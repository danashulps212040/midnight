<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Midnight</title>
    <style>
    /* Estilos para o botão de notificações */
    .notification-btn {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        margin: 0 8px;
        color: var(--text-color);
    }

    .notification-btn:hover {
        color: var(--primary-color);
    }

    .notification-count {
        position: absolute;
        top: 0;
        right: 0;
        background-color: var(--danger-color);
        color: white;
        border-radius: 50%;
        min-width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px;
    }

    /* Estilos para o modal de notificações */
    .notifications-modal {
        max-width: 600px;
        width: 90%;
    }

    .notifications-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #9B64E3;
    }

    .notifications-title {
        font-size: 1.2em;
        font-weight: 600;
        color: var(--text-color);
    }

    .notification-item.low-stock {
        border-left-color: #f5873800;
    }
    
    .notification-item.low-stock:hover {
        border-color: #9B64E3;
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.8);
    }

    .notifications-list {
        max-height: 70vh;
        overflow-y: auto;
        padding: 16px;
        border-top: 2px solid #9B64E3;
    }

    .notification-item {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .notification-item.low-stock {
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .notification-item.low-stock:hover {
        border-width: 2px;
        border-color: #9B64E3;
        box-shadow: 0 0 10px #9B64E3;
    }

    .notification-item.unread {
        background-color: var(--hover-color);
        border-left: 4px solid transparent;
    }

    .notification-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-color);
        padding-bottom: 8px;
        border-bottom: 1px solid #9B64E3;
    }

    .notification-message {
        color: var(--text-secondary);
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .notification-time {
        font-size: 0.85em;
        color: var(--text-tertiary);
    }

    .notification-actions {
        margin-top: 8px;
        display: flex;
        justify-content: flex-end;
    }

    .notification-item.unread.low-stock:hover {
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.8);
        border-color: #9B64E3;
        transition: all 0.3s ease;
    }

    .mark-read-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
    }

    .mark-read-btn:hover {
        background-color: var(--primary-dark);
    }

    .notification-loading,
    .no-notifications {
        text-align: center;
        padding: 24px;
        color: var(--text-secondary);
    }

        :root {
            --page-bg: #f4f7f9;
            --text-color: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --background-color: #ffffff;
            --hover-color: #f8f9fa;
            --border-color: #e0e0e0;
            --primary-color: #9B64E3;
            --primary-dark: #7a4fb8;
            --danger-color: #dc3545;
            --sidebar-bg: #3b0c79;
            --sidebar-text-color: white;
            --sidebar-hover-bg: #D8CEFE;
            --sidebar-hover-text: #333;
            --navbar-bg: rgba(68, 7, 148, 0.69);
            --navbar-text-color: white;
            --navbar-border: #9B64E3;
            --logout-btn-border: #D8CEFE;
            --logout-btn-hover-bg: #D8CEFE;
            --logout-btn-hover-text: #333;
            --flash-success-bg: #d4edda;
            --flash-success-text: #155724;
            --flash-success-border: #c3e6cb;
            --flash-danger-bg: #f8d7da;
            --flash-danger-text: #721c24;
            --flash-danger-border: #f5c6cb;
            --flash-warning-bg: #fff3cd;
            --flash-warning-text: #856404;
            --flash-warning-border: #ffeeba;
            --flash-info-bg: #d1ecf1;
            --flash-info-text: #0c5460;
            --flash-info-border: #bee5eb;
            --board-column-bg: #e2e4e6;
            --column-title-text: #172b4d;
            --order-card-bg: #ffffff;
            --order-card-hover-bg: #f0f0f0;
            --card-title-text: #333; /* Default to general text color */
            --card-detail-text: #5e6c84;
            --card-detail-strong-text: #42526e;
            --action-btn-hover-bg: #f0f0f0;
            --tooltip-bg: #333;
            --tooltip-text: white;
            --modal-content-bg: #fefefe;
            --modal-content-text: #333;
            --modal-title-text: #072B58;
            --steps-list-item-bg: #f9f9f9;
            --steps-list-item-border: #ddd;
            --steps-list-item-strong-text: #555;
            --link-color: #007bff; /* Example link color */
            --link-hover-color: #0056b3; /* Example link hover color */
        }        body.dark-theme {
            --page-bg: #1a1a2e; /* Dark blue/purple */
            --text-color: #e0e0e0; /* Light grey for text */
            --sidebar-bg: #2c0b5a; /* Slightly darker sidebar */
            --sidebar-text-color: #e0e0e0;
            --sidebar-hover-bg: #4a1a7a;
            --sidebar-hover-text: #ffffff;
            --navbar-bg: rgba(44, 11, 90, 0.8); /* Darker navbar */
            --navbar-text-color: #e0e0e0;
            --navbar-border: #7a4db3;
            --logout-btn-border: #bca0e8;
            --logout-btn-hover-bg: #bca0e8;
            --logout-btn-hover-text: #1a1a2e;
            --flash-success-bg: #1d4c25;
            --flash-success-text: #d4edda;
            --flash-success-border: #2a6832;
            --flash-danger-bg: #58151c;
            --flash-danger-text: #f8d7da;
            --flash-danger-border: #721c24;
            --flash-warning-bg: #664d03;
            --flash-warning-text: #fff3cd;
            --flash-warning-border: #856404;
            --flash-info-bg: #0a4350;
            --flash-info-text: #d1ecf1;
            --flash-info-border: #0c5460;
            --board-column-bg: #2c2c44; /* Darker column */
            --column-title-text: #c0c0e0;
            --order-card-bg: #25253a; /* Dark card */
            --order-card-hover-bg: #35354a;
            --card-title-text: #e0e0e0;
            --card-detail-text: #a0a0c0;
            --card-detail-strong-text: #c0c0e0;
            --action-btn-hover-bg: #35354a;
            --tooltip-bg: #e0e0e0;
            --tooltip-text: #1a1a2e;
            --modal-content-bg: #25253a;
            --modal-content-text: #e0e0e0;
            --modal-title-text: #c0c0e0;
            --steps-list-item-bg: #1e1e30;
            --steps-list-item-border: #444;
            --steps-list-item-strong-text: #a0a0c0;
            --link-color: #7aa5ff;
            --link-hover-color: #a0c5ff;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: var(--page-bg);
            color: var(--text-color);
            transition: margin-left 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Sidebar styles */
        .sidebar {
            height: 100%;
            width: 250px;
            position: fixed;
            top: 0;
            left: -250px;
            background-color: var(--sidebar-bg);
            overflow-x: hidden;
            transition: left 0.3s ease, background-color 0.3s ease;
            z-index: 999;
            padding-top: 70px;
        }

        .order-cover {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 3px;
        }
        
        .order-cover img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-toggle-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 10px;
            margin: 0;
            display: flex;
            align-items: center;
        }
        .sidebar-toggle-btn {
            margin-right: 10px;
        }
        .sidebar-toggle-btn svg {
            margin-right: 10px;
        }
        
        .sidebar-toggle-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav li {
            color: var(--sidebar-text-color);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            /* Melhor compatibilidade com touch no iOS antigo */
            -webkit-tap-highlight-color: rgba(155, 100, 227, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .sidebar-nav li.active {
            background-color: rgba(155, 100, 227, 0.2);
        }

        .sidebar-nav li.active .menu-item {
            border: 1px solid #9B64E3;
            background-color: rgba(155, 100, 227, 0.1);
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.3);
        }

        .menu-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            height: 44px;
            box-sizing: border-box;
            background-color: rgba(155, 100, 227, 0.05);
            /* Melhor compatibilidade com touch no iOS antigo */
            -webkit-tap-highlight-color: rgba(155, 100, 227, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            min-height: 44px; /* Tamanho mínimo recomendado para touch no iOS */
            border: 1px solid #9b64e300;
            color: white;
            border-radius: 0px;
            transition: all 0.3s ease;
        }

        .menu-item .menu-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item .menu-arrow {
            transition: transform 0.3s ease;
        }

        .menu-item.expanded .menu-arrow {
            transform: rotate(90deg);
        }

        .menu-description {
            font-size: 0.8em;
            padding: 0 15px 5px 45px;
            color: rgba(255,255,255,0.7);
            display: none;
        }

        .menu-item.expanded + .menu-description {
            display: block;
        }

        .submenu {
            display: none;
            background-color: rgba(0,0,0,0.1);
        }

        .submenu.expanded {
            display: block;
        }

        .submenu a {
            padding: 8px 15px 8px 45px;
            display: flex;
            align-items: center;
            color: var(--sidebar-text-color);
            text-decoration: none;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
            /* Melhor compatibilidade com touch no iOS antigo */
            -webkit-tap-highlight-color: rgba(155, 100, 227, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            min-height: 44px; /* Tamanho mínimo recomendado para touch no iOS */
        }

        .submenu.expanded a {
            animation: slideDown 0.3s ease forwards;
        }

        @keyframes slideDown {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .submenu.expanded a:nth-child(1) { animation-delay: 0.1s; }
        .submenu.expanded a:nth-child(2) { animation-delay: 0.2s; }
        .submenu.expanded a:nth-child(3) { animation-delay: 0.3s; }
        .submenu.expanded a:nth-child(4) { animation-delay: 0.4s; }
        .submenu.expanded a:nth-child(5) { animation-delay: 0.5s; }

        .submenu a:hover {
            background-color: #D8CEFE;
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.8);
            color: var(--sidebar-hover-text);
        }
        
        .menu-item:hover, .menu-item:focus {
            background-color: #D8CEFE;
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.8);
            color: var(--sidebar-hover-text);
            border: 1px solid #9B64E3;
        }

        .menu-item:focus-visible {
            outline: none;
            border: 1px solid #9B64E3;
            box-shadow: 0 0 0 2px rgba(155, 100, 227, 0.5);
        }
        
        body.sidebar-active {
            margin-left: 250px;
        }
        .navbar {
            background-color: var(--navbar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--navbar-text-color);
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1001;
            border-bottom: 2px solid var(--navbar-border);
            transition: background-color 0.3s ease, color 0.3s ease, border-bottom-color 0.3s ease;
        }
        .welcome-message {
            display: flex;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .welcome-message h2 {
            margin: 0;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }
        .navbar-logo {
            height: 30px;
            width: auto;
        }

        /* Estilos do dropdown do módulo */
        .module-dropdown {
            position: relative;
        }

        .module-indicator-button:hover {
            background-color: rgba(155, 100, 227, 0.2) !important;
            border-color: rgba(155, 100, 227, 0.5) !important;
        }

        .module-dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .module-dropdown-menu {
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            display: block;
            padding: 10px 16px;
            color: var(--navbar-text-color);
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .dropdown-item:hover {
            background-color: rgba(155, 100, 227, 0.15);
            border-left-color: #9B64E3;
            color: white;
            padding-left: 20px;
        }

        .dropdown-section:not(:last-child) {
            border-bottom: 1px solid rgba(155, 100, 227, 0.2);
        }
        .theme-toggle-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            /* padding: 8px;  Removido pois width/height e flex center cuidam do espaçamento interno */
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center; /* Para centralizar os ícones absolutos */
            transition: transform 0.3s ease;
            position: relative; /* Para posicionamento absoluto dos SVGs filhos */
            width: 40px;  /* Dimensão fixa para o botão */
            height: 40px; /* Dimensão fixa para o botão */
        }
        
        .theme-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        .theme-toggle-btn svg {
            width: 24px;
            height: 24px;
            transition: opacity 0.3s ease, transform 0.3s ease;
            position: absolute; /* Para sobrepor e animar no mesmo lugar */
        }

        /* Estado inicial: sol visível, lua escondida e rotacionada */
        .theme-toggle-btn #sunIcon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }
        .theme-toggle-btn #moonIcon {
            opacity: 0;
            transform: rotate(-90deg) scale(0.5);
        }

        /* Estado quando body.dark-theme está ativo: lua visível, sol escondido e rotacionada */
        body.dark-theme .theme-toggle-btn #sunIcon {
            opacity: 0;
            transform: rotate(90deg) scale(0.5);
        }
        body.dark-theme .theme-toggle-btn #moonIcon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }
        
        .refresh-btn {
            transition: all 0.3s ease !important;
            border-radius: 50% !important;
        }
        
        .refresh-btn:hover {
            background-color: rgba(155, 100, 227, 0.1) !important;
            transform: scale(1.1) !important;
        }
        
        .refresh-btn:active {
            background-color: rgba(155, 100, 227, 0.2) !important;
            transform: scale(0.95) !important;
        }
        
        .refresh-btn.refreshing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Estilos do dropdown do usuário */
        .user-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .user-menu-btn {
            background: transparent;
            border: none;
            color: var(--navbar-text-color);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .user-menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .user-menu-btn:after {
            content: "▼";
            position: absolute;
            right: 8px;
            color: #9B64E3;
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }
        
        .user-menu-btn.active:after {
            transform: rotate(180deg);
        }
        
        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9B64E3, #0083E5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .user-name {
            font-weight: 500;
            font-size: 14px;
            margin-right: 15px;
        }
        
        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--navbar-bg) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 2px solid #9B64E3;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            z-index: 10001;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            visibility: hidden;
            margin-top: 5px;
        }
        
        /* Debug: força backdrop-filter em qualquer estado */
        .user-dropdown-menu,
        .user-dropdown-menu.show {
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
        }
        
        /* Teste alternativo: usar position fixed para escapar do contexto */
        .user-dropdown-menu.debug-mode {
            position: fixed !important;
            backdrop-filter: blur(15px) !important;
            -webkit-backdrop-filter: blur(15px) !important;
            background-color: rgba(68, 7, 148, 0.8) !important;
        }
        
        .user-dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
            visibility: visible;
        }
        
        .user-info {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(155, 100, 227, 0.3);
        }
        
        .user-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9B64E3, #0083E5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .user-avatar-large img,
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name-large {
            font-weight: 600;
            color: white;
            font-size: 16px;
        }
        
        .user-email {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .dropdown-divider {
            border: none;
            border-top: 1px solid rgba(155, 100, 227, 0.3);
            margin: 0;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .dropdown-item:hover {
            background-color: rgba(155, 100, 227, 0.2);
            color: #D8CEFE;
        }
        
        .dropdown-item:first-of-type {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        
        .dropdown-item:last-of-type {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        
        .dropdown-item.logout-item:hover {
            background-color: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
        }
        
        .logout-btn {
            background-color: transparent;
            color: var(--navbar-text-color); /* Align with navbar text */
            border: 2px solid var(--logout-btn-border);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            margin-left: 10px;
        }
        .logout-btn:hover {
            background-color: var(--logout-btn-hover-bg);
            color: var(--logout-btn-hover-text);
        }
        .flash-messages {
            padding: 0 20px;
            list-style: none;
            margin: 10px 0 0 0; /* Add margin top */
        }
        .flash-messages .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .flash-messages .success { background-color: var(--flash-success-bg); color: var(--flash-success-text); border: 1px solid var(--flash-success-border); }
        .flash-messages .danger { background-color: var(--flash-danger-bg); color: var(--flash-danger-text); border: 1px solid var(--flash-danger-border); }
        .flash-messages .warning { background-color: var(--flash-warning-bg); color: var(--flash-warning-text); border: 1px solid var(--flash-warning-border); }
        .flash-messages .info { background-color: var(--flash-info-bg); color: var(--flash-info-text); border: 1px solid var(--flash-info-border); }

        .board-container {
            display: flex;
            flex-wrap: wrap;
            overflow-x: auto;
            padding: 20px;
            gap: 20px;
            align-items: flex-start;
            min-height: calc(100vh - 100px);
            margin-top: 70px;
            justify-content: center;
        }
        .board-column {
            background-color: var(--board-column-bg);
            border-radius: 5px;
            padding: 10px;
            min-width: 280px;
            max-width: 300px;
            width: calc(33.33% - 20px);
            flex: 0 1 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: background-color 0.3s ease;
        }
        .column-title {
            font-weight: bold;
            color: var(--column-title-text);
            padding: 5px 8px;
            margin-bottom: 10px;
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
            text-transform: uppercase;
            transition: color 0.3s ease;
        }
        .order-card {
            background-color: var(--order-card-bg);
            border-radius: 3px;
            padding: 10px;
            box-shadow: 0 1px 0 rgba(9,30,66,.25); /* Consider a variable for shadow if it needs to change */
            cursor: pointer; /* Indicate interactivity */
            transition: background-color 0.2s ease;
        }
        .order-card:hover {
            background-color: var(--order-card-hover-bg);
        }
        .card-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: clamp(0.85rem, 1.3vw, 0.95rem);
            color: var(--card-title-text);
            transition: color 0.3s ease;
        }
        .card-detail {
            font-size: clamp(0.75rem, 1vw, 0.85rem);
            color: var(--card-detail-text);
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }
        .card-detail strong {
            color: var(--card-detail-strong-text);
            transition: color 0.3s ease;
        }
        
        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 10px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            position: relative;
        }
        
        .action-btn:hover {
            background-color: var(--action-btn-hover-bg);
        }
        
        .action-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .action-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        .active-pause-btn {
            animation: pulse 1.5s infinite;
            border: 2px solid #F58838;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 136, 56, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(245, 136, 56, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 136, 56, 0); }
        }
        .no-orders {
            text-align: center;
            color: #5e6c84;
            margin-top: 20px;
            font-style: italic;
            width: 100%; /* Ensure it takes full width if container is empty */
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
        }
        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 10% auto; /* 10% from the top and centered */
            padding: 25px;
            border: 1px solid #888; /* Consider a variable for this border */
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 600px; /* Maximum width */
            border-radius: 8px;
            position: relative;
            color: var(--modal-content-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }
        .modal-title {
            margin-top: 0;
            color: var(--modal-title-text);
            border-bottom: 2px solid #9B64E3;
            padding-bottom: 10px;
            margin-bottom: 15px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .steps-list li {
            background-color: var(--steps-list-item-bg);
            border: 1px solid var(--steps-list-item-border);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
         .steps-list li strong {
             display: inline-block;
             min-width: 100px; /* Align details */
             color: var(--steps-list-item-strong-text);
             transition: color 0.3s ease;
         }
    </style>
    
    <!-- Script global para funções do dropdown - definido no head para disponibilidade imediata -->
    <script>
    // Definir funções globais para dropdown (compatibilidade iOS 12)
    window.toggleModuleDropdown = function() {
        console.log('[DROPDOWN-GLOBAL] toggleModuleDropdown chamada');
        var menu = document.getElementById('moduleDropdownMenu');
        if (menu) {
            var currentDisplay = menu.style.display;
            if (currentDisplay === 'block') {
                menu.style.display = 'none';
                console.log('[DROPDOWN-GLOBAL] Menu fechado');
            } else {
                menu.style.display = 'block';
                console.log('[DROPDOWN-GLOBAL] Menu aberto');
            }
        } else {
            console.error('[DROPDOWN-GLOBAL] Menu não encontrado');
        }
    };

    window.handleDropdownItemClick = function(pageName) {
        console.log('[DROPDOWN-GLOBAL] Item clicado:', pageName);
        
        // Log via API também para debug
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/debug-log', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({message: 'ITEM DROPDOWN CLICADO: ' + pageName, level: 'SUCCESS', source: 'DROPDOWN-GLOBAL-ITEM'}));
        
        // Fechar menu primeiro
        var menu = document.getElementById('moduleDropdownMenu');
        if (menu) {
            menu.style.display = 'none';
        }
        
        // Função que aguarda o documento estar completamente carregado
        function executeWhenReady() {
            var xhr2 = new XMLHttpRequest();
            xhr2.open('POST', '/api/debug-log', true);
            xhr2.setRequestHeader('Content-Type', 'application/json');
            xhr2.send(JSON.stringify({message: 'Estado documento: ' + document.readyState + ', loadContent: ' + (typeof loadContent) + ', window.loadContent: ' + (typeof window.loadContent), level: 'INFO', source: 'DROPDOWN-READY-CHECK'}));
            
            if (typeof window.loadContent === 'function') {
                window.loadContent(pageName);
                var xhr3 = new XMLHttpRequest();
                xhr3.open('POST', '/api/debug-log', true);
                xhr3.setRequestHeader('Content-Type', 'application/json');
                xhr3.send(JSON.stringify({message: 'SUCCESS: Conteudo carregado via window.loadContent!', level: 'SUCCESS', source: 'DROPDOWN-SUCCESS'}));
            } else if (typeof loadContent === 'function') {
                loadContent(pageName);
                var xhr4 = new XMLHttpRequest();
                xhr4.open('POST', '/api/debug-log', true);
                xhr4.setRequestHeader('Content-Type', 'application/json');
                xhr4.send(JSON.stringify({message: 'SUCCESS: Conteudo carregado via loadContent!', level: 'SUCCESS', source: 'DROPDOWN-SUCCESS'}));
            } else {
                var xhr5 = new XMLHttpRequest();
                xhr5.open('POST', '/api/debug-log', true);
                xhr5.setRequestHeader('Content-Type', 'application/json');
                xhr5.send(JSON.stringify({message: 'ERRO: loadContent ainda nao disponivel! Estado: ' + document.readyState, level: 'ERROR', source: 'DROPDOWN-ERROR'}));
            }
        }
        
        // Verificar se o documento já está carregado
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            // Documento já carregado, executar imediatamente
            executeWhenReady();
        } else {
            // Aguardar o documento carregar
            var xhr6 = new XMLHttpRequest();
            xhr6.open('POST', '/api/debug-log', true);
            xhr6.setRequestHeader('Content-Type', 'application/json');
            xhr6.send(JSON.stringify({message: 'Aguardando documento carregar... Estado atual: ' + document.readyState, level: 'INFO', source: 'DROPDOWN-WAIT'}));
            
            document.addEventListener('DOMContentLoaded', executeWhenReady);
        }
    };

    // Log de inicialização
    console.log('[DROPDOWN-GLOBAL] Funções globais definidas no head');
    </script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        {% if session.username %}
            <div style="padding: 15px; color: var(--sidebar-text-color); text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin: 0; font-size: 1rem;">Bem-vindo,<br>{{ session.username }}!</h3>
            </div>
        {% endif %}
        <ul class="sidebar-nav">
            <li onclick="loadContent('dashboard.html')" ontouchstart="loadContent('dashboard.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                <div class="menu-item">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Dashboard
                    </div>
                </div>
            </li>

            <li>
                <div class="menu-item" onclick="toggleSubmenu(this)" ontouchstart="toggleSubmenu(this)" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                        Comercial
                    </div>
                    <svg class="menu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="menu-description">Gerencia interações com clientes, desde orçamentos até vendas.</div>
                <div class="submenu">
                    <a href="#" onclick="loadContent('orcamentos.html')" ontouchstart="loadContent('orcamentos.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Orçamentos</a>
                    <a href="#" onclick="loadContent('vendas.html')" ontouchstart="loadContent('vendas.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Vendas</a>
                    <a href="/pdv-full" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">PDV</a>
                    <a href="#" onclick="loadContent('produtos.html')" ontouchstart="loadContent('produtos.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Produtos</a>
                    <a href="#" onclick="loadContent('relatorios_comerciais.html')" ontouchstart="loadContent('relatorios_comerciais.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Relatórios Comerciais</a>
                </div>
            </li>

            <li>
                <div class="menu-item" onclick="toggleSubmenu(this)" ontouchstart="toggleSubmenu(this)" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        Financeiro
                    </div>
                    <svg class="menu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="menu-description">Controla despesas, receitas e ordens de compra.</div>
                <div class="submenu">
                    <a href="#" onclick="loadContent('contas_receber.html')" ontouchstart="loadContent('contas_receber.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Contas a Receber</a>
                    <a href="#" onclick="loadContent('contas_pagar.html')" ontouchstart="loadContent('contas_pagar.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Contas a Pagar</a>
                    <a href="#" onclick="loadContent('ordens_compra.html')" ontouchstart="loadContent('ordens_compra.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Ordens de Compra</a>
                    <a href="#" onclick="loadContent('relatorios_financeiros.html')" ontouchstart="loadContent('relatorios_financeiros.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Relatórios Financeiros</a>
                </div>
            </li>

            <li>
                <div class="menu-item" onclick="toggleSubmenu(this)" ontouchstart="toggleSubmenu(this)" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4l3 3"></path></svg>
                        PCP
                    </div>
                    <svg class="menu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="menu-description">Gerencia o planejamento e execução de projetos gráficos.</div>
                <div class="submenu">
                    <a href="#" onclick="loadContent('ordens_servico.html')" ontouchstart="loadContent('ordens_servico.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Ordens de Serviço</a>
                    <a href="#" onclick="loadContent('etapas.html')" ontouchstart="loadContent('etapas.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Etapas</a>
                    <a href="#" onclick="loadContent('etapas_confeccao.html')" ontouchstart="loadContent('etapas_confeccao.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Etapas de Confecção</a>
                    <a href="#" onclick="loadContent('pos_calculo.html')" ontouchstart="loadContent('pos_calculo.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Pós Cálculo</a>
                    <a href="#" onclick="loadContent('apontamentos.html')" ontouchstart="loadContent('apontamentos.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Apontamentos</a>
                    <a href="#" onclick="loadContent('relatorios_producao.html')" ontouchstart="loadContent('relatorios_producao.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Relatórios de Produção</a>
                </div>
            </li>

            <li>
                <div class="menu-item" onclick="toggleSubmenu(this)" ontouchstart="toggleSubmenu(this)" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><rect x="7" y="4" width="4" height="4"></rect><rect x="7" y="12" width="4" height="4"></rect><rect x="13" y="8" width="4" height="4"></rect><rect x="13" y="16" width="4" height="4"></rect></svg>
                        Estoque
                    </div>
                    <svg class="menu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="menu-description">Controla materiais consumíveis (ex.: papéis, tintas, vinis).</div>
                <div class="submenu">
                    <a href="#" onclick="loadContent('estoque.html')" ontouchstart="loadContent('estoque.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Inventário</a>
                    <a href="#" onclick="loadContent('entrada_estoque.html')" ontouchstart="loadContent('entrada_estoque.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Entrada de Estoque</a>
                    <a href="#" onclick="loadContent('saida_estoque.html')" ontouchstart="loadContent('saida_estoque.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Saída de Estoque</a>
                    <a href="#" onclick="loadContent('ajuste_estoque.html')" ontouchstart="loadContent('ajuste_estoque.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Ajuste de Estoque</a>
                    <a href="#" onclick="loadContent('relatorios_estoque.html')" ontouchstart="loadContent('relatorios_estoque.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Relatórios de Estoque</a>
                </div>
            </li>

            <li>
                <div class="menu-item" onclick="toggleSubmenu(this)" ontouchstart="toggleSubmenu(this)" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Cadastros
                    </div>
                    <svg class="menu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="menu-description">Centraliza registros estáticos e categorias do sistema.</div>
                <div class="submenu">
                    <a href="#" onclick="loadContent('clientes.html')" ontouchstart="loadContent('clientes.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Clientes</a>
                    <a href="#" onclick="loadContent('fornecedores.html')" ontouchstart="loadContent('fornecedores.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Fornecedores</a>
                    <a href="#" onclick="loadContent('ferramentas.html')" ontouchstart="loadContent('ferramentas.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Ferramentas</a>
                    <a href="#" onclick="loadContent('maquinas.html')" ontouchstart="loadContent('maquinas.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Máquinas</a>
                    <a href="#" onclick="loadContent('categorias_materiais.html')" ontouchstart="loadContent('categorias_materiais.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Categorias de Materiais</a>
                    <a href="#" onclick="loadContent('categorias_servicos.html')" ontouchstart="loadContent('categorias_servicos.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Categorias de Serviços</a>
                    <a href="#" onclick="loadContent('categorias_os.html')" ontouchstart="loadContent('categorias_os.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Categorias de Ordens de Serviço</a>
                    <a href="#" onclick="loadContent('categorias_contas.html')" ontouchstart="loadContent('categorias_contas.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Categorias de Contas</a>
                    <a href="#" onclick="loadContent('unidades_medida.html')" ontouchstart="loadContent('unidades_medida.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Unidades de Medida</a>
                    <a href="#" onclick="loadContent('localizacoes_estoque.html')" ontouchstart="loadContent('localizacoes_estoque.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Localizações de Estoque</a>
                </div>
            </li>

            <li>
                <div class="menu-item" onclick="toggleSubmenu(this)" ontouchstart="toggleSubmenu(this)" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">
                    <div class="menu-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        Configurações
                    </div>
                    <svg class="menu-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="menu-description">Gerencia ajustes gerais e permissões do sistema.</div>
                <div class="submenu">
                    <a href="#" onclick="loadContent('usuarios.html')" ontouchstart="loadContent('usuarios.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Usuários</a>
                    <a href="#" onclick="loadContent('permissoes.html')" ontouchstart="loadContent('permissoes.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Permissões</a>
                    <a href="#" onclick="loadContent('configuracoes_gerais.html')" ontouchstart="loadContent('configuracoes_gerais.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Configurações Gerais</a>
                    <a href="#" onclick="loadContent('backup.html')" ontouchstart="loadContent('backup.html')" style="cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0);">Backup/Exportação</a>
                </div>
            </li>
        </ul>
        {% if session.username %}
            <div class="session-time" id="sessionTimer">Tempo de sessão: 00:00:00</div>
        {% endif %}
    </div>
    
    <nav class="navbar">
        <button id="sidebarToggle" class="sidebar-toggle-btn">
            <svg id="menuIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
            <svg id="closeIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div class="welcome-message" style="display: flex; align-items: center; gap: 15px;">
            <img src="{{ url_for('static', filename='logo.svg') }}" alt="Logo Midnight" class="navbar-logo">
            <div class="module-dropdown" id="moduleDropdown">
                <div class="module-indicator-button" ontouchstart="
                    event.preventDefault();
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/debug-log', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify({message: 'TOUCH UNICO - Botao dropdown tocado', level: 'INFO', source: 'DROPDOWN-TOUCH-ONLY'}));
                    
                    // Tentar imediatamente
                    if (typeof toggleModuleDropdown === 'function') {
                        toggleModuleDropdown();
                    } else if (typeof window.toggleModuleDropdown === 'function') {
                        window.toggleModuleDropdown();
                    } else {
                        // Tentar após pequeno delay para aguardar carregamento
                        setTimeout(function() {
                            if (typeof toggleModuleDropdown === 'function') {
                                toggleModuleDropdown();
                            } else if (typeof window.toggleModuleDropdown === 'function') {
                                window.toggleModuleDropdown();
                            } else {
                                var xhr2 = new XMLHttpRequest();
                                xhr2.open('POST', '/api/debug-log', true);
                                xhr2.setRequestHeader('Content-Type', 'application/json');
                                xhr2.send(JSON.stringify({message: 'ERRO: toggleModuleDropdown nao encontrada nem apos delay', level: 'ERROR', source: 'DROPDOWN-TOUCH-ONLY'}));
                            }
                        }, 100);
                    }
                " style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease; background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); -webkit-tap-highlight-color: rgba(155, 100, 227, 0.3);">
                    <span id="moduleIndicator" style="color: var(--navbar-text-color); font-size: 14px; font-weight: 500;">Dashboard</span>
                    <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition: transform 0.3s ease;">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div class="module-dropdown-menu" id="moduleDropdownMenu" style="position: absolute; top: 100%; left: 0; background: rgba(59, 12, 121, 0.95); backdrop-filter: blur(15px); border: 1px solid #9B64E3; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.4); display: none; min-width: 200px; z-index: 10000; margin-top: 5px;">
                    <div class="dropdown-section">
                        <div class="dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(155, 100, 227, 0.3); color: #9B64E3; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Comercial</div>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('orcamentos.html')" class="dropdown-item">Orçamentos</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('vendas.html')" class="dropdown-item">Vendas</a>
                        <a href="/pdv-full" class="dropdown-item">PDV</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('produtos.html')" class="dropdown-item">Produtos</a>
                    </div>
                    <div class="dropdown-section">
                        <div class="dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(155, 100, 227, 0.3); color: #9B64E3; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Estoque</div>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('estoque.html')" class="dropdown-item">Inventário</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('entrada_estoque.html')" class="dropdown-item">Entrada de Estoque</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('saida_estoque.html')" class="dropdown-item">Saída de Estoque</a>
                    </div>
                    <div class="dropdown-section">
                        <div class="dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(155, 100, 227, 0.3); color: #9B64E3; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Cadastros</div>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('clientes.html')" class="dropdown-item">Clientes</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('ferramentas.html')" class="dropdown-item">Ferramentas</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('maquinas.html')" class="dropdown-item">Máquinas</a>
                    </div>
                    <div class="dropdown-section">
                        <div class="dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(155, 100, 227, 0.3); color: #9B64E3; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Sistema</div>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('dashboard.html')" class="dropdown-item">Dashboard</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('usuarios.html')" class="dropdown-item">Usuários</a>
                        <a href="#" ontouchstart="event.preventDefault(); handleDropdownItemClick('configuracoes_gerais.html')" class="dropdown-item">Configurações</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="navbar-actions" style="display: flex; align-items: center;">
            <button id="refreshBtn" onclick="refreshCurrentContent()" class="refresh-btn" style="background: none; border: none; color: var(--navbar-text-color); cursor: pointer; padding: 8px; margin-left: 10px; display: flex; align-items: center; justify-content: center; position: relative; width: 40px; height: 40px; transition: all 0.3s ease; border-radius: 50%;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M3 21v-5h5"></path>
                </svg>
            </button>
            <button id="notificationBtn" onclick="openNotificationsModal()" class="notification-btn" style="background: none; border: none; color: var(--navbar-text-color); cursor: pointer; padding: 8px; margin-left: 10px; display: flex; align-items: center; justify-content: center; position: relative; width: 40px; height: 40px; transition: transform 0.3s ease;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span id="notificationCount" class="notification-count" style="position: absolute; top: 0; right: 0; background-color: #F58838; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none;">0</span>
            </button>
            <button id="themeToggle" class="theme-toggle-btn">
            <svg id="sunIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg id="moonIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
        {% if session.logged_in %}
            <div class="user-dropdown" style="position: relative; margin-left: 15px;">
                <button id="userMenuBtn" class="user-menu-btn" onclick="toggleUserDropdown()">
                    <div id="userAvatarSmall" class="user-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <span class="user-name">{{ session.username }}</span>
                </button>
                <div id="userDropdown" class="user-dropdown-menu">
                    <div class="user-info">
                        <div id="userAvatarLarge" class="user-avatar-large">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="user-details">
                            <div class="user-name-large">{{ session.username }}</div>
                            <div class="user-email">{{ session.user_email or 'N/A' }}</div>
                        </div>
                    </div>
                    <hr class="dropdown-divider">
                    <a href="#" onclick="changeUser()" class="dropdown-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Trocar Usuário
                    </a>
                    <a href="#" onclick="logout(); return false;" class="dropdown-item logout-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Sair
                    </a>
                </div>
            </div>
        {% endif %}
    </nav>

    {# Display flashed messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class=flash-messages>
        {% for category, message in messages %}
          <li class="message {{ category }}">{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- Banner de notificação flutuante -->
    <div id="notificationBanner" class="notification-banner" style="display: none;">
        <div class="banner-content">
            <span id="bannerIcon" class="banner-icon"></span>
            <span id="bannerMessage" class="banner-message"></span>
            <button onclick="closeBanner()" class="banner-close">&times;</button>
        </div>
    </div>

    <!-- Modal de Confirmação para Troca de Usuário -->
    <div id="changeUserConfirmationModal" class="modal">
        <div class="modal-content notification-modal-content">
            <div id="changeUserNotificationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;"></div>
            <h2 id="changeUserModalTitle">Confirmar Troca de Usuário</h2>
            <p id="changeUserModalMessage">Tem certeza que deseja trocar de usuário? Você será desconectado da sessão atual.</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeChangeUserConfirmationModal()">Cancelar</button>
                <button id="changeUserConfirmBtn" class="btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação para Logout -->
    <div id="logoutConfirmationModal" class="modal">
        <div class="modal-content notification-modal-content">
            <div id="logoutNotificationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;"></div>
            <h2 id="logoutModalTitle">Confirmar Logout</h2>
            <p id="logoutModalMessage">Tem certeza que deseja sair do sistema?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeLogoutConfirmationModal()">Cancelar</button>
                <button id="logoutConfirmBtn" class="btn-primary">Sair</button>
            </div>
        </div>
    </div>

    <!-- Modal de Login para Troca de Usuário -->
    <div id="userChangeLoginModal" class="modal" style="z-index: 10003;">
        <div class="login-container" style="position: relative; margin: 0;">
            <div class="logo-container" style="display: flex; justify-content: center; margin-bottom: 50px;">
                <svg width="200" height="200" viewBox="0 0 6.1344 6.8851" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="id0_modal" gradientUnits="userSpaceOnUse" gradientTransform="matrix(6.54315 -0 -0 6.54315 -20 -15)" cx="3.6891" cy="2.7778" r="1.6274" fx="3.6891" fy="2.7778">
                            <stop offset="0" style="stop-opacity:1; stop-color:#9B64E3"/>
                            <stop offset="0.54902" style="stop-opacity:1; stop-color:#0083E5"/>
                            <stop offset="1" style="stop-opacity:1; stop-color:#0083E5"/>
                        </radialGradient>
                        <radialGradient id="id1_modal" gradientUnits="userSpaceOnUse" gradientTransform="matrix(6.54314 -0 -0 6.54315 -13 -13)" cx="2.3924" cy="2.3409" r="3.4425" fx="2.3924" fy="2.3409">
                            <stop offset="0" style="stop-opacity:1; stop-color:#9B64E3"/>
                            <stop offset="0.54902" style="stop-opacity:1; stop-color:#0083E5"/>
                            <stop offset="1" style="stop-opacity:1; stop-color:#0083E5"/>
                        </radialGradient>
                    </defs>
                    <g>
                        <path fill="url(#id0_modal)" d="M4.7505 2.8756l0 1.6591 -0.5808 0 0 -0.5315 -0 -0.9108c-0.2144,0.3548 -0.4185,0.8135 -0.5863,1.4063l-0.5828 -1.0575 0 1.0935 -0.5808 0 0 -2.1483 0.5808 0 0.4854 0.8813c0,0 0.1785,-0.4961 0.6463,-0.911 0.3436,-0.305 0.7812,-0.4839 1.3164,-0.4839l0.1008 0.0023 0.1228 0.0078 0.0022 0c0,0 -0.4242,0.0278 -0.9239,0.4848l0 0.508z"/>
                        <path fill="url(#id1_modal)" d="M3.4425 0c1.0897,0 2.061,0.5065 2.6918,1.2967 -0.5634,-0.586 -1.3553,-0.9508 -2.2325,-0.9508 -1.7102,0 -3.0966,1.3864 -3.0966,3.0966 0,1.6914 1.356,3.066 3.0402,3.0961 0.341,-0.0262 0.683,-0.074 0.9879,-0.1421 0.5005,-0.1577 0.9461,-0.4391 1.301,-0.8083 -0.6308,0.7902 -1.6021,1.2967 -2.6918,1.2967 -1.9013,0 -3.4425,-1.5413 -3.4425,-3.4425 0,-1.9013 1.5413,-3.4425 3.4425,-3.4425zm-2.7976,5.4478c0,0.0001 0.0001,0.0001 0.0001,0.0002 -0,-0.0001 -0.0001,-0.0001 -0.0001,-0.0002zm-0.0219 -0.0309c0.0073,0.0103 0.0146,0.0206 0.0219,0.0308 -0.0074,-0.0102 -0.0147,-0.0205 -0.0219,-0.0308z"/>
                    </g>
                </svg>
            </div>
            
            <div id="modalLoginMessages" class="flash-messages">
                <!-- Mensagens de erro serão inseridas aqui -->
            </div>
            
            <form id="userChangeLoginForm">
                <div class="form-group">
                    <label for="modalUsername">Usuário</label>
                    <input type="text" id="modalUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="modalPassword">Senha</label>
                    <input type="password" id="modalPassword" name="password" required>
                </div>
                <button type="submit">Entrar</button>
            </form>
        </div>
    </div>

    <div id="content-container">
        <!-- Conteúdo dinâmico será carregado aqui -->
    </div>
    <div class="board-container">
        {# Check if orders_by_status exists and is not empty #}
        {% if orders_by_status is defined and orders_by_status %}
            {% for status, orders in orders_by_status.items() %}
                <div class="board-column">
                    <h3 class="column-title">{{ status }} ({{ orders|length }})</h3>
                    {% if orders %}
                        {% for order in orders %}
                            {# Add data-order-id attribute here #}
                            <div class="order-card" data-order-id="{{ order.id }}">
                                {% if order.cover_image %}
                                    <div class="order-cover">
                                        <img src="data:image/jpeg;base64,{{ order.cover_image }}" alt="Capa da O.S" style="max-width: 100%; border-radius: 3px; margin-bottom: 10px;">
    
                            </div>
                                {% endif %}
                                <div class="card-title">{{ order.product }}</div>
                                <div class="card-detail"><strong>Cliente:</strong> {{ order.customer_name }}</div>
                                <div class="card-detail"><strong>Prazo:</strong> {{ order.deadline_formatted }}</div>
                                <div class="card-detail"><strong>Qtd:</strong> {{ order.quantity }}</div>
                                <div class="card-detail"><strong>Veículo:</strong> {{ order.vehicle_name }}</div>
                                {# Add more details as needed, checking if they exist #}
                                {% if order.priority is defined %}
                                    {# You might want a mapping for priority numbers to names #}
                                    <div class="card-detail"><strong>Prioridade:</strong> {{ order.priority_name }}</div>
                                    <div class="card-detail">
                                        <strong>Tempo Estimado:</strong> 
                                        {% set hours = order.estimated_time // 60 %}
                                        {% set minutes = order.estimated_time % 60 %}
                                        {{ '%02d:%02d' % (hours, minutes) }}
                                    </div>
                                    <div class="card-detail timer-display" data-order-id="{{ order.id }}" style="display: none;">
                                        <strong>Tempo decorrido:</strong> <span class="timer-value">00:00:00</span>
                                    </div>
                                {% endif %}
                                <div class="card-actions">
                                    {# Desabilita o botão Play/Pause se a ordem já foi concluída pelo usuário #}
                                    <button 
                                        class="action-btn play-pause-btn" 
                                        onclick="toggleTimer('{{ order.id }}')" 
                                        title="Play/Pause" 
                                        data-tooltip="Play/Pause" 
                                        data-state="paused"
                                        {% if order.is_completed_by_user %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    </button>
                                    {# Desabilita o botão Concluir se a ordem já foi concluída pelo usuário #}
                                    <button 
                                        class="action-btn complete-btn" 
                                        onclick="completeOrder('{{ order.id }}')" 
                                        title="Concluir ordem" 
                                        data-tooltip="Concluir ordem"
                                        {% if order.is_completed_by_user %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        {# Displayed if a status column exists but has no orders #}
                        {# This part might not be strictly necessary if empty statuses are filtered out in app.py #}
                        {# <div class="card-detail" style="text-align: center; padding: 10px;">Nenhuma O.S.</div> #}
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            {# Displayed if orders_by_status is empty or not defined #}
            <p class="no-orders">Nenhuma Ordem de Serviço por aqui ainda...</p>
        {% endif %}
    </div>

    <!-- The Steps Modal -->
    <div id="stepsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle" class="modal-title">Etapas da O.S. #</h3>
            <ul id="stepsList" class="steps-list">
                <!-- Steps will be loaded here by JavaScript -->
                <li>Carregando etapas...</li>
            </ul>
        </div>
    </div>

    <!-- The Active Order Alert Modal -->
    <div id="activeOrderAlertModal" class="modal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 15px;">
                <img src="{{ url_for('static', filename='warning_icon.svg') }}" alt="Aviso" style="width: 48px; height: 48px;">
            </div>
            <h3 class="modal-title" style="text-align: center;">Ordem de Serviço em Andamento</h3>
            <p style="margin-bottom: 20px; text-align: center;">Você deve pausar a O.S <span id="currentOrderName"></span> em andamento antes de iniciar outra.</p>
            <div style="display: flex; justify-content: center;">
                <button id="okButton" onclick="handleActiveOrderAlertResponse(true)" style="background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: not-allowed; opacity: 0.5;" disabled>OK</button>
            </div>
        </div>
    </div>
    <script>
        // ===== TESTE INICIAL - SCRIPT EXECUTANDO =====
        try {
            var xhr_start = new XMLHttpRequest();
            xhr_start.open('POST', '/api/debug-log', true);
            xhr_start.setRequestHeader('Content-Type', 'application/json');
            xhr_start.send(JSON.stringify({message: 'SCRIPT INICIADO - Comecando a executar JavaScript!', level: 'DEBUG', source: 'SCRIPT-START'}));
        } catch (e) {
            console.log('Erro no log inicial:', e);
        }

        // ===== TESTE DE DEFINIÇÃO DE FUNÇÕES =====
        
        // Log de início
        var xhr_init = new XMLHttpRequest();
        xhr_init.open('POST', '/api/debug-log', true);
        xhr_init.setRequestHeader('Content-Type', 'application/json');
        xhr_init.send(JSON.stringify({message: 'Iniciando definicao das funcoes do dropdown...', level: 'DEBUG', source: 'INIT'}));

        // Função simples para logs
        function logToFlask(message, level, source) {
            if (!level) level = 'INFO';
            if (!source) source = 'DROPDOWN';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/debug-log', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                message: message,
                level: level,
                source: source
            }));
        }

        // Log após definir logToFlask
        var xhr_log = new XMLHttpRequest();
        xhr_log.open('POST', '/api/debug-log', true);
        xhr_log.setRequestHeader('Content-Type', 'application/json');
        xhr_log.send(JSON.stringify({message: 'Funcao logToFlask definida', level: 'SUCCESS', source: 'INIT'}));

        // Função principal do dropdown (versão ultra-simplificada)
        function toggleModuleDropdown() {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/debug-log', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({message: '� toggleModuleDropdown EXECUTADO com sucesso!', level: 'SUCCESS', source: 'DROPDOWN'}));
            
            var dropdown = document.getElementById('moduleDropdown');
            var menu = document.getElementById('moduleDropdownMenu');
            
            if (!dropdown) {
                var xhr2 = new XMLHttpRequest();
                xhr2.open('POST', '/api/debug-log', true);
                xhr2.setRequestHeader('Content-Type', 'application/json');
                xhr2.send(JSON.stringify({message: '❌ Elemento dropdown não encontrado', level: 'ERROR', source: 'DROPDOWN'}));
                return;
            }
            
            if (!menu) {
                var xhr3 = new XMLHttpRequest();
                xhr3.open('POST', '/api/debug-log', true);
                xhr3.setRequestHeader('Content-Type', 'application/json');
                xhr3.send(JSON.stringify({message: '❌ Elemento menu não encontrado', level: 'ERROR', source: 'DROPDOWN'}));
                return;
            }
            
            var isVisible = menu.style.display === 'block';
            
            if (isVisible) {
                menu.style.display = 'none';
                var xhr4 = new XMLHttpRequest();
                xhr4.open('POST', '/api/debug-log', true);
                xhr4.setRequestHeader('Content-Type', 'application/json');
                xhr4.send(JSON.stringify({message: '✅ Menu fechado', level: 'SUCCESS', source: 'DROPDOWN'}));
            } else {
                menu.style.display = 'block';
                var xhr5 = new XMLHttpRequest();
                xhr5.open('POST', '/api/debug-log', true);
                xhr5.setRequestHeader('Content-Type', 'application/json');
                xhr5.send(JSON.stringify({message: '✅ Menu aberto', level: 'SUCCESS', source: 'DROPDOWN'}));
            }
        }

        // Log após definir toggleModuleDropdown
        var xhr_toggle = new XMLHttpRequest();
        xhr_toggle.open('POST', '/api/debug-log', true);
        xhr_toggle.setRequestHeader('Content-Type', 'application/json');
        xhr_toggle.send(JSON.stringify({message: 'Funcao toggleModuleDropdown definida', level: 'SUCCESS', source: 'INIT'}));

        // Função para seleção de itens (versão simples para teste)
        function handleDropdownItemClick(pageName) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/debug-log', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({message: '🎯 Item selecionado: ' + pageName, level: 'INFO', source: 'DROPDOWN'}));
            
            // Definir uma versão completa de loadContent se ela não existir
            if (typeof window.loadContent !== 'function' && typeof loadContent !== 'function') {
                var xhr2 = new XMLHttpRequest();
                xhr2.open('POST', '/api/debug-log', true);
                xhr2.setRequestHeader('Content-Type', 'application/json');
                xhr2.send(JSON.stringify({message: 'CRIANDO loadContent completa...', level: 'WARNING', source: 'DROPDOWN'}));
                
                window.loadContent = function(pageName) {
                    var xhr3 = new XMLHttpRequest();
                    xhr3.open('POST', '/api/debug-log', true);
                    xhr3.setRequestHeader('Content-Type', 'application/json');
                    xhr3.send(JSON.stringify({message: 'LoadContent completa executada para: ' + pageName, level: 'SUCCESS', source: 'DROPDOWN-COMPLETE'}));
                    
                    // Fechar sidebar
                    var sidebar = document.querySelector('.sidebar');
                    if (sidebar && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        document.body.classList.remove('sidebar-active');
                        var menuIcon = document.getElementById('menuIcon');
                        var closeIcon = document.getElementById('closeIcon');
                        if (menuIcon) menuIcon.style.display = 'block';
                        if (closeIcon) closeIcon.style.display = 'none';
                    }
                    
                    var boardContainer = document.querySelector('.board-container');
                    var contentContainer = document.getElementById('content-container');
                    
                    if (!contentContainer) {
                        var xhr4 = new XMLHttpRequest();
                        xhr4.open('POST', '/api/debug-log', true);
                        xhr4.setRequestHeader('Content-Type', 'application/json');
                        xhr4.send(JSON.stringify({message: 'ERRO: content-container não encontrado!', level: 'ERROR', source: 'DROPDOWN-ERROR'}));
                        return;
                    }
                    
                    // Se for dashboard, mostrar board e limpar content
                    if (pageName === 'dashboard.html' || !pageName) {
                        if (boardContainer) boardContainer.style.display = 'flex';
                        contentContainer.innerHTML = '';
                        contentContainer.style.display = 'none';
                        return;
                    }
                    
                    // Para outras páginas, carregar conteúdo
                    contentContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Carregando...</div>';
                    contentContainer.style.display = 'block';
                    if (boardContainer) boardContainer.style.display = 'none';
                    
                    var url = pageName === 'usuarios.html' ? '/usuarios' : pageName;
                    var xhr5 = new XMLHttpRequest();
                    xhr5.open('GET', url, true);
                    xhr5.onreadystatechange = function() {
                        if (xhr5.readyState === 4) {
                            if (xhr5.status === 200) {
                                contentContainer.innerHTML = xhr5.responseText;
                                var xhr6 = new XMLHttpRequest();
                                xhr6.open('POST', '/api/debug-log', true);
                                xhr6.setRequestHeader('Content-Type', 'application/json');
                                xhr6.send(JSON.stringify({message: 'Conteúdo carregado com sucesso: ' + pageName, level: 'SUCCESS', source: 'DROPDOWN-SUCCESS'}));
                            } else {
                                contentContainer.innerHTML = '<p style="color: red; text-align: center;">Erro ao carregar ' + pageName + '</p>';
                                var xhr7 = new XMLHttpRequest();
                                xhr7.open('POST', '/api/debug-log', true);
                                xhr7.setRequestHeader('Content-Type', 'application/json');
                                xhr7.send(JSON.stringify({message: 'Erro ao carregar: ' + pageName + ' - Status: ' + xhr5.status, level: 'ERROR', source: 'DROPDOWN-ERROR'}));
                            }
                        }
                    };
                    xhr5.send();
                };
            }
            
            if (typeof window.loadContent === 'function') {
                window.loadContent(pageName);
            } else if (typeof loadContent === 'function') {
                loadContent(pageName);
            }
            
            var menu = document.getElementById('moduleDropdownMenu');
            if (menu) {
                menu.style.display = 'none';
            }
        }

        // Disponibilizar no escopo global com verificação
        try {
            window.toggleModuleDropdown = toggleModuleDropdown;
            window.handleDropdownItemClick = handleDropdownItemClick;
            window.logToFlask = logToFlask;
            
            var xhr_success = new XMLHttpRequest();
            xhr_success.open('POST', '/api/debug-log', true);
            xhr_success.setRequestHeader('Content-Type', 'application/json');
            xhr_success.send(JSON.stringify({message: '✅ Funções atribuídas ao window com sucesso! Tipo toggleModuleDropdown: ' + typeof window.toggleModuleDropdown, level: 'SUCCESS', source: 'INIT'}));
        } catch (e) {
            var xhr_error = new XMLHttpRequest();
            xhr_error.open('POST', '/api/debug-log', true);
            xhr_error.setRequestHeader('Content-Type', 'application/json');
            xhr_error.send(JSON.stringify({message: '❌ Erro ao atribuir funções ao window: ' + e.toString(), level: 'ERROR', source: 'INIT'}));
        }

        // Log final
        var xhr_final = new XMLHttpRequest();
        xhr_final.open('POST', '/api/debug-log', true);
        xhr_final.setRequestHeader('Content-Type', 'application/json');
        xhr_final.send(JSON.stringify({message: 'Todas as funcoes do dropdown definidas no escopo global!', level: 'SUCCESS', source: 'INIT'}));

        // ===== FIM DAS FUNÇÕES DO DROPDOWN =====

        // Função para controlar a expansão/contração dos menus
        function toggleSubmenu(element) {
            // Remove a classe expanded de todos os outros menus
            var allMenuItems = document.querySelectorAll('.menu-item');
            allMenuItems.forEach(item => {
                if (item !== element && item.classList.contains('expanded')) {
                    item.classList.remove('expanded');
                    var nextDesc = item.nextElementSibling;
                    var nextSubmenu = nextDesc ? nextDesc.nextElementSibling : null;
                    if (nextDesc && nextDesc.classList.contains('menu-description')) {
                        nextDesc.style.display = 'none';
                    }
                    if (nextSubmenu && nextSubmenu.classList.contains('submenu')) {
                        nextSubmenu.classList.remove('expanded');
                    }
                }
            });

            // Expande/contrai o menu clicado
            element.classList.toggle('expanded');
            var description = element.nextElementSibling;
            var submenu = description ? description.nextElementSibling : null;
            
            if (description && description.classList.contains('menu-description')) {
                description.style.display = element.classList.contains('expanded') ? 'block' : 'none';
            }
            if (submenu && submenu.classList.contains('submenu')) {
                submenu.classList.toggle('expanded');
            }
        }

        // Contagem regressiva no botão OK
        var countdown = 5;
        var okButton = document.getElementById('okButton');
        okButton.textContent = 'OK (' + countdown + 's)';
        
        var countdownInterval = setInterval(function() {
            countdown--;
            okButton.textContent = 'OK (' + countdown + 's)';
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                okButton.disabled = false;
                okButton.style.opacity = 1;
                okButton.style.cursor = 'pointer';
                okButton.textContent = 'OK';
            }
        }, 1000);
        
        // Função para lidar com a resposta do alerta de ordem ativa
        function handleActiveOrderAlertResponse() {
            document.getElementById('activeOrderAlertModal').style.display = 'none';
            
            // Encontra e destaca o botão de pausa da O.S ativa
            var activePauseBtn = document.querySelector('.play-pause-btn[data-state="playing"]');
            if (activePauseBtn) {
                activePauseBtn.classList.add('active-pause-btn');
                
                // Remove o destaque após 5 segundos
                setTimeout(() => {
                    activePauseBtn.classList.remove('active-pause-btn');
                }, 5000);
            }
        }
    </script>

    <!-- The Time Alert Modal -->
    <div id="timeAlertModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Tempo Estimado Atingido</h3>
            <p id="timeAlertMessage" style="margin-bottom: 20px;"></p>
            <div style="display: flex; justify-content: center; gap: 10px;">
                <button onclick="handleTimeAlertResponse(true)" style="background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Sim</button>
                <button onclick="handleTimeAlertResponse(false)" style="background-color: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Não</button>
            </div>
        </div>
    </div>

    <style>
        .session-time {
            font-size: clamp(0.7rem, 1.2vw, 0.8rem);
            color: #F58838;
            margin-top: 20px;
            text-align: center;
            padding: 10px 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
    
    <script>
        // Sidebar toggle functionality
        var sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                var sidebar = document.querySelector('.sidebar');
                var menuIcon = document.getElementById('menuIcon');
                var closeIcon = document.getElementById('closeIcon');
                
                sidebar.classList.toggle('active');
                document.body.classList.toggle('sidebar-active');
                
                if (sidebar.classList.contains('active')) {
                    menuIcon.style.display = 'none';
                    closeIcon.style.display = 'block';
                } else {
                    menuIcon.style.display = 'block';
                    closeIcon.style.display = 'none';
                }
            });
        }
        
        // Session timer functionality
        function updateSessionTimer() {
            if (!sessionStartTime) return;
            
            var sessionTimerElement = document.getElementById('sessionTimer');
            if (!sessionTimerElement) return; // Verificação se o elemento existe
            
            var now = new Date();
            var diffMs = now - sessionStartTime;
            var diffSec = Math.floor(diffMs / 1000);
            
            var hours = Math.floor(diffSec / 3600);
            var minutes = Math.floor((diffSec % 3600) / 60);
            var seconds = diffSec % 60;
            
            sessionTimerElement.textContent = 
                'Tempo de sessão: ' + (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }
        
        // Get session start time from localStorage or server or use current time as fallback
        var sessionStartTime;
        var storedTime = localStorage.getItem('sessionStartTime');
        
        if (storedTime) {
            sessionStartTime = new Date(storedTime);
        } else {
            sessionStartTime = new Date('{{ session.login_time }}' || Date.now());
            localStorage.setItem('sessionStartTime', sessionStartTime);
        }
        
        // Update timer immediately and then every second
        updateSessionTimer();
        setInterval(updateSessionTimer, 1000);
        
        // Clear localStorage on logout
        var logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('sessionStartTime');
            });
        }
        
        var modal = document.getElementById('stepsModal');
        var modalTitle = document.getElementById('modalTitle');
        var stepsList = document.getElementById('stepsList');

        var currentAlertOrderId = null;

        // Registrar Service Worker para notificações
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js').then(function(registration) {
                    console.log('ServiceWorker registrado com sucesso:', registration.scope);
                    requestNotificationPermission();
                }).catch(function(error) {
                    console.log('Falha ao registrar ServiceWorker:', error);
                });
            });
        }

        // Função para solicitar permissão de notificação
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Permissão de notificação concedida');
                }
            } catch (error) {
                console.error('Erro ao solicitar permissão:', error);
            }
        }

        // Função para mostrar notificação nativa
        function showNativeNotification(title, body) {
            if (Notification.permission === 'granted') {
                try {
                    new Notification(title, {
                        body: body,
                        icon: '/static/logo.svg'
                    });
                } catch (error) {
                    console.error('Erro ao mostrar notificação:', error);
                }
            }
        }

        // Função para mostrar o modal de alerta de tempo
        function showTimeAlertModal(orderId, orderName) {
            currentAlertOrderId = orderId;
            const message = document.getElementById('timeAlertMessage');
            message.textContent = `O apontamento para a O.S ${orderName} atingiu o tempo estimado. A ordem de serviço foi concluída?`;
            document.getElementById('timeAlertModal').style.display = 'block';
            
            // Adicionar notificação nativa
            showNativeNotification(
                'Tempo Estimado Atingido',
                `O apontamento para a O.S ${orderName} atingiu o tempo estimado.`
            );
        }

        // Solicitar permissão quando a página carregar
        document.addEventListener('DOMContentLoaded', requestNotificationPermission);

        // Função para lidar com a resposta do usuário ao alerta de tempo
        function handleTimeAlertResponse(confirmed) {
            document.getElementById('timeAlertModal').style.display = 'none';
            if (confirmed && currentAlertOrderId) {
                completeOrder(currentAlertOrderId);
            }
            currentAlertOrderId = null;
        }

        // Função para registrar eventos da ordem (play, pause, complete)
        function registerOrderEvent(orderId, eventType) {
            fetch(`/api/order/${orderId}/event`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    event_type: eventType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Se for um evento de conclusão, atualizar a interface
                    if (eventType === 'complete') {
                        // Atualizar o status da ordem na interface
                        const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                        if (orderCard) {
                            // Mover o card para a coluna 'Concluída'
                            const completedColumn = document.querySelector('.order-column[data-status="Concluída"]');
                            if (completedColumn) {
                                completedColumn.querySelector('.order-list').appendChild(orderCard);
                            }
                        }
                    }
                } else {
                    console.error('Erro ao registrar evento:', data.error);
                }
            })
            .catch(error => {
                console.error('Erro ao registrar evento:', error);
            });
        }
        
        // Função para chamar o registro do evento 'complete' e parar o timer
        function completeOrder(orderId) {
            // Opcional: Adicionar confirmação antes de concluir
            // if (!confirm(`Tem certeza que deseja concluir a O.S. #${orderId}?`)) {
            //     return; // Cancela se o usuário não confirmar
            // }

            // 1. Registrar o evento 'complete' no backend
            registerOrderEvent(orderId, 'complete');

            // 2. Parar e limpar o timer no frontend, se existir e estiver ativo
            if (timers[orderId]) {
                if (timers[orderId].interval) {
                    clearInterval(timers[orderId].interval); // Para o intervalo
                    timers[orderId].interval = null; // Define o intervalo como nulo
                }
                
                // Atualizar o botão para o estado 'paused' (ícone de play)
                const btn = document.querySelector(`.play-pause-btn[onclick="toggleTimer('${orderId}')"]`);
                if (btn) {
                    btn.dataset.state = 'paused';
                    btn.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    `;
                    // Desabilitar o botão play/pause após concluir
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            }
            
            // Opcional: Desabilitar o próprio botão de concluir após o clique
             const completeBtn = document.querySelector(`.complete-btn[onclick="completeOrder('${orderId}')"]`);
             if (completeBtn) {
                 completeBtn.disabled = true;
                 completeBtn.style.opacity = 0.5; // Indicar visualmente que está desabilitado
             }
        }

        // Function to open the modal and fetch steps
        async function openModal(orderId) {
            modalTitle.textContent = `Etapas da O.S. #${orderId}`;
            stepsList.innerHTML = '<li>Carregando etapas...</li>'; // Show loading state
            modal.style.display = 'block';

            try {
                const response = await fetch(`/api/order/${orderId}/steps`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const steps = await response.json();

                stepsList.innerHTML = ''; // Clear loading/previous steps
                if (steps && steps.length > 0) {
                    steps.forEach(step => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>Etapa:</strong> ${step.name || 'N/A'} <br>
                            <strong>Tempo Estimado:</strong> ${step.estimated_time || 'N/A'} <br>
                            <strong>Equipamento:</strong> ${step.equipment || 'N/A'}
                        `;
                        stepsList.appendChild(li);
                    });
                } else {
                    stepsList.innerHTML = '<li>Nenhuma etapa encontrada para esta O.S.</li>';
                }
            } catch (error) {
                console.error('Erro ao buscar etapas:', error);
                stepsList.innerHTML = '<li>Erro ao carregar as etapas. Tente novamente.</li>';
            }
        }

        // Function to close the modal
        function closeModal() {
            modal.style.display = 'none';
        }

        // Timer functionality with localStorage persistence
        const timers = {};
        
        // Load saved timer states from localStorage
        function loadTimerStates() {
            const savedTimers = localStorage.getItem('orderTimers');
            if (savedTimers) {
                const timerStates = JSON.parse(savedTimers);
                Object.keys(timerStates).forEach(orderId => {
                    const timerState = timerStates[orderId];
                    const btn = document.querySelector(`.play-pause-btn[onclick="toggleTimer('${orderId}')"]`);
                    const timerDisplay = document.querySelector(`.timer-display[data-order-id="${orderId}"]`);
                    
                    if (btn && timerDisplay) {
                        // Inicializa o timer com o estado salvo
                        timers[orderId] = {
                            seconds: timerState.seconds,
                            interval: null // Sempre inicializa com interval null
                        };
                        
                        // Atualiza a exibição do timer
                        updateTimerDisplay(orderId);
                        timerDisplay.style.display = 'block';
                        
                        // Configura o estado visual do botão
                        if (timerState.isPlaying) {
                            // Se estava tocando, inicia o timer novamente
                            toggleTimer(orderId);
                        } else {
                            // Se estava pausado, garante que o estado visual seja de pausa
                            btn.dataset.state = 'paused';
                            btn.innerHTML = `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            `;
                            // Garante que o interval seja null para timers pausados
                            clearInterval(timers[orderId].interval);
                            timers[orderId].interval = null;
                            // Salva o estado para garantir consistência
                            saveTimerState(orderId);
                        }
                    }
                });
            }
        }
        
        // Save timer state to localStorage
        function saveTimerState(orderId) {
            const savedTimers = localStorage.getItem('orderTimers') || '{}';
            const timerStates = JSON.parse(savedTimers);
            
            timerStates[orderId] = {
                seconds: timers[orderId].seconds,
                isPlaying: timers[orderId].interval !== null
            };
            
            localStorage.setItem('orderTimers', JSON.stringify(timerStates));
        }
        
        // Update timer display
        function updateTimerDisplay(orderId) {
            const timerDisplay = document.querySelector(`.timer-display[data-order-id="${orderId}"]`);
            const timerValue = timerDisplay.querySelector('.timer-value');
            const hours = Math.floor(timers[orderId].seconds / 3600);
            const minutes = Math.floor((timers[orderId].seconds % 3600) / 60);
            const secs = timers[orderId].seconds % 60;
            timerValue.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // Check if estimated time is reached
            const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
            if (orderCard) {
                const estimatedTimeText = orderCard.querySelector('.card-detail:nth-last-child(3)').textContent;
                const matches = estimatedTimeText.match(/(\d+):(\d+)/);
                if (matches) {
                    const estimatedMinutes = parseInt(matches[1]) * 60 + parseInt(matches[2]);
                    const elapsedMinutes = hours * 60 + minutes;
                    
                    if (elapsedMinutes >= estimatedMinutes && !timers[orderId].alertShown) {
                        const orderName = orderCard.querySelector('.card-title').textContent;
                        showTimeAlertModal(orderId, orderName);
                        timers[orderId].alertShown = true;
                    }
                }
            }
        }
        
        function toggleTimer(orderId) {
            const btn = document.querySelector(`.play-pause-btn[onclick="toggleTimer('${orderId}')"]`);
            const timerDisplay = document.querySelector(`.timer-display[data-order-id="${orderId}"]`);
            
            // Check if there's already an active timer
            const activeBtn = document.querySelector('.play-pause-btn[data-state="playing"]');
            if (activeBtn && activeBtn !== btn) {
                // Show alert modal
                document.getElementById('activeOrderAlertModal').style.display = 'block';
                document.getElementById('currentOrderName').textContent = activeBtn.closest('.order-card').querySelector('.card-title').textContent;
                return;
            }
            
            // Initialize timer object if it doesn't exist
            if (!timers[orderId]) {
                timers[orderId] = {
                    seconds: 0,
                    interval: null
                };
            }
            
            // Determine current state based on interval
            const isCurrentlyPlaying = timers[orderId].interval !== null;
            
            if (!isCurrentlyPlaying) {
                // Start timer and register play event
                btn.dataset.state = 'playing';
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                `;
                timerDisplay.style.display = 'block';
                
                timers[orderId].interval = setInterval(() => {
                    timers[orderId].seconds++;
                    updateTimerDisplay(orderId);
                    saveTimerState(orderId);
                }, 1000);
                
                // Register play event after starting the timer
                registerOrderEvent(orderId, 'play')
                    .catch(error => {
                        console.error('Erro ao registrar evento de play:', error);
                    });
            } else {
                // Pause timer first
                clearInterval(timers[orderId].interval);
                timers[orderId].interval = null;
                
                btn.dataset.state = 'paused';
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                `;
                
                saveTimerState(orderId);
                
                // Register pause event after pausing the timer
                registerOrderEvent(orderId, 'pause')
                    .catch(error => {
                        console.error('Erro ao registrar evento de pause:', error);
                    });
            }
        }

        // Load saved timer states when page loads
        document.addEventListener('DOMContentLoaded', loadTimerStates);

        // Add click listeners to all order cards, excluding action buttons
        document.querySelectorAll('.order-card').forEach(card => {
            // Extract order ID from the data attribute
            const orderId = card.dataset.orderId;
            if (orderId) {
                card.addEventListener('click', (e) => {
                    // Only open modal if click is directly on the card (not children)
                    if (e.target === card) {
                        openModal(orderId);
                    }
                });
            }
        });

        // Close modal if user clicks outside of the modal content
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
<script>
        // Toggle theme button functionality
        document.getElementById('themeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-theme');

            // Salvar preferência no localStorage
            if (document.body.classList.contains('dark-theme')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Aplicar tema salvo ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
          // Fecha a sidebar ao clicar na navbar
          const navbar = document.querySelector('.navbar');
          if (navbar) {
            navbar.addEventListener('click', function(e) {
              if (!e.target.closest('.sidebar-toggle-btn')) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.classList.contains('active')) {
                  sidebar.classList.remove('active');
                  document.body.classList.remove('sidebar-active');
                  const menuIcon = document.getElementById('menuIcon');
                  const closeIcon = document.getElementById('closeIcon');
                  if (menuIcon) menuIcon.style.display = 'block';
                  if (closeIcon) closeIcon.style.display = 'none';
                }
              }
            });
          }

          // Fecha a sidebar ao clicar no conteúdo principal
          const contentContainer = document.getElementById('content-container');
          if (contentContainer) {
            contentContainer.addEventListener('click', function() {
              const sidebar = document.querySelector('.sidebar');
              if (sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                document.body.classList.remove('sidebar-active');
                const menuIcon = document.getElementById('menuIcon');
                const closeIcon = document.getElementById('closeIcon');
                if (menuIcon) menuIcon.style.display = 'block';
                if (closeIcon) closeIcon.style.display = 'none';
              }
            });
          }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }
            // Os ícones são atualizados automaticamente pelo CSS com base na classe 'dark-theme' do body
        });
    </script>
<script>
    // Log de início do script principal
    try {
        var xhr_main = new XMLHttpRequest();
        xhr_main.open('POST', '/api/debug-log', true);
        xhr_main.setRequestHeader('Content-Type', 'application/json');
        xhr_main.send(JSON.stringify({message: 'SCRIPT PRINCIPAL INICIANDO - Definindo loadContent...', level: 'INFO', source: 'MAIN-SCRIPT'}));
    } catch (e) {
        console.log('Erro no log principal:', e);
    }

    // Função para carregar conteúdo dinamicamente
    function loadContent(pageName) {
        // Fechar sidebar automaticamente quando carregar conteúdo
        var sidebar = document.querySelector('.sidebar');
        var body = document.body;
        if (sidebar && sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
            body.classList.remove('sidebar-active');
            
            // Atualizar ícones do toggle
            var menuIcon = document.getElementById('menuIcon');
            var closeIcon = document.getElementById('closeIcon');
            if (menuIcon) menuIcon.style.display = 'block';
            if (closeIcon) closeIcon.style.display = 'none';
        }
        
        // Obter containers
        var boardContainer = document.querySelector('.board-container');
        var contentContainer = document.getElementById('content-container');

        if (!contentContainer) {
            console.error('Element #content-container not found');
            return;
        }

        // Limpar conteúdo atual e event listeners
        contentContainer.innerHTML = '';
        contentContainer.style.display = 'none';

        // Remover todos os scripts dinâmicos anteriores
        document.querySelectorAll('script[data-dynamic="true"]').forEach(script => script.remove());

        // Se for dashboard, mostrar board container e limpar content container
        if (pageName === 'dashboard.html' || !pageName) {
            if (boardContainer) {
                boardContainer.style.display = 'flex';
            }
            // Limpar atributo da página atual
            contentContainer.removeAttribute('data-current-page');
            // Atualizar indicador do módulo
            updateModuleIndicator('dashboard.html');
            if (window.location.pathname !== '/dashboard' && window.location.pathname !== '/') {
                window.location.href = '/dashboard';
            }
            return;
        }

        // Mostrar indicador de carregamento
        contentContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Carregando...</div>';
        contentContainer.style.display = 'block';
        if (boardContainer) {
            boardContainer.style.display = 'none';
        }

        // Para outras páginas, carregamos no contentContainer e escondemos o boardContainer.
        // Se for a página de usuários, fazemos fetch na rota Flask para obter os dados
        var url = pageName === 'usuarios.html' ? '/usuarios' : pageName;
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                }
                return response.text();
            })
            .then(html => {
                contentContainer.innerHTML = html;
                contentContainer.style.display = 'block'; // Garante que o container de conteúdo está visível
                
                // Marcar a página atual para facilitar o refresh
                contentContainer.setAttribute('data-current-page', pageName);
                
                if (boardContainer) boardContainer.style.display = 'none'; // Esconde o boardContainer ao carregar outra página

                // Se for a página de estoque, apenas carrega a lista inicial
                if (pageName === 'estoque.html') {
                    // Carrega a lista inicial de estoque
                    if (typeof carregarListaEstoque === 'function') {
                        carregarListaEstoque();
                    }
                    
                    // NÃO configura event listeners aqui - eles são configurados no próprio estoque.html
                    // para evitar duplicação
                    
                    // Event listeners de entrada e saída também são configurados no estoque.html
                    // Removido para evitar duplicação
                } else if (pageName === 'entrada_estoque.html') {
                    // Inicializa função para carregar lista de entradas
                    if (typeof carregarListaEntradas === 'function') {
                        carregarListaEntradas();
                    }
                }

                // Executar scripts do conteúdo carregado
                const scripts = Array.from(contentContainer.getElementsByTagName('script'));
                const loadScriptPromises = scripts.map(oldScript => {
                    return new Promise((resolve, reject) => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        
                        // Se for um script externo
                        if (oldScript.src) {
                            newScript.onload = resolve;
                            newScript.onerror = reject;
                        }
                        
                        // Se for um script inline
                        if (oldScript.innerHTML) {
                            newScript.innerHTML = oldScript.innerHTML;
                        }
                        
                        // Remove o script antigo
                        oldScript.parentNode.removeChild(oldScript);
                        
                        // Adiciona o novo script
                        contentContainer.appendChild(newScript);
                        
                        // Se for um script inline, resolve imediatamente
                        if (!oldScript.src) {
                            resolve();
                        }
                    });
                });
                
                // Aguarda todos os scripts serem carregados
                Promise.all(loadScriptPromises)
                    .then(() => {
                        // Marcar todos os scripts como dinâmicos
                        scripts.forEach(script => {
                            script.setAttribute('data-dynamic', 'true');
                        });

                        // Inicializar scripts específicos baseado na página
                        if (pageName === 'estoque.html' && typeof window.initializeEstoqueScripts === 'function') {
                            setTimeout(() => {
                                window.initializeEstoqueScripts();
                            }, 100);
                        } else if (pageName === 'clientes.html' && typeof window.initializeClientesScripts === 'function') {
                            setTimeout(() => {
                                window.initializeClientesScripts();
                            }, 100);
                        } else if (pageName === 'produtos.html' && typeof window.initializeProdutosScripts === 'function') {
                            setTimeout(() => {
                                console.log('🔧 Inicializando produtos via dashboard...');
                                window.initializeProdutosScripts();
                            }, 150);
                        } else if (pageName === 'ferramentas.html' && typeof window.initializeFerramentasScripts === 'function') {
                            setTimeout(() => {
                                window.initializeFerramentasScripts();
                            }, 100);
                        } else if (pageName === 'etapas_confeccao.html' && typeof window.initializeEtapasScripts === 'function') {
                            setTimeout(() => {
                                console.log('🔧 Inicializando etapas via dashboard...');
                                window.initializeEtapasScripts();
                            }, 150);
                        } else if (pageName === 'orcamentos.html' && typeof window.initializeOrcamentosScripts === 'function') {
                            setTimeout(() => {
                                console.log('🔧 Inicializando orçamentos via dashboard...');
                                window.initializeOrcamentosScripts();
                            }, 150);
                        } else if (pageName === 'pdv.html') {
                            setTimeout(() => {
                                console.log('🔧 [DASHBOARD] Inicializando PDV via dashboard...');
                                
                                // Log inicial via Flask
                                var xhr_pdv_start = new XMLHttpRequest();
                                xhr_pdv_start.open('POST', '/api/debug-log', true);
                                xhr_pdv_start.setRequestHeader('Content-Type', 'application/json');
                                xhr_pdv_start.send(JSON.stringify({
                                    message: '🔧 [DASHBOARD] INICIANDO PDV - Scripts carregados, verificando função initializePDV...',
                                    level: 'INFO',
                                    source: 'DASHBOARD-PDV-START'
                                }));
                                
                                // Verificar se função existe
                                console.log('[DASHBOARD] Verificando window.initializePDV:', typeof window.initializePDV);
                                console.log('[DASHBOARD] Todas as funções window disponíveis:', Object.keys(window).filter(k => k.includes('initialize')));
                                
                                if (typeof window.initializePDV === 'function') {
                                    console.log('[DASHBOARD] ✅ Função encontrada, chamando initializePDV...');
                                    
                                    var xhr_pdv_call = new XMLHttpRequest();
                                    xhr_pdv_call.open('POST', '/api/debug-log', true);
                                    xhr_pdv_call.setRequestHeader('Content-Type', 'application/json');
                                    xhr_pdv_call.send(JSON.stringify({
                                        message: '✅ [DASHBOARD] PDV FUNCTION FOUND - Chamando window.initializePDV()...',
                                        level: 'SUCCESS',
                                        source: 'DASHBOARD-PDV-CALL'
                                    }));
                                    
                                    try {
                                        window.initializePDV();
                                        
                                        var xhr_pdv_success = new XMLHttpRequest();
                                        xhr_pdv_success.open('POST', '/api/debug-log', true);
                                        xhr_pdv_success.setRequestHeader('Content-Type', 'application/json');
                                        xhr_pdv_success.send(JSON.stringify({
                                            message: '🎉 [DASHBOARD] PDV INICIALIZADO COM SUCESSO - initializePDV() executada sem erros!',
                                            level: 'SUCCESS',
                                            source: 'DASHBOARD-PDV-SUCCESS'
                                        }));
                                    } catch (error) {
                                        console.error('[DASHBOARD] Erro ao executar initializePDV:', error);
                                        
                                        var xhr_pdv_error = new XMLHttpRequest();
                                        xhr_pdv_error.open('POST', '/api/debug-log', true);
                                        xhr_pdv_error.setRequestHeader('Content-Type', 'application/json');
                                        xhr_pdv_error.send(JSON.stringify({
                                            message: '💥 [DASHBOARD] ERRO EXECUÇÃO PDV - Exceção ao executar initializePDV(): ' + error.message,
                                            level: 'ERROR',
                                            source: 'DASHBOARD-PDV-EXCEPTION'
                                        }));
                                    }
                                } else {
                                    console.error('[DASHBOARD] ❌ Função initializePDV não encontrada!');
                                    
                                    var xhr_pdv_not_found = new XMLHttpRequest();
                                    xhr_pdv_not_found.open('POST', '/api/debug-log', true);
                                    xhr_pdv_not_found.setRequestHeader('Content-Type', 'application/json');
                                    xhr_pdv_not_found.send(JSON.stringify({
                                        message: '❌ [DASHBOARD] PDV FUNCTION NOT FOUND - window.initializePDV não está disponível! Tipo atual: ' + (typeof window.initializePDV) + ' | Functions disponíveis: ' + Object.keys(window).filter(k => k.includes('PDV')).join(', '),
                                        level: 'ERROR',
                                        source: 'DASHBOARD-PDV-NOT-FOUND'
                                    }));
                                }
                            }, 150);
                        }
                        
                        // Reativa os event listeners após todos os scripts serem carregados
                        if (pageName === 'usuarios.html') {
                            // Reativa os event listeners dos dropdowns customizados
                            const customSelects = document.querySelectorAll('.custom-select');
                            customSelects.forEach(select => {
                                const button = select.querySelector('button');
                                const optionsContainer = select.querySelector('div');
                                const optionButtons = [...select.querySelectorAll('div > button')];

                                optionButtons.forEach(optionButton => {
                                    optionButton.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        const buttonText = optionButton.textContent;
                                        const buttonValue = optionButton.getAttribute('data-value') || buttonText;
                                        button.textContent = buttonText;
                                        button.setAttribute('data-value', buttonValue);
                                        optionsContainer.style.height = '0';
                                        select.blur();
                                    });
                                });

                                button.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    if (optionsContainer.style.height === '0px' || optionsContainer.style.height === '') {
                                        customSelects.forEach(otherSelect => {
                                            if (otherSelect !== select) {
                                                otherSelect.querySelector('div').style.height = '0';
                                            }
                                        });
                                        optionsContainer.style.height = 'auto';
                                    } else {
                                        optionsContainer.style.height = '0';
                                    }
                                });
                            });

                            document.addEventListener('click', (event) => {
                                customSelects.forEach(select => {
                                    if (!select.contains(event.target)) {
                                        select.querySelector('div').style.height = '0';
                                    }
                                });
                            });

                            // Reativa o event listener da imagem de perfil
                            const userProfileImage = document.getElementById('userProfileImage');
                            if (userProfileImage) {
                                userProfileImage.addEventListener('change', function(event) {
                                    const reader = new FileReader();
                                    const preview = document.getElementById('profileImagePreview');
                                    reader.onload = function() {
                                        preview.src = reader.result;
                                        preview.style.display = 'block';
                                    }
                                    if (event.target.files[0]) {
                                        reader.readAsDataURL(event.target.files[0]);
                                    }
                                });
                            }

                            // Reativa o event listener do botão de salvar
                            const saveButton = document.getElementById('save-user-btn');
                            if (saveButton) {
                                saveButton.addEventListener('click', async function() {
                                    const mode = this.getAttribute('data-mode');
                                    const id = this.getAttribute('data-id');
                                    const formData = new FormData();
                                    
                                    const nome = document.getElementById('userName').value;
                                    const email = document.getElementById('userEmail').value;
                                    const senha = document.getElementById('userPassword').value;
                                    const cargoButton = document.querySelector('#userRoleModal button');
                                    const nivelAcessoButton = document.querySelector('#userAccessLevelModal button');
                                    const cargo = cargoButton.getAttribute('data-value') || cargoButton.textContent;
                                    const nivelAcesso = nivelAcessoButton.getAttribute('data-value') || nivelAcessoButton.textContent;
                                    const fotoInput = document.getElementById('userProfileImage');
                                    
                                    if (!nome || !email || (mode === 'add' && !senha) || cargo === 'Selecione o Cargo' || nivelAcesso === 'Nível de Acesso') {
                                        alert('Por favor, preencha todos os campos obrigatórios.');
                                        return;
                                    }
                                    
                                    formData.append('nome', nome);
                                    formData.append('email', email);
                                    if (senha) formData.append('senha', senha);
                                    formData.append('cargo', cargo.toLowerCase());
                                    const nivelAcessoNumero = parseInt(nivelAcesso.match(/\d+/)?.[0]) || 1;
                                    formData.append('nivel_de_acesso', nivelAcessoNumero);
                                    if (fotoInput.files[0]) {
                                        formData.append('foto_de_perfil', fotoInput.files[0]);
                                    }
                                    
                                    try {
                                        const url = mode === 'edit' ? `/api/usuarios/${id}` : '/api/usuarios';
                                        const method = mode === 'edit' ? 'PUT' : 'POST';
                                        const response = await fetch(url, {
                                            method: method,
                                            body: formData
                                        });
                                        const result = await response.json();
                                        
                                        if (response.ok) {
                                            showNotificationModal(mode === 'edit' ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!', 'success');
                                            // Fechar o modal
                                            document.getElementById('userModal').style.display = 'none';
                                            // Atualizar a lista em vez de recarregar a página
                                            if (typeof atualizarListaUsuarios === 'function') {
                                                atualizarListaUsuarios();
                                            } else {
                                                console.error('Função atualizarListaUsuarios não encontrada');
                                            }
                                        } else {
                                            showNotificationModal(`Erro ao ${mode === 'edit' ? 'atualizar' : 'criar'} usuário: ${result.message}`, 'error');
                                        }
                                    } catch (error) {
                                        showNotificationModal(`Erro ao ${mode === 'edit' ? 'atualizar' : 'criar'} usuário. Por favor, tente novamente.`, 'error');
                                        console.error('Erro:', error);
                                    }
                                });
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar scripts:', error);
                    });

                // If clientes.html is loaded, make fetch request to API endpoint
                if (pageName === 'clientes.html') {
                    // Verificar se loadClients() existe antes de chamar
                    if (typeof loadClients === 'function') {
                        loadClients();
                    } else {
                        // Se loadClients() não existir, fazer a chamada manualmente
                        fetch('/api/clientes')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Erro ao carregar clientes.');
                                }
                                return response.json();
                            })
                            .then(result => {
                                if (result.length > 0) {
                                    const clientsListDiv = document.querySelector('.clientes-list');
                                    clientsListDiv.innerHTML = ''; // Limpa a lista existente
    
                                    result.forEach(client => {
                                        const clientItem = document.createElement('div');
                                        clientItem.classList.add('clientes-item');
                                        clientItem.innerHTML = `
                                            <div>${client.nome}</div>
                                            <div>${client.email}</div>
                                            <div>${client.telefone}</div>
                                            <div>${client.whatsapp || ''}</div>
                                            <div>${client.bairro || ''}</div>
                                            <div class="clientes-actions">
                                                <button class="action-btn" onclick="editClient(${client.id})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/></svg>
                                                </button>
                                                <button class="action-btn" onclick="deleteClient(${client.id})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                                </button>
                                            </div>
                                        `;
                                        clientsListDiv.appendChild(clientItem);
                                    });
                                } else {
                                    clientsListDiv.innerHTML = '<p>Nenhum cliente encontrado.</p>';
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao carregar clientes:', error);
                                document.querySelector('.clientes-list').innerHTML =
                                    '<p>Erro ao carregar clientes. Por favor, tente novamente.</p>';
                            });
                    }
                }
                
                // Atualizar indicador do módulo
                updateModuleIndicator(pageName);
            })
            .catch(error => {
                console.error('Erro ao carregar o conteúdo:', error);
                contentContainer.innerHTML = `<p style="color: red; text-align: center;">Erro ao carregar ${pageName}. Verifique o console.</p>`;
                contentContainer.style.display = 'block'; // Mostra a mensagem de erro
                if (boardContainer) boardContainer.style.display = 'none';
            });
    }

    // Disponibilizar a função imediatamente após sua definição
    window.loadContent = loadContent;
    
    // Log de confirmação que loadContent foi definida
    try {
        var xhr_assigned = new XMLHttpRequest();
        xhr_assigned.open('POST', '/api/debug-log', true);
        xhr_assigned.setRequestHeader('Content-Type', 'application/json');
        xhr_assigned.send(JSON.stringify({message: 'LOADCONTENT DEFINIDA! Tipo: ' + typeof window.loadContent, level: 'SUCCESS', source: 'MAIN-SCRIPT'}));
    } catch (e) {
        console.log('Erro no log de atribuição:', e);
    }

    // Função para atualizar o indicador do módulo atual
    function updateModuleIndicator(pageName) {
        const moduleIndicator = document.getElementById('moduleIndicator');
        if (!moduleIndicator) return;
        
        // Mapeamento de nomes de páginas para nomes de módulos
        const moduleNames = {
            'dashboard.html': 'Dashboard',
            'produtos.html': 'Produtos',
            'materiais.html': 'Materiais',
            'estoque.html': 'Estoque',
            'entrada_estoque.html': 'Entrada de Estoque',
            'saida_estoque.html': 'Saída de Estoque',
            'clientes.html': 'Clientes',
            'orcamentos.html': 'Orçamentos',
            'pdv.html': 'PDV',
            'vendas.html': 'Vendas',
            'relatorios_vendas.html': 'Relatórios',
            'relatorios_estoque.html': 'Relatórios de Estoque',
            'relatorios_financeiros.html': 'Relatórios Financeiros',
            'etapas_confeccao.html': 'Etapas de Confecção',
            'ferramentas.html': 'Ferramentas',
            'maquinas.html': 'Máquinas',
            'backup_exportacao.html': 'Backup/Exportação',
            'usuarios.html': 'Usuários',
            'permissoes.html': 'Permissões',
            'configuracoes_gerais.html': 'Configurações',
            'backup.html': 'Backup'
        };
        
        const moduleName = moduleNames[pageName] || 'Dashboard';
        moduleIndicator.textContent = moduleName;
    }

    // Funções do dropdown já definidas no início do arquivo

    // Configurar event listeners da sidebar
    function setupSidebarListeners() {
        document.querySelectorAll('.sidebar-nav li[onclick]').forEach(item => {
            // Remover manipulador onclick antigo
            const onclickValue = item.getAttribute('onclick');
            item.removeAttribute('onclick');
            
            // Adicionar novo event listener
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageMatch = onclickValue.match(/loadContent\('([^']+)'\)/);
                if (pageMatch && pageMatch[1]) {
                    const pageToLoad = pageMatch[1];
                    // Remover classe active de todos os itens
                    document.querySelectorAll('.sidebar-nav li').forEach(li => {
                        li.classList.remove('active');
                    });
                    // Adicionar classe active ao item clicado
                    this.classList.add('active');
                    loadContent(pageToLoad);
                    
                    // Fechar a sidebar em dispositivos móveis
                    const sidebar = document.querySelector('.sidebar');
                    if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        document.body.classList.remove('sidebar-active');
                        document.getElementById('menuIcon').style.display = 'block';
                        document.getElementById('closeIcon').style.display = 'none';
                    }
                }
            });
        });
    }

    // Chamar setup inicial
    setupSidebarListeners();

    // DROPDOWN FUNCTIONS - DEFINIDAS APÓS loadContent PARA GARANTIR ACESSO
    try {
        // Log inicial
        console.log('[DROPDOWN] Iniciando funcoes dropdown após loadContent definida');
        
        // Funcao principal
        function toggleModuleDropdown() {
            console.log('[DROPDOWN] toggleModuleDropdown executado!');
            
            const menu = document.getElementById('moduleDropdownMenu');
            if (menu) {
                const currentDisplay = menu.style.display;
                console.log(`[DROPDOWN] Estado atual: display=${currentDisplay}`);
                
                if (currentDisplay === 'block') {
                    menu.style.display = 'none';
                    console.log('[DROPDOWN] Menu FECHADO');
                } else {
                    menu.style.display = 'block';
                    console.log('[DROPDOWN] Menu ABERTO');
                }
            } else {
                console.error('[DROPDOWN] Elemento moduleDropdownMenu não encontrado!');
            }
        }

        // Funcao para itens
        function handleDropdownItemClick(pageName) {
            console.log(`[DROPDOWN] Item clicado: ${pageName}`);
            console.log(`[DROPDOWN] loadContent disponível: ${typeof loadContent}`);
            console.log(`[DROPDOWN] window.loadContent disponível: ${typeof window.loadContent}`);
            
            // Usar a função loadContent que já está definida
            if (typeof loadContent === 'function') {
                loadContent(pageName);
                console.log('[DROPDOWN] loadContent executado com sucesso!');
            } else if (typeof window.loadContent === 'function') {
                window.loadContent(pageName);
                console.log('[DROPDOWN] window.loadContent executado com sucesso!');
            } else {
                console.error('[DROPDOWN] ERRO: loadContent não encontrado!');
                return;
            }
            
            // Fechar menu
            const menu = document.getElementById('moduleDropdownMenu');
            if (menu) {
                menu.style.display = 'none';
                console.log(`[DROPDOWN] Menu fechado após seleção de: ${pageName}`);
            }
        }

        // Atribuir ao window
        window.toggleModuleDropdown = toggleModuleDropdown;
        window.handleDropdownItemClick = handleDropdownItemClick;

        console.log('[DROPDOWN] Funções dropdown definidas com sucesso!');

    } catch (error) {
        console.error('[DROPDOWN] Erro ao definir funções:', error);
    }

    // Reconfigurar listeners quando a página carregar
    document.addEventListener('DOMContentLoaded', setupSidebarListeners);

    // Inicializa a visualização correta ao carregar a página
    document.addEventListener('DOMContentLoaded', () => {
  // Fecha a sidebar ao clicar na navbar
  document.querySelector('.navbar').addEventListener('click', function(e) {
    if (!e.target.closest('.sidebar-toggle-btn')) {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
        document.body.classList.remove('sidebar-active');
        document.getElementById('menuIcon').style.display = 'block';
        document.getElementById('closeIcon').style.display = 'none';
      }
    }
  });

  // Fecha a sidebar ao clicar no conteúdo principal
  document.getElementById('content-container').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar.classList.contains('active')) {
      sidebar.classList.remove('active');
      document.body.classList.remove('sidebar-active');
      document.getElementById('menuIcon').style.display = 'block';
      document.getElementById('closeIcon').style.display = 'none';
    }
  });

        const path = window.location.pathname;
        // Remove a barra inicial se houver e obtém o nome do arquivo/template
        const pageNameFromPath = path.startsWith('/') ? path.substring(1) : path;

        // Se estiver na raiz ou /dashboard, trata como dashboard.html
        if (path === '/' || path === '/dashboard' || pageNameFromPath === 'dashboard.html' || pageNameFromPath === '') {
            loadContent('dashboard.html');
        } else {
            // Para qualquer outra rota, tenta carregar o conteúdo correspondente
            // Isso assume que as rotas correspondem aos nomes dos templates (ex: /usuarios carrega usuarios.html)
            // Se a rota for, por exemplo, /usuarios, pageNameFromPath será 'usuarios'. Precisamos adicionar '.html'
            let templateName = pageNameFromPath;
            if (!templateName.endsWith('.html')) {
                templateName += '.html';
            }
            loadContent(templateName);
        }
    });

    // Disponibilizar loadContent globalmente para compatibilidade iOS
    window.loadContent = loadContent;
</script>
<!-- Modal de Notificação -->
<div id="notificationModal" class="modal">
    <div class="modal-content notification-modal-content">
        <span class="close-button" onclick="closeNotificationModal()">&times;</span>
        <div id="notificationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;"></div>
        <h2 id="notificationModalTitle"></h2>
        <p id="notificationModalMessage"></p>
        <button class="btn-primary" onclick="closeNotificationModal()">OK</button>
    </div>
</div>

<!-- Modal de Notificações do Sistema -->
<div id="notificationsListModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="modal-close" onclick="closeNotificationsModal()">&times;</span>
        <h3 class="modal-title">Notificações</h3>
        <div id="notificationsContainer" style="max-height: 400px; overflow-y: auto;" class="custom-scrollbar">
            <div id="notificationsList">
                <!-- Notificações serão carregadas aqui -->
                <div class="notification-loading">Carregando notificações...</div>
            </div>
        </div>
    </div>
</div>

<style>
    .notification-modal-content {
        max-width: 400px;
        text-align: center;
        padding: 30px;
    }
    .notification-modal-content .btn-primary {
        margin: 0 auto; /* Centraliza o botão OK */
        display: block; /* Garante que o margin auto funcione */
    }
    .notification-modal-content h2 {
        border-bottom: none;
        margin-bottom: 15px;
        font-size: 1.5em;
    }
    .notification-modal-content p {
        margin-bottom: 20px;
        font-size: 1.1em;
    }
    .notification-modal-content .btn-primary {
        margin-top: 0;
        padding: 10px 20px;
    }
    .notification-modal-content.success h2 {
        color: #4CAF50; /* Green for success */
    }
    .notification-modal-content.error h2 {
        color: #F44336; /* Red for error */
    }
    
    /* Estilos para o sistema de notificações */
    .notification-btn {
        position: relative;
    }
    
    .notification-btn:hover {
        transform: scale(1.1);
    }
    
    .notification-count {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #9B64E3;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .notification-item {
        border-color: #9B64E3;
        border-radius: 3px;
        border: 3px;;
        padding: 15px;
        margin-bottom: 30px;
        margin-right: 30px;
        margin-top: 30px;
        margin-left: 30px;
        transition: background-color 0.3s ease;
        position: relative;
    }
    
    .notification-item:hover {
        background-color: #9b64e367;
        border-radius: 5px;
        border-color: #9B64E3;
    }
    
    .notification-item.unread {
        border: 2px solid #9B64E3;
        border-radius: 5px;
    }
    
    .notification-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--card-title-text);
    }
    
    .notification-message {
        color: var(--card-detail-text);
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    
    .notification-time {
        color: var(--card-detail-text);
        font-size: 0.8em;
        opacity: 0.8;
    }
    
    .notification-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
    }
    
    .mark-read-btn {
        background-color: rgba(155, 100, 227, 0.368);
        border: 1px solid #9B64E3;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        transition: all 0.3s ease;
    }
    
    .mark-read-btn:hover {
        background-color: #D8CEFE;
        color: white;
    }
    
    .notification-loading {
        text-align: center;
        padding: 20px;
        color: var(--card-detail-text);
    }
    
    .no-notifications {
        text-align: center;
        padding: 20px;
        color: var(--card-detail-text);
        font-style: italic;
    }

    /* Estilos para o banner de notificação */
    .notification-banner {
        position: fixed;
        top: 70px; /* Abaixo da navbar */
        left: 50%;
        transform: translateX(-50%);
        background: rgba(68, 7, 148, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 2px solid #9B64E3;
        border-radius: 10px;
        color: white;
        padding: 15px 20px;
        box-shadow: 0 4px 15px rgba(155, 100, 227, 0.4);
        z-index: 1002; /* Acima da navbar */
        min-width: 300px;
        max-width: 500px;
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .notification-banner.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .notification-banner.success {
        background-color: rgba(40, 167, 69, 0.2);
        border: 1px solid #28a745;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .notification-banner.error {
        background-color: rgba(220, 53, 69, 0.2);
        border: 1px solid #dc3545;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
    }

    .notification-banner.warning {
        border-color: #f59e0b;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    .notification-banner.info {
        border-color: #3b82f6;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .banner-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .banner-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }

    .banner-message {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
    }

    .banner-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
        font-size: 18px;
        line-height: 1;
        flex-shrink: 0;
    }

    .banner-close:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Animação do check */
    .check-animation {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #22c55e;
        background-color: transparent;
        position: relative;
        animation: checkBounce 0.6s ease-in-out;
    }

    .check-animation::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 6px;
        height: 12px;
        border: solid #22c55e;
        border-width: 0 2px 2px 0;
        transform: translate(-50%, -60%) rotate(45deg);
        animation: checkMark 0.3s ease-in-out 0.3s both;
        opacity: 0;
    }

    @keyframes checkBounce {
        0%, 20%, 53%, 80%, 100% {
            animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            transform: scale(1);
        }
        40%, 43% {
            animation-timing-function: cubic-bezier(0.755, 0.050, 0.855, 0.060);
            transform: scale(1.1);
        }
        70% {
            animation-timing-function: cubic-bezier(0.755, 0.050, 0.855, 0.060);
            transform: scale(1.05);
        }
        90% {
            transform: scale(1.02);
        }
    }

    @keyframes checkMark {
        0% {
            opacity: 0;
            transform: translate(-50%, -60%) rotate(45deg) scale(0);
        }
        100% {
            opacity: 1;
            transform: translate(-50%, -60%) rotate(45deg) scale(1);
        }
    }

    .banner-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* Estilos dos modais de confirmação */
    .modal {
        display: none;
        position: fixed;
        z-index: 10002;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    .notification-modal-content {
        max-width: 400px;
        text-align: center;
        padding: 30px;
        background-color: rgba(59, 12, 121, 0.29);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid #9B64E3;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        color: white;
    }

    .notification-modal-content h2 {
        margin-top: 0;
        color: white;
        font-size: 1.5em;
    }

    .notification-modal-content p {
        margin: 15px 0;
        font-size: 1.1em;
        line-height: 1.4;
    }

    .btn-primary, .btn-secondary {
        padding: 10px 20px;
        border: 2px solid #9B64E3;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .btn-primary {
        background-color: rgba(155, 100, 227, 0.1);
        color: white;
    }

    .btn-primary:hover {
        background-color: #D8CEFE;
        color: #1a1a1a;
    }

    .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* Modal de login para troca de usuário */
    #userChangeLoginModal {
        z-index: 10003 !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
    }

    #userChangeLoginModal .login-container {
        background-color: rgba(59, 12, 121, 0.29);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid #9B64E3;
        border-radius: 8px;
        padding: 30px;
        width: 300px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        color: white;
    }

    #userChangeLoginModal .form-group {
        margin-bottom: 15px;
    }

    #userChangeLoginModal .form-group label {
        display: block;
        margin-bottom: 5px;
        width: 88%;
        margin-left: auto;
        margin-right: auto;
        color: white;
    }

    #userChangeLoginModal .form-group input {
        width: 80%;
        padding: 10px;
        border: 1px solid #9B64E3;
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        display: block;
        margin: 0 auto;
    }

    #userChangeLoginModal .form-group input:focus {
        outline: none;
        border-color: #9B64E3;
        background-color: rgba(155, 100, 227, 0.1);
    }

    #userChangeLoginModal button[type="submit"] {
        width: 87%;
        padding: 10px;
        background-color: rgba(155, 100, 227, 0.1);
        color: white;
        border: 2px solid #9B64E3;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        display: block;
        margin: 0 auto;
    }

    #userChangeLoginModal button[type="submit"]:hover {
        background-color: #D8CEFE;
        color: #1a1a1a;
    }

    #userChangeLoginModal .flash-messages {
        margin-bottom: 15px;
    }

    #userChangeLoginModal .flash-messages .alert {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    #userChangeLoginModal .flash-messages .alert-success {
        background-color: rgba(40, 167, 69, 0.2);
        border: 1px solid #28a745;
    }

    #userChangeLoginModal .flash-messages .alert-danger {
        background-color: rgba(220, 53, 69, 0.2);
        border: 1px solid #dc3545;
    }

    /* Modal de notificações - seguir padrão visual dos outros modais */
    #notificationsListModal .modal-content {
        background-color: rgba(59, 12, 121, 0.29);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid #9B64E3;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        color: white;
        padding: 20px;
    }

    #notificationsListModal .modal-title {
        color: white;
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(155, 100, 227, 0.3);
        padding-bottom: 10px;
    }

    #notificationsListModal .modal-close {
        color: white;
        font-size: 24px;
        position: absolute;
        top: 15px;
        right: 20px;
        cursor: pointer;
        background: none;
        border: none;
    }

    #notificationsListModal .modal-close:hover {
        color: #D8CEFE;
    }

    #notificationsListModal .notification-loading,
    #notificationsListModal .no-notifications {
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        padding: 20px;
    }
</style>

<script>
    // Função para abrir o modal de notificações
    function openNotificationsModal() {
        const modal = document.getElementById('notificationsListModal');
        modal.classList.add('show');
        modal.style.display = 'flex';
        loadNotifications();
    }

    // Função para fechar o modal de notificações
    function closeNotificationsModal() {
        const modal = document.getElementById('notificationsListModal');
        modal.classList.remove('show');
        modal.style.display = 'none';
    }

    // Função para formatar data/hora
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Função para carregar as notificações
    async function loadNotifications() {
        const notificationsList = document.getElementById('notificationsList');
        notificationsList.innerHTML = '<div class="notification-loading">Carregando notificações...</div>';

        try {
            const response = await fetch('/api/notificacoes');
            const data = await response.json();

            if (data.status === 'success' && data.notificacoes && data.notificacoes.length > 0) {
                const unreadCount = data.notificacoes.filter(n => !n.lida).length;
                updateNotificationCount(unreadCount);

                notificationsList.innerHTML = data.notificacoes.map(notification => `
                    <div class="notification-item ${notification.lida ? '' : 'unread'} ${notification.tipo === 'estoque_baixo' ? 'low-stock' : ''}" data-id="${notification.id}">
                        <div class="notification-title">${notification.tipo === 'estoque_baixo' ? 'Alerta de Estoque' : notification.tipo}</div>
                        <div class="notification-message">${notification.mensagem}</div>
                        <div class="notification-time">${formatDateTime(notification.data_criacao)}</div>
                        ${!notification.lida ? `
                            <div class="notification-actions">
                                <button class="mark-read-btn" onclick="markNotificationAsRead(${notification.id})">Marcar como lida</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                notificationsList.innerHTML = '<div class="no-notifications">Nenhuma notificação encontrada.</div>';
                updateNotificationCount(0);
            }
        } catch (error) {
            console.error('Erro ao carregar notificações:', error);
            notificationsList.innerHTML = '<div class="notification-loading">Erro ao carregar notificações. Tente novamente.</div>';
        }
    }

    // Função para marcar uma notificação como lida
    async function markNotificationAsRead(notificationId) {
        try {
            const response = await fetch(`/api/notificacoes/marcar-como-lida/${notificationId}`, {
                method: 'PUT'
            });
            const data = await response.json();

            if (data.status === 'success') {
                const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.classList.remove('unread');
                    const actionsDiv = notificationItem.querySelector('.notification-actions');
                    if (actionsDiv) {
                        actionsDiv.remove();
                    }
                }
                // Recarregar notificações para atualizar contagem
                loadNotifications();
            } else {
                console.error('Erro ao marcar notificação como lida:', data.message);
            }
        } catch (error) {
            console.error('Erro ao marcar notificação como lida:', error);
        }
    }

    // Função para atualizar o contador de notificações
    function updateNotificationCount(count) {
        const countElement = document.getElementById('notificationCount');
        if (count > 0) {
            countElement.textContent = count;
            countElement.style.display = 'flex';
        } else {
            countElement.style.display = 'none';
        }
    }

    // Função para verificar itens com estoque baixo
    async function checkLowStockItems() {
        try {
            const response = await fetch('/api/estoque/check_low_stock');
            const data = await response.json();

            if (data.low_stock_items && data.low_stock_items.length > 0) {
                data.low_stock_items.forEach(item => {
                    showNativeNotification(
                        'Alerta de Estoque Baixo',
                        `O item ${item.name} está com estoque abaixo do mínimo (${item.current_quantity}/${item.min_stock})`
                    );
                });
            }
        } catch (error) {
            console.error('Erro ao verificar itens com estoque baixo:', error);
        }
    }

    // Verificar estoque baixo a cada hora
    setInterval(checkLowStockItems, 3600000);

    // Verificar estoque baixo ao carregar a página
    document.addEventListener('DOMContentLoaded', () => {
        checkLowStockItems();
        loadNotifications();
        
        // Processar mensagens flash e convertê-las em banner
        const flashMessages = document.querySelectorAll('.flash-messages .message');
        if (flashMessages.length > 0) {
            // Pegar a primeira mensagem flash
            const firstMessage = flashMessages[0];
            const messageText = firstMessage.textContent.trim();
            const messageCategory = firstMessage.className.replace('message ', '');
            
            // Esconder as mensagens flash tradicionais
            const flashContainer = document.querySelector('.flash-messages');
            if (flashContainer) {
                flashContainer.style.display = 'none';
            }
            
            // Mostrar no banner
            showBanner(messageText, messageCategory);
        }
    });

    // Função para mostrar o banner de notificação
    function showBanner(message, type = 'info') {
        const banner = document.getElementById('notificationBanner');
        const messageElement = document.getElementById('bannerMessage');
        const iconElement = document.getElementById('bannerIcon');
        
        messageElement.textContent = message;
        banner.className = `notification-banner ${type}`;
        
        // Definir ícone baseado no tipo
        if (type === 'success') {
            iconElement.innerHTML = '<div class="check-animation"></div>';
        } else if (type === 'error') {
            iconElement.innerHTML = '⚠️';
        } else {
            iconElement.innerHTML = 'ℹ️';
        }
        
        banner.style.display = 'block';
        
        // Animar entrada
        setTimeout(() => {
            banner.classList.add('show');
        }, 10);
        
        // Auto-fechar após 3 segundos
        setTimeout(() => {
            closeBanner();
        }, 3000);
    }

    // Função para fechar o banner
    function closeBanner() {
        const banner = document.getElementById('notificationBanner');
        banner.classList.remove('show');
        
        setTimeout(() => {
            banner.style.display = 'none';
        }, 300);
    }

    // Tornar funções globais
    window.showBanner = showBanner;
    window.closeBanner = closeBanner;

    function showNotificationModal(message, type) {
    const iconContainer = document.getElementById('notificationIcon');
    
    if (type === 'success') {
        iconContainer.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#4CAF50">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">
                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.5s" begin="0.3s" fill="freeze"/>
                </path>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>
                <animateTransform attributeName="transform" type="rotate" values="-15;0;15;0" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        `;
    } else {
        iconContainer.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#F44336">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M8 8L16 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="15" stroke-dashoffset="15">
                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.3s" fill="freeze"/>
                </path>
                <path d="M16 8L8 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="15" stroke-dashoffset="15">
                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.5s" fill="freeze"/>
                </path>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.2;1" dur="0.8s" repeatCount="1" additive="sum"/>
                <animateTransform attributeName="transform" type="rotate" values="0;15;-15;0" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        `;
    }
        const modal = document.getElementById('notificationModal');
        const title = document.getElementById('notificationModalTitle');
        const msg = document.getElementById('notificationModalMessage');
        const content = modal.querySelector('.notification-modal-content');

        title.textContent = type === 'success' ? 'Sucesso!' : 'Erro!';
        msg.textContent = message;
        content.className = 'modal-content notification-modal-content ' + type;
        modal.style.display = 'block';
    }

    function closeNotificationModal() {
        document.getElementById('notificationModal').style.display = 'none';
    }
    
    // Global notification function for dynamically loaded content
    function showNotification(type, message) {
        showNotificationModal(message, type);
    }
    
    // Make functions globally available
    window.showNotification = showNotification;
    window.showNotificationModal = showNotificationModal;
    window.closeNotificationModal = closeNotificationModal;
    
    // Função para refresh do conteúdo atual
    function refreshCurrentContent() {
        const refreshBtn = document.getElementById('refreshBtn');
        const contentContainer = document.getElementById('content-container');
        const boardContainer = document.querySelector('.board-container');
        
        // Adicionar classe de animação de rotação
        refreshBtn.classList.add('refreshing');
        
        // Remover classe após animação
        setTimeout(() => {
            refreshBtn.classList.remove('refreshing');
        }, 1000);
        
        // Verificar se estamos no dashboard principal (boardContainer visível)
        const isDashboardVisible = boardContainer && 
            (boardContainer.style.display === 'flex' || 
             boardContainer.style.display === '' || 
             !boardContainer.style.display ||
             boardContainer.style.display === 'block') &&
            (!contentContainer || 
             contentContainer.style.display === 'none' || 
             contentContainer.style.display === '');
        
        if (isDashboardVisible) {
            console.log('🔄 Refreshing dashboard...');
            window.location.reload();
            return;
        }
        
        // Se estivermos em um template carregado dinamicamente
        if (contentContainer && contentContainer.style.display === 'block') {
            let pageName = '';
            
            // Método 1: Verificar o atributo data-current-page se existir
            if (contentContainer.hasAttribute('data-current-page')) {
                pageName = contentContainer.getAttribute('data-current-page');
                console.log('🔄 Refreshing page from data attribute:', pageName);
                loadContent(pageName);
                return;
            }
            
            // Método 2: Detectar pela URL atual (apenas se não for dashboard)
            const currentPath = window.location.pathname;
            if (currentPath && currentPath !== '/' && currentPath !== '/dashboard') {
                pageName = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                if (!pageName.endsWith('.html')) {
                    pageName += '.html';
                }
                console.log('🔄 Refreshing page from URL:', pageName);
                loadContent(pageName);
                return;
            }
            
            // Método 3: Detectar por elementos únicos de cada página
            if (contentContainer.querySelector('.produtos-grid, .product-card, [data-page="estoque"]')) {
                pageName = 'estoque.html';
            } else if (contentContainer.querySelector('.fornecedores-list, .supplier-card, [data-page="fornecedores"]')) {
                pageName = 'fornecedores.html';
            } else if (contentContainer.querySelector('.clientes-list, .client-card, [data-page="clientes"]')) {
                pageName = 'clientes.html';
            } else if (contentContainer.querySelector('.usuarios-list, .user-card, [data-page="usuarios"]')) {
                pageName = 'usuarios.html';
            } else if (contentContainer.querySelector('.maquinas-list, .machine-card, [data-page="maquinas"]')) {
                pageName = 'maquinas.html';
            } else if (contentContainer.querySelector('.pdv-container, .cart-container, [data-page="pdv"]')) {
                pageName = 'pdv.html';
            } else if (contentContainer.querySelector('[data-page="orcamentos"], .orcamentos-container')) {
                pageName = 'orcamentos.html';
            } else if (contentContainer.querySelector('[data-page="ferramentas"], .ferramentas-container')) {
                pageName = 'ferramentas.html';
            }
            
            // Método 4: Detectar pelo título da página/módulo
            if (!pageName) {
                const moduleHeader = contentContainer.querySelector('.module-header h1, h1, .page-title, [class*="title"]');
                if (moduleHeader) {
                    const pageTitle = moduleHeader.textContent.trim().toLowerCase();
                    
                    const pageMap = {
                        'fornecedores': 'fornecedores.html',
                        'clientes': 'clientes.html', 
                        'estoque': 'estoque.html',
                        'ferramentas': 'ferramentas.html',
                        'máquinas': 'maquinas.html',
                        'maquinas': 'maquinas.html',
                        'usuários': 'usuarios.html',
                        'usuarios': 'usuarios.html',
                        'entrada de estoque': 'entrada_estoque.html',
                        'localizações de estoque': 'localizacoes_estoque.html',
                        'etapas de confecção': 'etapas_confeccao.html',
                        'pdv': 'pdv.html',
                        'ponto de venda': 'pdv.html',
                        'orçamentos': 'orcamentos.html',
                        'vendas': 'vendas.html',
                        'compras': 'compras.html',
                        'financeiro': 'financeiro.html'
                    };
                    
                    pageName = pageMap[pageTitle] || '';
                }
            }
            
            if (pageName) {
                console.log('🔄 Refreshing detected page:', pageName);
                loadContent(pageName);
            } else {
                // Fallback: recarregar a página inteira
                console.log('🔄 Unable to detect current page, reloading entire page...');
                window.location.reload();
            }
        } else {
            // Se não conseguir detectar, recarregar página inteira
            console.log('🔄 Content container not visible, reloading page...');
            window.location.reload();
        }
    }
    
    // Tornar a função global
    window.refreshCurrentContent = refreshCurrentContent;
    
    // Função para toggle do dropdown do usuário
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const btn = document.getElementById('userMenuBtn');
        
        // Debug logs
        console.log('=== DEBUG USER DROPDOWN ===');
        console.log('Dropdown element:', dropdown);
        console.log('Button element:', btn);
        
        if (dropdown) {
            const computedStyle = window.getComputedStyle(dropdown);
            console.log('Computed styles:', {
                backgroundColor: computedStyle.backgroundColor,
                backdropFilter: computedStyle.backdropFilter,
                webkitBackdropFilter: computedStyle.webkitBackdropFilter,
                zIndex: computedStyle.zIndex,
                position: computedStyle.position
            });
        }
        
        if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
            btn.classList.remove('active');
            console.log('Dropdown fechado');
        } else {
            dropdown.classList.add('show');
            btn.classList.add('active');
            console.log('Dropdown aberto');
            
            // Debug do backdrop-filter após abrir
            setTimeout(() => {
                const style = window.getComputedStyle(dropdown);
                console.log('Styles após abrir:', {
                    backgroundColor: style.backgroundColor,
                    backdropFilter: style.backdropFilter,
                    webkitBackdropFilter: style.webkitBackdropFilter
                });
                
                // Debug da posição e elementos por trás
                const rect = dropdown.getBoundingClientRect();
                console.log('Posição do dropdown:', rect);
                
                // Verificar elementos por trás do dropdown
                const elementsUnder = document.elementsFromPoint(rect.left + rect.width/2, rect.top + rect.height/2);
                console.log('Elementos por trás do dropdown:', elementsUnder);
                
                // Verificar se há conteúdo dinâmico carregado
                const contentContainer = document.getElementById('content-container');
                const boardContainer = document.querySelector('.board-container');
                console.log('Content container display:', contentContainer ? contentContainer.style.display : 'não encontrado');
                console.log('Board container display:', boardContainer ? window.getComputedStyle(boardContainer).display : 'não encontrado');
                
                // Testar forçar blur em elementos específicos
                console.log('Testando blur forçado...');
                if (contentContainer && contentContainer.style.display === 'block') {
                    console.log('Há conteúdo dinâmico carregado que pode estar interferindo');
                }
                
                // Teste: alternar para position fixed se backdrop-filter não funcionar
                if (style.backdropFilter === 'none' || style.backdropFilter === '') {
                    console.log('Backdrop-filter não está funcionando, tentando position fixed...');
                    dropdown.classList.add('debug-mode');
                    
                    // Recalcular posição para fixed
                    const btnRect = btn.getBoundingClientRect();
                    dropdown.style.top = (btnRect.bottom + 5) + 'px';
                    dropdown.style.right = (window.innerWidth - btnRect.right) + 'px';
                    dropdown.style.left = 'auto';
                } else {
                    console.log('Backdrop-filter funcionando:', style.backdropFilter);
                }
            }, 100);
        }
    }
    
    // Função para trocar usuário
    function changeUser() {
        showChangeUserConfirmationModal();
    }

    // Função para mostrar modal de confirmação de troca de usuário
    function showChangeUserConfirmationModal() {
        const modal = document.getElementById('changeUserConfirmationModal');
        const iconContainer = document.getElementById('changeUserNotificationIcon');
        
        // Ícone de pergunta
        iconContainer.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9,9a3,3,0,1,1,4,2.83"></path>
                <point cx="12" cy="17"></point>
            </svg>
        `;
        
        modal.classList.add('show');
        modal.style.display = 'flex';
        
        // Configurar ação do botão confirmar
        document.getElementById('changeUserConfirmBtn').onclick = function() {
            closeChangeUserConfirmationModal();
            // Deslogar usuário atual automaticamente
            fetch('/logout', { method: 'POST' })
                .then(() => {
                    showUserChangeLoginModal();
                })
                .catch(() => {
                    showUserChangeLoginModal(); // Mostrar modal mesmo se logout falhar
                });
        };
    }

    // Função para fechar modal de confirmação de troca de usuário
    function closeChangeUserConfirmationModal() {
        const modal = document.getElementById('changeUserConfirmationModal');
        modal.classList.remove('show');
        modal.style.display = 'none';
    }

    // Função para mostrar modal de login para troca de usuário
    function showUserChangeLoginModal() {
        const modal = document.getElementById('userChangeLoginModal');
        modal.style.display = 'flex';
        
        // Limpar formulário
        document.getElementById('userChangeLoginForm').reset();
        document.getElementById('modalLoginMessages').innerHTML = '';
        
        // Prevenir fechar ao clicar fora
        modal.onclick = function(event) {
            if (event.target === modal) {
                event.stopPropagation();
                return false;
            }
        };
        
        // Configurar submit do formulário
        document.getElementById('userChangeLoginForm').onsubmit = function(event) {
            event.preventDefault();
            
            const username = document.getElementById('modalUsername').value;
            const password = document.getElementById('modalPassword').value;
            
            // Fazer login
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
            })
            .then(response => response.text())
            .then(html => {
                if (html.includes('Dashboard')) {
                    // Login bem-sucedido
                    window.location.reload();
                } else {
                    // Extrair mensagem de erro
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const alerts = doc.querySelectorAll('.alert-danger');
                    
                    let errorMessage = 'Erro no login';
                    if (alerts.length > 0) {
                        errorMessage = alerts[0].textContent.trim();
                    }
                    
                    document.getElementById('modalLoginMessages').innerHTML = `
                        <div class="alert alert-danger">${errorMessage}</div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('modalLoginMessages').innerHTML = `
                    <div class="alert alert-danger">Erro de conexão. Tente novamente.</div>
                `;
            });
        };
    }

    // Função para logout com confirmação
    function logout() {
        showLogoutConfirmationModal();
    }

    // Função para mostrar modal de confirmação de logout
    function showLogoutConfirmationModal() {
        const modal = document.getElementById('logoutConfirmationModal');
        const iconContainer = document.getElementById('logoutNotificationIcon');
        
        // Ícone de logout
        iconContainer.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16,17 21,12 16,7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        `;
        
        modal.classList.add('show');
        modal.style.display = 'flex';
        
        // Configurar ação do botão confirmar
        document.getElementById('logoutConfirmBtn').onclick = function() {
            window.location.href = '/logout';
        };
    }

    // Função para fechar modal de confirmação de logout
    function closeLogoutConfirmationModal() {
        const modal = document.getElementById('logoutConfirmationModal');
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(event) {
        const userDropdown = document.querySelector('.user-dropdown');
        const dropdown = document.getElementById('userDropdown');
        const btn = document.getElementById('userMenuBtn');
        
        if (userDropdown && !userDropdown.contains(event.target)) {
            dropdown.classList.remove('show');
            btn.classList.remove('active');
        }
    });
    
    // Função para carregar foto do usuário
    async function loadUserPhoto() {
        try {
            const response = await fetch('/api/user-session');
            if (response.ok) {
                const sessionData = await response.json();
                if (sessionData.status === 'success' && sessionData.user.id) {
                    const photoResponse = await fetch(`/api/user-photo/${sessionData.user.id}`);
                    if (photoResponse.ok) {
                        const photoData = await photoResponse.json();
                        if (photoData.status === 'success' && photoData.photo) {
                            // Atualizar ambos os avatares com a foto
                            const smallAvatar = document.getElementById('userAvatarSmall');
                            const largeAvatar = document.getElementById('userAvatarLarge');
                            
                            if (smallAvatar) {
                                smallAvatar.innerHTML = `<img src="${photoData.photo}" alt="Avatar do usuário">`;
                            }
                            if (largeAvatar) {
                                largeAvatar.innerHTML = `<img src="${photoData.photo}" alt="Avatar do usuário">`;
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.log('Não foi possível carregar a foto do usuário:', error);
            // Manter os ícones SVG padrão em caso de erro
        }
    }
    
    // Carregar foto do usuário quando a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        loadUserPhoto();
    });
    
    // Tornar funções globais
    window.toggleUserDropdown = toggleUserDropdown;
    window.changeUser = changeUser;
    window.logout = logout;
    window.showChangeUserConfirmationModal = showChangeUserConfirmationModal;
    window.closeChangeUserConfirmationModal = closeChangeUserConfirmationModal;
    window.showLogoutConfirmationModal = showLogoutConfirmationModal;
    window.closeLogoutConfirmationModal = closeLogoutConfirmationModal;
    window.toggleModuleDropdown = toggleModuleDropdown;
    window.handleDropdownItemClick = handleDropdownItemClick;
    
    // Debug - testar se as funções estão disponíveis
    console.log('🔍 Funções do dropdown disponíveis:', {
        toggleModuleDropdown: typeof window.toggleModuleDropdown,
        handleDropdownItemClick: typeof window.handleDropdownItemClick
    });
    
    // Enviar log inicial para o Flask
    setTimeout(() => {
        const dropdown = document.getElementById('moduleDropdown');
        const menu = document.getElementById('moduleDropdownMenu');
        const button = document.querySelector('.module-indicator-button');
        
        fetch('/api/debug-log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: `🚀 Dashboard carregado - Elementos encontrados: dropdown=${!!dropdown}, menu=${!!menu}, button=${!!button}`,
                level: 'INFO',
                source: 'STARTUP'
            })
        });
        
        if (dropdown && menu && button) {
            fetch('/api/debug-log', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: `📐 Elementos dropdown criados: dropdown.id=${dropdown.id}, menu.id=${menu.id}, menu.display=${menu.style.display}`,
                    level: 'SUCCESS',
                    source: 'STARTUP'
                })
            });
        } else {
            fetch('/api/debug-log', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: '❌ Elementos dropdown não encontrados no DOM',
                    level: 'ERROR',
                    source: 'STARTUP'
                })
            });
        }
    }, 1000);  // Aguarda 1 segundo para garantir que o DOM está carregado
</script>

<script>
    // Compatibilidade aprimorada para iOS Safari antigo
    document.addEventListener('DOMContentLoaded', function() {
        // Detectar se é iOS Safari antigo
        const isOldIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && 
                              parseFloat((/OS (\d+)_(\d+)_?(\d+)?/.exec(navigator.userAgent) || [0,0])[1]) < 13;
        
        if (isOldIOSSafari) {
            console.log('📱 iOS Safari antigo detectado - aplicando correções de compatibilidade');
            
            // Forçar reflow dos elementos para garantir que os event listeners funcionem
            const sidebarElements = document.querySelectorAll('.sidebar-nav li, .menu-item, .submenu a');
            sidebarElements.forEach(function(element) {
                // Forçar propriedades CSS para melhor compatibilidade touch
                element.style.webkitTapHighlightColor = 'rgba(155, 100, 227, 0.3)';
                element.style.webkitTouchCallout = 'none';
                element.style.webkitUserSelect = 'none';
                element.style.touchAction = 'manipulation';
                
                // Adicionar event listeners para touchstart como fallback
                if (element.onclick) {
                    const originalOnclick = element.onclick;
                    element.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        setTimeout(function() {
                            originalOnclick.call(element, e);
                        }, 10);
                    }, { passive: false });
                }
            });
            
            // Aplicar fix específico para elementos com onclick inline
            document.querySelectorAll('[onclick]').forEach(function(element) {
                if (!element.ontouchstart) {
                    const onclickHandler = element.getAttribute('onclick');
                    element.setAttribute('ontouchstart', onclickHandler);
                }
            });
        }
    });
</script>


</body>
</html>
