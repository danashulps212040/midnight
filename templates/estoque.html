<div class="module-header" style="padding: 90px 20px 20px 20px; font-size: 14px;">
<link rel="stylesheet" href="/static/css/custom-scrollbar.css">
  <h1>Estoque</h1>
  
<!-- Filtros e busca de itens -->
<div class="search-filters" style="margin-bottom: 20px; padding: 15px; background-color: rgba(19, 4, 60, 0.69); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 2px solid #9B64E3; border-radius: 10px;">
    <div class="search-container" style="display: flex; margin-bottom: 15px;">
        <input type="text" id="searchItem" placeholder="Pesquisar item..." style="flex: 1; padding: 10px; border: 0.2px solid #9B64E3; border-radius: 5px 0 0 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
        <button type="button" id="searchButton" style="padding: 10px 15px; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9b63e3; border-left: none; border-radius: 0 5px 5px 0; color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
            <i class="search-icon">&#128269;</i>
        </button>
    </div>
</div>
<div style="display: flex; gap: 10px; margin-bottom: 20px; margin-top: 20px;">
    <button class="btn-primary btn-incluir-item" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'" onclick="openItemModal()">Incluir Item</button>
    <button class="btn-primary btn-entrada-estoque" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'" onclick="openEntradaEstoqueModal()">Entrada Estoque</button>
    <button class="btn-primary btn-saida-estoque" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'" onclick="openSaidaEstoqueModal()">Saída Estoque</button>
</div>
<div class="estoque-list-container" style="background-color: var(--order-card-bg); border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div class="estoque-list-header" style="display: grid; grid-template-columns: 0.8fr 1fr 1.5fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1fr 1fr 1fr 0.8fr 0.8fr; gap: 15px; font-weight: bold; padding: 15px 20px; border-bottom: 2px solid var(--cor-destaque, #9B64E3); color: var(--column-title-text);">
        <div>Código</div>
        <div>Tipo de item</div>
        <div>Nome</div>
        <div>Categoria</div>
        <div>Quantidade</div>
        <div>Mínimo</div>
        <div>Largura</div>
        <div>Compr.</div>
        <div>Peso</div>
        <div>Volume</div>
        <div>Custo médio</div>
        <div>Custo atual</div>
        <div>Fornecedor</div>
        <div>Fabricante</div>
        <div>Localização</div>
        <div>Status</div>
        <div>Ações</div>
    </div>
    <div class="estoque-list" style="margin-top: 10px;">
        <!-- Dados dos itens serão carregados dinamicamente aqui -->
    </div>
</div>

<!-- Modal para Entrada de Estoque -->
<div id="entradaEstoqueModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" onclick="closeEntradaEstoqueModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Entrada de Estoque</h2>
        <div class="modal-body">
            <form id="entradaEstoqueForm">
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="material">Material:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="material" style="width: calc(50% - 35px);">
                                    <button type="button" tabindex="0">Selecione o Material</button>
                                    <div class="dropdown-content">
                                        <!-- Opções serão carregadas dinamicamente -->
                                    </div>
                                </div>
                                <button type="button" onclick="openMaterialSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="quantidade">Quantidade:</label>
                            <input type="number" id="quantidade" name="quantidade" required style="width: 50%;">
                        </div>
                        <div class="form-group">
                            <label for="dataEntrada">Data da Entrada:</label>
                            <input type="date" id="dataEntrada" name="dataEntrada" value="" style="width: 50%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div class="form-group">
                            <label for="fornecedor">Fornecedor:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="fornecedor" style="width: calc(85% - 35px);">
                                    <button type="button" tabindex="0">Selecione o Fornecedor</button>
                                    <div class="dropdown-content">
                                        <!-- Opções serão carregadas dinamicamente -->
                                    </div>
                                </div>
                                <button type="button" onclick="openFornecedorSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="notaFiscal">Nota Fiscal:</label>
                            <input type="text" id="notaFiscal" name="notaFiscal" style="width: 90%;">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="custoUnitario">Custo Unitário:</label>
                            <input type="text" id="custoUnitario" name="custoUnitario" style="width: 50%;" oninput="formatarMoeda(this)" placeholder="R$ 0,00">
                        </div>
                        <div class="form-group">
                            <label for="dataValidade">Data de Validade:</label>
                            <input type="date" id="dataValidade" name="dataValidade" style="width: 50%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div class="form-group">
                            <label for="lote">Lote:</label>
                            <input type="text" id="lote" name="lote" style="width: 50%;">
                        </div>
                        <div class="form-group">
                            <label for="localizacao">Localização no Estoque:</label>
                            <input type="text" id="localizacao" name="localizacao" style="width: 90%;">
                        </div>
                        <div class="form-group">
                            <label for="observacoes">Observações:</label>
                            <textarea id="observacoes" name="observacoes" rows="3" style="width: 90%;"></textarea>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Entrada</button>
            </form>
        </div>
    </div>
</div>
<!-- Modal para Saída de Estoque -->
<div id="saidaEstoqueModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" onclick="closeSaidaEstoqueModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Saída de Estoque</h2>
        <div class="modal-body">
            <form id="saidaEstoqueForm">
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="materialSaida">Material:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="materialSaida" style="width: calc(50% - 35px);">
                                    <button type="button" tabindex="0">Selecione o Material</button>
                                    <div class="dropdown-content">
                                        <!-- Opções serão carregadas dinamicamente -->
                                    </div>
                                </div>
                                <button type="button" onclick="openMaterialSelectionModalSaida()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="quantidadeSaida">Quantidade saída:</label>
                            <input type="number" id="quantidadeSaida" name="quantidadeSaida" required style="width: 50%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div class="form-group">
                            <label for="dataSaida">Data da saída:</label>
                            <input type="date" id="dataSaida" name="dataSaida" style="width: 50%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div class="form-group">
                            <label for="motivoSaida">Motivo da saída:</label>
                            <div class="dropdown custom-select" tabindex="0" role="button" id="motivoSaida" style="width: 50%;">
                                <button type="button" tabindex="0">Selecione o Motivo</button>
                                <div class="dropdown-content">
                                    <div data-value="Consumo Interno">Consumo Interno</div>
                                    <div data-value="Transferência">Transferência</div>
                                    <div data-value="Devolução">Devolução</div>
                                    <div data-value="Descarte">Descarte</div>
                                    <div data-value="Outros">Outros</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="destino">Destino:</label>
                            <input type="text" id="destino" name="destino" style="width: 90%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div class="form-group">
                            <label for="localizacaoSaida">Localização no estoque:</label>
                            <input type="text" id="localizacaoSaida" name="localizacaoSaida" style="width: 90%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div class="form-group">
                            <label for="observacoesSaida">Observações:</label>
                            <textarea id="observacoesSaida" name="observacoesSaida" rows="3" style="width: 90%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;"></textarea>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Saída</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Seleção de Material -->
<div id="materialSelectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 80vh; overflow: hidden; box-sizing: border-box;">
        <span class="close-button" onclick="closeMaterialSelectionModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Selecionar Material</h2>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 15px; box-sizing: border-box;">
            <!-- Filtro de busca -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="materialSearchInput" placeholder="Pesquisar material..." style="width: 100%; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;" oninput="filtrarMateriais()">
            </div>
            
            <!-- Lista de materiais -->
            <div id="materialsList" style="display: grid; grid-template-columns: 0.8fr 2fr 1fr 1fr; gap: 10px; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #9B64E3; color: white; margin-bottom: 10px;">
                <div>Código</div>
                <div>Nome</div>
                <div>Categoria</div>
                <div>Estoque Atual</div>
            </div>
            <div id="materialsListContent">
                <!-- Materiais serão carregados aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Seleção de Fornecedor -->
<div id="fornecedorSelectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 80vh; overflow: hidden; box-sizing: border-box;">
        <span class="close-button" onclick="closeFornecedorSelectionModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Selecionar Fornecedor</h2>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 15px; box-sizing: border-box;">
            <!-- Filtro de busca e botão novo fornecedor em linha -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <input type="text" id="fornecedorSearchInput" placeholder="Pesquisar fornecedor..." style="flex: 1; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;" oninput="filtrarFornecedores()">
                <button type="button" onclick="openNovoFornecedorModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">+ Novo</button>
            </div>
            
            <!-- Lista de fornecedores -->
            <div id="fornecedoresList" style="display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 10px; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #9B64E3; color: white; margin-bottom: 10px;">
                <div>Nome</div>
                <div>Cidade</div>
                <div>CPF/CNPJ</div>
            </div>
            <div id="fornecedoresListContent">
                <!-- Fornecedores serão carregados aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Seleção de Categoria -->
<div id="categoriaSelectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; box-sizing: border-box;">
        <span class="close-button" onclick="closeCategoriaSelectionModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Selecionar Categoria</h2>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 15px; box-sizing: border-box;">
            <!-- Filtro de busca e botão nova categoria em linha -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <input type="text" id="categoriaSearchInput" placeholder="Pesquisar categoria..." style="flex: 1; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;" oninput="filtrarCategorias()">
                <button type="button" onclick="openNovaCategoriaModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">+ Nova</button>
            </div>
            
            <!-- Lista de categorias -->
            <div id="categoriasList" style="display: grid; grid-template-columns: 1fr; gap: 10px; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #9B64E3; color: white; margin-bottom: 10px;">
                <div>Nome da Categoria</div>
            </div>
            <div id="categoriasListContent">
                <!-- Categorias serão carregadas aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Seleção de Tipo de Item -->
<div id="tipoItemSelectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; width: 90%; max-height: 80vh; overflow: hidden; box-sizing: border-box;">
        <span class="close-button" onclick="closeTipoItemSelectionModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Selecionar Tipo de Item</h2>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 15px; box-sizing: border-box;">
            <!-- Filtro de busca e botão novo tipo em linha -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <input type="text" id="tipoItemSearchInput" placeholder="Pesquisar tipo..." style="flex: 1; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;" oninput="filtrarTiposItem()">
                <button type="button" onclick="openNovoTipoItemModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">+ Novo</button>
            </div>
            
            <!-- Lista de tipos -->
            <div id="tiposItemList" style="display: grid; grid-template-columns: 1.5fr 2fr; gap: 10px; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #9B64E3; color: white; margin-bottom: 10px;">
                <div>Nome</div>
                <div>Descrição</div>
            </div>
            <div id="tiposItemListContent">
                <!-- Tipos serão carregados aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Seleção de Unidade de Medida -->
<div id="unidadeSelectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; box-sizing: border-box;">
        <span class="close-button" onclick="closeUnidadeSelectionModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Selecionar Unidade de Medida</h2>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 15px; box-sizing: border-box;">
            <!-- Filtro de busca e botão nova unidade em linha -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <input type="text" id="unidadeSearchInput" placeholder="Pesquisar unidade..." style="flex: 1; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;" oninput="filtrarUnidades()">
                <button type="button" onclick="openNovaUnidadeModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">+ Nova</button>
            </div>
            
            <!-- Lista de unidades -->
            <div id="unidadesList" style="display: grid; grid-template-columns: 1fr; gap: 10px; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #9B64E3; color: white; margin-bottom: 10px;">
                <div>Nome da Unidade</div>
            </div>
            <div id="unidadesListContent">
                <!-- Unidades serão carregadas aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Item -->
<div id="itemModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" onclick="closeItemModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Incluir Novo Item</h2>
        <div class="modal-body">
            <form id="itemForm">
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="itemTipoItem">Tipo de Item:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="itemTipoItem" style="width: calc(85% - 30px);">
                                    <button type="button" tabindex="0">Selecione o tipo</button>
                                    <div class="dropdown-content">
                                        <!-- Opções de tipo serão carregadas aqui -->
                                    </div>
                                </div>
                                <button type="button" onclick="openTipoItemSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemName">Nome:</label>
                            <input type="text" id="itemName" name="itemName" required style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="itemFabricante">Fabricante:</label>
                            <input type="text" id="itemFabricante" name="itemFabricante" style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="itemCode">Código:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="text" id="itemCode" name="itemCode" required style="width: calc(85% - 35px); height: 20px;">
                                <button type="button" onclick="gerarCodigoAleatorio()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'" title="Gerar código aleatório">
                                    <svg width="24" height="24" viewBox="0 0 384 383.36" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <style>
                                                .cls-1 { fill: #ffffff; }
                                                .cls-2 { fill: currentColor; }
                                            </style>
                                        </defs>
                                        <path class="cls-2" d="M384,64.48v9.73l-48.61,177.92c-4.09,8.98-13.29,13.6-23.02,12.95l-63.37-16.45,16.41,62.58c1.01,9.34-3.37,18.85-11.89,23.16l-180.78,49h-9c-5.65-2.9-11.38-5.45-14.39-11.47-15.62-52.98-29.21-106.71-43.58-160.11-1.73-6.44-3.35-13.09-5.79-19.3v-9.73c2.49-7.24,6.58-13.54,14.06-16.29l120.02-32.54L166.68,14.13c3.89-10.03,14.76-15.83,25.36-13.69,60.11,16.42,120.77,31.28,180.47,48.93,6.2,3.3,9.18,8.75,11.49,15.11ZM243.91,231.24l69.41,18.73c6.65.58,8.05-3.46,9.71-8.68,17.59-55.24,28.39-114.49,45.65-170.05.93-3.19-.49-6.29-3.05-8.27L189.78,15.39c-3.94-1.09-7.98,1.25-9.26,5.07l-29.01,109.14,42.37-11.22c9.23-.77,17.57,3.62,22.28,11.44l27.76,101.42ZM194.83,133.49L20.4,180.27c-3.87,1.29-6.16,5.35-5.08,9.24,17.26,55.56,28.05,114.82,45.65,170.05,1.43,4.49,2.29,8,7.75,8.79l177.97-47.56,3.67-5.38-46.88-176.69c-1.33-3.8-4.76-5.72-8.65-5.24Z"/>
                                        <path class="cls-1" d="M129.57,228.61c30.39-3.98,34.88,41.64,5.73,44.63-29.61,3.04-34.21-40.91-5.73-44.63Z"/>
                                        <path class="cls-1" d="M278.06,165.71c36.5-5.76,35.87,49.85,0,43.8-22.61-3.81-22.78-40.21,0-43.8Z"/>
                                        <path class="cls-1" d="M214.3,55.67c36.19-6.1,36.19,49.91,0,43.81-22.65-3.82-22.66-39.99,0-43.81Z"/>
                                        <path class="cls-1" d="M301.3,78.88c36.14-6.09,36.14,49.9,0,43.81-22.65-3.82-22.66-39.99,0-43.81Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemSupplier">Fornecedor:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="itemSupplier" style="width: calc(85% - 30px);">
                                    <button type="button" tabindex="0">Selecione um fornecedor</button>
                                    <div class="dropdown-content">
                                        <!-- Opções de fornecedor serão carregadas aqui -->
                                    </div>
                                </div>
                                <button type="button" onclick="openFornecedorSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemColor">Cor:</label>
                            <input type="text" id="itemColor" name="itemColor" style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">Categoria:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="itemCategory" style="width: calc(85% - 30px);">
                                    <button type="button" tabindex="0">Selecione uma categoria</button>
                                    <div class="dropdown-content">
                                        <!-- Opções de categoria serão carregadas aqui -->
                                    </div>
                                </div>
                                <button type="button" onclick="openCategoriaSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemInitialQuantity">Quantidade Inicial:</label>
                            <input type="number" id="itemInitialQuantity" name="itemInitialQuantity" required style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="itemMinStock">Estoque Mínimo:</label>
                            <input type="number" id="itemMinStock" name="itemMinStock" required style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="itemUnidades">Unidades por Pacote:</label>
                            <input type="number" id="itemUnidades" name="itemUnidades" style="width: 85%;" placeholder="1" disabled title="Habilita automaticamente quando o tipo for 'Pacote Fechado'">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <!-- Grupo: Medidas e Dimensões -->
                        <div style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h3 style="color: #9B64E3; font-size: 14px; margin: 0 0 15px 0; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L10.3 16.5a2 2 0 0 1-2.83-2.83l7.07-7.07"/>
                                </svg>
                                Medidas e Dimensões
                            </h3>
                            
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="itemUnit">Unidade de Medida:</label>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div class="dropdown custom-select" tabindex="0" role="button" id="itemUnit" style="width: calc(85% - 30px);">
                                        <button type="button" tabindex="0" onchange="verificarUnidadeMedida('itemUnit')">Selecione uma unidade</button>
                                        <div class="dropdown-content">
                                            <!-- Opções de unidade serão carregadas aqui -->
                                        </div>
                                    </div>
                                    <button type="button" onclick="openUnidadeSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"/>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; padding: 0 10px;">
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="itemLargura" style="margin-bottom: 5px; display: block;">Largura (cm):</label>
                                    <input type="text" id="itemLargura" name="itemLargura" style="width: 100%; padding: 6px; border-radius: 4px;" placeholder="0.00 ou 210mm" oninput="convertDimensionInput(this)" onblur="calculateArea()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="itemComprimento" style="margin-bottom: 5px; display: block;">Comprimento (cm):</label>
                                    <input type="text" id="itemComprimento" name="itemComprimento" style="width: 100%; padding: 6px; border-radius: 4px;" placeholder="0.00 ou 210mm" oninput="convertDimensionInput(this)" onblur="calculateArea()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="itemEspessura" style="margin-bottom: 5px; display: block;">Espessura (mm):</label>
                                    <input type="number" id="itemEspessura" name="itemEspessura" style="width: 100%; padding: 6px; border-radius: 4px;" step="0.01" placeholder="0.00">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="itemVolume" style="margin-bottom: 5px; display: block;">Volume (lt):</label>
                                    <input type="number" id="itemVolume" name="itemVolume" style="width: 100%; padding: 6px; border-radius: 4px;" step="0.001" min="0" placeholder="0.000">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="itemPeso" style="margin-bottom: 5px; display: block;">Peso (g):</label>
                                    <input type="number" id="itemPeso" name="itemPeso" style="width: 100%; padding: 6px; border-radius: 4px;" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            
                            <!-- Label para mostrar a área calculada -->
                            <div style="margin-top: 10px; padding: 10px; background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 4px;">
                                <label style="color: #9B64E3; font-weight: bold; margin: 0;">Área: <span id="itemAreaDisplay">0.00 m²</span></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="itemLocation">Localização no Estoque:</label>
                            <input type="text" id="itemLocation" name="itemLocation" style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="itemTechSpecs">Especificações Técnicas:</label>
                            <textarea id="itemTechSpecs" name="itemTechSpecs" rows="2" style="width: 85%;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="itemDescription">Descrição:</label>
                            <textarea id="itemDescription" name="itemDescription" rows="2" style="width: 85%;"></textarea>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 10px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Item</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Editar Item -->
<div id="editItemModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditItemModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Editar Item</h2>
        <div class="modal-body">
            <form id="editItemForm" action="#">
                <input type="hidden" id="editItemId" name="editItemId">
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="editItemTipoItem">Tipo de Item:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="editItemTipoItem" style="width: calc(85% - 30px);">
                                    <button type="button" tabindex="0">Selecione o tipo</button>
                                    <div class="dropdown-content">
                                        <!-- Opções de tipo serão carregadas aqui -->
                                    </div>
                                </div>
                                <button type="button" onclick="openTipoItemSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editItemName">Nome:</label>
                            <input type="text" id="editItemName" name="itemName" required style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="editItemFabricante">Fabricante:</label>
                            <input type="text" id="editItemFabricante" name="editItemFabricante" style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="editItemCode">Código:</label>
                            <input type="text" id="editItemCode" name="itemCode" required style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="editItemSupplier">Fornecedor:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="editItemSupplier" style="width: calc(85% - 30px);">
                                    <button type="button" tabindex="0">Selecione um fornecedor</button>
                                    <div class="dropdown-content">
                                        <!-- Opções de fornecedor serão carregadas aqui -->
                                    </div>
                                </div>
                                <button type="button" onclick="openFornecedorSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editItemColor">Cor:</label>
                            <input type="text" id="editItemColor" name="itemColor" style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="editItemCategory">Categoria:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="editItemCategory" style="width: calc(85% - 30px);">
                                    <button type="button" tabindex="0">Selecione uma categoria</button>
                                    <div class="dropdown-content">
                                        <!-- Opções de categoria serão carregadas aqui -->
                                    </div>
                                </div>
                                <button type="button" onclick="openCategoriaSelectionModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editItemInitialQuantity">Quantidade Inicial:</label>
                            <input type="number" id="editItemInitialQuantity" name="itemInitialQuantity" required style="width: 85%;" disabled>
                        </div>
                        <div class="form-group">
                            <label for="editItemMinStock">Estoque Mínimo:</label>
                            <input type="number" id="editItemMinStock" name="itemMinimumStock" required style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="editItemUnidades">Unidades por Pacote:</label>
                            <input type="number" id="editItemUnidades" name="itemUnidades" style="width: 85%;" placeholder="1" disabled title="Habilita automaticamente quando o tipo for 'Pacote Fechado'">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <!-- Grupo: Medidas e Dimensões -->
                        <div style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h3 style="color: #9B64E3; font-size: 14px; margin: 0 0 15px 0; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L10.3 16.5a2 2 0 0 1-2.83-2.83l7.07-7.07"/>
                                </svg>
                                Medidas e Dimensões
                            </h3>
                            
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="editItemUnit">Unidade de Medida:</label>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div class="dropdown custom-select" tabindex="0" role="button" id="editItemUnit" style="width: calc(85% - 30px);">
                                        <button type="button" tabindex="0" onchange="verificarUnidadeMedida('editItemUnit')">Selecione uma unidade</button>
                                        <div class="dropdown-content">
                                            <!-- Opções de unidade serão carregadas aqui -->
                                        </div>
                                    </div>
                                    <button type="button" onclick="openNovaUnidadeModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 16px; line-height: 1;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">+</button>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; padding: 0 10px;">
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="editItemLargura" style="margin-bottom: 5px; display: block;">Largura (cm):</label>
                                    <input type="text" id="editItemLargura" name="itemLargura" style="width: 100%; padding: 6px; border-radius: 4px;" placeholder="0.00 ou 210mm" oninput="convertDimensionInput(this)" onblur="calculateAreaEdit()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="editItemComprimento" style="margin-bottom: 5px; display: block;">Comprimento (cm):</label>
                                    <input type="text" id="editItemComprimento" name="itemComprimento" style="width: 100%; padding: 6px; border-radius: 4px;" placeholder="0.00 ou 210mm" oninput="convertDimensionInput(this)" onblur="calculateAreaEdit()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="editItemEspessura" style="margin-bottom: 5px; display: block;">Espessura (mm):</label>
                                    <input type="number" id="editItemEspessura" name="itemEspessura" style="width: 100%; padding: 6px; border-radius: 4px;" step="0.01" placeholder="0.00">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="editItemVolume" style="margin-bottom: 5px; display: block;">Volume (lt):</label>
                                    <input type="number" id="editItemVolume" name="itemVolume" style="width: 100%; padding: 6px; border-radius: 4px;" step="0.001" min="0" placeholder="0.000">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 10px;">
                                    <label for="editItemPeso" style="margin-bottom: 5px; display: block;">Peso (g):</label>
                                    <input type="number" id="editItemPeso" name="itemPeso" style="width: 100%; padding: 6px; border-radius: 4px;" step="0.01" placeholder="0.00">
                                </div>
                            </div>
                            
                            <!-- Label para mostrar a área calculada no modal de edição -->
                            <div style="margin-top: 10px; padding: 10px; background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 4px;">
                                <label style="color: #9B64E3; font-weight: bold; margin: 0;">Área: <span id="editItemAreaDisplay">0.00 m²</span></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editItemLocation">Localização no Estoque:</label>
                            <input type="text" id="editItemLocation" name="itemLocation" style="width: 85%;">
                        </div>
                        <div class="form-group">
                            <label for="editItemTechSpecs">Especificações Técnicas:</label>
                            <textarea id="editItemTechSpecs" name="itemSpecs" rows="2" style="width: 85%;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editItemDescription">Descrição:</label>
                            <textarea id="editItemDescription" name="itemDescription" rows="2" style="width: 85%;"></textarea>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 10px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Atualizar Item</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Nova Unidade de Medida -->
<div id="novaUnidadeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; box-sizing: border-box; overflow: hidden;">
        <span class="close-button" onclick="closeNovaUnidadeModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Nova Unidade de Medida</h2>
        <div class="modal-body" style="padding: 15px; box-sizing: border-box;">
            <form id="novaUnidadeForm">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="novaUnidadeNome" style="display: block; margin-bottom: 5px; color: white;">Nome da Unidade:</label>
                    <input type="text" id="novaUnidadeNome" name="novaUnidadeNome" required style="width: 100%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;">
                </div>
                <div class="form-group" style="display: flex; align-items: center; margin-top: 15px; margin-bottom: 20px;">
                    <input type="checkbox" id="isMeasurementUnit" name="isMeasurementUnit" style="width: auto; margin-right: 8px; appearance: none; -webkit-appearance: none; -moz-appearance: none; width: 18px; height: 18px; border: 2px solid #9B64E3; border-radius: 3px; background-color: rgba(255, 255, 255, 0.1); cursor: pointer; position: relative; vertical-align: middle;">
                    <label for="isMeasurementUnit" style="margin: 0; cursor: pointer; color: white;">É uma unidade de medida (ex: mm, cm, m)?</label>
                </div>
                <button type="button" onclick="salvarNovaUnidade()" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Unidade</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Nova Categoria -->
<div id="novaCategoriaModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; box-sizing: border-box; overflow: hidden;">
        <span class="close-button" onclick="closeNovaCategoriaModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Nova Categoria</h2>
        <div class="modal-body" style="padding: 15px; box-sizing: border-box;">
            <form id="novaCategoriaForm">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="novaCategoriaNome" style="display: block; margin-bottom: 5px; color: white;">Nome da Categoria:</label>
                    <input type="text" id="novaCategoriaNome" name="novaCategoriaNome" required style="width: 100%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;">
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Categoria</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Novo Tipo de Item -->
<div id="novoTipoItemModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; box-sizing: border-box; overflow: hidden;">
        <span class="close-button" onclick="closeNovoTipoItemModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Novo Tipo de Item</h2>
        <div class="modal-body" style="padding: 15px; box-sizing: border-box;">
            <form id="novoTipoItemForm">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="novoTipoItemNome" style="display: block; margin-bottom: 5px; color: white;">Nome do Tipo:</label>
                    <input type="text" id="novoTipoItemNome" name="novoTipoItemNome" required style="width: 100%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="novoTipoItemDescricao" style="display: block; margin-bottom: 5px; color: white;">Descrição:</label>
                    <textarea id="novoTipoItemDescricao" name="novoTipoItemDescricao" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box; resize: vertical;"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Tipo</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('novaCategoriaForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Previne o comportamento padrão de submit do formulário
        salvarNovaCategoria(event);
    });

    async function carregarUnidadesParaDropdown(selectId) {
        try {
            const response = await fetch('/api/unidades_de_medida');
            if (response.ok) {
                const result = await response.json();
                
                // Debug: verificar estrutura completa da resposta da API
                console.log('Resposta completa da API de unidades:', result);
                
                const customSelect = document.getElementById(selectId);
                const selectButton = customSelect.querySelector('button');
                const selectOptionsDiv = customSelect.querySelector('.dropdown-content');

                selectOptionsDiv.innerHTML = ''; // Limpa as opções existentes
                selectButton.textContent = 'Selecione uma unidade'; // Resetar texto do botão
                selectButton.setAttribute('data-selected', ''); // Resetar valor selecionado

                if (result.unidades) {
                    result.unidades.forEach((unidade, index) => {
                        // Debug: verificar cada unidade individual
                        console.log(`Unidade ${index}:`, unidade);
                        console.log(`Unidade ${index} - is_measurement:`, unidade.is_measurement, 'Tipo:', typeof unidade.is_measurement);
                        
                        const optionDiv = document.createElement('div');
                        optionDiv.textContent = unidade.nome;
                        optionDiv.setAttribute('data-value', unidade.id); // Armazena o ID da unidade
                        
                        // Verificar se o campo is_measurement existe e converter corretamente
                        let isMeasurementValue = '0'; // Default para false
                        
                        // Verificar todas as possibilidades de valores truthy
                        if (unidade.hasOwnProperty('is_measurement')) {
                            const rawValue = unidade.is_measurement;
                            console.log(`Processando is_measurement para ${unidade.nome}:`, rawValue, typeof rawValue);
                            
                            // Verificar se é truthy (mas não null/undefined)
                            if (rawValue === 1 || rawValue === '1' || rawValue === true || rawValue === 'true' || rawValue === 'True') {
                                isMeasurementValue = '1';
                            } else {
                                isMeasurementValue = '0';
                            }
                        } else {
                            console.warn(`Unidade ${unidade.nome} não possui campo is_measurement`);
                        }
                        
                        optionDiv.setAttribute('data-is-measurement', isMeasurementValue);
                        
                        console.log(`Resultado final para ${unidade.nome}:`, {
                            nome: unidade.nome,
                            id: unidade.id,
                            is_measurement_original: unidade.is_measurement,
                            is_measurement_tipo: typeof unidade.is_measurement,
                            is_measurement_convertido: isMeasurementValue
                        });
                        
                        optionDiv.onclick = function() {
                            selectButton.textContent = this.textContent;
                            selectButton.setAttribute('data-selected', this.getAttribute('data-value'));
                            selectButton.setAttribute('data-is-measurement', this.getAttribute('data-is-measurement'));
                            selectOptionsDiv.style.display = 'none'; // Fechar dropdown após seleção
                            
                            console.log('Unidade selecionada:', selectId, this.textContent, this.getAttribute('data-value'), this.getAttribute('data-is-measurement'));
                            
                            // Verificar se deve habilitar/desabilitar campos de dimensão
                            verificarUnidadeMedida(selectId);
                        };
                        selectOptionsDiv.appendChild(optionDiv);
                    });
                } else {
                    console.error('Resposta da API não contém o campo "unidades"');
                }
            } else {
                console.error('Erro ao carregar unidades:', await response.text());
            }
        } catch (error) {
            console.error('Erro na requisição de unidades:', error);
        }
    }

    async function salvarNovaUnidade() {
        const nome = document.getElementById('novaUnidadeNome').value.trim();
        const isMeasurement = document.getElementById('isMeasurementUnit').checked ? 1 : 0;
        console.log('Attempting to save new unit:', { nome, is_measurement: isMeasurement });

        if (!nome) {
            showNotification('error', 'Por favor, informe o nome da unidade de medida.');
            console.log('Validation failed: Unit name is empty.');
            return;
        }
        
        try {
            console.log('Sending POST request to /api/unidades_de_medida with body:', JSON.stringify({ nome: nome, is_measurement: isMeasurement }));
            const response = await fetch('/api/unidades_de_medida', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nome: nome, is_measurement: isMeasurement })
            });
            
            console.log('Received response status:', response.status);
            const result = await response.json();
            console.log('Received response body:', result);
            
            if (result.status === 'success') {
                showNotification('success', result.message || 'Unidade de medida cadastrada com sucesso!');
                console.log('Unit saved successfully.');
                closeNovaUnidadeModal();
                document.getElementById('novaUnidadeForm').reset();
                
                // Recarregar as unidades nos dropdowns
                await carregarUnidadesParaDropdown('itemUnit');
                await carregarUnidadesParaDropdown('editItemUnit');
                
                // Recarregar a lista no modal de seleção se estiver aberto
                if (document.getElementById('unidadeSelectionModal').style.display === 'block') {
                    await carregarUnidadesParaSelecao();
                }
                
                console.log('Dropdowns reloaded.');
            } else {
                const errorMessage = result.message || result.error || 'Erro desconhecido';
                showNotification('error', `Erro ao cadastrar unidade de medida: ${errorMessage}`);
                console.log('Error saving unit:', errorMessage);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            showNotification('error', 'Erro ao cadastrar unidade de medida. Por favor, tente novamente.');
        }
    }

    function verificarUnidadeMedida(selectId) {
        const customSelect = document.getElementById(selectId);
        const selectButton = customSelect.querySelector('button');
        const isMeasurement = selectButton.getAttribute('data-is-measurement');
        
        console.log('DEBUG - Verificando unidade de medida:');
        console.log('  selectId:', selectId);
        console.log('  customSelect:', customSelect);
        console.log('  selectButton:', selectButton);
        console.log('  isMeasurement (raw):', isMeasurement);
        console.log('  isMeasurement (tipo):', typeof isMeasurement);
        console.log('  Botão texto:', selectButton ? selectButton.textContent : 'N/A');
        
        // Determinar qual modal está sendo usado para encontrar os campos corretos
        let larguraField, comprimentoField;
        
        if (selectId === 'itemUnit') {
            // Modal de incluir item
            larguraField = document.getElementById('itemLargura');
            comprimentoField = document.getElementById('itemComprimento');
            console.log('  Usando modal de incluir item');
        } else if (selectId === 'editItemUnit') {
            // Modal de editar item
            larguraField = document.getElementById('editItemLargura');
            comprimentoField = document.getElementById('editItemComprimento');
            console.log('  Usando modal de editar item');
        }
        
        console.log('  larguraField:', larguraField);
        console.log('  comprimentoField:', comprimentoField);
        
        if (larguraField && comprimentoField) {
            // Converter para boolean para comparação correta
            // MySQL BOOLEAN pode vir como 0, 1, '0', '1', false, true
            const isMetricUnit = isMeasurement === '1' || isMeasurement === 1 || isMeasurement === true || isMeasurement === 'true';
            
            console.log('  DECISÃO:');
            console.log('    isMeasurement === "1":', isMeasurement === '1');
            console.log('    isMeasurement === 1:', isMeasurement === 1);
            console.log('    isMeasurement === true:', isMeasurement === true);
            console.log('    isMeasurement === "true":', isMeasurement === 'true');
            console.log('    isMetricUnit (final):', isMetricUnit);
            
            if (!isMetricUnit) {
                // Unidade NÃO é de medida métrica - DESABILITAR campos de largura e comprimento
                console.log('  ❌ DESABILITANDO campos de dimensão');
                larguraField.disabled = true;
                comprimentoField.disabled = true;
                larguraField.style.backgroundColor = 'rgba(100, 100, 100, 0.3)';
                comprimentoField.style.backgroundColor = 'rgba(100, 100, 100, 0.3)';
                larguraField.style.cursor = 'not-allowed';
                comprimentoField.style.cursor = 'not-allowed';
                larguraField.style.color = '#666';
                comprimentoField.style.color = '#666';
                larguraField.value = '';
                comprimentoField.value = '';
                larguraField.placeholder = 'N/A';
                comprimentoField.placeholder = 'N/A';
            } else {
                // Unidade É de medida métrica - HABILITAR campos de largura e comprimento
                console.log('  ✅ HABILITANDO campos de dimensão');
                larguraField.disabled = false;
                comprimentoField.disabled = false;
                larguraField.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                comprimentoField.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                larguraField.style.cursor = '';
                comprimentoField.style.cursor = '';
                larguraField.style.color = 'white';
                comprimentoField.style.color = 'white';
                larguraField.placeholder = '0.00';
                comprimentoField.placeholder = '0.00';
            }
        } else {
            console.log('  ❌ Campos de largura/comprimento não encontrados para selectId:', selectId);
        }
        console.log('DEBUG - Fim da verificação\n');
    }

    // Função para verificar e habilitar/desabilitar o campo unidades baseado no tipo de item
    function verificarTipoItem(selectId) {
        const customSelect = document.getElementById(selectId);
        const selectButton = customSelect.querySelector('button');
        const tipoItemText = selectButton.textContent.toLowerCase();
        
        console.log('DEBUG - Verificando tipo de item:');
        console.log('  selectId:', selectId);
        console.log('  tipoItemText:', tipoItemText);
        
        // Determinar qual modal está sendo usado para encontrar o campo correto
        let unidadesField;
        
        if (selectId === 'itemTipoItem') {
            // Modal de incluir item
            unidadesField = document.getElementById('itemUnidades');
            console.log('  Usando modal de incluir item');
        } else if (selectId === 'editItemTipoItem') {
            // Modal de editar item
            unidadesField = document.getElementById('editItemUnidades');
            console.log('  Usando modal de editar item');
        }
        
        console.log('  unidadesField:', unidadesField);
        
        if (unidadesField) {
            // Verificar se o tipo contém "pacote fechado"
            const isPacoteFechado = tipoItemText.includes('pacote fechado') || tipoItemText.includes('pacote');
            
            console.log('  DECISÃO:');
            console.log('    isPacoteFechado:', isPacoteFechado);
            
            if (isPacoteFechado) {
                // É pacote fechado - HABILITAR campo de unidades
                console.log('  ✅ HABILITANDO campo de unidades');
                unidadesField.disabled = false;
                unidadesField.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                unidadesField.style.cursor = '';
                unidadesField.style.color = 'white';
                unidadesField.placeholder = '1';
                unidadesField.title = 'Defina quantas unidades há dentro deste pacote fechado';
                if (!unidadesField.value) {
                    unidadesField.value = '1';
                }
            } else {
                // NÃO é pacote fechado - DESABILITAR campo de unidades
                console.log('  ❌ DESABILITANDO campo de unidades');
                unidadesField.disabled = true;
                unidadesField.style.backgroundColor = 'rgba(100, 100, 100, 0.3)';
                unidadesField.style.cursor = 'not-allowed';
                unidadesField.style.color = '#666';
                unidadesField.value = '';
                unidadesField.placeholder = 'N/A';
                unidadesField.title = 'Habilita automaticamente quando o tipo for "Pacote Fechado"';
            }
        } else {
            console.log('  ❌ Campo de unidades não encontrado para selectId:', selectId);
        }
        console.log('DEBUG - Fim da verificação de tipo de item\n');
    }

    function openNovaUnidadeModal() {
        document.getElementById('novaUnidadeModal').style.display = 'block';
    }

    function closeNovaUnidadeModal() {
        document.getElementById('novaUnidadeModal').style.display = 'none';
        document.getElementById('novaUnidadeForm').reset();
    }

    // Funções para Tipo de Item
    function openNovoTipoItemModal() {
        document.getElementById('novoTipoItemModal').style.display = 'block';
    }

    function closeNovoTipoItemModal() {
        document.getElementById('novoTipoItemModal').style.display = 'none';
        document.getElementById('novoTipoItemForm').reset();
    }

    async function carregarTiposItemParaDropdown(selectId) {
        try {
            const response = await fetch('/api/tipo_itens');
            if (response.ok) {
                const result = await response.json();
                const customSelect = document.getElementById(selectId);
                const selectButton = customSelect.querySelector('button');
                const selectOptionsDiv = customSelect.querySelector('.dropdown-content');

                selectOptionsDiv.innerHTML = ''; // Limpa as opções existentes
                selectButton.textContent = 'Selecione o tipo'; // Resetar texto do botão
                selectButton.setAttribute('data-selected', ''); // Resetar valor selecionado

                if (result.status === 'success' && result.tipos) {
                    result.tipos.forEach(tipo => {
                        const optionDiv = document.createElement('div');
                        optionDiv.textContent = tipo.nome;
                        optionDiv.setAttribute('data-value', tipo.id); // Armazena o ID do tipo
                        optionDiv.onclick = function() {
                            selectButton.textContent = this.textContent;
                            selectButton.setAttribute('data-selected', this.getAttribute('data-value'));
                            selectOptionsDiv.style.display = 'none'; // Fechar dropdown após seleção
                            
                            // Verificar se deve habilitar/desabilitar o campo unidades
                            verificarTipoItem(selectId);
                        };
                        selectOptionsDiv.appendChild(optionDiv);
                    });
                }
            } else {
                console.error('Erro ao carregar tipos de item:', await response.text());
            }
        } catch (error) {
            console.error('Erro na requisição de tipos de item:', error);
        }
    }

    async function salvarNovoTipoItem() {
        const nome = document.getElementById('novoTipoItemNome').value.trim();
        const descricao = document.getElementById('novoTipoItemDescricao').value.trim();

        if (!nome) {
            showNotification('error', 'Por favor, informe o nome do tipo de item.');
            return;
        }
        
        try {
            const response = await fetch('/api/tipo_itens', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nome: nome, descricao: descricao })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showNotification('success', result.message || 'Tipo de item cadastrado com sucesso!');
                closeNovoTipoItemModal();
                document.getElementById('novoTipoItemForm').reset();
                
                // Recarregar os tipos nos dropdowns
                await carregarTiposItemParaDropdown('itemTipoItem');
                await carregarTiposItemParaDropdown('editItemTipoItem');
                
                // Recarregar a lista no modal de seleção se estiver aberto
                if (document.getElementById('tipoItemSelectionModal').style.display === 'block') {
                    await carregarTiposItemParaSelecao();
                }
            } else {
                const errorMessage = result.message || result.error || 'Erro desconhecido';
                showNotification('error', `Erro ao cadastrar tipo de item: ${errorMessage}`);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            showNotification('error', 'Erro ao cadastrar tipo de item. Por favor, tente novamente.');
        }
    }
</script>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirmationModal" class="modal">
    <div class="modal-content notification-modal-content">
        <span class="close-button" onclick="closeConfirmationModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <div id="confirmationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#FFC107">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M12 8V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="6" stroke-dashoffset="6">
                    <animate attributeName="stroke-dashoffset" values="6;0" dur="0.3s" begin="0.3s" fill="freeze"/>
                </path>
                <circle cx="12" cy="16" r="1" fill="white">
                    <animate attributeName="opacity" values="0;1" dur="0.2s" begin="0.6s" fill="freeze"/>
                </circle>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        </div>
        <h2>Confirmação</h2>
        <p id="confirmationModalMessage"></p>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="closeConfirmationModal()" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Cancelar</button>
            <button id="confirmBtn" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal para Nova Unidade de Medida -->
<div id="novaUnidadeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" onclick="closeNovaUnidadeModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Nova Unidade de Medida</h2>
        <div class="modal-body">
            <form id="novaUnidadeForm">
                <div class="form-group">
                    <label for="novaUnidadeNome">Nome da Unidade:</label>
                    <input type="text" id="novaUnidadeNome" name="novaUnidadeNome" required style="width: 100%; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                </div>
                <div class="form-group" style="display: flex; align-items: center; margin-top: 15px;">
                    <input type="checkbox" id="isMeasurementUnit" name="isMeasurementUnit" style="margin-right: 10px;">
                    <label for="isMeasurementUnit">É uma unidade de medida (ex: mm, cm, m)?</label>
                </div>
                <button type="button" onclick="salvarNovaUnidade()" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Unidade</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('novaUnidadeForm').addEventListener('submit', function(event) {
        event.preventDefault();
        salvarNovaUnidade();
    });

    // Adicionar event listener para o formulário de novo tipo de item
    document.getElementById('novoTipoItemForm').addEventListener('submit', function(event) {
        event.preventDefault();
        salvarNovoTipoItem();
    });
</script>

<!-- Modal de Notificação com Debug -->
<div id="notificationModal" class="modal">
    <div class="modal-content notification-modal-content">
        <span class="close-button" onclick="closeNotificationModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <div id="notificationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;"></div>
        <h2 id="notificationModalTitle"></h2>
        <p id="notificationModalMessage"></p>
        <div id="notificationDebugInfo" style="display: none; margin-top: 10px; padding: 8px; background-color: rgba(0, 0, 0, 0.3); border-radius: 4px; font-family: monospace; font-size: 0.9em; color: #FF9800;"></div>
        <button class="btn-primary" onclick="closeNotificationModal()" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; margin-top: 15px;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">OK</button>
    </div>
</div>

<style>
    /* Estilos para o combobox customizado */
    .custom-select {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 5px;
        position: relative;
        z-index: 1000;
        /* Evitar scroll do modal pai quando dropdown abrir */
        isolation: isolate;
    }

    .custom-select > button {
        padding: 10px 35px 10px 10px;
        background: transparent;
        border: none;
        color: white;
        text-align: left;
        font-size: 0.9em;
        width: 100%;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        box-sizing: border-box;
    }

    .custom-select > button:after {
        content: "▼";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9B64E3;
        font-size: 0.8em;
        pointer-events: none;
    }

    .custom-select > div {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 0;
        transition: height 0.3s ease-in-out;
        position: absolute;
        width: calc(100% - 12px);
        left: 6px;
        background-color: rgba(19, 4, 60, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 10px;
        margin-top: 5px;
        z-index: 10001;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .custom-select > div > a {
        display: block;
        padding: 10px;
        color: white;
        cursor: pointer;
        text-decoration: none;
        position: relative;
    }

    .custom-select > div > a:first-child {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    .custom-select > div > a:last-child {
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
    }

    .custom-select:hover > div,
    .custom-select:focus-within > div {
        height: auto;
        max-height: 200px;
        overflow-y: auto;
    }

    .custom-select > div > div {
        display: block;
        padding: 10px;
        color: white;
        cursor: pointer;
        text-decoration: none;
        position: relative;
        transition: background-color 0.2s ease;
    }

    .custom-select > div > div:hover,
    .custom-select > div > div:focus {
        background-color: rgba(155, 100, 227, 0.2);
        color: var(--cor-destaque, #D8CEFE);
    }

    .dropdown-content {
        display: none;
        position: absolute !important;
        width: calc(100% - 12px) !important;
        left: 6px !important;
        background-color: rgba(19, 4, 60, 0.7) !important;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 10px !important;
        margin-top: 5px !important;
        z-index: 10000 !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
        max-height: 150px !important;
        overflow-y: auto !important;
        min-height: 40px !important;
        /* Evitar scroll do modal pai */
        transform: translateZ(0);
        will-change: transform;
    }
    
    /* Força visibilidade quando display é block */
    .dropdown-content[style*="display: block"] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Z-index específico para dropdowns dentro de modais */
    .modal .custom-select {
        z-index: 1001;
    }

    .modal .custom-select > div,
    .modal .dropdown-content {
        z-index: 10002 !important;
    }

    /* Z-index específico para dropdowns dentro de modais de seleção */
    #categoriaSelectionModal .custom-select,
    #tipoItemSelectionModal .custom-select,
    #unidadeSelectionModal .custom-select,
    #fornecedorSelectionModal .custom-select,
    #materialSelectionModal .custom-select {
        z-index: 2002;
    }

    #categoriaSelectionModal .custom-select > div,
    #tipoItemSelectionModal .custom-select > div,
    #unidadeSelectionModal .custom-select > div,
    #fornecedorSelectionModal .custom-select > div,
    #materialSelectionModal .custom-select > div,
    #categoriaSelectionModal .dropdown-content,
    #tipoItemSelectionModal .dropdown-content,
    #unidadeSelectionModal .dropdown-content,
    #fornecedorSelectionModal .dropdown-content,
    #materialSelectionModal .dropdown-content {
        z-index: 2003 !important;
    }

    /* Garantir que o dropdown de tipo de item sempre fique acima do de categoria */
    #itemTipoItem {
        z-index: 1002;
    }

    #itemTipoItem > div,
    #itemTipoItem .dropdown-content {
        z-index: 10003 !important;
    }

    #editItemTipoItem {
        z-index: 1002;
    }

    #editItemTipoItem > div,
    #editItemTipoItem .dropdown-content {
        z-index: 10003 !important;
    }

    .modal {
        display: none; /* Oculto por padrão */
        position: fixed; /* Fica fixo na tela */
        z-index: 1000; /* Fica sobre todos os outros elementos */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Habilita scroll se necessário */
        background-color: rgba(0,0,0,0.4); /* Fundo preto com opacidade */
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    /* Z-index para modais principais */
    #itemModal,
    #editItemModal,
    #entradaEstoqueModal,
    #saidaEstoqueModal {
        z-index: 1500;
    }

    #itemModal .modal-content,
    #editItemModal .modal-content,
    #entradaEstoqueModal .modal-content,
    #saidaEstoqueModal .modal-content {
        z-index: 1501;
    }

    /* Z-index específicos para modais aninhados - ACIMA dos modais principais */
    #categoriaSelectionModal,
    #tipoItemSelectionModal,
    #unidadeSelectionModal,
    #fornecedorSelectionModal,
    #materialSelectionModal,
    #novaCategoriaModal,
    #novoTipoItemModal,
    #novaUnidadeModal,
    #novoFornecedorModal {
        z-index: 2000;
    }

    #categoriaSelectionModal .modal-content,
    #tipoItemSelectionModal .modal-content,
    #unidadeSelectionModal .modal-content,
    #fornecedorSelectionModal .modal-content,
    #novaCategoriaModal .modal-content,
    #novoTipoItemModal .modal-content,
    #novaUnidadeModal .modal-content,
    #novoFornecedorModal .modal-content {
        z-index: 2001;
    }

    /* Modal de notificação deve aparecer acima de todos os outros */
    #notificationModal,
    #confirmationModal {
        z-index: 3000 !important;
    }

    #notificationModal .modal-content,
    #confirmationModal .modal-content {
        z-index: 3001 !important;
    }

    .modal-content {
        background-color: rgba(59, 12, 121, 0.29);
        color: var(--sidebar-text-color, white);
        margin: 0;
        padding: 12px;
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 8px;
        width: 90%;
        max-width: 1100px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .modal-body {
        padding: 8px;
        max-height: none;
        overflow: visible;
    }

    /* Ajustes específicos para modais de item */
    #itemModal .modal-content,
    #editItemModal .modal-content {
        max-width: 1200px;
        max-height: 95vh;
        width: 95%;
        overflow-y: auto;
    }

    #itemModal .modal-body,
    #editItemModal .modal-body {
        padding: 15px;
        overflow: visible;
        max-height: none;
    }

    .close-button {
        color: var(--sidebar-text-color, white);
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: var(--cor-destaque, #D8CEFE);
        text-decoration: none;
        cursor: pointer;
    }

    .modal-content h2 {
        color: var(--sidebar-text-color, white);
        margin-top: 0;
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
        padding-bottom: 10px;
    }

    .modal-content form .form-group {
        margin-bottom: 8px;
    }

    .modal-content form label {
        display: block;
        margin-top: 5px;
        margin-bottom: 3px;
        font-weight: bold;
        color: var(--sidebar-text-color, white);
        font-size: 0.9em;
    }

    .modal-content form input[type="text"],
    .modal-content form input[type="number"],
    .modal-content form input[type="email"],
    .modal-content form input[type="password"],
    .modal-content form select,
    .modal-content form textarea {
        width: calc(100% - 22px);
        padding: 6px;
        margin-bottom: 3px;
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
        font-size: 0.9em;
    }

    .modal-content form input[type="text"]:hover,
    .modal-content form input[type="number"]:hover,
    .modal-content form input[type="email"]:hover,
    .modal-content form input[type="password"]:hover,
    .modal-content form select:hover,
    .modal-content form textarea:hover {
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.7);
        border-color: #D8CEFE;
    }
    .modal-content form select option {
        background-color: var(--sidebar-bg, #1f0a4d);
        color: var(--sidebar-text-color, white);
    }

    .modal-content form button[type="submit"] {
        background-color: rgba(155, 100, 227, 0.1);
        border: 1px solid #9B64E3;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 20px; /* Adicionar margem superior ao botão */
    }
    .modal-content form button[type="submit"]:hover {
        background-color: #D8CEFE;
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.7);
        border-color: #D8CEFE;
    }
</style>

<script>
function formatarMoeda(input) {
    let valor = input.value.replace(/\D/g, '');
    valor = (valor/100).toFixed(2);
    valor = valor.replace('.', ',');
    valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    input.value = valor.length > 0 ? `R$ ${valor}` : '';
}

function openEntradaEstoqueModal() {
    document.getElementById('entradaEstoqueModal').style.display = 'flex';
    carregarItensParaDropdown('material');
    carregarFornecedoresParaDropdown('fornecedor');
    // Set today's date as default
    document.getElementById('dataEntrada').value = new Date().toISOString().split('T')[0];
}

function openItemModal() {
    document.getElementById('itemModal').style.display = 'block';
    document.getElementById('itemForm').reset();
    // Inicializa o custom-select para a categoria
    const itemCategorySelect = document.getElementById('itemCategory');
    itemCategorySelect.querySelector('button').textContent = 'Selecione uma categoria';
    itemCategorySelect.querySelector('button').setAttribute('data-selected', '');
    carregarCategoriasParaDropdown('itemCategory');
}

function closeEntradaEstoqueModal() {
    document.getElementById('entradaEstoqueModal').style.display = 'none';
    document.getElementById('entradaEstoqueForm').reset();
}

function closeItemModal() {
    document.getElementById('itemModal').style.display = 'none';
    document.getElementById('itemForm').reset();
    
    // Resetar os dropdowns customizados
    const categoryDropdown = document.getElementById('itemCategory');
    const categoryButton = categoryDropdown.querySelector('button');
    if (categoryButton) {
        categoryButton.textContent = 'Selecione uma categoria';
        categoryButton.setAttribute('data-selected', '');
    }
    
    const supplierDropdown = document.getElementById('itemSupplier');
    const supplierButton = supplierDropdown.querySelector('button');
    if (supplierButton) {
        supplierButton.textContent = 'Selecione um fornecedor';
        supplierButton.setAttribute('data-selected', '');
    }
    
    const unitDropdown = document.getElementById('editItemUnit');
    const unitButton = unitDropdown.querySelector('button');
    if (unitButton) {
        unitButton.textContent = 'Selecione uma unidade';
        unitButton.setAttribute('data-selected', '');
    }
}

window.onclick = function(event) {
    const itemModal = document.getElementById('itemModal');
    const entradaEstoqueModal = document.getElementById('entradaEstoqueModal');
    const saidaEstoqueModal = document.getElementById('saidaEstoqueModal');
    const novaCategoriaModal = document.getElementById('novaCategoriaModal');
    
    if (event.target == itemModal) {
        itemModal.style.display = "none";
    } else if (event.target == entradaEstoqueModal) {
        entradaEstoqueModal.style.display = "none";
    } else if (event.target == saidaEstoqueModal) {
        saidaEstoqueModal.style.display = "none";
    } else if (event.target == novaCategoriaModal) {
        novaCategoriaModal.style.display = "none";
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Adiciona o event listener para o formulário de nova categoria
    const novaCategoriaForm = document.getElementById('novaCategoriaForm');
    if (novaCategoriaForm) {
        novaCategoriaForm.addEventListener('submit', salvarNovaCategoria);
    }
});

function openSaidaEstoqueModal() {
    document.getElementById('saidaEstoqueModal').style.display = 'flex';
    carregarItensParaDropdown('materialSaida');
    // Set today's date as default
    document.getElementById('dataSaida').value = new Date().toISOString().split('T')[0];
}

function closeSaidaEstoqueModal() {
    document.getElementById('saidaEstoqueModal').style.display = 'none';
    document.getElementById('saidaEstoqueForm').reset();
}

function openNovaCategoriaModal() {
    document.getElementById('novaCategoriaModal').style.display = 'block';
}

function closeNovaCategoriaModal() {
    document.getElementById('novaCategoriaModal').style.display = 'none';
    document.getElementById('novaCategoriaForm').reset();
}

async function salvarNovaCategoria(event) {
    event.preventDefault();
    const nomeCategoria = document.getElementById('novaCategoriaNome').value;
    if (!nomeCategoria.trim()) {
        showNotification('error', 'O nome da categoria não pode estar vazio.');
        return;
    }

    try {
        const response = await fetch('/api/categorias', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nome: nomeCategoria })
        });
        const result = await response.json();
        if (response.ok) {
            showNotification('success', 'Categoria cadastrada com sucesso!');
            closeNovaCategoriaModal();
            
            // Atualizar todos os dropdowns de categoria
            await carregarCategoriasParaDropdown('itemCategory');
            await carregarCategoriasParaDropdown('editItemCategory');
            
            // Recarregar a lista no modal de seleção se estiver aberto
            if (document.getElementById('categoriaSelectionModal').style.display === 'block') {
                await carregarCategoriasParaSelecao();
            }
        } else {
            showNotification('error', `Erro ao cadastrar categoria: ${result.message}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('error', 'Erro ao cadastrar categoria. Por favor, tente novamente.');
    }
}

function openNovoFornecedorModal() {
    document.getElementById('novoFornecedorModal').style.display = 'block';
}

function closeNovoFornecedorModal() {
    document.getElementById('novoFornecedorModal').style.display = 'none';
    document.getElementById('novoFornecedorForm').reset();
}

async function salvarNovoFornecedor(event) {
    event.preventDefault();
    
    const form = document.getElementById('novoFornecedorForm');
    
    // Criar um novo FormData para mapear os campos corretamente
    const formData = new FormData();
    
    // Mapear os campos do formulário para os nomes esperados pela API
    formData.append('nome', document.getElementById('fornecedorNome').value.trim());
    formData.append('cnpj', document.getElementById('fornecedorCNPJ').value.trim());
    formData.append('telefone', document.getElementById('fornecedorTelefone').value.trim());
    formData.append('email', document.getElementById('fornecedorEmail').value.trim());
    formData.append('endereco', document.getElementById('fornecedorEndereco').value.trim());
    formData.append('cidade', document.getElementById('fornecedorCidade').value.trim());
    formData.append('estado', document.getElementById('fornecedorEstado').value.trim());
    formData.append('cep', document.getElementById('fornecedorCEP').value.trim());
    formData.append('contato_nome', document.getElementById('fornecedorContatoNome').value.trim());
    formData.append('contato_telefone', document.getElementById('fornecedorContatoTelefone').value.trim());
    formData.append('contato_email', document.getElementById('fornecedorContatoEmail').value.trim());
    formData.append('website', document.getElementById('fornecedorWebsite').value.trim());
    formData.append('categoria_produtos', document.getElementById('fornecedorCategoriaProdutos').value.trim());
    formData.append('prazo_entrega', document.getElementById('fornecedorPrazoEntrega').value.trim());
    formData.append('condicoes_pagamento', document.getElementById('fornecedorCondicoesPagamento').value.trim());
    formData.append('observacoes', document.getElementById('fornecedorObservacoes').value.trim());
    
    // Validar apenas o nome do fornecedor como obrigatório
    const fornecedorNome = document.getElementById('fornecedorNome').value.trim();
    if (!fornecedorNome) {
        showNotification('error', 'Por favor, informe o nome do fornecedor.');
        return;
    }
    
    try {
        const response = await fetch('/api/fornecedores', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification('success', 'Fornecedor cadastrado com sucesso!');
            closeNovoFornecedorModal();
            form.reset();
            
            // Recarregar os fornecedores nos dropdowns
            await carregarFornecedoresParaDropdown('itemSupplier');
            await carregarFornecedoresParaDropdown('editItemSupplier');
            
            // Recarregar a lista no modal de seleção se estiver aberto
            if (document.getElementById('fornecedorSelectionModal').style.display === 'block') {
                await carregarFornecedoresParaSelecao();
            }
        } else {
            // Verificar se há uma mensagem de erro específica
            const errorMessage = result.erro || result.error || 'Erro desconhecido';
            showNotification('error', `Erro ao cadastrar fornecedor: ${errorMessage}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        showNotification('error', 'Erro ao cadastrar fornecedor. Por favor, tente novamente.');
    }
}

async function carregarCategoriasParaDropdown(selectId) {
    try {
        const response = await fetch('/api/categorias');
        if (response.ok) {
            const result = await response.json();
            const customSelect = document.getElementById(selectId);
            const selectButton = customSelect.querySelector('button');
            const selectOptionsDiv = customSelect.querySelector('.dropdown-content');

            selectOptionsDiv.innerHTML = ''; // Limpa as opções existentes
            selectButton.textContent = 'Selecione uma categoria'; // Resetar texto do botão
            selectButton.setAttribute('data-selected', ''); // Resetar valor selecionado

            if (result.status === 'success' && result.categorias) {
                result.categorias.forEach(categoria => {
                    const optionDiv = document.createElement('div');
                    optionDiv.textContent = categoria.nome;
                    optionDiv.setAttribute('data-value', categoria.id); // Usar ID da categoria
                    optionDiv.onclick = function() {
                        selectButton.textContent = this.textContent;
                        selectButton.setAttribute('data-selected', this.getAttribute('data-value'));
                        selectOptionsDiv.style.display = 'none'; // Fechar dropdown após seleção
                    };
                    selectOptionsDiv.appendChild(optionDiv);
                });
            }
        } else {
            console.error('Erro ao carregar categorias:', await response.text());
        }
    } catch (error) {
        console.error('Erro na requisição de categorias:', error);
    }
}

async function carregarFornecedoresParaDropdown(selectId) {
    try {
        const response = await fetch('/api/fornecedores');
        if (response.ok) {
            const result = await response.json();
            const customSelect = document.getElementById(selectId);
            const selectButton = customSelect.querySelector('button');
            const selectOptionsDiv = customSelect.querySelector('.dropdown-content');

            selectOptionsDiv.innerHTML = ''; // Limpa as opções existentes
            selectButton.textContent = 'Selecione um fornecedor'; // Resetar texto do botão
            selectButton.setAttribute('data-selected', ''); // Resetar valor selecionado

            // Verifica se o resultado é um array (resposta direta da API) ou tem a estrutura antiga
            const fornecedores = Array.isArray(result) ? result : 
                               (result.status === 'success' && result.fornecedores ? result.fornecedores : []);
            
            if (fornecedores.length > 0) {
                fornecedores.forEach(fornecedor => {
                    const optionDiv = document.createElement('div');
                    optionDiv.textContent = fornecedor.nome;
                    optionDiv.setAttribute('data-value', fornecedor.id); // Usar ID do fornecedor
                    optionDiv.onclick = function() {
                        selectButton.textContent = this.textContent;
                        selectButton.setAttribute('data-selected', this.getAttribute('data-value'));
                        selectOptionsDiv.style.display = 'none'; // Fechar dropdown após seleção
                    };
                    selectOptionsDiv.appendChild(optionDiv);
                });
            } else {
                console.log('Nenhum fornecedor encontrado');
            }
        } else {
            console.error('Erro ao carregar fornecedores:', await response.text());
        }
    } catch (error) {
        console.error('Erro na requisição de fornecedores:', error);
    }
}

function carregarItensParaDropdown(selectId) {
    fetch('/api/itens_estoque/lista')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const dropdown = document.querySelector(`#${selectId} > div`);
                dropdown.innerHTML = '';
                
                // Filtrar apenas itens que NÃO são unidades fracionadas
                const itensFiltrados = data.items.filter(item => {
                    const tipoItem = (item.tipo_item || '').toLowerCase();
                    const nome = (item.nome || '').toLowerCase();
                    
                    // Excluir se for "unidade fracionada" ou se o nome contém "(unidades)"
                    return !tipoItem.includes('unidade fracionada') && 
                           !nome.includes('(unidades)');
                });
                
                itensFiltrados.forEach(item => {
                    const option = document.createElement('div');
                    option.textContent = `${item.codigo} - ${item.nome}`;
                    option.setAttribute('data-value', item.id);
                    option.onclick = function() {
                        document.querySelector(`#${selectId} > button`).textContent = this.textContent;
                        document.querySelector(`#${selectId} > button`).setAttribute('data-selected', item.id);
                    };
                    dropdown.appendChild(option);
                });
            } else {
                console.error('Erro ao carregar itens:', data.message);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
        });
}

    function carregarListaEstoque() {
        fetch('/api/itens_estoque/completo')
            .then(response => {
                const statusCode = response.status;
                return response.json().then(data => ({ data, statusCode }));
            })
            .then(({ data, statusCode }) => {
            if (data.status === 'success') {
                const container = document.querySelector('.estoque-list');
                container.innerHTML = '';
                
                if (data.items.length === 0) {
                    const emptyRow = document.createElement('div');
                    emptyRow.className = 'user-item';
                    emptyRow.style.cssText = 'justify-content: center; color: #666;';
                    emptyRow.textContent = 'Nenhum item cadastrado.';
                    container.appendChild(emptyRow);
                    return;
                }
                
                data.items.forEach(item => {
                    const status = item.quantidade_atual <= item.estoque_minimo ? 'Baixo' : 'Normal';
                    const statusColor = status === 'Baixo' ? 'color: #ff6b6b;' : 'color: #51cf66;';
                    
                    // Format dimension, weight and volume values
                    const formatDimension = (value) => value ? `${value} cm` : '-';
                    
                    const formatWeight = (value) => {
                        if (!value || value === 0) return '-';
                        const weight = parseFloat(value);
                        if (weight >= 1000) {
                            return `${(weight / 1000).toFixed(2).replace('.', ',')} kg`;
                        }
                        return `${weight} g`;
                    };
                    
                    const formatVolume = (value) => {
                        if (!value || value === 0) return '-';
                        const volume = parseFloat(value);
                        if (volume >= 1) {
                            return `${volume.toFixed(3).replace('.', ',')} L`;
                        } else {
                            return `${(volume * 1000).toFixed(0)} ml`;
                        }
                    };
                    
                    const row = document.createElement('div');
                    row.className = 'user-item';
                    row.style.cssText = 'display: grid; grid-template-columns: 0.8fr 1fr 1.5fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1fr 1fr 1fr 0.8fr 0.8fr; gap: 15px; padding: 12px 20px; margin: 8px 0; border-radius: 6px; transition: background-color 0.2s ease; align-items: center;';
                    
                    // Format currency values
                    const formatCurrency = (value) => {
                        if (value && value !== 0) {
                            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
                        }
                        return 'R$ 0,00';
                    };
                    
                    row.innerHTML = `
                        <div title="${item.codigo}">${item.codigo}</div>
                        <div title="${item.tipo_item || '-'}">${item.tipo_item || '-'}</div>
                        <div title="${item.nome}">${item.nome}</div>
                        <div title="${item.categoria || '-'}">${item.categoria || '-'}</div>
                        <div>${item.quantidade_atual}</div>
                        <div>${item.estoque_minimo}</div>
                        <div>${formatDimension(item.largura)}</div>
                        <div>${formatDimension(item.comprimento)}</div>
                        <div>${formatWeight(item.peso)}</div>
                        <div>${formatVolume(item.volume)}</div>
                        <div>${formatCurrency(item.custo_medio)}</div>
                        <div>${formatCurrency(item.custo_atual)}</div>
                        <div title="${item.fornecedor || '-'}">${item.fornecedor || '-'}</div>
                        <div title="${item.fabricante || '-'}">${item.fabricante || '-'}</div>
                        <div title="${item.localizacao_estoque || '-'}">${item.localizacao_estoque || '-'}</div>
                        <div style="${statusColor} font-weight: bold;">${status}</div>
                        <div class="user-actions" style="display: flex; gap: 5px; margin: 0; padding: 0; list-style: none; align-items: center;">
                            ${item.tipo_item && item.tipo_item.toLowerCase().includes('pacote fechado') ? `
                                <button class="action-btn" data-tooltip="Fracionar Pacote" onclick="fracionarPacote(${item.id})" style="background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--action-icon-color);">
                                    <svg width="18" height="18" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M312.664485 307.584525l0.917215-0.917215 162.593998-228.139594c9.771868-9.383815 22.824543-14.53433 36.829711-14.534331s27.057843 5.150515 36.900265 14.604886l160.830124 226.340441 0.917215 0.917215c9.983533 10.089365 15.486823 23.494815 15.5221 37.817481 0 14.322665-5.468013 27.728115-15.451545 37.782202-9.912978 10.01881-23.353705 15.5221-37.817481 15.5221s-27.904503-5.50329-37.81748-15.5221l-70.660833-70.27278v319.473042c0 29.103938-24.376753 53.692355-53.19847 53.692356-28.821718 0-53.19847-24.588418-53.198471-53.692356V312.840872l-70.766665 70.413891c-9.8777 9.948255-23.212595 15.38099-37.711648 15.38099-14.25211 0-27.551728-5.36218-37.429428-15.09877-10.230475-9.807145-15.910153-22.85982-16.192372-36.900265-0.317498-14.640163 5.291625-28.50422 15.733765-39.052193z m1.869707 420.40197h394.931616c20.849003 0 38.417198 17.77986 38.417197 38.805251s-17.603473 38.80525-38.417197 38.80525H314.534192c-21.1665 0-38.417198-17.391808-38.417197-38.80525-0.035278-21.02539 17.568195-38.80525 38.417197-38.805251z m578.304062 81.949633c0 82.725738-66.674475 150.070486-148.624109 150.070487H279.785855c-81.949633 0-148.624109-67.30947-148.624109-150.070487V423.859166c0-27.65756 22.15427-50.023495 49.52961-50.023496 27.37534 0 49.52961 22.365935 49.529611 50.023496v386.076962c0 27.587005 22.224825 50.023495 49.52961 50.023496h464.428291c27.340063 0 49.52961-22.43649 49.52961-50.023496V419.131981c0-27.65756 22.15427-50.023495 49.529611-50.023496 27.37534 0 49.52961 22.365935 49.52961 50.023496v390.804147z"/>
                                    </svg>
                                </button>
                            ` : ''}
                            ${item.tipo_item && item.tipo_item.toLowerCase().includes('frasco') || item.tipo_item && item.tipo_item.toLowerCase().includes('garrafa') ? `
                                <button class="action-btn" data-tooltip="Fracionar por Volume" onclick="fracionarFrascoGarrafa(${item.id})" style="background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--action-icon-color);">
                                    <svg width="18" height="18" viewBox="0 0 10.17 16.1" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7.14,3.37v1.16h1.25c.6,0,1.35.71,1.57,1.24s.42,1.81-.44,1.74c-.65-.05-.45-.73-.53-1.13-.2-1.12-1.72-.62-2.49-.74-.15-.03-.48-.24-.48-.4v-1.84h-1.9v1.84c0,.16-.33.37-.48.4-.59.1-1.65-.16-2.12.17-.13.09-.39.44-.39.59v2.16c.14-.05.27-.12.41-.17.68-.21,1.34-.27,2.05-.13,1.87.35,2.76,2.37,4.99,1.27.29-.14.69-.54.99-.53.29,0,.51.22.55.49-.1,1.54.13,3.25,0,4.77-.09.93-.87,1.74-1.81,1.85H1.81c-.97-.12-1.74-.94-1.81-1.91v-7.79c-.01-.78.96-1.88,1.74-1.88h1.25v-1.16C1,3.16,1.04.18,3.04.03c1.33-.1,2.77.08,4.11,0,1.95.29,1.94,3.08-.02,3.33ZM3.05,1.16c-.51.13-.58.85-.09,1.05.28.12.42.03.67.03.94-.01,1.88-.01,2.82,0,.26,0,.4.09.68-.02.53-.19.46-.96-.09-1.07h-4ZM9,10.56c-1.02.5-2.21.5-3.25.07-.82-.34-1.42-1.05-2.31-1.24-.58-.13-1.14-.09-1.7.13-.11.04-.52.25-.59.33-.03.03-.04.06-.04.1v4.21c.06.37.31.69.68.8l6.41.02c.31,0,.79-.47.79-.75v-3.67Z"/>
                                    </svg>
                                </button>
                            ` : ''}
                            ${item.tipo_item && item.tipo_item.toLowerCase().includes('embalagem') && item.peso > 0 ? `
                                <button class="action-btn" data-tooltip="Fracionar por Peso" onclick="fracionarEmbalagem(${item.id})" style="background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--action-icon-color);">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zM9 8h6v2h-2v4h2v2H9v-2h2v-4H9V8z"/>
                                        <path d="M8 19h8v1H8v-1zm8-16H8v1h8V3zm-4 2.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/>
                                    </svg>
                                </button>
                            ` : ''}
                            <button class="action-btn" data-tooltip="Editar" onclick="editarItem(${item.id})" style="background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--action-icon-color);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                                    <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                                </svg>
                            </button>
                            <button class="action-btn" data-tooltip="Excluir" onclick="excluirItem(${item.id})" style="background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--action-icon-color);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    // Adicionar hover effect
                    row.addEventListener('mouseover', function() {
                        this.style.backgroundColor = 'var(--order-card-hover-bg)';
                    });
                    
                    row.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    container.appendChild(row);
                });
            } else {
                console.error('Erro ao carregar lista de estoque:', data.message);
                const errorCode = statusCode || 'API_ERROR';
                showNotification('error', 'Erro ao carregar itens: ' + data.message, errorCode);
                
                const errorRow = document.createElement('div');
                errorRow.className = 'user-item';
                errorRow.style.cssText = 'justify-content: center; color: red;';
                errorRow.textContent = 'Erro ao carregar itens: ' + data.message;
                document.querySelector('.estoque-list').appendChild(errorRow);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            showNotification('error', 'Erro ao carregar itens: ' + (error.message || 'Erro desconhecido'), 'EXCEPTION');
            
            const errorRow = document.createElement('div');
            errorRow.className = 'user-item';
            errorRow.style.cssText = 'justify-content: center; color: red;';
            errorRow.textContent = 'Erro ao carregar itens: ' + error.message;
            document.querySelector('.estoque-list').appendChild(errorRow);
        });
}

// Função para abrir o modal de edição de item
async function editarItem(id) {
    const modal = document.getElementById('editItemModal');
    const form = document.getElementById('editItemForm');
    
    // Resetar o formulário
    form.reset();
    
    try {
        // Buscar os dados do item pelo ID
        const response = await fetch(`/api/itens_estoque/${id}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        if (response.ok) {
            const result = await response.json();
            console.log('Resposta da API:', result);
            
            // Verificar se a resposta contém um erro
            if (result.status === 'error') {
                throw new Error(result.message || 'Erro ao carregar dados do item');
            }
            
            // Verificar se result contém o item
            if (!result.item) {
                console.error('Resposta da API não contém o campo "item":', result);
                throw new Error('Resposta da API não contém dados do item');
            }
            
            const item = result.item;
            
            // Verificar se o item é um objeto válido
            if (typeof item !== 'object') {
                console.error('Dados do item não são um objeto válido:', item);
                throw new Error('Dados do item inválidos ou incompletos');
            }
            
            console.log('Dados do item recebidos:', item);
            
            // Verificar se o item contém um erro
            if (item.erro) {
                console.error('Item contém erro:', item.erro);
                throw new Error(item.erro);
            }
            
            // Verificar campos obrigatórios
            const camposObrigatorios = ['id', 'nome', 'codigo'];
            for (const campo of camposObrigatorios) {
                if (!(campo in item)) {
                    console.error(`Campo obrigatório "${campo}" não encontrado no item:`, item);
                    throw new Error(`Campo obrigatório "${campo}" não encontrado`);
                }
            }
            
            // Preencher o formulário com os dados do item
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.nome || '';
            document.getElementById('editItemCode').value = item.codigo || '';
            document.getElementById('editItemColor').value = item.cor || '';
            document.getElementById('editItemInitialQuantity').value = item.quantidade_inicial || 0;
            document.getElementById('editItemMinStock').value = item.estoque_minimo || 0;
            document.getElementById('editItemUnit').value = item.unidade_medida || '';
            document.getElementById('editItemLocation').value = item.localizacao_estoque || '';
            document.getElementById('editItemFabricante').value = item.fabricante || '';
            document.getElementById('editItemTechSpecs').value = item.especificacoes_tecnicas || '';
            document.getElementById('editItemDescription').value = item.descricao || '';
            
            // Preencher os novos campos de dimensões e peso
            document.getElementById('editItemLargura').value = item.largura || '';
            document.getElementById('editItemComprimento').value = item.comprimento || '';
            document.getElementById('editItemEspessura').value = item.espessura || '';
            document.getElementById('editItemVolume').value = item.volume || '';
            document.getElementById('editItemPeso').value = item.peso || '';
            
            // Preencher o campo unidades por pacote corretamente
            document.getElementById('editItemUnidades').value = item.unidades_por_pacote || '';
            
            // Exibir o modal antes de carregar as categorias e fornecedores
            modal.style.display = 'block';
            
            // Carregar categorias no dropdown de edição
            await carregarCategoriasParaDropdown('editItemCategory');
            
            // Carregar tipos de item no dropdown de edição
            await carregarTiposItemParaDropdown('editItemTipoItem');
            
            // Carregar fornecedores no dropdown de edição
            await carregarFornecedoresParaDropdown('editItemSupplier');
            
            // Carregar unidades de medida no dropdown de edição
            await carregarUnidadesParaDropdown('editItemUnit');

            // Aguardar um pequeno delay para garantir que os dropdowns foram carregados
            setTimeout(() => {
                // Definir o valor da categoria após carregar as opções
                if (item.categoria_id) {
                    const categoryDropdown = document.getElementById('editItemCategory');
                    const categoryOption = categoryDropdown.querySelector(`div > div[data-value="${item.categoria_id}"]`);
                    if (categoryOption) {
                        // Simular clique na opção para atualizar o dropdown customizado
                        categoryOption.click();
                        console.log(`Categoria selecionada: ${item.categoria_nome} (ID: ${item.categoria_id})`);
                    } else {
                        console.log(`Categoria com ID ${item.categoria_id} não encontrada nas opções`);
                        // Se a categoria do item não estiver nas opções, resetar para o placeholder
                        const button = categoryDropdown.querySelector('button');
                        if (button) {
                            button.textContent = 'Selecione uma categoria';
                            button.setAttribute('data-selected', '');
                        }
                    }
                } else {
                    const categoryDropdown = document.getElementById('editItemCategory');
                    const button = categoryDropdown.querySelector('button');
                    if (button) {
                        button.textContent = 'Selecione uma categoria';
                        button.setAttribute('data-selected', '');
                    }
                }
                
                // Definir o valor do tipo de item após carregar as opções
                if (item.tipo_item_id) {
                    const tipoItemDropdown = document.getElementById('editItemTipoItem');
                    const tipoItemOption = tipoItemDropdown.querySelector(`div > div[data-value="${item.tipo_item_id}"]`);
                    if (tipoItemOption) {
                        tipoItemOption.click();
                        console.log(`Tipo de item selecionado: ${item.tipo_item_nome} (ID: ${item.tipo_item_id})`);
                    } else {
                        console.log(`Tipo de item com ID ${item.tipo_item_id} não encontrado nas opções`);
                        const button = tipoItemDropdown.querySelector('button');
                        if (button) {
                            button.textContent = 'Selecione o tipo';
                            button.setAttribute('data-selected', '');
                        }
                    }
                } else {
                    const tipoItemDropdown = document.getElementById('editItemTipoItem');
                    const button = tipoItemDropdown.querySelector('button');
                    if (button) {
                        button.textContent = 'Selecione o tipo';
                        button.setAttribute('data-selected', '');
                    }
                }
                
                // Definir o valor do fornecedor após carregar as opções
                if (item.fornecedor_id) {
                    const supplierDropdown = document.getElementById('editItemSupplier');
                    const supplierOption = supplierDropdown.querySelector(`div > div[data-value="${item.fornecedor_id}"]`);
                    if (supplierOption) {
                        // Simular clique na opção para atualizar o dropdown customizado
                        supplierOption.click();
                        console.log(`Fornecedor selecionado: ${item.fornecedor_nome} (ID: ${item.fornecedor_id})`);
                    } else {
                        console.log(`Fornecedor com ID ${item.fornecedor_id} não encontrado nas opções`);
                        // Se o fornecedor do item não estiver nas opções, resetar para o placeholder
                        const button = supplierDropdown.querySelector('button');
                        if (button) {
                            button.textContent = 'Selecione um fornecedor';
                            button.setAttribute('data-selected', '');
                        }
                    }
                } else {
                    const supplierDropdown = document.getElementById('editItemSupplier');
                    const button = supplierDropdown.querySelector('button');
                    if (button) {
                        button.textContent = 'Selecione um fornecedor';
                        button.setAttribute('data-selected', '');
                    }
                }

                // Definir o valor da unidade de medida após carregar as opções
                if (item.unidade_medida_id) {
                    const unitDropdown = document.getElementById('editItemUnit');
                    // Procuramos pelo ID da unidade de medida
                    const unitOption = unitDropdown.querySelector(`div > div[data-value="${item.unidade_medida_id}"]`);
                    if (unitOption) {
                        // Simular clique na opção para atualizar o dropdown customizado
                        unitOption.click();
                        console.log(`Unidade de medida selecionada: ${item.unidade_medida_nome} (ID: ${item.unidade_medida_id})`);
                    } else {
                        console.log(`Unidade de medida com ID ${item.unidade_medida_id} não encontrada nas opções`);
                        // Se a unidade do item não estiver nas opções, resetar para o placeholder
                        const button = unitDropdown.querySelector('button');
                        if (button) {
                            button.textContent = 'Selecione uma unidade';
                            button.setAttribute('data-selected', '');
                        }
                    }
                } else {
                    const unitDropdown = document.getElementById('editItemUnit');
                    const button = unitDropdown.querySelector('button');
                    if (button) {
                        button.textContent = 'Selecione uma unidade';
                        button.setAttribute('data-selected', '');
                    }
                }
            }, 500); // Aguarda 500ms para garantir que os dropdowns foram carregados
        } else {
            try {
                const error = await response.json();
                console.error('Erro na resposta da API:', error, 'Status:', response.status);
                const errorCode = response.status || 'API_ERROR';
                const errorMessage = error.message || 'Erro desconhecido';
                showNotification('error', `Erro ao carregar item: ${errorMessage}`, errorCode);
            } catch (jsonError) {
                console.error('Erro ao processar resposta da API:', jsonError, 'Status:', response.status);
                showNotification('error', `Erro ao carregar item. Status: ${response.status}`, 'PARSE_ERROR');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar item:', error);
        let errorMessage = 'Erro ao carregar item. Por favor, tente novamente.';
        let errorCode = 'EXCEPTION';
        
        // Tentar extrair mais informações do erro
        if (error.message) {
            errorMessage += ` Detalhes: ${error.message}`;
        }
        
        showNotification('error', errorMessage, errorCode);
    }
}

// Função para fechar o modal de edição
function closeEditItemModal() {
    document.getElementById('editItemModal').style.display = 'none';
    document.getElementById('editItemForm').reset();
    
    // Resetar os dropdowns customizados
    const categoryDropdown = document.getElementById('editItemCategory');
    const categoryButton = categoryDropdown.querySelector('button');
    if (categoryButton) {
        categoryButton.textContent = 'Selecione uma categoria';
        categoryButton.setAttribute('data-selected', '');
    }
    
    const supplierDropdown = document.getElementById('editItemSupplier');
    const supplierButton = supplierDropdown.querySelector('button');
    if (supplierButton) {
        supplierButton.textContent = 'Selecione um fornecedor';
        supplierButton.setAttribute('data-selected', '');
    }
    
    const unitDropdown = document.getElementById('editItemUnit');
    const unitButton = unitDropdown.querySelector('button');
    if (unitButton) {
        unitButton.textContent = 'Selecione uma unidade';
        unitButton.setAttribute('data-selected', '');
    }
}

// Função duplicada removida - a função principal está mais acima

// Função para excluir item com confirmação
function excluirItem(id) {
    // Mostra o modal de confirmação personalizado
    showConfirmationModal('Tem certeza que deseja excluir este item?', async () => {
        try {
            const response = await fetch(`/api/itens_estoque/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            
            if (response.ok) {
                showNotification('success', 'Item excluído com sucesso!');
                // Atualizar a lista de itens
                carregarListaEstoque();
            } else {
                const errorCode = response.status || 'API_ERROR';
                showNotification('error', `Erro ao excluir item: ${result.message}`, errorCode);
            }
        } catch (error) {
            console.error('Erro:', error);
            showNotification('error', 'Erro ao excluir item. Por favor, tente novamente.', 'EXCEPTION');
        }
    });
}

// Namespace para estoque para evitar conflitos
window.EstoqueModule = window.EstoqueModule || {};

// Função para mostrar o modal de confirmação
EstoqueModule.confirmationTimer = null;

function showConfirmationModal(message, onConfirm) {
    const modal = document.getElementById('confirmationModal');
    const msg = document.getElementById('confirmationModalMessage');
    const confirmBtn = document.getElementById('confirmBtn');
    
    // Verificar se todos os elementos foram encontrados
    if (!modal || !msg || !confirmBtn) {
        console.error('DEBUG - Elementos do modal de confirmação não encontrados:');
        console.error('  modal:', modal);
        console.error('  msg:', msg);
        console.error('  confirmBtn:', confirmBtn);
        // Fallback para confirmação nativa do browser
        if (confirm(message)) {
            if (typeof onConfirm === 'function') {
                onConfirm();
            }
        }
        return;
    }
    
    // Limpa qualquer timer existente
    if (EstoqueModule.confirmationTimer) {
        clearInterval(EstoqueModule.confirmationTimer);
    }
    
    // Usar innerHTML para renderizar HTML, ou textContent para texto simples
    if (message.includes('<div') || message.includes('<span')) {
        msg.innerHTML = message;
    } else {
        msg.textContent = message;
    }
    modal.style.display = 'block';
    
    // Remove qualquer onclick existente e desabilita o botão
    confirmBtn.onclick = null;
    confirmBtn.disabled = true;
    let secondsLeft = 5;
    confirmBtn.textContent = `Confirmar (${secondsLeft}s)`;
    
    // Inicia o contador
    EstoqueModule.confirmationTimer = setInterval(() => {
        secondsLeft--;
        if (secondsLeft <= 0) {
            clearInterval(EstoqueModule.confirmationTimer);
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirmar';
            
            // Só adiciona o onclick depois do tempo
            confirmBtn.onclick = function() {
                closeConfirmationModal();
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            };
        } else {
            confirmBtn.textContent = `Confirmar (${secondsLeft}s)`;
        }
    }, 1000);
}

// Função para fechar o modal de confirmação
function closeConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    const confirmBtn = document.getElementById('confirmBtn');
    
    // Limpa o timer e reseta o botão
    if (EstoqueModule.confirmationTimer) {
        clearInterval(EstoqueModule.confirmationTimer);
        EstoqueModule.confirmationTimer = null;
    }
    
    // Remove o onclick e reseta o botão
    confirmBtn.onclick = null;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Confirmar';
    
    modal.style.display = 'none';
}

// Função para mostrar notificações
function showNotification(type, message, errorCode = null) {
    const iconContainer = document.getElementById('notificationIcon');
    
    if (type === 'success') {
        iconContainer.innerHTML = `\n            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <circle cx="12" cy="12" r="10" fill="#4CAF50">\n                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>\n                </circle>\n                <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">\n                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.5s" begin="0.3s" fill="freeze"/>\n                </path>\n                <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>\n                <animateTransform attributeName="transform" type="rotate" values="-15;0;15;0" dur="0.8s" repeatCount="1" additive="sum"/>\n            </svg>\n        `;
    } else {
        iconContainer.innerHTML = `\n            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <circle cx="12" cy="12" r="10" fill="#F44336">\n                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>\n                </circle>\n                <path d="M8 8L16 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">\n                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.3s" fill="freeze"/>\n                </path>\n                <path d="M16 8L8 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="15" stroke-dashoffset="15">\n                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.5s" fill="freeze"/>\n                </path>\n                <animateTransform attributeName="transform" type="scale" values="0.5;1.2;1" dur="0.8s" repeatCount="1" additive="sum"/>\n                <animateTransform attributeName="transform" type="rotate" values="0;15;-15;0" dur="0.8s" repeatCount="1" additive="sum"/>\n            </svg>\n        `;
    }
    
    const modal = document.getElementById('notificationModal');
    const title = document.getElementById('notificationModalTitle');
    const msg = document.getElementById('notificationModalMessage');
    const content = modal.querySelector('.notification-modal-content');
    const debugContainer = document.getElementById('notificationDebugInfo');
    
    title.textContent = type === 'success' ? 'Sucesso!' : 'Erro!';
    msg.textContent = message;
    content.className = 'modal-content notification-modal-content ' + type;
    
    // Exibir informações de debug se houver um código de erro
    if (errorCode && debugContainer) {
        debugContainer.textContent = `Código de erro: ${errorCode}`;
        debugContainer.style.display = 'block';
    } else if (debugContainer) {
        debugContainer.style.display = 'none';
    }
    
    modal.style.display = 'block';
}

// Função para fechar o modal de notificação
function closeNotificationModal() {
    document.getElementById('notificationModal').style.display = 'none';
}

// Função global para inicializar os scripts do estoque
function initializeEstoqueScripts() {
    console.log('Inicializando scripts do estoque...');
    // Load initial inventory list
    carregarListaEstoque();
    
    // Carregar categorias, fornecedores, unidades e tipos para os dropdowns
    carregarCategoriasParaDropdown('itemCategory');
    carregarFornecedoresParaDropdown('itemSupplier');
    carregarUnidadesParaDropdown('itemUnit');
    carregarUnidadesParaDropdown('editItemUnit');
    carregarTiposItemParaDropdown('itemTipoItem');
    carregarTiposItemParaDropdown('editItemTipoItem');
    
    // Configurar dropdowns
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        const button = dropdown.querySelector('button');
        const dropdownContent = dropdown.querySelector('.dropdown-content');
        
        button.addEventListener('click', function() {
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        });
        
        dropdownContent.addEventListener('click', function(e) {
            if (e.target.tagName === 'DIV') {
                button.textContent = e.target.textContent;
                button.setAttribute('data-selected', e.target.getAttribute('data-value'));
                dropdownContent.style.display = 'none';
            }
        });
    });
    
    // Fechar dropdowns ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(content => {
                content.style.display = 'none';
            });
        }
    });
    
    // Adicionar event listener para o formulário de novo fornecedor
    const novoFornecedorForm = document.getElementById('novoFornecedorForm');
    if (novoFornecedorForm) {
        novoFornecedorForm.addEventListener('submit', salvarNovoFornecedor);
    }
    
    // Item form submission
    const itemForm = document.getElementById('itemForm');
    if (itemForm && !itemForm.hasAttribute('data-listeners-added')) {
        itemForm.setAttribute('data-listeners-added', 'true');
        
        itemForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Disable submit button to prevent double submission
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton && !submitButton.disabled) {
                submitButton.disabled = true;
                submitButton.style.opacity = '0.5';
                submitButton.style.cursor = 'not-allowed';
                
            const formData = new FormData(this);
            
            // Get values from inputs
            const largura = document.getElementById('itemLargura').value;
            const comprimento = document.getElementById('itemComprimento').value;
            const espessura = document.getElementById('itemEspessura').value;
            const volume = document.getElementById('itemVolume').value;
            const peso = document.getElementById('itemPeso').value;
            const fabricante = document.getElementById('itemFabricante').value;
            
            // Add the new fields to formData
            formData.set('itemLargura', largura);
            formData.set('itemComprimento', comprimento);
            formData.set('itemEspessura', espessura);
            formData.set('itemVolume', volume);
            formData.set('itemPeso', peso);
            formData.set('itemFabricante', fabricante);
            
            // Obter o valor da categoria do dropdown customizado
            const itemCategorySelect = document.getElementById('itemCategory');
            const categorySelectButton = itemCategorySelect.querySelector('button');
            const selectedCategory = categorySelectButton ? categorySelectButton.getAttribute('data-selected') : '';
            formData.set('itemCategory', selectedCategory);
            console.log('DEBUG - Categoria selecionada:', selectedCategory);
            
            // Obter o valor do tipo de item do dropdown customizado
            const itemTipoItemSelect = document.getElementById('itemTipoItem');
            const tipoItemSelectButton = itemTipoItemSelect.querySelector('button');
            const selectedTipoItem = tipoItemSelectButton ? tipoItemSelectButton.getAttribute('data-selected') : '';
            formData.set('itemTipoItem', selectedTipoItem);
            console.log('DEBUG - Tipo de item selecionado:', selectedTipoItem);
            
            // Obter o valor do fornecedor do dropdown customizado
            const itemSupplierSelect = document.getElementById('itemSupplier');
            const supplierSelectButton = itemSupplierSelect.querySelector('button');
            const selectedSupplier = supplierSelectButton ? supplierSelectButton.getAttribute('data-selected') : '';
            formData.set('itemSupplier', selectedSupplier);
            console.log('DEBUG - Fornecedor selecionado:', selectedSupplier);

            // Obter o valor da unidade de medida do dropdown customizado
            const itemUnitSelect = document.getElementById('itemUnit');
            const unitSelectButton = itemUnitSelect.querySelector('button');
            const selectedUnit = unitSelectButton ? unitSelectButton.getAttribute('data-selected') : '';
            formData.set('itemUnit', selectedUnit);
            console.log('DEBUG - Unidade de medida selecionada:', selectedUnit);
            
            // Debug completo do FormData
            console.log('DEBUG - FormData completo:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
                
                fetch('/api/itens_estoque', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    const statusCode = response.status;
                    return response.json().then(data => ({ data, statusCode }));
                })
                .then(({ data, statusCode }) => {
                    if (data.status === 'success') {
                        showNotification('success', data.message);
                        closeItemModal();
                        carregarListaEstoque();
                    } else {
                        const errorCode = statusCode || 'API_ERROR';
                        showNotification('error', data.message, errorCode);
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar item:', error);
                    showNotification('error', 'Erro ao salvar item: ' + error.message, 'NETWORK_ERROR');
                })
                .finally(() => {
                    // Re-enable the submit button regardless of success/failure
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.style.opacity = '1';
                        submitButton.style.cursor = 'pointer';
                    }
                });
            }
        });
    }
    
    // Entrada estoque form submission
    const entradaEstoqueForm = document.getElementById('entradaEstoqueForm');
    if (entradaEstoqueForm) {
        entradaEstoqueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedItem = document.querySelector('#material > button').getAttribute('data-selected');
            if (!selectedItem) {
                showNotification('error', 'Selecione um material', 'VALIDATION_ERROR');
                return;
            }
            
            const formData = new FormData(this);
            formData.append('itemId', selectedItem);
            
            // Obter o fornecedor selecionado do dropdown customizado
            const selectedFornecedor = document.querySelector('#fornecedor > button').getAttribute('data-selected');
            if (selectedFornecedor) {
                formData.append('fornecedor', selectedFornecedor);
            }
            
            fetch('/api/entradas_estoque', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const statusCode = response.status;
                return response.json().then(data => ({ data, statusCode }));
            })
            .then(({ data, statusCode }) => {
                if (data.status === 'success') {
                    showNotification('success', data.message);
                    closeEntradaEstoqueModal();
                    carregarListaEstoque();
                } else {
                    const errorCode = statusCode || 'API_ERROR';
                    showNotification('error', data.message, errorCode);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showNotification('error', 'Erro ao registrar entrada', 'EXCEPTION');
            });
        });
    }
    
    // Saida estoque form submission
    const saidaEstoqueForm = document.getElementById('saidaEstoqueForm');
    if (saidaEstoqueForm) {
        saidaEstoqueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedItem = document.querySelector('#materialSaida > button').getAttribute('data-selected');
            if (!selectedItem) {
                showNotification('error', 'Selecione um material', 'VALIDATION_ERROR');
                return;
            }
            
            const selectedMotivo = document.querySelector('#motivoSaida > button').textContent;
            if (selectedMotivo === 'Selecione o Motivo') {
                showNotification('error', 'Selecione o motivo da saída', 'VALIDATION_ERROR');
                return;
            }
            
            const formData = new FormData(this);
            formData.append('itemId', selectedItem);
            formData.append('motivoSaida', selectedMotivo);
            
            fetch('/api/saidas_estoque', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const statusCode = response.status;
                return response.json().then(data => ({ data, statusCode }));
            })
            .then(({ data, statusCode }) => {
                if (data.status === 'success') {
                    showNotification('success', data.message);
                    closeSaidaEstoqueModal();
                    carregarListaEstoque();
                } else {
                    const errorCode = statusCode || 'API_ERROR';
                    showNotification('error', data.message, errorCode);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showNotification('error', 'Erro ao registrar saída', 'EXCEPTION');
            });
        });
    }
    
    // Setup dropdown functionality for motivo saida
    document.querySelectorAll('#motivoSaida > div > div').forEach(option => {
        option.onclick = function() {
            document.querySelector('#motivoSaida > button').textContent = this.textContent;
        };
    });
    
    // Formulário de edição de item
    const editItemForm = document.getElementById('editItemForm');
    if (editItemForm) {
        editItemForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disable submit button to prevent double submission
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.style.opacity = '0.5';
                submitButton.style.cursor = 'not-allowed';
            }
            
            const itemId = document.getElementById('editItemId').value;
            const formData = new FormData(this);
            
            // Get values from inputs
            const largura = document.getElementById('editItemLargura').value;
            const comprimento = document.getElementById('editItemComprimento').value;
            const espessura = document.getElementById('editItemEspessura').value;
            const volume = document.getElementById('editItemVolume').value;
            const peso = document.getElementById('editItemPeso').value;
            const fabricante = document.getElementById('editItemFabricante').value;
            
            // Add the new fields to formData
            formData.set('itemLargura', largura);
            formData.set('itemComprimento', comprimento);
            formData.set('itemEspessura', espessura);
            formData.set('itemVolume', volume);
            formData.set('itemPeso', peso);
            formData.set('itemFabricante', fabricante);

            // Obter o valor da categoria do dropdown customizado
            const editItemCategorySelect = document.getElementById('editItemCategory');
            const categorySelectButton = editItemCategorySelect.querySelector('button');
            const selectedCategory = categorySelectButton ? categorySelectButton.getAttribute('data-selected') : '';
            formData.set('itemCategory', selectedCategory);
            console.log('DEBUG EDIT - Categoria selecionada:', selectedCategory);
            
            // Obter o valor do fornecedor do dropdown customizado
            const editItemSupplierSelect = document.getElementById('editItemSupplier');
            const supplierSelectButton = editItemSupplierSelect.querySelector('button');
            const selectedSupplier = supplierSelectButton ? supplierSelectButton.getAttribute('data-selected') : '';
            formData.set('itemSupplier', selectedSupplier);
            console.log('DEBUG EDIT - Fornecedor selecionado:', selectedSupplier);

            // Obter o valor da unidade de medida do dropdown customizado
            const editItemUnitSelect = document.getElementById('editItemUnit');
            const unitSelectButton = editItemUnitSelect.querySelector('button');
            const selectedUnit = unitSelectButton ? unitSelectButton.getAttribute('data-selected') : '';
            formData.set('itemUnit', selectedUnit);
            console.log('DEBUG EDIT - Unidade de medida selecionada:', selectedUnit);
            
            // Debug completo do FormData
            console.log('DEBUG EDIT - FormData completo:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            try {
                const response = await fetch(`/api/itens_estoque/${itemId}`, {
                    method: 'PUT',
                    body: formData
                }).finally(() => {
                    // Re-enable the submit button regardless of success/failure
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.style.opacity = '1';
                        submitButton.style.cursor = 'pointer';
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('success', 'Item atualizado com sucesso!');
                    closeEditItemModal();
                    carregarListaEstoque();
                } else {
                    const errorCode = response.status || 'API_ERROR';
                    showNotification('error', `Erro ao atualizar item: ${result.message}`, errorCode);
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('error', 'Erro ao atualizar item. Por favor, tente novamente.', 'EXCEPTION');
            }
        });
    }
}

// Adicionar o evento de submit para o formulário de edição
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa os scripts quando o documento é carregado diretamente
    initializeEstoqueScripts();

    // Fechar modais ao clicar fora
    window.onclick = function(event) {
        const itemModal = document.getElementById('itemModal');
        const editItemModal = document.getElementById('editItemModal');
        const entradaEstoqueModal = document.getElementById('entradaEstoqueModal');
        const saidaEstoqueModal = document.getElementById('saidaEstoqueModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const notificationModal = document.getElementById('notificationModal');
        const materialSelectionModal = document.getElementById('materialSelectionModal');
        const categoriaSelectionModal = document.getElementById('categoriaSelectionModal');
        const tipoItemSelectionModal = document.getElementById('tipoItemSelectionModal');
        const unidadeSelectionModal = document.getElementById('unidadeSelectionModal');
        const fornecedorSelectionModal = document.getElementById('fornecedorSelectionModal');
        const novaCategoriaModal = document.getElementById('novaCategoriaModal');
        const novoTipoItemModal = document.getElementById('novoTipoItemModal');
        const novaUnidadeModal = document.getElementById('novaUnidadeModal');
        const novoFornecedorModal = document.getElementById('novoFornecedorModal');
        
        if (event.target == itemModal) {
            closeItemModal();
        } else if (event.target == editItemModal) {
            closeEditItemModal();
        } else if (event.target == entradaEstoqueModal) {
            closeEntradaEstoqueModal();
        } else if (event.target == saidaEstoqueModal) {
            closeSaidaEstoqueModal();
        } else if (event.target == confirmationModal) {
            closeConfirmationModal();
        } else if (event.target == notificationModal) {
            closeNotificationModal();
        } else if (event.target == materialSelectionModal) {
            closeMaterialSelectionModal();
        } else if (event.target == categoriaSelectionModal) {
            closeCategoriaSelectionModal();
        } else if (event.target == tipoItemSelectionModal) {
            closeTipoItemSelectionModal();
        } else if (event.target == unidadeSelectionModal) {
            closeUnidadeSelectionModal();
        } else if (event.target == fornecedorSelectionModal) {
            closeFornecedorSelectionModal();
        } else if (event.target == novaCategoriaModal) {
            closeNovaCategoriaModal();
        } else if (event.target == novoTipoItemModal) {
            closeNovoTipoItemModal();
        } else if (event.target == novaUnidadeModal) {
            closeNovaUnidadeModal();
        } else if (event.target == novoFornecedorModal) {
            closeNovoFornecedorModal();
        }
    };
});

// Função para buscar endereço pelo CEP
async function buscarEnderecoPorCEP(cep) {
    if (cep.length === 8 || cep.length === 9) { // Verifica se o CEP tem 8 dígitos ou 9 com hífen
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep.replace('-', '')}/json/`);
            const data = await response.json();
            if (!data.erro) {
                document.getElementById('fornecedorEndereco').value = data.logradouro;
                document.getElementById('fornecedorCidade').value = data.localidade;
                document.getElementById('fornecedorEstado').value = data.uf;
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
        }
    }
}

// Funções para o modal de seleção de materiais
function openMaterialSelectionModal() {
    document.getElementById('materialSelectionModal').style.display = 'block';
    carregarMateriaisParaSelecao();
}

function closeMaterialSelectionModal() {
    document.getElementById('materialSelectionModal').style.display = 'none';
    document.getElementById('materialSearchInput').value = '';
}

function carregarMateriaisParaSelecao() {
    fetch('/api/itens_estoque/completo')
        .then(response => response.json())
        .then(data => {
            console.log('Dados recebidos para seleção de materiais:', data); // Debug
            
            if (data.status === 'success') {
                const container = document.getElementById('materialsListContent');
                container.innerHTML = '';
                
                // Filtrar apenas itens que NÃO são unidades fracionadas
                const itensFiltrados = data.items.filter(item => {
                    const tipoItem = (item.tipo_item || '').toLowerCase();
                    const nome = (item.nome || '').toLowerCase();
                    
                    // Excluir se for "unidade fracionada" ou se o nome contém "(unidades)"
                    return !tipoItem.includes('unidade fracionada') && 
                           !nome.includes('(unidades)');
                });
                
                if (itensFiltrados.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum material cadastrado.</div>';
                    return;
                }
                
                itensFiltrados.forEach(item => {
                    console.log('Item individual:', item); // Debug para ver estrutura dos dados
                    
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 0.8fr 2fr 1fr 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); align-items: center; transition: all 0.3s ease; cursor: pointer; border-radius: 4px;';
                    row.className = 'material-row';
                    
                    // Usar os campos corretos da API
                    const categoria = item.categoria || '-';
                    const estoqueAtual = item.quantidade_atual !== undefined ? item.quantidade_atual : 0;
                    
                    row.innerHTML = `
                        <div>${item.codigo}</div>
                        <div>${item.nome}</div>
                        <div>${categoria}</div>
                        <div>${estoqueAtual}</div>
                    `;
                    
                    // Adicionar eventos de hover e clique na linha inteira
                    row.addEventListener('mouseover', function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                    });
                    
                    row.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    // Permitir seleção clicando na linha inteira
                    row.addEventListener('click', function() {
                        selecionarMaterial(item.id, item.codigo, item.nome);
                    });
                    
                    container.appendChild(row);
                });
            } else {
                console.error('Erro ao carregar materiais:', data.message);
                document.getElementById('materialsListContent').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar materiais.</div>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            document.getElementById('materialsListContent').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar materiais.</div>';
        });
}

function selecionarMaterial(id, codigo, nome) {
    // Atualizar o dropdown de material no modal de entrada de estoque
    const materialButton = document.querySelector('#material > button');
    const materialText = `${codigo} - ${nome}`;
    
    materialButton.textContent = materialText;
    materialButton.setAttribute('data-selected', id);
    
    // Fechar o modal de seleção
    closeMaterialSelectionModal();
    
    // Mostrar feedback visual
    showNotification('success', `Material "${materialText}" selecionado!`);
}

function filtrarMateriais() {
    const searchText = document.getElementById('materialSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.material-row');
    
    rows.forEach(row => {
        const codigo = row.children[0].textContent.toLowerCase();
        const nome = row.children[1].textContent.toLowerCase();
        const categoria = row.children[2].textContent.toLowerCase();
        
        if (codigo.includes(searchText) || nome.includes(searchText) || categoria.includes(searchText)) {
            row.style.display = 'grid';
        } else {
            row.style.display = 'none';
        }
    });
}

// Funções para o modal de seleção de fornecedores
function openFornecedorSelectionModal() {
    console.log('Abrindo modal de seleção de fornecedores...');
    document.getElementById('fornecedorSelectionModal').style.display = 'block';
    carregarFornecedoresParaSelecao();
}

function closeFornecedorSelectionModal() {
    document.getElementById('fornecedorSelectionModal').style.display = 'none';
    document.getElementById('fornecedorSearchInput').value = '';
}

function carregarFornecedoresParaSelecao() {
    fetch('/api/fornecedores')
        .then(response => response.json())
        .then(data => {
            console.log('Dados recebidos para seleção de fornecedores:', data); // Debug
            
            const container = document.getElementById('fornecedoresListContent');
            container.innerHTML = '';
            
            // Verifica se o resultado é um array (resposta direta da API) ou tem a estrutura antiga
            const fornecedores = Array.isArray(data) ? data : 
                               (data.status === 'success' && data.fornecedores ? data.fornecedores : []);
            
            if (fornecedores.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum fornecedor cadastrado.</div>';
                return;
            }
            
            fornecedores.forEach(fornecedor => {
                console.log('Fornecedor individual:', fornecedor); // Debug para ver estrutura dos dados
                
                const row = document.createElement('div');
                row.style.cssText = 'display: grid; grid-template-columns: 2fr 1.5fr 1.5fr; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); align-items: center; transition: all 0.3s ease; cursor: pointer; border-radius: 4px;';
                row.className = 'fornecedor-row';
                
                // Usar os campos corretos da API
                const cidade = fornecedor.cidade || '-';
                const cpfCnpj = fornecedor.cnpj || fornecedor.cpf || '-';
                
                row.innerHTML = `
                    <div>${fornecedor.nome}</div>
                    <div>${cidade}</div>
                    <div>${cpfCnpj}</div>
                `;
                
                // Adicionar eventos de hover e clique na linha inteira
                row.addEventListener('mouseover', function() {
                    this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                });
                
                row.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '';
                });
                
                // Permitir seleção clicando na linha inteira
                row.addEventListener('click', function() {
                    selecionarFornecedor(fornecedor.id, fornecedor.nome);
                });
                
                container.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            document.getElementById('fornecedoresListContent').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar fornecedores.</div>';
        });
}

function selecionarFornecedor(id, nome) {
    // Determinar qual dropdown atualizar baseado no contexto
    let targetDropdown = null;
    
    // Verificar qual modal está aberto
    if (document.getElementById('entradaEstoqueModal').style.display !== 'none' && 
        document.getElementById('entradaEstoqueModal').style.display !== '') {
        // Modal de entrada de estoque está aberto
        targetDropdown = document.querySelector('#fornecedor > button');
    } else if (document.getElementById('itemModal').style.display === 'block') {
        // Modal de cadastro de item está aberto
        targetDropdown = document.querySelector('#itemSupplier > button');
    } else if (document.getElementById('editItemModal').style.display === 'block') {
        // Modal de edição de item está aberto
        targetDropdown = document.querySelector('#editItemSupplier > button');
    }
    
    if (targetDropdown) {
        targetDropdown.textContent = nome;
        targetDropdown.setAttribute('data-selected', id);
    }
    
    // Fechar o modal de seleção
    closeFornecedorSelectionModal();
    
    // Mostrar feedback visual
    showNotification('success', `Fornecedor "${nome}" selecionado!`);
}

function filtrarFornecedores() {
    const searchText = document.getElementById('fornecedorSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.fornecedor-row');
    
    rows.forEach(row => {
        const nome = row.children[0].textContent.toLowerCase();
        const cidade = row.children[1].textContent.toLowerCase();
        const cpfCnpj = row.children[2].textContent.toLowerCase();
        
        if (nome.includes(searchText) || cidade.includes(searchText) || cpfCnpj.includes(searchText)) {
            row.style.display = 'grid';
        } else {
            row.style.display = 'none';
        }
    });
}

// Funções para o modal de seleção de materiais para saída de estoque
function openMaterialSelectionModalSaida() {
    document.getElementById('materialSelectionModal').style.display = 'block';
    carregarMateriaisParaSelecaoSaida();
}

function carregarMateriaisParaSelecaoSaida() {
    fetch('/api/itens_estoque/completo')
        .then(response => response.json())
        .then(data => {
            console.log('Dados recebidos para seleção de materiais (saída):', data); // Debug
            
            if (data.status === 'success') {
                const container = document.getElementById('materialsListContent');
                container.innerHTML = '';
                
                if (data.items.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum material cadastrado.</div>';
                    return;
                }
                
                data.items.forEach(item => {
                    console.log('Item individual:', item); // Debug para ver estrutura dos dados
                    
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 0.8fr 2fr 1fr 1fr; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); align-items: center; transition: all 0.3s ease; cursor: pointer; border-radius: 4px;';
                    row.className = 'material-row';
                    
                    // Usar os campos corretos da API
                    const categoria = item.categoria || '-';
                    const estoqueAtual = item.quantidade_atual !== undefined ? item.quantidade_atual : 0;
                    
                    row.innerHTML = `
                        <div>${item.codigo}</div>
                        <div>${item.nome}</div>
                        <div>${categoria}</div>
                        <div>${estoqueAtual}</div>
                    `;
                    
                    // Adicionar eventos de hover e clique na linha inteira
                    row.addEventListener('mouseover', function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                    });
                    
                    row.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    // Permitir seleção clicando na linha inteira
                    row.addEventListener('click', function() {
                        selecionarMaterialSaida(item.id, item.codigo, item.nome);
                    });
                    
                    container.appendChild(row);
                });
            } else {
                console.error('Erro ao carregar materiais:', data.message);
                document.getElementById('materialsListContent').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar materiais.</div>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            document.getElementById('materialsListContent').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar materiais.</div>';
        });
}

function selecionarMaterialSaida(id, codigo, nome) {
    // Atualizar o dropdown de material no modal de saída de estoque
    const materialButton = document.querySelector('#materialSaida > button');
    const materialText = `${codigo} - ${nome}`;
    
    materialButton.textContent = materialText;
    materialButton.setAttribute('data-selected', id);
    
    // Fechar o modal de seleção
    closeMaterialSelectionModal();
    
    // Mostrar feedback visual
    showNotification('success', `Material "${materialText}" selecionado para saída!`);
}

// Funções para o modal de seleção de categorias
function openCategoriaSelectionModal() {
    document.getElementById('categoriaSelectionModal').style.display = 'block';
    carregarCategoriasParaSelecao();
}

function closeCategoriaSelectionModal() {
    document.getElementById('categoriaSelectionModal').style.display = 'none';
    document.getElementById('categoriaSearchInput').value = '';
}

function carregarCategoriasParaSelecao() {
    fetch('/api/categorias')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('categoriasListContent');
            container.innerHTML = '';
            
            if (data.status === 'success' && data.categorias) {
                if (data.categorias.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhuma categoria cadastrada.</div>';
                    return;
                }
                
                data.categorias.forEach(categoria => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 1fr; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); align-items: center; transition: all 0.3s ease; cursor: pointer; border-radius: 4px;';
                    row.className = 'categoria-row';
                    
                    row.innerHTML = `<div>${categoria.nome}</div>`;
                    
                    row.addEventListener('mouseover', function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                    });
                    
                    row.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    row.addEventListener('click', function() {
                        selecionarCategoria(categoria.id, categoria.nome);
                    });
                    
                    container.appendChild(row);
                });
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar categorias.</div>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            document.getElementById('categoriasListContent').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar categorias.</div>';
        });
}

function selecionarCategoria(id, nome) {
    // Determinar qual dropdown atualizar baseado no contexto
    let targetDropdown = null;
    
    // Verificar qual modal está aberto
    if (document.getElementById('itemModal').style.display === 'block') {
        targetDropdown = document.querySelector('#itemCategory > button');
    } else if (document.getElementById('editItemModal').style.display === 'block') {
        targetDropdown = document.querySelector('#editItemCategory > button');
    }
    
    if (targetDropdown) {
        targetDropdown.textContent = nome;
        targetDropdown.setAttribute('data-selected', id);
    }
    
    closeCategoriaSelectionModal();
    showNotification('success', `Categoria "${nome}" selecionada!`);
}

function filtrarCategorias() {
    const searchText = document.getElementById('categoriaSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.categoria-row');
    
    rows.forEach(row => {
        const nome = row.children[0].textContent.toLowerCase();
        
        if (nome.includes(searchText)) {
            row.style.display = 'grid';
        } else {
            row.style.display = 'none';
        }
    });
}

// Funções para o modal de seleção de tipos de item
function openTipoItemSelectionModal() {
    document.getElementById('tipoItemSelectionModal').style.display = 'block';
    carregarTiposItemParaSelecao();
}

function closeTipoItemSelectionModal() {
    document.getElementById('tipoItemSelectionModal').style.display = 'none';
    document.getElementById('tipoItemSearchInput').value = '';
}

function carregarTiposItemParaSelecao() {
    fetch('/api/tipo_itens')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('tiposItemListContent');
            container.innerHTML = '';
            
            if (data.status === 'success' && data.tipos) {
                if (data.tipos.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum tipo cadastrado.</div>';
                    return;
                }
                
                data.tipos.forEach(tipo => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 1.5fr 2fr; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); align-items: center; transition: all 0.3s ease; cursor: pointer; border-radius: 4px;';
                    row.className = 'tipo-item-row';
                    
                    row.innerHTML = `
                        <div>${tipo.nome}</div>
                        <div>${tipo.descricao || '-'}</div>
                    `;
                    
                    row.addEventListener('mouseover', function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                    });
                    
                    row.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    row.addEventListener('click', function() {
                        selecionarCategoria(categoria.id, categoria.nome);
                    });
                    
                    container.appendChild(row);
                });
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar tipos.</div>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            document.getElementById('tiposItemListContent').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar tipos.</div>';
        });
}

function selecionarTipoItem(id, nome) {
    // Determinar qual dropdown atualizar baseado no contexto
    let targetDropdown = null;
    let selectId = null;
    
    // Verificar qual modal está aberto
    if (document.getElementById('itemModal').style.display === 'block') {
        targetDropdown = document.querySelector('#itemTipoItem > button');
        selectId = 'itemTipoItem';
    } else if (document.getElementById('editItemModal').style.display === 'block') {
        targetDropdown = document.querySelector('#editItemTipoItem > button');
        selectId = 'editItemTipoItem';
    }
    
    if (targetDropdown) {
        targetDropdown.textContent = nome;
        targetDropdown.setAttribute('data-selected', id);
        
        // Verificar se deve habilitar/desabilitar o campo unidades após a seleção
        if (selectId) {
            verificarTipoItem(selectId);
        }
    }
    
    closeTipoItemSelectionModal();
    showNotification('success', `Tipo "${nome}" selecionado!`);
}

function filtrarTiposItem() {
    const searchText = document.getElementById('tipoItemSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.tipo-item-row');
    
    rows.forEach(row => {
        const nome = row.children[0].textContent.toLowerCase();
        const descricao = row.children[1].textContent.toLowerCase();
        
        if (nome.includes(searchText) || descricao.includes(searchText)) {
            row.style.display = 'grid';
        } else {
            row.style.display = 'none';
        }
    });
}

// Funções para o modal de seleção de unidades de medida
function openUnidadeSelectionModal() {
    document.getElementById('unidadeSelectionModal').style.display = 'block';
    carregarUnidadesParaSelecao();
}

function closeUnidadeSelectionModal() {
    document.getElementById('unidadeSelectionModal').style.display = 'none';
    document.getElementById('unidadeSearchInput').value = '';
}

function carregarUnidadesParaSelecao() {
    fetch('/api/unidades_de_medida')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('unidadesListContent');
            container.innerHTML = '';
            
            if (data.unidades) {
                if (data.unidades.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhuma unidade cadastrada.</div>';
                    return;
                }
                
                data.unidades.forEach(unidade => {
                    const row = document.createElement('div');
                    row.style.cssText = 'display: grid; grid-template-columns: 1fr; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); align-items: center; transition: all 0.3s ease; cursor: pointer; border-radius: 4px;';
                    row.className = 'unidade-row';
                    
                    row.innerHTML = `<div>${unidade.nome}</div>`;
                    
                    row.addEventListener('mouseover', function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                    });
                    
                    row.addEventListener('mouseout', function() {
                        this.style.backgroundColor = '';
                    });
                    
                    row.addEventListener('click', function() {
                        selecionarUnidade(unidade.id, unidade.nome);
                    });
                    
                    container.appendChild(row);
                });
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar unidades.</div>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            document.getElementById('unidadesListContent').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: red;">Erro ao carregar unidades.</div>';
        });
}

function selecionarUnidade(id, nome) {
    // Determinar qual dropdown atualizar baseado no contexto
    let targetDropdown = null;
    let selectId = null;
    
    // Verificar qual modal está aberto
    if (document.getElementById('itemModal').style.display === 'block') {
        targetDropdown = document.querySelector('#itemUnit > button');
        selectId = 'itemUnit';
    } else if (document.getElementById('editItemModal').style.display === 'block') {
        targetDropdown = document.querySelector('#editItemUnit > button');
        selectId = 'editItemUnit';
    }
    
    if (targetDropdown) {
        targetDropdown.textContent = nome;
        targetDropdown.setAttribute('data-selected', id);
        
        // Verificar se deve habilitar/desabilitar campos de dimensão após a seleção
        if (selectId) {
            // Buscar informações da unidade para verificar se é de medida
            fetch(`/api/unidades_de_medida/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.unidade) {
                        const isMeasurement = data.unidade.is_measurement ? '1' : '0';
                        targetDropdown.setAttribute('data-is-measurement', isMeasurement);
                        verificarUnidadeMedida(selectId);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar informações da unidade:', error);
                });
        }
    }
    
    closeUnidadeSelectionModal();
    showNotification('success', `Unidade "${nome}" selecionada!`);
}

function filtrarUnidades() {
    const searchText = document.getElementById('unidadeSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.unidade-row');
    
    rows.forEach(row => {
        const nome = row.children[0].textContent.toLowerCase();
        
        if (nome.includes(searchText)) {
            row.style.display = 'grid';
        } else {
            row.style.display = 'none';
        }
    });
}

// Função para converter automaticamente mm para cm nos campos de largura e comprimento
function convertDimensionInput(input) {
    let value = input.value.trim();
    
    // Verifica se o valor termina com "mm" (case insensitive)
    if (value.toLowerCase().endsWith('mm')) {
        // Remove "mm" e converte para número
        let mmValue = parseFloat(value.slice(0, -2));
        if (!isNaN(mmValue)) {
            // Converte de mm para cm (divide por 10)
            let cmValue = (mmValue / 10).toFixed(2);
            input.value = cmValue;
            
            // Mostrar feedback visual temporário
            input.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
            setTimeout(() => {
                input.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            }, 1000);
        }
    }
}

// Função para formatar área de forma mais legível
function formatArea(areaM2) {
    if (areaM2 === 0) {
        return '0 m²';
    } else if (areaM2 >= 1) {
        // Para áreas >= 1m², mostra no máximo 2 casas decimais
        return parseFloat(areaM2.toFixed(2)) + ' m²';
    } else {
        // Para áreas < 1m², mostra no máximo 4 casas decimais
        return parseFloat(areaM2.toFixed(4)) + ' m²';
    }
}

// Função para calcular a área automaticamente (modal de inclusão)
function calculateArea() {
    const largura = parseFloat(document.getElementById('itemLargura').value) || 0;
    const comprimento = parseFloat(document.getElementById('itemComprimento').value) || 0;
    
    // Calcular área em cm² e converter para m²
    const areaCm2 = largura * comprimento;
    const areaM2 = areaCm2 / 10000; // Converte cm² para m²
    
    const displayElement = document.getElementById('itemAreaDisplay');
    if (displayElement) {
        displayElement.textContent = formatArea(areaM2);
        
        // Destaque visual quando há mudança
        if (areaM2 > 0) {
            displayElement.style.color = '#4CAF50';
            displayElement.style.fontWeight = 'bold';
        } else {
            displayElement.style.color = '#9B64E3';
            displayElement.style.fontWeight = 'normal';
        }
    }
}

// Função para calcular a área automaticamente (modal de edição)
function calculateAreaEdit() {
    const largura = parseFloat(document.getElementById('editItemLargura').value) || 0;
    const comprimento = parseFloat(document.getElementById('editItemComprimento').value) || 0;
    
    // Calcular área em cm² e converter para m²
    const areaCm2 = largura * comprimento;
    const areaM2 = areaCm2 / 10000; // Converte cm² para m²
    
    const displayElement = document.getElementById('editItemAreaDisplay');
    if (displayElement) {
        displayElement.textContent = formatArea(areaM2);
        
        // Destaque visual quando há mudança
        if (areaM2 > 0) {
            displayElement.style.color = '#4CAF50';
            displayElement.style.fontWeight = 'bold';
        } else {
            displayElement.style.color = '#9B64E3';
            displayElement.style.fontWeight = 'normal';
        }
    }
}

// Função para fracionar pacote
function fracionarPacote(id) {
    console.log('DEBUG - Iniciando fracionamento do pacote ID:', id);
    
    // Primeiro, buscar os dados do item para obter informações sobre o pacote
    fetch(`/api/itens_estoque/${id}`)
        .then(response => response.json())
        .then(result => {
            console.log('DEBUG - Resposta da API:', result);
            
            if (result.status === 'error') {
                throw new Error(result.message || 'Erro ao carregar dados do item');
            }
            
            const item = result.item;
            console.log('DEBUG - Dados do item:', item);
            
            // Verificar múltiplas formas de identificar um pacote fechado
            const isPacoteFechado = 
                (item.tipo_item && item.tipo_item.toLowerCase().includes('pacote fechado')) ||
                (item.tipo_item_nome && item.tipo_item_nome.toLowerCase().includes('pacote fechado')) ||
                (item.tipo_item && item.tipo_item.toLowerCase().includes('pacote')) ||
                (item.tipo_item_nome && item.tipo_item_nome.toLowerCase().includes('pacote'));
            
            console.log('DEBUG - Verificação tipo pacote:');
            console.log('  item.tipo_item:', item.tipo_item);
            console.log('  item.tipo_item_nome:', item.tipo_item_nome);
            console.log('  isPacoteFechado:', isPacoteFechado);
            
            if (!isPacoteFechado) {
                showNotification('error', 'Este item não é um pacote fechado.');
                return;
            }
            
            // Verificar se tem unidades por pacote definidas
            const unidadesPorPacote = item.unidades_por_pacote || 1;
            console.log('DEBUG - Unidades por pacote:', unidadesPorPacote);
            
            if (unidadesPorPacote <= 1) {
                showNotification('error', 'Este pacote não tem unidades por pacote definidas ou já está fracionado.');
                return;
            }
            
            // Verificar se há estoque suficiente
            const quantidadeAtual = item.quantidade_atual || 0;
            console.log('DEBUG - Quantidade atual:', quantidadeAtual);
            
            if (quantidadeAtual < 1) {
                showNotification('error', 'Não há estoque suficiente para fracionar este pacote.');
                return;
            }
            
            // Mostrar modal personalizado para seleção da quantidade de pacotes
            showFracionarPacoteModal(item, id);
        })
        .catch(error => {
            console.error('Erro ao carregar dados do item:', error);
            showNotification('error', 'Erro ao carregar dados do item. Por favor, tente novamente.');
        });
}

// Função para fracionar frasco/garrafa
function fracionarFrascoGarrafa(id) {
    console.log('DEBUG - Iniciando fracionamento do frasco/garrafa ID:', id);
    
    // Primeiro, buscar os dados do item para obter informações sobre o frasco/garrafa
    fetch(`/api/itens_estoque/${id}`)
        .then(response => response.json())
        .then(result => {
            console.log('DEBUG - Resposta da API:', result);
            
            if (result.status === 'error') {
                throw new Error(result.message || 'Erro ao carregar dados do item');
            }
            
            const item = result.item;
            console.log('DEBUG - Dados do item:', item);
            
            // Verificar múltiplas formas de identificar um frasco ou garrafa
            const isFrascoGarrafa = 
                (item.tipo_item && (item.tipo_item.toLowerCase().includes('frasco') || item.tipo_item.toLowerCase().includes('garrafa'))) ||
                (item.tipo_item_nome && (item.tipo_item_nome.toLowerCase().includes('frasco') || item.tipo_item_nome.toLowerCase().includes('garrafa'))) ||
                (item.nome && (item.nome.toLowerCase().includes('frasco') || item.nome.toLowerCase().includes('garrafa')));
            
            console.log('DEBUG - Verificação tipo frasco/garrafa:');
            console.log('  item.tipo_item:', item.tipo_item);
            console.log('  item.tipo_item_nome:', item.tipo_item_nome);
            console.log('  item.nome:', item.nome);
            console.log('  isFrascoGarrafa:', isFrascoGarrafa);
            
            if (!isFrascoGarrafa) {
                showNotification('error', 'Este item não é um frasco ou garrafa.');
                return;
            }
            
            // Verificar se tem volume definido
            const volume = parseFloat(item.volume) || 0;
            console.log('DEBUG - Volume:', volume);
            
            if (volume <= 0) {
                showNotification('error', 'Este item não tem volume definido ou é inválido para fracionamento.');
                return;
            }
            
            // Verificar se há estoque suficiente
            const quantidadeAtual = item.quantidade_atual || 0;
            console.log('DEBUG - Quantidade atual:', quantidadeAtual);
            
            if (quantidadeAtual < 1) {
                showNotification('error', 'Não há estoque suficiente para fracionar este item.');
                return;
            }
            
            // Mostrar modal personalizado para seleção da quantidade e volume
            showFracionarFrascoGarrafaModal(item, id);
        })
        .catch(error => {
            console.error('Erro ao carregar dados do item:', error);
            showNotification('error', 'Erro ao carregar dados do item. Por favor, tente novamente.');
        });
}

// Função para fracionar embalagem por peso
function fracionarEmbalagem(id) {
    console.log('DEBUG - Iniciando fracionamento da embalagem ID:', id);
    
    // Primeiro, buscar os dados do item para obter informações sobre a embalagem
    fetch(`/api/itens_estoque/${id}`)
        .then(response => response.json())
        .then(result => {
            console.log('DEBUG - Resposta da API:', result);
            
            if (result.status === 'error') {
                throw new Error(result.message || 'Erro ao carregar dados do item');
            }
            
            const item = result.item;
            console.log('DEBUG - Dados do item:', item);
            
            // Verificar se é uma embalagem
            const isEmbalagem = 
                (item.tipo_item && item.tipo_item.toLowerCase().includes('embalagem')) ||
                (item.tipo_item_nome && item.tipo_item_nome.toLowerCase().includes('embalagem'));
            
            console.log('DEBUG - Verificação tipo embalagem:');
            console.log('  item.tipo_item:', item.tipo_item);
            console.log('  item.tipo_item_nome:', item.tipo_item_nome);
            console.log('  isEmbalagem:', isEmbalagem);
            
            if (!isEmbalagem) {
                showNotification('error', 'Este item não é uma embalagem.');
                return;
            }
            
            // Verificar se tem peso definido
            const peso = parseFloat(item.peso) || 0;
            console.log('DEBUG - Peso:', peso);
            
            if (peso <= 0) {
                showNotification('error', 'Este item não tem peso definido ou é inválido para fracionamento.');
                return;
            }
            
            // Verificar se há estoque suficiente
            const quantidadeAtual = item.quantidade_atual || 0;
            console.log('DEBUG - Quantidade atual:', quantidadeAtual);
            
            if (quantidadeAtual < 1) {
                showNotification('error', 'Não há estoque suficiente para fracionar este item.');
                return;
            }
            
            // Mostrar modal personalizado para seleção da quantidade e peso por porção
            showFracionarEmbalagemModal(item, id);
        })
        .catch(error => {
            console.error('Erro ao carregar dados do item:', error);
            showNotification('error', 'Erro ao carregar dados do item. Por favor, tente novamente.');
        });
}

// Função para mostrar modal de fracionamento de pacote
function showFracionarPacoteModal(item, itemId) {
    const modal = document.getElementById('fracionarPacoteModal');
    const nomeItem = document.getElementById('fracionarPacoteNome');
    const estoqueAtual = document.getElementById('fracionarPacoteEstoque');
    const unidadesPacote = document.getElementById('fracionarPacoteUnidades');
    const quantidadeInput = document.getElementById('quantidadePacotesFracionar');
    const totalUnidadesSpan = document.getElementById('totalUnidadesFracionamento');
    
    // Verificar se todos os elementos existem
    if (!modal || !nomeItem || !estoqueAtual || !unidadesPacote || !quantidadeInput || !totalUnidadesSpan) {
        console.error('Elementos do modal de fracionamento não encontrados');
        // Fallback para o método antigo
        const totalUnidades = item.quantidade_atual * item.unidades_por_pacote;
        const mensagem = `Fracionar TODOS os ${item.quantidade_atual} pacotes de "${item.nome}"?\n\n` +
                       `• Unidades por pacote: ${item.unidades_por_pacote}\n` +
                       `• Total de unidades: ${totalUnidades}`;
        
        if (confirm(mensagem)) {
            executarFracionamento(itemId, item.unidades_por_pacote, item.quantidade_atual, totalUnidades);
        }
        return;
    }
    
    // Preencher dados do modal
    nomeItem.textContent = item.nome;
    estoqueAtual.textContent = item.quantidade_atual;
    unidadesPacote.textContent = item.unidades_por_pacote;
    quantidadeInput.max = item.quantidade_atual;
    quantidadeInput.value = 1;
    
    // Calcular total inicial
    const totalInicial = 1 * item.unidades_por_pacote;
    totalUnidadesSpan.textContent = totalInicial;
    
    // Event listener para atualizar total quando quantidade mudar
    quantidadeInput.oninput = function() {
        const quantidade = parseInt(this.value) || 0;
        const total = quantidade * item.unidades_por_pacote;
        totalUnidadesSpan.textContent = total;
    };
    
    // Configurar botão de confirmação
    const confirmarBtn = document.getElementById('confirmarFracionamento');
    confirmarBtn.onclick = function() {
        const quantidadePacotes = parseInt(quantidadeInput.value) || 0;
        
        if (quantidadePacotes <= 0) {
            showNotification('error', 'Por favor, informe uma quantidade válida de pacotes.');
            return;
        }
        
        if (quantidadePacotes > item.quantidade_atual) {
            showNotification('error', `Quantidade não pode ser maior que o estoque atual (${item.quantidade_atual}).`);
            return;
        }
        
        const totalUnidades = quantidadePacotes * item.unidades_por_pacote;
        closeFracionarPacoteModal();
        
        // Mostrar confirmação final com contêineres organizados
        const svgPacote = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>');
        const svgUnidades = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 8l-4 4-4-4"/></svg>');
        const svgTotal = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="12" rx="2" ry="2"/><path d="M3 9h18"/><path d="M9 15h6"/></svg>');
        const svgAviso = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>');
        
        const mensagem = `
<div style="text-align: left; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <div style="margin-bottom: 20px; font-size: 16px; font-weight: bold; color: #9B64E3;">
        Confirma o fracionamento de ${quantidadePacotes} pacote(s) de "${item.nome}"?
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPacote}" alt="Pacotes" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Pacotes a fracionar: <strong style="color: #D8CEFE;">${quantidadePacotes}</strong></span>
        </div>
        
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgUnidades}" alt="Unidades" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Unidades por pacote: <strong style="color: #D8CEFE;">${item.unidades_por_pacote}</strong></span>
        </div>
        
        <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgTotal}" alt="Total" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Total de unidades: <strong style="color: #4CAF50;">${totalUnidades}</strong></span>
        </div>
    </div>
    
    <div style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: flex-start; gap: 10px;">
        <img src="${svgAviso}" alt="Aviso" style="width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px;">
        <span style="color: #FFC107; font-weight: 500;">Esta ação não pode ser desfeita.</span>
    </div>
</div>`;
        
        showConfirmationModal(mensagem, () => {
            executarFracionamento(itemId, item.unidades_por_pacote, quantidadePacotes, totalUnidades);
        });
    };
    
    // Mostrar modal
    modal.style.display = 'block';
}

// Função para mostrar modal de fracionamento de frasco/garrafa
function showFracionarFrascoGarrafaModal(item, itemId) {
    const modal = document.getElementById('fracionarFrascoGarrafaModal');
    const nomeItem = document.getElementById('fracionarFrascoNome');
    const estoqueAtual = document.getElementById('fracionarFrascoEstoque');
    const volumeItem = document.getElementById('fracionarFrascoVolume');
    const quantidadeInput = document.getElementById('quantidadeFrascosFracionar');
    const volumeInput = document.getElementById('volumeFracionamento');
    const volumeTotalSpan = document.getElementById('volumeTotalUtilizado');
    const totalPorcoesSpan = document.getElementById('totalPorcoesFracionamento');
    
    // Verificar se todos os elementos existem
    if (!modal || !nomeItem || !estoqueAtual || !volumeItem || !quantidadeInput || !volumeInput || !volumeTotalSpan || !totalPorcoesSpan) {
        console.error('Elementos do modal de fracionamento de frasco/garrafa não encontrados');
        // Fallback para o método antigo
        const volumePorUnidade = parseFloat(item.volume) || 0;
        const volumeTotal = item.quantidade_atual * volumePorUnidade;
        const mensagem = `Fracionar TODOS os ${item.quantidade_atual} recipientes de "${item.nome}"?\n\n` +
                       `• Volume por recipiente: ${volumePorUnidade}L\n` +
                       `• Volume total disponível: ${volumeTotal}L`;
        
        if (confirm(mensagem)) {
            executarFracionamentoVolume(itemId, volumePorUnidade, item.quantidade_atual, 0.1); // Volume padrão de 0.1L por porção
        }
        return;
    }
    
    // Preencher dados do modal
    nomeItem.textContent = item.nome;
    estoqueAtual.textContent = item.quantidade_atual;
    volumeItem.textContent = parseFloat(item.volume || 0).toFixed(3);
    quantidadeInput.max = item.quantidade_atual;
    quantidadeInput.value = 1;
    volumeInput.value = 0.1; // Volume padrão de 100ml
    
                    // Função para formatar números removendo zeros desnecessários
                    const formatarNumero = (valor) => {
                        if (valor === null || valor === undefined || isNaN(valor)) return '0';
                        // Converter para número com precisão máxima de 3 casas decimais
                        const numero = parseFloat(valor);
                        // Se for um número inteiro, retorna sem casas decimais
                        if (numero % 1 === 0) {
                            return numero.toString();
                        }
                        // Se tiver casas decimais, formata com até 3 casas e remove zeros à direita
                        return numero.toFixed(3).replace(/\.?0+$/, '');
                    };
                    
                    // Função para calcular valores
                    const calcularValores = () => {
                        const quantidade = parseInt(quantidadeInput.value) || 0;
                        const volumePorPorcao = parseFloat(volumeInput.value) || 0;
                        const volumePorUnidade = parseFloat(item.volume) || 0;
                        
                        // Corrigir a lógica: só criamos 1 porção por cada volume especificado
                        // O volume utilizado é igual ao volume por porção (não o volume total do recipiente)
                        const totalPorcoes = quantidade; // 1 porção por recipiente fracionado
                        const volumeUtilizado = totalPorcoes * volumePorPorcao;
                        
                        // Formatação mais clara dos resultados
                        volumeTotalSpan.textContent = formatarNumero(volumeUtilizado);
                        totalPorcoesSpan.textContent = totalPorcoes.toString();
                        
                        console.log('DEBUG - Cálculo fracionamento corrigido:', {
                            quantidade,
                            volumePorPorcao,
                            volumePorUnidade,
                            totalPorcoes,
                            volumeUtilizado,
                            volumeRestante: volumePorUnidade - volumePorPorcao
                        });
                        
                        return { quantidade, volumePorPorcao, volumePorUnidade, totalPorcoes, volumeUtilizado };
                    };
    
    // Calcular valores iniciais
    calcularValores();
    
    // Event listeners para atualizar valores quando inputs mudarem
    quantidadeInput.oninput = calcularValores;
    volumeInput.oninput = calcularValores;
    
    // Configurar botão de confirmação
    const confirmarBtn = document.getElementById('confirmarFracionamentoFrasco');
    confirmarBtn.onclick = function() {
        const valores = calcularValores();
        
        if (valores.quantidade <= 0) {
            showNotification('error', 'Por favor, informe uma quantidade válida de recipientes.');
            return;
        }
        
        if (valores.quantidade > item.quantidade_atual) {
            showNotification('error', `Quantidade não pode ser maior que o estoque atual (${item.quantidade_atual}).`);
            return;
        }
        
        if (valores.volumePorPorcao <= 0) {
            showNotification('error', 'Por favor, informe um volume válido por porção.');
            return;
        }
        
        if (valores.totalPorcoes <= 0) {
            showNotification('error', 'Volume por porção é muito grande. Reduza o volume ou aumente a quantidade de recipientes.');
            return;
        }
        
        closeFracionarFrascoGarrafaModal();
        
        // Mostrar confirmação final com contêineres organizados
        const svgFrasco = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c1.1 0 2 .9 2 2v2h1c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H9c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h1V4c0-1.1.9-2 2-2z"/><circle cx="12" cy="11" r="1" fill="currentColor"/></svg>');
        const svgVolume = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v20l8-4V6l-8-4z"/><path d="M16 6v12"/></svg>');
        const svgPorcoes = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>');
        const svgAviso = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>');
        
                        const volumeRestante = parseFloat(item.volume) - valores.volumePorPorcao;
                        
                        const mensagem = `
<div style="text-align: left; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <div style="margin-bottom: 20px; font-size: 16px; font-weight: bold; color: #9B64E3;">
        Confirma o fracionamento de ${valores.quantidade} recipiente(s) de "${item.nome}"?
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgFrasco}" alt="Recipientes" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Recipientes a fracionar: <strong style="color: #D8CEFE;">${valores.quantidade}</strong></span>
        </div>
        
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgVolume}" alt="Volume" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Volume original por recipiente: <strong style="color: #D8CEFE;">${formatarNumero(parseFloat(item.volume))}L</strong></span>
        </div>
        
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgVolume}" alt="Volume Porção" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Volume extraído por recipiente: <strong style="color: #D8CEFE;">${formatarNumero(valores.volumePorPorcao)}L</strong></span>
        </div>
        
        <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPorcoes}" alt="Porções" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Porções criadas: <strong style="color: #4CAF50;">${valores.totalPorcoes}</strong></span>
        </div>
        
        <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgVolume}" alt="Volume Total" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Volume total extraído: <strong style="color: #4CAF50;">${formatarNumero(valores.volumeUtilizado)}L</strong></span>
        </div>
        
        <div style="background-color: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgVolume}" alt="Volume Restante" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Volume restante no recipiente original: <strong style="color: #2196F3;">${formatarNumero(volumeRestante)}L</strong></span>
        </div>
    </div>
    
    <div style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;">
        <img src="${svgAviso}" alt="Aviso" style="width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px;">
        <div>
            <p style="color: #FFC107; font-weight: bold; margin: 0 0 5px 0;">Importante:</p>
            <p style="color: white; margin: 0; font-size: 14px;">• Serão criadas ${valores.totalPorcoes} porções de ${formatarNumero(valores.volumePorPorcao)}L cada</p>
            <p style="color: white; margin: 0; font-size: 14px;">• ${formatarNumero(volumeRestante)}L permanecerão no(s) recipiente(s) original(is)</p>
            <p style="color: white; margin: 0; font-size: 14px;">• Esta ação não pode ser desfeita</p>
        </div>
    </div>
</div>`;
        
        showConfirmationModal(mensagem, () => {
            executarFracionamentoVolume(itemId, valores.volumePorPorcao, valores.quantidade, valores.totalPorcoes);
        });
    };
    
    // Mostrar modal
    modal.style.display = 'block';
}

// Função para mostrar modal de fracionamento de embalagem
function showFracionarEmbalagemModal(item, itemId) {
    const modal = document.getElementById('fracionarEmbalagemModal');
    const nomeItem = document.getElementById('fracionarEmbalagemNome');
    const estoqueAtual = document.getElementById('fracionarEmbalagemEstoque');
    const pesoItem = document.getElementById('fracionarEmbalagemPeso');
    const quantidadeInput = document.getElementById('quantidadeEmbalagensFracionar');
    const pesoInput = document.getElementById('pesoFracionamento');
    const pesoTotalSpan = document.getElementById('pesoTotalUtilizado');
    const totalPorcoesSpan = document.getElementById('totalPorcoesPesoFracionamento');
    
    // Verificar se todos os elementos existem
    if (!modal || !nomeItem || !estoqueAtual || !pesoItem || !quantidadeInput || !pesoInput || !pesoTotalSpan || !totalPorcoesSpan) {
        console.error('Elementos do modal de fracionamento de embalagem não encontrados');
        // Fallback para o método antigo
        const pesoPorUnidade = parseFloat(item.peso) || 0;
        const pesoTotal = item.quantidade_atual * pesoPorUnidade;
        const mensagem = `Fracionar TODAS as ${item.quantidade_atual} embalagens de "${item.nome}"?\n\n` +
                       `• Peso por embalagem: ${pesoPorUnidade}g\n` +
                       `• Peso total disponível: ${pesoTotal}g`;
        
        if (confirm(mensagem)) {
            executarFracionamentoPeso(itemId, pesoPorUnidade, item.quantidade_atual, 100); // Peso padrão de 100g por porção
        }
        return;
    }
    
    // Preencher dados do modal
    nomeItem.textContent = item.nome;
    estoqueAtual.textContent = item.quantidade_atual;
    pesoItem.textContent = parseFloat(item.peso || 0).toFixed(1);
    quantidadeInput.max = item.quantidade_atual;
    quantidadeInput.value = 1;
    pesoInput.value = 100; // Peso padrão de 100g
    
    // Função para formatar números removendo zeros desnecessários
    const formatarNumero = (valor) => {
        if (valor === null || valor === undefined || isNaN(valor)) return '0';
        const numero = parseFloat(valor);
        if (numero % 1 === 0) {
            return numero.toString();
        }
        return numero.toFixed(1).replace(/\.?0+$/, '');
    };
    
    // Função para calcular valores
    const calcularValores = () => {
        const quantidade = parseInt(quantidadeInput.value) || 0;
        const pesoPorPorcao = parseFloat(pesoInput.value) || 0;
        const pesoPorUnidade = parseFloat(item.peso) || 0;
        
        const totalPorcoes = quantidade;
        const pesoUtilizado = totalPorcoes * pesoPorPorcao;
        
        pesoTotalSpan.textContent = formatarNumero(pesoUtilizado);
        totalPorcoesSpan.textContent = totalPorcoes.toString();
        
        console.log('DEBUG - Cálculo fracionamento por peso:', {
            quantidade,
            pesoPorPorcao,
            pesoPorUnidade,
            totalPorcoes,
            pesoUtilizado,
            pesoRestante: pesoPorUnidade - pesoPorPorcao
        });
        
        return { quantidade, pesoPorPorcao, pesoPorUnidade, totalPorcoes, pesoUtilizado };
    };
    
    // Calcular valores iniciais
    calcularValores();
    
    // Event listeners para atualizar valores quando inputs mudarem
    quantidadeInput.oninput = calcularValores;
    pesoInput.oninput = calcularValores;
    
    // Configurar botão de confirmação
    const confirmarBtn = document.getElementById('confirmarFracionamentoEmbalagem');
    confirmarBtn.onclick = function() {
        const valores = calcularValores();
        
        if (valores.quantidade <= 0) {
            showNotification('error', 'Por favor, informe uma quantidade válida de embalagens.');
            return;
        }
        
        if (valores.quantidade > item.quantidade_atual) {
            showNotification('error', `Quantidade não pode ser maior que o estoque atual (${item.quantidade_atual}).`);
            return;
        }
        
        if (valores.pesoPorPorcao <= 0) {
            showNotification('error', 'Por favor, informe um peso válido por porção.');
            return;
        }
        
        if (valores.pesoPorPorcao >= valores.pesoPorUnidade) {
            showNotification('error', 'O peso por porção deve ser menor que o peso da embalagem original.');
            return;
        }
        
        closeFracionarEmbalagemModal();
        
        // Mostrar confirmação final
        const svgEmbalagem = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"/></svg>');
        const svgPeso = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a6 6 0 0 0-6 6c0 2 2 4 6 4s6-2 6-4a6 6 0 0 0-6-6z"/><path d="M12 22c4.418 0 8-1.79 8-4s-3.582-4-8-4-8 1.79-8 4 3.582 4 8 4z"/></svg>');
        const svgPorcoes = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9B64E3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>');
        const svgAviso = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>');
        
        const pesoRestante = parseFloat(item.peso) - valores.pesoPorPorcao;
        
        const mensagem = `
<div style="text-align: left; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <div style="margin-bottom: 20px; font-size: 16px; font-weight: bold; color: #9B64E3;">
        Confirma o fracionamento de ${valores.quantidade} embalagem(ns) de "${item.nome}"?
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgEmbalagem}" alt="Embalagens" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Embalagens a fracionar: <strong style="color: #D8CEFE;">${valores.quantidade}</strong></span>
        </div>
        
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPeso}" alt="Peso" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Peso original por embalagem: <strong style="color: #D8CEFE;">${formatarNumero(parseFloat(item.peso))}g</strong></span>
        </div>
        
        <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPeso}" alt="Peso Porção" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Peso extraído por embalagem: <strong style="color: #D8CEFE;">${formatarNumero(valores.pesoPorPorcao)}g</strong></span>
        </div>
        
        <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPorcoes}" alt="Porções" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Porções criadas: <strong style="color: #4CAF50;">${valores.totalPorcoes}</strong></span>
        </div>
        
        <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPeso}" alt="Peso Total" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Peso total extraído: <strong style="color: #4CAF50;">${formatarNumero(valores.pesoUtilizado)}g</strong></span>
        </div>
        
        <div style="background-color: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px;">
            <img src="${svgPeso}" alt="Peso Restante" style="width: 16px; height: 16px; flex-shrink: 0;">
            <span style="color: white; font-weight: 500;">Peso restante na embalagem original: <strong style="color: #2196F3;">${formatarNumero(pesoRestante)}g</strong></span>
        </div>
    </div>
    
    <div style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 6px; padding: 12px; display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;">
        <img src="${svgAviso}" alt="Aviso" style="width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px;">
        <div>
            <p style="color: #FFC107; font-weight: bold; margin: 0 0 5px 0;">Importante:</p>
            <p style="color: white; margin: 0; font-size: 14px;">• Serão criadas ${valores.totalPorcoes} porções de ${formatarNumero(valores.pesoPorPorcao)}g cada</p>
            <p style="color: white; margin: 0; font-size: 14px;">• ${formatarNumero(pesoRestante)}g permanecerão na(s) embalagem(ns) original(is)</p>
            <p style="color: white; margin: 0; font-size: 14px;">• Esta ação não pode ser desfeita</p>
        </div>
    </div>
</div>`;
        
        showConfirmationModal(mensagem, () => {
            executarFracionamentoPeso(itemId, valores.pesoPorPorcao, valores.quantidade, valores.totalPorcoes);
        });
    };
    
    // Mostrar modal
    modal.style.display = 'block';
}

// Função para executar o fracionamento
async function executarFracionamento(itemId, unidadesPorPacote, quantidadePacotes, totalUnidades) {
    try {
        console.log('DEBUG - Dados para fracionamento:');
        console.log('  itemId:', itemId);
        console.log('  unidadesPorPacote:', unidadesPorPacote);
        console.log('  quantidadePacotes:', quantidadePacotes);
        console.log('  totalUnidades:', totalUnidades);
        
        // Executar requisição real para a API
        const fracionarResponse = await fetch(`/api/itens_estoque/${itemId}/fracionar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                quantidade_pacotes: quantidadePacotes
            })
        });
        
        if (!fracionarResponse.ok) {
            const errorText = await fracionarResponse.text();
            throw new Error(`HTTP ${fracionarResponse.status}: ${errorText}`);
        }
        
        const fracionarResult = await fracionarResponse.json();
        
        if (fracionarResult.status === 'success') {
            const dadosResult = fracionarResult.data || {};
            const pacotesFracionados = dadosResult.pacotes_fracionados || quantidadePacotes;
            const unidadesAdicionadas = dadosResult.unidades_adicionadas || totalUnidades;
            const novaQuantidadeTotal = dadosResult.nova_quantidade_total || 'N/A';
            
            showNotification('success', 
                `✅ Fracionamento realizado com sucesso!\n\n` +
                `📦 Pacotes fracionados: ${pacotesFracionados}\n` +
                `🔢 Unidades adicionadas: ${unidadesAdicionadas}\n` +
                `📊 Nova quantidade total: ${novaQuantidadeTotal}`
            );
            
            // Recarregar a lista de estoque para mostrar as alterações
            carregarListaEstoque();
        } else {
            throw new Error(fracionarResult.message || 'Erro desconhecido');
        }
        
    } catch (error) {
        console.error('Erro ao fracionar pacote:', error);
        
        if (error.message.includes('404')) {
            showNotification('error', 'A rota da API para fracionamento não foi encontrada.\n\nVerifique se o servidor está atualizado.', 'API_NOT_FOUND');
        } else if (error.message.includes('400')) {
            showNotification('error', `Erro de validação: ${error.message}`, 'VALIDATION_ERROR');
        } else {
            showNotification('error', `Erro ao fracionar pacote: ${error.message}`, 'EXCEPTION');
        }
    }
}

// Função para fechar modal de fracionamento de pacote
function closeFracionarPacoteModal() {
    const modal = document.getElementById('fracionarPacoteModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Função para fechar modal de fracionamento de frasco/garrafa
function closeFracionarFrascoGarrafaModal() {
    const modal = document.getElementById('fracionarFrascoGarrafaModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Função para fechar modal de fracionamento de embalagem
function closeFracionarEmbalagemModal() {
    const modal = document.getElementById('fracionarEmbalagemModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Função para executar o fracionamento por volume
async function executarFracionamentoVolume(itemId, volumePorPorcao, quantidadeRecipientes, totalPorcoes) {
    try {
        console.log('DEBUG - Dados para fracionamento por volume:');
        console.log('  itemId:', itemId);
        console.log('  volumePorPorcao:', volumePorPorcao);
        console.log('  quantidadeRecipientes:', quantidadeRecipientes);
        console.log('  totalPorcoes:', totalPorcoes);
        
        // Executar requisição para a API de fracionamento por volume
        const fracionarResponse = await fetch(`/api/itens_estoque/${itemId}/fracionar_volume`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                quantidade_recipientes: quantidadeRecipientes,
                volume_por_porcao: volumePorPorcao,
                total_porcoes: totalPorcoes
            })
        });
        
        if (!fracionarResponse.ok) {
            const errorText = await fracionarResponse.text();
            throw new Error(`HTTP ${fracionarResponse.status}: ${errorText}`);
        }
        
        const fracionarResult = await fracionarResponse.json();
        
        if (fracionarResult.status === 'success') {
            const dadosResult = fracionarResult.data || {};
            const recipientesFracionados = dadosResult.recipientes_fracionados || quantidadeRecipientes;
            const porcoesAdicionadas = dadosResult.porcoes_adicionadas || totalPorcoes;
            const volumeUtilizado = dadosResult.volume_utilizado || (totalPorcoes * volumePorPorcao);
            const novaQuantidadeTotal = dadosResult.nova_quantidade_total || 'N/A';
            
            showNotification('success', 
                `✅ Fracionamento por volume realizado com sucesso!\n\n` +
                `🍶 Recipientes fracionados: ${recipientesFracionados}\n` +
                `📏 Volume por porção: ${volumePorPorcao}L\n` +
                `🔢 Porções criadas: ${porcoesAdicionadas}\n` +
                `💧 Volume total utilizado: ${typeof volumeUtilizado === 'number' ? volumeUtilizado.toFixed(3) : volumeUtilizado}L\n` +
                `📊 Nova quantidade total: ${novaQuantidadeTotal}`
            );
            
            // Recarregar a lista de estoque para mostrar as alterações
            carregarListaEstoque();
        } else {
            throw new Error(fracionarResult.message || 'Erro desconhecido');
        }
        
    } catch (error) {
        console.error('Erro ao fracionar por volume:', error);
        
        if (error.message.includes('404')) {
            showNotification('error', 'A rota da API para fracionamento por volume não foi encontrada.\n\nVerifique se o servidor está atualizado.', 'API_NOT_FOUND');
        } else if (error.message.includes('400')) {
            showNotification('error', `Erro de validação: ${error.message}`, 'VALIDATION_ERROR');
        } else {
            showNotification('error', `Erro ao fracionar por volume: ${error.message}`, 'EXCEPTION');
        }
    }
}

// Função para executar fracionamento por peso
async function executarFracionamentoPeso(itemId, pesoPorPorcao, quantidadeEmbalagens, totalPorcoes) {
    try {
        console.log('DEBUG - Dados para fracionamento por peso:');
        console.log('  itemId:', itemId);
        console.log('  pesoPorPorcao:', pesoPorPorcao);
        console.log('  quantidadeEmbalagens:', quantidadeEmbalagens);
        console.log('  totalPorcoes:', totalPorcoes);
        
        // Executar requisição para a API de fracionamento por peso
        const fracionarResponse = await fetch(`/api/itens_estoque/${itemId}/fracionar_peso`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                quantidade_embalagens: quantidadeEmbalagens,
                peso_por_porcao: pesoPorPorcao,
                total_porcoes: totalPorcoes
            })
        });
        
        if (!fracionarResponse.ok) {
            const errorText = await fracionarResponse.text();
            throw new Error(`HTTP ${fracionarResponse.status}: ${errorText}`);
        }
        
        const fracionarResult = await fracionarResponse.json();
        
        if (fracionarResult.status === 'success') {
            const dadosResult = fracionarResult.data || {};
            const embalagensFracionadas = dadosResult.embalagens_fracionadas || quantidadeEmbalagens;
            const porcoesAdicionadas = dadosResult.porcoes_adicionadas || totalPorcoes;
            const pesoUtilizado = dadosResult.peso_utilizado || (totalPorcoes * pesoPorPorcao);
            const novaQuantidadeTotal = dadosResult.nova_quantidade_total || 'N/A';
            
            showNotification('success', 
                `✅ Fracionamento por peso realizado com sucesso!\n\n` +
                `📦 Embalagens fracionadas: ${embalagensFracionadas}\n` +
                `⚖️ Peso por porção: ${pesoPorPorcao}g\n` +
                `🔢 Porções criadas: ${porcoesAdicionadas}\n` +
                `💰 Peso total utilizado: ${typeof pesoUtilizado === 'number' ? pesoUtilizado.toFixed(1) : pesoUtilizado}g\n` +
                `📊 Nova quantidade total: ${novaQuantidadeTotal}`
            );
            
            // Recarregar a lista de estoque para mostrar as alterações
            carregarListaEstoque();
        } else {
            throw new Error(fracionarResult.message || 'Erro desconhecido');
        }
        
    } catch (error) {
        console.error('Erro ao fracionar por peso:', error);
        
        if (error.message.includes('404')) {
            showNotification('error', 'A rota da API para fracionamento por peso não foi encontrada.\n\nVerifique se o servidor está atualizado.', 'API_NOT_FOUND');
        } else if (error.message.includes('400')) {
            showNotification('error', `Erro de validação: ${error.message}`, 'VALIDATION_ERROR');
        } else {
            showNotification('error', `Erro ao fracionar por peso: ${error.message}`, 'EXCEPTION');
        }
    }
}

// Função para gerar código aleatório baseado no nome e fabricante
async function gerarCodigoAleatorio() {
    // Obter valores dos campos
    const nomeItem = document.getElementById('itemName').value.trim();
    const fabricante = document.getElementById('itemFabricante').value.trim();
    
    // Verificar se os campos necessários estão preenchidos
    if (!nomeItem) {
        showNotification('error', 'Por favor, informe o nome do item primeiro.');
        return;
    }
    
    if (!fabricante) {
        showNotification('error', 'Por favor, informe o fabricante primeiro.');
        return;
    }
    
    // Função para extrair palavras-chave do nome
    function extrairPalavrasChaveNome(texto) {
        // Lista de palavras a serem ignoradas
        const stopWords = ['de', 'da', 'do', 'das', 'dos', 'em', 'para', 'com', 'por', 'a', 'o', 'e', 'ou', 'na', 'no', 'nas', 'nos'];
        
        const palavras = texto.toLowerCase()
            .replace(/[^\w\s]/g, '') // Remove pontuação
            .split(/\s+/) // Divide por espaços
            .filter(palavra => palavra.length > 1 && !stopWords.includes(palavra)); // Remove palavras pequenas e stop words
        
        const abreviacoes = [];
        
        // Primeira palavra: 2 caracteres
        if (palavras[0]) {
            abreviacoes.push(palavras[0].substring(0, 2).toUpperCase());
        }
        
        // Segunda palavra: 2 caracteres
        if (palavras[1]) {
            abreviacoes.push(palavras[1].substring(0, 2).toUpperCase());
        }
        
        // Terceira palavra: 3 caracteres (se existir)
        if (palavras[2]) {
            abreviacoes.push(palavras[2].substring(0, 3).toUpperCase());
        }
        
        return abreviacoes;
    }
    
    // Extrair nome completo do fabricante (sem espaços)
    const fabricanteCompleto = fabricante.toUpperCase().replace(/[^\w]/g, '');
    
    // Extrair abreviações do nome
    const abreviacoesNome = extrairPalavrasChaveNome(nomeItem);
    
    // Função para verificar se código já existe
    async function verificarCodigoExistente(codigo) {
        try {
            const response = await fetch('/api/itens_estoque/verificar_codigo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ codigo: codigo })
            });
            
            if (response.ok) {
                const result = await response.json();
                return result.existe; // true se já existe, false se está disponível
            } else {
                console.warn('Erro ao verificar código existente, continuando sem verificação');
                return false; // Em caso de erro, assume que não existe
            }
        } catch (error) {
            console.warn('Erro na requisição de verificação de código:', error);
            return false; // Em caso de erro, assume que não existe
        }
    }
    
    // Gerar código até encontrar um único
    let tentativas = 0;
    const maxTentativas = 100;
    let codigoFinal = '';
    
    do {
        tentativas++;
        
        // Gerar número aleatório de 3 dígitos
        const numeroAleatorio = Math.floor(Math.random() * 900) + 100; // Entre 100 e 999
        
        // Construir o código
        const partes = [fabricanteCompleto, ...abreviacoesNome, numeroAleatorio.toString()];
        codigoFinal = partes.join('_');
        
        console.log(`DEBUG - Tentativa ${tentativas}: ${codigoFinal}`);
        
        // Verificar se já existe no banco
        const jaExiste = await verificarCodigoExistente(codigoFinal);
        
        if (!jaExiste) {
            break; // Código único encontrado
        }
        
        if (tentativas >= maxTentativas) {
            showNotification('error', 'Não foi possível gerar um código único após várias tentativas. Tente novamente.');
            return;
        }
        
    } while (tentativas < maxTentativas);
    
    // Preencher o campo de código
    document.getElementById('itemCode').value = codigoFinal;
    
    // Feedback visual
    const input = document.getElementById('itemCode');
    input.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
    input.style.borderColor = '#4CAF50';
    
    setTimeout(() => {
        input.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        input.style.borderColor = '#9B64E3';
    }, 1500);
    
    // Notificação de sucesso
    showNotification('success', `Código único gerado: ${codigoFinal}`);
    
    console.log('DEBUG - Geração de código concluída:');
    console.log('  Nome:', nomeItem);
    console.log('  Fabricante:', fabricante);
    console.log('  Abreviações do nome:', abreviacoesNome);
    console.log('  Fabricante completo:', fabricanteCompleto);
    console.log('  Código final:', codigoFinal);
    console.log('  Tentativas necessárias:', tentativas);
}

// Torna a função de inicialização disponível globalmente
window.initializeEstoqueScripts = initializeEstoqueScripts;
</script>
 </div>

<style>
    /* Estilos para os modais de confirmação e notificação */
    .notification-modal-content {
        max-width: 400px;
        text-align: center;
        padding: 30px;
    }
    .notification-modal-content .btn-primary {
        margin: 0 auto; /* Centraliza o botão OK */
        display: block; /* Garante que o margin auto funcione */
    }
    .notification-modal-content h2 {
        border-bottom: none;
        margin-bottom: 15px;
        font-size: 1.5em;
    }
    .notification-modal-content p {
        margin-bottom: 20px;
        font-size: 1.1em;
    }
    .notification-modal-content .btn-primary {
        margin-top: 0;
        padding: 10px 20px;
    }
    .notification-modal-content.success h2 {
        color: #4CAF50; /* Verde para sucesso */
    }
    .notification-modal-content.error h2 {
        color: #F44336; /* Vermelho para erro */
    }
    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px auto 0;
        width: 100%;
        max-width: 300px;
    }
    .modal-buttons button {
        min-width: 100px;
        transition: all 0.3s ease;
    }
    
    .modal-buttons button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Estilos para checkbox personalizada seguindo o padrão do login */
    #isMeasurementUnit {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 18px !important;
        height: 18px !important;
        border: 2px solid #9B64E3 !important;
        border-radius: 3px !important;
        background-color: rgba(255, 255, 255, 0.1) !important;
        cursor: pointer !important;
        position: relative !important;
        vertical-align: middle !important;
        margin-right: 8px !important;
    }
    
    #isMeasurementUnit:checked {
        background-color: #9B64E3 !important;
    }
    
    #isMeasurementUnit:checked::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    #isMeasurementUnit:hover {
        background-color: rgba(155, 100, 227, 0.1) !important;
    }
    
    /* Estilos para a lista de estoque (similar à lista de usuários) */
    .user-item {
        background-color: var(--order-card-bg);
        border-radius: 8px;
        transition: background-color 0.2s ease;
    }
    
    .user-item:hover {
        background-color: var(--order-card-hover-bg);
    }
    
    .user-item:hover .user-actions {
        opacity: 1;
        visibility: visible;
    }
    
    .user-actions {
        opacity: 0.7;
        transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    /* Estilos para truncar texto e mostrar tooltips */
    .user-item > div {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
        max-width: 100%;
    }

    .user-item > div:hover {
        z-index: 10;
    }

    /* Tooltip para texto truncado */
    .user-item > div[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: normal;
        word-wrap: break-word;
        z-index: 1000;
        max-width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        margin-bottom: 8px;
        border: 1px solid rgba(155, 100, 227, 0.3);
    }

    /* Seta do tooltip */
    .user-item > div[title]:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(8px);
        border: 6px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
        z-index: 1001;
    }

    /* Estilo específico para campos que podem ser longos */
    .user-item > div:nth-child(2), /* Tipo de item */
    .user-item > div:nth-child(3), /* Nome */
    .user-item > div:nth-child(4), /* Categoria */
    .user-item > div:nth-child(13), /* Fornecedor */
    .user-item > div:nth-child(14), /* Fabricante */
    .user-item > div:nth-child(15) { /* Localização */
        max-width: 150px;
    }

    /* Estilo para campos numéricos (não precisam de tooltip) */
    .user-item > div:nth-child(1), /* Código */
    .user-item > div:nth-child(5), /* Quantidade */
    .user-item > div:nth-child(6), /* Mínimo */
    .user-item > div:nth-child(7), /* Largura */
    .user-item > div:nth-child(8), /* Comprimento */
    .user-item > div:nth-child(9), /* Peso */
    .user-item > div:nth-child(10), /* Volume */
    .user-item > div:nth-child(11), /* Custo médio */
    .user-item > div:nth-child(12), /* Custo atual */
    .user-item > div:nth-child(16) { /* Status */
        max-width: 100px;
    }

    /* Ações não precisam de limitação */
    .user-item > div:nth-child(17) {
        max-width: none;
        overflow: visible;
        white-space: normal;
    }
    
    .action-btn {
        position: relative;
    }
    
    .action-btn:hover {
        background-color: rgba(155, 100, 227, 0.2);
        color: var(--cor-destaque, #9B64E3);
    }
    
    .action-btn[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 5px;
    }
    
    :root {
        --action-icon-color: #9B64E3;
        --order-card-hover-bg: rgba(155, 100, 227, 0.1);
    }

    /* Custom scrollbar styles para todos os elementos */
    /* Webkit browsers (Chrome, Safari, Edge) */
    .modal-body::-webkit-scrollbar,
    .dropdown-content::-webkit-scrollbar,
    .custom-select > div::-webkit-scrollbar,
    #materialsListContent::-webkit-scrollbar,
    #fornecedoresListContent::-webkit-scrollbar,
    #materialSelectionModal .modal-body::-webkit-scrollbar,
    #fornecedorSelectionModal .modal-body::-webkit-scrollbar,
    textarea::-webkit-scrollbar,
    .estoque-list::-webkit-scrollbar,
    .estoque-list-container::-webkit-scrollbar {
        width: 12px;
    }

    .modal-body::-webkit-scrollbar-track,
    .dropdown-content::-webkit-scrollbar-track,
    .custom-select > div::-webkit-scrollbar-track,
    #materialsListContent::-webkit-scrollbar-track,
    #fornecedoresListContent::-webkit-scrollbar-track,
    #materialSelectionModal .modal-body::-webkit-scrollbar-track,
    #fornecedorSelectionModal .modal-body::-webkit-scrollbar-track,
    textarea::-webkit-scrollbar-track,
    .estoque-list::-webkit-scrollbar-track,
    .estoque-list-container::-webkit-scrollbar-track {
        background: rgba(155, 100, 227, 0.1);
        border-radius: 4px;
        margin-right: 2px;
    }

    .modal-body::-webkit-scrollbar-thumb,
    .dropdown-content::-webkit-scrollbar-thumb,
    .custom-select > div::-webkit-scrollbar-thumb,
    #materialsListContent::-webkit-scrollbar-thumb,
    #fornecedoresListContent::-webkit-scrollbar-thumb,
    #materialSelectionModal .modal-body::-webkit-scrollbar-thumb,
    #fornecedorSelectionModal .modal-body::-webkit-scrollbar-thumb,
    textarea::-webkit-scrollbar-thumb,
    .estoque-list::-webkit-scrollbar-thumb,
    .estoque-list-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #9B64E3, #D8CEFE);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(155, 100, 227, 0.3);
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    .modal-body::-webkit-scrollbar-thumb:hover,
    .dropdown-content::-webkit-scrollbar-thumb:hover,
    .custom-select > div::-webkit-scrollbar-thumb:hover,
    #materialsListContent::-webkit-scrollbar-thumb:hover,
    #fornecedoresListContent::-webkit-scrollbar-thumb:hover,
    #materialSelectionModal .modal-body::-webkit-scrollbar-thumb:hover,
    #fornecedorSelectionModal .modal-body::-webkit-scrollbar-thumb:hover,
    textarea::-webkit-scrollbar-thumb:hover,
    .estoque-list::-webkit-scrollbar-thumb:hover,
    .estoque-list-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #8A4FD3, #C7B7FE);
        box-shadow: 0 4px 8px rgba(155, 100, 227, 0.5);
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    /* Firefox */
    .modal-body,
    .dropdown-content,
    .custom-select > div,
    #materialsListContent,
    #fornecedoresListContent,
    #materialSelectionModal .modal-body,
    #fornecedorSelectionModal .modal-body,
    textarea,
    .estoque-list,
    .estoque-list-container {
        scrollbar-width: thin;
        scrollbar-color: #9B64E3 rgba(155, 100, 227, 0.1);
    }

    /* Scrollbar para elementos específicos dos modais */
    #itemModal .modal-body::-webkit-scrollbar,
    #editItemModal .modal-body::-webkit-scrollbar,
    #entradaEstoqueModal .modal-body::-webkit-scrollbar,
    #saidaEstoqueModal .modal-body::-webkit-scrollbar,
    #novaUnidadeModal .modal-body::-webkit-scrollbar,
    #novaCategoriaModal .modal-body::-webkit-scrollbar,
    #novoTipoItemModal .modal-body::-webkit-scrollbar,
    #novoFornecedorModal .modal-body::-webkit-scrollbar,
    #confirmationModal .modal-body::-webkit-scrollbar,
    #notificationModal .modal-body::-webkit-scrollbar {
        width: 12px;
    }

    #itemModal .modal-body::-webkit-scrollbar-track,
    #editItemModal .modal-body::-webkit-scrollbar-track,
    #entradaEstoqueModal .modal-body::-webkit-scrollbar-track,
    #saidaEstoqueModal .modal-body::-webkit-scrollbar-track,
    #novaUnidadeModal .modal-body::-webkit-scrollbar-track,
    #novaCategoriaModal .modal-body::-webkit-scrollbar-track,
    #novoTipoItemModal .modal-body::-webkit-scrollbar-track,
    #novoFornecedorModal .modal-body::-webkit-scrollbar-track,
    #confirmationModal .modal-body::-webkit-scrollbar-track,
    #notificationModal .modal-body::-webkit-scrollbar-track {
        background: rgba(155, 100, 227, 0.1);
        border-radius: 4px;
    }

    #itemModal .modal-body::-webkit-scrollbar-thumb,
    #editItemModal .modal-body::-webkit-scrollbar-thumb,
    #entradaEstoqueModal .modal-body::-webkit-scrollbar-thumb,
    #saidaEstoqueModal .modal-body::-webkit-scrollbar-thumb,
    #novaUnidadeModal .modal-body::-webkit-scrollbar-thumb,
    #novaCategoriaModal .modal-body::-webkit-scrollbar-thumb,
    #novoTipoItemModal .modal-body::-webkit-scrollbar-thumb,
    #novoFornecedorModal .modal-body::-webkit-scrollbar-thumb,
    #confirmationModal .modal-body::-webkit-scrollbar-thumb,
    #notificationModal .modal-body::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #9B64E3, #D8CEFE);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(155, 100, 227, 0.3);
    }

    #itemModal .modal-body::-webkit-scrollbar-thumb:hover,
    #editItemModal .modal-body::-webkit-scrollbar-thumb:hover,
    #entradaEstoqueModal .modal-body::-webkit-scrollbar-thumb:hover,
    #saidaEstoqueModal .modal-body::-webkit-scrollbar-thumb:hover,
    #novaUnidadeModal .modal-body::-webkit-scrollbar-thumb:hover,
    #novaCategoriaModal .modal-body::-webkit-scrollbar-thumb:hover,
    #novoTipoItemModal .modal-body::-webkit-scrollbar-thumb:hover,
    #novoFornecedorModal .modal-body::-webkit-scrollbar-thumb:hover,
    #confirmationModal .modal-body::-webkit-scrollbar-thumb:hover,
    #notificationModal .modal-body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #8A4FD3, #C7B7FE);
        box-shadow: 0 4px 8px rgba(155, 100, 227, 0.5);
    }

    /* Firefox para elementos específicos dos modais */
    #itemModal .modal-body,
    #editItemModal .modal-body,
    #entradaEstoqueModal .modal-body,
    #saidaEstoqueModal .modal-body,
    #novaUnidadeModal .modal-body,
    #novaCategoriaModal .modal-body,
    #novoTipoItemModal .modal-body,
    #novoFornecedorModal .modal-body,
    #confirmationModal .modal-body,
    #notificationModal .modal-body {
        scrollbar-width: thin;
        scrollbar-color: #9B64E3 rgba(155, 100, 227, 0.1);
    }
</style>

<!-- Modal para Fracionamento de Pacote -->
<div id="fracionarPacoteModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; box-sizing: border-box;">
        <span class="close-button" onclick="closeFracionarPacoteModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2 style="color: #9B64E3; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
            </svg>
            Fracionar Pacote
        </h2>
        <div class="modal-body" style="padding: 20px; box-sizing: border-box;">
            <!-- Informações do Item -->
            <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #9B64E3; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">Informações do Pacote</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Item:</label>
                        <span id="fracionarPacoteNome" style="color: white;"></span>
                    </div>
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Estoque Atual:</label>
                        <span id="fracionarPacoteEstoque" style="color: white; font-weight: bold;"></span> pacotes
                    </div>
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Unidades por Pacote:</label>
                        <span id="fracionarPacoteUnidades" style="color: white; font-weight: bold;"></span> unidades
                    </div>
                </div>
            </div>
            
            <!-- Seleção da Quantidade -->
            <div style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid rgba(155, 100, 227, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #9B64E3; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">Quantidade a Fracionar</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <label for="quantidadePacotesFracionar" style="color: white; font-weight: bold; min-width: 100px;">Pacotes:</label>
                    <input type="number" id="quantidadePacotesFracionar" min="1" value="1" style="flex: 1; max-width: 150px; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; font-weight: bold; text-align: center;">
                </div>
            </div>
            
            <!-- Resultado da Operação -->
            <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #4CAF50; font-size: 16px; margin: 0 0 10px 0; font-weight: bold;">Resultado</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: white;">Total de unidades individuais:</span>
                    <span id="totalUnidadesFracionamento" style="color: #4CAF50; font-weight: bold; font-size: 18px;">0</span>
                    <span style="color: white;">unidades</span>
                </div>
            </div>
            
            <!-- Aviso Importante -->
            <div style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-top: 2px; flex-shrink: 0;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div>
                        <p style="color: #FFC107; font-weight: bold; margin: 0 0 5px 0;">Atenção:</p>
                        <p style="color: white; margin: 0; font-size: 14px;">Esta operação não pode ser desfeita. Os pacotes selecionados serão convertidos em unidades individuais.</p>
                    </div>
                </div>
            </div>
            
            <!-- Botões -->
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" onclick="closeFracionarPacoteModal()" style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid #ccc; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'">Cancelar</button>
                <button type="button" id="confirmarFracionamento" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">Fracionar Pacotes</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Fracionamento de Frasco/Garrafa -->
<div id="fracionarFrascoGarrafaModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; box-sizing: border-box;">
        <span class="close-button" onclick="closeFracionarFrascoGarrafaModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2 style="color: #9B64E3; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2c1.1 0 2 .9 2 2v2h1c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H9c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h1V4c0-1.1.9-2 2-2z"/>
                <circle cx="12" cy="11" r="1" fill="currentColor"/>
                <circle cx="12" cy="15" r="1" fill="currentColor"/>
            </svg>
            Fracionar por Volume
        </h2>
        <div class="modal-body" style="padding: 20px; box-sizing: border-box;">
            <!-- Informações do Item -->
            <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #9B64E3; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">Informações do Recipiente</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Item:</label>
                        <span id="fracionarFrascoNome" style="color: white;"></span>
                    </div>
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Estoque Atual:</label>
                        <span id="fracionarFrascoEstoque" style="color: white; font-weight: bold;"></span> unidades
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Volume por Unidade:</label>
                        <span id="fracionarFrascoVolume" style="color: white; font-weight: bold;"></span> litros
                    </div>
                </div>
            </div>
            
            <!-- Seleção da Quantidade -->
            <div style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid rgba(155, 100, 227, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #9B64E3; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">Configuração do Fracionamento</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label for="quantidadeFrascosFracionar" style="color: white; font-weight: bold; min-width: 120px;">Recipientes:</label>
                        <input type="number" id="quantidadeFrascosFracionar" min="1" value="1" style="flex: 1; max-width: 150px; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; font-weight: bold; text-align: center;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label for="volumeFracionamento" style="color: white; font-weight: bold; min-width: 120px;">Volume por porção (L):</label>
                        <input type="number" id="volumeFracionamento" min="0.001" step="0.001" value="0.1" style="flex: 1; max-width: 150px; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; font-weight: bold; text-align: center;">
                    </div>
                </div>
            </div>
            
            <!-- Resultado da Operação -->
            <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #4CAF50; font-size: 16px; margin: 0 0 10px 0; font-weight: bold;">Resultado</h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white;">Volume total utilizado:</span>
                        <span id="volumeTotalUtilizado" style="color: #4CAF50; font-weight: bold; font-size: 16px;">0</span>
                        <span style="color: white;">litros</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white;">Porções criadas:</span>
                        <span id="totalPorcoesFracionamento" style="color: #4CAF50; font-weight: bold; font-size: 18px;">0</span>
                        <span style="color: white;">porções</span>
                    </div>
                </div>
            </div>
            
            <!-- Aviso Importante -->
            <div style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-top: 2px; flex-shrink: 0;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div>
                        <p style="color: #FFC107; font-weight: bold; margin: 0 0 5px 0;">Atenção:</p>
                        <p style="color: white; margin: 0; font-size: 14px;">Esta operação não pode ser desfeita. Os recipientes serão convertidos em porções menores com o volume especificado.</p>
                    </div>
                </div>
            </div>
            
            <!-- Botões -->
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" onclick="closeFracionarFrascoGarrafaModal()" style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid #ccc; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'">Cancelar</button>
                <button type="button" id="confirmarFracionamentoFrasco" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">Fracionar por Volume</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Fracionamento por Peso -->
<div id="fracionarEmbalagemModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; box-sizing: border-box;">
        <span class="close-button" onclick="closeFracionarEmbalagemModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2 style="color: #9B64E3; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"/>
            </svg>
            Fracionar por Peso
        </h2>
        <div class="modal-body" style="padding: 20px; box-sizing: border-box;">
            <!-- Informações do Item -->
            <div style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid rgba(155, 100, 227, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #9B64E3; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">Informações da Embalagem</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Item:</label>
                        <span id="fracionarEmbalagemNome" style="color: white;"></span>
                    </div>
                    <div>
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Estoque Atual:</label>
                        <span id="fracionarEmbalagemEstoque" style="color: white; font-weight: bold;"></span> unidades
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label style="color: #9B64E3; font-weight: bold; display: block; margin-bottom: 5px;">Peso por Unidade:</label>
                        <span id="fracionarEmbalagemPeso" style="color: white; font-weight: bold;"></span> gramas
                    </div>
                </div>
            </div>
            
            <!-- Seleção da Quantidade -->
            <div style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid rgba(155, 100, 227, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #9B64E3; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">Configuração do Fracionamento</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label for="quantidadeEmbalagensFracionar" style="color: white; font-weight: bold; min-width: 120px;">Embalagens:</label>
                        <input type="number" id="quantidadeEmbalagensFracionar" min="1" value="1" style="flex: 1; max-width: 150px; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; font-weight: bold; text-align: center;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label for="pesoFracionamento" style="color: white; font-weight: bold; min-width: 120px;">Peso por porção (g):</label>
                        <input type="number" id="pesoFracionamento" min="1" step="1" value="100" style="flex: 1; max-width: 150px; padding: 10px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; font-weight: bold; text-align: center;">
                    </div>
                </div>
            </div>
            
            <!-- Resultado da Operação -->
            <div style="background-color: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="color: #4CAF50; font-size: 16px; margin: 0 0 10px 0; font-weight: bold;">Resultado</h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white;">Peso total utilizado:</span>
                        <span id="pesoTotalUtilizado" style="color: #4CAF50; font-weight: bold; font-size: 16px;">0</span>
                        <span style="color: white;">gramas</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white;">Porções criadas:</span>
                        <span id="totalPorcoesPesoFracionamento" style="color: #4CAF50; font-weight: bold; font-size: 18px;">0</span>
                        <span style="color: white;">porções</span>
                    </div>
                </div>
            </div>
            
            <!-- Aviso Importante -->
            <div style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFC107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-top: 2px; flex-shrink: 0;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div>
                        <p style="color: #FFC107; font-weight: bold; margin: 0 0 5px 0;">Atenção:</p>
                        <p style="color: white; margin: 0; font-size: 14px;">Esta operação não pode ser desfeita. As embalagens serão convertidas em porções menores com o peso especificado.</p>
                    </div>
                </div>
            </div>
            
            <!-- Botões -->
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" onclick="closeFracionarEmbalagemModal()" style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid #ccc; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'">Cancelar</button>
                <button type="button" id="confirmarFracionamentoEmbalagem" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">Fracionar por Peso</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Novo Fornecedor -->
<div id="novoFornecedorModal" class="modal" style="display: none;">
    <div class="modal-content custom-scrollbar" style="max-width: 600px; max-height: 60vh; overflow-y: auto;">
        <span class="close-button" onclick="closeNovoFornecedorModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2 style="color: #9B64E3; margin-bottom: 20px;">Cadastrar Novo Fornecedor</h2>
        <div class="modal-body">
            <form id="novoFornecedorForm">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Informações Básicas -->
                    <div style="margin-bottom: 10px;">
                        <h3 style="color: #9B64E3; font-size: 16px; margin-bottom: 10px;">Informações Básicas</h3>
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorNome">Nome:</label>
                        <input type="text" id="fornecedorNome" name="fornecedorNome" required style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorCNPJ">CNPJ:</label>
                        <input type="text" id="fornecedorCNPJ" name="fornecedorCNPJ" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorTelefone">Telefone:</label>
                        <input type="text" id="fornecedorTelefone" name="fornecedorTelefone" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorEmail">Email:</label>
                        <input type="email" id="fornecedorEmail" name="fornecedorEmail" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorWebsite">Website:</label>
                        <input type="url" id="fornecedorWebsite" name="fornecedorWebsite" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease; background-color: rgba(155, 100, 227, 0.05);" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorCategoriaProdutos">Categoria de Produtos:</label>
                        <input type="text" id="fornecedorCategoriaProdutos" name="fornecedorCategoriaProdutos" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    
                    <!-- Endereço -->
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <h3 style="color: #9B64E3; font-size: 16px; margin-bottom: 10px;">Endereço</h3>
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorCEP">CEP:</label>
                        <input type="text" id="fornecedorCEP" name="fornecedorCEP" oninput="buscarEnderecoPorCEP(this.value)" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorEndereco">Endereço:</label>
                        <input type="text" id="fornecedorEndereco" name="fornecedorEndereco" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorCidade">Cidade:</label>
                        <input type="text" id="fornecedorCidade" name="fornecedorCidade" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorEstado">Estado:</label>
                        <input type="text" id="fornecedorEstado" name="fornecedorEstado" maxlength="2" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    
                    <!-- Contato -->
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <h3 style="color: #9B64E3; font-size: 16px; margin-bottom: 10px;">Informações de Contato</h3>
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorContatoNome">Nome do Contato:</label>
                        <input type="text" id="fornecedorContatoNome" name="fornecedorContatoNome" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorContatoTelefone">Telefone do Contato:</label>
                        <input type="text" id="fornecedorContatoTelefone" name="fornecedorContatoTelefone" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorContatoEmail">Email do Contato:</label>
                        <input type="email" id="fornecedorContatoEmail" name="fornecedorContatoEmail" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    
                    <!-- Condições Comerciais -->
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <h3 style="color: #9B64E3; font-size: 16px; margin-bottom: 10px;">Condições Comerciais</h3>
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorPrazoEntrega">Prazo de Entrega:</label>
                        <input type="text" id="fornecedorPrazoEntrega" name="fornecedorPrazoEntrega" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorCondicoesPagamento">Condições de Pagamento:</label>
                        <input type="text" id="fornecedorCondicoesPagamento" name="fornecedorCondicoesPagamento" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="width: 70%;">
                        <label for="fornecedorObservacoes">Observações:</label>
                        <textarea id="fornecedorObservacoes" name="fornecedorObservacoes" rows="3" style="width: 100%; border: 1px solid #9B64E3; border-radius: 4px; padding: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 0 5px rgba(155, 100, 227, 0.5)'" onmouseout="this.style.boxShadow='none'"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Fornecedor</button>
            </form>
        </div>
    </div>
</div>
 </div>
