<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Midnight (Completo iOS 12)</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Midnight PDV">
    <meta name="description" content="Sistema PDV para iPad - Midnight Desenvolvimento">
    <meta name="theme-color" content="#9B64E3">
    <meta name="background-color" content="#ffffff">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS Safari PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Midnight PDV">
    
    <!-- Status Bar personalizada para PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-navbutton-color" content="#9B64E3">
    <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/static/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/static/icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="/static/icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512x512.png">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-72x72.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#9B64E3">
    <meta name="msapplication-TileImage" content="/static/icons/icon-144x144.png">
    <style>
        :root {
            --primary-color: #9B64E3;
            --primary-dark: #7B4AC3;
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --background-dark: #1a1a2e;
            --card-bg: rgba(155, 100, 227, 0.05);
            --border-color: #9B64E3;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-dark);
            color: var(--text-color);
            /* Padding para status bar em modo PWA */
            padding-top: env(safe-area-inset-top);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation; /* Previne zoom por duplo toque */
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* iOS Safari */
            user-select: none; /* Padrão */
        }

        /* PWA Status Bar Personalizada */
        @supports (padding-top: env(safe-area-inset-top)) {
            /* Detectar modo PWA (standalone) */
            @media all and (display-mode: standalone) {
                body {
                    padding-top: 0; /* Reset do padding */
                }
                
                /* Status bar customizada com mesma aparência da navbar */
                body::before {
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: env(safe-area-inset-top, 20px);
                    background: rgba(44, 11, 90, 0.85);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    z-index: 9999;
                    pointer-events: none;
                }
                

                
                /* Ajustar conteúdo para não ficar atrás da status bar */
                .pdv-container {
                    margin-top: calc(60px + env(safe-area-inset-top, 20px));
                }
                
                .navbar {
                    top: env(safe-area-inset-top, 20px);
                }
            }
        }

        /* Fallback para dispositivos que não suportam safe-area-inset */
        @media all and (display-mode: standalone) {
            body::before {
                height: 20px; /* Altura padrão da status bar */
                background: linear-gradient(135deg, #9B64E3 0%, #7B4AC3 100%);
            }
        }

        /* CSS específico para iPad em modo PWA */
        @media only screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 1) and (display-mode: standalone),
               only screen and (device-width: 1024px) and (device-height: 768px) and (-webkit-device-pixel-ratio: 1) and (display-mode: standalone) {
            /* iPad Air 1 específico */
            body::before {
                height: 20px;
                background: #9B64E3;
            }
        }

        /* Estilos específicos para modo PWA */
        body.pwa-mode {
            /* Otimizações para modo standalone */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body.pwa-mode .navbar {
            /* Navbar com fundo translúcido da marca em modo PWA */
            background: rgba(44, 11, 90, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            /* Efeito de luz linear desfocada na borda inferior */
            box-shadow: 
                0 2px 10px rgba(44, 11, 90, 0.3),
                0 8px 25px rgba(44, 11, 90, 0.4),
                0 0 40px rgba(44, 11, 90, 0.2),
                0 0 80px rgba(44, 11, 90, 0.1);
            /* Posicionar logo após a status bar */
            top: env(safe-area-inset-top, 20px);
        }

        body.pwa-mode .pdv-container {
            /* Ajustar margin-top para considerar tanto status bar quanto navbar */
            margin-top: calc(60px + env(safe-area-inset-top, 20px));
        }

        /* Estilos para modo browser normal */
        body.browser-mode .navbar {
            /* Manter estilo padrão da navbar para navegador */
            background: rgba(44, 11, 90, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            /* Efeito de luz linear desfocada na borda inferior */
            box-shadow: 
                0 2px 10px rgba(44, 11, 90, 0.3),
                0 8px 25px rgba(44, 11, 90, 0.4),
                0 0 40px rgba(44, 11, 90, 0.2),
                0 0 80px rgba(44, 11, 90, 0.1);
            top: 0;
        }
        
        html {
            margin: 0;
            padding: 0;
            background: var(--background-dark);
        }

        .pdv-container {
            padding: 20px;
            margin-top: 60px;
            background: var(--background-dark);
            min-height: calc(100vh - 60px);
        }

        .pdv-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }

        @media (max-width: 768px) {
            .pdv-content {
                grid-template-columns: 1fr;
            }
        }

        .product-list {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .search-container {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(44, 11, 90, 0.85);
            border-radius: 8px;
            border: 1px solid rgba(155, 100, 227, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 2px 15px rgba(155, 100, 227, 0.3);
        }
        
        /* Barra de busca em modo PWA */
        body.pwa-mode .search-container {
            background: rgba(44, 11, 90, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(155, 100, 227, 0.7);
            box-shadow: 0 2px 15px rgba(155, 100, 227, 0.3);
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(155, 100, 227, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .search-buttons {
            display: flex;
            gap: 8px;
        }

        .barcode-btn {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: rgba(155, 100, 227, 0.1);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .barcode-btn:hover {
            background: rgba(155, 100, 227, 0.2);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 250px);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-right: 8px;
        }

        /* Scroll customizado para lista de produtos */
        .products-grid::-webkit-scrollbar {
            width: 8px;
        }

        .products-grid::-webkit-scrollbar-track {
            background: rgba(155, 100, 227, 0.15);
            border-radius: 4px;
            margin: 4px;
        }

        .products-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #9B64E3 0%, #7B4AC3 100%);
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(155, 100, 227, 0.3);
            transition: all 0.3s ease;
        }

        .products-grid::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #A970E8 0%, #8A50D0 100%);
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(155, 100, 227, 0.4);
        }

        .products-grid::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #7B4AC3 0%, #5B2A83 100%);
        }

        .product-card {
            background: rgba(82, 40, 136, 0.4);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(155, 100, 227, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(155, 100, 227, 0.4);
            background: rgba(82, 40, 136, 0.6);
        }

        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            background: #f0f0f0;
            position: relative;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            transition: opacity 0.3s ease;
        }

        /* Loading indicator para imagens dos produtos */
        .product-image-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(155, 100, 227, 0.2);
            border: 2px solid rgba(155, 100, 227, 0.4);
            border-radius: 6px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(155, 100, 227, 0.3);
            border-top: 4px solid #9B64E3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: #9B64E3;
            font-size: 12px;
            margin-top: 8px;
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .loading-progress {
            color: #9B64E3;
            font-size: 14px;
            font-weight: bold;
            margin-top: 4px;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estado quando a imagem carregou */
        .product-image.loaded .product-image-loading {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .product-image.loaded img {
            opacity: 1;
        }

        .product-image img {
            opacity: 0;
        }

        /* Estado de erro na imagem */
        .product-image.image-error .product-image-loading {
            background: rgba(244, 67, 54, 0.1);
            border: 1px dashed rgba(244, 67, 54, 0.3);
        }

        .product-image.image-error .loading-text {
            color: rgba(244, 67, 54, 0.8);
        }

        /* Estado de timeout na imagem */
        .product-image.image-timeout .product-image-loading {
            background: rgba(255, 193, 7, 0.1);
            border: 1px dashed rgba(255, 193, 7, 0.3);
        }

        .product-image.image-timeout .loading-text {
            color: rgba(255, 193, 7, 0.8);
        }

        .product-name {
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .product-price {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1rem;
            margin: 0;
        }

        .product-stock {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 34px;
            height: 34px;
            border: none;
            background: rgba(155, 100, 227, 0.2);
            border: 1px solid #9B64E3;
            color: #9B64E3;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .favorite-btn svg {
            width: 24px !important;
            height: 24px !important;
            pointer-events: none;
            min-width: 24px;
            min-height: 24px;
        }

        .favorite-btn:hover {
            background: rgba(155, 100, 227, 0.3);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .favorite-btn.active svg {
            fill: #ff6b6b;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .quantity-btn {
            width: 36px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: rgba(155, 100, 227, 0.1);
            color: var(--text-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background: rgba(155, 100, 227, 0.2);
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9rem;
        }

        .add-to-cart-btn {
            background: rgba(155, 100, 227, 0.2);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 28px;
        }

        .add-to-cart-btn:hover {
            background: rgba(155, 100, 227, 0.3);
        }

        .cart-panel {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px 20px 15px 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.1);
            height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .cart-panel {
                height: calc(100vh - 150px);
                padding: 15px 15px 10px 15px;
                gap: 8px;
            }
        }

        .cart-title {
            color: var(--text-color);
            margin: 0;
            font-size: 1.2em;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(155, 100, 227, 0.3);
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .cart-title {
                font-size: 1.1em;
                padding-bottom: 8px;
            }
        }

        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 25px;
            flex: 1 1 auto;
            min-height: 0;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .cart-items::-webkit-scrollbar {
            width: 6px;
        }

        .cart-items::-webkit-scrollbar-track {
            background: rgba(155, 100, 227, 0.12);
            border-radius: 3px;
            margin: 2px;
        }

        .cart-items::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #9B64E3 0%, #7B4AC3 100%);
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(155, 100, 227, 0.25);
            transition: all 0.2s ease;
        }

        .cart-items::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #A970E8 0%, #8A50D0 100%);
            transform: scaleX(1.2);
            box-shadow: 0 2px 6px rgba(155, 100, 227, 0.35);
        }

        .cart-items::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #7B4AC3 0%, #5B2A83 100%);
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .cart-items {
                max-height: 180px;
                gap: 8px;
            }
            
            .products-grid {
                max-height: calc(100vh - 200px);
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
                padding: 8px;
            }
            
            /* Scrollbars mais finos em dispositivos móveis */
            .products-grid::-webkit-scrollbar {
                width: 6px;
            }
            
            .cart-items::-webkit-scrollbar {
                width: 4px;
            }
            
            /* Cores mais vibrantes em dispositivos móveis para melhor visibilidade */
            .products-grid::-webkit-scrollbar-thumb,
            .cart-items::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #A970E8 0%, #8A50D0 100%);
                box-shadow: 0 2px 4px rgba(155, 100, 227, 0.4);
            }
        }
        
        /* Estilos para dispositivos touch */
        @media (pointer: coarse) {
            .products-grid::-webkit-scrollbar-thumb,
            .cart-items::-webkit-scrollbar-thumb {
                min-height: 40px; /* Área mínima para toque */
            }
        }
        
        /* Indicadores de scroll - gradientes de fade */
        .products-grid-container {
            position: relative;
        }
        
        .products-grid-container::before,
        .products-grid-container::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 20px;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .products-grid-container::before {
            top: 0;
            background: linear-gradient(to bottom, var(--background-dark) 0%, transparent 100%);
        }
        
        .products-grid-container::after {
            bottom: 0;
            background: linear-gradient(to top, var(--background-dark) 0%, transparent 100%);
        }
        
        .products-grid-container.show-scroll-top::before {
            opacity: 0.8;
        }
        
        .products-grid-container.show-scroll-bottom::after {
            opacity: 0.8;
        }
        
        /* Indicador de scroll para carrinho */
        .cart-panel {
            position: relative;
        }
        
        .cart-panel::after {
            content: '';
            position: absolute;
            bottom: 130px; /* Acima dos totais */
            left: 0;
            right: 0;
            height: 15px;
            background: linear-gradient(to top, rgba(26, 26, 46, 0.9) 0%, transparent 100%);
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cart-panel.show-cart-scroll::after {
            opacity: 1;
        }

        .cart-item {
            background: rgba(82, 40, 136, 0.2);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border: 1px solid rgba(155, 100, 227, 0.3);
            position: relative;
            min-height: 80px;
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .cart-item {
                padding: 8px;
                min-height: 65px;
                gap: 8px;
                margin-bottom: 4px;
            }
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .cart-item-name {
            color: var(--text-color);
            font-size: 0.9em;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cart-item-price {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin: 2px 0 5px 0;
        }

        .cart-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
        }

        .cart-quantity-btn {
            width: 24px;
            height: 24px;
            border: 1px solid var(--border-color);
            background: rgba(155, 100, 227, 0.1);
            color: var(--text-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .cart-quantity {
            color: var(--text-color);
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            font-size: 0.9em;
        }

        .cart-item-total {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.95em;
            text-align: right;
            margin-left: 12px;
            white-space: nowrap;
        }

        .cart-item-remove {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: rgba(255, 50, 50, 0.8);
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .cart-item-remove:hover {
            background: rgba(255, 50, 50, 0.2);
        }

        .discount-section {
            padding: 15px;
            background: rgba(82, 40, 136, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(155, 100, 227, 0.3);
            margin-top: 10px;
            flex-shrink: 0;
            min-height: auto;
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .discount-section {
                padding: 10px;
                min-height: auto;
                margin-top: 8px;
            }
        }

        .discount-title {
            color: var(--text-color);
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .discount-type-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .discount-type-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            background: rgba(155, 100, 227, 0.1);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
        }

        .discount-type-btn.active {
            background: rgba(155, 100, 227, 0.3);
            border-color: var(--primary-color);
        }

        .discount-input-container {
            margin-bottom: 10px;
        }

        .discount-input {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 4px;
            font-size: 0.9em;
            box-sizing: border-box;
        }

        .discount-info {
            color: var(--text-secondary);
            font-size: 0.8em;
            display: none;
        }

        .cart-summary {
            flex-shrink: 0;
            margin-top: 15px;
            margin-bottom: 0;
            padding-top: 15px;
            padding-bottom: 0;
            border-top: 1px solid rgba(155, 100, 227, 0.3);
            min-height: auto;
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .cart-summary {
                margin-top: 8px;
                margin-bottom: 0;
                padding-top: 8px;
                padding-bottom: 0;
                min-height: auto;
            }
        }

        .subtotal-row, .discount-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .discount-row {
            color: #4ade80;
            display: none;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color);
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .cart-total-value {
            color: var(--primary-color);
            font-weight: bold;
        }

        .checkout-btn {
            width: 100%;
            padding: 12px;
            background: rgba(155, 100, 227, 0.2);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            margin-top: 10px;
            margin-bottom: 0;
        }

        /* Otimização para iPad 1024x768 em modo paisagem */
        @media (max-width: 1024px) and (max-height: 768px) {
            .checkout-btn {
                padding: 10px;
                font-size: 0.95em;
                margin-top: 8px;
                margin-bottom: 0;
            }
        }

        .checkout-btn:hover:not(:disabled) {
            background: rgba(155, 100, 227, 0.3);
        }

        .checkout-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cart-empty {
            color: var(--text-secondary);
            text-align: center;
            padding: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Modal Styles com Animações Fade */
        .modal-overlay {
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            height: calc(100vh - 60px);
            background-color: rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            padding: 20px 0;
            box-sizing: border-box;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal-overlay.closing {
            opacity: 0;
        }

        .checkout-modal {
            background-color: rgba(44, 11, 90, 0.85);
            color: white;
            border: 1px solid rgba(155, 100, 227, 0.7);
            border-radius: 12px;
            max-width: 800px;
            width: 95%;
            max-height: calc(100vh - 160px);
            margin: 20px auto;
            overflow-y: auto;
            position: relative;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 2px 15px rgba(155, 100, 227, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .modal-overlay.show .checkout-modal {
            transform: scale(1) translateY(0px);
            opacity: 1;
        }
        
        /* Garantia adicional para evitar truncamento */
        .checkout-modal {
            min-height: 0;
            box-sizing: border-box;
        }
        
        /* Modal em modo PWA */
        body.pwa-mode .modal-overlay {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        body.pwa-mode .checkout-modal {
            background-color: rgba(44, 11, 90, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(155, 100, 227, 0.7);
            box-shadow: 0 2px 15px rgba(155, 100, 227, 0.3);
        }

        .modal-header {
            padding: 0 0 15px 0;
            border-bottom: 1px solid rgba(155, 100, 227, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            color: white;
            margin: 0;
            font-size: 1.3em;
            font-weight: bold;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: absolute;
            right: 15px;
            top: 15px;
        }

        .modal-close:hover {
            color: #9B64E3;
            text-shadow: 0 0 8px rgba(155, 100, 227, 0.8);
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 0;
        }

        .checkout-section {
            background: rgba(155, 100, 227, 0.05);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(155, 100, 227, 0.2);
        }

        .section-title {
            color: white;
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(155, 100, 227, 0.3);
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .payment-method {
            padding: 8px;
            border: 1px solid rgba(155, 100, 227, 0.3);
            border-radius: 6px;
            background: rgba(82, 40, 136, 0.2);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            text-align: center;
        }

        .payment-method:hover {
            background: rgba(155, 100, 227, 0.2);
            border-color: var(--primary-color);
        }

        .payment-method.selected {
            background: rgba(155, 100, 227, 0.3);
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(155, 100, 227, 0.4);
        }

        .payment-method-icon {
            font-size: 1.5em;
        }

        .installment-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .installment-value {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px;
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: center;
        }

        .installment-option {
            padding: 6px 8px;
            border: 1px solid rgba(155, 100, 227, 0.3);
            border-radius: 4px;
            background: rgba(82, 40, 136, 0.2);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8em;
            text-align: center;
        }

        .installment-option:hover {
            background: rgba(155, 100, 227, 0.2);
        }

        .installment-option.selected {
            background: rgba(155, 100, 227, 0.3);
            border-color: var(--primary-color);
        }

        .cash-input {
            width: 65%;
            max-width: 200px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1em;
            margin-bottom: 10px;
        }

        .troco-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 4px;
            color: #22c55e;
        }

        .troco-display.negative {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .troco-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .troco-value.negative {
            color: #ef4444;
        }

        .seller-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1em;
        }

        .order-summary-container {
            display: flex;
            flex-direction: column;
            max-height: 350px;
            border: 1px solid rgba(155, 100, 227, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .order-items-list {
            flex: 1;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 2px solid rgba(155, 100, 227, 0.3);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .order-items-list::-webkit-scrollbar {
            width: 6px;
        }

        .order-items-list::-webkit-scrollbar-track {
            background: rgba(155, 100, 227, 0.15);
            border-radius: 3px;
        }

        .order-items-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #9B64E3 0%, #7B4AC3 100%);
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(155, 100, 227, 0.25);
            transition: all 0.2s ease;
        }

        .order-items-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #A970E8 0%, #8A50D0 100%);
            box-shadow: 0 2px 6px rgba(155, 100, 227, 0.35);
        }

        .order-totals {
            flex-shrink: 0;
            padding: 10px;
            background: rgba(82, 40, 136, 0.1);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(155, 100, 227, 0.2);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-info {
            flex: 1;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .order-item-price {
            color: var(--primary-color);
            font-weight: bold;
        }

        .modal-actions {
            padding: 20px;
            border-top: 1px solid rgba(155, 100, 227, 0.3);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-shrink: 0;
        }

        .modal-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-height: 50px;
        }

        .modal-btn.cancel {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .modal-btn.cancel:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .modal-btn.confirm {
            background: rgba(155, 100, 227, 0.2);
            border: 1px solid #9B64E3;
            color: white;
        }

        .modal-btn.confirm:hover:not(:disabled) {
            background: #9B64E3;
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.8);
        }

        .modal-btn.confirm:disabled {
            background: rgba(155, 100, 227, 0.1);
            border-color: rgba(155, 100, 227, 0.3);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal de notificação PDV */
        #pdvNotificationModal {
            z-index: 3000 !important;
        }

        .pdv-notification-modal {
            background-color: rgba(59, 12, 121, 0.85);
            color: white;
            border: 2px solid #9B64E3;
            border-radius: 20px;
            padding: 40px 30px 30px 30px;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            margin: 5% auto;
            box-shadow: 0 15px 35px rgba(155, 100, 227, 0.3);
            position: relative;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            text-align: center;
            animation: modalPulse 0.5s ease-in-out;
        }

        .pdv-notification-modal .close-button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: absolute;
            right: 15px;
            top: 15px;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdv-notification-modal .close-button:hover {
            background: rgba(155, 100, 227, 0.2);
            color: #9B64E3;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(155, 100, 227, 0.4);
        }

        .pdv-notification-modal h2 {
            color: white;
            font-size: 1.8em;
            font-weight: bold;
            margin: 20px 0 15px 0;
            border-bottom: none;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .pdv-notification-modal p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.2em;
            margin-bottom: 25px;
            line-height: 1.5;
            white-space: pre-line;
        }

        .pdv-notification-modal.success h2 {
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .pdv-notification-modal.error h2 {
            color: #F44336;
            text-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }

        .pdv-notification-modal .modal-btn {
            background: linear-gradient(135deg, #9B64E3, #7B46C8);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(155, 100, 227, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pdv-notification-modal .modal-btn:hover {
            background: linear-gradient(135deg, #7B46C8, #5A2D9F);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 100, 227, 0.4);
        }

        .pdv-notification-modal .modal-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(155, 100, 227, 0.3);
        }

        @keyframes modalPulse {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.02);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Modal de Imagem Completa */
        #imageModal {
            z-index: 4000 !important;
        }

        .image-modal-content {
            background-color: rgba(59, 12, 121, 0.95);
            border: 2px solid #9B64E3;
            border-radius: 20px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            margin: 2% auto;
            position: relative;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            text-align: center;
            animation: modalPulse 0.4s ease-in-out;
            overflow: hidden;
        }

        .image-modal-content .close-button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 32px;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .image-modal-content .close-button:hover {
            background: rgba(155, 100, 227, 0.3);
            color: #9B64E3;
            transform: scale(1.1);
        }

        .modal-image-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px 20px 20px;
        }

        .modal-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .modal-image-title {
            color: white;
            font-size: 1.4em;
            font-weight: bold;
            margin: 15px 0 0 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Estilos para dropdowns customizados */
        .custom-select {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            position: relative;
            z-index: 1000;
            isolation: isolate;
        }

        .custom-select > button {
            padding: 10px 35px 10px 10px;
            background: transparent;
            border: none;
            color: white;
            text-align: left;
            font-size: 0.9em;
            width: 100%;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-sizing: border-box;
        }

        .custom-select > button:after {
            content: "▼";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9B64E3;
            font-size: 0.8em;
            pointer-events: none;
        }

        .custom-select > div {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 0;
            transition: height 0.3s ease-in-out;
            position: absolute;
            width: calc(100% - 12px);
            left: 6px;
            background-color: rgba(59, 12, 121, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            margin-top: 5px;
            z-index: 10001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 1px solid #9B64E3;
        }

        .custom-select > div > a {
            display: block;
            padding: 10px;
            color: white;
            cursor: pointer;
            text-decoration: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .custom-select > div > a:hover {
            background-color: rgba(155, 100, 227, 0.3);
        }

        .custom-select > div > a:first-child {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .custom-select > div > a:last-child {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .custom-select:hover > div,
        .custom-select:focus-within > div {
            height: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        .custom-select.open > div {
            height: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Ícone de favoritos - Estilo PDV Original */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(155, 100, 227, 0.2);
            border: 1px solid #9B64E3;
            color: #9B64E3;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .favorite-btn svg {
            width: 24px !important;
            height: 24px !important;
            pointer-events: none;
            min-width: 24px;
            min-height: 24px;
        }

        .favorite-btn:hover {
            background: rgba(155, 100, 227, 0.3);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .favorite-btn.active svg {
            fill: #ff6b6b;
        }

        .favorite-btn.active:hover {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        /* Otimização para iPad (1024x768) */
        @media (max-width: 1024px) and (max-height: 768px) {
            .checkout-modal {
                max-width: 900px;
                max-height: calc(100vh - 140px);
                padding: 15px;
                margin: 15px auto;
            }
            
            .checkout-content {
                gap: 12px;
            }
            
            .checkout-section {
                padding: 10px;
            }
            
            .section-title {
                font-size: 0.95em;
                margin-bottom: 8px;
            }
            
            .payment-method {
                padding: 6px;
                font-size: 0.85em;
            }
            
            .installment-options {
                grid-template-columns: repeat(6, 1fr);
                gap: 4px;
            }
            
            .installment-option {
                padding: 4px 6px;
                font-size: 0.75em;
            }
        }

        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
        }
        
        /* Teclado Virtual - Bolha de Diálogo */
        .virtual-keyboard {
            position: absolute;
            z-index: 999999;
            padding: 20px;
            background: rgba(44, 11, 90, 0.85);
            border-radius: 16px;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid rgba(155, 100, 227, 0.7);
            box-shadow: 
                0 20px 50px rgba(155, 100, 227, 0.4), 
                0 10px 25px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: none;
            width: 280px;
            max-width: 90vw;
            -webkit-user-select: none;
            user-select: none;
            opacity: 0;
            transform: scale(0.9) translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        /* Teclado Virtual em modo PWA */
        body.pwa-mode .virtual-keyboard {
            background: rgba(44, 11, 90, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 2px solid rgba(155, 100, 227, 0.7);
            box-shadow: 
                0 20px 50px rgba(155, 100, 227, 0.4), 
                0 10px 25px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Animação de Entrada - Fade In */
        .virtual-keyboard.show {
            opacity: 1;
            transform: scale(1) translateY(0px);
        }
        
        /* Animação de Saída - Fade Out */
        .virtual-keyboard.closing {
            opacity: 0;
            transform: scale(0.9) translateY(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        
        /* Seta da bolha apontando para o input (à esquerda) */
        .virtual-keyboard::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            border-right: 12px solid #9B64E3;
            z-index: 1;
        }
        
        .virtual-keyboard::after {
            content: '';
            position: absolute;
            left: -9px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid rgba(44, 11, 90, 0.95);
            z-index: 2;
        }
        
        /* Seta da bolha quando está à esquerda do input (fallback) */
        .virtual-keyboard.bubble-left::before {
            left: auto;
            right: -12px;
            border-right: none;
            border-left: 12px solid #9B64E3;
        }
        
        .virtual-keyboard.bubble-left::after {
            left: auto;
            right: -9px;
            border-right: none;
            border-left: 10px solid rgba(44, 11, 90, 0.95);
        }
        
        /* Seta do teclado de desconto na borda direita apontando para a direita */
        .virtual-keyboard.keyboard-right-arrow::before {
            content: '';
            position: absolute;
            left: auto !important;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            border-right: none;
            border-left: 12px solid #9B64E3;
            z-index: 1;
        }
        
        .virtual-keyboard.keyboard-right-arrow::after {
            content: '';
            position: absolute;
            left: auto !important;
            right: -9px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: none;
            border-left: 10px solid rgba(44, 11, 90, 0.95);
            z-index: 2;
        }
        
        .keyboard-drag-handle:active {
            cursor: grabbing;
        }
        
        .keyboard-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }
        
        .keyboard-row:last-child {
            margin-bottom: 0;
        }
        
        .key-btn {
            flex: 1;
            max-width: 60px;
            height: 50px;
            background: linear-gradient(145deg, #9B64E3 0%, #7B3CB0 100%);
            border: 1px solid #B983F0;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(155, 100, 227, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .key-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 100, 227, 0.6);
            background: linear-gradient(145deg, #A874E8 0%, #8B4BC7 100%);
            border-color: #C094FF;
        }
        
        .key-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(155, 100, 227, 0.4);
            background: linear-gradient(145deg, #8E56D6 0%, #6E329C 100%);
        }
        
        .key-btn.action-btn {
            background: linear-gradient(145deg, #E74C3C 0%, #C0392B 100%);
            border-color: #F1948A;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }
        
        .key-btn.action-btn:hover {
            background: linear-gradient(145deg, #EC7063 0%, #CD6155 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
            border-color: #F5B7B1;
        }
        
        .key-btn.confirm-btn {
            flex: 1;
            max-width: none;
            background: linear-gradient(145deg, #27AE60 0%, #229954 100%);
            border-color: #58D68D;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        
        .key-btn.confirm-btn:hover {
            background: linear-gradient(145deg, #2ECC71 0%, #27AE60 100%);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
            border-color: #7DCEA0;
        }
        
        @media (max-width: 1024px) and (max-height: 768px) {
            .key-btn {
                height: 45px;
                font-size: 16px;
                max-width: 55px;
            }
        }
        
        @media (max-width: 768px) {
            .virtual-keyboard {
                margin-top: 10px;
                padding: 10px;
            }
            
            .key-btn {
                height: 40px;
                font-size: 16px;
                max-width: 50px;
            }
            
            .keyboard-row {
                gap: 8px;
                margin-bottom: 8px;
            }
        }
        
        /* Regras Especiais para Teclado Virtual */
        body.keyboard-open {
            overflow: visible !important;
        }
        
        .virtual-keyboard {
            pointer-events: auto !important;
            visibility: visible !important;
            isolation: isolate;
        }
        
        /* Previne que contêineres pais afetem o teclado */
        .modal-overlay,
        .checkout-modal,
        .pdv-container {
            overflow: visible !important;
        }
        
        /* Ajuste adicional para modal em dispositivos menores */
        @media (max-height: 600px) {
            .modal-overlay {
                top: 50px;
                height: calc(100vh - 50px);
                padding: 15px 0;
            }
            
            .checkout-modal {
                max-height: calc(100vh - 120px);
                margin: 10px auto;
            }
        }
        
        /* Garante que o teclado apareça em todos os dispositivos */
        @supports (position: fixed) {
            .virtual-keyboard {
                position: fixed !important;
                contain: layout style paint;
            }
        }
        
        /* Navbar Styles */
        .navbar {
            background-color: rgba(44, 11, 90, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            padding: 0.5rem 1.5rem;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            box-shadow: 0 2px 15px rgba(155, 100, 227, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1001;
            transition: transform 0.3s ease;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        
        .navbar-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .navbar-logo {
            height: 32px;
            width: auto;
        }
        
        .navbar-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .navbar-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        
        .navbar-btn:hover {
            background: rgba(155, 100, 227, 0.2);
            border-color: var(--primary-color);
        }
        
        .navbar-btn:active {
            transform: scale(0.95);
            background: rgba(155, 100, 227, 0.3);
        }

        .navbar-btn.refreshing {
            animation: spin 1s linear infinite;
        }
        
        /* Remover bordas e outline do botão refresh - especial para iPad */
        .navbar-btn {
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .navbar-btn:focus,
        .navbar-btn:active,
        .navbar-btn:hover {
            outline: none !important;
            border: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
            background: transparent !important;
        }
        
        /* Estilos do dropdown do usuário no PDV */
        .user-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .user-info-navbar {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .user-info-navbar:hover {
            background: rgba(155, 100, 227, 0.2);
        }
        
        .user-info-navbar:after {
            content: "▼";
            font-size: 8px;
            margin-left: 4px;
            transition: transform 0.3s ease;
            opacity: 0.7;
        }
        
        .user-info-navbar.active:after {
            transform: rotate(180deg);
        }
        
        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(68, 7, 148, 0.69);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid #9B64E3;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(155, 100, 227, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            margin-top: 5px;
        }
        
        .user-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-info {
            padding: 15px;
            border-bottom: 1px solid rgba(155, 100, 227, 0.3);
            display: flex;
            align-items: center;
            gap: 20px !important;
        }
        
        /* Regra mais específica para garantir o espaçamento */
        .user-dropdown-menu .user-info {
            gap: 20px !important;
        }
        
        .user-avatar-large {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(155, 100, 227, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .user-details {
            flex: 1;
            margin-left: 15px;
        }
        
        .user-name-large {
            font-weight: 600;
            color: white;
            font-size: 0.9em;
        }
        
        .dropdown-divider {
            height: 1px;
            background: rgba(155, 100, 227, 0.3);
        }
        
        .dropdown-item {
            display: block;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dropdown-item:hover {
            background: rgba(155, 100, 227, 0.2);
            border-left-color: #9B64E3;
            color: white;
        }
        
        .dropdown-item.logout-item:hover {
            background: rgba(220, 53, 69, 0.2);
            border-left-color: #dc3545;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Estilos dos modais do PDV */
        .modal {
            display: none;
            position: fixed;
            z-index: 10002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }
        
        /* Desfoque no conteúdo quando modal estiver aberto */
        body.modal-open .main-content,
        body.modal-open .navbar {
            filter: blur(3px);
            pointer-events: none;
        }

        .pdv-modal-content {
            max-width: 400px;
            text-align: center;
            padding: 30px;
            background: rgba(68, 7, 148, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid #9B64E3;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white;
        }

        .pdv-modal-content h2 {
            margin-top: 0;
            color: white;
            font-size: 1.5em;
        }

        .pdv-modal-content p {
            margin: 15px 0;
            font-size: 1.1em;
            line-height: 1.4;
        }

        .btn-primary, .btn-secondary {
            padding: 10px 20px;
            border: 2px solid #9B64E3;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: rgba(155, 100, 227, 0.2);
            color: white;
        }

        .btn-primary:hover {
            background: #9B64E3;
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Estilos do modal de login */
        .login-container {
            background: rgba(68, 7, 148, 0.69);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid #9B64E3;
            border-radius: 10px;
            padding: 30px;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .login-container .form-group {
            margin-bottom: 15px;
        }

        .login-container .form-group label {
            display: block;
            margin-bottom: 5px;
            width: 88%;
            margin-left: auto;
            margin-right: auto;
        }

        .login-container .form-group input {
            width: 80%;
            padding: 10px;
            border: 1px solid #9B64E3;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            display: block;
            margin: 0 auto;
        }

        .login-container .form-group input:focus {
            outline: none;
            border-color: #9B64E3;
            background-color: rgba(155, 100, 227, 0.1);
        }

        .login-container button[type="submit"] {
            width: 87%;
            padding: 10px;
            background-color: rgba(155, 100, 227, 0.1);
            color: white;
            border: 2px solid #9B64E3;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }

        .login-container button[type="submit"]:hover {
            background-color: #9B64E3;
        }

        .login-container .flash-messages {
            margin-bottom: 15px;
        }

        .login-container .flash-messages .alert {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .login-container .flash-messages .alert-success {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
        }

        .login-container .flash-messages .alert-danger {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
        }
        
        .login-container .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #9B64E3;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            position: relative;
            vertical-align: middle;
        }
        
        .login-container .form-group input[type="checkbox"]:checked {
            background-color: #9B64E3;
        }
        
        .login-container .form-group input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .login-container .form-group input[type="checkbox"]:hover {
            background-color: rgba(155, 100, 227, 0.1);
        }
        
        .login-container .btn-secondary {
            width: 87%;
            padding: 10px;
            background-color: rgba(155, 100, 227, 0.1);
            color: white;
            border: 2px solid #9B64E3;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }
        
        .login-container .btn-secondary:hover {
            background-color: #D8CEFE;
        }
        
        .user-info-navbar {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 6px 12px;
            background: rgba(155, 100, 227, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(155, 100, 227, 0.3);
        }
        
        .user-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: white;
            font-weight: 600;
            overflow: hidden;
            border: 2px solid rgba(155, 100, 227, 0.3);
        }
        
        .user-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-name-small {
            font-size: 0.9em;
            color: white;
            font-weight: 500;
            margin-left: 12px; /* Forçar espaçamento */
        }
        
        /* Transições suaves */
        .pdv-container {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-left">
            <!-- Espaço reservado -->
        </div>
        
        <div class="navbar-center">
            <img src="{{ url_for('static', filename='logo.svg') }}" alt="Logo Midnight" class="navbar-logo">
        </div>
        
        <div class="navbar-actions">
            <div class="user-dropdown">
                <div id="currentUserNavbar" class="user-info-navbar" onclick="toggleUserDropdown()">
                    <div id="userAvatarNavbar" class="user-avatar-small">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <span id="currentUserNameNavbar" class="user-name-small">Carregando...</span>
                </div>
                <div id="userDropdown" class="user-dropdown-menu">
                    <div class="user-info">
                        <div class="user-avatar-large">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="user-details">
                            <div id="dropdownUserName" class="user-name-large">Carregando...</div>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item" onclick="changeUser(); return false;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <path d="M20 8v6M23 11h-6"></path>
                        </svg>
                        Trocar Usuário
                    </a>
                    <a href="#" class="dropdown-item logout-item" onclick="logout(); return false;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Sair
                    </a>
                </div>
            </div>
            
            <button id="refreshBtn" class="navbar-btn" onclick="refreshProducts()" title="Atualizar Produtos">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Modal de Login para Troca de Usuário ou Logout -->
    <div id="loginModal" class="modal">
        <div class="login-container" style="position: relative; margin: 0; width: 300px;">
            <div class="logo-container" style="display: flex; justify-content: center; margin-bottom: 50px;">
                <svg width="200" height="200" viewBox="0 0 6.1344 6.8851" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="id0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(6.54315 -0 -0 6.54315 -20 -15)" cx="3.6891" cy="2.7778" r="1.6274" fx="3.6891" fy="2.7778">
                            <stop offset="0" style="stop-opacity:1; stop-color:#9B64E3"/>
                            <stop offset="0.54902" style="stop-opacity:1; stop-color:#0083E5"/>
                            <stop offset="1" style="stop-opacity:1; stop-color:#0083E5"/>
                        </radialGradient>
                        <radialGradient id="id1" gradientUnits="userSpaceOnUse" gradientTransform="matrix(6.54314 -0 -0 6.54315 -13 -13)" cx="2.3924" cy="2.3409" r="3.4425" fx="2.3924" fy="2.3409">
                            <stop offset="0" style="stop-opacity:1; stop-color:#9B64E3"/>
                            <stop offset="0.54902" style="stop-opacity:1; stop-color:#0083E5"/>
                            <stop offset="1" style="stop-opacity:1; stop-color:#0083E5"/>
                        </radialGradient>
                    </defs>
                    <g>
                        <path fill="url(#id0)" d="M4.7505 2.8756l0 1.6591 -0.5808 0 0 -0.5315 -0 -0.9108c-0.2144,0.3548 -0.4185,0.8135 -0.5863,1.4063l-0.5828 -1.0575 0 1.0935 -0.5808 0 0 -2.1483 0.5808 0 0.4854 0.8813c0,0 0.1785,-0.4961 0.6463,-0.911 0.3436,-0.305 0.7812,-0.4839 1.3164,-0.4839l0.1008 0.0023 0.1228 0.0078 0.0022 0c0,0 -0.4242,0.0278 -0.9239,0.4848l0 0.508z"/>
                        <path fill="url(#id1)" d="M3.4425 0c1.0897,0 2.061,0.5065 2.6918,1.2967 -0.5634,-0.586 -1.3553,-0.9508 -2.2325,-0.9508 -1.7102,0 -3.0966,1.3864 -3.0966,3.0966 0,1.6914 1.356,3.066 3.0402,3.0961 0.341,-0.0262 0.683,-0.074 0.9879,-0.1421 0.5005,-0.1577 0.9461,-0.4391 1.301,-0.8083 -0.6308,0.7902 -1.6021,1.2967 -2.6918,1.2967 -1.9013,0 -3.4425,-1.5413 -3.4425,-3.4425 0,-1.9013 1.5413,-3.4425 3.4425,-3.4425z"/>
                    </g>
                </svg>
            </div>
            
            <div id="loginMessages" class="flash-messages"></div>
            
            <form id="loginForm" onsubmit="handlePDVLogin(event)">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group" style="display: flex; align-items: center; margin-bottom: 20px; width: 67%; margin-left: 20px; margin-right: 20px;">
                    <input type="checkbox" id="keep_connected" name="keep_connected">
                    <label for="keep_connected" style="width: auto; margin: 0 0 0 8px;">Manter conectado</label>
                </div>
                <button type="submit" id="loginSubmitBtn">Entrar</button>
                <button type="button" class="btn-secondary" onclick="closeLoginModal()" style="margin-top: 10px;">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo do PDV -->
    <div class="pdv-container">
        <div class="pdv-content">
            <!-- Lista de Produtos -->
            <div class="product-list">
                <div class="search-container">
                    <input type="text" id="productSearch" class="search-input" placeholder="Buscar produtos...">
                </div>

                <!-- Status de carregamento -->
                <div id="loadingStatus" class="status-message" style="display: none;"></div>

                <!-- Grade de produtos -->
                <div id="productsGrid" class="products-grid">
                    <div class="loading">Carregando produtos...</div>
                </div>
            </div>

            <!-- Painel do Carrinho -->
            <div class="cart-panel">
                <h2 class="cart-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 5px;"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>Carrinho</h2>
                
                <div id="cartItems" class="cart-items">
                    <div class="cart-empty">
                        Carrinho vazio<br>
                        <small>Clique nos produtos para adicionar</small>
                    </div>
                </div>

                <!-- Seção de Desconto -->
                <div class="discount-section">
                    <div class="discount-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 5px;">
                            <line x1="19" y1="5" x2="5" y2="19"></line>
                            <circle cx="6.5" cy="6.5" r="2.5"></circle>
                            <circle cx="17.5" cy="17.5" r="2.5"></circle>
                        </svg>
                        Desconto
                    </div>
                    
                    <div class="discount-type-selector">
                        <button class="discount-type-btn active" data-type="percentage" onclick="setDiscountType('percentage')">%</button>
                        <button class="discount-type-btn" data-type="value" onclick="setDiscountType('value')">R$</button>
                    </div>
                    
                    <div class="discount-input-container">
                        <input type="tel" id="discountInput" class="discount-input" placeholder="0" step="0.01" min="0" max="100" readonly onclick="showVirtualKeyboardForDiscount()" ontouchstart="showVirtualKeyboardForDiscount()" onmousedown="showVirtualKeyboardForDiscount()" onfocus="showVirtualKeyboardForDiscount()">

                    </div>
                    
                    <div id="discountInfo" class="discount-info">
                        <span id="discountDescription">Desconto aplicado</span>
                    </div>
                </div>

                <div class="cart-summary">
                    <div id="cartSubtotal" class="subtotal-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotalValue">R$ 0,00</span>
                    </div>
                    
                    <div id="cartTroco" class="subtotal-row" style="display: none; color: #4ade80;">
                        <span>Troco:</span>
                        <span id="cartTrocoValue">R$ 0,00</span>
                    </div>
                    
                    <div id="discountRow" class="discount-row">
                        <span>Desconto:</span>
                        <span id="discountAmount">- R$ 0,00</span>
                    </div>
                    
                    <div class="cart-total">
                        <span>Total:</span>
                        <span id="cartTotal" class="cart-total-value">R$ 0,00</span>
                    </div>
                    
                    <button id="checkoutBtn" class="checkout-btn" onclick="checkout()" disabled>
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Checkout -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="checkout-modal">
            <div class="modal-header">
                <h2 class="modal-title">Finalizar Venda</h2>
                <button class="modal-close" onclick="closeCheckoutModal()">&times;</button>
            </div>

            <div class="checkout-content">
                <!-- Método de Pagamento -->
                <div class="checkout-section">
                    <div class="section-title">Método de Pagamento</div>
                    <div class="payment-methods">
                        <div class="payment-method" data-method="dinheiro" onclick="selectPaymentMethod('dinheiro')">
                            <div class="payment-method-icon">
                                <img src="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjZmZmZmZmIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTQuNzUgMi41SDEuMjVBMS4yNSAxLjI1IDAgMCAwIDAgMy43NXY4LjVhMS4yNSAxLjI1IDAgMCAwIDEuMjUgMS4yNWgxMy41QTEuMjUgMS4yNSAwIDAgMCAxNiAxMi4yNXYtOC41YTEuMjUgMS4yNSAwIDAgMC0xLjI1LTEuMjV6TTEuMjUgMy43NWgyYTEuODYgMS44NiAwIDAgMS0yIDEuNzV6bTAgOC41VjEwLjVhMS44NiAxLjg2IDAgMCAxIDIgMS43NXptMTMuNSAwSDEyLjhhMS44NiAxLjg2IDAgMCAxIDEuOTUtMS43NXptMC0zYTMuMSAzLjEgMCAwIDAtMy4yIDNoLTcuMWEzLjEgMy4xIDAgMCAwLTMuMi0zdi0yLjVhMy4xIDMuMSAwIDAgMCAzLjItM2g3LjFhMy4xIDMuMSAwIDAgMCAzLjIgM3ptMC0zLjc1YTEuODYgMS44NiAwIDAgMS0xLjk1LTEuNzVoMS45NXoiLz48cGF0aCBkPSJNOCA1YTMuMSAzLjEgMCAwIDAtMy4yIDNBMy4xIDMuMSAwIDAgMCA4IDExYTMuMSAzLjEgMCAwIDAgMy4yLTNBMy4xIDMuMSAwIDAgMCA4IDV6bTAgNC43NUExLjg2IDEuODYgMCAwIDEgNi4wNSA4IDEuODYgMS44NiAwIDAgMSA4IDYuMjUgMS44NiAxLjg2IDAgMCAxIDEwIDhhMS44NiAxLjg2IDAgMCAxLTIgMS43NXoiLz48L3N2Zz4=" alt="Dinheiro" style="width: 20px; height: 20px;">
                            </div>
                            Dinheiro
                        </div>
                        <div class="payment-method" data-method="debito" onclick="selectPaymentMethod('debito')">
                            <div class="payment-method-icon">
                                <img src="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB3aWR0aD0iMjQiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgNTAyLjY4NSA1MDIuNjg1IiBmaWxsPSIjZmZmZmZmIj48Zz48Zz48cGF0aCBkPSJNNDgyLjc5NywyNzYuOTI0YzQuNTMtNS44MjQsNi43My0xMy4zMzEsNC43MjQtMjAuOTg4TDQyOC4wNSwzMC41MjFjLTMuNDUxLTEzLjAyOS0xNi44NDctMjAuODM3LTI5Ljg1NC0xNy4zODZMMTguMTg0LDExMy4zMzFDNS4yMiwxMTYuNzYxLTIuNjEsMTMwLjIsMC43OTgsMTQzLjIwN0w2MC4yNjksMzY4LjZjMy40MDgsMTMuMDA3LDE2Ljg2OCwyMC44MTYsMjkuODc2LDE3LjQwOGwxMzQuMjc4LTM1LjQxOXY3NS40NzZjMCw0Mi4yMTQsNjkuOTU0LDY0LjMwMywxMzkuMTEsNjQuMzAzYzY5LjExMywwLDEzOS4xNTMtMjIuMDg5LDEzOS4xNTMtNjQuMzAyVjMxMS42MUM1MDIuNjg1LDI5Ny44NjksNDk1LjE1NywyODYuMzA3LDQ4Mi43OTcsMjc2LjkyNHogTTQzOS43NjMsMTk5LjIyNmw2LjIxMiwyMy40NjlsLTc1LjU0MSwxOS45NTNsLTYuMTY5LTIzLjUxMkw0MzkuNzYzLDE5OS4yMjZ6IE0zOTUuOTMxLDUwLjczM2wxMS43OTksNDQuNjk1bC0xMTguMDE0LDMxLjE0OGwtMTEuNzk5LTQ0LjY5NUwzOTUuOTMxLDUwLjczM3ogTTM0Mi45NzUsMjI0Ljc0NGw2LjA0LDIyLjk1MWMtMjcuOTM0LDEuMjUxLTU1LjExMyw2LjEyNi03Ni45NDMsMTQuNDUybC00LjYxNi0xNy40MjlMMzQyLjk3NSwyMjQuNzQ0eiBNNzkuOTg0LDMxOS4yMjRsLTYuMTY5LTIzLjQyNmw3NS41MTktMTkuOTc1bDYuMjEyLDIzLjU1NUw3OS45ODQsMzE5LjIyNHogTTE3MC42MjUsMjcwLjIzN2w3NS40NzYtMTkuOTUzbDUuNzE2LDIxLjUwNmMtMS44MzQsMS4xMjItMy41NTksMi4yODYtNS4yNDIsMy40NzNsLTY5Ljc4MSwxOC40MjFMMTcwLjYyNSwyNzAuMjM3eiBNNDc3LjQ5MSw0MjQuMjA5YzAsMjQuNjEyLTUwLjk5Myw0NC41NDQtMTEzLjk1OCw0NC41NDRjLTYyLjksMC0xMTMuOTM3LTE5Ljk1My0xMTMuOTM3LTQ0LjU0NHYtMjcuNzE4YzAtMC45MjgsMC41MzktMS43NjksMC42OS0yLjY1M2MzLjYwMiwyMy4zNCw1Mi42NTQsNDEuODQ3LDExMy4yNDcsNDEuODQ3YzYwLjYxNCwwLDEwOS42ODctMTguNTA4LDExMy4yNjgtNDEuODQ3YzAuMTUxLDAuODg0LDAuNjksMS43MjYsMC42OSwyLjY1M1Y0MjQuMjA5eiBNNDc3LjQ5MSwzNjkuNjc4YzAsMjQuNTkxLTUwLjk5Myw0NC41MjItMTEzLjk1OCw0NC41MjJjLTYyLjksMC0xMTMuOTM3LTE5LjkzMS0xMTMuOTM3LTQ0LjUyMlYzNDEuOTZjMC0wLjkwNiwwLjUzOS0xLjc2OSwwLjY5LTIuNjUzYzMuNjAyLDIzLjMxOCw1Mi42NTQsNDEuODY5LDExMy4yNDcsNDEuODY5YzYwLjYxNCwwLDEwOS42ODctMTguNTUxLDExMy4yNjgtNDEuODY5YzAuMTUxLDAuODg0LDAuNjksMS43NDcsMC42OSwyLjY1M1YzNjkuNjc4eiBNMzYzLjUzMiwzNTYuMTFjLTYyLjksMC0xMTMuOTM3LTE5LjkzMS0xMTMuOTM3LTQ0LjUwMWMwLTI0LjU2OSw1MS4wMzYtNDQuNSwxMTMuOTM3LTQ0LjVjNjIuOTY1LDAsMTEzLjk1OCwxOS45MzEsMTEzLjk1OCw0NC41QzQ3Ny40OTEsMzM2LjE3OSw0MjYuNDk3LDM1Ni4xMSwzNjMuNTMyLDM1Ni4xMXoiLz48L2c+PC9nPjwvc3ZnPg==" alt="Débito" style="width: 20px; height: 20px;">
                            </div>
                            Débito
                        </div>
                        <div class="payment-method" data-method="credito" onclick="selectPaymentMethod('credito')">
                            <div class="payment-method-icon">
                                <img src="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjZmZmZmZmIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgNTEyLjAwMiA1MTIuMDAyIj48Zz48Zz48Zz48cGF0aCBkPSJNNDgxLjUxOSwxMjMuMjJoLTAuMDA5bC0yMC43MS0yLjIyN3YtMTQuMzI3SDB2NTEuMmg0NDMuNzMzdjE3LjA2N0gwdjE3OS4yYzAsMTUuNDI4LDEwLjM1MSwyOC4zNDgsMjQuNDIyLDMyLjU2M2MtMC4wMDksNy43NzQsMi40NDksMTUuMjkyLDcuMzk4LDIxLjQzNmM1LjcxNyw3LjEsMTMuODY3LDExLjUzNywyMi44ODYsMTIuNTFsMzk0LjA2MSw0NC4yMjhjMS4yMjksMC4xMzcsMi40NDksMC4xOTYsMy42NjEsMC4xOTZjMTcuMjAzLDAsMzIuMDQzLTEzLjAxMywzMy45MzctMzAuNjAxbDI1LjQzOC0yNzMuNjU2QzUxMy44MTgsMTQyLjEwNCw1MDAuMjMzLDEyNS4yMzQsNDgxLjUxOSwxMjMuMjJ6IE0yNjQuNTMzLDI1Mi4wMzFjMC00LjcxOSwzLjgyMy04LjUzMyw4LjUzMy04LjUzM0g0MDkuNmM0LjcxLDAsOC41MzMsMy44MTQsOC41MzMsOC41MzN2NzYuNTAxYzAsNC43MTktMy44MjMsOC41MzMtOC41MzMsOC41MzNIMjczLjA2N2MtNC43MSwwLTguNTMzLTMuODE0LTguNTMzLTguNTMzVjI1Mi4wMzF6IE0xNDUuMDY3LDIwOS4wNjVoNjguMjY3YzQuNzEsMCw4LjUzMywzLjgyMyw4LjUzMyw4LjUzM2MwLDQuNzE5LTMuODIzLDguNTMzLTguNTMzLDguNTMzaC02OC4yNjdjLTQuNzEsMC04LjUzMy0zLjgxNC04LjUzMy04LjUzM0MxMzYuNTMzLDIxMi44ODgsMTQwLjM1NiwyMDkuMDY1LDE0NS4wNjcsMjA5LjA2NXogTTIyMS44NjcsMjUxLjczMmMwLDQuNzE5LTMuODIzLDguNTMzLTguNTMzLDguNTMzaC0yNS42Yy00LjcxLDAtOC41MzMtMy44MTQtOC41MzMtOC41MzNjMC00LjcxLDMuODIzLTguNTMzLDguNTMzLTguNTMzaDI1LjZDMjE4LjA0NCwyNDMuMTk5LDIyMS44NjcsMjQ3LjAyMiwyMjEuODY3LDI1MS43MzJ6IE00Mi42NjcsMjA5LjA2NWg2OC4yNjdjNC43MSwwLDguNTMzLDMuODIzLDguNTMzLDguNTMzYzAsNC43MTktMy44MjMsOC41MzMtOC41MzMsOC41MzNINDIuNjY3Yy00LjcxLDAtOC41MzMtMy44MTQtOC41MzMtOC41MzNDMzQuMTMzLDIxMi44ODgsMzcuOTU2LDIwOS4wNjUsNDIuNjY3LDIwOS4wNjV6IE0zNC4xMzMsMjUxLjczMmMwLTQuNzEsMy44MjMtOC41MzMsOC41MzMtOC41MzNIMTUzLjZjNC43MSwwLDguNTMzLDMuODIzLDguNTMzLDguNTMzYzAsNC43MTktMy44MjMsOC41MzMtOC41MzMsOC41MzNINDIuNjY3QzM3Ljk1NiwyNjAuMjY1LDM0LjEzMywyNTYuNDUxLDM0LjEzMywyNTEuNzMyeiBNNDk0LjgyMiwxNTkuMTAzTDQ2OS4zODUsNDMyLjc1Yy0xLjAwNyw5LjM2MS05LjM4NywxNi4xNTQtMTguNzU2LDE1LjE1NUw1Ni41NjcsNDAzLjY3N2MtNC41MzEtMC40ODYtOC42MDItMi43MDUtMTEuNDYtNi4yNTVjLTIuMTQyLTIuNjYyLTMuNDEzLTUuODI4LTMuNzEyLTkuMTU2aDM4NS4yNzFjMTguODI1LDAsMzQuMTMzLTE1LjMsMzQuMTMzLTM0LjEzM3YtMTc5LjJ2LTE3LjA2N3YtMTkuNzAzbDE4Ljg5MywyLjAyMkM0ODkuMDQ1LDE0MS4yLDQ5NS44MzgsMTQ5LjYzMSw0OTQuODIyLDE1OS4xMDN6Ii8+PHJlY3QgeD0iMjgxLjYwMiIgeT0iMjYwLjU2IiB3aWR0aD0iMTE5LjQ2NyIgaGVpZ2h0PSI1OS40NDMiLz48cGF0aCBkPSJNNDYwLjgwMiw4MS4wN2MwLTE4LjgyNS0xNS4zMDktMzQuMTMzLTM0LjEzMy0zNC4xMzNIMzQuMTM1Yy0xOC44MjUsMC0zNC4xMzMsMTUuMzA5LTM0LjEzMywzNC4xMzN2OC41MzNoNDYwLjhWODEuMDd6Ii8+PC9nPjwvZz48L2c+PC9zdmc+" alt="Crédito" style="width: 20px; height: 20px;">
                            </div>
                            Crédito
                        </div>
                        <div class="payment-method" data-method="pix" onclick="selectPaymentMethod('pix')">
                            <div class="payment-method-icon">
                                <img src="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjZmZmZmZmIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAxNiAxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTEuOTE3IDExLjcxYTIuMDQ2IDIuMDQ2IDAgMCAxLTEuNDU0LS42MDJsLTIuMS0yLjFhLjQuNCAwIDAgMC0uNTUxIDBsLTIuMTA4IDIuMTA4YTIuMDQ0IDIuMDQ0IDAgMCAxLTEuNDU0LjYwMmgtLjQxNGwyLjY2IDIuNjZjLjgzLjgzIDIuMTc3LjgzIDMuMDA3IDBsMi42NjctMi42NjhoLS4yNTN6TTQuMjUgNC4yODJjLjU1IDAgMS4wNjYuMjE0IDEuNDU0LjYwMmwyLjEwOCAyLjEwOGEuMzkuMzkgMCAwIDAgLjU1MiAwbDIuMS0yLjFhMi4wNDQgMi4wNDQgMCAwIDEgMS40NTMtLjYwMmguMjUzTDkuNTAzIDEuNjIzYTIuMTI3IDIuMTI3IDAgMCAwLTMuMDA3IDBsLTIuNjYgMi42NmguNDE0eiIvPjxwYXRoIGQ9Im0xNC4zNzcgNi40OTYtMS42MTItMS42MTJhLjMwNy4zMDcgMCAwIDEtLjExNC4wMjNoLS43MzNjLS4zNzkgMC0uNzUuMTU0LTEuMDE3LjQyMmwtMi4xIDIuMWExLjAwNSAxLjAwNSAwIDAgMS0xLjQyNSAwTDUuMjY4IDUuMzJhMS40NDggMS40NDggMCAwIDAtMS4wMTgtLjQyMmgtLjlhLjMwNi4zMDYgMCAwIDEtLjEwOS0uMDIxTDEuNjIzIDYuNDk2Yy0uODMuODMtLjgzIDIuMTc3IDAgMy4wMDhsMS42MTggMS42MThhLjMwNS4zMDUgMCAwIDEgLjEwOC0uMDIyaC45MDFjLjM4IDAgLjc1LS4xNTMgMS4wMTgtLjQyMUw3LjM3NSA4LjU3YTEuMDM0IDEuMDM0IDAgMCAxIDEuNDI2IDBsMi4xIDIuMWMuMjY3LjI2OC42MzguNDIxIDEuMDE3LjQyMWguNzMzYy4wNCAwIC4wNzkuMDEuMTE0LjAyNGwxLjYxMi0xLjYxMmMuODMtLjgzLjgzLTIuMTc4IDAtMy4wMDh6Ii8+PC9zdmc+" alt="PIX" style="width: 20px; height: 20px;">
                            </div>
                            PIX
                        </div>
                    </div>

                    <!-- Seção de Parcelas -->
                    <div id="installmentsSection" class="installments-section" style="display: none;">
                        <div class="section-subtitle">Parcelas</div>
                        <div class="installment-options">
                            <div class="installment-option" data-installments="1" onclick="selectInstallments(1)">À vista</div>
                            <div class="installment-option" data-installments="2" onclick="selectInstallments(2)">2x</div>
                            <div class="installment-option" data-installments="3" onclick="selectInstallments(3)">3x</div>
                            <div class="installment-option" data-installments="4" onclick="selectInstallments(4)">4x</div>
                            <div class="installment-option" data-installments="5" onclick="selectInstallments(5)">5x</div>
                            <div class="installment-option" data-installments="6" onclick="selectInstallments(6)">6x</div>
                            <div class="installment-option" data-installments="7" onclick="selectInstallments(7)">7x</div>
                            <div class="installment-option" data-installments="8" onclick="selectInstallments(8)">8x</div>
                            <div class="installment-option" data-installments="9" onclick="selectInstallments(9)">9x</div>
                            <div class="installment-option" data-installments="10" onclick="selectInstallments(10)">10x</div>
                            <div class="installment-option" data-installments="11" onclick="selectInstallments(11)">11x</div>
                            <div class="installment-option" data-installments="12" onclick="selectInstallments(12)">12x</div>
                        </div>
                    </div>

                    <!-- Seção de Dinheiro -->
                    <div id="cashSection" class="cash-section" style="display: none;">
                        <div class="section-subtitle">Valor Recebido</div>
                        <input type="tel" id="valorRecebido" class="cash-input" placeholder="R$ 0,00" readonly onfocus="showVirtualKeyboard()" onclick="showVirtualKeyboard()" ontouchstart="showVirtualKeyboard()">
                        
                        <!-- Teclado Virtual -->
                        <div id="virtualKeyboard" class="virtual-keyboard" style="display: none;">
                            <div class="keyboard-row">
                                <button class="key-btn" onclick="addDigit('1')">1</button>
                                <button class="key-btn" onclick="addDigit('2')">2</button>
                                <button class="key-btn" onclick="addDigit('3')">3</button>
                            </div>
                            <div class="keyboard-row">
                                <button class="key-btn" onclick="addDigit('4')">4</button>
                                <button class="key-btn" onclick="addDigit('5')">5</button>
                                <button class="key-btn" onclick="addDigit('6')">6</button>
                            </div>
                            <div class="keyboard-row">
                                <button class="key-btn" onclick="addDigit('7')">7</button>
                                <button class="key-btn" onclick="addDigit('8')">8</button>
                                <button class="key-btn" onclick="addDigit('9')">9</button>
                            </div>
                            <div class="keyboard-row">
                                <button class="key-btn action-btn" onclick="clearValue()">C</button>
                                <button class="key-btn" onclick="addDigit('0')">0</button>
                                <button class="key-btn action-btn" onclick="deleteDigit()">⌫</button>
                            </div>
                            <div class="keyboard-row">
                                <button class="key-btn confirm-btn" onclick="hideVirtualKeyboard()">✓ Confirmar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Vendedor removido do checkout -->
                </div>

                <!-- Resumo do Pedido -->
                <div class="checkout-section">
                    <div class="section-title">Resumo do Pedido</div>
                    <div class="order-summary-container">
                        <div class="order-items-list" id="orderItemsList">
                            <!-- Lista scrollável de itens -->
                        </div>
                        <div class="order-totals" id="orderTotals">
                            <!-- Subtotal, desconto, total fixos -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeCheckoutModal()">Cancelar</button>
                <button class="modal-btn confirm" id="confirmSaleBtn" onclick="confirmSale()" disabled>Confirmar Venda</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificação PDV -->
    <div id="pdvNotificationModal" class="modal" style="display: none;">
        <div class="pdv-notification-modal">
            <span class="close-button" onclick="closePdvNotificationModal()">&times;</span>
            <div id="pdvNotificationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;"></div>
            <h2 id="pdvNotificationModalTitle">Notificação</h2>
            <p id="pdvNotificationModalMessage">Mensagem da notificação</p>
            <div id="pdvNotificationDebugInfo" style="display: none; margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 0.9em; color: rgba(255, 255, 255, 0.8);"></div>
            <button class="modal-btn confirm" onclick="closePdvNotificationModal()">OK</button>
        </div>
    </div>

    <!-- Modal de Imagem Completa -->
    <div id="imageModal" class="modal" style="display: none;">
        <div class="image-modal-content">
            <span class="close-button" onclick="closeImageModal()">&times;</span>
            <div class="modal-image-container">
                <img id="modalImage" class="modal-image" src="" alt="Imagem do Produto">
            </div>
            <h3 id="modalImageTitle" class="modal-image-title"></h3>
        </div>
    </div>

    <script>
        // Variáveis globais ES5
        var products = [];
        var cart = [];
        var favorites = [];
        var usuarios = [];
        var selectedUserId = null;
        var usuarioLogado = null;
        var searchTimeout = null;

        var currentDiscount = {
            type: 'percentage',
            amount: 0,
            appliedValue: 0
        };

        var checkoutData = {
            paymentMethod: null,
            installments: 1,
            valorRecebido: 0,
            troco: 0
        };

        // SVG padrão para produtos - Sacolinha com cores da marca
        var defaultProductImage = 'data:image/svg+xml;base64,' + btoa(
            '<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">' +
                '<defs>' +
                    '<linearGradient id="bagGradient" x1="0%" y1="0%" x2="100%" y2="100%">' +
                        '<stop offset="0%" style="stop-color:#9B64E3;stop-opacity:1" />' +
                        '<stop offset="100%" style="stop-color:#2C0B5A;stop-opacity:1" />' +
                    '</linearGradient>' +
                '</defs>' +
                '<rect width="100" height="100" fill="#f8f6fc"/>' +
                '<!-- Sacolinha -->' +
                '<path d="M30 35 L70 35 L65 75 L35 75 Z" fill="url(#bagGradient)" stroke="#7B3CB0" stroke-width="1.5"/>' +
                '<!-- Alças -->' +
                '<path d="M38 35 C38 28, 45 25, 50 25 C55 25, 62 28, 62 35" fill="none" stroke="#7B3CB0" stroke-width="2" stroke-linecap="round"/>' +
                '<!-- Detalhe brilho -->' +
                '<path d="M35 40 L60 40" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>' +
                '<!-- Logo Midnight -->' +
                '<g transform="translate(42, 47) scale(2.6)">' +
                    '<path d="M4.75 2.88v1.66h-0.58v-0.53V2.97c-0.21,0.35-0.42,0.81-0.59,1.41l-0.58-1.06v1.09h-0.58V2.25h0.58l0.49,0.88s0.18-0.5,0.65-0.91c0.34-0.31,0.78-0.48,1.32-0.48h0.1l0.12,0.01s-0.42,0.03-0.92,0.48v0.51z" fill="#9B64E3"/>' +
                    '<path d="M3.44 0c1.09,0 2.06,0.51 2.69,1.3C5.5,0.71 4.71,0.35 3.83,0.35c-1.71,0-3.1,1.39-3.1,3.1 0,1.69 1.36,3.07 3.04,3.1 0.34-0.03 0.68-0.07 0.99-0.14 0.5-0.16 0.95-0.44 1.3-0.81C5.44,6.39 4.47,6.9 3.44,6.9c-1.9,0-3.44-1.54-3.44-3.44S1.54,0 3.44,0z" fill="#7B3CB0"/>' +
                '</g>' +
            '</svg>'
        );

        // Função de debug
        function debugLog(message) {
            console.log('[PDV-FULL] ' + message);
        }

        // Funções do dropdown do usuário
        function toggleUserDropdown() {
            var dropdown = document.getElementById('userDropdown');
            var navbar = document.getElementById('currentUserNavbar');
            
            if (dropdown && navbar) {
                var isVisible = dropdown.classList.contains('show');
                
                if (isVisible) {
                    dropdown.classList.remove('show');
                    navbar.classList.remove('active');
                } else {
                    dropdown.classList.add('show');
                    navbar.classList.add('active');
                }
            }
        }



        // Função para trocar usuário
        function changeUser() {
            showLoginModal();
        }

        // Função para logout
        function logout() {
            showLoginModal();
        }

        // Função para mostrar modal de login
        function showLoginModal() {
            var modal = document.getElementById('loginModal');
            modal.classList.add('show');
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            
            // Limpar formulário
            document.getElementById('loginForm').reset();
            document.getElementById('loginMessages').innerHTML = '';
        }

        // Função para fechar modal de login
        function closeLoginModal() {
            var modal = document.getElementById('loginModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        // Função para lidar com login no PDV
        function handlePDVLogin(event) {
            event.preventDefault();
            
            var username = document.getElementById('username').value;
            var password = document.getElementById('password').value;
            var messagesDiv = document.getElementById('loginMessages');
            var submitBtn = document.getElementById('loginSubmitBtn');
            
            if (!username || !password) {
                messagesDiv.innerHTML = '<div class="alert alert-danger">Por favor, preencha todos os campos.</div>';
                return;
            }
            
            // Desabilitar botão e mostrar loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Entrando...';
            
            // Enviar requisição de login
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/login', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Entrar';
                    
                    if (xhr.status === 200) {
                        // Login bem-sucedido - recarregar a página
                        messagesDiv.innerHTML = '<div class="alert alert-success">Login realizado com sucesso! Recarregando...</div>';
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // Erro no login
                        messagesDiv.innerHTML = '<div class="alert alert-danger">Credenciais inválidas. Tente novamente.</div>';
                    }
                }
            };
            
            var formData = 'username=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password);
            xhr.send(formData);
        }

        // Fechar dropdown ao clicar fora - melhorado
        document.addEventListener('click', function(event) {
            var userDropdown = document.querySelector('.user-dropdown');
            var dropdown = document.getElementById('userDropdown');
            var navbar = document.getElementById('currentUserNavbar');
            
            // Verificar se o clique foi fora do dropdown
            if (userDropdown && !userDropdown.contains(event.target)) {
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    if (navbar) navbar.classList.remove('active');
                }
            }
        });
        
        // Fechar dropdown ao pressionar ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                var dropdown = document.getElementById('userDropdown');
                var navbar = document.getElementById('currentUserNavbar');
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                    if (navbar) navbar.classList.remove('active');
                }
            }
        });

        // Funções utilitárias
        function formatCurrency(value) {
            return 'R$ ' + parseFloat(value).toFixed(2).replace('.', ',');
        }

        function unformatCurrency(value) {
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace(/[R$\s]/g, '').replace(',', '.')) || 0;
        }

        function formatCurrencyInput(input) {
            var value = input.value.replace(/[^\d]/g, '');
            if (value) {
                var number = parseInt(value) / 100;
                input.value = 'R$ ' + number.toFixed(2).replace('.', ',');
            }
        }

        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        function showError(message) {
            var loadingStatus = document.getElementById('loadingStatus');
            loadingStatus.innerHTML = message;
            loadingStatus.className = 'status-message status-error';
            loadingStatus.style.display = 'block';
        }

        function showSuccess(message) {
            var loadingStatus = document.getElementById('loadingStatus');
            loadingStatus.innerHTML = message;
            loadingStatus.className = 'status-message status-success';
            loadingStatus.style.display = 'block';
            setTimeout(function() {
                loadingStatus.style.display = 'none';
            }, 3000);
        }

        function getCartTotal() {
            var subtotal = 0;
            for (var i = 0; i < cart.length; i++) {
                subtotal += cart[i].preco * cart[i].quantity;
            }
            return subtotal - currentDiscount.appliedValue;
        }

        // Função para carregar usuários
        function loadUsuarios() {
            debugLog('👥 Carregando usuários...');
            
            // Testar se a API está disponível
            debugLog('🌐 Testando conexão com /api/usuarios');
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/usuarios', true);
            
            xhr.timeout = 10000; // 10 segundos de timeout
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    debugLog('📡 Response usuários - Status: ' + xhr.status + ', Response: ' + xhr.responseText);
                    
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            debugLog('✅ Response usuários parseado: ' + JSON.stringify(response));
                            
                            // A API retorna response.data, não response.usuarios
                            if (response.status === 'success' && response.data) {
                                usuarios = response.data;
                                populateUserSelect();
                                debugLog('✅ ' + usuarios.length + ' usuários carregados');
                            } else {
                                debugLog('❌ Estrutura de resposta inesperada ou erro: ' + JSON.stringify(response));
                            }
                        } catch (e) {
                            debugLog('❌ Erro ao carregar usuários: ' + e.message + ' | Response: ' + xhr.responseText);
                        }
                    } else {
                        debugLog('❌ Erro HTTP ao carregar usuários: ' + xhr.status);
                    }
                }
            };
            
            xhr.send();
        }

        function populateUserSelect() {
            // Carregar o usuário atual logado
            loadCurrentUser();
        }

        function loadCurrentUser() {
            debugLog('👤 Carregando usuário atual...');
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/usuario-atual', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success' && response.user) {
                                usuarioLogado = response.user;
                                selectedUserId = response.user.id;
                                
                                // Atualizar nome na navbar
                                var userNavbarLabel = document.getElementById('currentUserNameNavbar');
                                var dropdownUserName = document.getElementById('dropdownUserName');
                                if (userNavbarLabel) {
                                    userNavbarLabel.textContent = usuarioLogado.nome;
                                    debugLog('✅ Nome do usuário atualizado na navbar: ' + usuarioLogado.nome);
                                } else {
                                    debugLog('❌ Elemento currentUserNameNavbar não encontrado');
                                }
                                if (dropdownUserName) {
                                    dropdownUserName.textContent = usuarioLogado.nome;
                                }
                                
                                debugLog('✅ Usuário logado: ' + usuarioLogado.nome);
                                loadUserFavorites(); // Carregar favoritos do usuário
                                loadUserPhotoNavbar(); // Carregar foto do usuário na navbar
                            } else {
                                debugLog('❌ Erro ao obter usuário atual: ' + response.message);
                                
                                // Redirecionar para login se usuário não estiver logado
                                alert('Você precisa estar logado para acessar o PDV.');
                                window.location.href = '/login';
                                return;
                            }
                        } catch (e) {
                            debugLog('❌ Erro JSON usuário atual: ' + e.message);
                        }
                    } else {
                        debugLog('❌ Erro HTTP usuário atual: ' + xhr.status);
                        
                        // Se erro 401 (não autorizado), redirecionar para login
                        if (xhr.status === 401) {
                            alert('Sessão expirada. Faça login novamente.');
                            window.location.href = '/login';
                            return;
                        }
                        
                        var userNavbarLabel = document.getElementById('currentUserNameNavbar');
                        if (userNavbarLabel) {
                            userNavbarLabel.textContent = 'Erro';
                        }
                    }
                }
            };
            
            xhr.send();
        }
        
        // Função selectUser removida - agora usa label fixo

        // Função para carregar favoritos do usuário
        function loadUserFavorites() {
            if (!selectedUserId) {
                favorites = [];
                return;
            }

            debugLog('⭐ Carregando favoritos do usuário: ' + selectedUserId);
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/favoritos/' + selectedUserId, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success') {
                                favorites = response.favoritos || [];
                                renderProducts(); // Re-render para mostrar favoritos
                                debugLog('✅ ' + favorites.length + ' favoritos carregados');
                            }
                        } catch (e) {
                            debugLog('❌ Erro ao carregar favoritos: ' + e.message);
                        }
                    }
                }
            };
            
            xhr.send();
        }

        // Função para carregar produtos
        function loadProducts() {
            debugLog('📦 Carregando produtos...');
            
            var productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '<div class="loading">Carregando produtos...</div>';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/produtos', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    debugLog('📡 Response recebido - Status: ' + xhr.status);
                    
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            debugLog('✅ Produtos recebidos: ' + (response.produtos ? response.produtos.length : 0));
                            
                            if (response.status === 'success' && response.produtos) {
                                products = response.produtos;
                                renderProducts();
                            } else {
                                showError('Erro na resposta da API');
                            }
                        } catch (e) {
                            debugLog('❌ Erro JSON: ' + e.message);
                            showError('Erro ao processar dados');
                        }
                    } else {
                        showError('Erro HTTP: ' + xhr.status);
                    }
                }
            };

            xhr.onerror = function() {
                debugLog('❌ Erro de conexão ao carregar usuários');
                showError('Erro de conexão ao carregar usuários');
            };

            xhr.ontimeout = function() {
                debugLog('⏰ Timeout ao carregar usuários');
                showError('Timeout ao carregar usuários');
            };

            debugLog('📡 Enviando requisição para /api/usuarios');
            xhr.send();
        }

        // Função para refresh dos produtos
        function refreshProducts() {
            debugLog('🔄 Refresh de produtos acionado');
            
            var refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.classList.add('refreshing');
            }
            
            setTimeout(function() {
                if (refreshBtn) {
                    refreshBtn.classList.remove('refreshing');
                }
            }, 2000);
            
            // Recarregar produtos
            loadProducts();
            
            // Recarregar favoritos se há usuário selecionado
            if (selectedUserId) {
                loadUserFavorites();
            }
            
            showMessage('✅ Produtos atualizados!');
        }

        // Função para verificar se é favorito
        function isFavorite(productId) {
            for (var i = 0; i < favorites.length; i++) {
                if (favorites[i].produto_id == productId) {
                    return true;
                }
            }
            return false;
        }

        // Função para renderizar produtos
        function renderProducts(searchTerm) {
            var productsGrid = document.getElementById('productsGrid');
            debugLog('🎨 Renderizando ' + products.length + ' produtos');
            
            if (products.length === 0) {
                productsGrid.innerHTML = '<div class="cart-empty">Nenhum produto encontrado</div>';
                return;
            }

            var filteredProducts = products;
            
            // Aplicar filtro de busca se fornecido
            if (searchTerm && searchTerm.trim()) {
                var normalizedSearch = normalizeText(searchTerm.trim());
                filteredProducts = products.filter(function(product) {
                    var normalizedName = normalizeText(product.nome || '');
                    return normalizedName.includes(normalizedSearch);
                });
            }

            // Ordenar: favoritos primeiro
            if (selectedUserId && favorites.length > 0) {
                filteredProducts.sort(function(a, b) {
                    var aIsFavorite = isFavorite(a.id);
                    var bIsFavorite = isFavorite(b.id);
                    
                    if (aIsFavorite && !bIsFavorite) return -1;
                    if (!aIsFavorite && bIsFavorite) return 1;
                    return 0;
                });
            }

            var html = '';
            for (var i = 0; i < filteredProducts.length; i++) {
                var product = filteredProducts[i];
                var price = parseFloat(product.preco) || 0;
                var priceFormatted = formatCurrency(price);
                var favoriteClass = isFavorite(product.id) ? 'active' : '';
                var isFav = isFavorite(product.id);
                
                html += '<div class="product-card" onclick="addToCart(' + product.id + ')">';
                html += '<button class="favorite-btn ' + favoriteClass + '" data-product-id="' + product.id + '" onclick="event.stopPropagation(); toggleFavorite(this)">';
                html += '<svg width="24" height="24" viewBox="0 0 24 24" fill="' + (isFav ? '#ff6b6b' : 'none') + '" stroke="' + (isFav ? '#ff6b6b' : 'currentColor') + '" stroke-width="2" style="width: 24px; height: 24px;">';
                html += '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>';
                html += '</svg>';
                html += '</button>';
                // Verificar se o produto tem imagem de capa
                var productImageId = 'product-img-' + product.id;
                
                debugLog('📊 Produto ' + product.id + ' - tem_imagem: ' + product.tem_imagem + ', foto_capa: ' + (product.foto_capa ? 'SIM' : 'NÃO'));
                
                if (product.tem_imagem && product.foto_capa) {
                    debugLog('🖼️ Renderizando produto com imagem: ' + product.id);
                    
                    // Produto tem foto de capa - sempre mostrar loading inicialmente
                    html += '<div class="product-image" id="' + productImageId + '">';
                    
                    // Indicador de carregamento (sempre visível inicialmente)
                    html += '<div class="product-image-loading" id="loading-' + product.id + '">';
                    html += '<div style="text-align: center;">';
                    html += '<div class="loading-spinner"></div>';
                    html += '<div class="loading-text">Carregando...</div>';
                    html += '<div class="loading-progress" id="progress-' + product.id + '">0%</div>';
                    html += '</div>';
                    html += '</div>';
                    
                    // Imagem (inicialmente invisível)
                    html += '<img src="' + product.foto_capa + '" alt="' + (product.nome || '') + '" ';
                    html += 'style="opacity: 0;" ';
                    html += 'oncontextmenu="return false;" ';
                    html += 'ontouchstart="handleImageTouchStart(event, ' + product.id + ', \'' + (product.nome || '').replace(/'/g, '\\\'') + '\')" ';
                    html += 'ontouchend="handleImageTouchEnd()" ';
                    html += 'ontouchmove="handleImageTouchMove()" ';
                    html += 'onclick="showImageModal(' + product.id + ', \'' + (product.nome || '').replace(/'/g, '\\\'') + '\')" ';
                    html += 'onload="handleImageLoad(' + product.id + ')" ';
                    html += 'onerror="handleImageError(' + product.id + ')">';
                    
                    html += '</div>';
                } else {
                    // Produto sem foto de capa - tentar carregar layout ou usar sacolinha SVG
                    html += '<div class="product-image" id="' + productImageId + '" style="display: flex; align-items: center; justify-content: center; background: #f8f6fc;">';
                    html += '<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">';
                    html += '<defs>';
                    html += '<linearGradient id="bagGradient_' + product.id + '" x1="0%" y1="0%" x2="100%" y2="100%">';
                    html += '<stop offset="0%" style="stop-color:#9B64E3;stop-opacity:1" />';
                    html += '<stop offset="100%" style="stop-color:#2C0B5A;stop-opacity:1" />';
                    html += '</linearGradient>';
                    html += '</defs>';
                    html += '<rect width="100" height="100" fill="#f8f6fc"/>';
                    html += '<path d="M30 35 L70 35 L65 75 L35 75 Z" fill="url(#bagGradient_' + product.id + ')" stroke="#7B3CB0" stroke-width="1.5"/>';
                    html += '<path d="M38 35 C38 28, 45 25, 50 25 C55 25, 62 28, 62 35" fill="none" stroke="#7B3CB0" stroke-width="2" stroke-linecap="round"/>';
                    html += '<path d="M35 40 L60 40" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>';
                    html += '<g transform="translate(42, 47) scale(2.6)">';
                    html += '<path d="M4.75 2.88v1.66h-0.58v-0.53V2.97c-0.21,0.35-0.42,0.81-0.59,1.41l-0.58-1.06v1.09h-0.58V2.25h0.58l0.49,0.88s0.18-0.5,0.65-0.91c0.34-0.31,0.78-0.48,1.32-0.48h0.1l0.12,0.01s-0.42,0.03-0.92,0.48v0.51z" fill="white"/>';
                    html += '<path d="M3.44 0c1.09,0 2.06,0.51 2.69,1.3C5.5,0.71 4.71,0.35 3.83,0.35c-1.71,0-3.1,1.39-3.1,3.1 0,1.69 1.36,3.07 3.04,3.1 0.34-0.03 0.68-0.07 0.99-0.14 0.5-0.16 0.95-0.44 1.3-0.81C5.44,6.39 4.47,6.9 3.44,6.9c-1.9,0-3.44-1.54-3.44-3.44S1.54,0 3.44,0z" fill="rgba(255,255,255,0.9)"/>';
                    html += '</g>';
                    html += '</svg>';
                    html += '</div>';
                }
                
                // Tentar carregar layout do produto (assíncrono)
                loadProductLayout(product.id, productImageId);
                html += '<h3 class="product-name">' + (product.nome || 'Produto sem nome') + '</h3>';
                html += '<p class="product-price">' + priceFormatted + '</p>';
                html += '<p class="product-stock">Estoque: ' + (product.estoque || 0) + '</p>';
                html += '</div>';
            }

            productsGrid.innerHTML = html;
            
            // Configurar timeouts e simulação de progresso para produtos com imagem
            setTimeout(function() {
                for (var i = 0; i < filteredProducts.length; i++) {
                    var product = filteredProducts[i];
                    if (product.tem_imagem && product.foto_capa) {
                        setupImageLoadingTimeout(product.id);
                        simulateImageProgress(product.id);
                        debugLog('⏱️ Timeout e progresso configurados para produto ' + product.id);
                    }
                }
            }, 100);
            
            debugLog('✅ ' + filteredProducts.length + ' produtos renderizados!');
            
            // Inicializar sistema de tracking de carregamento
            var produtosComImagem = filteredProducts.filter(function(p) { return p.tem_imagem && p.foto_capa; });
            debugLog('🖼️ Produtos com imagem: ' + produtosComImagem.length);
            
            if (produtosComImagem.length > 0) {
                initializeImageLoadingTracker(produtosComImagem);
            }
            
            // Atualizar indicadores de scroll após renderizar produtos
            setTimeout(function() {
                var productsGrid = document.getElementById('productsGrid');
                var wrapper = productsGrid ? productsGrid.parentElement : null;
                if (wrapper && wrapper.classList.contains('products-grid-container')) {
                    updateScrollIndicators(productsGrid, wrapper);
                }
            }, 200);
        }

        // Função para carregar layout/design do produto
        function loadProductLayout(productId, imageElementId) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/produtos/' + productId + '/layout', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success' && response.layout) {
                                var imageElement = document.getElementById(imageElementId);
                                if (imageElement) {
                                    // Substituir o conteúdo atual por uma imagem do layout
                                    imageElement.innerHTML = '<img src="' + response.layout + '" alt="Layout do produto" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; opacity: 0; transition: opacity 0.3s ease;" onload="this.style.opacity=1;" onerror="this.style.display=\'none\';">';
                                    debugLog('🎨 Layout carregado para produto ' + productId);
                                }
                            } else {
                                debugLog('ℹ️ Produto ' + productId + ' não possui layout/design');
                            }
                        } catch (e) {
                            debugLog('❌ Erro ao processar layout do produto ' + productId + ': ' + e.message);
                        }
                    } else if (xhr.status !== 404) {
                        debugLog('❌ Erro HTTP ao buscar layout do produto ' + productId + ': ' + xhr.status);
                    }
                }
            };
            
            xhr.send();
        }

        // Função para alternar favorito
        function toggleFavorite(button) {
            if (!selectedUserId) {
                alert('Selecione um vendedor primeiro');
                return;
            }

            var productId = button.getAttribute('data-product-id');
            var isCurrentlyFavorite = isFavorite(productId);
            
            debugLog((isCurrentlyFavorite ? '💔' : '💛') + ' Alterando favorito: ' + productId);

            // Atualização otimista da UI
            if (isCurrentlyFavorite) {
                // Remove dos favoritos localmente
                favorites = favorites.filter(f => f.produto_id != productId);
            } else {
                // Adiciona aos favoritos localmente
                favorites.push({ produto_id: productId, usuario_id: selectedUserId });
            }
            
            // Re-renderiza imediatamente para feedback visual
            renderProducts();

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/favoritos', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success') {
                                debugLog('✅ Favorito alterado com sucesso');
                                // Recarregar do servidor para sincronizar
                                loadUserFavorites();
                            } else {
                                debugLog('❌ Erro no servidor: ' + response.message);
                                // Reverter mudança local em caso de erro
                                loadUserFavorites();
                            }
                        } catch (e) {
                            debugLog('❌ Erro ao processar resposta: ' + e.message);
                            // Reverter mudança local em caso de erro
                            loadUserFavorites();
                        }
                    } else {
                        debugLog('❌ Erro HTTP: ' + xhr.status);
                        // Reverter mudança local em caso de erro
                        loadUserFavorites();
                    }
                }
            };

            var requestData = {
                usuario_id: selectedUserId,
                produto_id: productId,
                action: isCurrentlyFavorite ? 'remove' : 'add'
            };

            xhr.send(JSON.stringify(requestData));
        }

        // Funções do carrinho
        function addToCart(productId) {
            debugLog('🛒 Adicionando produto: ' + productId);
            
            var product = null;
            for (var i = 0; i < products.length; i++) {
                if (products[i].id == productId) {
                    product = products[i];
                    break;
                }
            }
            
            if (!product) {
                debugLog('❌ Produto não encontrado');
                return;
            }

            var existingItem = null;
            for (var j = 0; j < cart.length; j++) {
                if (cart[j].id == productId) {
                    existingItem = cart[j];
                    break;
                }
            }

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    nome: product.nome,
                    preco: parseFloat(product.preco) || 0,
                    quantity: 1
                });
            }

            updateCartDisplay();
            applyDiscountAutomatically();
        }

        function changeQuantity(productId, delta) {
            for (var i = 0; i < cart.length; i++) {
                if (cart[i].id == productId) {
                    cart[i].quantity += delta;
                    if (cart[i].quantity <= 0) {
                        cart.splice(i, 1);
                    }
                    break;
                }
            }
            updateCartDisplay();
            applyDiscountAutomatically();
        }

        function removeFromCart(productId) {
            for (var i = 0; i < cart.length; i++) {
                if (cart[i].id == productId) {
                    cart.splice(i, 1);
                    break;
                }
            }
            updateCartDisplay();
            applyDiscountAutomatically();
        }

        function updateCartDisplay() {
            var cartItems = document.getElementById('cartItems');
            var cartTotal = document.getElementById('cartTotal');
            var cartSubtotalValue = document.getElementById('cartSubtotalValue');
            var checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="cart-empty">Carrinho vazio<br><small>Clique nos produtos para adicionar</small></div>';
                cartTotal.textContent = 'R$ 0,00';
                cartSubtotalValue.textContent = 'R$ 0,00';
                checkoutBtn.disabled = true;
                
                // Limpar desconto quando carrinho vazio
                currentDiscount.amount = 0;
                currentDiscount.appliedValue = 0;
                document.getElementById('discountInput').value = '';
                updateDiscountDisplay();
                return;
            }

            var html = '';
            var subtotal = 0;

            for (var i = 0; i < cart.length; i++) {
                var item = cart[i];
                var itemTotal = item.preco * item.quantity;
                subtotal += itemTotal;

                html += '<div class="cart-item">';
                html += '<div class="cart-item-info">';
                html += '<div class="cart-item-name">' + item.nome + '</div>';
                html += '<div class="cart-item-price">R$ ' + item.preco.toFixed(2).replace('.', ',') + ' cada</div>';
                html += '<div class="cart-item-row">';
                html += '<div class="cart-item-controls">';
                html += '<button class="cart-quantity-btn" onclick="changeQuantity(' + item.id + ', -1)">−</button>';
                html += '<span class="cart-quantity">' + item.quantity + '</span>';
                html += '<button class="cart-quantity-btn" onclick="changeQuantity(' + item.id + ', 1)">+</button>';
                html += '</div>';
                html += '<div class="cart-item-total">' + formatCurrency(itemTotal) + '</div>';
                html += '</div>';
                html += '</div>';
                html += '<button class="cart-item-remove" onclick="removeFromCart(' + item.id + ')">✕</button>';
                html += '</div>';
            }

            var total = subtotal - currentDiscount.appliedValue;

            cartItems.innerHTML = html;
            cartSubtotalValue.textContent = formatCurrency(subtotal);
            cartTotal.textContent = formatCurrency(total);
            checkoutBtn.disabled = false;
            
            // Atualizar indicadores de scroll do carrinho
            setTimeout(function() {
                var cartItems = document.getElementById('cartItems');
                var cartPanel = document.querySelector('.cart-panel');
                if (cartItems && cartPanel) {
                    updateCartScrollIndicator(cartItems, cartPanel);
                }
            }, 100);
            
            // Atualizar troco no resumo do carrinho apenas quando houver troco positivo
            var cartTrocoRow = document.getElementById('cartTroco');
            var cartTrocoValue = document.getElementById('cartTrocoValue');
            if (cartTrocoRow && cartTrocoValue && checkoutData.troco > 0) {
                cartTrocoRow.style.display = 'flex';
                cartTrocoValue.textContent = formatCurrency(checkoutData.troco);
            } else if (cartTrocoRow) {
                cartTrocoRow.style.display = 'none';
            }
        }

        // Funções de desconto
        function setDiscountType(type) {
            currentDiscount.type = type;
            
            var buttons = document.querySelectorAll('.discount-type-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            document.querySelector('[data-type="' + type + '"]').classList.add('active');
            
            var input = document.getElementById('discountInput');
            if (type === 'percentage') {
                input.placeholder = '0';
                input.max = '100';
                input.step = '0.01';
            } else {
                input.placeholder = '0,00';
                input.max = '999999';
                input.step = '0.01';
            }
            
            if (currentDiscount.amount > 0) {
                clearDiscount();
            }
            
            applyDiscountAutomatically();
        }

        function handleDiscountInput(input) {
            if (currentDiscount.type === 'value') {
                formatCurrencyInput(input);
            }
            applyDiscountAutomatically();
        }

        function applyDiscountAutomatically() {
            var input = document.getElementById('discountInput');
            var amount;
            
            if (currentDiscount.type === 'percentage') {
                amount = parseFloat(input.value) || 0;
            } else {
                amount = unformatCurrency(input.value);
            }
            
            if (amount <= 0) {
                currentDiscount.amount = 0;
                currentDiscount.appliedValue = 0;
                updateCartDisplay();
                updateDiscountDisplay();
                return;
            }
            
            var subtotal = 0;
            for (var i = 0; i < cart.length; i++) {
                subtotal += cart[i].preco * cart[i].quantity;
            }
            
            if (subtotal <= 0) {
                currentDiscount.amount = 0;
                currentDiscount.appliedValue = 0;
                updateCartDisplay();
                updateDiscountDisplay();
                return;
            }
            
            if (currentDiscount.type === 'percentage') {
                var limitedAmount = Math.min(100, Math.max(0, amount));
                if (limitedAmount !== amount) {
                    input.value = limitedAmount;
                }
                currentDiscount.amount = limitedAmount;
                currentDiscount.appliedValue = (subtotal * limitedAmount) / 100;
            } else {
                var limitedAmount = Math.min(subtotal, Math.max(0, amount));
                currentDiscount.amount = limitedAmount;
                currentDiscount.appliedValue = limitedAmount;
            }
            
            updateCartDisplay();
            updateDiscountDisplay();
        }

        function clearDiscount() {
            currentDiscount.amount = 0;
            currentDiscount.appliedValue = 0;
            document.getElementById('discountInput').value = '';
            updateCartDisplay();
            updateDiscountDisplay();
        }

        function updateDiscountDisplay() {
            var discountInfo = document.getElementById('discountInfo');
            var discountRow = document.getElementById('discountRow');
            var discountAmount = document.getElementById('discountAmount');
            
            if (currentDiscount.appliedValue > 0) {
                if (discountInfo) {
                    discountInfo.style.display = 'block';
                    var description = currentDiscount.type === 'percentage' 
                        ? currentDiscount.amount + '% de desconto aplicado'
                        : 'Desconto de ' + formatCurrency(currentDiscount.amount) + ' aplicado';
                    document.getElementById('discountDescription').textContent = description;
                }
                
                if (discountRow) {
                    discountRow.style.display = 'flex';
                }
                
                if (discountAmount) {
                    discountAmount.textContent = '- ' + formatCurrency(currentDiscount.appliedValue);
                }
            } else {
                if (discountInfo) discountInfo.style.display = 'none';
                if (discountRow) discountRow.style.display = 'none';
            }
        }

        // Funções de checkout
        function checkout() {
            if (cart.length === 0) {
                debugLog('⚠️ Tentativa de checkout com carrinho vazio');
                return;
            }

            debugLog('💳 Iniciando checkout com ' + cart.length + ' itens');
            
            checkoutData.paymentMethod = null;
            checkoutData.installments = 1;
            checkoutData.valorRecebido = 0;
            checkoutData.troco = 0;
            
            updateOrderSummary();
            updateInstallmentButtons();
            // loadCheckoutSellers() removido
            
            var modal = document.getElementById('checkoutModal');
            modal.style.display = 'flex';
            setTimeout(function() {
                modal.classList.add('show');
            }, 10);
            
            var paymentMethods = document.querySelectorAll('.payment-method');
            for (var i = 0; i < paymentMethods.length; i++) {
                paymentMethods[i].classList.remove('selected');
            }
            document.getElementById('installmentsSection').style.display = 'none';
            document.getElementById('cashSection').style.display = 'none';
            document.getElementById('confirmSaleBtn').disabled = true;
        }

        function closeCheckoutModal() {
            var modal = document.getElementById('checkoutModal');
            modal.classList.add('closing');
            
            setTimeout(function() {
                modal.classList.remove('show');
                modal.classList.remove('closing');
                modal.style.display = 'none';
            }, 300);
            
            checkoutData.paymentMethod = null;
            checkoutData.installments = 1;
            checkoutData.valorRecebido = 0;
            checkoutData.troco = 0;
            
            document.getElementById('installmentsSection').style.display = 'none';
            document.getElementById('cashSection').style.display = 'none';
            document.getElementById('valorRecebido').value = '';
            // Reset virtual keyboard
            virtualKeyboardValue = '';
            document.getElementById('virtualKeyboard').style.display = 'none';
            var trocoDisplay = document.getElementById('trocoDisplay');
            if (trocoDisplay) trocoDisplay.style.display = 'none';
            
            var paymentMethods = document.querySelectorAll('.payment-method');
            for (var i = 0; i < paymentMethods.length; i++) {
                paymentMethods[i].classList.remove('selected');
            }
            var installmentOptions = document.querySelectorAll('.installment-option');
            for (var j = 0; j < installmentOptions.length; j++) {
                installmentOptions[j].classList.remove('selected');
            }
            
            document.getElementById('confirmSaleBtn').disabled = true;
        }

        function selectPaymentMethod(method) {
            checkoutData.paymentMethod = method;
            
            var paymentMethods = document.querySelectorAll('.payment-method');
            for (var i = 0; i < paymentMethods.length; i++) {
                paymentMethods[i].classList.remove('selected');
            }
            document.querySelector('[data-method="' + method + '"]').classList.add('selected');
            
            document.getElementById('installmentsSection').style.display = 'none';
            document.getElementById('cashSection').style.display = 'none';
            
            if (method === 'credito') {
                document.getElementById('installmentsSection').style.display = 'block';
                checkoutData.installments = 1;
                document.querySelector('[data-installments="1"]').classList.add('selected');
                // Atualizar valor das parcelas
                selectInstallments(1);
            } else if (method === 'dinheiro') {
                document.getElementById('cashSection').style.display = 'block';
                // Reset virtual keyboard
                virtualKeyboardValue = '';
                document.getElementById('valorRecebido').value = '';
                document.getElementById('virtualKeyboard').style.display = 'none';
                checkoutData.troco = 0;
                checkoutData.valorRecebido = 0;
            }
            
            // Limpar troco se não for pagamento em dinheiro
            if (method !== 'dinheiro') {
                checkoutData.troco = 0;
                checkoutData.valorRecebido = 0;
            }
            
            // Atualizar resumo do pedido
            updateOrderSummary();
            
            document.getElementById('confirmSaleBtn').disabled = false;
        }

        function selectInstallments(installments) {
            checkoutData.installments = installments;
            
            var installmentOptions = document.querySelectorAll('.installment-option');
            for (var i = 0; i < installmentOptions.length; i++) {
                installmentOptions[i].classList.remove('selected');
            }
            document.querySelector('[data-installments="' + installments + '"]').classList.add('selected');
            
            updateInstallmentButtons();
        }
        
        function updateInstallmentButtons() {
            var total = getCartTotal();
            var installmentOptions = document.querySelectorAll('.installment-option');
            
            for (var i = 0; i < installmentOptions.length; i++) {
                var button = installmentOptions[i];
                var installments = parseInt(button.getAttribute('data-installments'));
                
                if (installments === 1) {
                    button.textContent = 'À vista - ' + formatCurrency(total);
                } else {
                    var parcelValue = total / installments;
                    button.textContent = installments + 'x de ' + formatCurrency(parcelValue);
                }
            }
        }

        function calculateChange(input) {
            // Se o teclado virtual foi usado (ou ainda está ativo), use seu valor
            if (virtualKeyboardValue !== '') {
                var cents = parseInt(virtualKeyboardValue || '0');
                checkoutData.valorRecebido = cents / 100;
            } else {
                formatCurrencyInput(input);
                checkoutData.valorRecebido = unformatCurrency(input.value);
            }
            
            var subtotal = 0;
            for (var i = 0; i < cart.length; i++) {
                subtotal += cart[i].preco * cart[i].quantity;
            }
            var total = subtotal - currentDiscount.appliedValue;
            
            checkoutData.troco = checkoutData.valorRecebido - total;
            
            // Debug para verificar valores
            debugLog('💰 Valor recebido: R$ ' + checkoutData.valorRecebido + ' | Total: R$ ' + total + ' | Troco: R$ ' + checkoutData.troco);
            
            // Atualizar resumo do pedido para mostrar o troco
            updateOrderSummary();
            
            // Também atualizar o display do carrinho principal
            updateCartDisplay();
            
            // Controlar habilitação do botão de confirmação
            if (checkoutData.valorRecebido > 0 && checkoutData.troco >= 0) {
                document.getElementById('confirmSaleBtn').disabled = false;
            } else {
                document.getElementById('confirmSaleBtn').disabled = true;
            }
        }

        // Variáveis para drag do teclado
        var keyboardDragData = {
            isDragging: false,
            startX: 0,
            startY: 0,
            initialX: 0,
            initialY: 0
        };



        function startDrag(e) {
            keyboardDragData.isDragging = true;
            var keyboard = document.getElementById('virtualKeyboard');
            var rect = keyboard.getBoundingClientRect();
            
            keyboardDragData.startX = e.clientX;
            keyboardDragData.startY = e.clientY;
            keyboardDragData.initialX = rect.left;
            keyboardDragData.initialY = rect.top;
            
            keyboard.style.transform = 'none';
            keyboard.style.left = rect.left + 'px';
            keyboard.style.top = rect.top + 'px';
            
            e.preventDefault();
        }

        function startDragTouch(e) {
            debugLog('🖐️ Touch start no handle do teclado');
            
            if (e.touches.length !== 1) return; // Apenas um dedo
            
            var touch = e.touches[0];
            keyboardDragData.isDragging = true;
            var keyboard = document.getElementById('virtualKeyboard');
            var rect = keyboard.getBoundingClientRect();
            
            keyboardDragData.startX = touch.clientX;
            keyboardDragData.startY = touch.clientY;
            keyboardDragData.initialX = rect.left;
            keyboardDragData.initialY = rect.top;
            
            debugLog('📱 Iniciando drag - X: ' + touch.clientX + ', Y: ' + touch.clientY);
            
            // Remover transform e definir posição absoluta
            keyboard.style.transform = 'none';
            keyboard.style.left = rect.left + 'px';
            keyboard.style.top = rect.top + 'px';
            keyboard.style.bottom = 'auto';
            
            // Prevenir scroll/zoom
            e.preventDefault();
            e.stopPropagation();
        }

        function drag(e) {
            if (!keyboardDragData.isDragging) return;
            
            var keyboard = document.getElementById('virtualKeyboard');
            var deltaX = e.clientX - keyboardDragData.startX;
            var deltaY = e.clientY - keyboardDragData.startY;
            
            var newX = keyboardDragData.initialX + deltaX;
            var newY = keyboardDragData.initialY + deltaY;
            
            // Limitar dentro da tela
            newX = Math.max(0, Math.min(newX, window.innerWidth - keyboard.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - keyboard.offsetHeight));
            
            keyboard.style.left = newX + 'px';
            keyboard.style.top = newY + 'px';
            
            e.preventDefault();
        }

        function dragTouch(e) {
            if (!keyboardDragData.isDragging || e.touches.length !== 1) return;
            
            var touch = e.touches[0];
            var keyboard = document.getElementById('virtualKeyboard');
            var deltaX = touch.clientX - keyboardDragData.startX;
            var deltaY = touch.clientY - keyboardDragData.startY;
            
            var newX = keyboardDragData.initialX + deltaX;
            var newY = keyboardDragData.initialY + deltaY;
            
            // Limitar dentro da tela com margem
            var margin = 10;
            newX = Math.max(margin, Math.min(newX, window.innerWidth - keyboard.offsetWidth - margin));
            newY = Math.max(margin, Math.min(newY, window.innerHeight - keyboard.offsetHeight - margin));
            
            keyboard.style.left = newX + 'px';
            keyboard.style.top = newY + 'px';
            
            // Prevenir scroll/zoom
            e.preventDefault();
            e.stopPropagation();
        }

        function stopDrag() {
            keyboardDragData.isDragging = false;
        }

        // Funções do Teclado Virtual
        var virtualKeyboardValue = '';
        var keyboardListenersActive = false;
        
        function showVirtualKeyboard() {
            currentInputTarget = document.getElementById('valorRecebido');
            var keyboard = document.getElementById('virtualKeyboard');
            var input = currentInputTarget;
            
            // Debug para iPad
            console.log('🎹 showVirtualKeyboard chamado, display atual:', keyboard.style.display);
            
            // Se já estiver aberto, apenas reposicionar
            if (keyboard.style.display === 'block') {
                positionKeyboardBubble(keyboard, input);
                return;
            }
            
            // Mostrar o teclado com fade in
            keyboard.style.display = 'block';
            document.body.classList.add('keyboard-open');
            
            // Posicionar o teclado como bolha de diálogo
            positionKeyboardBubble(keyboard, input);
            
            // Trigger da animação fade in
            setTimeout(function() {
                keyboard.classList.add('show');
            }, 10);
            
            // Feedback tátil minimalista
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
            
            // Configurar valor atual
            var currentValue = input.value;
            virtualKeyboardValue = currentValue.replace(/[^\d]/g, '');
            updateVirtualKeyboardDisplay();
            
            // Listeners para fechar teclado quando clicar fora e reposicionar (evitar duplicatas)
            if (!keyboardListenersActive) {
                setTimeout(function() {
                    document.addEventListener('click', hideKeyboardOnClickOutside);
                    document.addEventListener('touchstart', hideKeyboardOnTouchOutside);
                    window.addEventListener('resize', repositionKeyboard);
                    keyboardListenersActive = true;
                }, 100);
            }
        }
        
        function positionKeyboardBubble(keyboard, input) {
            var inputRect = input.getBoundingClientRect();
            var keyboardWidth = 280;
            
            // Forçar cálculo da altura real do teclado
            var tempDisplay = keyboard.style.display;
            keyboard.style.visibility = 'hidden';
            keyboard.style.display = 'block';
            var keyboardHeight = keyboard.offsetHeight;
            keyboard.style.visibility = 'visible';
            keyboard.style.display = tempDisplay;
            
            var margin = 20;
            var gap = 15; // Espaço entre input e teclado
            
            // Posição horizontal - sempre à direita do input (prioridade máxima)
            var leftPos = inputRect.right + gap;
            
            // Verificar se há espaço suficiente à direita
            var spaceRight = window.innerWidth - inputRect.right - margin;
            
            if (spaceRight >= keyboardWidth + gap) {
                // Há espaço suficiente à direita - posicionar normalmente
                leftPos = inputRect.right + gap;
                keyboard.classList.remove('bubble-left');
            } else {
                // Não há espaço à direita - ajustar posição mantendo visibilidade
                var spaceLeft = inputRect.left - margin;
                
                if (spaceLeft >= keyboardWidth + gap) {
                    // Colocar à esquerda se houver espaço
                    leftPos = inputRect.left - keyboardWidth - gap;
                    keyboard.classList.add('bubble-left');
                } else {
                    // Forçar posição que caiba na tela, priorizando direita
                    if (spaceRight > spaceLeft) {
                        leftPos = window.innerWidth - keyboardWidth - margin;
                        keyboard.classList.remove('bubble-left');
                    } else {
                        leftPos = margin;
                        keyboard.classList.remove('bubble-left');
                    }
                }
            }
            
            // Posição vertical - priorizar posicionamento acima do input se não houver espaço embaixo
            var availableSpaceBelow = window.innerHeight - inputRect.bottom - margin;
            var availableSpaceAbove = inputRect.top - margin;
            
            var topPos;
            if (availableSpaceBelow >= keyboardHeight + 20) {
                // Há espaço suficiente abaixo - posicionar abaixo do input
                topPos = inputRect.bottom + gap;
            } else if (availableSpaceAbove >= keyboardHeight + 20) {
                // Não há espaço abaixo, mas há acima - posicionar acima do input
                topPos = inputRect.top - keyboardHeight - gap;
            } else {
                // Pouco espaço em ambos os lados - posicionar de forma segura
                if (availableSpaceBelow > availableSpaceAbove) {
                    topPos = window.innerHeight - keyboardHeight - margin - 60; // 60px de margem extra para botões
                } else {
                    topPos = margin;
                }
            }
            
            // Garantir que nunca saia dos limites da tela e sempre deixe espaço para botões
            var safeBottomMargin = 100; // Margem extra para garantir visibilidade de botões
            topPos = Math.max(margin, Math.min(topPos, window.innerHeight - keyboardHeight - margin - safeBottomMargin));
            
            // Aplicar posição
            keyboard.style.left = leftPos + 'px';
            keyboard.style.top = topPos + 'px';
            keyboard.style.position = 'fixed';
            keyboard.style.zIndex = '9999';
            
            console.log('🎈 Teclado posicionado:', { 
                left: leftPos, 
                top: topPos, 
                inputRect: inputRect, 
                windowHeight: window.innerHeight,
                keyboardHeight: keyboardHeight,
                safeBottomMargin: safeBottomMargin
            });
        }
        
        function repositionKeyboard() {
            var keyboard = document.getElementById('virtualKeyboard');
            var activeInput = document.querySelector('input:focus') || document.getElementById('valorRecebido');
            
            if (keyboard.style.display === 'block') {
                positionKeyboardBubble(keyboard, activeInput);
            }
        }
        
        // Variável global para controlar qual input está ativo
        var currentInputTarget = null;
        
        function showVirtualKeyboardForDiscount() {
            console.log('🎹 showVirtualKeyboardForDiscount - CRIANDO TECLADO ESPECÍFICO PARA DESCONTO');
            
            // Criar um teclado específico para desconto que não interfere com o original
            createFreshDiscountKeyboard();
        }
                    keyboardListenersActive = true;
                    console.log('👂 Event listeners adicionados');

        

        
        // Função que cria um teclado do zero se necessário
        function createFreshDiscountKeyboard() {
            console.log('🔨 Criando teclado virtual específico para DESCONTO...');
            
            // Não remover o teclado original - criar um ID único para desconto
            var existingDiscountKeyboard = document.getElementById('discountVirtualKeyboard');
            if (existingDiscountKeyboard) {
                existingDiscountKeyboard.remove();
                console.log('🔨 Teclado de desconto antigo removido');
            }
            
            // Configurar target como discountInput
            currentInputTarget = document.getElementById('discountInput');
            if (!currentInputTarget) {
                console.error('❌ discountInput não encontrado!');
                return;
            }
            
            // Criar novo teclado específico para desconto com ID único
            var discountKeyboard = document.createElement('div');
            discountKeyboard.id = 'discountVirtualKeyboard'; // ID único para não conflitar
            discountKeyboard.className = 'virtual-keyboard show';
            discountKeyboard.innerHTML = `
                <div class="keyboard-row">
                    <button class="key-btn" onclick="addDiscountDigit('1')">1</button>
                    <button class="key-btn" onclick="addDiscountDigit('2')">2</button>
                    <button class="key-btn" onclick="addDiscountDigit('3')">3</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" onclick="addDiscountDigit('4')">4</button>
                    <button class="key-btn" onclick="addDiscountDigit('5')">5</button>
                    <button class="key-btn" onclick="addDiscountDigit('6')">6</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" onclick="addDiscountDigit('7')">7</button>
                    <button class="key-btn" onclick="addDiscountDigit('8')">8</button>
                    <button class="key-btn" onclick="addDiscountDigit('9')">9</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn action-btn" onclick="clearDiscountDigits()">C</button>
                    <button class="key-btn" onclick="addDiscountDigit('0')">0</button>
                    <button class="key-btn action-btn" onclick="backspaceDiscountDigit()">⌫</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn confirm-btn" onclick="hideDiscountKeyboard()">✓ Confirmar</button>
                </div>
            `;
            
            // O teclado usará os estilos CSS das classes existentes
            
            // Posicionar o teclado completamente à esquerda do input (considerando a seta)
            var inputRect = currentInputTarget.getBoundingClientRect();
            var keyboardWidth = 280; // largura real do teclado
            var arrowWidth = 12; // largura da seta (right: -12px)
            var spacing = 50; // espaçamento muito maior para garantir separação total
            var leftPosition = inputRect.left - keyboardWidth - arrowWidth - spacing;
            
            // Verificar se o teclado sairia da tela à esquerda
            if (leftPosition < 10) {
                leftPosition = 10; // manter pelo menos 10px da borda esquerda
            }
            
            discountKeyboard.style.position = 'fixed';
            discountKeyboard.style.top = (inputRect.top + (inputRect.height / 2)) + 'px';
            discountKeyboard.style.left = leftPosition + 'px';
            discountKeyboard.style.transform = 'translateY(-50%)';
            discountKeyboard.style.zIndex = '999999';
            discountKeyboard.style.display = 'block';
            
            // Adicionar classe para seta na borda direita
            discountKeyboard.classList.add('keyboard-right-arrow');
            
            // Adicionar ao body
            document.body.appendChild(discountKeyboard);
            
            // Configurar variáveis específicas para desconto
            virtualKeyboardValue = '0';
            currentInputTarget.focus();
            
            // Atualizar display inicial do desconto
            updateDiscountKeyboardDisplay();
            
            // Adicionar event listeners para fechar ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', hideDiscountKeyboardOnClickOutside);
                document.addEventListener('touchstart', hideDiscountKeyboardOnTouchOutside);
            }, 100);
            
            // Garantir estado inicial para animação
            discountKeyboard.style.opacity = '0';
            discountKeyboard.style.transform = 'translateY(-50%) scale(0.9)';
            
            // Forçar animação de entrada
            setTimeout(() => {
                discountKeyboard.style.opacity = '1';
                discountKeyboard.style.transform = 'translateY(-50%) scale(1)';
            }, 10);
            
            console.log('✅ Teclado de desconto criado com sucesso!');
            
            return discountKeyboard;
        }
        
        // Funções específicas para o teclado de desconto
        function addDiscountDigit(digit) {
            console.log('➕ Adicionando dígito ao desconto:', digit);
            
            if (virtualKeyboardValue === '0' && digit !== '.') {
                virtualKeyboardValue = digit;
            } else {
                virtualKeyboardValue += digit;
            }
            
            updateDiscountKeyboardDisplay();
        }
        
        function clearDiscountDigits() {
            console.log('🧹 Limpando desconto');
            virtualKeyboardValue = '0';
            updateDiscountKeyboardDisplay();
        }
        
        function backspaceDiscountDigit() {
            console.log('⬅️ Backspace no desconto');
            if (virtualKeyboardValue.length > 1) {
                virtualKeyboardValue = virtualKeyboardValue.slice(0, -1);
            } else {
                virtualKeyboardValue = '0';
            }
            updateDiscountKeyboardDisplay();
        }
        
        function updateDiscountKeyboardDisplay() {
            // Atualizar o input de desconto diretamente (sem display interno no teclado)
            if (currentInputTarget && currentInputTarget.id === 'discountInput') {
                currentInputTarget.value = virtualKeyboardValue;
                
                // Atualizar o desconto em tempo real
                applyDiscountAutomatically();
            }
        }
        
        function hideDiscountKeyboard() {
            console.log('🔒 Fechando teclado de desconto');
            
            var discountKeyboard = document.getElementById('discountVirtualKeyboard');
            if (discountKeyboard) {
                // Animação de saída
                discountKeyboard.style.opacity = '0';
                discountKeyboard.style.transform = 'translateY(-50%) scale(0.9)';
                
                // Remover após animação
                setTimeout(() => {
                    if (discountKeyboard.parentNode) {
                        discountKeyboard.remove();
                    }
                }, 300);
            }
            
            // Aplicar o valor final ao input
            if (currentInputTarget && currentInputTarget.id === 'discountInput') {
                currentInputTarget.value = virtualKeyboardValue;
                console.log('💰 Valor do desconto aplicado:', virtualKeyboardValue);
            }
            
            // Remover event listeners
            document.removeEventListener('click', hideDiscountKeyboardOnClickOutside);
            document.removeEventListener('touchstart', hideDiscountKeyboardOnTouchOutside);
            
            // Limpar variáveis
            currentInputTarget = null;
            virtualKeyboardValue = '0';
        }

        function createFreshMoneyKeyboard() {
            console.log('💰 Criando teclado virtual do zero para DINHEIRO...');
            
            // Remover teclado existente se houver (especialmente o de desconto)
            var oldKeyboard = document.getElementById('virtualKeyboard');
            if (oldKeyboard) {
                oldKeyboard.remove();
                console.log('💰 Teclado antigo removido');
            }
            
            // Garantir que é para dinheiro
            if (!currentInputTarget || currentInputTarget.id !== 'valorRecebido') {
                console.log('💰 Definindo target como valorRecebido');
                currentInputTarget = document.getElementById('valorRecebido');
            }
            
            // Criar novo teclado para dinheiro
            var newKeyboard = document.createElement('div');
            newKeyboard.id = 'virtualKeyboard';
            newKeyboard.innerHTML = `
                <div style="padding: 20px; background: rgba(44, 11, 90, 0.95); border: 2px solid #9B64E3; border-radius: 16px;">
                    <div id="keyboardDisplay" style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 15px; text-align: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">R$ 0,00</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <button onclick="appendToValue('1')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">1</button>
                        <button onclick="appendToValue('2')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">2</button>
                        <button onclick="appendToValue('3')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">3</button>
                        <button onclick="appendToValue('4')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">4</button>
                        <button onclick="appendToValue('5')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">5</button>
                        <button onclick="appendToValue('6')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">6</button>
                        <button onclick="appendToValue('7')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">7</button>
                        <button onclick="appendToValue('8')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">8</button>
                        <button onclick="appendToValue('9')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">9</button>
                        <button onclick="clearValue()" style="padding: 15px; font-size: 16px; background: #E74C3C; color: white; border: none; border-radius: 8px; cursor: pointer;">Limpar</button>
                        <button onclick="appendToValue('0')" style="padding: 15px; font-size: 18px; background: #4A90E2; color: white; border: none; border-radius: 8px; cursor: pointer;">0</button>
                        <button onclick="backspaceValue()" style="padding: 15px; font-size: 16px; background: #F39C12; color: white; border: none; border-radius: 8px; cursor: pointer;">⌫</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="confirmValue()" style="flex: 1; padding: 15px; font-size: 16px; background: #27AE60; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirmar</button>
                        <button onclick="closeVirtualKeyboard()" style="flex: 1; padding: 15px; font-size: 16px; background: #95A5A6; color: white; border: none; border-radius: 8px; cursor: pointer;">Fechar</button>
                    </div>
                </div>
            `;
            
            // Estilo do teclado
            newKeyboard.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
                background: transparent;
                max-width: 90vw !important;
            `;
            
            // Adicionar ao body
            document.body.appendChild(newKeyboard);
            
            // Configurar variáveis globais
            currentInputTarget = document.getElementById('valorRecebido');
            virtualKeyboardValue = '0';
            
            // Atualizar display inicial
            updateMoneyKeyboardDisplay();
            
            console.log('💰 Novo teclado de dinheiro criado e adicionado ao DOM');
            
            // Fade in
            setTimeout(() => {
                newKeyboard.style.opacity = '1';
            }, 10);
            
            return newKeyboard;
        }
        
        // Função para atualizar o display do teclado de dinheiro em tempo real
        function updateMoneyKeyboardDisplay() {
            var display = document.getElementById('keyboardDisplay');
            if (display && currentInputTarget && currentInputTarget.id === 'valorRecebido') {
                var value = virtualKeyboardValue || '0';
                // Garantir que seja tratado como centavos
                var numValue = parseInt(value) || 0;
                var formatted = (numValue / 100).toFixed(2).replace('.', ',');
                display.textContent = 'R$ ' + formatted;
                
                // Atualizar o input também
                currentInputTarget.value = formatted;
            }
        }
        
        // Função para atualizar o display do teclado em tempo real
        function updateKeyboardDisplay() {
            var display = document.getElementById('keyboardDisplay');
            if (display && currentInputTarget) {
                var value = virtualKeyboardValue || '0';
                var displayValue = '';
                
                if (currentInputTarget.id === 'discountInput') {
                    // Para desconto, mostrar como decimal
                    var numValue = parseFloat(value) / 100;
                    displayValue = numValue.toString();
                    if (currentDiscount && currentDiscount.type === 'percentage') {
                        displayValue += '%';
                    } else {
                        displayValue = 'R$ ' + numValue.toFixed(2).replace('.', ',');
                    }
                } else {
                    // Para dinheiro
                    var paddedValue = value.padStart(3, '0');
                    var reais = paddedValue.slice(0, -2) || '0';
                    var cents = paddedValue.slice(-2);
                    reais = parseInt(reais).toString();
                    displayValue = 'R$ ' + reais + ',' + cents;
                }
                
                display.textContent = displayValue;
                console.log('📺 Display atualizado:', displayValue);
            }
        }
        
        // Função para atualizar o display do teclado em tempo real
        function updateKeyboardDisplay() {
            var display = document.getElementById('keyboardDisplay');
            if (display && currentInputTarget) {
                var value = virtualKeyboardValue || '0';
                var displayValue = '';
                
                if (currentInputTarget.id === 'discountInput') {
                    // Para desconto, mostrar como decimal
                    var numValue = parseFloat(value) / 100;
                    displayValue = numValue.toString();
                    if (currentDiscount.type === 'percentage') {
                        displayValue += '%';
                    } else {
                        displayValue = 'R$ ' + numValue.toFixed(2).replace('.', ',');
                    }
                } else {
                    // Para dinheiro
                    var paddedValue = value.padStart(3, '0');
                    var reais = paddedValue.slice(0, -2) || '0';
                    var cents = paddedValue.slice(-2);
                    reais = parseInt(reais).toString();
                    displayValue = 'R$ ' + reais + ',' + cents;
                }
                
                display.textContent = displayValue;
                console.log('📺 Display atualizado:', displayValue);
            }
        }

        // Função de diagnóstico completa
        function fullDiagnostic() {
            console.log('🔍 === DIAGNÓSTICO COMPLETO INICIADO ===');
            
            // Verificar se elementos existem
            var keyboard = document.getElementById('virtualKeyboard');
            var input = document.getElementById('discountInput');
            
            console.log('🔍 Elementos encontrados:', {
                keyboard: !!keyboard,
                input: !!input,
                keyboardElement: keyboard,
                inputElement: input
            });
            
            if (keyboard) {
                console.log('🔍 Estado do teclado:', {
                    display: keyboard.style.display,
                    visibility: keyboard.style.visibility,
                    opacity: keyboard.style.opacity,
                    className: keyboard.className,
                    offsetWidth: keyboard.offsetWidth,
                    offsetHeight: keyboard.offsetHeight,
                    clientWidth: keyboard.clientWidth,
                    clientHeight: keyboard.clientHeight,
                    innerHTML: keyboard.innerHTML.substring(0, 100) + '...'
                });
                
                // Verificar CSS computado
                var computedStyle = window.getComputedStyle(keyboard);
                console.log('🔍 CSS computado do teclado:', {
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    position: computedStyle.position,
                    zIndex: computedStyle.zIndex,
                    width: computedStyle.width,
                    height: computedStyle.height
                });
                
                // Tentar forçar exibição de várias formas
                console.log('🔍 Tentando forçar exibição...');
                
                // Método 1: CSS inline
                keyboard.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    position: fixed !important;
                    top: 10px !important;
                    left: 10px !important;
                    width: 300px !important;
                    height: 400px !important;
                    background: red !important;
                    z-index: 999999 !important;
                    border: 5px solid yellow !important;
                `;
                
                // Método 2: Attributes
                keyboard.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; top: 50px !important; left: 50px !important; background: blue !important; z-index: 999999 !important; width: 200px !important; height: 200px !important;');
                
                // Método 3: Classes
                keyboard.className = '';
                keyboard.classList.add('virtual-keyboard', 'show');
                
                console.log('🔍 Após tentativas de exibição:', {
                    display: keyboard.style.display,
                    visibility: keyboard.style.visibility,
                    opacity: keyboard.style.opacity,
                    offsetWidth: keyboard.offsetWidth,
                    offsetHeight: keyboard.offsetHeight
                });
                
            } else {
                console.error('🔍 ❌ TECLADO NÃO ENCONTRADO NO DOM!');
            }
            
            // Verificar se há outros elementos com IDs similares
            var allElements = document.querySelectorAll('[id*="keyboard"], [id*="virtual"], [class*="keyboard"], [class*="virtual"]');
            console.log('🔍 Elementos relacionados ao teclado encontrados:', allElements);
            
            // Verificar se há event listeners que podem interferir
            console.log('🔍 Verificando event listeners globais...');
            
            // Tentar proteger o teclado contra interferências
            if (keyboard) {
                // Criar um observer para monitorar mudanças
                var observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            console.log('🔍 ALERTA: Estilo do teclado foi modificado!', keyboard.style.cssText);
                        }
                    });
                });
                
                observer.observe(keyboard, { attributes: true, attributeFilter: ['style', 'class'] });
                console.log('🔍 Observer instalado para monitorar mudanças no teclado');
            }
            
            console.log('🔍 === DIAGNÓSTICO COMPLETO FINALIZADO ===');
        }

        // Função super simples que funciona garantido
        function simpleShowDiscountKeyboard() {
            console.log('⚡ FUNÇÃO SUPER SIMPLES CHAMADA');
            
            var keyboard = document.getElementById('virtualKeyboard');
            var input = document.getElementById('discountInput');
            
            if (!keyboard || !input) {
                console.error('⚡ Elementos não encontrados:', { keyboard: !!keyboard, input: !!input });
                return;
            }
            
            // Set globals
            currentInputTarget = input;
            virtualKeyboardValue = '0';
            
            // Force show with inline styles
            keyboard.setAttribute('style', 
                'display: block !important; ' +
                'visibility: visible !important; ' +
                'opacity: 1 !important; ' +
                'position: fixed !important; ' +
                'top: 20% !important; ' +
                'left: 50% !important; ' +
                'transform: translateX(-50%) !important; ' +
                'z-index: 999999 !important; ' +
                'background: rgba(44, 11, 90, 0.95) !important; ' +
                'border: 2px solid #9B64E3 !important; ' +
                'border-radius: 16px !important; ' +
                'padding: 20px !important;'
            );
            
            keyboard.className = 'virtual-keyboard show';
            updateVirtualKeyboardDisplay();
            
            console.log('⚡ TECLADO SIMPLES ATIVADO COM FORÇA BRUTA');
        }

        // Função de teste para debug - força abertura direta
        function testShowKeyboard() {
            console.log('🧪 TESTE: Forçando abertura do teclado...');
            
            var keyboard = document.getElementById('virtualKeyboard');
            var discountInput = document.getElementById('discountInput');
            
            console.log('🧪 Elementos encontrados:', {
                keyboard: !!keyboard,
                discountInput: !!discountInput,
                keyboardDisplay: keyboard ? keyboard.style.display : 'N/A',
                keyboardVisibility: keyboard ? keyboard.style.visibility : 'N/A'
            });
            
            if (keyboard && discountInput) {
                // Force mostrar o teclado
                currentInputTarget = discountInput;
                virtualKeyboardValue = '0';
                
                keyboard.style.display = 'block';
                keyboard.style.visibility = 'visible';
                keyboard.style.opacity = '1';
                keyboard.style.transform = 'scale(1) translateY(0px)';
                keyboard.style.position = 'fixed';
                keyboard.style.top = '50%';
                keyboard.style.left = '50%';
                keyboard.style.transform = 'translate(-50%, -50%) scale(1)';
                keyboard.style.zIndex = '999999';
                
                keyboard.classList.add('show');
                keyboard.classList.remove('closing');
                
                document.body.classList.add('keyboard-open');
                
                updateVirtualKeyboardDisplay();
                
                console.log('🧪 Teclado forçado a aparecer no centro da tela');
            } else {
                console.error('🧪 ERRO: Elementos não encontrados!');
            }
        }
        
        // Função específica para o teclado de dinheiro (garante teclado original)
        function showVirtualKeyboardForMoney() {
            console.log('� Iniciando teclado virtual para DINHEIRO');
            
            // Usar a função específica do teclado de dinheiro
            createFreshMoneyKeyboard();
        }

        // Função específica para o teclado de dinheiro (garante teclado original)
        function showVirtualKeyboardForMoneyOriginal_TEMP() {
            console.log('� Iniciando teclado virtual para DINHEIRO');
            
            // Usar a função específica do teclado de dinheiro
            createFreshMoneyKeyboard();
        }

        // Funções específicas para o teclado criado
        function clearDigits() {
            virtualKeyboardValue = '';
            updateVirtualKeyboardDisplay();
            updateKeyboardDisplay();
            console.log('🗑️ Dígitos limpos');
        }

        function backspaceDigit() {
            virtualKeyboardValue = virtualKeyboardValue.slice(0, -1);
            updateVirtualKeyboardDisplay();
            updateKeyboardDisplay();
            console.log('⬅️ Backspace, valor atual:', virtualKeyboardValue);
        }

        // Função específica para iPad - força abertura do teclado
        function forceShowKeyboard() {
            var keyboard = document.getElementById('virtualKeyboard');
            var input = document.getElementById('valorRecebido');
            
            console.log('🍎 Forçando abertura do teclado para iPad');
            
            // Remover listeners temporariamente
            keyboardListenersActive = false;
            
            // Forçar fechamento se estiver aberto
            keyboard.style.display = 'none';
            
            // Aguardar um frame e reabrir
            setTimeout(function() {
                showVirtualKeyboard();
            }, 10);
        }
        
        function hideVirtualKeyboard() {
            var keyboard = document.getElementById('virtualKeyboard');
            
            console.log('✨ hideVirtualKeyboard - iniciando fade out');
            
            // Aplicar valor ao input correto
            if (currentInputTarget) {
                console.log('💾 Aplicando valor ao input:', currentInputTarget.id, 'valor:', virtualKeyboardValue);
                
                if (currentInputTarget.id === 'valorRecebido') {
                    var formattedValue = formatCurrency(virtualKeyboardValue / 100);
                    currentInputTarget.value = formattedValue;
                    checkoutData.valorRecebido = virtualKeyboardValue / 100;
                    calculateChange();
                    console.log('💵 Valor aplicado ao valorRecebido:', formattedValue);
                } else if (currentInputTarget.id === 'discountInput') {
                    // Para desconto, aplicar o valor como decimal (sem divisão por 100 pois já está correto)
                    var discountValue = parseFloat(virtualKeyboardValue) / 100;
                    currentInputTarget.value = discountValue.toString();
                    console.log('🏷️ Valor aplicado ao discountInput:', discountValue);
                    
                    // Aplicar o desconto automaticamente
                    handleDiscountInput(currentInputTarget);
                }
                
                currentInputTarget = null; // Limpar referência
            }
            
            // Feedback tátil suave
            if (navigator.vibrate) {
                navigator.vibrate(15);
            }
            
            // Remover classe show para trigger do fade out
            keyboard.classList.remove('show');
            keyboard.classList.add('closing');
            
            // Aguardar animação fade out terminar antes de esconder
            setTimeout(function() {
                keyboard.style.display = 'none';
                keyboard.classList.remove('closing');
                document.body.classList.remove('keyboard-open');
            }, 250);
            
            // Remove event listeners
            document.removeEventListener('click', hideKeyboardOnClickOutside);
            document.removeEventListener('touchstart', hideKeyboardOnTouchOutside);
            window.removeEventListener('resize', repositionKeyboard);
            keyboardListenersActive = false;
            
            // Calcular troco diretamente sem reformatar o input
            var cents = parseInt(virtualKeyboardValue || '0');
            checkoutData.valorRecebido = cents / 100;
            
            var subtotal = 0;
            for (var i = 0; i < cart.length; i++) {
                subtotal += cart[i].preco * cart[i].quantity;
            }
            var total = subtotal - currentDiscount.appliedValue;
            
            checkoutData.troco = checkoutData.valorRecebido - total;
            
            // Debug para verificar valores
            debugLog('💰 Valor recebido: R$ ' + checkoutData.valorRecebido + ' | Total: R$ ' + total + ' | Troco: R$ ' + checkoutData.troco);
            
            // Atualizar displays
            updateOrderSummary();
            updateCartDisplay();
            
            // Controlar habilitação do botão de confirmação
            if (checkoutData.valorRecebido > 0 && checkoutData.troco >= 0) {
                document.getElementById('confirmSaleBtn').disabled = false;
            } else {
                document.getElementById('confirmSaleBtn').disabled = true;
            }
        }
        
        function hideKeyboardOnClickOutside(event) {
            var keyboard = document.getElementById('virtualKeyboard');
            var valorRecebidoInput = document.getElementById('valorRecebido');
            var discountInput = document.getElementById('discountInput');
            
            // Check if keyboard is visible
            if (keyboard.style.display === 'none') {
                return;
            }
            
            // Don't hide if clicking on keyboard or its children
            if (keyboard && keyboard.contains(event.target)) {
                return;
            }
            
            // Don't hide if clicking on any of the inputs (let them handle the focus event)
            if ((valorRecebidoInput && (valorRecebidoInput.contains(event.target) || event.target === valorRecebidoInput)) ||
                (discountInput && (discountInput.contains(event.target) || event.target === discountInput))) {
                return;
            }
            
            // Hide keyboard if clicking outside
            hideVirtualKeyboard();
        }
        
        function hideKeyboardOnTouchOutside(event) {
            var keyboard = document.getElementById('virtualKeyboard');
            var input = document.getElementById('valorRecebido');
            
            // Check if keyboard is visible
            if (keyboard.style.display === 'none') {
                return;
            }
            
            // Don't hide if touching keyboard or its children
            if (keyboard && keyboard.contains(event.target)) {
                event.stopPropagation();
                return;
            }
            
            // Don't hide if touching the input - IMPORTANT for iPad
            if (input && (input.contains(event.target) || event.target === input)) {
                event.stopPropagation();
                return;
            }
            
            // Hide keyboard only if truly touching outside
            setTimeout(function() {
                hideVirtualKeyboard();
            }, 50);
        }
        
        // Funções para fechar o teclado de desconto ao clicar fora
        function hideDiscountKeyboardOnClickOutside(event) {
            var discountKeyboard = document.getElementById('discountVirtualKeyboard');
            var discountInput = document.getElementById('discountInput');
            
            // Verificar se o teclado de desconto está visível
            if (!discountKeyboard || discountKeyboard.style.display === 'none') {
                return;
            }
            
            // Não fechar se clicar no teclado ou seus filhos
            if (discountKeyboard && discountKeyboard.contains(event.target)) {
                return;
            }
            
            // Não fechar se clicar no input de desconto
            if (discountInput && (discountInput.contains(event.target) || event.target === discountInput)) {
                return;
            }
            
            // Fechar teclado se clicar fora
            hideDiscountKeyboard();
        }
        
        function hideDiscountKeyboardOnTouchOutside(event) {
            var discountKeyboard = document.getElementById('discountVirtualKeyboard');
            var discountInput = document.getElementById('discountInput');
            
            // Verificar se o teclado de desconto está visível
            if (!discountKeyboard || discountKeyboard.style.display === 'none') {
                return;
            }
            
            // Não fechar se tocar no teclado ou seus filhos
            if (discountKeyboard && discountKeyboard.contains(event.target)) {
                event.stopPropagation();
                return;
            }
            
            // Não fechar se tocar no input de desconto
            if (discountInput && (discountInput.contains(event.target) || event.target === discountInput)) {
                return;
            }
            
            // Fechar teclado se tocar fora
            setTimeout(() => {
                hideDiscountKeyboard();
            }, 50);
        }
        
        function addDigit(digit) {
            if (virtualKeyboardValue.length < 10) {
                virtualKeyboardValue += digit;
                updateVirtualKeyboardDisplay();
                updateKeyboardDisplay(); // Atualizar display em tempo real
                console.log('🔢 Dígito adicionado:', digit, 'Valor atual:', virtualKeyboardValue);
            }
        }
        
        function deleteDigit() {
            virtualKeyboardValue = virtualKeyboardValue.slice(0, -1);
            updateVirtualKeyboardDisplay();
        }
        
        function clearValue() {
            virtualKeyboardValue = '';
            updateVirtualKeyboardDisplay();
        }
        
        function cancelInput() {
            virtualKeyboardValue = '';
            document.getElementById('valorRecebido').value = '';
            hideVirtualKeyboard();
            calculateChange(document.getElementById('valorRecebido'));
        }
        
        function updateVirtualKeyboardDisplay() {
            var value = virtualKeyboardValue;
            var formattedValue = '';
            
            console.log('💰 updateVirtualKeyboardDisplay chamado:', { value, currentInputTarget: currentInputTarget ? currentInputTarget.id : 'none' });
            
            if (value === '') {
                formattedValue = '';
            } else {
                if (currentInputTarget && currentInputTarget.id === 'discountInput') {
                    // Para desconto, mostrar como número decimal simples
                    var numValue = parseFloat(value) / 100;
                    formattedValue = numValue.toString();
                    console.log('💰 Formatando para desconto:', { value, numValue, formattedValue });
                } else {
                    // Para dinheiro, mostrar como moeda
                    var paddedValue = value.padStart(3, '0');
                    var reais = paddedValue.slice(0, -2) || '0';
                    var cents = paddedValue.slice(-2);
                    reais = parseInt(reais).toString();
                    formattedValue = 'R$ ' + reais + ',' + cents;
                    console.log('💰 Formatando para dinheiro:', { value, formattedValue });
                }
            }
            
            // Atualizar o input correto
            if (currentInputTarget) {
                currentInputTarget.value = formattedValue;
                console.log('💰 Valor aplicado ao input:', currentInputTarget.id, formattedValue);
            } else {
                // Fallback para valorRecebido se não houver target
                document.getElementById('valorRecebido').value = formattedValue;
            }
            
            // Trigger change calculation automatically
            var input = document.getElementById('valorRecebido');
            calculateChange(input);
        }

        function loadCheckoutSellers() {
            // Função simplificada - vendedor já definido no header
            return;
        }
        
        // Função selectCheckoutSeller removida - vendedor já definido no header

        function updateOrderSummary() {
            var orderItemsList = document.getElementById('orderItemsList');
            var orderTotals = document.getElementById('orderTotals');
            var subtotal = 0;
            var itemsHtml = '';
            var totalsHtml = '';

            // Lista de itens (scrollável)
            for (var i = 0; i < cart.length; i++) {
                var item = cart[i];
                var itemTotal = item.preco * item.quantity;
                subtotal += itemTotal;

                itemsHtml += '<div class="order-item">';
                itemsHtml += '<div class="order-item-info">' + item.nome + ' (x' + item.quantity + ')<br><small style="color: #888; font-size: 0.85em;">Valor unitário: ' + formatCurrency(item.preco) + '</small></div>';
                itemsHtml += '<div class="order-item-price">' + formatCurrency(itemTotal) + '</div>';
                itemsHtml += '</div>';
            }

            // Resumo fixo (não scrollável)
            totalsHtml += '<div class="order-item">';
            totalsHtml += '<div class="order-item-info"><strong>Subtotal:</strong></div>';
            totalsHtml += '<div class="order-item-price"><strong>' + formatCurrency(subtotal) + '</strong></div>';
            totalsHtml += '</div>';

            if (currentDiscount.appliedValue > 0) {
                totalsHtml += '<div class="order-item">';
                totalsHtml += '<div class="order-item-info" style="color: #4ade80;">Desconto:</div>';
                totalsHtml += '<div class="order-item-price" style="color: #4ade80;">- ' + formatCurrency(currentDiscount.appliedValue) + '</div>';
                totalsHtml += '</div>';
            }

            var total = subtotal - currentDiscount.appliedValue;
            totalsHtml += '<div class="order-item" style="border-top: 1px solid rgba(155, 100, 227, 0.3); margin-top: 5px; padding-top: 5px; font-size: 1.1em;">';
            totalsHtml += '<div class="order-item-info"><strong>Total:</strong></div>';
            totalsHtml += '<div class="order-item-price" style="color: #9B64E3;"><strong>' + formatCurrency(total) + '</strong></div>';
            totalsHtml += '</div>';

            // Adicionar troco apenas quando houver troco positivo
            if (checkoutData.troco > 0) {
                totalsHtml += '<div class="order-item" style="border-top: 1px solid rgba(155, 100, 227, 0.3); margin-top: 5px; padding-top: 5px;">';
                totalsHtml += '<div class="order-item-info" style="color: #4ade80;"><strong>Troco:</strong></div>';
                totalsHtml += '<div class="order-item-price" style="color: #4ade80;"><strong>' + formatCurrency(checkoutData.troco) + '</strong></div>';
                totalsHtml += '</div>';
            }

            orderItemsList.innerHTML = itemsHtml;
            orderTotals.innerHTML = totalsHtml;
        }

        function confirmSale() {
            if (!checkoutData.paymentMethod) {
                alert('Selecione um método de pagamento');
                return;
            }
            
            // Verificar vendedor selecionado no dropdown do checkout
            var vendedorSelecionado = selectedUserId;
            
            if (!vendedorSelecionado) {
                alert('Selecione um vendedor');
                return;
            }
            
            // Atualizar o vendedor selecionado se foi alterado no checkout
            if (vendedorSelecionado !== selectedUserId) {
                selectedUserId = vendedorSelecionado;
                usuarioLogado = usuarios.find(function(u) { return u.id == vendedorSelecionado; });
            }
            
            var subtotal = 0;
            for (var i = 0; i < cart.length; i++) {
                subtotal += cart[i].preco * cart[i].quantity;
            }
            
            var saleData = {
                usuario_id: vendedorSelecionado,
                itens: [],
                subtotal: subtotal,
                desconto: currentDiscount.appliedValue,
                total: subtotal - currentDiscount.appliedValue,
                metodo_pagamento: checkoutData.paymentMethod,
                parcelas: checkoutData.installments,
                valor_recebido: checkoutData.valorRecebido || null,
                troco: checkoutData.troco || null
            };
            
            // Mapear itens do carrinho
            for (var j = 0; j < cart.length; j++) {
                var item = cart[j];
                saleData.itens.push({
                    produto_id: item.id,
                    quantidade: item.quantity,
                    preco_unitario: item.preco,
                    subtotal: item.preco * item.quantity
                });
            }
            
            debugLog('💳 Confirmando venda para vendedor ' + vendedorSelecionado + ': ' + JSON.stringify(saleData));
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/vendas', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    debugLog('📡 Resposta da venda - Status: ' + xhr.status + ', Response: ' + xhr.responseText);
                    
                    // Status 200 (OK) ou 201 (Created) são sucessos
                    if (xhr.status === 200 || xhr.status === 201) {
                        try {
                            var result = JSON.parse(xhr.responseText);
                            debugLog('✅ Resposta da venda parseada: ' + JSON.stringify(result));
                            
                            if (result.status === 'success') {
                                // Calcular total de itens vendidos
                                var totalItens = 0;
                                for (var k = 0; k < saleData.itens.length; k++) {
                                    totalItens += saleData.itens[k].quantidade;
                                }
                                
                                var itemText = totalItens === 1 ? 'item' : 'itens';
                                showPdvNotification('success', 'Venda realizada com sucesso!\n' + totalItens + ' ' + itemText + ' vendidos\nTotal: ' + formatCurrency(saleData.total));
                                
                                // Limpar carrinho e fechar modal
                                cart = [];
                                currentDiscount.amount = 0;
                                currentDiscount.appliedValue = 0;
                                document.getElementById('discountInput').value = '';
                                updateCartDisplay();
                                updateDiscountDisplay();
                                closeCheckoutModal();
                            } else {
                                debugLog('❌ Erro na venda: ' + (result.message || 'Erro desconhecido'));
                                showPdvNotification('error', 'Erro ao realizar venda: ' + (result.message || 'Erro desconhecido'));
                            }
                        } catch (e) {
                            debugLog('❌ Erro ao processar resposta da venda: ' + e.message + ' | Response: ' + xhr.responseText);
                            showPdvNotification('error', 'Erro ao processar resposta do servidor');
                        }
                    } else {
                        debugLog('❌ Erro HTTP na venda: ' + xhr.status + ' | Response: ' + xhr.responseText);
                        showPdvNotification('error', 'Erro ao conectar com o servidor (HTTP ' + xhr.status + ')');
                    }
                }
            };
            
            xhr.onerror = function() {
                debugLog('❌ Erro de conexão na venda');
                showPdvNotification('error', 'Erro de conexão com o servidor');
            };
            
            xhr.send(JSON.stringify(saleData));
        }

        // Função para mostrar notificação
        function showPdvNotification(type, message, errorCode = null) {
            const iconContainer = document.getElementById('pdvNotificationIcon');
            
            if (type === 'success') {
                iconContainer.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#4CAF50">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">
                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.5s" begin="0.3s" fill="freeze"/>
                </path>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>
                <animateTransform attributeName="transform" type="rotate" values="-15;0;15;0" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        `;
            } else {
                iconContainer.innerHTML = `
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#F44336">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M8 8L16 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">
                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.3s" fill="freeze"/>
                </path>
                <path d="M16 8L8 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="15" stroke-dashoffset="15">
                    <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.5s" fill="freeze"/>
                </path>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.2;1" dur="0.8s" repeatCount="1" additive="sum"/>
                <animateTransform attributeName="transform" type="rotate" values="0;15;-15;0" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        `;
            }
            
            const modal = document.getElementById('pdvNotificationModal');
            const title = document.getElementById('pdvNotificationModalTitle');
            const msg = document.getElementById('pdvNotificationModalMessage');
            const content = modal.querySelector('.pdv-notification-modal');
            const debugContainer = document.getElementById('pdvNotificationDebugInfo');
            
            title.textContent = type === 'success' ? 'Sucesso!' : 'Erro!';
            msg.textContent = message;
            content.className = 'pdv-notification-modal ' + type;
            
            // Exibir informações de debug se houver um código de erro
            if (errorCode && debugContainer) {
                debugContainer.textContent = `Código de erro: ${errorCode}`;
                debugContainer.style.display = 'block';
            } else if (debugContainer) {
                debugContainer.style.display = 'none';
            }
            
            modal.style.display = 'block';
        }

        function closePdvNotificationModal() {
            document.getElementById('pdvNotificationModal').style.display = 'none';
        }

        // Variáveis para controle do toque e segura
        var touchTimer = null;
        var touchMoved = false;
        var longPressTriggered = false;

        // Função para mostrar modal de imagem completa
        function showImageModal(productId, productName) {
            if (longPressTriggered) {
                longPressTriggered = false;
                return; // Evita abrir modal em clique normal após long press
            }
            
            var modal = document.getElementById('imageModal');
            var modalImage = document.getElementById('modalImage');
            var modalTitle = document.getElementById('modalImageTitle');
            
            // Configurar imagem em qualidade completa
            modalImage.src = '/api/produtos/' + productId + '/imagem?quality=full';
            modalTitle.textContent = productName;
            
            modal.style.display = 'block';
        }

        // Função para fechar modal de imagem
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Controle de toque e segura para mostrar imagem completa
        function handleImageTouchStart(event, productId, productName) {
            touchMoved = false;
            longPressTriggered = false;
            
            // Limpar qualquer timer anterior
            if (touchTimer) {
                clearTimeout(touchTimer);
            }
            
            // Configurar timer para long press (800ms)
            touchTimer = setTimeout(function() {
                if (!touchMoved) {
                    longPressTriggered = true;
                    // Vibração tátil se disponível
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    showImageModal(productId, productName);
                }
            }, 800);
        }

        function handleImageTouchMove() {
            touchMoved = true;
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
            }
        }

        function handleImageTouchEnd() {
            if (touchTimer) {
                clearTimeout(touchTimer);
                touchTimer = null;
            }
        }

        // Função para quando a imagem carrega com sucesso
        function handleImageLoad(productId) {
            debugLog('🖼️ Imagem carregada para produto ' + productId);
            
            // Limpar interval de progresso e completar
            if (window.progressIntervals && window.progressIntervals[productId]) {
                clearInterval(window.progressIntervals[productId]);
                delete window.progressIntervals[productId];
            }
            
            // Completar progresso
            updateProductProgress(productId, 100);
            
            // Atualizar tracker
            imageLoadingTracker.loaded++;
            
            var productContainer = document.getElementById('product-img-' + productId);
            var loadingIndicator = document.getElementById('loading-' + productId);
            
            if (productContainer) {
                productContainer.classList.add('loaded');
                debugLog('✅ Container marcado como carregado');
            }
            
            // Remover o loading após mostrar 100% por um momento
            if (loadingIndicator) {
                setTimeout(function() {
                    loadingIndicator.style.display = 'none';
                    debugLog('🔄 Loading removido');
                }, 500); // Aumentar tempo para ver o 100%
            }
            
            debugLog('📈 Progresso geral: ' + imageLoadingTracker.loaded + '/' + imageLoadingTracker.total);
        }

        // Sistema de tracking de carregamento de imagens
        var imageLoadingTracker = {
            total: 0,
            loaded: 0,
            failed: 0,
            products: []
        };
        
        // Objeto global para armazenar intervals de progresso
        window.progressIntervals = {};

        // Função para inicializar o tracking
        function initializeImageLoadingTracker(productsWithImages) {
            imageLoadingTracker.total = productsWithImages.length;
            imageLoadingTracker.loaded = 0;
            imageLoadingTracker.failed = 0;
            imageLoadingTracker.products = productsWithImages.map(function(p) { return p.id; });
            
            debugLog('📊 Tracker inicializado - ' + imageLoadingTracker.total + ' imagens para carregar');
            
            // Iniciar simulação de progresso para cada produto
            for (var i = 0; i < productsWithImages.length; i++) {
                var productId = productsWithImages[i].id;
                simulateImageProgress(productId);
            }
        }

        // Função para atualizar progresso de um produto específico
        function updateProductProgress(productId, progress) {
            var progressElement = document.getElementById('progress-' + productId);
            if (progressElement) {
                progressElement.textContent = progress + '%';
            }
        }

        // Função para simular progresso de carregamento
        function simulateImageProgress(productId) {
            var progress = 0;
            var progressInterval = setInterval(function() {
                progress += Math.random() * 15 + 5; // Incremento aleatório entre 5-20%
                if (progress >= 90) {
                    progress = 90; // Para em 90% até carregar realmente
                    clearInterval(progressInterval);
                }
                updateProductProgress(productId, Math.round(progress));
            }, 150);
            
            // Guardar referência do interval para limpar depois
            if (!window.progressIntervals) window.progressIntervals = {};
            window.progressIntervals[productId] = progressInterval;
        }

        // Função para verificar se uma imagem já está em cache
        function isImageCached(src) {
            // No iPad, sempre mostrar loading para melhor experiência
            return false;
        }

        // Função para configurar timeout de loading
        function setupImageLoadingTimeout(productId) {
            setTimeout(function() {
                var productContainer = document.getElementById('product-img-' + productId);
                var loadingIndicator = document.getElementById('loading-' + productId);
                
                // Se ainda está carregando após 10 segundos, mostrar erro
                if (productContainer && !productContainer.classList.contains('loaded') && !productContainer.classList.contains('image-error')) {
                    if (loadingIndicator) {
                        loadingIndicator.innerHTML = '<div style="text-align: center; color: rgba(155, 100, 227, 0.6);">' +
                                                   '<div style="font-size: 20px;">⏱️</div>' +
                                                   '<div class="loading-text">Timeout</div>' +
                                                   '</div>';
                    }
                    
                    productContainer.classList.add('image-timeout');
                }
            }, 10000); // 10 segundos
        }

        // Função para quando há erro no carregamento da imagem
        function handleImageError(productId) {
            debugLog('❌ Erro ao carregar imagem para produto ' + productId);
            
            // Limpar interval de progresso
            if (window.progressIntervals && window.progressIntervals[productId]) {
                clearInterval(window.progressIntervals[productId]);
                delete window.progressIntervals[productId];
            }
            
            // Atualizar tracker
            imageLoadingTracker.failed++;
            
            var productContainer = document.getElementById('product-img-' + productId);
            var loadingIndicator = document.getElementById('loading-' + productId);
            
            if (loadingIndicator) {
                loadingIndicator.innerHTML = '<div style="text-align: center; color: rgba(155, 100, 227, 0.6);">' +
                                           '<div style="font-size: 24px;">⚠️</div>' +
                                           '<div class="loading-text">Erro ao carregar</div>' +
                                           '</div>';
                debugLog('🔄 Loading atualizado com erro');
            }
            
            // Adicionar classe de erro para estilização especial se necessário
            if (productContainer) {
                productContainer.classList.add('image-error');
                debugLog('❌ Container marcado com erro');
            }
            
            debugLog('📊 Status: ' + imageLoadingTracker.loaded + ' carregadas, ' + imageLoadingTracker.failed + ' falharam');
        }

        // Função para scanner de código de barras
        function scanBarcode() {
            alert('Funcionalidade de scanner em desenvolvimento');
        }

        // Função de busca com debounce
        function setupSearch() {
            var searchInput = document.getElementById('productSearch');
            searchInput.addEventListener('input', function() {
                var searchTerm = this.value;
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                searchTimeout = setTimeout(function() {
                    renderProducts(searchTerm);
                }, 300);
            });
        }

        // Função de inicialização
        function initializePDV() {
            debugLog('🚀 Inicializando PDV completo...');
            
            // Verificar se os elementos necessários existem
            var productsGrid = document.getElementById('productsGrid');
            var currentUserNavbar = document.getElementById('currentUserNavbar');
            
            if (!productsGrid) {
                debugLog('❌ Elemento productsGrid não encontrado no DOM');
                showError('Erro: Grade de produtos não encontrada');
                return;
            }
            
            if (!currentUserNavbar) {
                debugLog('❌ Elemento currentUserNavbar não encontrado no DOM');
                showError('Erro: Elemento de usuário da navbar não encontrado');
                return;
            }
            
            debugLog('✅ Elementos DOM verificados com sucesso');
            
            loadUsuarios();
            loadProducts();
            setupSearch();
        }

        // Controle dos dropdowns customizados
        document.addEventListener('click', function(e) {
            // Fechar todos os dropdowns quando clicar fora
            var dropdowns = document.querySelectorAll('.custom-select');
            dropdowns.forEach(function(dropdown) {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('open');
                }
            });
            
            // Abrir dropdown quando clicar no botão
            if (e.target.closest('.custom-select button')) {
                var dropdown = e.target.closest('.custom-select');
                dropdown.classList.toggle('open');
                e.preventDefault();
                e.stopPropagation();
            }
        });

        // Adicionar listener para tecla ESC
        document.addEventListener('keydown', function(event) {

        });

        // Funções para indicadores de scroll
        function initializeScrollIndicators() {
            var productsGrid = document.getElementById('productsGrid');
            var cartItems = document.getElementById('cartItems');
            
            if (productsGrid) {
                // Criar container wrapper se não existir
                var wrapper = productsGrid.parentElement;
                if (!wrapper.classList.contains('products-grid-container')) {
                    var container = document.createElement('div');
                    container.className = 'products-grid-container';
                    productsGrid.parentElement.insertBefore(container, productsGrid);
                    container.appendChild(productsGrid);
                    wrapper = container;
                }
                
                productsGrid.addEventListener('scroll', function() {
                    updateScrollIndicators(productsGrid, wrapper);
                });
                
                // Verificar inicialmente
                setTimeout(function() {
                    updateScrollIndicators(productsGrid, wrapper);
                }, 500);
            }
            
            if (cartItems) {
                var cartPanel = document.querySelector('.cart-panel');
                if (cartPanel) {
                    cartItems.addEventListener('scroll', function() {
                        updateCartScrollIndicator(cartItems, cartPanel);
                    });
                    
                    // Verificar inicialmente
                    setTimeout(function() {
                        updateCartScrollIndicator(cartItems, cartPanel);
                    }, 500);
                }
            }
        }
        
        function updateScrollIndicators(element, container) {
            if (!element || !container) return;
            
            var scrollTop = element.scrollTop;
            var scrollHeight = element.scrollHeight;
            var clientHeight = element.clientHeight;
            var maxScroll = scrollHeight - clientHeight;
            
            // Mostrar indicador superior se não estiver no topo
            if (scrollTop > 20) {
                container.classList.add('show-scroll-top');
            } else {
                container.classList.remove('show-scroll-top');
            }
            
            // Mostrar indicador inferior se não estiver no final
            if (scrollTop < maxScroll - 20) {
                container.classList.add('show-scroll-bottom');
            } else {
                container.classList.remove('show-scroll-bottom');
            }
        }
        
        function updateCartScrollIndicator(element, container) {
            if (!element || !container) return;
            
            var scrollTop = element.scrollTop;
            var scrollHeight = element.scrollHeight;
            var clientHeight = element.clientHeight;
            var maxScroll = scrollHeight - clientHeight;
            
            // Mostrar indicador se há conteúdo para fazer scroll e não está no final
            if (maxScroll > 10 && scrollTop < maxScroll - 10) {
                container.classList.add('show-cart-scroll');
            } else {
                container.classList.remove('show-cart-scroll');
            }
        }

        // Inicializar quando a página carrega
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('📄 DOM carregado');
            
            // Prevenir zoom por duplo toque
            var lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                var now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Event listeners específicos para iPad no input de desconto
            var discountInput = document.getElementById('discountInput');
            if (discountInput) {
                console.log('🎯 discountInput encontrado, adicionando listeners extras');
                
                // Múltiplos event listeners para garantir funcionamento
                discountInput.addEventListener('click', function(e) {
                    console.log('🖱️ discountInput clicado via addEventListener');
                    e.preventDefault();
                    e.stopPropagation();
                    simpleShowDiscountKeyboard();
                });
                
                discountInput.addEventListener('touchstart', function(e) {
                    console.log('👆 discountInput touchstart via addEventListener');
                    e.preventDefault();  
                    e.stopPropagation();
                    simpleShowDiscountKeyboard();
                });
                
                discountInput.addEventListener('mousedown', function(e) {
                    console.log('🖱️ discountInput mousedown via addEventListener');
                    e.preventDefault();
                    e.stopPropagation();
                    forceShowDiscountKeyboard();
                });
                
                discountInput.addEventListener('focus', function(e) {
                    console.log('🎯 discountInput focus via addEventListener');
                    forceShowDiscountKeyboard();
                });
                
                // Listener adicional para debug
                discountInput.addEventListener('pointerdown', function(e) {
                    console.log('👉 discountInput pointerdown via addEventListener');
                    e.preventDefault();
                    forceShowDiscountKeyboard();
                });
                
            } else {
                console.error('❌ discountInput NÃO encontrado no DOM!');
            }

            // Event listeners específicos para iPad no input valorRecebido
            var valorInput = document.getElementById('valorRecebido');
            if (valorInput) {
                // Adicionar múltiplos event listeners para garantir que funcione no iPad
                valorInput.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('📱 Click detectado no input');
                    showVirtualKeyboard();
                });
                
                valorInput.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    console.log('📱 Touch start detectado no input');
                    setTimeout(function() {
                        showVirtualKeyboard();
                    }, 50);
                }, { passive: false });
                
                valorInput.addEventListener('focus', function(e) {
                    console.log('📱 Focus detectado no input');
                    showVirtualKeyboard();
                });
            }
            
            initializePDV();

            // Event listeners para modais de imagem
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });

            // Fechar modal de imagem ao clicar no backdrop
            document.addEventListener('click', function(event) {
                var imageModal = document.getElementById('imageModal');
                if (event.target === imageModal) {
                    closeImageModal();
                }
            });
            
            // Inicializar indicadores de scroll
            initializeScrollIndicators();
        });

        // Função para carregar foto do usuário na navbar
        function loadUserPhotoNavbar() {
            debugLog('📷 Tentando carregar foto do usuário na navbar...');
            
            if (!usuarioLogado || !usuarioLogado.id) {
                debugLog('❌ Usuário não logado ou ID não encontrado');
                return;
            }
            
            var userAvatarNavbar = document.getElementById('userAvatarNavbar');
            if (!userAvatarNavbar) {
                debugLog('❌ Elemento userAvatarNavbar não encontrado');
                return;
            }
            
            debugLog('✅ Elemento userAvatarNavbar encontrado, carregando foto para usuário ID: ' + usuarioLogado.id);
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/user-photo/' + usuarioLogado.id, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success' && response.photo) {
                                var img = document.createElement('img');
                                img.src = response.photo;
                                img.style.width = '24px';
                                img.style.height = '24px';
                                img.style.borderRadius = '50%';
                                img.style.objectFit = 'cover';
                                img.onerror = function() {
                                    // Se falhar ao carregar a imagem, manter o ícone SVG
                                    debugLog('❌ Erro ao carregar foto do usuário na navbar');
                                };
                                userAvatarNavbar.innerHTML = '';
                                userAvatarNavbar.appendChild(img);
                                
                                // Atualizar foto no dropdown também
                                var userAvatarDropdown = document.querySelector('.user-avatar-large');
                                if (userAvatarDropdown) {
                                    var imgDropdown = document.createElement('img');
                                    imgDropdown.src = response.photo;
                                    imgDropdown.style.width = '32px';
                                    imgDropdown.style.height = '32px';
                                    imgDropdown.style.borderRadius = '50%';
                                    imgDropdown.style.objectFit = 'cover';
                                    imgDropdown.onerror = function() {
                                        debugLog('❌ Erro ao carregar foto no dropdown');
                                    };
                                    userAvatarDropdown.innerHTML = '';
                                    userAvatarDropdown.appendChild(imgDropdown);
                                }
                                
                                debugLog('✅ Foto do usuário carregada na navbar e dropdown');
                            } else {
                                debugLog('ℹ️ Usuário sem foto, mantendo ícone padrão');
                            }
                        } catch (e) {
                            debugLog('❌ Erro JSON foto usuário: ' + e.message);
                        }
                    } else {
                        debugLog('ℹ️ Foto do usuário não encontrada (HTTP ' + xhr.status + ')');
                    }
                }
            };
            
            xhr.send();
        }



        // Função principal de toggle fullscreen
        function toggleFullscreen() {
            try {
                debugLog('🎯 Toggle fullscreen chamado. Estado atual: ' + (isInFullscreen() ? 'ativo' : 'inativo'));
                
                if (!isInFullscreen()) {
                    // Tentar entrar em fullscreen
                    var element = document.documentElement;
                    var success = false;
                    
                    if (element.requestFullscreen) {
                        element.requestFullscreen();
                        success = true;
                    } else if (element.webkitRequestFullscreen) {
                        element.webkitRequestFullscreen();
                        success = true;
                    } else if (element.webkitRequestFullScreen) {
                        element.webkitRequestFullScreen();
                        success = true;
                    } else if (element.mozRequestFullScreen) {
                        element.mozRequestFullScreen();
                        success = true;
                    } else if (element.msRequestFullscreen) {
                        element.msRequestFullscreen();
                        success = true;
                    }
                    
                    if (success) {
                        fullscreenActive = true;
                        fullscreenRetryCount = 0;
                        debugLog('✅ Fullscreen solicitado com sucesso');
                        
                        // Configurar listeners para reativar fullscreen quando sair
                        setupFullscreenMonitoring();
                    } else {
                        handleFullscreenError('Fullscreen não suportado neste navegador');
                    }
                    
                } else {
                    // Sair do fullscreen
                    fullscreenActive = false;
                    exitFullscreen().then(function() {
                        debugLog('✅ Fullscreen desativado');
                        removeFullscreenMonitoring();
                    }).catch(function(error) {
                        debugLog('❌ Erro ao sair do fullscreen: ' + error.message);
                    });
                }
                
            } catch (error) {
                debugLog('❌ Erro geral no toggle fullscreen: ' + error.message);
                handleFullscreenError();
            }
        }







        // ==================== PWA SERVICE WORKER ====================
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        debugLog('✅ Service Worker registrado com sucesso:', registration.scope);
                        
                        // Verificar atualizações
                        registration.addEventListener('updatefound', function() {
                            debugLog('🔄 Atualização do Service Worker encontrada');
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nova versão disponível
                                    showPdvNotification('info', 'Nova versão disponível! Recarregue a página para atualizar.');
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        debugLog('❌ Falha ao registrar Service Worker:', error);
                    });
                
                // Listener para mensagens do Service Worker
                navigator.serviceWorker.addEventListener('message', function(event) {
                    debugLog('📨 Mensagem do Service Worker:', event.data);
                });
            });
        } else {
            debugLog('⚠️ Service Worker não suportado neste navegador');
        }
        
        // Detectar quando o app é instalado como PWA
        window.addEventListener('beforeinstallprompt', function(e) {
            // Prevenir o prompt automático
            e.preventDefault();
            
            // Armazenar o evento para usar depois
            window.deferredPrompt = e;
            
            debugLog('📱 PWA pode ser instalado');
            
            // Opcionalmente, mostrar um botão de instalação personalizado
            // showPdvNotification('info', 'Este app pode ser instalado no seu iPad!');
        });
        
        // Detectar quando o PWA é instalado
        window.addEventListener('appinstalled', function(evt) {
            debugLog('🎉 PWA instalado com sucesso!');
            showPdvNotification('success', 'App instalado! Agora você pode acessá-lo diretamente da tela inicial.');
        });
        
        // Detectar modo PWA (standalone)
        function isPWAMode() {
            return window.matchMedia && window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }
        
        // Configurar PWA e status bar personalizada
        function configurePWA() {
            const isPWA = isPWAMode();
            
            if (isPWA) {
                debugLog('📱 Executando em modo PWA (standalone)');
                
                // Adicionar classe CSS para modo PWA
                document.body.classList.add('pwa-mode');
                
                // Configurar cor da status bar dinamicamente
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (themeColorMeta) {
                    themeColorMeta.setAttribute('content', '#9B64E3');
                }
                
                // Configurar altura da viewport para considerar safe areas
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover'
                    );
                }
                
                // Adicionar CSS inline para status bar se necessário (iPad Air 1 compatibilidade)
                if (navigator.userAgent.includes('iPad')) {
                    const style = document.createElement('style');
                    style.textContent = `
                        @media (display-mode: standalone) {
                            body::before {
                                background: rgba(44, 11, 90, 0.85) !important;
                                backdrop-filter: blur(20px) !important;
                                -webkit-backdrop-filter: blur(20px) !important;
                            }
                            .navbar {
                                background: rgba(44, 11, 90, 0.85) !important;
                                backdrop-filter: blur(20px) !important;
                                -webkit-backdrop-filter: blur(20px) !important;
                                box-shadow: 
                                    0 2px 10px rgba(44, 11, 90, 0.3),
                                    0 8px 25px rgba(44, 11, 90, 0.4),
                                    0 0 40px rgba(44, 11, 90, 0.2),
                                    0 0 80px rgba(44, 11, 90, 0.1) !important;
                                top: 20px !important;
                            }
                            .search-container {
                                background: rgba(44, 11, 90, 0.85) !important;
                                backdrop-filter: blur(20px) !important;
                                -webkit-backdrop-filter: blur(20px) !important;
                                border: 1px solid rgba(155, 100, 227, 0.7) !important;
                            }
                            .virtual-keyboard {
                                background: rgba(44, 11, 90, 0.85) !important;
                                backdrop-filter: blur(25px) !important;
                                -webkit-backdrop-filter: blur(25px) !important;
                                border: 2px solid rgba(155, 100, 227, 0.7) !important;
                            }
                            .modal-overlay {
                                background-color: rgba(0, 0, 0, 0.3) !important;
                                backdrop-filter: blur(5px) !important;
                                -webkit-backdrop-filter: blur(5px) !important;
                            }
                            .checkout-modal {
                                background-color: rgba(44, 11, 90, 0.85) !important;
                                backdrop-filter: blur(20px) !important;
                                -webkit-backdrop-filter: blur(20px) !important;
                                border: 1px solid rgba(155, 100, 227, 0.7) !important;
                            }
                            .pdv-container {
                                margin-top: 80px !important;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                debugLog('🎨 Status bar configurada com tema Midnight');
            } else {
                debugLog('🌐 Executando em navegador normal');
                document.body.classList.add('browser-mode');
            }
        }
        
        // Executar configuração PWA
        configurePWA();
        
        // ==================== FIM PWA ====================

        debugLog('🌐 PDV Completo iOS 12 carregado');
    </script>
</body>
</html>