<!-- Tooltip que segue o cursor -->
<div id="cursorTooltip" class="cursor-tooltip">
    Clique direito para remover
</div>

<!-- Tooltip para causas que segue o cursor -->
<div id="causeTooltip" class="cursor-cause-tooltip">
    <div id="causeTooltipContent"></div>
</div>

<!-- Menu de contexto para remoção de materiais -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item danger" onclick="confirmRemoveMaterial()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Remover Material
    </div>
</div>

<!-- Modal de confirmação personalizado -->
<div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-modal-content">
        <div class="confirmation-modal-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <h3 class="confirmation-modal-title">Confirmar Remoção</h3>
        </div>
        <p class="confirmation-modal-message">
            Deseja remover este material da lista? Esta ação não pode ser desfeita.
        </p>
        <div class="confirmation-modal-buttons">
            <button class="confirmation-btn confirmation-btn-cancel" onclick="closeConfirmationModal()">
                Cancelar
            </button>
            <button class="confirmation-btn confirmation-btn-confirm" onclick="executeMaterialRemoval()">
                Remover
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Atualização de Preços -->
<div id="atualizarPrecosModal" class="modal" style="display: none;">
    <div class="modal-content-price-update">
        <span class="close-button" onclick="closeAtualizarPrecosModal()">&times;</span>
        
        <!-- Cabeçalho do Modal -->
        <div class="modal-header-fixed">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--cor-destaque, #9B64E3);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #FFD700;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <div>
                    <h2 style="margin: 0; color: white;">Confirmar Atualização de Preços</h2>
                    <p style="margin: 5px 0 0 0; color: #D8CEFE; font-size: 14px;">Foram detectadas alterações nos custos de materiais e/ou máquinas. Revisar impactos nos preços dos produtos.</p>
                </div>
            </div>

            <!-- Resumo das Alterações -->
            <div class="price-update-summary" style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;">
                <div class="summary-card" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, rgba(155, 100, 227, 0.2), rgba(155, 100, 227, 0.1)); border: 1px solid #9B64E3; border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #FFD700;" id="produtosAfetadosCount">0</div>
                    <div style="color: #D8CEFE; font-size: 14px;">Produtos Afetados</div>
                </div>
                <div class="summary-card" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, rgba(255, 71, 87, 0.2), rgba(255, 71, 87, 0.1)); border: 1px solid #FF4757; border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #FF4757;" id="materiaisAlteradosCount">0</div>
                    <div style="color: #D8CEFE; font-size: 14px;">Materiais Alterados</div>
                </div>
                <div class="summary-card" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(46, 213, 115, 0.1)); border: 1px solid #2ED573; border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #2ED573;" id="maquinasAlteradasCount">0</div>
                    <div style="color: #D8CEFE; font-size: 14px;">Máquinas Alteradas</div>
                </div>
            </div>

            <!-- Filtros de Visualização -->
            <div class="price-update-filters" style="background-color: rgba(19, 4, 60, 0.69); backdrop-filter: blur(10px); border: 2px solid #9B64E3; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="color: white; font-size: 14px;">Categoria:</label>
                        <select id="filtroCategoria" style="padding: 8px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; min-width: 150px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="color: white; font-size: 14px;">Impacto:</label>
                        <select id="filtroImpacto" style="padding: 8px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; min-width: 120px;">
                            <option value="">Todos</option>
                            <option value="alto">Alto (>20%)</option>
                            <option value="medio">Médio (5-20%)</option>
                            <option value="baixo">Baixo (<5%)</option>
                        </select>
                    </div>
                    <div style="max-width: 250px; min-width: 200px;">
                        <input type="text" id="filtroProduto" placeholder="Buscar produto..." style="width: 100%; padding: 8px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Produtos com Scroll -->
        <div class="modal-content-scrollable">
            <!-- Tabela de Produtos Afetados -->
            <div class="price-update-table-container" style="background-color: var(--order-card-bg); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <table class="price-update-table" style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background-color: var(--order-card-bg); z-index: 10;">
                        <tr style="border-bottom: 2px solid var(--cor-destaque, #9B64E3);">
                            <th style="padding: 12px 8px; text-align: center; color: var(--column-title-text); width: 50px;">
                                <input type="checkbox" id="selectAllProducts" onchange="toggleAllProductSelection()" style="cursor: pointer;">
                            </th>
                            <th style="padding: 12px; text-align: left; color: var(--column-title-text);">Produto</th>
                            <th style="padding: 12px; text-align: center; color: var(--column-title-text); width: 120px;">Categoria</th>
                            <th style="padding: 12px; text-align: right; color: var(--column-title-text); width: 100px;">Preço Atual</th>
                            <th style="padding: 12px; text-align: right; color: var(--column-title-text); width: 100px;">Novo Preço</th>
                            <th style="padding: 12px; text-align: center; color: var(--column-title-text); width: 80px;">Variação</th>
                            <th style="padding: 12px; text-align: center; color: var(--column-title-text); width: 80px;">Impacto</th>
                            <th style="padding: 12px; text-align: left; color: var(--column-title-text); width: 150px;">Causas</th>
                        </tr>
                    </thead>
                    <tbody id="priceUpdateTableBody">
                        <!-- Produtos serão carregados dinamicamente aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer do Modal Fixo -->
        <div class="modal-footer-fixed">
            <!-- Informações de Seleção -->
            <div class="selection-info" style="margin: 15px 0; padding: 10px; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; border-radius: 5px;">
                <span style="color: #D8CEFE; font-size: 14px;">
                    <span id="selectedProductsCount">0</span> de <span id="totalProductsCount">0</span> produtos selecionados
                </span>
            </div>

            <!-- Botões de Ação -->
            <div class="modal-buttons" style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(155, 100, 227, 0.3);">
                <button type="button" onclick="closeAtualizarPrecosModal()" class="btn-cancel" style="background-color: rgba(255, 71, 87, 0.1); border: 1px solid #FF4757; color: #FF4757; padding: 12px 20px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 71, 87, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 71, 87, 0.1)'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Cancelar
                </button>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="recalcularPrecos()" class="btn-recalculate" style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid #FFC107; color: #FFC107; padding: 12px 20px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 193, 7, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 193, 7, 0.1)'">
                        <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzODQgMzgzLjI4Ij4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLmNscy0xIHsKICAgICAgICBmaWxsOiAjNTI1MmFkOwogICAgICB9CgogICAgICAuY2xzLTIgewogICAgICAgIGZpbGw6ICM0NDQ0YTY7CiAgICAgIH0KCiAgICAgIC5jbHMtMyB7CiAgICAgICAgZmlsbDogI2UxYzNmZTsKICAgICAgfQoKICAgICAgLmNscy00IHsKICAgICAgICBmaWxsOiAjMWExYTkzOwogICAgICB9CgogICAgICAuY2xzLTUgewogICAgICAgIGZpbGw6ICMwNTA1ODk7CiAgICAgIH0KICAgIDwvc3R5bGU+CiAgPC9kZWZzPgogIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTS4xNCwxODAuNDJjMC0uMTEuNzItLjg1Ljc4LTEuODEuNDktNi45Ljc2LTEzLjgyLDIuMjItMjAuNjVoNzEuOTdjLTEwLjY5LDM5LjA2LTEuODYsODIuMDYsMjQuNzYsMTEyLjYzLDQwLjk4LDQ3LjA3LDExMC41Nyw1Ni42MiwxNjEuOSwyMC4ybC0yNS40OS0yNy4yOSwxMTAuMi0xMS4yNC0xMC41LDExMC4wMy0yLjY2LS43MS0yMC45Ni0yMC4yN2MtMjkuNDMsMjIuNjItNjQuNjksMzcuNjctMTAxLjk1LDQxLjE5LTIuMjIuMjEtNS4zMi42NS03LjEyLjc1aC0yNS40OWMtNi45My0xLjY0LTE0LjEyLTEuOTQtMjEuMTMtMy4yM0M3Ni40OCwzNjUuMzIsMTIuMDYsMjk4LjQzLDEuNzMsMjE3LjM4Yy0uNi00LjctLjM1LTkuOTctMS42LTE0LjUuMzItNy40Mi0uNDMtMTUuMDUsMC0yMi40NloiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTUiIGQ9Ik0zODMuOTYsMTc2LjY4djQuNDljLTEuMjQuODEtLjc1LDMuMDgtLjc1LDQuNDlzLS40OSwzLjY4Ljc1LDQuNDl2Mi45OWMtMS4yNC44LS43NiwzLjA5LS43NSw0LjQ5LDAsMS4yLS40NCwzLjEyLjc1LDMuNzQtLjA5LDEuNzMuMTMsMy41MiwwLDUuMjQtLjAxLjE0LS42NC41OS0uNjksMS4xOS0uNTgsNi4yNi41LDE0LjgxLTYuNTksMTcuMzdsLTU5Ljg1LjE5Yy0xMC4xOS0yLjYtNC44Ny0xMi44NC00LjE5LTE5Ljk2LDkuNzItMTAwLjQ0LTk1Ljc1LTE2OC43LTE4My4wNS0xMTcuNjZsLTcuMjUsNS40NWM1LjM5LDcuNjIsMjcuMTksMTkuMTgsMTIuMTUsMjcuOWwtOTAuNTQsOS4yMWMtMy44LS40LTUuNjEtMy43NS02LjI5LTcuMmw5LjAxLTg2LjcxYzYuMDQtMTguMDQsMTcuMjktLjA1LDI1LjA1LDUuNTgsNjguNjgtNTQuODYsMTY3LjMzLTU2LjE4LDIzNy4xOC0yLjU3LDQyLjM0LDMyLjQ5LDcwLjksODMuODcsNzUuMDQsMTM3LjI4Wk0zNjguMjEsMjEwLjM3YzIuMDgtMjQuNTItLjEzLTQ4Ljc5LTcuNDgtNzIuMjVDMzI3LjM5LDMxLjcyLDIwMi4xNi0xNi45LDEwNC41OSwzOC4wN2MtMTAuODUsNi4xMi0xOS4xNCwxNC41Ny0yOC43NywyMC42OC03LjMxLDQuNjQtMTAuNTQtMS4zNi0xNS43LTUuNThsLTYsNjEuMzgsNjAuNzEtNS45OWMxLjA4LS45Ny04LjQ3LTkuMjctOS4zOC0xMC40Ni02LjY1LTguNjQuODItMTIuNjQsNy4zNS0xNy40LDQzLjQ3LTMxLjcsMTA0LjA1LTMzLjQyLDE0OS45NS01LjY4LDQ1Ljg0LDI3LjcxLDcyLjYxLDgxLjg5LDY0LjI0LDEzNS4zNGg0MS4yM1oiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zODMuOTYsMTg1LjY2aC0uNzVjMC0xLjQxLS40OS0zLjY4Ljc1LTQuNDl2NC40OVoiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTQiIGQ9Ik0zODMuOTYsMTkwLjE2Yy0xLjI0LS44MS0uNzUtMy4wOC0uNzUtNC40OWguNzV2NC40OVoiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTQiIGQ9Ik0zODMuOTYsMTk3LjY0aC0uNzVjLS4wMS0xLjQtLjQ5LTMuNjkuNzUtNC40OXY0LjQ5WiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTM4My45NiwyMDEuMzhjLTEuMTktLjYzLS43NC0yLjU0LS43NS0zLjc0aC43NXYzLjc0WiIvPgo8L3N2Zz4=" width="16" height="16" alt="Refresh" style="filter: brightness(0) saturate(100%) invert(79%) sepia(96%) saturate(1345%) hue-rotate(350deg) brightness(103%) contrast(107%);">
                        Recalcular
                    </button>
                    
                    <button type="button" onclick="confirmarAtualizacaoPrecos()" id="btnConfirmarAtualizacao" class="btn-confirm" style="background-color: rgba(46, 213, 115, 0.1); border: 1px solid #2ED573; color: #2ED573; padding: 12px 20px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; opacity: 0.5;" onmouseover="if(!this.disabled) { this.style.backgroundColor='rgba(46, 213, 115, 0.2)' }" onmouseout="if(!this.disabled) { this.style.backgroundColor='rgba(46, 213, 115, 0.1)' }" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Aplicar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="module-header" style="padding: 90px 20px 20px 20px; font-size: 14px;">
    <h1>Produtos</h1>
    
    <!-- Filtros e busca de produtos -->
    <div class="search-filters" style="margin-bottom: 20px; padding: 15px; background-color: rgba(19, 4, 60, 0.69); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 2px solid #9B64E3; border-radius: 10px;">
        <div class="search-container" style="display: flex; margin-bottom: 15px;">
            <input type="text" id="searchProduto" placeholder="Pesquisar produto..." style="flex: 1; padding: 10px; border: 0.2px solid #9B64E3; border-radius: 5px 0 0 5px; background-color: rgba(255, 255, 255, 0.1); color: white;">
            <button type="button" id="searchButton" style="padding: 10px 15px; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9b63e3; border-left: none; border-radius: 0 5px 5px 0; color: white; cursor: pointer;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                <i class="search-icon">&#128269;</i>
            </button>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="color: white; font-size: 14px;">Categoria:</label>
                <select id="filtroCategoriaBusca" style="padding: 8px; border: 1px solid #9B64E3; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; min-width: 150px;">
                    <option value="all">Todas</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Botões de ação -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px; margin-top: 20px;">
        <button class="btn-novo-produto" onclick="openProdutoModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Novo Produto
        </button>
        
        <button class="btn-novo-kit" onclick="openKitModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
            </svg>
            Novo Kit
        </button>
        
        <!-- Botões para verificação de alterações de preços -->
        <button class="btn-verificar-precos" onclick="verificarAlteracoesCustosReais()" style="background-color: rgba(46, 213, 115, 0.1); border: 1px solid #2ED573; color: #2ED573; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(46, 213, 115, 0.2)'" onmouseout="this.style.backgroundColor='rgba(46, 213, 115, 0.1)'">
            <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzODQgMzgzLjI4Ij4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLmNscy0xIHsKICAgICAgICBmaWxsOiAjMkVENTczOwogICAgICB9CgogICAgICAuY2xzLTIgewogICAgICAgIGZpbGw6ICMyNUM4NjA7CiAgICAgIH0KCiAgICAgIC5jbHMtMyB7CiAgICAgICAgZmlsbDogI0ZGRkZGRjsKICAgICAgfQoKICAgICAgLmNscy00IHsKICAgICAgICBmaWxsOiAjMUY5QjQ4OwogICAgICB9CgogICAgICAuY2xzLTUgewogICAgICAgIGZpbGw6ICMxNzg1M0M7CiAgICAgIH0KICAgIDwvc3R5bGU+CiAgPC9kZWZzPgogIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTS4xNCwxODAuNDJjMC0uMTEuNzItLjg1Ljc4LTEuODEuNDktNi45Ljc2LTEzLjgyLDIuMjItMjAuNjVoNzEuOTdjLTEwLjY5LDM5LjA2LTEuODYsODIuMDYsMjQuNzYsMTEyLjYzLDQwLjk4LDQ3LjA3LDExMC41Nyw1Ni42MiwxNjEuOSwyMC4ybC0yNS40OS0yNy4yOSwxMTAuMi0xMS4yNC0xMC41LDExMC4wMy0yLjY2LS43MS0yMC45Ni0yMC4yN2MtMjkuNDMsMjIuNjItNjQuNjksMzcuNjctMTAxLjk1LDQxLjE5LTIuMjIuMjEtNS4zMi42NS03LjEyLjc1aC0yNS40OWMtNi45My0xLjY0LTE0LjEyLTEuOTQtMjEuMTMtMy4yM0M3Ni40OCwzNjUuMzIsMTIuMDYsMjk4LjQzLDEuNzMsMjE3LjM4Yy0uNi00LjctLjM1LTkuOTctMS42LTE0LjUuMzItNy40Mi0uNDMtMTUuMDUsMC0yMi40NloiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTUiIGQ9Ik0zODMuOTYsMTc2LjY4djQuNDljLTEuMjQuODEtLjc1LDMuMDgtLjc1LDQuNDlzLS40OSwzLjY4Ljc1LDQuNDl2Mi45OWMtMS4yNC44LS43NiwzLjA5LS43NSw0LjQ5YzAsMS4yLS40NCwzLjEyLjc1LDMuNzQtLjA5LDEuNzMuMTMsMy41MiwwLDUuMjQtLjAxLjE0LS42NC41OS0uNjksMS4xOS0uNTgsNi4yNi41LDE0LjgxLTYuNTksMTcuMzdsLTU5Ljg1LjE5Yy0xMC4xOS0yLjYtNC44Ny0xMi44NC00LjE5LTE5Ljk2LDkuNzItMTAwLjQ0LTk1Ljc1LTE2OC43LTE4My4wNS0xMTcuNjZsLTcuMjUsNS40NWM1LjM5LDcuNjIsMjcuMTksMTkuMTgsMTIuMTUsMjcuOWwtOTAuNTQsOS4yMWMtMy44LS40LTUuNjEtMy43NS02LjI5LTcuMmw5LjAxLTg2LjcxYzYuMDQtMTguMDQsMTcuMjktLjA1LDI1LjA1LDUuNTgsNjguNjgtNTQuODYsMTY3LjMzLTU2LjE4LDIzNy4xOC0yLjU3LDQyLjM0LDMyLjQ5LDcwLjksODMuODcsNzUuMDQsMTM3LjI4Wk0zNjguMjEsMjEwLjM3YzIuMDgtMjQuNTItLjEzLTQ4Ljc5LTcuNDgtNzIuMjVDMzI3LjM5LDMxLjcyLDIwMi4xNi0xNi45LDEwNC41OSwzOC4wN2MtMTAuODUsNi4xMi0xOS4xNCwxNC41Ny0yOC43NywyMC42OC03LjMxLDQuNjQtMTAuNTQtMS4zNi0xNS43LTUuNThsLTYsNjEuMzgsNjAuNzEtNS45OWMxLjA4LS45Ny04LjQ3LTkuMjctOS4zOC0xMC40Ni02LjY1LTguNjQuODItMTIuNjQsNy4zNS0xNy40LDQzLjQ3LTMxLjcsMTA0LjA1LTMzLjQyLDE0OS45NS01LjY4LDQ1Ljg0LDI3LjcxLDcyLjYxLDgxLjg5LDY0LjI0LDEzNS4zNGg0MS4yM1oiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0zODMuOTYsMTg1LjY2aC0uNzVjMC0xLjQxLS40OS0zLjY4Ljc1LTQuNDl2NC40OVoiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTQiIGQ9Ik0zODMuOTYsMTkwLjE2Yy0xLjI0LS44MS0uNzUtMy4wOC0uNzUtNC40OWguNzV2NC40OVoiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTQiIGQ9Ik0zODMuOTYsMTk3LjY0aC0uNzVjLS4wMS0xLjQtLjQ5LTMuNjkuNzUtNC40OXY0LjQ5WiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTM4My45NiwyMDEuMzhjLTEuMTktLjYzLS43NC0yLjU0LS43NS0zLjc0aC43NXYzLjc0WiIvPgo8L3N2Zz4=" width="16" height="16" alt="Refresh" style="filter: brightness(0) saturate(100%) invert(70%) sepia(71%) saturate(473%) hue-rotate(87deg) brightness(96%) contrast(88%);">
            Verificar alterações de preços
        </button>
        
        <!-- Botão de demonstração com dados simulados -->
        <button class="btn-teste-precos" onclick="simularDeteccaoMudancasCustos()" style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid #FFC107; color: #FFC107; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: none; align-items: center; gap: 10px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 193, 7, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 193, 7, 0.1)'">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Demo: Simular Alterações
        </button>
        
        <!-- Botão de debug para testar cálculos -->
        <button class="btn-debug-calculos" onclick="debugCalculosPrecos()" style="background-color: rgba(128, 128, 128, 0.1); border: 1px solid #808080; color: #808080; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: none; align-items: center; gap: 10px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(128, 128, 128, 0.2)'" onmouseout="this.style.backgroundColor='rgba(128, 128, 128, 0.1)'">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
            Debug: Testar Cálculos
        </button>
    </div>

    <!-- Lista de produtos -->
    <div class="produtos-list-container" style="background-color: var(--order-card-bg); border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div class="produtos-list-header" style="display: grid; grid-template-columns: 0.8fr 1.5fr 1fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: 15px; font-weight: bold; padding: 15px 20px; border-bottom: 2px solid var(--cor-destaque, #9B64E3); color: var(--column-title-text);">
            <div>Código</div>
            <div>Nome</div>
            <div>Categoria</div>
            <div>Preço</div>
            <div>Margem</div>
            <div>Etapas</div>
            <div>Status</div>
            <div>Estoque</div>
            <div>Ações</div>
        </div>
        <div class="produtos-list" style="margin-top: 10px;">
            <!-- Produtos serão carregados dinamicamente aqui -->
        </div>
    </div>
</div>

<!-- Modal para Novo Produto -->
<div id="produtoModal" class="modal">
    <div class="modal-content custom-scrollbar">
        <span class="close-button" onclick="closeProdutoModal()">&times;</span>
        <h2>Novo Produto</h2>
        <div class="modal-body">
            <form id="produtoForm">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="produtoNome">Nome:</label>
                            <input type="text" id="produtoNome" name="produtoNome" required style="width: 90%;">
                        </div>
                        <div class="form-group">
                            <label for="produtoCodigo">Código:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="text" id="produtoCodigo" name="produtoCodigo" required style="width: calc(50% - 40px);">
                                <button type="button" onclick="gerarCodigoProduto()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'" title="Gerar código aleatório">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="produtoCategoria">Categoria:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="produtoCategoria" style="width: calc(50% - 35px);">
                                    <button type="button" tabindex="0">Selecione uma categoria</button>
                                    <div class="dropdown-content">
                                        <!-- Opções serão carregadas dinamicamente -->
                                    </div>
                                </div>
                                <button type="button" onclick="openBuscarCategoriaModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; gap: 15px; align-items: end;">
                                <div style="flex: 1;">
                                    <label for="produtoMargem" style="display: flex; align-items: center; gap: 5px;">
                                        Configurar Margem (%)
                                        <div class="tooltip-container" style="position: relative; cursor: help;">
                                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyUzYuNDggMjIgMTIgMjJTMjIgMTcuNTIgMjIgMTJTMTcuNTIgMiAxMiAyWk0xMyAxN0gxMVYxMUgxM1YxN1pNMTMgOUgxMVY3SDEzVjlaIiBmaWxsPSIjOUI2NEUzIi8+Cjwvc3ZnPgo=" alt="Dica" style="height: 14px; width: 14px; opacity: 0.7; transition: all 0.3s ease;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                                            <div class="tooltip-text" style="visibility: hidden; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.9); color: white; text-align: center; border-radius: 6px; padding: 8px 12px; font-size: 12px; white-space: nowrap; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                                Margem de lucro em porcentagem sobre o custo total
                                            </div>
                                        </div>
                                    </label>
                                    <input type="text" id="produtoMargem" name="produtoMargem" style="width: 80%;" oninput="formatarPorcentagem(this); calcularPrecoComMargem();" onwheel="handleMargemWheel(event)" placeholder="0,00%" value="0,00%">
                                </div>
                                <div style="flex: 1;">
                                    <label for="produtoPreco">Preço:</label>
                                    <input type="text" id="produtoPreco" name="produtoPreco" required style="width: 80%;" placeholder="R$ 0,00" readonly title="Preço calculado automaticamente: Custo Total + Margem">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="produtoDescricao">Descrição:</label>
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <textarea id="produtoDescricao" name="produtoDescricao" rows="3" style="flex: 1;"></textarea>
                                <button type="button" id="btnGerarDescricao" onclick="gerarDescricaoProduto()" 
                                        style="padding: 8px 12px; background: linear-gradient(135deg, #9B64E3, #7A4BB8); border: none; border-radius: 5px; color: white; font-weight: 500; cursor: pointer; white-space: nowrap; height: fit-content; margin-top: 2px;"
                                        title="Gerar descrição atraente baseada nos materiais e etapas do produto">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 1 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                                        <polyline points="14,2 14,8 20,8"></polyline>
                                        <path d="M10,13 L14,13"></path>
                                        <path d="M10,17 L14,17"></path>
                                        <path d="M10,9 L12,9"></path>
                                    </svg>
                                    Gerar Descrição
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="produtoEspecificacoes">Especificações Técnicas:</label>
                            <textarea id="produtoEspecificacoes" name="produtoEspecificacoes" rows="3" style="width: 90%;"></textarea>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <!-- Sistema de Abas para Materiais e Etapas -->
                        <div class="tabs-container">
                            <div class="tabs-header">
                                <button type="button" class="tab-button active" data-tab="materiais">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    Materiais para Confecção
                                </button>
                                <button type="button" class="tab-button" data-tab="etapas">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V6a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                    Etapas de Confecção
                                </button>
                                <button type="button" class="tab-button" data-tab="anexos">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l7.07-7.07"></path>
                                    </svg>
                                    Anexos
                                </button>
                            </div>
                            
                            <!-- Conteúdo da Aba Materiais -->
                            <div class="tab-content active" id="materiais-tab">
                                <div class="form-group">
                                    <small style="color: #D8CEFE; font-style: italic; margin-bottom: 8px; display: block;">
                                        * Para materiais "Rolo/Bobina" ou "Chapa/Placa": use apenas as dimensões (L × A) - a quantidade será sempre 1. Para outros materiais: use apenas "Qtd. Nec."
                                    </small>
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        <div class="materials-table-container custom-scrollbar">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th style="padding: 8px; text-align: left;">Material</th>
                                                        <th style="padding: 8px; text-align: center;">Tipo</th>
                                                        <th style="padding: 8px; text-align: right;">Qtd. Disp.</th>
                                                        <th style="padding: 8px; text-align: center;">Qtd. Nec.</th>
                                                        <th style="padding: 8px; text-align: center;">Dimensões (cm)</th>
                                                        <th style="padding: 8px; text-align: right;">Área (m²)</th>
                                                        <th style="padding: 8px; text-align: right;">Custo/m² ou Unit.</th>
                                                        <th style="padding: 8px; text-align: right;">Total</th>
                                                        <th style="padding: 8px; text-align: center;">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="materiaisList">
                                                    <!-- Materiais serão adicionados aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                                            <button type="button" onclick="openSelecionarMaterialModal()" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                Adicionar Material
                                            </button>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <strong style="color: white;">Custo Total:</strong>
                                                <span id="custoTotal" style="display: inline-block; padding: 4px 8px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; color: white; font-weight: bold;">R$ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Conteúdo da Aba Etapas -->
                            <div class="tab-content" id="etapas-tab">
                                <div class="form-group">
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        <div class="etapas-table-container custom-scrollbar">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th style="padding: 8px; text-align: left; width: 18%;">Etapa</th>
                                                        <th style="padding: 8px; text-align: center; width: 12%;">Tipo de etapa</th>
                                                        <th style="padding: 8px; text-align: center; width: 17%;">Equipamento</th>
                                                        <th style="padding: 8px; text-align: center; width: 18%;">Usar Material</th>
                                                        <th style="padding: 8px; text-align: center; width: 12%;">Tempo estimado</th>
                                                        <th style="padding: 8px; text-align: right; width: 13%;">Custo estimado</th>
                                                        <th style="padding: 8px; text-align: center; width: 10%;">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="etapasList">
                                                    <!-- Etapas serão adicionadas aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                                            <button type="button" onclick="openAdicionarEtapaModal()" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                Adicionar Etapa
                                            </button>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <strong style="color: white;">Custo Total Etapas:</strong>
                                                <span id="custoTotalEtapas" style="display: inline-block; padding: 4px 8px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; color: white; font-weight: bold;">R$ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Conteúdo da Aba Anexos -->
                            <div class="tab-content" id="anexos-tab">
                                <div class="form-group">
                                    <small style="color: #D8CEFE; font-style: italic; margin-bottom: 8px; display: block;">
                                        * Anexe arquivos relacionados à confecção do produto (desenhos técnicos, moldes, instruções, etc.)
                                    </small>
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        
                                        <!-- Área de upload -->
                                        <div style="border: 2px dashed rgba(155, 100, 227, 0.5); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; transition: all 0.3s ease; cursor: pointer;" 
                                             id="anexoDropArea" 
                                             ondrop="handleFileDrop(event)" 
                                             ondragover="handleDragOver(event)" 
                                             ondragleave="handleDragLeave(event)"
                                             onclick="document.getElementById('anexoFileInput').click()">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 10px; opacity: 0.7;">
                                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l7.07-7.07"></path>
                                            </svg>
                                            <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.8);">
                                                <strong>Clique aqui ou arraste arquivos</strong><br>
                                                <small>Formatos aceitos: PDF, DWG, PNG, JPG, DOC, XLS</small><br>
                                                <small>Tamanho máximo: 10MB por arquivo</small>
                                            </p>
                                            <input type="file" id="anexoFileInput" multiple accept=".pdf,.dwg,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx" style="display: none;" onchange="handleFileSelect(event)">
                                        </div>
                                        
                                        <!-- Lista de arquivos anexados -->
                                        <div style="flex: 1; overflow-y: auto;" class="custom-scrollbar">
                                            <div id="anexosList" style="display: flex; flex-direction: column; gap: 8px;">
                                                <!-- Arquivos anexados aparecerão aqui -->
                                            </div>
                                        </div>
                                        
                                        <!-- Resumo -->
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="color: rgba(255, 255, 255, 0.8);">Arquivos anexados:</span>
                                                <span id="anexosCount" style="display: inline-block; padding: 2px 8px; background-color: rgba(155, 100, 227, 0.3); border-radius: 12px; color: white; font-weight: bold; font-size: 12px;">0</span>
                                            </div>
                                            <button type="button" onclick="limparTodosAnexos()" class="btn-secondary" style="background-color: rgba(255, 100, 100, 0.1); border: 1px solid rgba(255, 100, 100, 0.4); color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 100, 100, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 100, 100, 0.1)'">
                                                Limpar Todos
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-primary" onclick="salvarProduto()" style="margin-top: 5px;">Salvar Produto</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Adicionar/Editar Etapa -->
<div id="etapaModal" class="modal modal-top-level" style="display: none;">
    <div class="modal-content" style="width: 65%; max-width: 750px; max-height: 85vh; overflow: hidden;">
        <span class="close-button" onclick="closeEtapaModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2 id="etapaModalTitle" style="margin-bottom: 25px; color: white;">Adicionar Etapa</h2>
        <div class="modal-body" style="padding: 25px; overflow: visible;">
            <form id="etapaForm" onsubmit="event.preventDefault(); adicionarOuEditarEtapa();">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="etapaNome">Nome da Etapa *</label>
                    <input type="text" id="etapaNome" name="etapaNome" required placeholder="Ex: Corte, Dobra, Solda, Pintura...">
                </div>

                <!-- Linha com Tipo, Equipamento e Material -->
                <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="etapaTipo">Tipo de Etapa *</label>
                        <div class="dropdown custom-select" tabindex="0" role="button" id="etapaTipo" style="width: 100%;">
                            <button type="button" tabindex="0">Selecionar tipo...</button>
                            <div class="dropdown-content">
                                <div data-value="Preparação">Preparação</div>
                                <div data-value="Processamento">Processamento</div>
                                <div data-value="Montagem">Montagem</div>
                                <div data-value="Acabamento">Acabamento</div>
                                <div data-value="Controle de Qualidade">Controle de Qualidade</div>
                                <div data-value="Embalagem">Embalagem</div>
                                <div data-value="Outro">Outro</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="etapaEquipamento">Equipamento</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <div class="dropdown custom-select" tabindex="0" role="button" id="etapaEquipamento" style="flex: 1;">
                                <button type="button" tabindex="0">Selecionar equipamento...</button>
                                <div class="dropdown-content">
                                    <!-- Opções serão carregadas dinamicamente -->
                                </div>
                            </div>
                            <button type="button" id="btnLimparEquipamento" onclick="limparEquipamento()" title="Remover equipamento (apenas mão de obra)" style="
                                background-color: rgba(255, 255, 255, 0.1); 
                                border: 1px solid rgba(155, 100, 227, 0.4); 
                                color: white; 
                                padding: 6px 8px; 
                                border-radius: 5px; 
                                cursor: pointer; 
                                transition: all 0.3s ease;
                                font-size: 12px;
                                height: 32px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                opacity: 0.7;
                                position: relative;
                            " 
                            onmouseover="
                                this.style.backgroundColor='rgba(255, 100, 100, 0.2)'; 
                                this.style.borderColor='rgba(255, 100, 100, 0.6)'; 
                                this.style.opacity='1';
                                this.style.transform='scale(1.05)';
                            " 
                            onmouseout="
                                this.style.backgroundColor='rgba(255, 255, 255, 0.1)'; 
                                this.style.borderColor='rgba(155, 100, 227, 0.4)'; 
                                this.style.opacity='0.7';
                                this.style.transform='scale(1)';
                            ">
                                ✕
                            </button>
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 10px; margin-top: 2px; display: block;">
                            Opcional
                        </small>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="etapaMaterial">Material da Etapa</label>
                        <div class="dropdown custom-select" tabindex="0" role="button" id="etapaMaterial" style="width: 100%;">
                            <button type="button" tabindex="0">Selecionar material...</button>
                            <div class="dropdown-content">
                                <!-- Materiais serão carregados dinamicamente dos materiais já adicionados -->
                            </div>
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 10px; margin-top: 2px; display: block;">
                            Opcional
                        </small>
                    </div>
                </div>

                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 25px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="etapaTempo" style="display: flex; align-items: center; gap: 5px;">
                            Tempo Estimado (HH:MM:SS) *
                            <div class="tooltip-container" style="position: relative; cursor: help;">
                                <img src="data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMzIuOTUgMjE2LjYyIj4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLmNscy0xIHsKICAgICAgICBmaWxsOiAjOUI2NEUzOwogICAgICB9CgogICAgICAuY2xzLTIgewogICAgICAgIGZpbGw6ICM3QjY0RTM7CiAgICAgIH0KCiAgICAgIC5jbHMtMyB7CiAgICAgICAgZmlsbDogIzZCNTREMzsKICAgICAgfQoKICAgICAgLmNscy00IHsKICAgICAgICBmaWxsOiAjQUI3NEYzOwogICAgICB9CgogICAgICAuY2xzLTUgewogICAgICAgIGZpbGw6ICM4QjY0RTM7CiAgICAgIH0KCiAgICAgIC5jbHMtNiB7CiAgICAgICAgZmlsbDogIzVCNDRDMzsKICAgICAgfQogICAgPC9zdHlsZT4KICA8L2RlZnM+CiAgPGcgaWQ9Im9iamVjdHMiPgogICAgPGc+CiAgICAgIDxnPgogICAgICAgIDxnPgogICAgICAgICAgPHBhdGggY2xhc3M9ImNscy0yIiBkPSJNMzkuNzQsMTg1LjV2MTkuMzdjMCw2LjQ5LDYuMiwxMS43NSwxMy44NSwxMy43NWgxMS43N2M3LjY1LDAsMTMuODUtNS4yNiwxMy44NS0xMS43NXYtMTkuMzdoLTM5LjQ2WiIvPgogICAgICAgICAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNNTkuNDMsMTg1LjVoLTE5LjY5djE5LjM3YzAsNi40OSw2LjIsMTEuNzUsMTMuODUsMTEuNzVoNS44NHYtMzEuMTJaIi8+CiAgICAgICAgPC9nPgogICAgICAgIDxnPgogICAgICAgICAgPHJlY3QgY2xhc3M9ImNscy01IiB4PSIzOS43NCIgeT0iMTg1LjUiIHdpZHRoPSIzOS40NiIgaGVpZ2h0PSIxNS42NyIvPgogICAgICAgICAgPHJlY3QgY2xhc3M9ImNscy02IiB4PSIzOS43NCIgeT0iMTg1LjUiIHdpZHRoPSIxOS42OSIgaGVpZ2h0PSIxNS42NyIvPgogICAgICAgIDwvZz4KICAgICAgICA8Zz4KICAgICAgICAgIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTMyLjE4LDE2Mi4yOHYxOS4zN2MwLDYuNDgsOC42NCwxMS43NCwxOS4yOSwxMS43NGgxNi4zOWMxMC42NSwwLDE5LjI5LTUuMjYsMTkuMjktMTEuNzR2LTE5LjM3aC01NC45N1oiLz4KICAgICAgICAgIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTU5LjQzLDE2Mi4yOGgtMjcuMjV2MTkuMzdjMCw2LjQ4LDguNjQsMTEuNzQsMTkuMjksMTEuNzRoNy45NXYtMzEuMTJaIi8+CiAgICAgICAgPC9nPgogICAgICA8L2c+CiAgICAgIDxnPgogICAgICAgIDxwYXRoIGNsYXNzPSJjbHMtNCIgZD0iTTU5LjA0LDE1Ni40OWMtOC42NiwwLTE2LjMzLTUuNC0xNy44NS0xMy4wNS03LjMyLTM2LjgzLDE2LjMyLTUwLjY4LDMxLjk2LTU5Ljg0LDguMjUtNC44MywxNS4zOC05LjAxLDE5LjE3LTE1LjgxLDYuMS0xMC45Myw1Ljg0LTE5LjkyLS43OS0yNi43NC03Ljc0LTcuOTYtMjIuOTUtMTEuNjItMzUuMzgtOC41MS0xMS4yLDIuOC0xOC4xNCwxMC41Ny0yMC4wNSwyMi40Ny0xLjM4LDguNi0xMC41NCwxNC42LTIwLjQ3LDEzLjRDNS43MSw2Ny4yLTEuMjEsNTkuMjYuMTgsNTAuNjZDNC4xLDI2LjI2LDIwLjg0LDguNjQsNDYuMSwyLjMzYzI2LjE1LTYuNTQsNTYuMjQsMS4wNSw3My4xNywxOC40NiwxNS45OSwxNi40NCwxOC4wNywzOC41Nyw1LjcsNjAuNy04LjA1LDE0LjQxLTIxLjA1LTIyLjAzLTMxLjUsMjguMTUtMTQuNDYsOC40Ny0xOS44NywxMS42NS0xNi41MywyOC40NiwxLjcsOC41Ni00LjkyLDE2LjY5LTE0Ljc5LDE4LjE2LTEuMDQuMTYtMi4wOC4yMy0zLjEuMjNaIi8+CiAgICAgICAgPGc+CiAgICAgICAgICA8cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik02MC44NCw5MS40MWMtMTMuMDIsOS40OC0yNS4xOSwyNC4xOS0xOS42NSw1Mi4wMywxLjUyLDcuNjUsOS4xOCwxMy4wNSwxNy44NSwxMy4wNS42LDAsMS4yLS4wMywxLjgtLjA4di02NVoiLz4KICAgICAgICAgIDxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTU2LjE1LDMyLjUzYzEuNTMtLjM4LDMuMS0uNjYsNC42OS0uODRWLjEzYy00Ljk4LjI3LTkuOTMuOTktMTQuNzQsMi4yQzIwLjg0LDguNjQsNC4xLDI2LjI2LjE4LDUwLjY2Yy0xLjM4LDguNiw1LjU0LDE2LjU0LDE1LjQ2LDE3Ljc0LDkuOTIsMS4yLDE5LjA4LTQuOCwyMC40Ny0xMy40LDEuOTItMTEuOSw4Ljg1LTE5LjY3LDIwLjA1LTIyLjQ3WiIvPgogICAgICAgIDwvZz4KICAgICAgPC9nPgogICAgPC9nPgogIDwvZz4KPC9zdmc+" alt="Dica" style="height: 1em; width: auto; opacity: 0.7; transition: all 0.3s ease; vertical-align: baseline;" onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.7'; this.style.transform='scale(1)'">
                                <div class="tooltip-text" style="visibility: hidden; width: 250px; background-color: rgba(19, 4, 60, 0.69); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 2px solid #9B64E3; color: white; text-align: center; border-radius: 10px; padding: 12px; position: absolute; z-index: 1000; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: normal; box-shadow: 0 4px 15px rgba(155, 100, 227, 0.3);">
                                    Use o scroll do mouse sobre horas, minutos ou segundos para ajustar
                                    <div style="position: absolute; top: 100%; left: 50%; margin-left: -5px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #9B64E3;"></div>
                                </div>
                            </div>
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="etapaTempo" name="etapaTempo" placeholder="00:30:00" pattern="^([0-9]{1,2}):([0-5][0-9]):([0-5][0-9])$" required class="time-input" style="font-family: monospace;" oninput="calcularCustoEstimado()" onmousemove="updateTimeHover(event)" onwheel="handleTimeWheel(event)">
                            <div id="timeHoverIndicator" style="position: absolute; bottom: -2px; height: 2px; background-color: #9B64E3; width: 0; transition: all 0.2s ease; border-radius: 1px;"></div>
                        </div>
                    </div>
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="etapaCusto">Custo Estimado</label>
                        <input type="text" id="etapaCusto" name="etapaCusto" oninput="formatarCustoEtapa(this)" placeholder="R$ 0,00">
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; border-top: 1px solid rgba(155, 100, 227, 0.3); padding-top: 20px;">
                    <button type="button" onclick="closeEtapaModal()" class="btn-secondary" style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(155, 100, 227, 0.4); color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'; this.style.borderColor='rgba(155, 100, 227, 0.6)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'; this.style.borderColor='rgba(155, 100, 227, 0.4)'">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">
                        Salvar Etapa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Nova Categoria de Produtos -->
<div id="novaCategoriaModal" class="modal modal-top-level" style="display: none;">
    <div class="modal-content" style="width: 50%; max-width: 600px; max-height: 80vh;">
        <span class="close-button" onclick="closeNovaCategoriaModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <h2>Nova Categoria de Produto</h2>
        <div class="modal-body" style="padding: 20px; overflow-x: hidden;">
            <form id="novaCategoriaForm">
                <div class="form-group">
                    <label for="novaCategoriaNome">Nome da Categoria:</label>
                    <input type="text" id="novaCategoriaNome" name="novaCategoriaNome" required style="width: calc(100% - 22px); padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;">
                </div>
                <div class="form-group">
                    <label for="novaCategoriaDescricao">Descrição (opcional):</label>
                    <textarea id="novaCategoriaDescricao" name="novaCategoriaDescricao" rows="3" style="width: calc(100% - 22px); padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box; resize: vertical;"></textarea>
                </div>
                <button type="button" onclick="salvarNovaCategoriaProduto()" class="btn-primary" style="margin-top: 20px; background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Salvar Categoria</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Notificação -->
<div id="notificationModal" class="modal modal-notification">
    <div class="modal-content notification-modal-content">
        <span class="close-button" onclick="closeNotificationModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <div id="notificationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;"></div>
        <h2 id="notificationModalTitle"></h2>
        <p id="notificationModalMessage"></p>
        <button class="btn-primary" onclick="closeNotificationModal()" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; margin-top: 15px;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">OK</button>
    </div>
</div>

<!-- Modal de Confirmação de Edição -->
<div id="confirmationEditModal" class="modal modal-notification">
    <div class="modal-content notification-modal-content">
        <span class="close-button" onclick="closeConfirmationEditModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <div id="confirmationEditIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#FFC107">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M12 8V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="6" stroke-dashoffset="6">
                    <animate attributeName="stroke-dashoffset" values="6;0" dur="0.3s" begin="0.3s" fill="freeze"/>
                </path>
                <circle cx="12" cy="16" r="1" fill="white">
                    <animate attributeName="opacity" values="0;1" dur="0.2s" begin="0.6s" fill="freeze"/>
                </circle>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        </div>
        <h2>Confirmar Edição do Produto</h2>
        <p id="confirmationEditMessage"></p>
        <div id="confirmationEditChanges"></div>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="closeConfirmationEditModal()" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Cancelar</button>
            <button id="confirmEditBtn" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Confirmar Edição</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão de Produto -->
<div id="productDeleteConfirmationModal" class="modal">
    <div class="modal-content notification-modal-content">
        <span class="close-button" onclick="closeProductDeleteConfirmationModal()" style="cursor: pointer; position: absolute; right: 15px; top: 15px; font-size: 24px; transition: all 0.3s ease;" onmouseover="this.style.color='#9B64E3'; this.style.textShadow='0 0 8px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.color=''; this.style.textShadow='none'">&times;</span>
        <div id="productDeleteConfirmationIcon" style="margin: 0 auto 20px; width: 64px; height: 64px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="#FFC107">
                    <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                </circle>
                <path d="M12 8V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="6" stroke-dashoffset="6">
                    <animate attributeName="stroke-dashoffset" values="6;0" dur="0.3s" begin="0.3s" fill="freeze"/>
                </path>
                <circle cx="12" cy="16" r="1" fill="white">
                    <animate attributeName="opacity" values="0;1" dur="0.2s" begin="0.6s" fill="freeze"/>
                </circle>
                <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>
            </svg>
        </div>
        <h2>Confirmação</h2>
        <p id="productDeleteConfirmationMessage"></p>
        <div class="modal-buttons">
            <button class="btn-secondary" onclick="closeProductDeleteConfirmationModal()" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Cancelar</button>
            <button id="productDeleteConfirmBtn" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.05); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.05)'; this.style.boxShadow='none'">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal para Buscar/Incluir Categoria -->
<div id="buscarCategoriaModal" class="modal modal-top-level" style="display: none;">
    <div class="modal-content" style="max-width: 800px; width: 60%; max-height: 80vh;">
        <span class="close-button" onclick="closeBuscarCategoriaModal()">&times;</span>
        <h2>Buscar ou Incluir Categoria</h2>
        <div class="modal-body" style="padding: 20px; overflow-x: hidden;">
            <!-- Barra de busca e botão nova categoria na mesma linha -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <input type="text" id="searchCategoriaModal" placeholder="Pesquisar categoria..." style="flex: 1; padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;" oninput="filtrarCategorias(this.value)">
                <button type="button" onclick="openNovaCategoriaModal(); closeBuscarCategoriaModal();" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 10px 16px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; white-space: nowrap;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Nova Categoria
                </button>
            </div>
            
            <!-- Lista de categorias -->
            <div style="max-height: 400px; overflow-y: auto; overflow-x: hidden; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--cor-destaque, #9B64E3);">
                            <th style="padding: 10px; text-align: left; color: white; width: 40%;">Nome</th>
                            <th style="padding: 10px; text-align: left; color: white; width: 60%;">Descrição</th>
                        </tr>
                    </thead>
                    <tbody id="listaCategorias">
                        <!-- Categorias serão carregadas aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Seleção de Materiais -->
<div id="selecionarMaterialModal" class="modal modal-top-level">
    <div class="modal-content" style="max-width: 1000px; max-height: 80vh;">
        <span class="close-button" onclick="closeSelecionarMaterialModal()">&times;</span>
        <h2>Selecionar Material</h2>
        <div class="modal-body" style="padding: 20px; overflow-x: hidden; max-height: 60vh; overflow-y: auto;">
            <!-- Barra de busca dentro do modal -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="searchMaterialModal" placeholder="Pesquisar material..." style="width: calc(100% - 22px); padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;">
            </div>
            
            <!-- Lista de materiais -->
            <div style="max-height: 300px; overflow-y: auto; overflow-x: hidden; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--cor-destaque, #9B64E3);">
                            <th style="padding: 10px; text-align: left; color: white; width: 30%;">Material</th>
                            <th style="padding: 10px; text-align: center; color: white; width: 20%;">Tipo</th>
                            <th style="padding: 10px; text-align: center; color: white; width: 15%;">Código</th>
                            <th style="padding: 10px; text-align: right; color: white; width: 17.5%;">Qtd. Disponível</th>
                            <th style="padding: 10px; text-align: right; color: white; width: 17.5%;">Preço/m² ou Unit.</th>
                        </tr>
                    </thead>
                    <tbody id="listaMateriais">
                        <!-- Materiais serão carregados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Produto -->
<div id="editProdutoModal" class="modal">
    <div class="modal-content custom-scrollbar">
        <span class="close-button" onclick="closeEditProdutoModal()">&times;</span>
        <h2>Editar Produto</h2>
        <div class="modal-body">
            <form id="editProdutoForm">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="editProdutoNome">Nome:</label>
                            <input type="text" id="editProdutoNome" name="editProdutoNome" required style="width: 90%;">
                        </div>
                        <div class="form-group">
                            <label for="editProdutoCodigo">Código:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="text" id="editProdutoCodigo" name="editProdutoCodigo" required style="width: calc(50% - 40px);">
                                <button type="button" onclick="gerarCodigoProdutoEdit()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'" title="Gerar código aleatório">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editProdutoCategoria">Categoria:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div class="dropdown custom-select" tabindex="0" role="button" id="editProdutoCategoria" style="width: calc(50% - 35px);">
                                    <button type="button" tabindex="0">Selecione uma categoria</button>
                                    <div class="dropdown-content">
                                        <!-- Opções serão carregadas dinamicamente -->
                                    </div>
                                </div>
                                <button type="button" onclick="openBuscarCategoriaModal()" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;" onmouseover="this.style.backgroundColor='#D8CEFE'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; gap: 15px; align-items: end;">
                                <div style="flex: 1;">
                                    <label for="editProdutoMargem" style="display: flex; align-items: center; gap: 5px;">
                                        Configurar Margem (%)
                                        <div class="tooltip-container" style="position: relative; cursor: help;">
                                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyUzYuNDggMjIgMTIgMjJTMjIgMTcuNTIgMjIgMTJTMTcuNTIgMiAxMiAyWk0xMyAxN0gxMVYxMUgxM1YxN1pNMTMgOUgxMVY3SDEzVjlaIiBmaWxsPSIjOUI2NEUzIi8+Cjwvc3ZnPgo=" alt="Dica" style="height: 14px; width: 14px; opacity: 0.7; transition: all 0.3s ease;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                                            <div class="tooltip-text" style="visibility: hidden; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.9); color: white; text-align: center; border-radius: 6px; padding: 8px 12px; font-size: 12px; white-space: nowrap; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                                Margem de lucro em porcentagem sobre o custo total
                                            </div>
                                        </div>
                                    </label>
                                    <input type="text" id="editProdutoMargem" name="editProdutoMargem" style="width: 80%;" oninput="formatarPorcentagem(this); calcularPrecoComMargemEdit();" onwheel="handleMargemWheel(event)" placeholder="0,00%">
                                </div>
                                <div style="flex: 1;">
                                    <label for="editProdutoPreco">Preço:</label>
                                    <input type="text" id="editProdutoPreco" name="editProdutoPreco" required style="width: 80%;" placeholder="R$ 0,00" readonly title="Preço calculado automaticamente: Custo Total + Margem">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editProdutoDescricao">Descrição:</label>
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <textarea id="editProdutoDescricao" name="editProdutoDescricao" rows="3" style="flex: 1;"></textarea>
                                <button type="button" id="btnGerarDescricaoEdit" onclick="gerarDescricaoProduto('edit')" 
                                        style="padding: 8px 12px; background: linear-gradient(135deg, #9B64E3, #7A4BB8); border: none; border-radius: 5px; color: white; font-weight: 500; cursor: pointer; white-space: nowrap; height: fit-content; margin-top: 2px;"
                                        title="Gerar descrição atraente baseada nos materiais e etapas do produto">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 1 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                                        <polyline points="14,2 14,8 20,8"></polyline>
                                        <path d="M10,13 L14,13"></path>
                                        <path d="M10,17 L14,17"></path>
                                        <path d="M10,9 L12,9"></path>
                                    </svg>
                                    Gerar Descrição
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editProdutoEspecificacoes">Especificações Técnicas:</label>
                            <textarea id="editProdutoEspecificacoes" name="editProdutoEspecificacoes" rows="3" style="width: 90%;"></textarea>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <!-- Sistema de Abas para Materiais e Etapas - Modal Edição -->
                        <div class="tabs-container">
                            <div class="tabs-header">
                                <button type="button" class="tab-button active" data-tab="edit-materiais">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    Materiais para Confecção
                                </button>
                                <button type="button" class="tab-button" data-tab="edit-etapas">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V6a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                    Etapas de Confecção
                                </button>
                                <button type="button" class="tab-button" data-tab="edit-anexos">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l7.07-7.07"></path>
                                    </svg>
                                    Anexos
                                </button>
                            </div>
                            
                            <!-- Conteúdo da Aba Materiais - Modal Edição -->
                            <div class="tab-content active" id="edit-materiais-tab">
                                <div class="form-group">
                                    <small style="color: #D8CEFE; font-style: italic; margin-bottom: 8px; display: block;">
                                        * Para materiais "Rolo/Bobina" ou "Chapa/Placa": use apenas as dimensões (L × A) - a quantidade será sempre 1. Para outros materiais: use apenas "Qtd. Nec."
                                    </small>
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        <div class="materials-table-container custom-scrollbar">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th style="padding: 8px; text-align: left;">Material</th>
                                                        <th style="padding: 8px; text-align: center;">Tipo</th>
                                                        <th style="padding: 8px; text-align: right;">Qtd. Disp.</th>
                                                        <th style="padding: 8px; text-align: center;">Qtd. Nec.</th>
                                                        <th style="padding: 8px; text-align: center;">Dimensões (cm)</th>
                                                        <th style="padding: 8px; text-align: right;">Área (m²)</th>
                                                        <th style="padding: 8px; text-align: right;">Custo/m² ou Unit.</th>
                                                        <th style="padding: 8px; text-align: right;">Total</th>
                                                        <th style="padding: 8px; text-align: center;">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="editMateriaisList">
                                                    <!-- Materiais serão adicionados aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                                            <button type="button" onclick="openSelecionarMaterialModal()" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                Adicionar Material
                                            </button>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <strong style="color: white;">Custo Total:</strong>
                                                <span id="editCustoTotal" style="display: inline-block; padding: 4px 8px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; color: white; font-weight: bold;">R$ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Conteúdo da Aba Etapas - Modal Edição -->
                            <div class="tab-content" id="edit-etapas-tab">
                                <div class="form-group">
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        <div class="etapas-table-container custom-scrollbar">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th style="padding: 8px; text-align: left; width: 18%;">Etapa</th>
                                                        <th style="padding: 8px; text-align: center; width: 12%;">Tipo de etapa</th>
                                                        <th style="padding: 8px; text-align: center; width: 17%;">Equipamento</th>
                                                        <th style="padding: 8px; text-align: center; width: 18%;">Usar Material</th>
                                                        <th style="padding: 8px; text-align: center; width: 12%;">Tempo estimado</th>
                                                        <th style="padding: 8px; text-align: right; width: 13%;">Custo estimado</th>
                                                        <th style="padding: 8px; text-align: center; width: 10%;">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="editEtapasList">
                                                    <!-- Etapas serão adicionadas aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                                            <button type="button" onclick="openAdicionarEtapaModal()" class="btn-primary" style="background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#D8CEFE'; this.style.boxShadow='0 0 15px rgba(155, 100, 227, 0.8)'" onmouseout="this.style.backgroundColor='rgba(155, 100, 227, 0.1)'; this.style.boxShadow='none'">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                Adicionar Etapa
                                            </button>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <strong style="color: white;">Custo Total Etapas:</strong>
                                                <span id="editCustoTotalEtapas" style="display: inline-block; padding: 4px 8px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; color: white; font-weight: bold;">R$ 0,00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Conteúdo da Aba Anexos - Modal Edição -->
                            <div class="tab-content" id="edit-anexos-tab">
                                <div class="form-group">
                                    <small style="color: #D8CEFE; font-style: italic; margin-bottom: 8px; display: block;">
                                        * Anexe arquivos relacionados à confecção do produto (desenhos técnicos, moldes, instruções, etc.)
                                    </small>
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        
                                        <!-- Área de upload -->
                                        <div style="border: 2px dashed rgba(155, 100, 227, 0.5); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; transition: all 0.3s ease; cursor: pointer;" 
                                             id="editAnexoDropArea" 
                                             ondrop="handleFileDropEdit(event)" 
                                             ondragover="handleDragOver(event)" 
                                             ondragleave="handleDragLeave(event)"
                                             onclick="document.getElementById('editAnexoFileInput').click()">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 10px; opacity: 0.7;">
                                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l7.07-7.07"></path>
                                            </svg>
                                            <p style="margin: 10px 0; color: rgba(255, 255, 255, 0.8);">
                                                <strong>Clique aqui ou arraste arquivos</strong><br>
                                                <small>Formatos aceitos: PDF, DWG, PNG, JPG, DOC, XLS</small><br>
                                                <small>Tamanho máximo: 10MB por arquivo</small>
                                            </p>
                                            <input type="file" id="editAnexoFileInput" multiple accept=".pdf,.dwg,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx" style="display: none;" onchange="handleFileSelectEdit(event)">
                                        </div>
                                        
                                        <!-- Lista de arquivos anexados -->
                                        <div style="flex: 1; overflow-y: auto;" class="custom-scrollbar">
                                            <div id="editAnexosList" style="display: flex; flex-direction: column; gap: 8px;">
                                                <!-- Arquivos anexados aparecerão aqui -->
                                            </div>
                                        </div>
                                        
                                        <!-- Resumo -->
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="color: rgba(255, 255, 255, 0.8);">Arquivos anexados:</span>
                                                <span id="editAnexosCount" style="display: inline-block; padding: 2px 8px; background-color: rgba(155, 100, 227, 0.3); border-radius: 12px; color: white; font-weight: bold; font-size: 12px;">0</span>
                                            </div>
                                            <button type="button" onclick="limparTodosAnexosEdit()" class="btn-secondary" style="background-color: rgba(255, 100, 100, 0.1); border: 1px solid rgba(255, 100, 100, 0.4); color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 100, 100, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 100, 100, 0.1)'">
                                                Limpar Todos
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-primary" onclick="salvarEdicaoProduto()" style="margin-top: 5px;">Salvar Produto</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Novo Kit -->
<div id="kitModal" class="modal">
    <div class="modal-content custom-scrollbar">
        <span class="close-button" onclick="closeKitModal()">&times;</span>
        <h2>Novo Kit</h2>
        <div class="modal-body">
            <form id="kitForm">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label for="kitNome">Nome do Kit:</label>
                            <input type="text" id="kitNome" name="kitNome" required style="width: 90%;">
                        </div>
                        <div class="form-group">
                            <label for="kitCodigo">Código:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="text" id="kitCodigo" name="kitCodigo" required style="width: calc(50% - 40px);">
                                <button type="button" onclick="gerarCodigoKit()" style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid #FFC107; color: #FFC107; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#FFF3CD'" onmouseout="this.style.backgroundColor='rgba(255, 193, 7, 0.1)'" title="Gerar código automaticamente">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="kitDescricao">Descrição (opcional):</label>
                            <textarea id="kitDescricao" name="kitDescricao" style="width: 90%; height: 80px; resize: vertical;" placeholder="Descreva o kit e seu propósito..."></textarea>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <!-- Sistema de Abas para Produtos do Kit -->
                        <div class="tabs-container">
                            <div class="tabs-header">
                                <button type="button" class="tab-button active" data-tab="produtos">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="9" x2="15" y2="15"></line>
                                        <line x1="15" y1="9" x2="9" y2="15"></line>
                                    </svg>
                                    Produtos do Kit
                                </button>
                            </div>
                            
                            <!-- Conteúdo da Aba Produtos -->
                            <div class="tab-content active" id="produtos-tab">
                                <div class="form-group">
                                    <small style="color: #D8CEFE; font-style: italic; margin-bottom: 8px; display: block;">
                                        * Selecione os produtos que compõem este kit e ajuste as quantidades conforme necessário.
                                    </small>
                                    <div style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; padding: 8px; margin-bottom: 10px; height: 400px; display: flex; flex-direction: column;">
                                        <div class="materials-table-container custom-scrollbar">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th style="padding: 8px; text-align: left;">Produto</th>
                                                        <th style="padding: 8px; text-align: center;">Categoria</th>
                                                        <th style="padding: 8px; text-align: center;">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="kitProdutosList">
                                                    <!-- Produtos serão adicionados aqui -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style="border-top: 1px solid var(--cor-destaque, #9B64E3); padding-top: 10px; margin-top: 10px; display: flex; justify-content: center; align-items: center;">
                                            <button type="button" onclick="openSelecionarProdutosModal()" class="btn-primary" style="background-color: rgba(255, 193, 7, 0.1); border: 1px solid #FFC107; color: #FFC107; padding: 8px 16px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#FFF3CD'; this.style.boxShadow='0 0 15px rgba(255, 193, 7, 0.8)'" onmouseout="this.style.backgroundColor='rgba(255, 193, 7, 0.1)'; this.style.boxShadow='none'"
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                                Incluir Produtos
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-primary" onclick="salvarKit()" style="margin-top: 5px;">Salvar Kit</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Selecionar Produtos -->
<div id="selecionarProdutosModal" class="modal modal-top-level">
    <div class="modal-content" style="max-width: 1000px; max-height: 80vh;">
        <span class="close-button" onclick="closeSelecionarProdutosModal()">&times;</span>
        <h2>Selecionar Produtos para o Kit</h2>
        <div class="modal-body">
            <!-- Barra de pesquisa -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="searchProdutoKit" placeholder="Pesquisar produto..." 
                       style="width: calc(100% - 22px); padding: 10px; border: 1px solid var(--cor-destaque, #9B64E3); border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box;"
                       oninput="filtrarProdutosKit(this.value)">
            </div>
            
            <!-- Botões de seleção -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <button type="button" class="btn-secondary" onclick="selecionarTodosProdutos()" style="padding: 8px 16px;">
                    Selecionar Todos
                </button>
                <button type="button" class="btn-secondary" onclick="desselecionarTodosProdutos()" style="padding: 8px 16px;">
                    Limpar Seleção
                </button>
            </div>
            
            <!-- Lista de produtos -->
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #9B64E3; border-radius: 8px; background-color: rgba(255, 255, 255, 0.05);">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background-color: rgba(19, 4, 60, 0.9); z-index: 10;">
                        <tr style="border-bottom: 2px solid #9B64E3;">
                            <th style="padding: 12px 8px; text-align: center; color: white; width: 50px;">
                                <input type="checkbox" id="selectAllProdutosKit" onchange="toggleAllProdutosKit()" style="cursor: pointer;">
                            </th>
                            <th style="padding: 12px; text-align: left; color: white;">Produto</th>
                            <th style="padding: 12px; text-align: center; color: white; width: 120px;">Categoria</th>
                            <th style="padding: 12px; text-align: center; color: white; width: 120px;">Preço</th>
                        </tr>
                    </thead>
                    <tbody id="produtosKitList">
                        <!-- Produtos serão carregados aqui dinamicamente -->
                    </tbody>
                </table>
            </div>
            
            <!-- Rodapé do modal -->
            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="color: white;">Produtos selecionados: </span>
                    <span id="produtosSelecionadosCount" style="color: #2ED573; font-weight: bold;">0</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn-secondary" onclick="closeSelecionarProdutosModal()">Cancelar</button>
                    <button type="button" class="btn-primary" onclick="confirmarSelecaoProdutos()">Confirmar Seleção</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para o modal de confirmação de exclusão de produto */
    #productDeleteConfirmationModal {
        z-index: 2001;
    }

    #productDeleteConfirmationModal .modal-content {
        background-color: rgba(59, 12, 121, 0.29);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 2px solid #9B64E3;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 400px;
        max-width: 90%;
        position: relative;
        text-align: center;
        animation: modalAppear 0.3s ease-out;
    }

    #productDeleteConfirmationModal .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
    }

    /* Customização do scrollbar para o modal de confirmação */

    /* Estilos específicos para o modal de atualização de preços */
    .modal-content-price-update {
        background-color: rgba(59, 12, 121, 0.29);
        color: var(--sidebar-text-color);
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 10px;
        width: 90%;
        max-width: 1200px;
        max-height: calc(100vh - 120px); /* Deixa espaço para não encostar na navbar */
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Remove scroll do modal principal */
    }

    .modal-header-fixed {
        padding: 20px;
        background-color: rgba(59, 12, 121, 0.4);
        border-bottom: 1px solid rgba(155, 100, 227, 0.3);
        flex-shrink: 0; /* Impede que o header encolha */
    }

    .modal-content-scrollable {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0 20px;
        min-height: 0; /* Permite que o flex shrink funcione */
    }

    .modal-footer-fixed {
        padding: 20px;
        background-color: rgba(59, 12, 121, 0.4);
        border-top: 1px solid rgba(155, 100, 227, 0.3);
        flex-shrink: 0; /* Impede que o footer encolha */
    }

    /* Customização do scrollbar para o modal de preços */
    .modal-content-scrollable::-webkit-scrollbar {
        width: 8px;
    }

    .modal-content-scrollable::-webkit-scrollbar-track {
        background: rgba(155, 100, 227, 0.1);
        border-radius: 4px;
    }

    .modal-content-scrollable::-webkit-scrollbar-thumb {
        background: rgba(155, 100, 227, 0.5);
        border-radius: 4px;
    }

    .modal-content-scrollable::-webkit-scrollbar-thumb:hover {
        background: rgba(155, 100, 227, 0.7);
    }

    /* Responsividade para o modal de preços */
    @media (max-width: 768px) {
        .modal-content-price-update {
            width: 95%;
            max-height: calc(100vh - 80px);
        }

        .modal-header-fixed,
        .modal-content-scrollable,
        .modal-footer-fixed {
            padding: 15px;
        }
    }

    @media (max-width: 480px) {
        .modal-content-price-update {
            width: 98%;
            max-height: calc(100vh - 60px);
        }

        .modal-header-fixed,
        .modal-content-scrollable,
        .modal-footer-fixed {
            padding: 10px;
        }
    }

    /* Estilos para os modais de notificação */
    .notification-modal-content {
        max-width: 400px;
        text-align: center;
        padding: 30px;
    }
    .notification-modal-content .btn-primary {
        margin: 0 auto;
        display: block;
    }
    .notification-modal-content h2 {
        border-bottom: none;
        margin-bottom: 15px;
        font-size: 1.5em;
    }
    .notification-modal-content p {
        margin-bottom: 20px;
        font-size: 1.1em;
    }
    .notification-modal-content.success h2 {
        color: #4CAF50;
    }
    .notification-modal-content.error h2 {
        color: #F44336;
    }

    /* Estilos para o modal de confirmação de edição */
    .confirmation-edit-modal-content {
        max-width: 600px;
        text-align: center;
        padding: 30px;
    }
    
    .confirmation-edit-modal-content .btn-primary,
    .confirmation-edit-modal-content .btn-secondary {
        margin: 0 10px;
        display: inline-block;
    }
    
    .confirmation-edit-modal-content h2 {
        border-bottom: none;
        margin-bottom: 15px;
        font-size: 1.5em;
        color: #FFC107;
    }
    
    .confirmation-edit-modal-content p {
        margin-bottom: 20px;
        font-size: 1.1em;
    }
    
    #confirmationEditChanges {
        font-size: 0.95em;
        line-height: 1.4;
        text-align: left;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(155, 100, 227, 0.3);
        padding: 12px;
        margin: 15px 0;
        max-height: 300px;
        overflow-y: auto;
        /* Aplicar scroll customizado */
        scrollbar-width: thin;
        scrollbar-color: rgba(155, 100, 227, 0.8) rgba(0, 0, 0, 0.1);
    }
    
    /* Scroll customizado para WebKit */
    #confirmationEditChanges::-webkit-scrollbar {
        width: 8px;
    }
    
    #confirmationEditChanges::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }
    
    #confirmationEditChanges::-webkit-scrollbar-thumb {
        background: rgba(155, 100, 227, 0.8);
        border-radius: 4px;
        transition: background 0.3s ease;
    }
    
    #confirmationEditChanges::-webkit-scrollbar-thumb:hover {
        background: rgba(155, 100, 227, 1);
    }
    
    #confirmationEditChanges .change-item {
        margin: 3px 0;
        padding: 8px 10px;
        border-radius: 5px;
        background: rgba(155, 100, 227, 0.1);
        border-left: 3px solid #9B64E3;
    }
    
    #confirmationEditChanges .change-item:last-child {
        margin-bottom: 0;
    }
    
    #confirmationEditChanges .change-item:first-child {
        margin-top: 0;
    }
    
    #confirmationEditChanges .change-label {
        font-weight: bold;
        color: #9B64E3;
        display: block;
        margin-bottom: 3px;
        font-size: 1.05em;
    }
    
    #confirmationEditChanges .change-value {
        color: #e0e0e0;
        font-size: 0.95em;
        line-height: 1.4;
        margin-top: 2px;
        white-space: pre-line; /* Permite quebras de linha */
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    #confirmationEditChanges .change-comparison {
        margin-top: 3px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    #confirmationEditChanges .change-from {
        color: #ff6b6b;
        text-decoration: line-through;
        background: rgba(244, 67, 54, 0.1);
        padding: 2px 4px;
        border-radius: 3px;
        flex: 0 1 auto;
        min-width: 0;
    }
    
    #confirmationEditChanges .change-to {
        color: #51cf66;
        font-weight: bold;
        background: rgba(76, 175, 80, 0.1);
        padding: 2px 4px;
        border-radius: 3px;
        flex: 0 1 auto;
        min-width: 0;
    }
    
    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }

    /* Estilos para o dropdown customizado */
    .custom-select {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 5px;
        position: relative;
        z-index: 10;
    }

    .custom-select > button {
        padding: 10px;
        background: transparent;
        border: none;
        color: white;
        text-align: left;
        font-size: 0.9em;
        width: 100%;
        cursor: pointer;
        position: relative;
    }

    .custom-select > button:after {
        content: "▼";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #9B64E3;
        font-size: 0.8em;
        pointer-events: none;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        width: calc(100% - 12px);
        left: 6px;
        background-color: rgba(19, 4, 60, 0.95);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-radius: 10px;
        margin-top: 5px;
        z-index: 1000;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid rgba(155, 100, 227, 0.3);
    }

    /* Scroll personalizado para dropdowns */
    .dropdown-content::-webkit-scrollbar {
        width: 12px;
    }

    .dropdown-content::-webkit-scrollbar-track {
        background: rgba(155, 100, 227, 0.1);
        border-radius: 4px;
        margin-right: 2px;
    }

    .dropdown-content::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #9B64E3, #D8CEFE);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(155, 100, 227, 0.3);
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    .dropdown-content::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #8A4FD3, #C7B7FE);
        box-shadow: 0 4px 8px rgba(155, 100, 227, 0.5);
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    /* Firefox */
    .dropdown-content {
        scrollbar-width: thin;
        scrollbar-color: #9B64E3 rgba(155, 100, 227, 0.1);
    }

    .dropdown-content > div {
        display: block;
        padding: 10px;
        color: white;
        cursor: pointer;
        text-decoration: none;
        position: relative;
        transition: background-color 0.2s ease;
    }

    .dropdown-content > div:hover,
    .dropdown-content > div:focus {
        background-color: rgba(155, 100, 227, 0.2);
        color: var(--cor-destaque, #D8CEFE);
    }

    .dropdown:hover .dropdown-content,
    .dropdown:focus-within .dropdown-content {
        display: block;
    }

    /* Indicadores visuais para máquinas e ferramentas no dropdown */
    .dropdown-content > div[data-value^="maquina_"],
    .dropdown-content > div[data-value^="ferramenta_"] {
        padding: 8px 12px;
        border-radius: 6px;
        margin: 2px 4px;
        transition: all 0.3s ease;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dropdown-content > div[data-value^="maquina_"]:hover {
        background-color: rgba(155, 100, 227, 0.2);
        color: var(--cor-destaque, #D8CEFE);
    }

    .dropdown-content > div[data-value^="ferramenta_"]:hover {
        background-color: rgba(155, 100, 227, 0.2);
        color: var(--cor-destaque, #D8CEFE);
    }

    /* Estilos específicos para ícones SVG nos dropdowns */
    .dropdown-content img[alt="Máquina"],
    .dropdown-content img[alt="Ferramenta"] {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }

    .dropdown-content > div:hover img[alt="Máquina"],
    .dropdown-content > div:hover img[alt="Ferramenta"] {
        opacity: 1;
    }

    /* Legenda para equipamentos (opcional para adicionar posteriormente) */
    .equipamentos-legenda {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        font-size: 12px;
        color: var(--cor-texto, #ccc);
    }

    .equipamentos-legenda .legenda-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .equipamentos-legenda .legenda-cor {
        width: 12px;
        height: 3px;
    }

    .equipamentos-legenda .legenda-maquina {
        background-color: #007bff;
    }

    .equipamentos-legenda .legenda-ferramenta {
        background-color: #28a745;
    }

    /* Estilos básicos do modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    /* Modal de nível superior - para modais que aparecem sobre outros modais */
    .modal-top-level {
        z-index: 10002 !important;
    }

    /* Modal de notificação - z-index mais alto */
    .modal-notification {
        z-index: 15000 !important;
    }

    /* Garantir que o modal de notificação sempre apareça acima de todos os outros */
    #notificationModal {
        z-index: 15000 !important;
    }

    #notificationModal.modal {
        z-index: 15000 !important;
    }

    /* Garantir que o modal de confirmação de edição também tenha z-index alto */
    #confirmationEditModal {
        z-index: 15001 !important;
    }

    #confirmationEditModal.modal {
        z-index: 15001 !important;
    }

    /* Forçar z-index para todos os modais de notificação e confirmação */
    .modal.modal-notification,
    #notificationModal.modal-notification,
    #confirmationEditModal.modal-notification {
        z-index: 15000 !important;
    }

    /* Sobrescrever qualquer z-index inferior nos modais de notificação */
    .modal-notification * {
        position: relative;
        z-index: auto;
    }

    .modal-content {
        background-color: rgba(59, 12, 121, 0.29);
        color: var(--sidebar-text-color);
        margin: 0;
        padding: 15px;
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 10px;
        width: 70%;
        max-width: 1200px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .close-button {
        color: var(--sidebar-text-color);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-button:hover,
    .close-button:focus {
        color: var(--cor-destaque, #D8CEFE);
        text-shadow: 0 0 8px rgba(155, 100, 227, 0.8);
    }

    .modal-content h2 {
        color: var(--sidebar-text-color);
        margin-top: 0;
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
        padding-bottom: 10px;
    }
    
    /* Sobrescrever para modais de produtos */
    #produtoModal .modal-content h2,
    #editProdutoModal .modal-content h2 {
        margin-top: 0;
        margin-bottom: 20px;
        padding-right: 60px; /* Espaço para o botão fechar */
        padding-bottom: 15px;
        color: white;
        font-size: 24px;
        font-weight: 600;
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
    }

    .modal-body {
        padding: 20px;
    }

    .modal-layout {
        display: flex;
        gap: 20px;
    }

    .modal-form {
        flex: 1;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--sidebar-text-color);
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="time"],
    .form-group textarea,
    .form-group select {
        width: calc(100% - 22px);
        padding: 10px;
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
    }

    .form-group input:hover,
    .form-group textarea:hover,
    .form-group select:hover {
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.7);
        border-color: #D8CEFE;
    }

    /* Estilos específicos para campos de tempo */
    .time-input,
    input[type="time"] {
        width: calc(100% - 22px) !important;
        padding: 10px !important;
        border: 1px solid var(--cor-destaque, #9B64E3) !important;
        border-radius: 5px !important;
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: white !important;
        transition: all 0.3s ease !important;
        font-family: inherit !important;
        font-size: 0.9em !important;
    }

    .time-input:hover,
    input[type="time"]:hover {
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.7) !important;
        border-color: #D8CEFE !important;
        background-color: rgba(255, 255, 255,  0.15) !important;
    }

    .time-input:focus,
    input[type="time"]:focus {
        outline: none !important;
        border-color: #D8CEFE !important;
        box-shadow: 0 0 12px rgba(155, 100, 227, 0.8) !important;
        background-color: rgba(255, 255, 255, 0.2) !important;
    }

    /* Estilos para botões de gerar descrição */
    #btnGerarDescricao, #btnGerarDescricaoEdit {
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(155, 100, 227, 0.3);
    }

    #btnGerarDescricao:hover, #btnGerarDescricaoEdit:hover {
        background: linear-gradient(135deg, #A770E8, #8850C3) !important;
        box-shadow: 0 4px 12px rgba(155, 100, 227, 0.5);
        transform: translateY(-1px);
    }

    #btnGerarDescricao:active, #btnGerarDescricaoEdit:active {
        transform: translateY(0px);
        box-shadow: 0 2px 6px rgba(155, 100, 227, 0.4);
    }

    /* Personalizar os controles do input de tempo */
    input[type="time"]::-webkit-calendar-picker-indicator {
        background-color: transparent;
        color: #9B64E3;
        cursor: pointer;
        filter: invert(1);
        opacity: 0.7;
    }

    input[type="time"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
        background-color: rgba(155, 100, 227, 0.1);
        border-radius: 3px;
    }

    /* Estilos específicos para materiais */
    /* Estilos básicos do modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }


    .modal-body {
        padding: 20px;
        max-height: 70vh;
        overflow-y: auto;
    }

    .close-button {
        color: var(--sidebar-text-color, white);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
        color: var(--cor-destaque, #D8CEFE);
        text-decoration: none;
    }

    .modal-content h2 {
        color: var(--sidebar-text-color, white);
        margin-top: 0;
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
        padding-bottom: 10px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--sidebar-text-color, white);
    }

    .materials-list {
        margin-top: 10px;
        background-color: rgba(19, 4, 60, 0.69);
        border-radius: 8px;
        padding: 15px;
        width: 100%;
        overflow-x: auto;
    }

    /* Materiais */
    .materials-list {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--cor-destaque, #9B64E3);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
    }

    .materials-list table {
        width: 100%;
        border-collapse: collapse;
    }

    .materials-list thead tr {
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
    }

    .materials-list th,
    .materials-list td {
        padding: 8px;
        text-align: left;
    }

    .materials-list th {
        font-weight: bold;
        color: var(--sidebar-text-color, white);
    }

    .materials-list tbody tr:hover {
        background-color: rgba(155, 100, 227, 0.1);
    }

    .materials-header {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 0.5fr;
        gap: 10px;
        padding: 15px;
        background-color: rgba(155, 100, 227, 0.1);
        border-radius: 5px;
        margin-bottom: 10px;
        font-weight: bold;
        border-bottom: 2px solid var(--cor-destaque, #9B64E3);
        color: var(--column-title-text);
    }

    .material-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 0.5fr;
        gap: 10px;
        padding: 12px;
        border: 1px solid rgba(155, 100, 227, 0.2);
        border-radius: 5px;
        margin-bottom: 5px;
        align-items: center;
        background-color: rgba(155, 100, 227, 0.05);
        transition: all 0.3s ease;
    }

    .material-item:hover {
        background-color: rgba(155, 100, 227, 0.1);
        box-shadow: 0 0 10px rgba(155, 100, 227, 0.3);
    }

    .material-item select,
    .material-item input[type="number"] {
        width: 90%;
        padding: 8px;
        border: 1px solid #9B64E3;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
    }

    .material-item select:hover,
    .material-item input[type="number"]:hover {
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.7);
        border-color: #D8CEFE;
    }

    .material-item select option {
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text-color);
    }

    .material-item .material-actions {
        display: flex;
        justify-content: center;
        gap: 5px;
    }

    .material-item .btn-remove {
        background: none;
        border: none;
        color: #F44336;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .material-item .btn-remove:hover {
        background-color: rgba(244, 67, 54, 0.2);
        transform: scale(1.1);
    }

    /* Botões */
    .btn-primary,
    .btn-secondary {
        background-color: rgba(155, 100, 227, 0.1);
        border: 1px solid #9B64E3;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
    }

    .btn-primary:hover,
    .btn-secondary:hover {
        background-color: #D8CEFE;
        box-shadow: 0 0 15px rgba(155, 100, 227, 0.7);
        transform: translateY(-2px);
    }

    #save-produto-btn {
        margin-top: 30px;
        width: auto;
        margin-left: auto;
        margin-right: auto;
        display: block;
        padding: 12px 24px;
    }

    .btn-secondary {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }

    #materialsList {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
    }

    /* Custom scrollbar styles para a lista de materiais */
    .custom-scrollbar::-webkit-scrollbar {
        width: 12px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(155, 100, 227, 0.1);
        border-radius: 4px;
        margin-right: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #9B64E3, #D8CEFE);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(155, 100, 227, 0.3);
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #8A4FD3, #C7B7FE);
        box-shadow: 0 4px 8px rgba(155, 100, 227, 0.5);
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    /* Firefox */
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #9B64E3 rgba(155, 100, 227, 0.1);
    }

    .materials-table-container table {
        width: 100%;
        border-collapse: collapse;
    }

    /* Estilos para cabeçalho fixo da tabela de etapas */
    .etapas-table-container {
        position: relative;
        max-height: 150px;
        overflow-y: auto;
    }

    .etapas-table-container table {
        width: 100%;
        border-collapse: collapse;
    }

    .etapas-table-container thead th {
        position: sticky;
        top: 0;
        background-color: rgba(59, 12, 121, 0.58);
        z-index: 1;
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    /* Cabeçalho flutuante para tabela de materiais - mesmo estilo das etapas */
    .materials-table-container thead th {
        position: sticky;
        top: 0;
        background-color: rgba(59, 12, 121, 0.58);
        z-index: 1;
        border-bottom: 1px solid var(--cor-destaque, #9B64E3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        font-weight: 600;
    }

    /* Estilos para badges de tipo de etapa */
    .etapa-tipo-badge {
        background-color: rgba(155, 100, 227, 0.2);
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
        border: 1px solid rgba(155, 100, 227, 0.3);
        display: inline-block;
        text-align: center;
        min-width: 70px;
    }

    /* Estilos para botões de ação nas etapas */
    .btn-edit:hover {
        color: #D8CEFE !important;
        transform: scale(1.1);
    }

    .btn-delete:hover {
        color: #ff8a8a !important;
        transform: scale(1.1);
    }

    .btn-edit, .btn-delete {
        transition: all 0.2s ease;
    }

    /* Estilos para campos de dimensões */
    .dimensions-input {
        width: 65px;
        text-align: center;
        padding: 4px 6px;
        border: 1px solid #9B64E3;
        border-radius: 3px;
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
        font-size: 13px;
        font-weight: 500;
    }

    .dimensions-input:focus {
        outline: none;
        border-color: #D8CEFE;
        box-shadow: 0 0 8px rgba(155, 100, 227, 0.6);
        background-color: rgba(255, 255, 255, 0.2);
    }

    .dimensions-input:hover {
        background-color: rgba(255, 255, 255, 0.18);
        border-color: #B88EE8;
    }

    .dimensions-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
        font-size: 11px;
        font-style: italic;
    }

    .dimensions-container {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: center;
        min-width: 140px;
    }

    .dimension-separator {
        color: white;
        font-size: 14px;
        font-weight: bold;
        margin: 0 2px;
    }

    .area-display, .subtotal-display {
        font-weight: bold;
        color: #D8CEFE;
    }

    /* Estilo para campos não disponíveis */
    .na-field {
        color: #666 !important;
        font-style: italic;
        font-size: 12px;
        text-align: center;
    }

    /* Estilo para campos de quantidade desabilitados */
    input[data-tipo="quantidade"][readonly] {
        background-color: rgba(150, 150, 150, 0.2) !important;
        color: #999 !important;
        cursor: not-allowed !important;
        opacity: 0.7 !important;
    }

    input[data-tipo="quantidade"][readonly]:hover {
        box-shadow: none !important;
        border-color: #666 !important;
    }

    /* Estilo para tooltip personalizado na coluna de materiais */
    .material-name-cell {
        max-width: 150px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        cursor: help;
        position: relative;
    }

    .material-name-cell:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 0;
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: normal;
        word-wrap: break-word;
        max-width: 300px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        border: 1px solid #9B64E3;
        margin-bottom: 5px;
    }

    .material-name-cell:hover::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 15px;
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid rgba(0, 0, 0, 0.9);
        z-index: 1001;
        margin-bottom: -5px;
    }

    /* Estilos para validação visual de dimensões que excedem o máximo */
    .dimension-input-error {
        color: #ff4444 !important;
        border-color: #ff4444 !important;
        background-color: rgba(255, 68, 68, 0.1) !important;
        box-shadow: 0 0 8px rgba(255, 68, 68, 0.3) !important;
        animation: pulse-error 1.5s ease-in-out infinite;
    }

    @keyframes pulse-error {
        0%, 100% {
            box-shadow: 0 0 8px rgba(255, 68, 68, 0.3);
        }
        50% {
            box-shadow: 0 0 12px rgba(255, 68, 68, 0.6);
        }
    }

    .dimension-input-valid {
        color: white !important;
        border-color: #9B64E3 !important;
        background-color: rgba(255, 255, 255, 0.15) !important;
        box-shadow: none !important;
        animation: none !important;
    }

    /* Estilos para tooltip */
    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    .tooltip-text {
        visibility: hidden;
        background-color: rgba(19, 4, 60, 0.9);
        color: white;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1001;
        bottom: 125%;
        left: 50%;
        margin-left: -125px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        border: 1px solid #9B64E3;
    }
    
    /* Estilização personalizada para checkboxes do modal de preços */
    .price-update-table input[type="checkbox"], 
    #selectAllProducts {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid #9B64E3;
        border-radius: 3px;
        background-color: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        position: relative;
        vertical-align: middle;
    }
    
    .price-update-table input[type="checkbox"]:checked,
    #selectAllProducts:checked {
        background-color: #9B64E3;
    }
    
    .price-update-table input[type="checkbox"]:checked::after,
    #selectAllProducts:checked::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    .price-update-table input[type="checkbox"]:hover,
    #selectAllProducts:hover {
        background-color: rgba(155, 100, 227, 0.2);
    }

    /* ===================================== */
    /* ESTILOS PARA LISTA DE PRODUTOS */
    /* ===================================== */

    .produto-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(155, 100, 227, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .produto-item:hover {
        background-color: rgba(155, 100, 227, 0.1);
        border-color: rgba(155, 100, 227, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(155, 100, 227, 0.2);
    }

    .produto-info {
        flex: 1;
    }

    .produto-nome {
        font-size: 1.1em;
        margin-bottom: 8px;
    }

    .produto-nome strong {
        color: #ffffff;
        margin-right: 10px;
    }

    .produto-codigo {
        color: #9B64E3;
        font-size: 0.9em;
        background-color: rgba(155, 100, 227, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .produto-detalhes {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .produto-categoria {
        color: #cccccc;
        font-size: 0.9em;
    }

    .produto-preco {
        color: #2ED573;
        font-weight: bold;
        font-size: 1em;
    }

    .produto-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-ativo {
        background-color: rgba(46, 213, 115, 0.2);
        color: #2ED573;
        border: 1px solid rgba(46, 213, 115, 0.3);
    }

    .status-inativo {
        background-color: rgba(255, 107, 107, 0.2);
        color: #FF6B6B;
        border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .produto-acoes {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-editar, .btn-duplicar, .btn-excluir {
        padding: 8px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .btn-editar {
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .btn-editar:hover {
        background-color: rgba(52, 152, 219, 0.2);
        transform: scale(1.1);
    }

    .btn-duplicar {
        background-color: rgba(241, 196, 15, 0.1);
        color: #f1c40f;
        border: 1px solid rgba(241, 196, 15, 0.3);
    }

    .btn-duplicar:hover {
        background-color: rgba(241, 196, 15, 0.2);
        transform: scale(1.1);
    }

    .btn-excluir {
        background-color: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .btn-excluir:hover {
        background-color: rgba(231, 76, 60, 0.2);
        transform: scale(1.1);
    }

    /* Responsividade para lista de produtos */
    @media (max-width: 768px) {
        .produto-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .produto-acoes {
            align-self: flex-end;
            width: 100%;
            justify-content: flex-end;
        }

        .produto-detalhes {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
    }
</style>

<script>
    // =============================================
    // FUNCIONALIDADES DO SISTEMA DE PRODUTOS
    // =============================================
    
    // Função de debug para testar cálculos de preços
    async function debugCalculosPrecos() {
        try {
            console.log('=== DEBUG: Iniciando teste de cálculos de preços ===');
            
            // Buscar todos os produtos para teste
            const response = await fetch('/api/produtos');
            if (!response.ok) {
                throw new Error('Não foi possível buscar produtos para debug');
            }
            
            const data = await response.json();
            const produtos = data.produtos || [];
            
            if (produtos.length === 0) {
                showNotification('Nenhum produto encontrado para teste', 'warning');
                return;
            }
            
            // Testar cálculo detalhado do primeiro produto
            const produtoTeste = produtos[0];
            console.log(`=== DEBUG: Testando produto: ${produtoTeste.nome} (ID: ${produtoTeste.id}) ===`);
            
            const detalhesResponse = await fetch(`/api/produtos/${produtoTeste.id}/detalhes-calculo`);
            if (!detalhesResponse.ok) {
                throw new Error('Não foi possível obter detalhes do produto');
            }
            
            const detalhes = await detalhesResponse.json();
            console.log('=== DEBUG: Detalhes do produto ===', detalhes);
            
            // Simular cálculo com diferentes cenários
            for (const material of detalhes.materiais || []) {
                console.log(`\n=== DEBUG: Testando material: ${material.nome} ===`);
                
                // Cenário 1: Custo atual
                const custo1 = calcularCustoMaterialInteligente(
                    material.nome,
                    material.custo_unitario,
                    material.quantidade_necessaria,
                    material.area_utilizada,
                    material.unidades_por_pacote,
                    material.is_measurement,
                    !!(material.largura && material.comprimento),
                    material.area_total
                );
                console.log(`Cenário 1 (custo atual R$${material.custo_unitario}): R$${custo1.toFixed(2)}`);
                
                // Cenário 2: Custo aumentado em 20%
                const custoAumentado = material.custo_unitario * 1.2;
                const custo2 = calcularCustoMaterialInteligente(
                    material.nome,
                    custoAumentado,
                    material.quantidade_necessaria,
                    material.area_utilizada,
                    material.unidades_por_pacote,
                    material.is_measurement,
                    !!(material.largura && material.comprimento),
                    material.area_total
                );
                console.log(`Cenário 2 (custo +20% R$${custoAumentado.toFixed(2)}): R$${custo2.toFixed(2)}`);
                console.log(`Diferença: R$${(custo2 - custo1).toFixed(2)} (${((custo2 - custo1) / custo1 * 100).toFixed(2)}%)`);
            }
            
            showNotification('Debug de cálculos concluído. Verifique o console para detalhes.', 'info');
            
        } catch (error) {
            console.error('Erro no debug de cálculos:', error);
            showNotification('Erro no debug de cálculos: ' + error.message, 'error');
        }
    }

    /* 
     * FUNCIONALIDADE DE REMOÇÃO COM CLIQUE DIREITO:
     * - Materiais nas tabelas podem ser removidos clicando com o botão direito
     * - Funciona tanto no modal de novo produto quanto no modal de edição
     * - Inclui feedback visual: hover mostra tooltip, clique direito destaca a linha
     * - Confirmação antes da remoção para evitar remoções acidentais
     * - Atualização automática dos custos totais após remoção
     */
    
    let searchTimeout = null;

    async function buscarMateriais(searchTerm) {
        console.log(`Buscando materiais com termo: "${searchTerm}"`);
        
        if (searchTerm.length < 2) {
            document.getElementById('materiaisDropdown').style.display = 'none';
            return;
        }

        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        // Set new timeout to prevent too many requests
        searchTimeout = setTimeout(async () => {
            try {
                console.log(`Fazendo requisição para: /api/itens_estoque/busca?termo=${encodeURIComponent(searchTerm)}`);
                
                // Busca materiais na tabela itens_estoque
                const response = await fetch(`/api/itens_estoque/busca?termo=${encodeURIComponent(searchTerm)}`);
                
                console.log('Status da resposta:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos da API:', data);

                const dropdown = document.getElementById('materiaisDropdown');
                dropdown.innerHTML = '';

                if (data.status === 'success' && data.itens && data.itens.length > 0) {
                    console.log(`Encontrados ${data.itens.length} materiais`);
                    
                    // Processar itens sequencialmente para buscar informações completas
                    for (const item of data.itens) {
                        const div = document.createElement('div');
                        div.className = 'material-option';
                        div.style.padding = '8px 12px';
                        div.style.cursor = 'pointer';
                        div.style.transition = 'background-color 0.2s ease';
                        div.style.color = 'white';
                        
                        // Usa o campo 'descricao' que vem da API
                        let nomeCompleto = item.descricao || item.nome || 'Item sem nome';
                        const quantidade = item.quantidade_atual || 0;
                        const preco = item.preco_unitario || 0;
                        const tipoItem = item.tipo_item_nome || 'Sem tipo';
                        
                        // Buscar informações completas para exibir nome completo
                        try {
                            const responseCompleto = await fetch(`/api/itens_estoque/${item.id}`);
                            if (responseCompleto.ok) {
                                const materialInfo = await responseCompleto.json();
                                const largura = materialInfo.item?.largura;
                                const comprimento = materialInfo.item?.comprimento;
                                const area = materialInfo.item?.area;
                                const fabricante = materialInfo.item?.fabricante;
                                
                                // Adicionar dimensões se disponível
                                if (area && parseFloat(area) > 1 && largura && comprimento) {
                                    const larguraFormat = parseFloat(largura).toFixed(0);
                                    const comprimentoFormat = parseFloat(comprimento).toFixed(0);
                                    const areaFormatada = parseFloat(area).toFixed(2).replace('.', ',');
                                    nomeCompleto += ` ${larguraFormat}x${comprimentoFormat}cm (${areaFormatada}m²)`;
                                }
                                
                                // Adicionar fabricante se disponível
                                if (fabricante) {
                                    nomeCompleto += ` ${fabricante.toUpperCase()}`;
                                }
                            }
                        } catch (error) {
                            console.error('Erro ao buscar informações completas do material:', error);
                        }
                        
                        // Determinar se deve mostrar preço por m² ou unitário
                        const temDimensoes = tipoSuportaDimensoes(tipoItem);
                        const precoDisplay = temDimensoes ? 
                            `${formatarMoedaBrasileira(preco / 1)}/m²` : // assumindo 1m² como área padrão
                            formatarMoedaBrasileira(preco);
                        
                        div.innerHTML = `${nomeCompleto} (Tipo: ${tipoItem} | Disp: ${quantidade} | ${precoDisplay})`;
                        
                        div.onmouseover = function() {
                            this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
                        };
                        
                        div.onmouseout = function() {
                            this.style.backgroundColor = 'transparent';
                        };
                        
                        div.onclick = function() {
                            const materialData = {
                                id: item.id,
                                nome: item.descricao || item.nome || 'Item sem nome',
                                quantidade_atual: item.quantidade_atual || 0,
                                preco_unitario: item.preco_unitario || 0,
                                tipo_item_nome: item.tipo_item_nome || 'Sem tipo',
                                // Para materiais tipo bobina/chapa, assumir área padrão de 1m² se não especificado
                                area_total: item.area_total || (tipoSuportaDimensoes(item.tipo_item_nome || '') ? 1 : null)
                            };
                            adicionarMaterialSelecionado(materialData);
                            document.getElementById('materiaisDropdown').style.display = 'none';
                            document.querySelector('#materialSelect input').value = '';
                        };
                        
                        dropdown.appendChild(div);
                    }
                    
                    dropdown.style.display = 'block';
                } else {
                    dropdown.innerHTML = '<div style="padding: 8px 12px; color: #666;">Nenhum material encontrado</div>';
                    dropdown.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao buscar materiais:', error);
            }
        }, 300); // Wait 300ms after last keystroke
    }

    async function adicionarMaterialSelecionado(item) {
        console.log('Função adicionarMaterialSelecionado chamada com:', item);
        
        // Detectar qual modal está ativo e usar a lista correta
        let materialsList;
        let custoTotalElementId;
        
        if (document.getElementById('editProdutoModal').style.display === 'block') {
            // Modal de edição está ativo
            materialsList = document.getElementById('editMateriaisList');
            custoTotalElementId = 'editCustoTotal';
        } else {
            // Modal de novo produto está ativo
            materialsList = document.getElementById('materiaisList');
            custoTotalElementId = 'custoTotal';
        }
        
        console.log('Elemento materialsList encontrado:', materialsList);
        
        if (!materialsList) {
            console.error('Elemento materialsList não encontrado!');
            return;
        }
        
        // Gerar ID único para esta instância do material
        const instanceId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('Gerando ID único para instância do material:', instanceId);
        
        // Buscar informações completas do material incluindo tipo
        let tipoMaterial = 'N/A';
        let areaTotalMaterial = 1; // Valor padrão para assumir preço por m²
        let nomeCompleto = item.nome;
        
        try {
            const response = await fetch(`/api/itens_estoque/${item.id}`);
            if (response.ok) {
                const materialInfo = await response.json();
                console.log('Informações do material recuperadas:', materialInfo.item);
                tipoMaterial = materialInfo.item?.tipo_item_nome || 'N/A';
                
                console.log('Informações do material recuperadas:', {
                    id: item.id,
                    nome: item.nome,
                    tipoMaterial: tipoMaterial,
                    largura: materialInfo.item?.largura,
                    comprimento: materialInfo.item?.comprimento,
                    area: materialInfo.item?.area,
                    fabricante: materialInfo.item?.fabricante,
                    is_measurement: materialInfo.item?.is_measurement
                });
                
                // Adicionar is_measurement ao objeto item
                item.is_measurement = materialInfo.item?.is_measurement || 0;
                
                // Usar a área já calculada pela API, ou calcular se não disponível
                if (materialInfo.item?.area) {
                    areaTotalMaterial = parseFloat(materialInfo.item.area);
                    console.log('Usando área da API:', areaTotalMaterial);
                } else if (materialInfo.item?.largura && materialInfo.item?.comprimento) {
                    const larguraCm = parseFloat(materialInfo.item.largura);
                    const comprimentoCm = parseFloat(materialInfo.item.comprimento);
                    areaTotalMaterial = (larguraCm / 100) * (comprimentoCm / 100); // Converter para m²
                    
                    console.log('Calculando área manualmente:', {
                        larguraCm: larguraCm,
                        comprimentoCm: comprimentoCm,
                        areaTotalMaterial: areaTotalMaterial
                    });
                } else {
                    console.log('Dimensões não encontradas, usando valor padrão:', areaTotalMaterial);
                }
                
                // Construir nome completo do material UMA ÚNICA VEZ
                // Adicionar dimensões se disponível
                if (areaTotalMaterial > 1 && materialInfo.item?.largura && materialInfo.item?.comprimento) {
                    const largura = parseFloat(materialInfo.item.largura).toFixed(0);
                    const comprimento = parseFloat(materialInfo.item.comprimento).toFixed(0);
                    nomeCompleto += ` ${largura}x${comprimento}cm (${areaTotalMaterial.toFixed(2).replace('.', ',')}m²)`;
                }
                
                // Adicionar fabricante se disponível
                const fabricante = materialInfo.item?.fabricante;
                if (fabricante) {
                    nomeCompleto += ` ${fabricante.toUpperCase()}`;
                }
            }
        } catch (error) {
            console.error('Erro ao buscar informações do material:', error);
        }
        
        const tr = document.createElement('tr');
        tr.setAttribute('data-material-id', item.id); // ID do material original
        tr.setAttribute('data-instance-id', instanceId); // ID único da instância
        
        // Verificar se deve mostrar campos de dimensões baseado no tipo
        const mostrarDimensoes = tipoSuportaDimensoes(tipoMaterial);
        
        tr.innerHTML = `
            <td class="material-name-cell" style="padding: 10px; color: white;" title="${nomeCompleto}">${nomeCompleto}</td>
            <td style="padding: 10px; text-align: center; color: white;">${tipoMaterial || 'Sem tipo'}</td>
            <td style="padding: 10px; text-align: right; color: white;">${item.quantidade_atual}</td>
            <td style="padding: 10px; text-align: center; color: white;">
                ${mostrarDimensoes ? `
                    <input type="number" min="0" step="1" value="1" readonly
                           class="quantidade-input"
                           data-tipo="quantidade"
                           style="width: 60px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 4px; border-radius: 3px;"
                           title="Quantidade fixa para materiais dimensionais">
                ` : `
                    <input type="number" min="0" step="1" value="1"
                           class="quantidade-input"
                           data-tipo="quantidade"
                           onchange="${custoTotalElementId === 'editCustoTotal' ? 'calcularSubtotalCompletoEdit(this)' : 'calcularSubtotalCompleto(this)'}"
                           oninput="${custoTotalElementId === 'editCustoTotal' ? 'calcularSubtotalCompletoEdit(this)' : 'calcularSubtotalCompleto(this)'}"
                           style="width: 60px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 4px; border-radius: 3px;"
                           title="Quantidade necessária">
                `}
            </td>
            <td style="padding: 10px; text-align: center; color: white;">
                ${mostrarDimensoes ? `
                    <div class="dimensions-container">
                        <input type="number" placeholder="Larg." min="0" step="0.1" value="0"
                               class="dimensions-input"
                               onchange="${custoTotalElementId === 'editCustoTotal' ? 'calcularSubtotalCompletoEdit(this)' : 'calcularSubtotalCompleto(this)'}"
                               oninput="${custoTotalElementId === 'editCustoTotal' ? 'calcularSubtotalCompletoEdit(this)' : 'calcularSubtotalCompleto(this)'}"
                               data-dimension="largura"
                               style="width: 60px; margin-right: 5px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 2px; border-radius: 3px;"
                               title="Largura em centímetros">
                        <span class="dimension-separator">×</span>
                        <input type="number" placeholder="Alt." min="0" step="0.1" value="0"
                               class="dimensions-input"
                               onchange="${custoTotalElementId === 'editCustoTotal' ? 'calcularSubtotalCompletoEdit(this)' : 'calcularSubtotalCompleto(this)'}"
                               oninput="${custoTotalElementId === 'editCustoTotal' ? 'calcularSubtotalCompletoEdit(this)' : 'calcularSubtotalCompleto(this)'}"
                               data-dimension="altura"
                               style="width: 60px; margin-left: 5px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 2px; border-radius: 3px;"
                               title="Altura em centímetros">
                    </div>
                ` : `
                    <span class="na-field">N/A</span>
                `}
            </td>
            <td style="padding: 10px; text-align: right; color: white;">
                ${mostrarDimensoes ? `
                    <span class="area-display" data-area-total="${areaTotalMaterial}" data-area-utilizada="0">0,00 m²</span>
                ` : `
                    <span class="na-field" data-area-utilizada="${areaTotalMaterial}">N/A</span>
                `}
            </td>
            <td style="padding: 10px; text-align: right; color: white;">
                <span class="preco-unitario-display" data-preco="${item.preco_unitario}" data-mostrar-dimensoes="${mostrarDimensoes}">
                    ${mostrarDimensoes ? 'R$ 0,00/m²' : formatarMoedaBrasileira(item.preco_unitario || 0)}
                </span>
            </td>
            <td style="padding: 10px; text-align: right; color: white;">
                <span class="subtotal-display" 
                      data-preco="${item.preco_unitario}" 
                      data-mostrar-dimensoes="${mostrarDimensoes}"
                      data-unidades-pacote="${item.unidades_por_pacote || 0}"
                      data-is-measurement="${item.is_measurement === 1 || item.is_measurement === true}">R$ 0,00</span>
            </td>
            <td style="padding: 10px; text-align: center;">
                <button type="button" class="action-btn" data-tooltip="Excluir" onclick="removerMaterialDaTabela(this)" style="background: none; border: none; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--action-icon-color); position: relative;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </td>
        `;
        
        console.log('TR criado:', tr);
        
        // Adicionar material ao array correspondente
        if (custoTotalElementId === 'editCustoTotal') {
            // Modal de edição está ativo - sempre adicionar (permitir múltiplas instâncias)
            const materialData = {
                instance_id: instanceId, // ID único da instância
                material_id: item.id,
                material_nome: nomeCompleto,
                tipo_item_nome: tipoMaterial,
                quantidade_necessaria: 1,
                custo_unitario: item.preco_unitario,
                subtotal: mostrarDimensoes ? 0 : item.preco_unitario, // Subtotal será 0 para materiais com dimensões até serem definidas
                largura: mostrarDimensoes ? 0 : null,
                altura: mostrarDimensoes ? 0 : null,
                area_utilizada: mostrarDimensoes ? 0 : null,
                area_total_material: areaTotalMaterial, // Adicionar área total para cálculo proporcional
                is_measurement: item.is_measurement || 0, // Garantir que is_measurement seja propagado
                unidades_por_pacote: item.unidades_por_pacote || 0 // Garantir que unidades_por_pacote seja propagado
            };
            editMateriais.push(materialData);
            console.log('Material adicionado ao array editMateriais:', materialData);
        }
        
        materialsList.appendChild(tr);
        
        // Adicionar event listener para remoção com botão direito do mouse
        tr.addEventListener('contextmenu', function(e) {
            showContextMenu(e, this);
        });
        
        // Adicionar event listener para mostrar tooltip temporário
        tr.addEventListener('mouseenter', function(e) {
            showCursorTooltip(e);
        });
        
        tr.addEventListener('mouseleave', function(e) {
            hideCursorTooltip();
        });
        
        // Aplicar estilo inicial válido nos campos de dimensões
        if (mostrarDimensoes) {
            const larguraInput = tr.querySelector('[data-dimension="largura"]');
            const alturaInput = tr.querySelector('[data-dimension="altura"]');
            
            if (larguraInput) {
                larguraInput.classList.add('dimension-input-valid');
            }
            if (alturaInput) {
                alturaInput.classList.add('dimension-input-valid');
            }
        }
        
        // Adicionar event listener para garantir que quantidade seja sempre 1 para materiais com dimensões
        if (mostrarDimensoes) {
            const quantidadeInput = tr.querySelector('[data-tipo="quantidade"]');
            if (quantidadeInput) {
                quantidadeInput.addEventListener('input', function() {
                    if (this.value !== '1') {
                        this.value = '1';
                    }
                });
                quantidadeInput.addEventListener('change', function() {
                    if (this.value !== '1') {
                        this.value = '1';
                    }
                });
            }
            
            // Inicializar o preço por m² para materiais com dimensões
            const precoDisplay = tr.querySelector('.preco-unitario-display');
            const areaDisplay = tr.querySelector('.area-display');
            const precoUnitario = parseFloat(item.preco_unitario || 0);
            
            console.log('Inicializando material com dimensões:', {
                nome: item.nome,
                precoUnitario: precoUnitario,
                areaTotalMaterial: areaTotalMaterial,
                mostrarDimensoes: mostrarDimensoes
            });
            
            // Usar a área total calculada ou assumir que o preço é por m²
            if (areaTotalMaterial > 1) {
                // Temos dimensões reais, calcular preço por m²
                const precoPorM2 = precoUnitario / areaTotalMaterial;
                console.log('Calculando preço por m² com área real:', {
                    precoPorM2: precoPorM2,
                    calculo: `${precoUnitario} / ${areaTotalMaterial} = ${precoPorM2}`
                });
                if (precoDisplay) {
                    precoDisplay.textContent = `${formatarMoedaBrasileira(precoPorM2)}/m²`;
                }
            } else {
                // Assumir que o preço já é por m²
                console.log('Assumindo preço já em R$/m²:', precoUnitario);
                if (precoDisplay) {
                    precoDisplay.textContent = `${formatarMoedaBrasileira(precoUnitario)}/m²`;
                }
            }
        }
        console.log('TR adicionado ao materiaisList');
        
        // Para materiais sem dimensões, calcular subtotal inicial
        if (!mostrarDimensoes) {
            const subtotalDisplay = tr.querySelector('.subtotal-display');
            const precoUnitario = parseFloat(item.preco_unitario || 0);
            const quantidade = 1; // Quantidade inicial padrão
            
            // Aplicar mesma lógica do backend: priorizar quantidade >= 1
            let subtotal;
            if (quantidade >= 1.0) {
                subtotal = quantidade * precoUnitario;
            } else if (item.area && parseFloat(item.area) > 0) {
                subtotal = parseFloat(item.area) * precoUnitario;
            } else {
                subtotal = quantidade * precoUnitario;
            }
            
            if (subtotalDisplay) {
                subtotalDisplay.textContent = formatarMoedaBrasileira(subtotal);
            }
            
            console.log('Subtotal inicial calculado para material sem dimensões:', {
                nome: item.nome,
                precoUnitario: precoUnitario,
                quantidade: quantidade,
                area: item.area,
                subtotal: subtotal,
                logica: quantidade >= 1.0 ? 'quantidade' : 'area'
            });
        }
        
        // Atualizar custo total do modal correto
        if (custoTotalElementId === 'editCustoTotal') {
            atualizarCustoTotalEdit();
        } else {
            atualizarCustoTotal();
        }
        console.log('Custo total atualizado');
        
        // Atualizar tempo estimado se houver uma máquina selecionada no modal de etapas
        setTimeout(() => {
            if (document.getElementById('etapaModal').style.display === 'block') {
                atualizarTempoEstimadoMaquina();
            }
        }, 100);
    }

    /**
     * Calcula o custo de um material aplicando lógica inteligente baseada nas características do material
     * 
     * Regras de negócio:
     * 1. Materiais vendidos por pacote (unidades_por_pacote > 1): usar quantidade em pacotes
     * 2. Materiais unitários (quantidade >= 1): usar quantidade
     * 3. Materiais com dimensões e unidade dimensional (is_measurement=1): usar área
     * 4. Fallback: usar quantidade se área não disponível
     */
    function calcularCustoMaterialInteligente(nomeMaterial, custoUnitario, quantidadeNecessaria, areaUtilizada, unidadesPorPacote, isMeasurement, temDimensoes, areaTotalMaterial) {
        // Debug: mostrar todos os parâmetros
        console.log(`[DEBUG] Parâmetros para ${nomeMaterial}:`, {
            custoUnitario, quantidadeNecessaria, areaUtilizada, unidadesPorPacote, 
            isMeasurement, temDimensoes, areaTotalMaterial
        });
        
        // Regra 1: Materiais vendidos por pacote
        if (unidadesPorPacote && unidadesPorPacote > 1) {
            // Para materiais vendidos por pacote, a quantidade representa o número de pacotes
            const custoMaterial = custoUnitario * quantidadeNecessaria;
            console.log(`[DEBUG] Material ${nomeMaterial}: PACOTE COMPLETO - ${quantidadeNecessaria} pacotes × R$${custoUnitario.toFixed(2)}/pacote = R$${custoMaterial.toFixed(2)}`);
            return custoMaterial;
        }
        
        // Regra 2: Materiais dimensionais - calcular preço por m²
        if (temDimensoes && isMeasurement && areaTotalMaterial > 0) {
            console.log(`[DEBUG] Material ${nomeMaterial}: Entrou na regra dimensional`);
            
            // Se área utilizada é 0, retornar custo 0 (material dimensional sem dimensões definidas)
            if (areaUtilizada === 0) {
                console.log(`[DEBUG] Material ${nomeMaterial}: DIMENSIONAL SEM ÁREA - área utilizada é 0, retornando custo R$0.00`);
                return 0;
            }
            
            // Para materiais dimensionais, custoUnitario é o preço da chapa inteira
            // Calcular preço por m² dividindo pelo área total
            const precoPorM2 = custoUnitario / areaTotalMaterial;
            console.log(`[DEBUG] Preço por m²: R$${custoUnitario.toFixed(2)} / ${areaTotalMaterial.toFixed(4)} m² = R$${precoPorM2.toFixed(2)}/m²`);
            
            const areaEsperadaParaQuantidade = areaTotalMaterial * quantidadeNecessaria;
            const tolerancia = 0.01; // 1% de tolerância
            
            console.log(`[DEBUG] Comparação: areaUtilizada=${areaUtilizada}, areaEsperada=${areaEsperadaParaQuantidade}, tolerancia=${tolerancia}`);
            
            if (Math.abs(areaUtilizada - areaEsperadaParaQuantidade) / areaEsperadaParaQuantidade <= tolerancia) {
                // Usar quantidade quando a área utilizada é próxima à área esperada (chapas inteiras)
                const custoMaterial = custoUnitario * quantidadeNecessaria;
                console.log(`[DEBUG] Material ${nomeMaterial}: QUANTIDADE (área completa) - ${quantidadeNecessaria.toFixed(3)} unidades × R$${custoUnitario.toFixed(2)} = R$${custoMaterial.toFixed(2)}`);
                return custoMaterial;
            } else {
                // Usar cálculo proporcional por área (preço por m² × área utilizada)
                const custoMaterial = precoPorM2 * areaUtilizada;
                console.log(`[DEBUG] Material ${nomeMaterial}: ÁREA PROPORCIONAL - ${areaUtilizada.toFixed(4)} m² × R$${precoPorM2.toFixed(2)}/m² = R$${custoMaterial.toFixed(2)}`);
                return custoMaterial;
            }
        }
        
        console.log(`[DEBUG] Material ${nomeMaterial}: Não entrou na regra dimensional - temDimensoes=${temDimensoes}, isMeasurement=${isMeasurement}, areaUtilizada=${areaUtilizada}, areaTotalMaterial=${areaTotalMaterial}`);
        
        // Regra 3: Materiais unitários (quantidade >= 1)
        if (quantidadeNecessaria >= 1.0) {
            const custoMaterial = custoUnitario * quantidadeNecessaria;
            console.log(`[DEBUG] Material ${nomeMaterial}: QUANTIDADE - ${quantidadeNecessaria.toFixed(3)} unidades × R$${custoUnitario.toFixed(2)} = R$${custoMaterial.toFixed(2)}`);
            return custoMaterial;
        }
        
        // Regra 4: Fallback para área quando quantidade < 1
        if (areaUtilizada > 0) {
            const custoMaterial = custoUnitario * areaUtilizada;
            console.log(`[DEBUG] Material ${nomeMaterial}: ÁREA FALLBACK - ${areaUtilizada.toFixed(4)} m² × R$${custoUnitario.toFixed(2)} = R$${custoMaterial.toFixed(2)}`);
            return custoMaterial;
        }
        
        // Último fallback: usar quantidade mesmo se < 1
        const custoMaterial = custoUnitario * quantidadeNecessaria;
        console.log(`[DEBUG] Material ${nomeMaterial}: QUANTIDADE FALLBACK - ${quantidadeNecessaria.toFixed(3)} × R$${custoUnitario.toFixed(2)} = R$${custoMaterial.toFixed(2)}`);
        return custoMaterial;
    }

    function calcularSubtotalCompleto(input) {
        const row = input.closest('tr');
        const quantidadeInput = row.querySelector('[data-tipo="quantidade"]');
        const larguraInput = row.querySelector('[data-dimension="largura"]');
        const alturaInput = row.querySelector('[data-dimension="altura"]');
        const areaDisplay = row.querySelector('.area-display');
        const subtotalDisplay = row.querySelector('.subtotal-display');
        const precoDisplay = row.querySelector('.preco-unitario-display');
        
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const mostrarDimensoes = subtotalDisplay.getAttribute('data-mostrar-dimensoes') === 'true';
        
        let areaM2 = 0;
        
        // Calcular área apenas se o material suporta dimensões
        if (mostrarDimensoes && larguraInput && alturaInput) {
            let largura = parseFloat(larguraInput.value) || 0;
            let altura = parseFloat(alturaInput.value) || 0;
            
            // Obter dimensões máximas do rolo/bobina a partir do data-area-total e dos dados do material
            const areaTotalBobina = parseFloat(areaDisplay.getAttribute('data-area-total')) || 1;
            let larguraMaxima = null;
            let alturaMaxima = null;
            
            // Buscar as dimensões originais do material para validação
            try {
                // Extrair dimensões do título da célula do material (que contém o nome completo)
                const materialCell = row.querySelector('.material-name-cell');
                if (materialCell && materialCell.title) {
                    const tituloCompleto = materialCell.title;
                    // Procurar padrão como "127x5000cm"
                    const dimensoesMatch = tituloCompleto.match(/(\d+(?:\.\d+)?)x(\d+(?:\.\d+)?)cm/);
                    if (dimensoesMatch) {
                        larguraMaxima = parseFloat(dimensoesMatch[1]);
                        alturaMaxima = parseFloat(dimensoesMatch[2]);
                    }
                }
            } catch (error) {
                console.error('Erro ao extrair dimensões máximas:', error);
            }
            
            // Validar e aplicar estilo visual para dimensões que excedem o máximo
            if (larguraMaxima !== null && largura > larguraMaxima) {
                larguraInput.classList.add('dimension-input-error');
                larguraInput.classList.remove('dimension-input-valid');
                larguraInput.title = `Largura excede o máximo disponível (${larguraMaxima}cm)`;
            } else {
                larguraInput.classList.add('dimension-input-valid');
                larguraInput.classList.remove('dimension-input-error');
                larguraInput.title = 'Largura em centímetros';
            }
            
            if (alturaMaxima !== null && altura > alturaMaxima) {
                alturaInput.classList.add('dimension-input-error');
                alturaInput.classList.remove('dimension-input-valid');
                alturaInput.title = `Altura excede o máximo disponível (${alturaMaxima}cm)`;
            } else {
                alturaInput.classList.add('dimension-input-valid');
                alturaInput.classList.remove('dimension-input-error');
                alturaInput.title = 'Altura em centímetros';
            }
            
            // Calcular área
            const areaCm2 = largura * altura;
            areaM2 = areaCm2 / 10000;
            
            // Atualizar display da área com formatação apropriada
            if (areaDisplay) {
                // Atualizar o atributo data-area-utilizada com a área calculada
                areaDisplay.setAttribute('data-area-utilizada', areaM2.toString());
                
                if (areaM2 < 0.01 && areaM2 > 0) {
                    // Para áreas muito pequenas, mostrar em cm²
                    const areaCm2Format = (areaM2 * 10000).toFixed(1).replace('.', ',');
                    areaDisplay.textContent = areaCm2Format + " cm²";
                } else if (areaM2 >= 0.01) {
                    // Para áreas maiores, mostrar em m² com formato brasileiro
                    const areaM2Format = areaM2.toFixed(2).replace('.', ',');
                    areaDisplay.textContent = areaM2Format + " m²";
                } else {
                    areaDisplay.textContent = "0,00 m²";
                }
            }
        }
        
        // Obter informações do material para lógica inteligente
        const precoUnitario = parseFloat(subtotalDisplay.getAttribute('data-preco')) || 0;
        const unidadesPorPacote = parseFloat(subtotalDisplay.getAttribute('data-unidades-pacote')) || 0;
        const isMeasurement = subtotalDisplay.getAttribute('data-is-measurement') === 'true';
        const temDimensoes = mostrarDimensoes;
        const nomeMaterial = row.querySelector('.material-name-cell')?.textContent || 'Material';
        const areaTotalMaterial = parseFloat(areaDisplay?.getAttribute('data-area-total')) || 0;
        
        // Aplicar lógica inteligente de cálculo
        const subtotal = calcularCustoMaterialInteligente(
            nomeMaterial, precoUnitario, quantidade, areaM2, 
            unidadesPorPacote, isMeasurement, temDimensoes, areaTotalMaterial
        );
        
        subtotalDisplay.textContent = formatarMoedaBrasileira(subtotal);
        
        atualizarCustoTotal();
        
        // Atualizar tempo estimado se houver uma máquina selecionada no modal de etapas
        setTimeout(() => {
            if (document.getElementById('etapaModal').style.display === 'block') {
                atualizarTempoEstimadoMaquina();
            }
        }, 100);
    }

    function calcularSubtotalCompletoEdit(input) {
        // Verificar se está em processo de carregamento inicial
        if (window.isLoadingEditModal) {
            console.log('🔄 [SKIP] calcularSubtotalCompletoEdit: Ignorando chamada durante carregamento inicial');
            return;
        }
        
        // Adicionar delay adicional para evitar chamadas prematuras
        if (!window.editModalReady) {
            console.log('🔄 [SKIP] calcularSubtotalCompletoEdit: Modal ainda não está pronto');
            return;
        }
        
        const row = input.closest('tr');
        const quantidadeInput = row.querySelector('[data-tipo="quantidade"]');
        const larguraInput = row.querySelector('[data-dimension="largura"]');
        const alturaInput = row.querySelector('[data-dimension="altura"]');
        const areaDisplay = row.querySelector('.area-display');
        const subtotalDisplay = row.querySelector('.subtotal-display');
        const precoDisplay = row.querySelector('.preco-unitario-display');
        
        // Encontrar o material pelo instance_id ao invés do material_id
        const instanceId = row.getAttribute('data-instance-id');
        const materialId = row.getAttribute('data-material-id');
        
        if (!instanceId && !materialId) {
            console.error('IDs do material não encontrados na linha');
            return;
        }
        
        // Encontrar o material no array editMateriais usando instance_id primeiro, depois material_id como fallback
        let materialIndex = -1;
        if (instanceId) {
            materialIndex = editMateriais.findIndex(m => m.instance_id === instanceId);
        }
        if (materialIndex === -1 && materialId) {
            // Fallback para materiais antigos sem instance_id
            materialIndex = editMateriais.findIndex(m => m.material_id.toString() === materialId.toString());
        }
        
        console.log('🔄 [MANUAL] calcularSubtotalCompletoEdit: instance_id:', instanceId, 'material_id:', materialId, 'materialIndex:', materialIndex);
        
        const material = editMateriais[materialIndex];
        
        if (!material) {
            console.error('Material não encontrado no array editMateriais');
            console.error('Valores buscados - instance_id:', instanceId, 'material_id:', materialId);
            console.error('Array editMateriais:', editMateriais);
            return;
        }
        
        const quantidade = parseFloat(quantidadeInput.value) || 0;
        const mostrarDimensoes = !!(larguraInput && alturaInput); // Detectar pela presença dos campos de dimensão (garantir boolean)
        
        console.log('🔄 [MANUAL] Material encontrado:', material.material_nome, 'Quantidade:', quantidade);
        
        // Sempre atualizar a quantidade no array, independentemente de ter dimensões
        material.quantidade_necessaria = quantidade;
        
        let areaM2 = 0;
        
        // Calcular área apenas se o material suporta dimensões
        if (mostrarDimensoes && larguraInput && alturaInput) {
            let largura = parseFloat(larguraInput.value) || 0;
            let altura = parseFloat(alturaInput.value) || 0;
            
            // Atualizar valores no array editMateriais
            material.largura = largura;
            material.altura = altura;
            
            // Calcular área
            const areaCm2 = largura * altura;
            areaM2 = areaCm2 / 10000;
            material.area_utilizada = areaM2;
            
            // Atualizar display da área
            if (areaDisplay) {
                if (areaM2 < 0.01 && areaM2 > 0) {
                    const areaCm2Format = (areaM2 * 10000).toFixed(1).replace('.', ',');
                    areaDisplay.textContent = areaCm2Format + " cm²";
                } else if (areaM2 >= 0.01) {
                    // Formatar com até 4 casas decimais, removendo zeros desnecessários
                    let areaFormatada = areaM2.toFixed(4).replace(/\.?0+$/, '');
                    areaFormatada = areaFormatada.replace('.', ',');
                    areaDisplay.textContent = areaFormatada + " m²";
                } else {
                    areaDisplay.textContent = "0,00 m²";
                }
            }
        }
        
        // Obter informações do material para lógica inteligente
        const precoUnitario = parseFloat(material.custo_unitario) || 0;
        const unidadesPorPacote = parseFloat(material.unidades_por_pacote) || 0;
        const isMeasurement = material.is_measurement === 1 || material.is_measurement === true;
        const temDimensoes = mostrarDimensoes;
        const nomeMaterial = material.material_nome || 'Material';
        const areaTotalMaterial = parseFloat(material.area_total_material) || 0;
        
        // Aplicar lógica inteligente de cálculo
        const quantidadeNecessaria = parseFloat(material.quantidade_necessaria) || 0;
        const areaUtilizada = parseFloat(material.area_utilizada) || 0;
        
        console.log('🔄 [MANUAL] Antes do cálculo - quantidade:', quantidadeNecessaria, 'area:', areaUtilizada, 'precoUnitario:', precoUnitario);
        
        const subtotal = calcularCustoMaterialInteligente(
            nomeMaterial, precoUnitario, quantidadeNecessaria, areaUtilizada,
            unidadesPorPacote, isMeasurement, temDimensoes, areaTotalMaterial
        );
        
        console.log('🔄 [MANUAL] Subtotal calculado:', subtotal, 'Material:', nomeMaterial);
        
        // Atualizar subtotal no array e no display
        material.subtotal = subtotal;
        subtotalDisplay.textContent = subtotal.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        });
        
        console.log('🔄 [MANUAL] Material atualizado no array editMateriais:', material);
        
        // Atualizar custo total do modal de edição
        console.log('🔄 [MANUAL] Chamando atualizarCustoTotalEdit() após atualização individual de material');
        atualizarCustoTotalEdit();
    }

    function atualizarCustoTotal() {
        const rows = document.querySelectorAll('#materiaisList tr');
        let total = 0;
        
        rows.forEach(row => {
            const subtotalDisplay = row.querySelector('.subtotal-display');
            if (subtotalDisplay) {
                const subtotalText = subtotalDisplay.textContent;
                // Remover R$, pontos de milhar e substituir vírgula por ponto
                const valor = subtotalText.replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.');
                const subtotal = parseFloat(valor);
                if (!isNaN(subtotal)) {
                    total += subtotal;
                }
            }
        });
        
        document.getElementById('custoTotal').textContent = formatarMoedaBrasileira(total);
        
        // Recalcular preço final com margem
        calcularPrecoComMargem();
    }

    function atualizarCustoTotalEdit() {
        console.log('🔄 [DEBUG] atualizarCustoTotalEdit() chamada');
        console.log('🔄 [DEBUG] Estado atual do editMateriais:', editMateriais);
        
        // Calcular total diretamente do array editMateriais ao invés de parsear DOM
        let total = 0;
        
        if (editMateriais && editMateriais.length > 0) {
            console.log('Calculando custo total de', editMateriais.length, 'materiais:');
            editMateriais.forEach((material, index) => {
                const subtotal = parseFloat(material.subtotal) || 0;
                console.log(`Material ${index + 1}: ${material.material_nome} - subtotal: R$ ${subtotal.toFixed(2)}`);
                total += subtotal;
            });
        }
        
        console.log('💰 [DEBUG] Custo total final calculado:', total);
        
        document.getElementById('editCustoTotal').textContent = formatarMoedaBrasileira(total);
        
        // SEMPRE recalcular preço após atualizar custo total
        console.log('🔄 [DEBUG] Chamando calcularPrecoComMargemEdit() após atualização de custos');
        calcularPrecoComMargemEdit();
    }

    function removerMaterialDaTabela(button) {
        const row = button.closest('tr');
        const materialId = row.getAttribute('data-material-id');
        const instanceId = row.getAttribute('data-instance-id');
        
        // Verificar qual modal está ativo
        if (document.getElementById('editProdutoModal').style.display === 'block') {
            // Modal de edição está ativo - remover do array editMateriais usando instance_id
            if (instanceId) {
                const materialIndex = editMateriais.findIndex(m => m.instance_id === instanceId);
                if (materialIndex !== -1) {
                    editMateriais.splice(materialIndex, 1);
                    console.log('Material removido do array editMateriais:', instanceId);
                }
            } else if (materialId) {
                // Fallback para materiais antigos sem instance_id (remove o primeiro encontrado)
                const materialIndex = editMateriais.findIndex(m => m.material_id.toString() === materialId.toString());
                if (materialIndex !== -1) {
                    editMateriais.splice(materialIndex, 1);
                    console.log('Material removido do array editMateriais (fallback):', materialId);
                }
            }
            // Remover linha da tabela
            row.remove();
            // Atualizar custo total do modal de edição
            atualizarCustoTotalEdit();
        } else {
            // Modal de novo produto está ativo - usar comportamento padrão
            row.remove();
            atualizarCustoTotal();
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('materiaisDropdown');
        const searchInput = document.querySelector('#materialSelect input');
        
        if (dropdown && !event.target.closest('#materialSelect')) {
            dropdown.style.display = 'none';
        }
    });

    // Função para verificar se o tipo de material suporta dimensões
    function tipoSuportaDimensoes(tipoMaterial) {
        if (!tipoMaterial) return false;
        
        const tipo = tipoMaterial.toLowerCase();
        return tipo.includes('rolo') || 
               tipo.includes('bobina') || 
               tipo.includes('chapa') || 
               tipo.includes('placa');
    }

    // Função para formatar valores em moeda brasileira
    function formatarMoedaBrasileira(valor) {
        const numero = parseFloat(valor);
        if (isNaN(numero)) return 'R$ 0,00';
        
        return numero.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Função para calcular a área total dos materiais
    function calcularAreaTotalMateriais() {
        let areaTotal = 0;
        
        // Detectar se estamos no modal de edição ou novo produto
        const modalEditarProduto = document.getElementById('editProdutoModal');
        const isEditMode = modalEditarProduto && modalEditarProduto.style.display === 'block';
        
        if (isEditMode) {
            // Usar o array editMateriais para o modal de edição
            const materiaisParaUsar = editMateriais || [];
            
            materiaisParaUsar.forEach(material => {
                if (material.largura && material.altura && material.quantidade_necessaria) {
                    // Material com dimensões
                    const quantidade = parseFloat(material.quantidade_necessaria) || 0;
                    const larguraCm = parseFloat(material.largura) || 0;
                    const alturaCm = parseFloat(material.altura) || 0;
                    
                    if (quantidade > 0 && larguraCm > 0 && alturaCm > 0) {
                        // Converter de cm² para m²
                        const areaM2 = (larguraCm * alturaCm) / 10000;
                        areaTotal += quantidade * areaM2;
                    }
                } else if (material.area_utilizada) {
                    // Material já tem área calculada
                    areaTotal += parseFloat(material.area_utilizada) || 0;
                } else if (material.quantidade_necessaria) {
                    // Material sem dimensões (assumir que já está em m² ou usar valor padrão)
                    const quantidade = parseFloat(material.quantidade_necessaria) || 0;
                    // Para materiais sem dimensões, assumir 1m² por unidade (pode ser ajustado)
                    areaTotal += quantidade * 1;
                }
            });
        } else {
            // Usar a tabela DOM para o modal de novo produto
            const materiaisList = document.getElementById('materiaisList');
            if (!materiaisList) {
                return 0;
            }
            
            const materialRows = materiaisList.querySelectorAll('tr');
            
            materialRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    // Verificar se há inputs de dimensões na linha
                    const larguraInput = row.querySelector('[data-dimension="largura"]');
                    const alturaInput = row.querySelector('[data-dimension="altura"]');
                    const quantidadeInput = row.querySelector('[data-tipo="quantidade"]');
                    
                    if (larguraInput && alturaInput && quantidadeInput) {
                        // Material com dimensões
                        const quantidade = parseFloat(quantidadeInput.value) || 0;
                        const larguraCm = parseFloat(larguraInput.value) || 0;
                        const alturaCm = parseFloat(alturaInput.value) || 0;
                        
                        if (quantidade > 0 && larguraCm > 0 && alturaCm > 0) {
                            // Converter de cm² para m²
                            const areaM2 = (larguraCm * alturaCm) / 10000;
                            areaTotal += quantidade * areaM2;
                        }
                    } else if (quantidadeInput) {
                        // Material sem dimensões (assumir que já está em m² ou usar valor padrão)
                        const quantidade = parseFloat(quantidadeInput.value) || 0;
                        // Para materiais sem dimensões, assumir 1m² por unidade (pode ser ajustado)
                        areaTotal += quantidade * 1;
                    }
                }
            });
        }
        
        return areaTotal;
    }

    // Função para calcular o tempo estimado baseado na máquina e área total
    function calcularTempoEstimadoMaquina(maquina, areaTotalM2) {
        if (!maquina || !maquina.metros_quadrados_por_hora || areaTotalM2 <= 0) {
            return '00:00:00';
        }
        
        const metrosQuadradosPorHora = parseFloat(maquina.metros_quadrados_por_hora);
        if (metrosQuadradosPorHora <= 0) return '00:00:00';
        
        // Calcular horas necessárias
        const horasNecessarias = areaTotalM2 / metrosQuadradosPorHora;
        
        // Converter para horas, minutos e segundos
        const horas = Math.floor(horasNecessarias);
        const minutos = Math.floor((horasNecessarias - horas) * 60);
        const segundos = Math.floor(((horasNecessarias - horas) * 60 - minutos) * 60);
        
        // Formatar como HH:MM:SS
        return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    }

    // Função para atualizar o tempo estimado quando uma máquina é selecionada
    // Função para calcular a área do material selecionado na etapa
    function calcularAreaMaterialEtapa() {
        const materialButton = document.querySelector('#etapaMaterial button');
        const selectedValue = materialButton ? materialButton.getAttribute('data-selected') : null;
        
        if (!selectedValue) {
            return 0;
        }
        
        // Detectar se estamos no modal de edição ou novo produto
        const modalEditarProduto = document.getElementById('editProdutoModal');
        const isEditMode = modalEditarProduto && modalEditarProduto.style.display === 'block';
        
        let areaCalculada = 0;
        
        if (isEditMode) {
            // Modo edição - usar array editMateriais
            if (selectedValue.startsWith('instance_')) {
                // Novo formato: instance_X onde X é o índice no array
                const instanceIndex = parseInt(selectedValue.replace('instance_', ''));
                const material = editMateriais[instanceIndex];
                
                if (material) {
                    // Priorizar area_utilizada se disponível e válida
                    if (material.area_utilizada && parseFloat(material.area_utilizada) > 0) {
                        const areaUtilizada = parseFloat(material.area_utilizada);
                        const quantidade = parseFloat(material.quantidade_necessaria) || 1;
                        areaCalculada = areaUtilizada * quantidade;
                    }
                    // Se não tem area_utilizada, verificar se tem dimensões válidas
                    else if (material.largura && material.altura && 
                        parseFloat(material.largura) > 0 && parseFloat(material.altura) > 0) {
                        const quantidade = parseFloat(material.quantidade_necessaria) || 1;
                        const larguraCm = parseFloat(material.largura);
                        const alturaCm = parseFloat(material.altura);
                        
                        // Converter de cm² para m²
                        const areaM2 = (larguraCm * alturaCm) / 10000;
                        areaCalculada = quantidade * areaM2;
                    }
                    // Para materiais sem dimensões e sem area_utilizada
                    else if (material.quantidade_necessaria) {
                        const quantidade = parseFloat(material.quantidade_necessaria) || 1;
                        areaCalculada = quantidade * 1; // Assumir 1m² por unidade
                    }
                }
            } else {
                // Formato antigo (fallback) - buscar por material_id
                const materialId = selectedValue;
                const materiaisEncontrados = editMateriais.filter(m => 
                    parseInt(m.material_id) === parseInt(materialId) || 
                    parseInt(m.id) === parseInt(materialId)
                );
                
                // Usar apenas o primeiro material encontrado (compatibilidade)
                if (materiaisEncontrados.length > 0) {
                    const material = materiaisEncontrados[0];
                    if (material.largura && material.altura && material.quantidade_necessaria) {
                        const quantidade = parseFloat(material.quantidade_necessaria) || 0;
                        const larguraCm = parseFloat(material.largura) || 0;
                        const alturaCm = parseFloat(material.altura) || 0;
                        
                        if (quantidade > 0 && larguraCm > 0 && alturaCm > 0) {
                            const areaM2 = (larguraCm * alturaCm) / 10000;
                            areaCalculada = quantidade * areaM2;
                        }
                    }
                }
            }
        } else {
            // Modo novo produto - usar tabela DOM
            if (selectedValue.startsWith('row_')) {
                // Novo formato: row_X onde X é o índice da linha
                const rowIndex = parseInt(selectedValue.replace('row_', ''));
                const materiaisList = document.getElementById('materiaisList');
                
                if (materiaisList) {
                    const materialRows = materiaisList.querySelectorAll('tr');
                    const targetRow = materialRows[rowIndex];
                    
                    if (targetRow) {
                        // Extrair dados da linha específica
                        const larguraInput = targetRow.querySelector('[data-dimension="largura"]');
                        const alturaInput = targetRow.querySelector('[data-dimension="altura"]');
                        const quantidadeInput = targetRow.querySelector('[data-tipo="quantidade"]');
                        const areaUtilizadaElement = targetRow.querySelector('[data-area-utilizada]');
                        
                        // Priorizar area_utilizada se disponível
                        if (areaUtilizadaElement) {
                            const areaUtilizada = parseFloat(areaUtilizadaElement.getAttribute('data-area-utilizada'));
                            const quantidade = parseFloat(quantidadeInput.value) || 1;
                            
                            if (areaUtilizada > 0) {
                                areaCalculada = quantidade * areaUtilizada;
                            } else if (quantidadeInput) {
                                // Fallback para quantidade
                                areaCalculada = quantidade * 1;
                            }
                        }
                        // Se não tem area_utilizada, verificar se tem dimensões
                        else if (larguraInput && alturaInput && quantidadeInput) {
                            const quantidade = parseFloat(quantidadeInput.value) || 1;
                            const larguraCm = parseFloat(larguraInput.value) || 0;
                            const alturaCm = parseFloat(alturaInput.value) || 0;
                            
                            if (quantidade > 0 && larguraCm > 0 && alturaCm > 0) {
                                // Converter de cm² para m²
                                const areaM2 = (larguraCm * alturaCm) / 10000;
                                areaCalculada = quantidade * areaM2;
                            }
                        } 
                        // Para materiais sem dimensões e sem area_utilizada
                        else if (quantidadeInput) {
                            const quantidade = parseFloat(quantidadeInput.value) || 1;
                            areaCalculada = quantidade * 1; // Assumir 1m² por unidade
                        }
                    }
                }
            } else {
                // Formato antigo (fallback) - buscar por material_id
                const materialId = selectedValue;
                const materiaisList = document.getElementById('materiaisList');
                
                if (materiaisList) {
                    const materialRows = materiaisList.querySelectorAll(`tr[data-material-id="${materialId}"]`);
                    
                    // Usar apenas a primeira linha encontrada (compatibilidade)
                    if (materialRows.length > 0) {
                        const targetRow = materialRows[0];
                        const larguraInput = targetRow.querySelector('[data-dimension="largura"]');
                        const alturaInput = targetRow.querySelector('[data-dimension="altura"]');
                        const quantidadeInput = targetRow.querySelector('[data-tipo="quantidade"]');
                        
                        if (larguraInput && alturaInput && quantidadeInput) {
                            const quantidade = parseFloat(quantidadeInput.value) || 0;
                            const larguraCm = parseFloat(larguraInput.value) || 0;
                            const alturaCm = parseFloat(alturaInput.value) || 0;
                            
                            if (quantidade > 0 && larguraCm > 0 && alturaCm > 0) {
                                const areaM2 = (larguraCm * alturaCm) / 10000;
                                areaCalculada = quantidade * areaM2;
                            }
                        }
                    }
                }
            }
        }
        
        return areaCalculada;
    }

    function atualizarTempoEstimadoMaquina() {
        const equipamentoButton = document.querySelector('#etapaEquipamento button');
        const tempoEstimadoInput = document.getElementById('etapaTempo');
        
        if (!equipamentoButton || !tempoEstimadoInput) {
            return;
        }
        
        const equipamentoId = equipamentoButton.getAttribute('data-selected');
        
        if (!equipamentoId) {
            return;
        }
        
        // Verificar se é uma máquina (não ferramenta)
        if (!equipamentoId.startsWith('maquina_')) {
            return;
        }
        
        // Extrair ID da máquina
        const maquinaId = parseInt(equipamentoId.replace('maquina_', ''));
        
        // Buscar dados da máquina selecionada
        const maquinaSelecionada = maquinasData.find(m => m.id === maquinaId);
        
        if (!maquinaSelecionada || !maquinaSelecionada.metros_quadrados_por_hora) {
            return;
        }
        
        // Calcular área do material selecionado na etapa (não todos os materiais)
        const areaMaterialM2 = calcularAreaMaterialEtapa();
        
        // Só calcular se houver área para processar
        if (areaMaterialM2 <= 0) {
            tempoEstimadoInput.value = '00:00:00';
            return;
        }
        
        // Calcular tempo estimado
        const tempoEstimado = calcularTempoEstimadoMaquina(maquinaSelecionada, areaMaterialM2);
        
        // Preencher o campo de tempo estimado
        tempoEstimadoInput.value = tempoEstimado;
        
        // Feedback visual para indicar que o tempo foi calculado automaticamente
        tempoEstimadoInput.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
        tempoEstimadoInput.style.borderColor = '#9B64E3';
        setTimeout(() => {
            tempoEstimadoInput.style.backgroundColor = '';
            tempoEstimadoInput.style.borderColor = '';
        }, 1500);
        
        // Recalcular custo automaticamente com o novo tempo
        calcularCustoEstimado();
    }

    // ========================
    // FUNÇÕES DE ETAPAS
    // ========================

    let etapas = [];
    let editEtapas = []; // Array para etapas do modal de edição
    let editMateriais = []; // Array para materiais do modal de edição
    let etapaEditandoIndex = -1;
    let maquinasData = [];  // Armazenar dados das máquinas para cálculo de custos
    let ferramentasData = []; // Armazenar dados das ferramentas

    async function openAdicionarEtapaModal() {
        etapaEditandoIndex = -1;
        document.getElementById('etapaModalTitle').textContent = 'Adicionar Etapa';
        document.getElementById('etapaForm').reset();
        
        // Resetar dropdowns customizados
        const tipoButton = document.querySelector('#etapaTipo button');
        tipoButton.textContent = 'Selecionar tipo...';
        tipoButton.setAttribute('data-selected', '');
        
        const equipamentoButton = document.querySelector('#etapaEquipamento button');
        equipamentoButton.textContent = 'Selecionar equipamento...';
        equipamentoButton.setAttribute('data-selected', '');
        
        const materialButton = document.querySelector('#etapaMaterial button');
        materialButton.textContent = 'Selecionar material...';
        materialButton.setAttribute('data-selected', '');
        
        // Carregar equipamentos e materiais disponíveis
        await carregarEquipamentos();
        await carregarMateriaisParaEtapa();
        
        document.getElementById('etapaModal').style.display = 'block';
        
        // Configurar dropdowns após carregar dados E após modal estar visível
        setTimeout(() => {
            console.log('🔧 [MODAL] Configurando dropdowns de etapa...');
            configurarDropdownsEtapa();
            
            // Debug: verificar se os IDs estão corretos
            const equipamentoDropdown = document.getElementById('etapaEquipamento');
            const materialDropdown = document.getElementById('etapaMaterial');
            console.log('🔍 [DEBUG] Dropdown equipamento encontrado:', !!equipamentoDropdown, equipamentoDropdown?.id);
            console.log('🔍 [DEBUG] Dropdown material encontrado:', !!materialDropdown, materialDropdown?.id);
        }, 200);
    }

    function openEditarEtapaModal(index) {
        etapaEditandoIndex = index;
        
        // Detectar qual modal está ativo para usar o array correto
        const modalEditarProduto = document.getElementById('editProdutoModal');
        const isEditMode = modalEditarProduto && modalEditarProduto.style.display === 'block';
        
        const etapa = isEditMode ? editEtapas[index] : etapas[index];
        
        document.getElementById('etapaModalTitle').textContent = 'Editar Etapa';
        document.getElementById('etapaNome').value = etapa.nome;
        
        // Configurar dropdown de tipo
        const tipoButton = document.querySelector('#etapaTipo button');
        tipoButton.textContent = etapa.tipo;
        tipoButton.setAttribute('data-selected', etapa.tipo);
        
        // Configurar dropdown de equipamento (será configurado após carregar)
        // Normalizar formato do tempo para HH:MM:SS
        let tempoNormalizado = etapa.tempo_estimado || '00:00:00';
        if (tempoNormalizado && !tempoNormalizado.match(/^\d{2}:\d{2}:\d{2}$/)) {
            // Se o formato não está correto (ex: "0:00:08"), normalizar para "00:00:08"
            const partesTempo = tempoNormalizado.split(':');
            if (partesTempo.length === 3) {
                const horas = partesTempo[0].padStart(2, '0');
                const minutos = partesTempo[1].padStart(2, '0');
                const segundos = partesTempo[2].padStart(2, '0');
                tempoNormalizado = `${horas}:${minutos}:${segundos}`;
            }
        }
        document.getElementById('etapaTempo').value = tempoNormalizado;
        
        // Formatação correta do custo - converter para centavos para compatibilidade com formatarCustoEtapa
        let custoEmCentavos = '';
        if (etapa.custo_estimado !== undefined && etapa.custo_estimado !== null) {
            let custoNumerico = 0;
            
            // Se já está formatado como moeda brasileira (R$ 0,02)
            if (typeof etapa.custo_estimado === 'string' && etapa.custo_estimado.includes('R$')) {
                // Remover R$ e converter para número
                let valorString = etapa.custo_estimado.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                custoNumerico = parseFloat(valorString) || 0;
            } else {
                // Se é um número ou string numérica
                custoNumerico = parseFloat(etapa.custo_estimado) || 0;
            }
            
            // Converter para centavos (a função formatarCustoEtapa espera centavos)
            custoEmCentavos = Math.round(custoNumerico * 100).toString();
        } else {
            custoEmCentavos = '0';
        }
        
        // Definir o valor em centavos e formatar
        const custoInput = document.getElementById('etapaCusto');
        custoInput.value = custoEmCentavos;
        formatarCustoEtapa(custoInput);
        
        // Carregar equipamentos disponíveis e configurar seleção
        carregarEquipamentos().then(() => {
            const equipamentoButton = document.querySelector('#etapaEquipamento button');
            equipamentoButton.textContent = etapa.equipamento_nome;
            
            // Formatar o equipamento_id corretamente
            if (etapa.equipamento_id) {
                let equipamentoIdFormatado = '';
                
                // Verificar se o equipamento_id já está no formato correto (com prefixo)
                if (typeof etapa.equipamento_id === 'string' && 
                    (etapa.equipamento_id.startsWith('maquina_') || etapa.equipamento_id.startsWith('ferramenta_'))) {
                    // Já está formatado, usar como está
                    equipamentoIdFormatado = etapa.equipamento_id;
                } else {
                    // É um ID numérico, precisa determinar se é máquina ou ferramenta
                    const equipamentoIdNumerico = parseInt(etapa.equipamento_id);
                    
                    // Primeiro, tentar encontrar nas máquinas
                    const maquina = maquinasData.find(m => m.id === equipamentoIdNumerico);
                    if (maquina) {
                        equipamentoIdFormatado = `maquina_${equipamentoIdNumerico}`;
                    } else {
                        // Se não for máquina, verificar se é ferramenta
                        const ferramenta = ferramentasData.find(f => f.id === equipamentoIdNumerico);
                        if (ferramenta) {
                            equipamentoIdFormatado = `ferramenta_${equipamentoIdNumerico}`;
                        } else {
                            // Fallback: assumir que é máquina (para compatibilidade)
                            equipamentoIdFormatado = `maquina_${equipamentoIdNumerico}`;
                        }
                    }
                }
                
                equipamentoButton.setAttribute('data-selected', equipamentoIdFormatado);
            } else {
                equipamentoButton.setAttribute('data-selected', '');
            }
        });
        
        // Carregar materiais e configurar seleção se houver material na etapa
        carregarMateriaisParaEtapa().then(() => {
            const materialButton = document.querySelector('#etapaMaterial button');
            if (etapa.material_nome) {
                // Se há uma seleção específica de instância preservada, usar ela
                if (etapa.material_instance_selection) {
                    const specificOption = document.querySelector(`#etapaMaterial .dropdown-content div[data-value="${etapa.material_instance_selection}"]`);
                    if (specificOption) {
                        materialButton.textContent = specificOption.textContent.trim();
                        materialButton.setAttribute('data-selected', etapa.material_instance_selection);
                    } else {
                        // Se a seleção específica não existe mais, tentar encontrar uma instância do mesmo material
                        const materialOptions = document.querySelectorAll(`#etapaMaterial .dropdown-content div[data-material-id="${etapa.material_id}"]`);
                        if (materialOptions.length > 0) {
                            const firstOption = materialOptions[0];
                            materialButton.textContent = firstOption.textContent.trim();
                            materialButton.setAttribute('data-selected', firstOption.getAttribute('data-value'));
                        } else {
                            // Fallback para o nome do material
                            materialButton.textContent = etapa.material_nome;
                            materialButton.setAttribute('data-selected', etapa.material_id);
                        }
                    }
                } else {
                    // Modo compatibilidade: tentar encontrar uma instância do material pelo ID
                    const materialOptions = document.querySelectorAll(`#etapaMaterial .dropdown-content div[data-material-id="${etapa.material_id}"]`);
                    if (materialOptions.length > 0) {
                        const firstOption = materialOptions[0];
                        materialButton.textContent = firstOption.textContent.trim();
                        materialButton.setAttribute('data-selected', firstOption.getAttribute('data-value'));
                    } else {
                        // Usar ID do material como fallback
                        materialButton.textContent = etapa.material_nome;
                        materialButton.setAttribute('data-selected', etapa.material_id);
                    }
                }
            } else {
                materialButton.textContent = 'Selecionar material...';
                materialButton.setAttribute('data-selected', '');
            }
        });
        
        document.getElementById('etapaModal').style.display = 'block';
        
        // Configurar dropdowns após abrir modal
        setTimeout(() => {
            configurarDropdownsEtapa();
        }, 100);
    }

    function closeEtapaModal() {
        document.getElementById('etapaModal').style.display = 'none';
        etapaEditandoIndex = -1;
        
        // Resetar campos do formulário
        document.getElementById('etapaForm').reset();
        
        // Resetar dropdowns customizados
        const tipoButton = document.querySelector('#etapaTipo button');
        if (tipoButton) {
            tipoButton.textContent = 'Selecionar tipo...';
            tipoButton.setAttribute('data-selected', '');
        }
        
        const equipamentoButton = document.querySelector('#etapaEquipamento button');
        if (equipamentoButton) {
            equipamentoButton.textContent = 'Selecionar equipamento...';
            equipamentoButton.setAttribute('data-selected', '');
        }
        
        const materialButton = document.querySelector('#etapaMaterial button');
        if (materialButton) {
            materialButton.textContent = 'Selecionar material...';
            materialButton.setAttribute('data-selected', '');
        }
        
        // Limpar custo estimado
        const custoEstimado = document.getElementById('etapaCustoEstimado');
        if (custoEstimado) {
            custoEstimado.value = '0.00';
        }
        
        // Resetar campo de tempo estimado
        const tempoEstimado = document.getElementById('etapaTempo');
        if (tempoEstimado) {
            tempoEstimado.value = '00:00:00';
        }
    }

    async function carregarEquipamentos() {
        try {
            console.log('🔧 Carregando equipamentos...');
            const responseMaquinas = await fetch('/api/maquinas');
            const responseFerramentas = await fetch('/api/ferramentas');
            
            console.log('📡 Resposta máquinas:', responseMaquinas.status, responseMaquinas.ok);
            console.log('📡 Resposta ferramentas:', responseFerramentas.status, responseFerramentas.ok);
            
            const dataMaquinas = responseMaquinas.ok ? await responseMaquinas.json() : null;
            const dataFerramentas = responseFerramentas.ok ? await responseFerramentas.json() : null;
            
            console.log('📊 Dados máquinas:', dataMaquinas);
            console.log('📊 Dados ferramentas:', dataFerramentas);
            
            // Armazenar dados globalmente para cálculos posteriores
            maquinasData = dataMaquinas && dataMaquinas.status === 'success' ? dataMaquinas.machines : [];
            ferramentasData = dataFerramentas && dataFerramentas.status === 'success' ? dataFerramentas.ferramentas : [];
            
            console.log('🔧 Máquinas carregadas:', maquinasData.length);
            console.log('🔨 Ferramentas carregadas:', ferramentasData.length);
            
            const equipamentoDropdown = document.querySelector('#etapaEquipamento .dropdown-content');
            if (!equipamentoDropdown) {
                console.error('❌ Dropdown de equipamento não encontrado!');
                return;
            }
            
            equipamentoDropdown.innerHTML = '';
            
            let totalEquipamentos = 0;
            
            // Adicionar máquinas
            if (maquinasData && maquinasData.length > 0) {
                maquinasData.forEach(maquina => {
                    const div = document.createElement('div');
                    div.setAttribute('data-value', `maquina_${maquina.id}`);
                    div.innerHTML = `
                        <span style="display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden;">
                            <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzODUgMzgzLjE2Ij4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLmNscy0xIHsKICAgICAgICBmaWxsOiAjZjZkMGZmOwogICAgICAgIHN0cm9rZTogIzIyMGQ4NjsKICAgICAgICBzdHJva2UtbWl0ZXJsaW1pdDogMTA7CiAgICAgIH0KCiAgICAgIC5jbHMtMiB7CiAgICAgICAgZmlsbDogIzAzMDM4ODsKICAgICAgfQoKICAgICAgLmNscy0zIHsKICAgICAgICBmaWxsOiAjMDUwNTg5OwogICAgICB9CgogICAgICAuY2xzLTQgewogICAgICAgIGZpbGw6ICMwMjAyODg7CiAgICAgIH0KICAgIDwvc3R5bGU+CiAgPC9kZWZzPgogIDxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI2Ljc1LDIyNS4yMmM0Ljk3LS4yMSwxMC4wMi4wNiwxNSwwLDcuNDktLjA5LDE1LjAxLjA0LDIyLjUsMCw0Ljk5LS4wMiwxMC4wMS4wMSwxNSwwLDM1LjI0LS4xMSw3MC41MS4wMywxMDUuNzUsMCw0Ljk5LDAsMTAuMDEsMCwxNSwwLDM1LjI0LjAzLDcwLjUxLS4xMSwxMDUuNzUsMCw0Ljk5LjAxLDEwLjAxLS4wMiwxNSwwLDcuNDkuMDQsMTUuMDEtLjA5LDIyLjUsMCw0Ljk4LjA2LDEwLjAzLS4yMSwxNSwwLDE0LjAyLjU5LDIyLjAxLDQuNzcsMjYuMjUsMTguNzF2Ny40OWMtMiw4Ljg4LTkuMjYsMTcuNTgtMTguNzUsMTguNzEtNC43Mi41Ny0xMy44My43LTE4Ljc1Ljc1LTEwMS42OCwxLjAzLTIwNC41My4xLTMwNi40Ni0uOC0xLjM2LS4wMS0yLjQuOC0yLjU0LjgtNC45Mi0uMDUtMTQuMDMtLjE4LTE4Ljc1LS43NS05LjM5LTEuMTMtMTYuMTYtOS40NC0xOC43NS0xNy45NnYtOC4yM2M0LjI1LTE0LjA3LDEyLjIxLTE4LjEyLDI2LjI1LTE4LjcxWiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTM4LDI3MC44OGM2LDcuOTcsMTAuOTUsMjEuMiwyMi4xMiwyMi40NmwyNjMuMjguMDNjMTIuNjktLjM3LDE2Ljk4LTE0LjAxLDIzLjU5LTIyLjQ5LDQuOTItLjA1LDE0LjAzLS4xOCwxOC43NS0uNzUtMTEuNjgsMTUuOTctMjAuOTYsNDAuNDQtNDUsMzguMTd2MjkuOTVjMjkuNzktMi4zNywzNi4zNCwzNy40Nyw3LjUsNDQuOTFoLTY5Ljc1Yy01LjU4LTIuODctMTEuMjMtNS43OS0xNC4yOC0xMS41OC05LjAxLTE3LjEyLDQuNjktMzUuMTcsMjMuMjgtMzMuMzR2LTI5Ljk0SDExNy41djI5Ljk0YzI5LjYzLTIuMzIsMzYuMTMsMzcuMzMsNy41LDQ0LjkxSDU1LjI1Yy02Ljg1LTMuMTEtMTMuMS03LjA3LTE1LjgtMTQuNTUtNS45Ni0xNi41Niw3Ljc0LTMyLjMyLDI0LjgtMzAuMzZ2LTI5Ljk1Yy0yNC4yMSwyLjE4LTMzLjEzLTIyLjEtNDUtMzguMTcsNC43Mi41NywxMy44My43LDE4Ljc1Ljc1Wk0xMDIuNSwzMDguM2gtMjMuMjV2MjkuOTRoMjMuMjV2LTI5Ljk0Wk0zMDUuNzUsMzA4LjNoLTIzLjI1djI5Ljk0aDIzLjI1di0yOS45NFpNNTguNzgsMzUzLjM3Yy03Ljg4LDMuMTYtNy4zMiwxMi40MS42NCwxNC43N2g2Mi45MWM4LjM1LTIuNDYsOC4zNC0xMi40MywwLTE0Ljg5bC02My41NS4xMVpNMjYyLjAzLDM1My4zN2MtNy44OCwzLjE2LTcuMzIsMTIuNDEuNjQsMTQuNzdoNjIuOTFjOC4zNS0yLjQ2LDguMzQtMTIuNDMsMC0xNC44OWwtNjMuNTUuMTFaIi8+CiAgPHBhdGggY2xhc3M9ImNscy00IiBkPSJNMjYuNzUsMjI1LjIybC0uMDMtMjAxLjAxYzQuODItMzUuNjEsNTUuMDYtMzAuMjUsNTIuNTIsNS42NGgyMjYuMDdjLTEuNDQtMzQuOSw0NS45LTQxLjY5LDUyLjg1LTcuMDNsLjA4LDIwMi40Yy00Ljk3LS4yMS0xMC4wMi4wNi0xNSwwbC4wMi0yMDAuMjVjLTIuNy0xMy41My0xOS44Ny0xMy4zMS0yMi41MywwbC4wMiwyMDAuMjVjLTQuOTktLjAyLTEwLjAxLjAxLTE1LDBWNzQuNzZoLTQ5LjVjLjEyLDEzLjctOS4yOSwyNS42Mi0yMi40LDI5LjMtLjg1LDEuMzIuMzUsMjYuNS0uMDcsMzEtLjc4LDguNS04LjE5LDguMjUtMTUuMDQsNy44MiwxLjMyLDEyLjU1LTYuMTcsMjUuMzctMTguNjYsMjguNTNsLS4wOSw1My44MWMtNC45OSwwLTEwLjAxLDAtMTUsMGwtLjA5LTUzLjgxYy0xMi40OS0zLjE2LTE5Ljk3LTE1Ljk4LTE4LjY2LTI4LjUzLTYuODUuNDMtMTQuMjYuNjgtMTUuMDQtNy44Mi0uNDEtNC41Ljc4LTI5LjY4LS4wNy0zMS0xMy4wNC0zLjY3LTIyLjcyLTE1LjYzLTIyLjQtMjkuM2gtNDkuNXYxNTAuNDZjLTQuOTkuMDEtMTAuMDEtLjAyLTE1LDBsLjAyLTIwMC4yNWMtMi43LTEzLjUzLTE5Ljg3LTEzLjMxLTIyLjUzLDBsLjAyLDIwMC4yNWMtNC45OC4wNi0xMC4wMy0uMjEtMTUsMFpNMzA1Ljc1LDQ0LjgySDc5LjI1djE0Ljk3aDIyNi41di0xNC45N1pNMjQxLjI1LDc0Ljc2aC05Ny41Yy0uMjcsNy4xOSw0Ljg3LDEzLjI3LDExLjgsMTQuNzksMjMuMS0uOTgsNDguMjQsMS45Miw3MS4xLjIxLDguNy0uNjUsMTQuNTItNi4xOSwxNC41OS0xNVpNMjE4Ljc1LDEwNC43aC01Mi41djIzLjJoNTIuNXYtMjMuMlpNMjAzLjc1LDE0Mi44OGgtMjIuNWMtMi4xMywxOS43MywyNC42NCwxOS43MiwyMi41LDBaIi8+CiAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMjE3LjQ4LDIwOC41MmMtMi40MS0yLjEzLTMuMTctNi4wOS0xLjYzLTkuMDMuNzctMS40OCwxNS45My0xNi42MiwxNy44OS0xOC4wNyw3LjMtNS40LDE1LjE5LDEuODQsMTEuMTcsOS42NS0uNzIsMS40LTE1LjI3LDE1Ljk0LTE3LjE0LDE3LjMzLTMuMDcsMi4yNy03LjE4LDIuODYtMTAuMjguMTNaIi8+CiAgPHBhdGggY2xhc3M9ImNscy0zIiBkPSJNMTY3LjUyLDIwOC41MmMtMy4xLDIuNzMtNy4yMSwyLjE1LTEwLjI4LS4xMy0xLjg3LTEuMzktMTYuNDItMTUuOTMtMTcuMTQtMTcuMzMtNC4wMi03LjgxLDMuODctMTUuMDYsMTEuMTctOS42NSwzLjA0LDIuMjUsMTIuMzMsMTEuMjMsMTUsMTQuMjIsMy4zOCwzLjc4LDUuODgsOC44LDEuMjUsMTIuODhaIi8+Cjwvc3ZnPg==" 
                                 style="width: 14px; height: 14px; flex-shrink: 0; filter: brightness(0) saturate(100%) invert(1);" 
                                 alt="Máquina">
                            <span style="text-overflow: ellipsis; overflow: hidden;">${maquina.nome}</span>
                        </span>
                    `;
                    equipamentoDropdown.appendChild(div);
                    totalEquipamentos++;
                });
            }
            
            // Adicionar ferramentas
            if (ferramentasData && ferramentasData.length > 0) {
                ferramentasData.forEach(ferramenta => {
                    const div = document.createElement('div');
                    div.setAttribute('data-value', `ferramenta_${ferramenta.id}`);
                    div.innerHTML = `
                        <span style="display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden;">
                            <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzODQgMzU0LjQ0Ij4KICA8ZGVmcz4KICAgIDxzdHlsZT4KICAgICAgLmNscy0xIHsKICAgICAgICBmaWxsOiAjZTFjM2ZlOwogICAgICB9CgogICAgICAuY2xzLTIgewogICAgICAgIGZpbGw6ICMwNDA0ODk7CiAgICAgIH0KCiAgICAgIC5jbHMtMyB7CiAgICAgICAgZmlsbDogIzA4MDg4YTsKICAgICAgfQoKICAgICAgLmNscy00IHsKICAgICAgICBmaWxsOiAjZTFjNGZlOwogICAgICB9CgogICAgICAuY2xzLTUgewogICAgICAgIGZpbGw6ICMwNjA2ODk7CiAgICAgIH0KICAgIDwvc3R5bGU+CiAgPC9kZWZzPgogIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTAsNDUuMjZDNS42NiwyMSwyNC4zNSwyLjczLDQ5Ljg0LDEuMDZjNTEuNjUtMy4zOCwxMDYuOTksMi41OSwxNTkuMDIuMDUsOC4xMy45NiwxNS4wNCwzLjE3LDIyLjE1LDcuMDksNy41NSw0LjE1LDI4Ljc0LDIxLjIsMzQuMjksMjIuNjYsMy45OCwxLjA1LDEwLjkxLS4yNywxNS40OS4yNiwxMS43MSwxLjM2LDE5Ljc1LDEwLjgsMjAuODQsMjIuMjQsMTMuMTQsMS4xLDI1LjI4LDkuMzcsMjguNDUsMjIuNWw0NS4yOS4wOWMzLjk2LjQ0LDYuNDEsMi4wNCw4LjYyLDUuMjR2NS4yNGMtMS4xNywxLjg2LTUsNS4yNC03LjEyLDUuMjRoLTQ2Ljg4Yy0zLjEyLDEzLjE4LTE1LjE5LDIxLjM3LTI4LjMyLDIyLjYzLTEuNCwxMS40Mi05LjA5LDIwLjgyLTIwLjg5LDIyLjItNC41OC41My0xMS41LS43OS0xNS40OS4yNi01LjE5LDEuMzctMjUuOTEsMTcuODYtMzIuODcsMjEuODQtOS4wMiw1LjE3LTE4LjU5LDguMzMtMjkuMTksNy45MiwyLjMyLDIzLjE0LTkuNDcsNDYuMDgtMzAuOTksNTUuNTItMTQuMDcsNi4xOC0yNy40NSw0LjAxLTQyLjQsNC40NmwtNy42LDM3LjMzaDU4Ljg4YzEwLjg0LDAsMjEuMDcsOS45OSwyMi4xMiwyMC41OSwxLjA1LDEwLjYxLDEuNCw0MS40MS0uMTcsNTEuNDYtMS41OCwxMC4xLTExLjA2LDE3Ljk3LTIxLjE3LDE4LjU1bC0xNjEuMjctLjAzYy0xMC41OS0xLjE3LTE2LjgzLTcuNzctMjAuNjMtMTcuMjF2LTY4LjEyYzMuNzgtNi4zMiwxMC44NC00LjU5LDE3LjA4LTYuNTMsMTEuMTgtMy40NiwxNi42Ni0xMi41OCwxOS40My0yMy4yNyw2LjA3LTIzLjQxLDguNjktNDguNzcsMTQuNS03Mi4zNi0uMDQtLjU0LTcuODItMS4xOS05LjA1LTEuNDctMjIuMzMtNS4wNC0zNy4yMi0yMS44LTQxLjk2LTQzLjgzVjQ1LjI2Wk00OC41OCwxNi4yOGMtMTcuOTksMi4yNi0zMi4wNSwxNi40NS0zMy41NywzNC42MS0xLjQ2LDE3LjM1LTEuMzUsNDcuNy0uMDQsNjUuMTQsMS40NiwxOS40OCwxNi4zLDMzLjgyLDM1LjYzLDM1LjU1bDE1Ni43Ni0uMDRjMTcuNjQtMS41NywzMy4wNC0xNy45LDQ4LjAxLTI2LjE5bC4yNS04Mi41OWMtMTQuODEtOC45MS0zMS4xMy0yNS4zOS00OC45Ny0yNi43M2wtMTU4LjA3LjI0Wk0yNzAuNzUsMTIxLjYxYzYuNi4xMSwxMy4zOSwxLjIzLDE1LjU4LTYuNTMtMS4xLTE5LjM0LDIuMDUtNDEuNDkuMjEtNjAuNS0uOTItOS41My04LjA3LTguODYtMTUuNzktOC41N3Y3NS42Wk0zMDEuNSw5OS4xNmMxOS42My0yLjM4LDE5LjYzLTI4LjMxLDAtMzAuNjl2MzAuNjlaTTYzLjc1LDE4MS41Yy00LjI2LDIwLjU4LTcuODcsNDMuNTgtMTMuMTIsNjMuNjMtLjY4LDIuNjItMi4yNSw4LjI3LTMuMzgsMTAuNDctMiwzLjg4LTkuMjcsMTEuNzUtMTIuODEsMTQuNTMtNS45OSw0LjcxLTEyLjQ0LDYuNDctMTkuNDQsOS4wNXYyMi44M2gxNzMuMjV2LTE2Ljg0YzAtMS44Ny0zLjQ0LTUuNi01LjY3LTUuNTctMjEuODEtMS43MS00Ni43NywyLjE1LTY4LjItLjA1LTcuMTctLjc0LTkuODItNC4xLTguNDMtMTEuMzlsMjAuMDQtMTAxLjYzaC02MGMtLjc0LDQuOTEtMS4yNSwxMC4xMi0yLjI1LDE0Ljk3Wk0xODguMjUsMTY2LjUzaC00Ni41bC05LDQ0LjkxaDIzLjYyYzEzLjc2LDAsMzEuODgtMTkuNjcsMzEuODgtMzMuMzF2LTExLjZaTTE4OC4yNSwzMTYuOThIMTV2MTYuMDljMCwyLjk2LDUuNDYsNy4wNCw4LjYsNi4zOWgxNTYuMDZjMi41Ny44Niw4LjYtMy41Niw4LjYtNS42NHYtMTYuODRaIi8+CiAgPHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNjMuNzUsMTgxLjVoMzBzLTE0LjI2LDc0LjEtMTQuMjYsNzQuMWgtMzIuMjRjMS4xNC0yLjE5LDIuNy03Ljg1LDMuMzgtMTAuNDYsNS4yNS0yMC4wNSw4Ljg2LTQzLjA1LDEzLjEyLTYzLjYzWiIvPgogIDxyZWN0IGNsYXNzPSJjbHMtNCIgeD0iMzcuNSIgeT0iMzguNTMiIHdpZHRoPSI2MCIgaGVpZ2h0PSI5MC41NyIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMyIgZD0iTTEyMi41MSw4OS4xN2MtNC43NS00Ljc5LS43Ni0xMy4zMyw2LjEyLTEzLjIyaDk2Ljc1YzEwLjUsMS4xOSwxMS4xMSwxNC41Mi0uNzYsMTUuNzEtMjkuOTksMy02NC43Ny0yLjI0LTk1LjI3LjA0LTIuMTUtLjAyLTUuMzItMS02Ljg0LTIuNTNaIi8+CiAgPHBhdGggY2xhc3M9ImNscy01IiBkPSJNMjMxLjUyLDQxYzMuODUsNC4xNSwxLjQyLDEyLjIxLTQuNjIsMTIuNTFsLTEwMi4yLS41OGMtNi43OS00LjEyLTQuOS0xMy42NSwzLjE2LTE0LjQyLDMxLjEsMi4yMSw2Ni4xNy0yLjg4LDk2LjgtLjAxLDIuMTEuMiw1LjM5LjkyLDYuODYsMi41WiIvPgogIDxwYXRoIGNsYXNzPSJjbHMtNSIgZD0iTTIzMS41MiwxMjYuNjJjLTEuNDcsMS41OC00Ljc1LDIuMzEtNi44NiwyLjUtMzAuNjMsMi44Ny02NS43LTIuMjItOTYuOC0uMDEtOC4wNy0uNzctOS45NS0xMC4zLTMuMTYtMTQuNDJsMTAyLjItLjU4YzYuMDQuMyw4LjQ4LDguMzYsNC42MiwxMi41MVoiLz4KPC9zdmc+" 
                                 style="width: 14px; height: 14px; flex-shrink: 0; filter: brightness(0) saturate(100%) invert(1);" 
                                 alt="Ferramenta">
                            <span style="text-overflow: ellipsis; overflow: hidden;">${ferramenta.nome}</span>
                        </span>
                    `;
                    equipamentoDropdown.appendChild(div);
                    totalEquipamentos++;
                });
            }
            
            // Atualizar texto do botão
            const equipamentoButton = document.querySelector('#etapaEquipamento button');
            if (totalEquipamentos > 0) {
                equipamentoButton.textContent = `Selecionar equipamento... (${totalEquipamentos} disponíveis)`;
            } else {
                equipamentoButton.textContent = 'Nenhum equipamento disponível';
            }
            
        } catch (error) {
            console.error('Erro ao carregar equipamentos:', error);
            const equipamentoButton = document.querySelector('#etapaEquipamento button');
            equipamentoButton.textContent = 'Erro ao carregar equipamentos';
            mostrarMensagem('Erro ao carregar equipamentos', 'erro');
        }
    }

    async function carregarMateriaisParaEtapa() {
        try {
            const materialDropdown = document.querySelector('#etapaMaterial .dropdown-content');
            materialDropdown.innerHTML = '';
            
            let materiaisParaUsar = [];
            let totalMateriais = 0;
                 // Detectar se estamos no modal de edição ou novo produto
        const modalEditarProduto = document.getElementById('editProdutoModal');
        const isEditMode = modalEditarProduto && modalEditarProduto.style.display === 'block';
            
            if (isEditMode) {
                // Usar o array editMateriais para o modal de edição
                materiaisParaUsar = editMateriais || [];
                console.log(`[DEBUG] Usando editMateriais (${materiaisParaUsar.length} itens):`, materiaisParaUsar);
                
                    materiaisParaUsar.forEach((material, index) => {
                        // Usar o nome correto do material conforme a estrutura do editMateriais
                        const materialNome = material.material_nome || material.nome || 'Material sem nome';
                        const materialId = material.material_id || material.id || `edit_material_${index}`;
                        
                        // Criar descrição detalhada da instância
                        let descricaoInstancia = materialNome;
                        if (material.largura && material.altura && material.quantidade_necessaria) {
                            descricaoInstancia += ` (${material.largura}x${material.altura}cm, Qtd: ${material.quantidade_necessaria})`;
                        } else if (material.quantidade_necessaria) {
                            descricaoInstancia += ` (Qtd: ${material.quantidade_necessaria})`;
                        }
                        
                        // Criar a opção no dropdown usando um ID único para cada instância
                        const div = document.createElement('div');
                        div.setAttribute('data-value', `instance_${index}`); // ID único para cada instância
                        div.setAttribute('data-material-id', materialId); // ID do material para compatibilidade
                        div.setAttribute('data-instance-index', index); // Índice da instância no array
                        div.style.cssText = 'padding: 8px 12px; cursor: pointer; transition: background-color 0.2s ease; display: flex; align-items: center; gap: 8px; border-radius: 4px; margin: 2px;';
                        div.innerHTML = `
                            <span style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <span style="width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%; flex-shrink: 0;"></span>
                                ${descricaoInstancia}
                            </span>
                        `;
                        materialDropdown.appendChild(div);
                        totalMateriais++;
                    });
            } else {
                // Usar a lista de materiais do DOM para o modal de novo produto
                console.log(`[DEBUG] Usando materiaisList do DOM`);
                const materiaisList = document.getElementById('materiaisList');
                if (!materiaisList) {
                    console.error('[DEBUG] Elemento materiaisList não encontrado');
                    return;
                }
                
                const materialRows = materiaisList.querySelectorAll('tr');
                console.log(`[DEBUG] Encontradas ${materialRows.length} linhas de materiais`);

                materialRows.forEach((row, index) => {
                    const cells = row.cells;
                    if (cells && cells.length > 0) {
                        // Pegar o nome do material da primeira célula
                        const materialNome = cells[0].textContent.trim();
                        
                        // Pegar o ID real do material do atributo data-material-id da linha
                        const materialId = row.getAttribute('data-material-id');
                        
                        // Obter informações da instância para criar descrição detalhada
                        let descricaoInstancia = materialNome;
                        const larguraInput = row.querySelector('[data-dimension="largura"]');
                        const alturaInput = row.querySelector('[data-dimension="altura"]');
                        const quantidadeInput = row.querySelector('[data-tipo="quantidade"]');
                        
                        if (larguraInput && alturaInput && quantidadeInput) {
                            const largura = larguraInput.value || '0';
                            const altura = alturaInput.value || '0';
                            const quantidade = quantidadeInput.value || '0';
                            descricaoInstancia += ` (${largura}x${altura}cm, Qtd: ${quantidade})`;
                        } else if (quantidadeInput) {
                            const quantidade = quantidadeInput.value || '0';
                            descricaoInstancia += ` (Qtd: ${quantidade})`;
                        }
                        
                        // Criar a opção no dropdown usando um ID único para cada linha
                        const div = document.createElement('div');
                        div.setAttribute('data-value', `row_${index}`); // ID único para cada linha
                        div.setAttribute('data-material-id', materialId); // ID do material para compatibilidade
                        div.setAttribute('data-row-index', index); // Índice da linha na tabela
                        div.style.cssText = 'padding: 8px 12px; cursor: pointer; transition: background-color 0.2s ease; display: flex; align-items: center; gap: 8px; border-radius: 4px; margin: 2px;';
                        div.innerHTML = `
                            <span style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <span style="width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%; flex-shrink: 0;"></span>
                                ${descricaoInstancia}
                            </span>
                        `;
                        materialDropdown.appendChild(div);
                        totalMateriais++;
                    }
                });
            }
            
            // Atualizar texto do botão
            const materialButton = document.querySelector('#etapaMaterial button');
            if (totalMateriais > 0) {
                materialButton.textContent = `Selecionar material... (${totalMateriais} disponíveis)`;
            } else {
                materialButton.textContent = 'Nenhum material adicionado';
            }
            
            return Promise.resolve();
            
        } catch (error) {
            console.error('Erro ao carregar materiais para etapa:', error);
            const materialButton = document.querySelector('#etapaMaterial button');
            materialButton.textContent = 'Erro ao carregar materiais';
            return Promise.reject(error);
        }
    }

    // Funções para controle de tempo com scroll do mouse
    function updateTimeHover(event) {
        const input = event.target;
        const rect = input.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const indicator = document.getElementById('timeHoverIndicator');
        
        // Criar um elemento temporário para medir o texto
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Obter o estilo computado do input
        const computedStyle = window.getComputedStyle(input);
        ctx.font = `${computedStyle.fontSize} ${computedStyle.fontFamily}`;
        
        // Valor atual do input ou valor padrão
        const currentValue = input.value || '00:00:00';
        
        // Calcular larguras dos caracteres individuais
        const paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;
        
        // Medir largura de cada parte do tempo
        const hoursWidth = ctx.measureText('00').width;
        const colonWidth = ctx.measureText(':').width;
        const minutesWidth = ctx.measureText('00').width;
        const secondsWidth = ctx.measureText('00').width;
        
        // Calcular posições absolutas de cada seção
        const hoursStart = paddingLeft;
        const hoursEnd = hoursStart + hoursWidth;
        
        const firstColonStart = hoursEnd;
        const firstColonEnd = firstColonStart + colonWidth;
        
        const minutesStart = firstColonEnd;
        const minutesEnd = minutesStart + minutesWidth;
        
        const secondColonStart = minutesEnd;
        const secondColonEnd = secondColonStart + colonWidth;
        
        const secondsStart = secondColonEnd;
        const secondsEnd = secondsStart + secondsWidth;
        
        // Determinar qual seção está sendo apontada
        let section = '';
        let indicatorPos = 0;
        let indicatorWidth = 0;
        
        if (x >= hoursStart && x <= hoursEnd) {
            section = 'hours';
            indicatorPos = hoursStart;
            indicatorWidth = hoursWidth;
        } else if (x >= minutesStart && x <= minutesEnd) {
            section = 'minutes';
            indicatorPos = minutesStart;
            indicatorWidth = minutesWidth;
        } else if (x >= secondsStart && x <= secondsEnd) {
            section = 'seconds';
            indicatorPos = secondsStart;
            indicatorWidth = secondsWidth;
        } else {
            section = '';
            indicatorWidth = 0;
        }
        
        // Atualizar indicador visual
        indicator.style.left = indicatorPos + 'px';
        indicator.style.width = indicatorWidth + 'px';
        
        // Armazenar seção atual para uso no scroll
        input.dataset.currentSection = section;
    }

    function handleTimeWheel(event) {
        event.preventDefault();
        
        const input = event.target;
        const section = input.dataset.currentSection;
        
        if (!section) return;
        
        let currentValue = input.value || '00:00:00';
        
        // Garantir formato correto
        if (!/^\d{2}:\d{2}:\d{2}$/.test(currentValue)) {
            currentValue = '00:00:00';
        }
        
        const parts = currentValue.split(':');
        let hours = parseInt(parts[0]);
        let minutes = parseInt(parts[1]);
        let seconds = parseInt(parts[2]);
        
        // Determinar direção do scroll (positivo = para cima, negativo = para baixo)
        const delta = Math.sign(event.deltaY) * -1;
        
        // Ajustar valores baseado na seção
        switch (section) {
            case 'hours':
                hours = Math.max(0, Math.min(99, hours + delta));
                break;
            case 'minutes':
                minutes += delta;
                if (minutes >= 60) {
                    minutes = 0;
                    hours = Math.min(99, hours + 1);
                } else if (minutes < 0) {
                    minutes = 59;
                    hours = Math.max(0, hours - 1);
                }
                break;
            case 'seconds':
                seconds += delta;
                if (seconds >= 60) {
                    seconds = 0;
                    minutes++;
                    if (minutes >= 60) {
                        minutes = 0;
                        hours = Math.min(99, hours + 1);
                    }
                } else if (seconds < 0) {
                    seconds = 59;
                    minutes--;
                    if (minutes < 0) {
                        minutes = 59;
                        hours = Math.max(0, hours - 1);
                    }
                }
                break;
        }
        
        // Formatar e atualizar valor
        const newValue = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        input.value = newValue;
        
        // Disparar evento de input para recalcular custo
        calcularCustoEstimado();
        
        // Feedback visual
        input.style.boxShadow = '0 0 10px rgba(155, 100, 227, 0.8)';
        setTimeout(() => {
            input.style.boxShadow = '';
        }, 150);
    }

    // Função para calcular custo estimado baseado no equipamento e tempo
    // Para máquinas: calcula automaticamente com base na hora/máquina * tempo
    // Para ferramentas: define custo como R$ 0,00 (pode ser alterado manualmente)
    function calcularCustoEstimado() {
        console.log(`🔧 [CALC CUSTO] === Iniciando cálculo de custo estimado ===`);
        
        const equipamentoButton = document.querySelector('#etapaEquipamento button');
        if (!equipamentoButton) {
            console.error(`❌ [CALC CUSTO] Botão de equipamento não encontrado!`);
            return;
        }
        
        const equipamento_id = equipamentoButton.getAttribute('data-selected');
        const tempo_estimado = document.getElementById('etapaTempo').value;
        
        console.log(`🔧 [CALC CUSTO] Button encontrado:`, equipamentoButton);
        console.log(`🔧 [CALC CUSTO] equipamento_id:`, equipamento_id);
        console.log(`🔧 [CALC CUSTO] tempo_estimado:`, tempo_estimado);
        console.log(`🔧 [CALC CUSTO] Todos os atributos do botão:`, Array.from(equipamentoButton.attributes).map(attr => `${attr.name}="${attr.value}"`));
        
        if (!equipamento_id || !tempo_estimado) {
            console.log(`⚠️ [CALC CUSTO] Equipamento ou tempo não definidos`);
            console.log(`   - equipamento_id válido:`, !!equipamento_id);
            console.log(`   - tempo_estimado válido:`, !!tempo_estimado);
            return;
        }

        // Verificar se é máquina ou ferramenta
        if (equipamento_id.startsWith('maquina_')) {
            const maquina_id = parseInt(equipamento_id.replace('maquina_', ''));
            const maquina = maquinasData.find(m => m.id === maquina_id);
            
            console.log(`[DEBUG] maquina_id: ${maquina_id}`);
            console.log(`[DEBUG] maquina encontrada:`, maquina);
            console.log(`[DEBUG] maquinasData:`, maquinasData);
            
            if (maquina && maquina.hora_maquina) {
                const hora_maquina = parseFloat(maquina.hora_maquina);
                console.log(`[DEBUG] hora_maquina: ${hora_maquina}`);
                
                // Converter tempo HH:MM:SS para horas decimais
                const tempoPartes = tempo_estimado.split(':');
                const horas = parseInt(tempoPartes[0]) || 0;
                const minutos = parseInt(tempoPartes[1]) || 0;
                const segundos = parseInt(tempoPartes[2]) || 0;
                const tempoEmHoras = horas + (minutos / 60) + (segundos / 3600);
                
                console.log(`[DEBUG] tempo convertido para horas: ${tempoEmHoras}`);
                
                const custoCalculado = hora_maquina * tempoEmHoras;
                console.log(`[DEBUG] custoCalculado: ${custoCalculado}`);
                
                // Verificar se há material selecionado para log adicional
                const materialButton = document.querySelector('#etapaMaterial button');
                const materialId = materialButton ? materialButton.getAttribute('data-selected') : null;
                console.log(`[DEBUG] Material da etapa usado no cálculo: ${materialId}`);
                
                // Atualizar campo de custo no formato adequado para o input
                const custoInput = document.getElementById('etapaCusto');
                const valorFormatado = formatarMoedaBrasileira(custoCalculado);
                console.log(`[DEBUG] valorFormatado: ${valorFormatado}`);
                
                custoInput.value = valorFormatado;
                
                // Forçar trigger do evento de formatação do campo
                formatarCustoEtapa(custoInput);
            }
        }
        // Para ferramentas, não há cálculo automático (podem ter custo zero ou manual)
        else if (equipamento_id.startsWith('ferramenta_')) {
            console.log(`[DEBUG] Ferramenta selecionada, definindo custo como R$ 0,00`);
            // Limpar o campo de custo para ferramentas
            const custoInput = document.getElementById('etapaCusto');
            custoInput.value = 'R$ 0,00';
        }
    }

    function limparEquipamento() {
        const equipamentoButton = document.querySelector('#etapaEquipamento button');
        equipamentoButton.textContent = 'Sem equipamento (mão de obra)';
        equipamentoButton.removeAttribute('data-selected');
        
        // Definir tipo como manual quando não há equipamento
        const tipoButton = document.querySelector('#etapaTipo button');
        tipoButton.textContent = 'Preparação';
        tipoButton.setAttribute('data-selected', 'Preparação');
        
        // Limpar campo de custo quando não há equipamento
        const custoInput = document.getElementById('etapaCusto');
        custoInput.value = 'R$ 0,00';
        
        // Adicionar feedback visual temporário
        const btnLimpar = document.getElementById('btnLimparEquipamento');
        const originalText = btnLimpar.innerHTML;
        btnLimpar.innerHTML = '✓';
        btnLimpar.style.backgroundColor = 'rgba(100, 255, 100, 0.3)';
        btnLimpar.style.borderColor = 'rgba(100, 255, 100, 0.6)';
        
        setTimeout(() => {
            btnLimpar.innerHTML = originalText;
            btnLimpar.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            btnLimpar.style.borderColor = 'rgba(155, 100, 227, 0.4)';
        }, 1000);
        
        // Focar no campo de custo para permitir entrada manual
        custoInput.focus();
    }

    function adicionarOuEditarEtapa() {
        const nome = document.getElementById('etapaNome').value.trim();
        const tipoButton = document.querySelector('#etapaTipo button');
        const tipoSelecionado = tipoButton.getAttribute('data-selected');
        const equipamentoButton = document.querySelector('#etapaEquipamento button');
        const equipamento_id = equipamentoButton.getAttribute('data-selected');
        const materialButton = document.querySelector('#etapaMaterial button');
        const material_id = materialButton.getAttribute('data-selected');
        const tempo_estimado = document.getElementById('etapaTempo').value;
        
        // Determinar o tipo baseado na seleção do usuário (prioridade) ou no equipamento como fallback
        let tipo;
        if (tipoSelecionado && tipoSelecionado !== '' && tipoSelecionado !== 'Selecionar tipo...') {
            // Usar o tipo explicitamente selecionado pelo usuário
            tipo = tipoSelecionado;
        } else {
            // Fallback: determinar baseado no equipamento ou usar manual como padrão
            if (equipamento_id) {
                if (equipamento_id.startsWith('maquina_')) {
                    tipo = 'Processamento';
                } else if (equipamento_id.startsWith('ferramenta_')) {
                    tipo = 'Preparação';
                } else {
                    tipo = 'Preparação';
                }
            } else {
                tipo = 'Preparação';
            }
        }
        
        // Extrair valor do custo corretamente
        let custo_input_value = document.getElementById('etapaCusto').value;
        let custo_estimado = 0;
        
        if (custo_input_value) {
            // Remover "R$ " e espaços
            let valorString = custo_input_value.replace(/R\$\s*/g, '').trim();
            
            // Se contém vírgula, é formato brasileiro (ex: "1.234,56")
            if (valorString.includes(',')) {
                // Remover pontos (separadores de milhares) e substituir vírgula por ponto
                valorString = valorString.replace(/\./g, '').replace(',', '.');
            }
            
            custo_estimado = parseFloat(valorString) || 0;
        }

        if (!nome || !tipo || !tempo_estimado) {
            mostrarMensagem('Por favor, preencha os campos obrigatórios: Nome, Tipo e Tempo', 'erro');
            return;
        }

        // Buscar nome do equipamento a partir da opção selecionada
        let equipamentoNome = '';
        
        if (equipamento_id) {
            const selectedOption = document.querySelector(`#etapaEquipamento .dropdown-content div[data-value="${equipamento_id}"]`);
            if (selectedOption) {
                const fullText = selectedOption.textContent.trim();
                // Extrair apenas o nome do equipamento (antes do texto "(Máquina" ou "(Ferramenta")
                const nomeMatch = fullText.match(/^([^(]+)/);
                equipamentoNome = nomeMatch ? nomeMatch[1].trim() : fullText;
            }
        } else {
            // Sem equipamento - mão de obra
            equipamentoNome = 'Mão de obra';
        }

        // Buscar nome do material a partir da opção selecionada
        let materialNome = '';
        let materialIdReal = null; // Para armazenar o ID real do material (não da instância)
        
        if (material_id) {
            const selectedMaterialOption = document.querySelector(`#etapaMaterial .dropdown-content div[data-value="${material_id}"]`);
            if (selectedMaterialOption) {
                // Extrair o nome do material do texto completo
                const fullText = selectedMaterialOption.textContent.trim();
                
                // Se é uma instância específica (contém parenteses com dimensões)
                if (fullText.includes('(') && fullText.includes(')')) {
                    // Extrair apenas o nome do material (antes dos parênteses)
                    const nomeMatch = fullText.match(/^(.+?)\s*\(/);
                    materialNome = nomeMatch ? nomeMatch[1].trim() : fullText;
                } else {
                    // Remover ícone se houver e pegar o nome completo
                    const textParts = fullText.split(/\s+/);
                    if (textParts.length > 1) {
                        materialNome = textParts.slice(1).join(' ');
                    } else {
                        materialNome = fullText;
                    }
                }
                
                // Obter o ID real do material (se disponível)
                const realMaterialId = selectedMaterialOption.getAttribute('data-material-id');
                if (realMaterialId) {
                    materialIdReal = realMaterialId;
                } else {
                    // Fallback para material_id se não há data-material-id
                    materialIdReal = material_id.startsWith('instance_') || material_id.startsWith('row_') ? null : material_id;
                }
            }
        }

        const etapa = {
            nome: nome,
            tipo: tipo,
            equipamento_id: equipamento_id || null,
            equipamento_nome: equipamentoNome,
            material_id: materialIdReal || null, // Usar o ID real do material
            material_nome: materialNome || null,
            material_instance_selection: material_id, // Preservar a seleção específica da instância
            tempo_estimado: tempo_estimado,
            custo_estimado: custo_estimado // Manter como número para facilitar edições futuras
        };

        // Detectar qual modal está ativo
        const novoModalAtivo = document.getElementById('produtoModal').style.display === 'block';
        const editModalAtivo = document.getElementById('editProdutoModal').style.display === 'block';

        if (editModalAtivo) {
            // Modal de edição está ativo
            if (etapaEditandoIndex >= 0) {
                editEtapas[etapaEditandoIndex] = etapa;
                mostrarMensagem('Etapa editada com sucesso!', 'sucesso');
            } else {
                editEtapas.push(etapa);
                mostrarMensagem('Etapa adicionada com sucesso!', 'sucesso');
            }
            atualizarTabelaEtapasEdit();
            atualizarCustoTotalEtapasEdit();
        } else {
            // Modal de novo produto está ativo
            if (etapaEditandoIndex >= 0) {
                etapas[etapaEditandoIndex] = etapa;
                mostrarMensagem('Etapa editada com sucesso!', 'sucesso');
            } else {
                etapas.push(etapa);
                mostrarMensagem('Etapa adicionada com sucesso!', 'sucesso');
            }
            atualizarTabelaEtapas();
            atualizarCustoTotalEtapas();
        }

        closeEtapaModal();
    }

    function removerEtapa(index) {
        if (confirm('Tem certeza que deseja remover esta etapa?')) {
            // Detectar qual modal está ativo
            const editModalAtivo = document.getElementById('editProdutoModal').style.display === 'block';
            
            if (editModalAtivo) {
                editEtapas.splice(index, 1);
                atualizarTabelaEtapasEdit();
                atualizarCustoTotalEtapasEdit();
            } else {
                etapas.splice(index, 1);
                atualizarTabelaEtapas();
                atualizarCustoTotalEtapas();
            }
            
            mostrarMensagem('Etapa removida com sucesso!', 'sucesso');
        }
    }

    function atualizarTabelaEtapas() {
        const tbody = document.getElementById('etapasList');
        tbody.innerHTML = '';

        etapas.forEach((etapa, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div class="material-name-truncate" title="${etapa.nome}">
                        ${etapa.nome}
                    </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <span class="etapa-tipo-badge" style="background-color: rgba(155, 100, 227, 0.2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                        ${etapa.tipo}
                    </span>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; color: white;">
                    <div class="material-name-truncate" title="${etapa.equipamento_nome}">
                        ${etapa.equipamento_nome}
                    </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; color: white;">
                    <div class="material-name-truncate" title="${etapa.material_nome || 'Nenhum'}">
                        ${etapa.material_nome || 'Nenhum'}
                    </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; color: white;">
                    ${etapa.tempo_estimado}
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: right; color: white; font-weight: bold;">
                    ${(() => {
                        const valor = parseFloat(etapa.custo_estimado) || 0;
                        return valor.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    })()}
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <button type="button" onclick="openEditarEtapaModal(${index})" class="btn-edit" style="background: none; border: none; color: #9B64E3; cursor: pointer; margin-right: 5px;" title="Editar etapa">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="removerEtapa(${index})" class="btn-delete" style="background: none; border: none; color: #ff6b6b; cursor: pointer;" title="Remover etapa">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Atualizar custo total sempre que a tabela for atualizada
        atualizarCustoTotalEtapas();
    }

    function atualizarCustoTotalEtapas() {
        // Verificar se o elemento existe
        const elemento = document.getElementById('custoTotalEtapas');
        if (!elemento) {
            console.warn('Elemento custoTotalEtapas não encontrado');
            return;
        }
        
        // Se não há etapas, mostrar R$ 0,00
        if (!etapas || etapas.length === 0) {
            elemento.textContent = 'R$ 0,00';
            return;
        }
        
        let total = 0;
        
        etapas.forEach((etapa, index) => {
            if (!etapa.custo_estimado && etapa.custo_estimado !== 0) {
                return; // Pular etapas sem custo
            }
            
            // Como agora armazenamos como número, usar diretamente
            const valor = parseFloat(etapa.custo_estimado) || 0;
            total += valor;
        });
        
        elemento.textContent = formatarMoedaBrasileira(total);
        
        // Recalcular preço final com margem
        calcularPrecoComMargem();
    }

    function atualizarTabelaEtapasEdit() {
        const tbody = document.getElementById('editEtapasList');
        if (!tbody) {
            console.error('Elemento editEtapasList não encontrado');
            return;
        }
        
        tbody.innerHTML = '';

        editEtapas.forEach((etapa, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div class="material-name-truncate" title="${etapa.nome}">
                        ${etapa.nome}
                    </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <span class="etapa-tipo-badge" style="background-color: rgba(155, 100, 227, 0.2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                        ${etapa.tipo}
                    </span>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; color: white;">
                    <div class="material-name-truncate" title="${etapa.equipamento_nome}">
                        ${etapa.equipamento_nome}
                    </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; color: white;">
                    <div class="material-name-truncate" title="${etapa.material_nome || 'Nenhum'}">
                        ${etapa.material_nome || 'Nenhum'}
                    </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; color: white;">
                    ${etapa.tempo_estimado}
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: right; color: white; font-weight: bold;">
                    ${(() => {
                        let valorString = etapa.custo_estimado.toString();
                        // Remover R$ se existir e espaços
                        valorString = valorString.replace(/R\$\s*/g, '').trim();
                        // Converter para número
                        let valor = 0;
                        if (valorString.includes(',')) {
                            // Formato brasileiro: remover pontos e trocar vírgula por ponto
                            valorString = valorString.replace(/\./g, '').replace(',', '.');
                        }
                        valor = parseFloat(valorString) || 0;
                        return valor.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    })()}
                </td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <button type="button" onclick="openEditarEtapaModal(${index})" class="btn-edit" style="background: none; border: none; color: #9B64E3; cursor: pointer; margin-right: 5px;" title="Editar etapa">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button type="button" onclick="removerEtapa(${index})" class="btn-delete" style="background: none; border: none; color: #ff6b6b; cursor: pointer;" title="Remover etapa">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Atualizar custo total sempre que a tabela for atualizada
        atualizarCustoTotalEtapasEdit();
    }

    function atualizarCustoTotalEtapasEdit() {
        // Verificar se o elemento existe
        const elemento = document.getElementById('editCustoTotalEtapas');
        if (!elemento) {
            console.warn('Elemento editCustoTotalEtapas não encontrado');
            return;
        }
        
        // Se não há etapas, mostrar R$ 0,00
        if (!editEtapas || editEtapas.length === 0) {
            elemento.textContent = 'R$ 0,00';
            calcularPrecoComMargemEdit(); // Recalcular preço mesmo com etapas zeradas
            return;
        }
        
        let total = 0;
        
        editEtapas.forEach((etapa, index) => {
            if (!etapa.custo_estimado && etapa.custo_estimado !== 0) {
                return; // Pular etapas sem custo
            }
            
            // Como agora armazenamos como número, usar diretamente
            const valor = parseFloat(etapa.custo_estimado) || 0;
            total += valor;
        });
        
        elemento.textContent = formatarMoedaBrasileira(total);
        
        // SEMPRE recalcular preço final com margem para edição
        console.log('🔄 [DEBUG] Chamando calcularPrecoComMargemEdit() após atualização de custos de etapas');
        calcularPrecoComMargemEdit();
    }

    // Função para formatar custo em tempo real
    function formatarCustoEtapa(input) {
        let valor = input.value.replace(/\D/g, '');
        if (valor.length === 0) {
            input.value = '';
            return;
        }
        
        valor = (valor / 100).toFixed(2);
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        input.value = `R$ ${valor}`;
    }

    // Função específica para configurar dropdowns do modal de etapas
    function configurarDropdownsEtapa() {
        console.log('🔧 [CONFIG] Iniciando configuração de dropdowns de etapa...');
        
        // Configurar dropdown de tipo de etapa
        const tipoDropdown = document.getElementById('etapaTipo');
        if (tipoDropdown) {
            console.log('🔧 [CONFIG] Configurando dropdown de tipo:', tipoDropdown.id);
            configurarDropdownEspecifico(tipoDropdown);
        }
        
        // Configurar dropdown de equipamento
        const equipamentoDropdown = document.getElementById('etapaEquipamento');
        if (equipamentoDropdown) {
            console.log('🔧 [CONFIG] Configurando dropdown de equipamento:', equipamentoDropdown.id);
            configurarDropdownEspecifico(equipamentoDropdown);
        } else {
            console.error('❌ [CONFIG] Dropdown de equipamento não encontrado!');
        }
        
        // Configurar dropdown de material
        const materialDropdown = document.getElementById('etapaMaterial');
        if (materialDropdown) {
            console.log('🔧 [CONFIG] Configurando dropdown de material:', materialDropdown.id);
            configurarDropdownEspecifico(materialDropdown);
        } else {
            console.error('❌ [CONFIG] Dropdown de material não encontrado!');
        }
        
        console.log('✅ [CONFIG] Configuração de dropdowns concluída');
    }
</script>

<style>
    /* Estilos para indicar funcionalidade de clique direito nas linhas de materiais */
    #materiaisList tr,
    #editMateriaisList tr {
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }
    
    #materiaisList tr:hover,
    #editMateriaisList tr:hover {
        background-color: rgba(155, 100, 227, 0.1);
        box-shadow: 0 2px 8px rgba(155, 100, 227, 0.2);
    }
    
    /* Tooltip temporário que segue o cursor */
    .cursor-tooltip {
        position: fixed;
        background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 30, 40, 0.95));
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 15000;
        pointer-events: none;
        border: 1px solid rgba(155, 100, 227, 0.4);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        opacity: 0;
        transform: scale(0.9);
        transition: all 0.2s ease;
    }
    
    .cursor-tooltip.show {
        opacity: 1;
        transform: scale(1);
    }
    
    /* Menu de contexto personalizado */
    .context-menu {
        position: fixed;
        background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 30, 40, 0.95));
        border: 1px solid rgba(155, 100, 227, 0.3);
        border-radius: 8px;
        padding: 4px 0;
        min-width: 160px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(155, 100, 227, 0.1);
        z-index: 10000;
        opacity: 0;
        transform: scale(0.95);
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
    }
    
    .context-menu.show {
        opacity: 1;
        transform: scale(1);
    }
    
    .context-menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 13px;
        font-weight: 500;
    }
    
    .context-menu-item:hover {
        background: rgba(155, 100, 227, 0.2);
        color: #D8CEFE;
        transform: translateX(2px);
    }
    
    .context-menu-item.danger:hover {
        background: rgba(220, 53, 69, 0.2);
        color: #ff6b6b;
    }
    
    .context-menu-item svg {
        width: 16px;
        height: 16px;
        transition: transform 0.2s ease;
    }
    
    .context-menu-item:hover svg {
        transform: scale(1.1);
    }

    /* Modal de confirmação personalizado */
    .confirmation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 20000;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }
    
    .confirmation-modal.show {
        display: flex;
    }
    
    .confirmation-modal-content {
        background: linear-gradient(135deg, 
            rgba(30, 30, 45, 0.95) 0%, 
            rgba(40, 40, 55, 0.95) 50%, 
            rgba(50, 45, 65, 0.95) 100%);
        border: 1px solid rgba(155, 100, 227, 0.4);
        border-radius: 16px;
        padding: 28px;
        max-width: 420px;
        width: 90%;
        box-shadow: 
            0 25px 80px rgba(0, 0, 0, 0.6),
            0 0 40px rgba(155, 100, 227, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
    }
    
    .confirmation-modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(155, 100, 227, 0.05) 0%, 
            transparent 50%, 
            rgba(155, 100, 227, 0.02) 100%);
        border-radius: 16px;
        pointer-events: none;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.8);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .confirmation-modal-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 20px;
        color: #ff9999;
        position: relative;
        z-index: 1;
    }
    
    .confirmation-modal-header svg {
        width: 28px;
        height: 28px;
        filter: drop-shadow(0 0 8px rgba(255, 153, 153, 0.3));
    }
    
    .confirmation-modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .confirmation-modal-message {
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 24px;
        line-height: 1.6;
        font-size: 15px;
        position: relative;
        z-index: 1;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .confirmation-modal-buttons {
        display: flex;
        gap: 14px;
        justify-content: flex-end;
        position: relative;
        z-index: 1;
    }
    
    .confirmation-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        min-width: 90px;
        position: relative;
        overflow: hidden;
    }
    
    .confirmation-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .confirmation-btn:hover::before {
        left: 100%;
    }
    
    .confirmation-btn-cancel {
        background: linear-gradient(135deg, 
            rgba(255, 255, 255, 0.1) 0%, 
            rgba(255, 255, 255, 0.05) 100%);
        color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(155, 100, 227, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .confirmation-btn-cancel:hover {
        background: linear-gradient(135deg, 
            rgba(155, 100, 227, 0.2) 0%, 
            rgba(155, 100, 227, 0.1) 100%);
        color: #D8CEFE;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(155, 100, 227, 0.2);
        border-color: rgba(155, 100, 227, 0.5);
    }
    
    .confirmation-btn-confirm {
        background: linear-gradient(135deg, 
            #dc3545 0%, 
            #c82333 50%, 
            #bd2130 100%);
        color: white;
        border: 1px solid rgba(220, 53, 69, 0.6);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    
    .confirmation-btn-confirm:hover {
        background: linear-gradient(135deg, 
            #c82333 0%, 
            #bd2130 50%, 
            #a71e2a 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(220, 53, 69, 0.4);
        border-color: rgba(220, 53, 69, 0.8);
    }

    /* Botão Novo Produto com efeitos similares aos botões de confirmação */
    .btn-novo-produto {
        padding: 8px 16px;
        border: 1px solid #9B64E3;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, 
            rgba(155, 100, 227, 0.05) 0%, 
            rgba(155, 100, 227, 0.1) 100%);
        color: white;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        min-width: 140px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn-novo-produto::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .btn-novo-produto:hover::before {
        left: 100%;
    }
    
    .btn-novo-produto:hover {
        background: #D8CEFE;
        color: rgba(155, 100, 227, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(155, 100, 227, 0.4);
        border-color: rgba(155, 100, 227, 0.8);
    }

    /* Botão Novo Kit com efeitos similares ao Novo Produto */
    .btn-novo-kit {
        padding: 8px 16px;
        border: 1px solid #FFC107;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, 
            rgba(255, 193, 7, 0.05) 0%, 
            rgba(255, 193, 7, 0.1) 100%);
        color: #FFC107;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        min-width: 120px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn-novo-kit::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .btn-novo-kit:hover::before {
        left: 100%;
    }
    
    .btn-novo-kit:hover {
        background: #FFF3CD;
        color: rgba(255, 193, 7, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(255, 193, 7, 0.4);
        border-color: rgba(255, 193, 7, 0.8);
    }

    /* =============================================
       SISTEMA DE ABAS - ESTILO ELEGANTE
       ============================================= */
    
    /* Garantir que os containers principais das abas funcionem como flex containers */
    .tab-content .form-group > div[style*="display: flex"] {
        display: flex !important;
        flex-direction: column !important;
        height: 400px; /* Altura consistente */
    }
    
    /* Garantir que o rodapé fique ancorado no final */
    .tab-content .form-group > div > div[style*="border-top"] {
        margin-top: auto !important; /* Força o rodapé para o final */
        flex-shrink: 0; /* Não permite que o rodapé encolha */
    }
    
    /* Aplicar também especificamente aos modais de produtos */
    #produtoModal .tab-content .form-group > div > div[style*="border-top"],
    #editProdutoModal .tab-content .form-group > div > div[style*="border-top"] {
        margin-top: auto !important;
        flex-shrink: 0;
    }

    /* DEBUG: Forçar visibilidade de todas as colunas */
    .materials-table-container th,
    .materials-table-container td {
        opacity: 1 !important;
        visibility: visible !important;
        display: table-cell !important;
        overflow: visible !important;
    }
    
    /* DEBUG: Container das abas deve permitir overflow */
    .tabs-container {
        overflow-x: auto !important;
        width: 100% !important;
        min-width: 1100px !important;
    }

    /* Tabs-container específico do kit sem largura mínima forçada */
    #kitModal .tabs-container {
        overflow-x: hidden !important;
        width: 100% !important;
        min-width: auto !important; /* Remover largura mínima forçada */
    }

    /* Modais de Produtos - Dimensões Fixas */
    #produtoModal .modal-content,
    #editProdutoModal .modal-content {
        width: 99%;
        max-width: 1800px; /* Aumentar largura máxima para melhor aproveitamento */
        max-height: 90vh; /* Usar max-height em vez de altura fixa */
        overflow: hidden; /* Evitar scroll no modal, só nas abas */
        display: flex;
        flex-direction: column;
        position: relative; /* Para posicionamento absoluto do botão fechar */
        padding: 20px;
    }

    /* Modal de Kit - Dimensões Otimizadas */
    #kitModal .modal-content {
        width: 98%;
        max-width: 1600px; /* Aumentar largura máxima para acomodar melhor a tabela */
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        padding: 20px;
    }
    
    /* Modal body sem scroll forçado */
    #produtoModal .modal-body,
    #editProdutoModal .modal-body {
        flex: 1;
        overflow: visible; /* Remover scroll forçado */
        padding-right: 0; /* Remover padding desnecessário */
    }

    #kitModal .modal-body {
        flex: 1;
        overflow: visible;
        padding-right: 0;
    }

    /* Campos do formulário do kit mais compactos */
    #kitModal .form-group {
        margin-bottom: 12px; /* Reduzir espaçamento entre campos */
    }

    #kitModal .form-group label {
        font-size: 13px; /* Labels menores */
        margin-bottom: 4px;
        display: block;
    }

    #kitModal .form-group input,
    #kitModal .form-group textarea {
        font-size: 13px; /* Campos menores */
        padding: 6px 8px; /* Padding reduzido */
    }

    #kitModal .form-group textarea {
        min-height: 60px; /* Altura mínima reduzida para textareas */
    }
    
    /* Ajuste do layout das abas nos modais de produtos */
    #produtoModal .tabs-container,
    #editProdutoModal .tabs-container {
        height: auto; /* Altura automática baseada no conteúdo */
        min-height: 350px; /* Manter altura mínima */
        display: flex;
        flex-direction: column;
    }

    #kitModal .tabs-container {
        height: auto;
        min-height: 350px;
        display: flex;
        flex-direction: column;
    }
    
    /* Layout principal dos modais com melhor distribuição */
    #produtoModal .modal-body > form > div[style*="display: flex"],
    #editProdutoModal .modal-body > form > div[style*="display: flex"] {
        gap: 30px !important; /* Aumentar espaçamento */
    }

    /* Layout do kit com espaçamento otimizado */
    #kitModal .modal-body > form > div[style*="display: flex"] {
        gap: 15px !important; /* Reduzir gap para maximizar espaço da tabela */
    }
    
    /* Coluna da esquerda - campos básicos */
    #produtoModal .modal-body > form > div > div:first-child,
    #editProdutoModal .modal-body > form > div > div:first-child {
        flex: 0 0 25%; /* Largura fixa de 45% */
        min-width: 400px; /* Largura mínima */
    }

    /* Coluna da esquerda do kit - otimizada */
    #kitModal .modal-body > form > div > div:first-child {
        flex: 0 0 25%; /* Reduzir ainda mais para dar mais espaço à tabela */
        min-width: 280px; /* Largura mínima suficiente para os campos */
        max-width: 320px; /* Limitar largura máxima */
    }
    
    /* Coluna da direita - abas */
    #produtoModal .modal-body > form > div > div:last-child,
    #editProdutoModal .modal-body > form > div > div:last-child {
        flex: 1; /* Ocupar espaço restante */
        min-width: 1100px; /* Largura mínima aumentada para acomodar tabela */
        overflow-x: auto; /* Permitir scroll horizontal se necessário */
    }

    /* Coluna da direita do kit - otimizada */
    #kitModal .modal-body > form > div > div:last-child {
        flex: 1;
        min-width: 1100px; /* Aumentar para dar mais espaço à tabela */
        overflow-x: hidden; /* Remover scroll horizontal */
    }
    
    /* Garantir que as tabelas dentro das abas tenham altura consistente */
    #produtoModal .materials-table-container,
    #produtoModal .etapas-table-container,
    #editProdutoModal .materials-table-container,
    #editProdutoModal .etapas-table-container {
        height: 320px !important; /* Altura aumentada para melhor aproveitamento do espaço */
        overflow-y: auto;
        overflow-x: hidden; /* Remover scroll horizontal */
        flex: 1;
        min-height: 0; /* Permitir que o flex funcione corretamente */
    }

    /* Container da tabela do kit - otimizado */
    #kitModal .materials-table-container {
        height: 320px !important;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        min-height: 0;
    }

    /* Tabela do kit com colunas otimizadas */
    #kitModal .materials-table-container table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
    }

    /* Larguras das colunas otimizadas para o kit */
    #kitModal .materials-table-container th:nth-child(1),
    #kitModal .materials-table-container td:nth-child(1) {
        width: 40%; /* Produto - mais espaço para nomes longos */
    }

    #kitModal .materials-table-container th:nth-child(2),
    #kitModal .materials-table-container td:nth-child(2) {
        width: 18%; /* Categoria */
    }

    #kitModal .materials-table-container th:nth-child(3),
    #kitModal .materials-table-container td:nth-child(3) {
        width: 10%; /* Quantidade */
    }

    #kitModal .materials-table-container th:nth-child(4),
    #kitModal .materials-table-container td:nth-child(4) {
        width: 14%; /* Preço Unit. */
    }

    #kitModal .materials-table-container th:nth-child(5),
    #kitModal .materials-table-container td:nth-child(5) {
        width: 14%; /* Total */
    }

    #kitModal .materials-table-container th:nth-child(6),
    #kitModal .materials-table-container td:nth-child(6) {
        width: 4%; /* Ações - mais compacto */
    }

    /* Texto responsivo nas células do kit */
    #kitModal .materials-table-container td {
        padding: 8px 6px; /* Aumentar padding horizontal */
        word-wrap: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Primeira coluna pode quebrar texto */
    #kitModal .materials-table-container td:first-child {
        white-space: normal;
        word-wrap: break-word;
        padding: 8px 6px;
    }

    /* Headers da tabela do kit */
    #kitModal .materials-table-container th {
        padding: 10px 6px;
        font-size: 14px;
        font-weight: 600;
    }

    .tabs-container {
        margin-bottom: 15px;
        min-height: 450px; /* Altura mínima aumentada para melhor aproveitamento */
        display: flex;
        flex-direction: column;
    }
    
    .tabs-header {
        display: flex;
        border-bottom: 2px solid rgba(155, 100, 227, 0.3);
        margin-bottom: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px 8px 0 0;
        overflow: hidden;
    }
    
    .tab-button {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        border-right: 1px solid rgba(155, 100, 227, 0.2);
    }
    
    .tab-button:last-child {
        border-right: none;
    }
    
    .tab-button:hover {
        background: rgba(155, 100, 227, 0.1);
        color: rgba(255, 255, 255, 0.9);
        transform: translateY(-1px);
    }
    
    .tab-button.active {
        background: rgba(155, 100, 227, 0.2);
        color: #D8CEFE;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(155, 100, 227, 0.3);
    }
    
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #9B64E3, #D8CEFE);
        animation: tabSlideIn 0.3s ease;
    }
    
    @keyframes tabSlideIn {
        from {
            transform: scaleX(0);
        }
        to {
            transform: scaleX(1);
        }
    }
    
    .tab-button svg {
        transition: all 0.3s ease;
    }
    
    .tab-button:hover svg {
        transform: scale(1.1);
    }
    
    .tab-button.active svg {
        transform: scale(1.1);
        filter: drop-shadow(0 0 4px rgba(155, 100, 227, 0.8));
    }
    
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
        min-height: 300px; /* Altura mínima em vez de fixa */
        width: 100%;
        min-width: 1050px; /* Largura mínima para tabelas */
        overflow: visible; /* Permitir overflow natural */
        flex: 1; /* Ocupar espaço disponível */
    }
    
    .tab-content.active {
        display: flex; /* Usar flex para melhor controle */
        flex-direction: column;
    }
    
    /* Container das tabelas dentro das abas com altura otimizada */
    .materials-table-container,
    .etapas-table-container {
        height: 320px !important; /* Altura aumentada para melhor aproveitamento do espaço */
        overflow-y: auto;
        overflow-x: auto; /* Permitir scroll horizontal quando necessário */
        flex: 1;
        min-width: 1050px; /* Largura mínima para garantir visibilidade das colunas */
        width: 100%;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Melhorias nas tabelas de materiais e etapas */
    .materials-table-container table,
    .etapas-table-container table {
        width: 100%;
        min-width: 1050px; /* Largura mínima aumentada para garantir visibilidade de todas as colunas */
        table-layout: auto; /* Layout automático para melhor ajuste */
        border-collapse: collapse;
    }
    
    /* Remover larguras fixas que causam scroll horizontal */
    .materials-table-container th,
    .etapas-table-container th {
        padding: 8px;
        text-align: center;
        white-space: nowrap;
    }
    
    /* Larguras proporcionais em vez de fixas */
    .materials-table-container th:nth-child(1) { min-width: 140px; } /* Material */
    .materials-table-container th:nth-child(2) { min-width: 70px; }  /* Tipo */
    .materials-table-container th:nth-child(3) { min-width: 80px; }  /* Qtd. Disp. */
    .materials-table-container th:nth-child(4) { min-width: 80px; }  /* Qtd. Nec. */
    .materials-table-container th:nth-child(5) { min-width: 120px; } /* Dimensões */
    .materials-table-container th:nth-child(6) { min-width: 90px; }  /* Área */
    .materials-table-container th:nth-child(7) { min-width: 110px; } /* Custo/m² */
    .materials-table-container th:nth-child(8) { min-width: 90px; }  /* Total */
    .materials-table-container th:nth-child(9) { min-width: 100px; } /* Ações - aumentado */
    
    /* Larguras mínimas para células de dados (td) - mesmo padrão dos cabeçalhos */
    .materials-table-container td:nth-child(1) { min-width: 140px; } /* Material */
    .materials-table-container td:nth-child(2) { min-width: 70px; }  /* Tipo */
    .materials-table-container td:nth-child(3) { min-width: 80px; }  /* Qtd. Disp. */
    .materials-table-container td:nth-child(4) { min-width: 80px; }  /* Qtd. Nec. */
    .materials-table-container td:nth-child(5) { min-width: 120px; } /* Dimensões */
    .materials-table-container td:nth-child(6) { min-width: 90px; }  /* Área */
    .materials-table-container td:nth-child(7) { min-width: 110px; } /* Custo/m² */
    .materials-table-container td:nth-child(8) { min-width: 90px; }  /* Total */
    .materials-table-container td:nth-child(9) { min-width: 100px; } /* Ações */
    
    /* Larguras proporcionais para etapas */
    .etapas-table-container th:nth-child(1) { min-width: 100px; } /* Etapa */
    .etapas-table-container th:nth-child(2) { min-width: 80px; }  /* Tipo */
    .etapas-table-container th:nth-child(3) { min-width: 120px; } /* Equipamento */
    .etapas-table-container th:nth-child(4) { min-width: 120px; } /* Material */
    .etapas-table-container th:nth-child(5) { min-width: 90px; }  /* Tempo */
    .etapas-table-container th:nth-child(6) { min-width: 90px; }  /* Custo */
    .etapas-table-container th:nth-child(7) { min-width: 100px; } /* Ações */
    
    /* Células com melhor comportamento */
    .materials-table-container td,
    .etapas-table-container td {
        padding: 6px !important;
        word-wrap: break-word;
        vertical-align: middle;
        white-space: nowrap; /* Evitar quebra de linha desnecessária */
    }
    
    /* Primeira coluna pode quebrar texto */
    .materials-table-container td:first-child,
    .etapas-table-container td:first-child {
        white-space: normal;
        word-wrap: break-word;
        max-width: 150px;
    }
    
    /* Inputs ajustados */
    .materials-table-container input,
    .etapas-table-container input {
        width: 100% !important;
        min-width: 60px;
        box-sizing: border-box;
        font-size: 12px;
        padding: 4px 6px;
    }

    /* Responsividade para abas em telas menores */
    @media (max-width: 768px) {
        .tab-button {
            font-size: 12px;
            padding: 10px 15px;
            flex-direction: column;
            gap: 4px;
        }
        
        .tab-button svg {
            width: 14px;
            height: 14px;
        }
        
        /* Ajustar modais em telas pequenas */
        #produtoModal .modal-content,
        #editProdutoModal .modal-content {
            width: 99%;
            height: 90vh;
            max-width: none;
        }

        /* Modal do kit em telas pequenas */
        #kitModal .modal-content {
            width: 98%;
            height: 95vh;
            max-width: none;
        }
        
        /* Layout em coluna única em telas pequenas */
        #produtoModal .modal-body > form > div[style*="display: flex"],
        #editProdutoModal .modal-body > form > div[style*="display: flex"] {
            flex-direction: column !important;
        }

        #kitModal .modal-body > form > div[style*="display: flex"] {
            flex-direction: column !important;
        }
        
        #produtoModal .modal-body > form > div > div,
        #editProdutoModal .modal-body > form > div > div {
            flex: none !important;
            min-width: auto !important;
        }

        #kitModal .modal-body > form > div > div {
            flex: none !important;
            min-width: auto !important;
        }
        
        /* Tabelas com scroll horizontal em telas pequenas */
        .materials-table-container,
        .etapas-table-container {
            overflow-x: auto;
        }
    }

    .produtos-list-container {
        margin-top: 20px;
    }

    .produtos-item {
        display: grid;
        grid-template-columns: 0.8fr 1.5fr 1fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr;
        gap: 15px;
        padding: 12px 20px;
        margin: 8px 0;
        border-radius: 6px;
        transition: background-color 0.2s ease;
        align-items: center;
    }

    .produtos-item:hover {
        background-color: var(--order-card-hover-bg);
    }

    /* Ajuste específico do botão fechar para modais de produtos */
    #produtoModal .close-button,
    #editProdutoModal .close-button,
    #kitModal .close-button {
        position: absolute;
        top: 15px;
        right: 20px;
        z-index: 1000;
        font-size: 28px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: all 0.3s ease;
        background: none;
        border: none;
        padding: 5px;
        line-height: 1;
    }
    
    #produtoModal .close-button:hover,
    #editProdutoModal .close-button:hover,
    #kitModal .close-button:hover {
        color: #9B64E3;
        text-shadow: 0 0 8px rgba(155, 100, 227, 0.8);
        transform: scale(1.1);
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
        color: var(--action-icon-color);
    }

    /* Estilos para badges de status */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-ativo {
        background-color: rgba(46, 213, 115, 0.2);
        color: #2ED573;
        border: 1px solid #2ED573;
    }

    .status-inativo {
        background-color: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid #e74c3c;
    }

    /* Estilos para botões de ação */
    .btn-acao {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-acao:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-editar:hover {
        background: rgba(52, 152, 219, 0.3);
        border-color: #3498db;
    }

    .btn-duplicar:hover {
        background: rgba(155, 89, 182, 0.3);
        border-color: #9b59b6;
    }

    .btn-excluir:hover {
        background: rgba(231, 76, 60, 0.3);
        border-color: #e74c3c;
    }

    /* Ajuste para as linhas da lista de produtos */
    .produto-row:hover {
        background-color: rgba(155, 100, 227, 0.1);
        transition: background-color 0.2s ease;
    }

    .action-btn:hover {
        background-color: rgba(155, 100, 227, 0.2);
        color: var(--cor-destaque, #9B64E3);
    }

    .action-btn[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 5px;
    }

    :root {
        --action-icon-color: #9B64E3;
        --order-card-hover-bg: rgba(155, 100, 227, 0.1);
    }

    /* ===== ESTILOS PARA MODAL DE ATUALIZAÇÃO DE PREÇOS ===== */
    .price-update-table {
        font-size: 13px;
    }

    .price-update-table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--cor-destaque, #9B64E3);
    }

    .price-update-table td {
        padding: 10px 8px;
        border-bottom: 1px solid rgba(155, 100, 227, 0.1);
        vertical-align: middle;
    }

    .price-update-table tr:hover {
        background-color: rgba(155, 100, 227, 0.05);
    }

    .price-update-table tr.selected {
        background-color: rgba(155, 100, 227, 0.1);
        border-left: 3px solid var(--cor-destaque, #9B64E3);
    }

    .price-variation {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    .price-variation.positive {
        color: #ff4757;
        background-color: rgba(255, 71, 87, 0.1);
    }

    .price-variation.negative {
        color: #2ed573;
        background-color: rgba(46, 213, 115, 0.1);
    }

    .impact-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .impact-badge.alto {
        background-color: rgba(255, 71, 87, 0.2);
        color: #ff4757;
        border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .impact-badge.medio {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .impact-badge.baixo {
        background-color: rgba(46, 213, 115, 0.2);
        color: #2ed573;
        border: 1px solid rgba(46, 213, 115, 0.3);
    }

    /* Estilo para o badge de causas com tooltip dinâmico */
    .cause-tooltip-dynamic {
        position: relative;
        display: inline-block;
        padding: 4px 12px;
        background-color: rgba(155, 100, 227, 0.2);
        border: 1px solid #9B64E3;
        border-radius: 12px;
        font-size: 12px;
        color: #9B64E3;
        cursor: help;
        transition: all 0.3s ease;
    }

    .cause-tooltip-dynamic:hover {
        background-color: rgba(155, 100, 227, 0.3);
        border-color: #7b4dc7;
        color: #d8cefe;
        transform: translateY(-1px);
    }

    /* Tooltip que segue o cursor */
    .cursor-cause-tooltip {
        position: fixed;
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.95));
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        white-space: pre-line;
        z-index: 999999;
        pointer-events: none;
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.2s ease, transform 0.2s ease;
        max-width: 250px;
        border: 1px solid rgba(155, 100, 227, 0.4);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(155, 100, 227, 0.2);
        backdrop-filter: blur(10px);
        text-align: center;
        line-height: 1.4;
    }

    .cursor-cause-tooltip.show {
        opacity: 1;
        transform: scale(1);
    }

    .cursor-cause-tooltip::before {
        content: '';
        position: absolute;
        top: -5px;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-bottom-color: rgba(0, 0, 0, 0.95);
    }

    .cause-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background-color: rgba(155, 100, 227, 0.1);
        border: 1px solid rgba(155, 100, 227, 0.3);
        border-radius: 6px;
        font-size: 10px;
        color: #d8cefe;
        margin: 1px;
    }

    .cause-chip.material {
        background-color: rgba(255, 71, 87, 0.1);
        border-color: rgba(255, 71, 87, 0.3);
        color: #ff4757;
    }

    .cause-chip.maquina {
        background-color: rgba(46, 213, 115, 0.1);
        border-color: rgba(46, 213, 115, 0.3);
        color: #2ed573;
    }

    /* Estilos dos botões do modal de preços */
    .btn-recalculate {
        position: relative;
        overflow: hidden;
    }

    .btn-recalculate:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
    }

    .btn-confirm {
        position: relative;
        overflow: hidden;
    }

    .btn-confirm:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(46, 213, 115, 0.3);
    }

    .btn-confirm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    .btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.3);
    }

    /* Animações para cards de resumo */
    .summary-card {
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* Estilos para filtros */
    .price-update-filters select,
    .price-update-filters input {
        transition: border-color 0.3s ease;
    }

    .price-update-filters select:focus,
    .price-update-filters input:focus {
        outline: none;
        border-color: var(--cor-destaque, #9B64E3);
        box-shadow: 0 0 0 2px rgba(155, 100, 227, 0.2);
    }

    /* Scrollbar para tabela de preços */
    .price-update-table-container::-webkit-scrollbar {
        width: 8px;
    }

    .price-update-table-container::-webkit-scrollbar-track {
        background: rgba(155, 100, 227, 0.1);
        border-radius: 4px;
    }

    .price-update-table-container::-webkit-scrollbar-thumb {
        background: rgba(155, 100, 227, 0.3);
        border-radius: 4px;
        transition: background 0.3s ease;
    }

    .price-update-table-container::-webkit-scrollbar-thumb:hover {
        background: rgba(155, 100, 227, 0.5);
    }

    /* ===== ESTILOS PARA CHECKBOXES DO MODAL DE SELEÇÃO DE PRODUTOS PARA KIT ===== */
    #produtosKitList input[type="checkbox"],
    #selectAllProdutosKit {
        width: auto;
        margin-right: 8px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid #9B64E3;
        border-radius: 3px;
        background-color: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        position: relative;
        vertical-align: middle;
        transition: all 0.2s ease;
    }
    
    #produtosKitList input[type="checkbox"]:checked,
    #selectAllProdutosKit:checked {
        background-color: #9B64E3;
        border-color: #9B64E3;
    }
    
    #produtosKitList input[type="checkbox"]:checked::after,
    #selectAllProdutosKit:checked::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    #produtosKitList input[type="checkbox"]:hover,
    #selectAllProdutosKit:hover {
        background-color: rgba(155, 100, 227, 0.2);
        border-color: #B884F0;
        box-shadow: 0 0 8px rgba(155, 100, 227, 0.3);
    }

    /* ===== ESTILOS PARA SCROLLBAR DO MODAL DE SELEÇÃO DE PRODUTOS PARA KIT ===== */
    #selecionarProdutosModal .modal-body {
        scrollbar-width: thin;
        scrollbar-color: rgba(155, 100, 227, 0.6) rgba(255, 255, 255, 0.1);
    }

    #selecionarProdutosModal .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    #selecionarProdutosModal .modal-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    #selecionarProdutosModal .modal-body::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(155, 100, 227, 0.8), rgba(155, 100, 227, 0.6));
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
    }

    #selecionarProdutosModal .modal-body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, rgba(155, 100, 227, 1), rgba(155, 100, 227, 0.8));
        box-shadow: 0 0 8px rgba(155, 100, 227, 0.4);
    }

    /* Estilo adicional para a tabela de produtos do kit */
    #produtosKitList {
        max-height: 400px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(155, 100, 227, 0.6) rgba(255, 255, 255, 0.1);
    }

    #produtosKitList::-webkit-scrollbar {
        width: 6px;
    }

    #produtosKitList::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    #produtosKitList::-webkit-scrollbar-thumb {
        background: rgba(155, 100, 227, 0.7);
        border-radius: 3px;
        transition: all 0.2s ease;
    }

    #produtosKitList::-webkit-scrollbar-thumb:hover {
        background: rgba(155, 100, 227, 0.9);
    }

</style>

<script>
    // Função global para limpar todos os modais e overlays
    function limparTodosModaisEOverlays() {
        // Fechar todos os modais
        const modais = document.querySelectorAll('.modal');
        modais.forEach(modal => {
            modal.style.display = 'none';
        });
        
        // Fechar todos os overlays
        const overlays = document.querySelectorAll('.overlay');
        overlays.forEach(overlay => {
            overlay.style.display = 'none';
        });
        
        // Resetar flags de carregamento
        window.isLoadingEditModal = false;
        window.editModalReady = false;
        
        console.log('✅ Todos os modais e overlays foram limpos');
    }
    
    // Expor função globalmente para uso em outros arquivos
    window.limparTodosModaisEOverlays = limparTodosModaisEOverlays;

    // =============================================
    // SISTEMA DE MENU DE CONTEXTO E CONFIRMAÇÃO
    // =============================================
    
    let currentMaterialRow = null; // Armazenar referência da linha atual
    let tooltipTimeout = null;
    
    // Função para mostrar tooltip temporário ao lado do cursor
    function showCursorTooltip(event) {
        const tooltip = document.getElementById('cursorTooltip');
        
        // Posicionar tooltip próximo ao cursor
        const offsetX = 15;
        const offsetY = -10;
        
        tooltip.style.left = (event.clientX + offsetX) + 'px';
        tooltip.style.top = (event.clientY + offsetY) + 'px';
        tooltip.classList.add('show');
        
        // Esconder após 2 segundos
        if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
        }
        
        tooltipTimeout = setTimeout(() => {
            tooltip.classList.remove('show');
        }, 2000);
    }
    
    // Função para esconder tooltip
    function hideCursorTooltip() {
        const tooltip = document.getElementById('cursorTooltip');
        tooltip.classList.remove('show');
        
        if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = null;
        }
    }
    
    // Função para mostrar o menu de contexto
    function showContextMenu(event, row) {
        event.preventDefault();
        
        currentMaterialRow = row;
        const contextMenu = document.getElementById('contextMenu');
        
        // Esconder tooltip se estiver visível
        hideCursorTooltip();
        
        // Posicionar o menu próximo ao cursor
        const x = event.clientX;
        const y = event.clientY;
        
        // Verificar limites da tela
        const menuWidth = 160;
        const menuHeight = 50;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        let left = x;
        let top = y;
        
        // Ajustar posição se sair da tela
        if (x + menuWidth > windowWidth) {
            left = x - menuWidth;
        }
        if (y + menuHeight > windowHeight) {
            top = y - menuHeight;
        }
        
        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';
        contextMenu.classList.add('show');
        
        // Adicionar feedback visual na linha
        row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
        row.style.transform = 'scale(0.98)';
    }
    
    // Função para esconder o menu de contexto
    function hideContextMenu() {
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.classList.remove('show');
        
        // Restaurar estilo da linha se ainda existe
        if (currentMaterialRow) {
            currentMaterialRow.style.backgroundColor = '';
            currentMaterialRow.style.transform = '';
        }
    }
    
    // Função para confirmar remoção (abre modal)
    function confirmRemoveMaterial() {
        hideContextMenu();
        
        if (!currentMaterialRow) return;
        
        // Obter nome do material para mostrar no modal
        const materialNameCell = currentMaterialRow.querySelector('.material-name-cell');
        const materialName = materialNameCell ? materialNameCell.textContent.trim() : 'este material';
        
        // Atualizar mensagem do modal
        const messageElement = document.querySelector('.confirmation-modal-message');
        messageElement.innerHTML = `Deseja remover <strong>"${materialName}"</strong> da lista? Esta ação não pode ser desfeita.`;
        
        // Mostrar modal
        const modal = document.getElementById('confirmationModal');
        modal.classList.add('show');
    }
    
    // Função para fechar modal de confirmação
    function closeConfirmationModal() {
        const modal = document.getElementById('confirmationModal');
        modal.classList.remove('show');
        
        // Restaurar estilo da linha
        if (currentMaterialRow) {
            currentMaterialRow.style.backgroundColor = '';
            currentMaterialRow.style.transform = '';
            currentMaterialRow = null;
        }
    }
    
    // Função para executar a remoção
    function executeMaterialRemoval() {
        if (!currentMaterialRow) {
            closeConfirmationModal();
            return;
        }
        
        // Efeito visual de remoção
        currentMaterialRow.style.transition = 'all 0.3s ease';
        currentMaterialRow.style.opacity = '0';
        currentMaterialRow.style.transform = 'translateX(-20px) scale(0.9)';
        
        setTimeout(() => {
            // Encontrar botão de remoção na linha e executar remoção
            const removeButton = currentMaterialRow.querySelector('.action-btn');
            if (removeButton) {
                // Verificar se estamos no modal de edição ou novo produto
                const isEditMode = document.getElementById('editProdutoModal').style.display === 'block';
                
                if (isEditMode) {
                    // Para modal de edição, usar removerMaterialEdit com o índice
                    const tbody = currentMaterialRow.closest('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const index = rows.indexOf(currentMaterialRow);
                    
                    if (index >= 0) {
                        removerMaterialEdit(index);
                    }
                } else {
                    // Para modal de novo produto, usar função padrão
                    removerMaterialDaTabela(removeButton);
                }
            }
            
            closeConfirmationModal();
            currentMaterialRow = null;
            
            // Mostrar mensagem de sucesso
            if (typeof mostrarMensagem === 'function') {
                mostrarMensagem('Material removido com sucesso!', 'sucesso');
            }
        }, 300);
    }
    
    // Event listeners globais
    document.addEventListener('click', function(event) {
        // Fechar menu de contexto ao clicar fora
        if (!event.target.closest('.context-menu')) {
            hideContextMenu();
        }
        
        // Fechar modal ao clicar fora
        if (event.target.classList.contains('confirmation-modal')) {
            closeConfirmationModal();
        }
    });
    
    // Fechar menu com ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hideContextMenu();
            closeConfirmationModal();
        }
    });

    // =============================================
    // SISTEMA DE ABAS - JAVASCRIPT
    // =============================================
    
    function initializeTabs(contextSelector = null) {
        console.log('🔧 Inicializando sistema de abas...');
        
        // Determinar o contexto - se fornecido, usar apenas esse modal
        const context = contextSelector ? document.getElementById(contextSelector) : document;
        
        // Configurar todos os botões de aba no contexto
        context.querySelectorAll('.tab-button').forEach(button => {
            // Remover listeners existentes para evitar duplicatas
            button.removeEventListener('click', tabClickHandler);
            button.addEventListener('click', tabClickHandler);
        });
        
        // Ativar primeira aba por padrão em cada container do contexto
        context.querySelectorAll('.tabs-container').forEach(container => {
            const firstButton = container.querySelector('.tab-button');
            if (firstButton) {
                const tabName = firstButton.getAttribute('data-tab');
                switchTab(tabName, firstButton);
            }
        });
    }
    
    // Handler separado para clicks de aba
    function tabClickHandler() {
        const tabName = this.getAttribute('data-tab');
        switchTab(tabName, this);
    }
    
    function switchTab(tabName, clickedButton) {
        // Encontrar o container pai da aba
        const tabContainer = clickedButton.closest('.tabs-container');
        if (!tabContainer) return;
        
        // Remover classe active de todos os botões neste container
        tabContainer.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // Adicionar classe active ao botão clicado
        clickedButton.classList.add('active');
        
        // Esconder todos os conteúdos de aba neste container
        tabContainer.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Mostrar o conteúdo da aba selecionada
        const targetTab = document.getElementById(tabName + '-tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // Feedback visual
        clickedButton.style.transform = 'scale(0.98)';
        setTimeout(() => {
            clickedButton.style.transform = '';
        }, 150);
        
        // Log para debug
        console.log(`📋 Aba alterada para: ${tabName}`);
    }
    
    // Função para alternar programaticamente para uma aba específica
    function activateTab(tabName, contextSelector = null) {
        const context = contextSelector ? document.getElementById(contextSelector) : document;
        const button = context.querySelector(`[data-tab="${tabName}"]`);
        if (button) {
            switchTab(tabName, button);
        }
    }
    
    // Função para obter a aba ativa em um container específico
    function getActiveTab(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return null;
        
        const activeButton = container.querySelector('.tab-button.active');
        return activeButton ? activeButton.getAttribute('data-tab') : null;
    }

    // =============================================
    // INTEGRAÇÃO REAL COM O SISTEMA DE PRODUTOS
    // =============================================

    // Função para detectar mudanças de custos automaticamente
    async function detectarMudancasCustos() {
        try {
            const response = await fetch('/api/produtos/verificar-mudancas-custos', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.produtos_afetados && data.produtos_afetados.length > 0) {
                // Abrir modal com produtos afetados
                abrirModalAtualizacaoPrecos(
                    data.produtos_afetados,
                    data.materiais_alterados || [],
                    data.maquinas_alteradas || []
                );
                return true;
            }
            
            return false;
            
        } catch (error) {
            console.error('Erro ao detectar mudanças de custos:', error);
            showNotification('Erro ao verificar mudanças de custos', 'error');
            return false;
        }
    }

    // Função para calcular novos preços baseado em alterações
    async function calcularNovosPrecos(materiaisAlterados, maquinasAlteradas) {
        try {
            const response = await fetch('/api/produtos/calcular-novos-precos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    materiais_alterados: materiaisAlterados,
                    maquinas_alteradas: maquinasAlteradas
                })
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            return data.produtos_afetados || [];
            
        } catch (error) {
            console.error('Erro ao calcular novos preços:', error);
            throw new Error('Erro ao recalcular preços: ' + error.message);
        }
    }

    // Função para aplicar atualização de preços no banco de dados
    async function aplicarAtualizacaoPrecos(produtosSelecionados) {
        try {
            const response = await fetch('/api/produtos/atualizar-precos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    produtos: produtosSelecionados.map(produto => ({
                        id: produto.id,
                        novo_preco: produto.novo_preco,
                        preco_anterior: produto.preco_atual
                    }))
                })
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            return data;
            
        } catch (error) {
            console.error('Erro ao aplicar atualização de preços:', error);
            throw new Error('Erro ao atualizar preços: ' + error.message);
        }
    }

    // Hook para ser chamado quando custos de materiais/máquinas forem alterados
    function onCustoMaterialOuMaquinaAlterado(tipo, itemId, custoAnterior, custoNovo) {
        console.log(`🔄 Custo alterado - ${tipo} ID: ${itemId}, De: ${custoAnterior}, Para: ${custoNovo}`);
        
        // Verificar se a mudança é real (> 0%)
        const variacao = Math.abs((custoNovo - custoAnterior) / custoAnterior * 100);
        
        if (variacao > 0) {  // Mudança maior que 0%
            console.log(`⚠️ Mudança detectada (${variacao.toFixed(2)}%)`);
            
            // Aguardar um pouco para permitir outras alterações em lote
            setTimeout(async () => {
                const temMudancas = await detectarMudancasCustos();
                if (temMudancas) {
                    showNotification('Mudanças de custos detectadas! Verifique os impactos nos preços dos produtos.', 'warning');
                }
            }, 2000);
        }
    }

    // Função para monitorar mudanças de custos em tempo real
    function iniciarMonitoramentoCustos() {
        // Verificar mudanças a cada 5 minutos
        setInterval(async () => {
            const temMudancas = await detectarMudancasCustos();
            if (temMudancas) {
                showNotification('Novas mudanças de custos detectadas!', 'info');
            }
        }, 5 * 60 * 1000); // 5 minutos
    }

    // Função auxiliar para obter produtos do sistema atual
    async function obterTodosProdutos() {
        try {
            const response = await fetch('/api/produtos/listar', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            return await response.json();
            
        } catch (error) {
            console.error('Erro ao obter produtos:', error);
            return [];
        }
    }

    // Função para recalcular um produto específico
    async function recalcularPrecoProduto(produtoId) {
        try {
            const response = await fetch(`/api/produtos/${produtoId}/recalcular-preco`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            return await response.json();
            
        } catch (error) {
            console.error('Erro ao recalcular preço do produto:', error);
            throw error;
        }
    }

    // Função para integrar com o sistema de edição de materiais
    function integrarComEdicaoMateriais() {
        // Buscar formulários de edição de materiais
        const formsMateriais = document.querySelectorAll('form[id*="material"], form[id*="Material"]');
        
        formsMateriais.forEach(form => {
            form.addEventListener('submit', function(event) {
                // Capturar dados antes da submissão
                const custoAnterior = parseFloat(form.querySelector('input[name*="preco"], input[name*="custo"]')?.dataset.valorOriginal || 0);
                const custoNovo = parseFloat(form.querySelector('input[name*="preco"], input[name*="custo"]')?.value || 0);
                const materialId = form.querySelector('input[name*="id"]')?.value;
                
                if (materialId && custoAnterior !== custoNovo) {
                    // Disparar hook após sucesso da submissão
                    setTimeout(() => {
                        onCustoMaterialOuMaquinaAlterado('material', materialId, custoAnterior, custoNovo);
                    }, 1000);
                }
            });
        });
    }

    // Função para integrar com o sistema de edição de máquinas
    function integrarComEdicaoMaquinas() {
        // Buscar formulários de edição de máquinas
        const formsMaquinas = document.querySelectorAll('form[id*="maquina"], form[id*="Maquina"]');
        
        formsMaquinas.forEach(form => {
            form.addEventListener('submit', function(event) {
                // Capturar dados antes da submissão
                const custoAnterior = parseFloat(form.querySelector('input[name*="hora_maquina"], input[name*="custo"]')?.dataset.valorOriginal || 0);
                const custoNovo = parseFloat(form.querySelector('input[name*="hora_maquina"], input[name*="custo"]')?.value || 0);
                const maquinaId = form.querySelector('input[name*="id"]')?.value;
                
                if (maquinaId && custoAnterior !== custoNovo) {
                    // Disparar hook após sucesso da submissão
                    setTimeout(() => {
                        onCustoMaterialOuMaquinaAlterado('maquina', maquinaId, custoAnterior, custoNovo);
                    }, 1000);
                }
            });
        });
    }

    // Função de inicialização do sistema de monitoramento
    function inicializarSistemaAtualizacaoPrecos() {
        console.log('🚀 Inicializando sistema de atualização automática de preços...');
        
        // Integrar com formulários existentes
        integrarComEdicaoMateriais();
        integrarComEdicaoMaquinas();
        
        // Iniciar monitoramento periódico
        iniciarMonitoramentoCustos();
        
        // Verificar mudanças na inicialização
        setTimeout(detectarMudancasCustos, 5000);
        
        console.log('✅ Sistema de atualização de preços inicializado!');
    }

    // =============================================
    // FUNÇÕES DE FALLBACK PARA DESENVOLVIMENTO
    // =============================================

    // Função para simular detecção quando endpoints não existem
    async function detectarMudancasCustosFallback() {
        console.log('🧪 Modo de desenvolvimento: simulando detecção de mudanças...');
        
        // Simular produtos afetados baseado no sistema atual
        const produtosSimulados = await gerarProdutosSimuladosDoSistema();
        
        if (produtosSimulados.length > 0) {
            abrirModalAtualizacaoPrecos(
                produtosSimulados,
                ['Aço Inox', 'Alumínio'],
                ['Corte a Laser', 'Dobradeira']
            );
            return true;
        }
        
        showNotification('Nenhuma mudança de custo detectada', 'info');
        return false;
    }

    // Função para gerar produtos simulados baseado no sistema real
    async function gerarProdutosSimuladosDoSistema() {
        try {
            // Tentar obter produtos reais do sistema
            const produtos = await obterTodosProdutos();
            
            if (produtos.length === 0) {
                // Fallback para dados simulados
                return [
                    {
                        id: 1,
                        nome: 'Produto A',
                        categoria: 'Categoria 1',
                        preco_atual: 150.00,
                        novo_preco: 165.50,
                        materiais_alterados: ['Aço Inox'],
                        maquinas_alteradas: [],
                        selecionado: false
                    },
                    {
                        id: 2,
                        nome: 'Produto B',
                        categoria: 'Categoria 2',
                        preco_atual: 89.90,
                        novo_preco: 92.15,
                        materiais_alterados: ['Alumínio'],
                        maquinas_alteradas: ['Corte a Laser'],
                        selecionado: false
                    }
                ];
            }
            
            // Processar produtos reais
            return produtos.slice(0, 5).map((produto, index) => ({
                id: produto.id,
                nome: produto.nome || `Produto ${index + 1}`,
                categoria: produto.categoria || 'Sem categoria',
                preco_atual: parseFloat(produto.preco || 100 + index * 50),
                novo_preco: parseFloat(produto.preco || 100 + index * 50) * (1 + (Math.random() * 0.2 - 0.1)), // Variação de ±10%
                materiais_alterados: ['Material ' + (index + 1)],
                maquinas_alteradas: index % 2 === 0 ? ['Máquina ' + (index + 1)] : [],
                selecionado: false
            }));
            
        } catch (error) {
            console.error('Erro ao gerar produtos simulados:', error);
            return [];
        }
    }

    // Modificar função existente para usar endpoint real ou fallback
    async function detectarMudancasCustosComFallback() {
        try {
            // Tentar usar endpoint real primeiro
            return await detectarMudancasCustos();
        } catch (error) {
            console.log('📡 Endpoint não disponível, usando modo de desenvolvimento');
            return await detectarMudancasCustosFallback();
        }
    }

    // ...existing code...

    // =============================================
    // DOCUMENTAÇÃO DE INTEGRAÇÃO
    // =============================================

    /*
    COMO INTEGRAR O SISTEMA DE ATUALIZAÇÃO DE PREÇOS:

    1. DETECÇÃO AUTOMÁTICA:
       - Chame onCustoMaterialOuMaquinaAlterado('material', 'Nome do Material') 
         sempre que o custo de um material for alterado
       - Chame onCustoMaterialOuMaquinaAlterado('maquina', 'Nome da Máquina') 
         sempre que o custo de uma máquina for alterado

    2. DETECÇÃO MANUAL:
       - Use detectarMudancasCustos(['material1', 'material2'], ['maquina1']) 
         para verificar impactos manualmente

    3. ABERTURA DIRETA DO MODAL:
       - Use abrirModalAtualizacaoPrecos(produtos, materiais, maquinas) 
         para abrir o modal com dados específicos

    EXEMPLO DE USO:
    
    // Quando um material é editado:
    async function salvarMaterial(materialData) {
        const resultado = await fetch('/api/materiais', { ... });
        if (resultado.success) {
            // Verificar se o preço foi alterado
            if (materialData.preco_alterado) {
                onCustoMaterialOuMaquinaAlterado('material', materialData.nome);
            }
        }
    }

    // Quando uma máquina é editada:
    async function salvarMaquina(maquinaData) {
        const resultado = await fetch('/api/maquinas', { ... });
        if (resultado.success) {
            // Verificar se o custo por hora foi alterado
            if (maquinaData.hora_maquina_alterada) {
                onCustoMaterialOuMaquinaAlterado('maquina', maquinaData.nome);
            }
        }
    }
    */

    // =============================================
    // SISTEMA DE NOTIFICAÇÕES (COMPATIBILIDADE)
    // =============================================

    // Função de fallback para notificações caso não exista mostrarMensagem
    function showNotification(message, type = 'info') {
        // Chamar a função unificada com os parâmetros corretos
        const tipoMap = {
            'info': 'info',
            'success': 'success',
            'warning': 'warning',
            'error': 'error'
        };
        showNotificationModal(tipoMap[type] || 'info', message);
    }

    // =============================================
    // FUNÇÕES DE INTEGRAÇÃO COM O BACKEND
    // =============================================

    // Função para detectar mudanças de custos (chama backend real)
    async function detectarMudancasCustos(materiaisAlterados = [], maquinasAlteradas = []) {
        try {
            const response = await fetch('/api/precos/detectar-mudancas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    materiais_alterados: materiaisAlterados,
                    maquinas_alteradas: maquinasAlteradas
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                // Corrigir cálculos de custos proporcionais para materiais dimensionais
                const produtosCorrigidos = await corrigirCustosProdutosDimensionais(data.produtos_afetados);
                return produtosCorrigidos;
            } else {
                throw new Error(data.message || 'Erro ao detectar mudanças');
            }
        } catch (error) {
            console.error('Erro ao detectar mudanças:', error);
            throw error;
        }
    }

    // Função para corrigir cálculos de custos proporcionais para materiais dimensionais
    async function corrigirCustosProdutosDimensionais(produtosAfetados) {
        try {
            const produtosCorrigidos = [];
            
            for (const produto of produtosAfetados) {
                try {
                    // Obter detalhes do produto incluindo materiais e suas especificações
                    const response = await fetch(`/api/produtos/${produto.id}/detalhes-calculo`);
                    
                    if (response.ok) {
                        const detalhes = await response.json();
                        
                        // Recalcular preço considerando área proporcional para materiais dimensionais
                        const novoPrecoCorrigido = await recalcularPrecoComProporcionalidade(produto, detalhes);
                        
                        // Calcular variação após recálculo
                        const variacaoRecalculada = ((novoPrecoCorrigido - produto.preco_atual) / produto.preco_atual * 100);
                        
                        console.log(`[DEBUG] Produto ${produto.nome} após recálculo:`);
                        console.log(`  - Preço original: R$ ${produto.preco_atual}`);
                        console.log(`  - Preço recalculado: R$ ${novoPrecoCorrigido}`);
                        console.log(`  - Variação recalculada: ${variacaoRecalculada.toFixed(6)}%`);
                        
                        // Só incluir se a variação for significativa (> 0%)
                        if (Math.abs(variacaoRecalculada) > 0) {
                            console.log(`  ✅ INCLUÍDO - variação ${variacaoRecalculada.toFixed(3)}% > 0%`);
                            produtosCorrigidos.push({
                                ...produto,
                                novo_preco: novoPrecoCorrigido,
                                variacao_percentual: variacaoRecalculada
                            });
                        } else {
                            console.log(`  ❌ FILTRADO - variação ${variacaoRecalculada.toFixed(3)}% <= 0% (não significativa)`);
                        }
                        // Se a variação ficou < 1% após recálculo, não incluir o produto
                    } else {
                        console.warn(`Não foi possível obter detalhes do produto ${produto.id}, mantendo cálculo original`);
                        produtosCorrigidos.push(produto);
                    }
                } catch (error) {
                    console.error(`Erro ao processar produto ${produto.id}:`, error);
                    // Em caso de erro, manter produto original
                    produtosCorrigidos.push(produto);
                }
            }
            
            return produtosCorrigidos;
        } catch (error) {
            console.error('Erro ao corrigir custos proporcionais:', error);
            // Em caso de erro, retornar dados originais
            return produtosAfetados;
        }
    }

    // Função para recalcular preço com proporcionalidade correta
    async function recalcularPrecoComProporcionalidade(produto, detalhes) {
        try {
            console.log(`[DEBUG] Recalculando preço para produto ${produto.nome}:`, detalhes);
            
            let custoTotalCorrigido = 0;
            
            // Recalcular custo dos materiais com proporcionalidade correta
            for (const material of detalhes.materiais || []) {
                const custoAnterior = material.custo_unitario;
                const custoNovo = material.custo_unitario_novo || material.custo_unitario;
                
                console.log(`[DEBUG] Material ${material.nome}: custo anterior R$${custoAnterior}, novo R$${custoNovo}`);
                
                const custoMaterial = calcularCustoMaterialInteligente(
                    material.nome,
                    custoNovo,
                    material.quantidade_necessaria || 0,
                    material.area_utilizada || 0,
                    material.unidades_por_pacote || null,
                    material.is_measurement || false,
                    !!(material.largura && material.comprimento),
                    material.area_total || 0
                );
                
                console.log(`[DEBUG] Custo calculado para ${material.nome}: R$${custoMaterial.toFixed(2)}`);
                custoTotalCorrigido += custoMaterial;
            }
            
            // Adicionar custo das etapas (sem alteração)
            custoTotalCorrigido += detalhes.custo_etapas || 0;
            
            console.log(`[DEBUG] Custo total corrigido (materiais + etapas): R$${custoTotalCorrigido.toFixed(2)}`);
            
            // Aplicar margem de lucro
            const margemLucro = detalhes.produto.margem_lucro || 0;
            const precoFinal = custoTotalCorrigido * (1 + margemLucro / 100);
            
            console.log(`[DEBUG] Preço final com margem ${margemLucro}%: R$${precoFinal.toFixed(2)}`);
            console.log(`[DEBUG] Preço corrigido para ${produto.nome}: R$${precoFinal.toFixed(2)} (era R$${produto.novo_preco.toFixed(2)})`);
            
            return precoFinal;
        } catch (error) {
            console.error('Erro ao recalcular preço com proporcionalidade:', error);
            return produto.novo_preco; // Retornar preço original em caso de erro
        }
    }

    // Função para calcular novos preços (chama backend real)
    async function calcularNovosPrecos(materiaisAlterados = [], maquinasAlteradas = []) {
        try {
            // Primeiro detectar quais produtos foram afetados
            const produtosAfetados = await detectarMudancasCustos(materiaisAlterados, maquinasAlteradas);
            
            if (produtosAfetados.length === 0) {
                return [];
            }

            // Os produtos já vêm com os preços corrigidos da função detectarMudancasCustos
            // que agora aplica a correção de proporcionalidade
            return produtosAfetados;
            
        } catch (error) {
            console.error('Erro ao calcular novos preços:', error);
            throw error;
        }
    }

    // Função para aplicar atualizações de preços (chama backend real)
    async function aplicarAtualizacaoPrecos(produtosSelecionados) {
        try {
            const response = await fetch('/api/precos/atualizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    produtos: produtosSelecionados.map(produto => ({
                        id: produto.id,
                        novo_preco: produto.novo_preco,
                        preco_anterior: produto.preco_atual
                    }))
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                return data;
            } else {
                throw new Error(data.message || 'Erro ao atualizar preços');
            }
        } catch (error) {
            console.error('Erro ao aplicar atualizações:', error);
            throw error;
        }
    }

    // Função para ser chamada quando custos de material ou máquina forem alterados
    async function onCustoMaterialOuMaquinaAlterado(tipoAlteracao, nomeItem) {
        try {
            let materiaisAlterados = [];
            let maquinasAlteradas = [];

            if (tipoAlteracao === 'material') {
                materiaisAlterados = [nomeItem];
            } else if (tipoAlteracao === 'maquina') {
                maquinasAlteradas = [nomeItem];
            }

            // Detectar produtos afetados
            const produtosAfetados = await detectarMudancasCustos(materiaisAlterados, maquinasAlteradas);

            if (produtosAfetados.length > 0) {
                // Mostrar modal automaticamente
                abrirModalAtualizacaoPrecos(produtosAfetados, materiaisAlterados, maquinasAlteradas);
                
                // Mostrar notificação
                showNotification(
                    `${produtosAfetados.length} produto(s) podem ter preços desatualizados devido à alteração de ${tipoAlteracao}.`, 
                    'warning'
                );
            }

        } catch (error) {
            console.error('Erro ao verificar impacto da alteração:', error);
            showNotification('Erro ao verificar impacto nos produtos', 'error');
        }
    }

    // Variáveis globais para o modal de preços
    let produtosParaAtualizar = [];
    let materiaisAlterados = [];
    let maquinasAlteradas = [];

    // Função para abrir o modal de atualização de preços
    function abrirModalAtualizacaoPrecos(produtos, materiais = [], maquinas = []) {
        console.log('🔧 Tentando abrir modal de atualização de preços...');
        console.log('📊 Produtos recebidos:', produtos);
        console.log('🔧 Materiais alterados:', materiais);
        console.log('⚙️ Máquinas alteradas:', maquinas);
        
        // Adicionar debug detalhado para cada produto
        if (produtos && produtos.length > 0) {
            produtos.forEach((produto, index) => {
                const variacao = Math.abs((produto.novo_preco - produto.preco_atual) / produto.preco_atual * 100);
                console.log(`📊 Produto ${index + 1}: ${produto.nome}`);
                console.log(`   - Preço atual: R$ ${produto.preco_atual}`);
                console.log(`   - Novo preço: R$ ${produto.novo_preco}`);
                console.log(`   - Variação: ${variacao.toFixed(4)}%`);
            });
        }
        
        // Filtrar apenas produtos que tenham realmente variação significativa de preço (> 0%)
        const produtosComVariacao = (produtos || []).filter(produto => {
            const variacao = Math.abs((produto.novo_preco - produto.preco_atual) / produto.preco_atual * 100);
            console.log(`🔍 Produto ${produto.nome}: variação ${variacao.toFixed(3)}% - ${variacao > 0 ? 'INCLUÍDO' : 'FILTRADO'}`);
            return variacao > 0; // Filtrar apenas variações significativas (> 0%)
        });
        
        console.log(`✅ Produtos após filtro: ${produtosComVariacao.length}/${produtos?.length || 0}`);
        
        // Se não há produtos que precisem de atualização, não abrir o modal
        if (produtosComVariacao.length === 0) {
            console.log('ℹ️ Nenhum produto precisa de atualização de preço. Modal não será aberto.');
            showNotification('Nenhum produto precisa de atualização de preço significativa.', 'info');
            return;
        }
        
        produtosParaAtualizar = produtosComVariacao;
        materiaisAlterados = [...new Set(materiais || [])]; // Remove duplicatas
        maquinasAlteradas = [...new Set(maquinas || [])]; // Remove duplicatas

        const modal = document.getElementById('atualizarPrecosModal');
        console.log('🔍 Modal encontrado:', modal);
        
        if (!modal) {
            console.error('❌ Modal de atualização de preços não encontrado');
            return;
        }

        console.log('✅ Modal encontrado, iniciando configuração...');

        // Atualizar contadores do resumo
        atualizarResumoModal();

        // Carregar categorias no filtro
        carregarCategoriasFiltroPrecosUnicas();

        // Popular tabela de produtos
        popularTabelaProdutos();

        // Resetar filtros
        resetarFiltrosModal();

        // Mostrar modal
        modal.style.display = 'block';
        
        // Adicionar classe de animação se necessário
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        console.log('✅ Modal aberto com sucesso!');
    }

    // Função para fechar o modal
    function closeAtualizarPrecosModal() {
        const modal = document.getElementById('atualizarPrecosModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // Limpar dados
        produtosParaAtualizar = [];
        materiaisAlterados = [];
        maquinasAlteradas = [];
    }

    // Função para atualizar o resumo do modal
    function atualizarResumoModal() {
        const produtosCount = document.getElementById('produtosAfetadosCount');
        const materiaisCount = document.getElementById('materiaisAlteradosCount');
        const maquinasCount = document.getElementById('maquinasAlteradasCount');

        if (produtosCount) produtosCount.textContent = produtosParaAtualizar.length;
        if (materiaisCount) materiaisCount.textContent = materiaisAlterados.length;
        if (maquinasCount) maquinasCount.textContent = maquinasAlteradas.length;

        // Mostrar detalhes das alterações se houver materiais ou máquinas alterados
        atualizarDetalhesAlteracoes();
    }

    // Função para atualizar os detalhes das alterações
    function atualizarDetalhesAlteracoes() {
        const detalhesDiv = document.getElementById('alteracoesDetalhes');
        const materiaisDetalhes = document.getElementById('materiaisDetalhes');
        const maquinasDetalhes = document.getElementById('maquinasDetalhes');

        if (!detalhesDiv || !materiaisDetalhes || !maquinasDetalhes) return;

        let mostrarDetalhes = false;

        // Detalhes dos materiais alterados
        if (materiaisAlterados && materiaisAlterados.length > 0) {
            mostrarDetalhes = true;
            const materiaisHtml = materiaisAlterados.map(material => 
                `<span style="display: inline-block; margin: 2px 5px 2px 0; padding: 4px 10px; background-color: rgba(255, 71, 87, 0.2); border: 1px solid #FF4757; border-radius: 15px; font-size: 12px; color: #FF4757;">🧱 ${material}</span>`
            ).join('');
            materiaisDetalhes.innerHTML = `<div style="margin-bottom: 8px;"><strong style="color: #FF4757;">Materiais alterados:</strong></div><div>${materiaisHtml}</div>`;
        } else {
            materiaisDetalhes.innerHTML = '';
        }

        // Detalhes das máquinas alteradas
        if (maquinasAlteradas && maquinasAlteradas.length > 0) {
            mostrarDetalhes = true;
            const maquinasHtml = maquinasAlteradas.map(maquina => 
                `<span style="display: inline-block; margin: 2px 5px 2px 0; padding: 4px 10px; background-color: rgba(46, 213, 115, 0.2); border: 1px solid #2ED573; border-radius: 15px; font-size: 12px; color: #2ED573;">⚙️ ${maquina}</span>`
            ).join('');
            maquinasDetalhes.innerHTML = `<div style="margin-bottom: 8px;"><strong style="color: #2ED573;">Máquinas alteradas:</strong></div><div>${maquinasHtml}</div>`;
        } else {
            maquinasDetalhes.innerHTML = '';
        }

        // Mostrar ou ocultar a seção de detalhes
        detalhesDiv.style.display = mostrarDetalhes ? 'block' : 'none';
    }

    // Função para carregar categorias únicas no filtro
    function carregarCategoriasFiltroPrecosUnicas() {
        const filtroCategoria = document.getElementById('filtroCategoria');
        if (!filtroCategoria) return;

        // Limpar opções existentes (exceto "Todas")
        while (filtroCategoria.children.length > 1) {
            filtroCategoria.removeChild(filtroCategoria.lastChild);
        }

        // Extrair categorias únicas dos produtos
        const categoriasUnicas = [...new Set(produtosParaAtualizar.map(p => p.categoria))];
        
        categoriasUnicas.forEach(categoria => {
            if (categoria) {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                filtroCategoria.appendChild(option);
            }
        });
    }

    // Função para popular a tabela de produtos
    function popularTabelaProdutos() {
        const tbody = document.getElementById('priceUpdateTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        console.log('📋 Populando tabela com produtos:', produtosParaAtualizar);

        // Remover filtro adicional para debug - mostrar todos os produtos que chegaram até aqui
        const produtosComVariacao = produtosParaAtualizar; // Sem filtro adicional por enquanto

        console.log(`📊 Produtos para tabela: ${produtosComVariacao.length}`);

        produtosComVariacao.forEach((produto, index) => {
            console.log(`📦 Criando linha para produto: ${produto.nome}`);
            const row = criarLinhaTabela(produto, index);
            tbody.appendChild(row);
        });

        // Atualizar contadores
        atualizarContadoresSelecao();
    }

    // Função para criar linha da tabela
    function criarLinhaTabela(produto, index) {
        const row = document.createElement('tr');
        row.dataset.index = index;
        row.dataset.categoria = produto.categoria || '';
        row.dataset.nome = produto.nome.toLowerCase();

        // Calcular variação e impacto
        const variacao = ((produto.novo_preco - produto.preco_atual) / produto.preco_atual * 100);
        const variacaoAbs = Math.abs(variacao);
        const impacto = variacaoAbs > 20 ? 'alto' : variacaoAbs > 5 ? 'medio' : 'baixo';
        
        row.dataset.impacto = impacto;

        // Determinar causas (removendo duplicatas)
        const causas = [];
        const materiaisUnicos = [];
        const maquinasUnicas = [];
        
        if (produto.materiais_alterados && produto.materiais_alterados.length > 0) {
            // Remover duplicatas de materiais
            materiaisUnicos.push(...[...new Set(produto.materiais_alterados)]);
            causas.push({ tipo: 'material', nomes: materiaisUnicos });
        }
        if (produto.maquinas_alteradas && produto.maquinas_alteradas.length > 0) {
            // Remover duplicatas de máquinas
            maquinasUnicas.push(...[...new Set(produto.maquinas_alteradas)]);
            causas.push({ tipo: 'maquina', nomes: maquinasUnicas });
        }

        // Gerar HTML das causas simplificado com tooltip dinâmico
        let causasHtml = '';
        if (causas.length > 0) {
            const causasTexto = [];
            const tooltipDetalhes = [];
            
            if (materiaisUnicos.length > 0) {
                causasTexto.push('Material');
                tooltipDetalhes.push(`Materiais: ${materiaisUnicos.join(', ')}`);
            }
            if (maquinasUnicas.length > 0) {
                causasTexto.push('Máquina');
                tooltipDetalhes.push(`Máquinas: ${maquinasUnicas.join(', ')}`);
            }
            
            const textoFinal = causasTexto.join(' + ');
            const tooltipFinal = tooltipDetalhes.join('\n');
            
            causasHtml = `<span 
                class="cause-tooltip-dynamic" 
                data-tooltip="${tooltipFinal}"
                onmouseenter="showCauseTooltip(event, '${tooltipFinal.replace(/'/g, "&#39;")}')"
                onmouseleave="hideCauseTooltip()"
                onmousemove="updateCauseTooltipPosition(event)"
            >${textoFinal}</span>`;
        }

        row.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" class="product-checkbox" data-index="${index}" onchange="atualizarSelecaoProduto(${index})" style="cursor: pointer;">
            </td>
            <td style="font-weight: 500;">${produto.nome}</td>
            <td style="text-align: center;">
                <span style="padding: 2px 8px; background-color: rgba(155, 100, 227, 0.1); border-radius: 12px; font-size: 11px; color: #d8cefe;">
                    ${produto.categoria || 'Sem categoria'}
                </span>
            </td>
            <td style="text-align: right; font-family: monospace;">R$ ${produto.preco_atual.toFixed(2)}</td>
            <td style="text-align: right; font-family: monospace; font-weight: bold;">R$ ${produto.novo_preco.toFixed(2)}</td>
            <td style="text-align: center;">
                <span class="price-variation ${variacao >= 0 ? 'positive' : 'negative'}">
                    ${variacao >= 0 ? '+' : ''}${variacao.toFixed(3)}%
                </span>
            </td>
            <td style="text-align: center;">
                <span class="impact-badge ${impacto}">${impacto.toUpperCase()}</span>
            </td>
            <td style="text-align: left; padding: 8px;">
                ${causasHtml || '<span style="color: #888; font-style: italic;">Sem causas</span>'}
            </td>
        `;

        return row;
    }

    // Função para atualizar seleção de produto
    function atualizarSelecaoProduto(index, isSelected = null) {
        const checkbox = document.querySelector(`input[data-index="${index}"]`);
        if (!checkbox) return;

        if (isSelected !== null) {
            checkbox.checked = isSelected;
        }

        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.classList.add('selected');
            produtosParaAtualizar[index].selecionado = true;
        } else {
            row.classList.remove('selected');
            produtosParaAtualizar[index].selecionado = false;
        }

        atualizarContadoresSelecao();
        atualizarEstadoBotaoConfirmar();
    }

    // Função para alternar seleção de todos os produtos
    function toggleAllProductSelection() {
        const selectAllCheckbox = document.getElementById('selectAllProducts');
        const produtoCheckboxes = document.querySelectorAll('.product-checkbox');
        const isSelectAll = selectAllCheckbox.checked;

        produtoCheckboxes.forEach(checkbox => {
            if (checkbox.closest('tr').style.display !== 'none') { // Apenas produtos visíveis
                const index = parseInt(checkbox.dataset.index);
                atualizarSelecaoProduto(index, isSelectAll);
            }
        });
    }

    // Função para atualizar contadores de seleção
    function atualizarContadoresSelecao() {
        const produtosSelecionados = produtosParaAtualizar.filter(p => p.selecionado).length;
        const totalProdutos = produtosParaAtualizar.length;

        const selectedCount = document.getElementById('selectedProductsCount');
        const totalCount = document.getElementById('totalProductsCount');

        if (selectedCount) selectedCount.textContent = produtosSelecionados;
        if (totalCount) totalCount.textContent = totalProdutos;
    }

    // Função para atualizar estado do botão confirmar
    function atualizarEstadoBotaoConfirmar() {
        const btnConfirmar = document.getElementById('btnConfirmarAtualizacao');
        const produtosSelecionados = produtosParaAtualizar.filter(p => p.selecionado).length;

        if (btnConfirmar) {
            if (produtosSelecionados > 0) {
                btnConfirmar.disabled = false;
                btnConfirmar.style.opacity = '1';
                btnConfirmar.style.cursor = 'pointer';
            } else {
                btnConfirmar.disabled = true;
                btnConfirmar.style.opacity = '0.5';
                btnConfirmar.style.cursor = 'not-allowed';
            }
        }
    }

    // Função para resetar filtros
    function resetarFiltrosModal() {
        const filtroCategoria = document.getElementById('filtroCategoria');
        const filtroImpacto = document.getElementById('filtroImpacto');
        const filtroProduto = document.getElementById('filtroProduto');

        if (filtroCategoria) filtroCategoria.value = '';
        if (filtroImpacto) filtroImpacto.value = '';
        if (filtroProduto) filtroProduto.value = '';

        aplicarFiltrosModal();
    }

    // Função para aplicar filtros
    function aplicarFiltrosModal() {
        const filtroCategoria = document.getElementById('filtroCategoria')?.value || '';
        const filtroImpacto = document.getElementById('filtroImpacto')?.value || '';
        const filtroProduto = document.getElementById('filtroProduto')?.value.toLowerCase() || '';

        const rows = document.querySelectorAll('#priceUpdateTableBody tr');
        
        rows.forEach(row => {
            const categoria = row.dataset.categoria || '';
            const impacto = row.dataset.impacto || '';
            const nome = row.dataset.nome || '';

            const matchCategoria = !filtroCategoria || categoria === filtroCategoria;
            const matchImpacto = !filtroImpacto || impacto === filtroImpacto;
            const matchNome = !filtroProduto || nome.includes(filtroProduto);

            if (matchCategoria && matchImpacto && matchNome) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Atualizar checkbox "Selecionar Todos"
        atualizarCheckboxSelecionarTodos();
    }

    // Função para atualizar checkbox "Selecionar Todos"
    function atualizarCheckboxSelecionarTodos() {
        const selectAllCheckbox = document.getElementById('selectAllProducts');
        const visibleCheckboxes = document.querySelectorAll('.product-checkbox');
        const visibleCheckedBoxes = Array.from(visibleCheckboxes).filter(cb => 
            cb.checked && cb.closest('tr').style.display !== 'none'
        );

        if (selectAllCheckbox) {
            selectAllCheckbox.checked = visibleCheckedBoxes.length > 0 && 
                visibleCheckedBoxes.length === Array.from(visibleCheckboxes).filter(cb => 
                    cb.closest('tr').style.display !== 'none'
                ).length;
        }
    }

    // Função para recalcular preços
    async function recalcularPrecos() {
        try {
            showNotification('Recalculando preços...', 'info');
            
            // Recalcular usando a função de integração real
            const novosPrecos = await calcularNovosPrecos(materiaisAlterados, maquinasAlteradas);
            
            // Atualizar dados dos produtos
            produtosParaAtualizar = novosPrecos;
            
            // Atualizar resumo
            atualizarResumoModal();
            
            // Recarregar categorias
            carregarCategoriasFiltroPrecosUnicas();
            
            // Atualizar tabela com novos cálculos
            popularTabelaProdutos();
            
            // Aplicar filtros novamente
            aplicarFiltrosModal();
            
            showNotification('Preços recalculados com sucesso!', 'success');
            
        } catch (error) {
            console.error('Erro ao recalcular preços:', error);
            showNotification('Erro ao recalcular preços: ' + error.message, 'error');
        }
    }

    // Função para confirmar atualização de preços
    async function confirmarAtualizacaoPrecos() {
        const produtosSelecionados = produtosParaAtualizar.filter(p => p.selecionado);
        
        if (produtosSelecionados.length === 0) {
            showNotification('Selecione pelo menos um produto para atualizar', 'warning');
            return;
        }

        try {
            showNotification('Atualizando preços...', 'info');
            
            // Aplicar atualização usando a função de integração real
            const resultado = await aplicarAtualizacaoPrecos(produtosSelecionados);
            
            showNotification(`${produtosSelecionados.length} produto(s) atualizado(s) com sucesso!`, 'success');
            
            // Fechar modal
            closeAtualizarPrecosModal();
            
            // Recarregar a lista de produtos mantendo filtros ativos
            if (typeof carregarListaProdutos === 'function') {
                carregarListaProdutos(true);
            }
            
        } catch (error) {
            console.error('Erro ao atualizar preços:', error);
            showNotification('Erro ao atualizar preços: ' + error.message, 'error');
        }
    }

    // Event listeners para filtros
    document.addEventListener('DOMContentLoaded', function() {
        const filtroCategoria = document.getElementById('filtroCategoria');
        const filtroImpacto = document.getElementById('filtroImpacto');
        const filtroProduto = document.getElementById('filtroProduto');

        if (filtroCategoria) {
            filtroCategoria.addEventListener('change', aplicarFiltrosModal);
        }

        if (filtroImpacto) {
            filtroImpacto.addEventListener('change', aplicarFiltrosModal);
        }

        if (filtroProduto) {
            filtroProduto.addEventListener('input', aplicarFiltrosModal);
        }
    });

    // =============================================
    // FUNÇÃO PARA VERIFICAR ALTERAÇÕES DE PREÇOS REAIS
    // =============================================

    // Função para verificar alterações de custos reais e abrir modal
    async function verificarAlteracoesCustosReais() {
        try {
            // Mostrar indicador de carregamento
            mostrarCarregandoAtualizacaoPrecos();
            
            // Fazer requisição para verificar alterações
            const response = await fetch('/api/produtos/verificar-alteracoes-precos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dias: 7 // Verificar últimos 7 dias
                })
            });
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.alteracoes_detectadas) {
                // Processar dados dos produtos afetados com informações sobre materiais e máquinas alterados
                const produtosAfetadosOriginais = data.produtos_afetados.map(produto => ({
                    id: produto.id,
                    nome: produto.nome,
                    categoria: produto.categoria || 'Sem categoria',
                    preco_atual: produto.preco_atual,
                    novo_preco: produto.novo_preco,
                    variacao_percentual: produto.variacao_percentual,
                    impacto: produto.impacto,
                    causa: produto.causa,
                    materiais_alterados: produto.materiais_alterados || [],
                    maquinas_alteradas: produto.maquinas_alteradas || [],
                    selecionado: false
                }));
                
                // Aplicar correção de proporcionalidade para materiais dimensionais
                const produtosAfetadosCorrigidos = await corrigirCustosProdutosDimensionais(produtosAfetadosOriginais);
                
                // Extrair materiais e máquinas alterados dos detalhes da API
                const materiaisAlterados = data.detalhes_alteracoes?.materiais?.map(m => m.nome) || [];
                const maquinasAlteradas = data.detalhes_alteracoes?.maquinas?.map(m => m.nome) || [];
                
                console.log('📊 Alterações detectadas:', {
                    materiais: materiaisAlterados,
                    maquinas: maquinasAlteradas,
                    produtos: produtosAfetadosCorrigidos.length
                });
                
                // Abrir modal com dados corrigidos
                abrirModalAtualizacaoPrecos(produtosAfetadosCorrigidos, materiaisAlterados, maquinasAlteradas);
                
            } else {
                // Nenhuma alteração detectada
                showNotification('Nenhuma alteração significativa de custos foi detectada nos últimos 7 dias.', 'info');
            }
            
        } catch (error) {
            console.error('Erro ao verificar alterações de custos:', error);
            showNotification('Erro ao verificar alterações de custos: ' + error.message, 'error');
        } finally {
            ocultarCarregandoAtualizacaoPrecos();
        }
    }

    // Função para simular detecção de mudanças de custos (para demonstração)
    function simularDeteccaoMudancasCustos() {
        // Dados simulados para demonstração quando não há dados reais
        const produtosSimulados = [
            {
                id: 1,
                nome: 'Produto Demo A',
                categoria: 'Categoria Demo',
                preco_atual: 150.00,
                novo_preco: 165.50,
                variacao_percentual: 10.33,
                impacto: 'medio',
                causa: 'Material: Aço Inox 304',
                selecionado: false
            },
            {
                id: 2,
                nome: 'Produto Demo B',
                categoria: 'Categoria Demo',
                preco_atual: 89.90,
                novo_preco: 92.15,
                variacao_percentual: 2.50,
                impacto: 'baixo',
                causa: 'Material: Tinta Acrílica, Máquina: Torno CNC',
                selecionado: false
            },
            {
                id: 3,
                nome: 'Produto Demo C',
                categoria: 'Categoria Demo',
                preco_atual: 200.00,
                novo_preco: 180.50,
                variacao_percentual: -9.75,
                impacto: 'medio',
                causa: 'Máquina: Prensa Hidráulica',
                selecionado: false
            }
        ];

        const materiaisSimulados = ['Aço Inox 304', 'Tinta Acrílica'];
        const maquinasSimuladas = ['Torno CNC', 'Prensa Hidráulica'];

        // Abrir modal com dados simulados
        abrirModalAtualizacaoPrecos(produtosSimulados, materiaisSimulados, maquinasSimuladas);
        
        showNotification('Dados simulados carregados para demonstração. Use "Verificar alterações de preços" para dados do sistema.', 'info');
    }

    // Função para mostrar indicador de carregamento
    function mostrarCarregandoAtualizacaoPrecos() {
        const btn = document.querySelector('.btn-teste-precos');
        if (btn) {
            btn.innerHTML = `
                <div style="width: 16px; height: 16px; border: 2px solid #FFC107; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Verificando...
            `;
            btn.disabled = true;
        }
    }

    // Função para ocultar indicador de carregamento
    function ocultarCarregandoAtualizacaoPrecos() {
        const btn = document.querySelector('.btn-teste-precos');
        if (btn) {
            btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Verificar alterações de preços
            `;
            btn.disabled = false;
        }
    }

    // Expor funções para uso global
    window.simularDeteccaoMudancasCustos = simularDeteccaoMudancasCustos;
    window.verificarAlteracoesCustosReais = verificarAlteracoesCustosReais;
    window.debugCalculosPrecos = debugCalculosPrecos;

    function formatarMoeda(input) {
        let valor = input.value.replace(/\D/g, '');
        valor = (valor/100).toFixed(2);
        valor = valor.replace('.', ',');
        valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        input.value = valor.length > 0 ? `R$ ${valor}` : '';
    }

    function formatarPorcentagem(input) {
        let valor = input.value.replace(/[^0-9,]/g, '');
        // Permitir apenas números e vírgula
        valor = valor.replace(/,/g, '.');
        let numero = parseFloat(valor);
        
        if (isNaN(numero)) {
            input.value = '';
            return;
        }
        
        // Limitar apenas para valores não negativos
        numero = Math.max(0, numero);
        
        // Formatear com até 2 casas decimais
        let formatado = numero.toFixed(2).replace('.', ',');
        // Remover zeros desnecessários
        formatado = formatado.replace(/,00$/, '').replace(/,0$/, '');
        
        input.value = formatado + '%';
    }

    function handleMargemWheel(event) {
        event.preventDefault();
        
        const input = event.target;
        let currentValue = input.value.replace('%', '').replace(',', '.') || '0';
        let numero = parseFloat(currentValue);
        
        if (isNaN(numero)) {
            numero = 0;
        }
        
        // Determinar direção do scroll (positivo = para cima, negativo = para baixo)
        const delta = Math.sign(event.deltaY) * -1;
        
        // Determinar incremento baseado nas teclas modificadoras
        let incremento = 1; // Padrão: 1%
        
        if (event.shiftKey) {
            incremento = 10; // Shift: 10%
        } else if (event.ctrlKey || event.metaKey) {
            incremento = 0.1; // Ctrl/Cmd: 0.1%
        }
        
        // Aplicar incremento
        numero += delta * incremento;
        
        // Limitar apenas para valores não negativos
        numero = Math.max(0, numero);
        
        // Formatear com até 2 casas decimais
        let formatado = numero.toFixed(2).replace('.', ',');
        // Remover zeros desnecessários
        formatado = formatado.replace(/,00$/, '').replace(/,0$/, '');
        
        input.value = formatado + '%';
        
        // Feedback visual
        input.style.boxShadow = '0 0 10px rgba(155, 100, 227, 0.8)';
        setTimeout(() => {
            input.style.boxShadow = '';
        }, 150);
        
        // Recalcular preço com nova margem - detectar qual modal está ativo
        if (input.id === 'editProdutoMargem') {
            calcularPrecoComMargemEdit();
        } else {
            calcularPrecoComMargem();
        }
    }

    function calcularPrecoComMargem() {
        // Obter custo total dos materiais
        const custoMaterialsElement = document.getElementById('custoTotal');
        let custoMaterials = 0;
        if (custoMaterialsElement && custoMaterialsElement.textContent) {
            let valorString = custoMaterialsElement.textContent.replace(/R\$\s*/g, '').trim();
            if (valorString.includes(',')) {
                valorString = valorString.replace(/\./g, '').replace(',', '.');
            }
            custoMaterials = parseFloat(valorString) || 0;
        }
        
        // Obter custo total das etapas
        const custoEtapasElement = document.getElementById('custoTotalEtapas');
        let custoEtapas = 0;
        if (custoEtapasElement && custoEtapasElement.textContent) {
            let valorString = custoEtapasElement.textContent.replace(/R\$\s*/g, '').trim();
            if (valorString.includes(',')) {
                valorString = valorString.replace(/\./g, '').replace(',', '.');
            }
            custoEtapas = parseFloat(valorString) || 0;
        }
        
        // Calcular custo total
        const custoTotal = custoMaterials + custoEtapas;
        
        // Obter margem
        const margemInput = document.getElementById('produtoMargem');
        let margem = 0;
        if (margemInput && margemInput.value) {
            let margemString = margemInput.value.replace('%', '').replace(',', '.') || '0';
            margem = parseFloat(margemString) || 0;
        }
        
        // Calcular preço final (custo total + margem%)
        const precoFinal = custoTotal * (1 + margem / 100);
        
        // Atualizar campo de preço
        const precoInput = document.getElementById('produtoPreco');
        if (precoInput) {
            precoInput.value = formatarMoedaBrasileira(precoFinal);
        }
    }

    function calcularPrecoComMargemEdit() {
        console.log('💰 [CÁLCULO] Iniciando cálculo de preço com margem...');
        
        // Obter custo total dos materiais no modal de edição
        const custoMaterialsElement = document.getElementById('editCustoTotal');
        let custoMaterials = 0;
        if (custoMaterialsElement && custoMaterialsElement.textContent) {
            let valorString = custoMaterialsElement.textContent.replace(/R\$\s*/g, '').trim();
            if (valorString.includes(',')) {
                valorString = valorString.replace(/\./g, '').replace(',', '.');
            }
            custoMaterials = parseFloat(valorString) || 0;
        }
        console.log('💰 [CÁLCULO] Custo materiais:', custoMaterials);
        
        // Obter custo total das etapas no modal de edição
        const custoEtapasElement = document.getElementById('editCustoTotalEtapas');
        let custoEtapas = 0;
        if (custoEtapasElement && custoEtapasElement.textContent) {
            let valorString = custoEtapasElement.textContent.replace(/R\$\s*/g, '').trim();
            if (valorString.includes(',')) {
                valorString = valorString.replace(/\./g, '').replace(',', '.');
            }
            custoEtapas = parseFloat(valorString) || 0;
        }
        console.log('💰 [CÁLCULO] Custo etapas:', custoEtapas);
        
        // Calcular custo total
        const custoTotal = custoMaterials + custoEtapas;
        console.log('💰 [CÁLCULO] Custo total (materiais + etapas):', custoTotal);
        
        // Obter margem no modal de edição
        const margemInput = document.getElementById('editProdutoMargem');
        let margem = 0;
        if (margemInput && margemInput.value) {
            let margemString = margemInput.value.replace('%', '').replace(',', '.') || '0';
            margem = parseFloat(margemString) || 0;
        }
        console.log('💰 [CÁLCULO] Margem:', margem + '%');
        
        // Calcular preço final (custo total + margem%)
        const precoFinal = custoTotal * (1 + margem / 100);
        console.log('💰 [CÁLCULO] Preço final calculado:', precoFinal);
        
        // Atualizar campo de preço no modal de edição
        const precoInput = document.getElementById('editProdutoPreco');
        if (precoInput) {
            precoInput.value = formatarMoedaBrasileira(precoFinal);
            console.log('💰 [CÁLCULO] Preço atualizado no campo:', precoInput.value);
        } else {
            console.error('💰 [CÁLCULO] Campo editProdutoPreco não encontrado!');
        }
    }

    function openProdutoModal() {
        document.getElementById('produtoModal').style.display = 'block';
        // Carregar categorias
        carregarCategoriasParaDropdown('produtoCategoria');
        
        // Inicializar etapas e custos
        etapas = [];
        atualizarTabelaEtapas();
        atualizarCustoTotal();
        
        // Inicializar margem e calcular preço inicial
        const margemInput = document.getElementById('produtoMargem');
        if (margemInput) {
            margemInput.value = '0,00%';
        }
        
        setTimeout(() => {
            calcularPrecoComMargem();
        }, 100);
        
        // Configurar dropdowns após carregar
        setTimeout(() => {
            configurarDropdowns();
        }, 200);
        
        // Inicializar abas no modal
        setTimeout(() => {
            initializeTabs('produtoModal');
            // Ativar primeira aba (materiais) por padrão
            activateTab('materiais', 'produtoModal');
        }, 300);
    }

    function closeProdutoModal() {
        document.getElementById('produtoModal').style.display = 'none';
        document.getElementById('produtoForm').reset();
        
        // Limpar etapas e custos
        etapas = [];
        atualizarTabelaEtapas();
        atualizarCustoTotal();
        
        // Limpar anexos
        limparAnexosAoFecharModal('novo');
    }

    // Função para inicializar os scripts do produtos.html
    function initializeProdutosScripts() {
        console.log('🔧 Inicializando scripts do produtos.html...');
        
        // Não inicializar abas aqui - será feito em cada modal individualmente
        
        // Carregar lista de produtos
        carregarListaProdutos();
        
        // Configurar dropdowns
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const button = dropdown.querySelector('button');
            const dropdownContent = dropdown.querySelector('.dropdown-content');
            
            if (button && dropdownContent) {
                // Remove listeners anteriores (evita duplicação)
                button.removeEventListener('click', dropdownClickHandler);
                button.addEventListener('click', dropdownClickHandler);
                
                dropdownContent.removeEventListener('click', dropdownContentClickHandler);
                dropdownContent.addEventListener('click', dropdownContentClickHandler);
            }
        });
        
        // Configurar busca no modal
        const searchInput = document.getElementById('searchMaterialModal');
        if (searchInput) {
            searchInput.removeEventListener('input', searchInputHandler);
            searchInput.addEventListener('input', searchInputHandler);
        }
        
        // Fechar dropdowns ao clicar fora
        document.removeEventListener('click', fecharDropdownsGlobal);
        document.addEventListener('click', fecharDropdownsGlobal);
    }
    
    // Handlers das funções (para poder remover/adicionar sem duplicar)
    function dropdownClickHandler() {
        const dropdown = this.parentElement;
        const dropdownContent = dropdown.querySelector('.dropdown-content');
        dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
    }
    
    function dropdownContentClickHandler(e) {
        if (e.target.tagName === 'DIV' || e.target.closest('div[data-value]')) {
            const selectedDiv = e.target.tagName === 'DIV' ? e.target : e.target.closest('div[data-value]');
            const dropdown = this.parentElement;
            const button = dropdown.querySelector('button');
            
            // Para dropdowns de equipamentos, preservar o HTML com ícones
            if (selectedDiv.getAttribute('data-value') && 
                (selectedDiv.getAttribute('data-value').startsWith('maquina_') || 
                 selectedDiv.getAttribute('data-value').startsWith('ferramenta_'))) {
                button.innerHTML = selectedDiv.innerHTML;
            } else {
                button.textContent = selectedDiv.textContent;
            }
            
            button.setAttribute('data-selected', selectedDiv.getAttribute('data-value'));
            this.style.display = 'none';
            
            // Detectar se é o dropdown de material da etapa e recalcular tempo/custo
            if (dropdown.id === 'etapaMaterial') {
                // Aguardar um pouco para garantir que a mudança foi aplicada
                setTimeout(() => {
                    atualizarTempoEstimadoMaquina();
                }, 100);
            }
            // Detectar se é o dropdown de equipamento da etapa e recalcular tempo/custo
            else if (dropdown.id === 'etapaEquipamento') {
                // Atualizar o tipo de etapa automaticamente baseado no equipamento selecionado
                // apenas se o tipo ainda não foi definido pelo usuário
                const tipoButton = document.querySelector('#etapaTipo button');
                const equipamentoId = selectedDiv.getAttribute('data-value');
                const tipoAtual = tipoButton.getAttribute('data-selected');
                
                // Se o tipo ainda está vazio ou é o padrão, sugerir baseado no equipamento
                if (!tipoAtual || tipoAtual === '' || tipoAtual === 'Selecionar tipo...') {
                    if (equipamentoId && equipamentoId.startsWith('maquina_')) {
                        tipoButton.textContent = 'Processamento';
                        tipoButton.setAttribute('data-selected', 'Processamento');
                    } else if (equipamentoId && equipamentoId.startsWith('ferramenta_')) {
                        tipoButton.textContent = 'Preparação';
                        tipoButton.setAttribute('data-selected', 'Preparação');
                    }
                }
                
                // Aguardar um pouco para garantir que a mudança foi aplicada
                setTimeout(() => {
                    atualizarTempoEstimadoMaquina();
                }, 100);
            }
        }
    }
    
    function searchInputHandler() {
        filtrarMateriais(this.value);
    }
    
    // Expor a função globalmente para que possa ser chamada pelo dashboard
    window.initializeProdutosScripts = initializeProdutosScripts;
    
    // Carregar lista de produtos ao iniciar (fallback para quando acessado diretamente)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeProdutosScripts);
    } else {
        initializeProdutosScripts();
    }

    // Fechar modal ao clicar fora
    window.onclick = function(event) {
        if (event.target === document.getElementById('produtoModal')) {
            closeProdutoModal();
        }
        if (event.target === document.getElementById('editProdutoModal')) {
            closeEditProdutoModal();
        }
        if (event.target === document.getElementById('novaCategoriaModal')) {
            closeNovaCategoriaModal();
        }
        if (event.target === document.getElementById('productDeleteConfirmationModal')) {
            closeProductDeleteConfirmationModal();
        }
    };

    function carregarListaProdutos(manterFiltro = false) {
        // Se deve manter filtro, usar a função de busca existente
        if (manterFiltro) {
            const inputBusca = document.getElementById('searchProduto');
            const filtroCategoria = document.getElementById('filtroCategoriaBusca');
            
            // Se há filtros ativos, usar a função de busca
            if ((inputBusca && inputBusca.value.trim()) || 
                (filtroCategoria && filtroCategoria.value && filtroCategoria.value !== 'all')) {
                console.log('[DEBUG] Mantendo filtros ativos após atualização');
                executarBuscaProdutos();
                return;
            }
        }
        
        // Implementar a lógica de carregar produtos (sem filtros)
        fetch('/api/produtos')
            .then(response => response.json())
            .then(data => {
                const container = document.querySelector('.produtos-list');
                container.innerHTML = '';

                if (data.produtos && data.produtos.length > 0) {
                    data.produtos.forEach(produto => {
                        const row = document.createElement('div');
                        row.className = 'produtos-item';
                        row.style.cssText = 'display: grid; grid-template-columns: 0.8fr 1.5fr 1fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: 15px; padding: 12px 20px; margin: 8px 0; border-radius: 6px; transition: background-color 0.2s ease; align-items: center; border-bottom: 1px solid rgba(155, 100, 227, 0.2);';
                        row.setAttribute('data-produto-id', produto.id);

                        // Função para formatar preço
                        const formatCurrency = (value) => {
                            if (value && value !== 0) {
                                return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
                            }
                            return 'R$ 0,00';
                        };

                        // Função para formatar margem
                        const formatMargin = (value) => {
                            if (value && value !== 0) {
                                return `${parseFloat(value).toFixed(1)}%`;
                            }
                            return '0%';
                        };

                        // Definir cor do status
                        let statusColor = 'color: #51cf66;'; // Verde para ativo
                        let status = produto.status || 'Ativo';
                        if (status.toLowerCase() === 'inativo') {
                            statusColor = 'color: #ff6b6b;'; // Vermelho para inativo
                        } else if (status.toLowerCase() === 'em desenvolvimento') {
                            statusColor = 'color: #ffd43b;'; // Amarelo para em desenvolvimento
                        }

                        row.innerHTML = `
                            <div title="${produto.codigo}">${produto.codigo}</div>
                            <div title="${produto.nome}">${produto.nome}</div>
                            <div title="${produto.categoria || '-'}">${produto.categoria || '-'}</div>
                            <div>${formatCurrency(produto.preco)}</div>
                            <div style="text-align: center; color: #51cf66; font-weight: bold;">${formatMargin(produto.margem_lucro)}</div>
                            <div style="text-align: center;">${produto.etapas_count || '0'}</div>
                            <div style="${statusColor} font-weight: bold;">${status}</div>
                            <div>${produto.estoque || '0'}</div>
                            <div class="produto-actions" style="display: flex; gap: 5px; margin: 0; padding: 0; list-style: none; align-items: center;">
                                <button class="action-btn" onclick="editarProduto(${produto.id})" title="Editar" style="background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; border-radius: 3px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(155, 100, 227, 0.2)'" onmouseout="this.style.backgroundColor='transparent'">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                                        <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                                    </svg>
                                </button>
                                <button class="action-btn" onclick="excluirProduto(${produto.id})" title="Excluir" style="background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; border-radius: 3px; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='rgba(255, 100, 100, 0.2)'; this.style.color='#ff6464'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='var(--text-color)'">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        `;

                        // Adicionar efeito hover similar ao estoque
                        row.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = 'rgba(155, 100, 227, 0.1)';
                        });
                        
                        row.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = 'transparent';
                        });

                        container.appendChild(row);
                    });
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-color);">Nenhum produto cadastrado.</div>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar produtos:', error);
                document.querySelector('.produtos-list').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: var(--text-color);">Erro ao carregar produtos.</div>';
            });
    }

    async function editarProduto(id) {
        // Definir flags para evitar recálculo de preço durante carregamento
        console.log('🔄 [INIT] Iniciando edição do produto, definindo flags de carregamento...');
        window.isLoadingEditModal = true;
        window.editModalReady = false;
        
        // Limpar campo de margem antes de carregar novos dados
        const margemField = document.getElementById('editProdutoMargem');
        if (margemField) {
            margemField.value = '';
            console.log('🧹 Campo de margem limpo antes do carregamento');
        }
        
        // Buscar dados do produto
        fetch(`/api/produtos/${id}`)
            .then(response => response.json())
            .then(data => {
                console.log('📦 [PRODUTO] Dados recebidos do servidor:', data);
                if (data.status === 'success') {
                    const produto = data.produto;
                    console.log('📦 [PRODUTO] Objeto produto:', produto);
                    
                    // Armazenar dados originais para comparação
                    storeOriginalProductData(produto);
                    
                    // Preencher campos básicos
                    document.getElementById('editProdutoNome').value = produto.nome || '';
                    document.getElementById('editProdutoCodigo').value = produto.codigo || '';
                    
                    // Preencher valores monetários e percentuais
                    console.log('🔢 Margem do produto:', produto.margem_lucro, 'Tipo:', typeof produto.margem_lucro);
                    if (produto.margem_lucro !== undefined && produto.margem_lucro !== null) {
                        // Garantir que a margem seja um número
                        let margemValor = parseFloat(produto.margem_lucro) || 0;
                        // Formatar com até 2 casas decimais e remover zeros desnecessários
                        let margemFormatada = margemValor.toFixed(2).replace('.', ',');
                        margemFormatada = margemFormatada.replace(/,00$/, '').replace(/,0$/, '');
                        
                        const margemInput = document.getElementById('editProdutoMargem');
                        console.log('🔍 [DEBUG] Estado do campo margem antes da definição:', margemInput.value);
                        margemInput.value = margemFormatada + '%';
                        console.log('📊 Margem definida no campo:', margemFormatada + '%');
                        console.log('🔍 [DEBUG] Estado do campo margem após definição:', margemInput.value);
                        
                        // Verificar se o valor persistiu após um pequeno delay
                        setTimeout(() => {
                            console.log('🔍 [DEBUG] Estado do campo margem após 100ms:', margemInput.value);
                        }, 100);
                    } else {
                        // Se não há margem definida, usar 0%
                        document.getElementById('editProdutoMargem').value = '0%';
                        console.log('⚠️ Margem não definida, usando 0%');
                    }
                    // CORREÇÃO: Não definir preço diretamente do banco - será recalculado automaticamente
                    // com base nos custos atualizados e margem definida
                    
                    // Preencher descrições
                    document.getElementById('editProdutoDescricao').value = produto.descricao || '';
                    document.getElementById('editProdutoEspecificacoes').value = produto.especificacoes || '';
                    
                    // Armazenar ID do produto para uso no salvamento
                    document.getElementById('editProdutoForm').setAttribute('data-produto-id', id);
                    
                    // Carregar materiais do produto
                    if (produto.materiais && produto.materiais.length > 0) {
                        carregarMateriaisParaEdicao(produto.materiais);
                    } else {
                        // Limpar lista de materiais se não houver
                        editMateriais = [];
                        document.getElementById('editMateriaisList').innerHTML = '';
                    }
                    
                    // Carregar etapas do produto
                    if (produto.etapas && produto.etapas.length > 0) {
                        carregarEtapasParaEdicao(produto.etapas);
                    } else {
                        // Limpar lista de etapas se não houver
                        editEtapas = [];
                        document.getElementById('editEtapasList').innerHTML = '';
                    }
                    
                    // Carregar anexos do produto
                    carregarAnexosParaEdicao(id);
                    
                    // CORREÇÃO: Não sobrescrever custos recalculados - deixar que carregarMateriaisParaEdicao 
                    // e carregarEtapasParaEdicao calculem os valores corretos proporcionais
                    // Os custos serão atualizados automaticamente pelas funções de carregamento
                    
                    // Carregar categorias para o dropdown e aguardar conclusão
                    carregarCategoriasParaDropdown('editProdutoCategoria').then(() => {
                        // Configurar dropdowns
                        configurarDropdowns();
                        
                        // Preencher categoria DEPOIS do carregamento das categorias
                        const categoriaDropdown = document.getElementById('editProdutoCategoria');
                        const categoriaButton = categoriaDropdown.querySelector('button');
                        if (produto.categoria) {
                            console.log('🏷️ Definindo categoria:', produto.categoria, 'ID:', produto.categoria_id);
                            categoriaButton.textContent = produto.categoria;
                            categoriaButton.setAttribute('data-selected', produto.categoria_id || produto.categoria);
                        }
                        
                        // NÃO recalcular preço automaticamente na edição - preservar preço original
                        // calcularPrecoComMargemEdit(); // Comentado para preservar preço original
                    }).catch(error => {
                        console.error('Erro ao carregar categorias:', error);
                    });
                    
                    // Inicializar abas no modal de edição
                    setTimeout(() => {
                        initializeTabs('editProdutoModal');
                        activateTab('edit-materiais', 'editProdutoModal');
                    }, 100);
                    
                    // Abrir modal
                    document.getElementById('editProdutoModal').style.display = 'block';
                    
                } else {
                    showNotification(data.message || 'Erro ao carregar dados do produto', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao buscar produto:', error);
                showNotification('Erro ao carregar dados do produto', 'error');
            });
    }

    function closeEditProdutoModal() {
        document.getElementById('editProdutoModal').style.display = 'none';
        document.getElementById('editProdutoForm').reset();
        
        // Limpar flags de estado
        window.isLoadingEditModal = false;
        window.editModalReady = false;
        
        // Limpar atributo de ID do produto
        document.getElementById('editProdutoForm').removeAttribute('data-produto-id');
        
        // Limpar arrays de edição
        editMateriais = [];
        editEtapas = [];
        
        // Limpar listas visuais
        const materiaisList = document.getElementById('editMateriaisList');
        if (materiaisList) materiaisList.innerHTML = '';
        
        const etapasList = document.getElementById('editEtapasList');
        if (etapasList) etapasList.innerHTML = '';
        
        // Limpar anexos
        limparAnexosAoFecharModal('edit');
        
        // Resetar custos
        const custoTotal = document.getElementById('editCustoTotal');
        if (custoTotal) custoTotal.textContent = 'R$ 0,00';
        
        const custoTotalEtapas = document.getElementById('editCustoTotalEtapas');
        if (custoTotalEtapas) custoTotalEtapas.textContent = 'R$ 0,00';
        
        // Resetar dropdown de categoria
        const categoriaDropdown = document.getElementById('editProdutoCategoria');
        const categoriaButton = categoriaDropdown.querySelector('button');
        if (categoriaButton) {
            categoriaButton.textContent = 'Selecione uma categoria';
            categoriaButton.removeAttribute('data-selected');
        }
    }

    async function carregarMateriaisParaEdicao(materiais) {
        // Carregar materiais no array específico do modal de edição
        // Usar os mesmos instance_id que foram gerados em storeOriginalProductData
        editMateriais = materiais.map((material, index) => {
            // Usar o mesmo padrão de ID que foi usado em storeOriginalProductData
            const instanceId = material.instance_id || `original_${material.material_id}_${index}`;
            return {
                ...material,
                instance_id: instanceId,
                // Preservar subtotal original se disponível
                subtotal: parseFloat(material.subtotal) || 0
            };
        });
        
        const lista = document.getElementById('editMateriaisList');
        if (!lista) {
            console.error('Elemento editMateriaisList não encontrado');
            return;
        }
        
        lista.innerHTML = '';
        let custoTotalMateriais = 0;
        
        // CORREÇÃO: Aguardar que TODOS os materiais sejam processados de forma sequencial
        for (let index = 0; index < editMateriais.length; index++) {
            const material = editMateriais[index];
            
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(155, 100, 227, 0.2)';
            row.setAttribute('data-material-id', material.material_id); // ID do material original
            row.setAttribute('data-instance-id', material.instance_id); // ID único da instância
            
            // Buscar informações atualizadas do material da API (para quantidade disponível e outros dados)
            let quantidadeDisponivel = '0';
            let tipoMaterial = material.tipo_item_nome || 'Sem tipo';
            
            try {
                const response = await fetch(`/api/itens_estoque/${material.material_id}`);
                if (response.ok) {
                    const materialInfo = await response.json();
                    const item = materialInfo.item;
                    
                    quantidadeDisponivel = item?.quantidade_atual || '0';
                    tipoMaterial = item?.tipo_item_nome || 'Sem tipo';
                    
                    // Atualizar informações importantes do material no array editMateriais
                    if (!material.is_measurement && item?.is_measurement !== undefined) {
                        material.is_measurement = item.is_measurement;
                    }
                    
                    if (!material.area_total_material && item?.area) {
                        material.area_total_material = parseFloat(item.area);
                        console.log(`Material ${material.material_nome}: area_total_material atualizada para ${material.area_total_material}`);
                    }
                    
                    if (!material.unidades_por_pacote && item?.unidades_por_pacote) {
                        material.unidades_por_pacote = item.unidades_por_pacote;
                    }
                    
                    // CORREÇÃO CRÍTICA: Para materiais dimensionais, sempre usar o custo atual da chapa inteira
                    // Para outros materiais, preservar o custo original para manter consistência
                    if (item?.custo_atual || item?.custo_medio) {
                        const custoRealAtual = parseFloat(item.custo_atual || item.custo_medio);
                        const custoOriginal = parseFloat(material.custo_unitario);
                        
                        // Se é material dimensional (is_measurement), sempre usar o custo atual da chapa inteira
                        if (material.is_measurement === 1 || material.is_measurement === true) {
                            material.custo_unitario = custoRealAtual;
                            console.log(`Material dimensional ${material.material_nome}: usando custo atual da chapa inteira R$${custoRealAtual} (era R$${custoOriginal})`);
                        } else {
                            // Para materiais não dimensionais, manter o custo original
                            console.log(`Material não dimensional ${material.material_nome}: mantendo custo original R$${custoOriginal} (atual: R$${custoRealAtual})`);
                        }
                    }
                    
                    // Atualizar area_utilizada se não estiver definida
                    if (!material.area_utilizada && item?.area) {
                        material.area_utilizada = parseFloat(item.area);
                        console.log(`Material ${material.material_nome}: area_utilizada atualizada para ${material.area_utilizada}`);
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar informações do material:', error);
            }
            
            // CORREÇÃO: Para materiais dimensionais, sempre recalcular o subtotal baseado na área
            // Para outros materiais, preservar o subtotal original
            let subtotal = parseFloat(material.subtotal || 0);
            
            // Detectar se é material dimensional com dimensões definidas
            const isMaterialDimensional = !!(material.largura && material.altura && material.largura > 0 && material.altura > 0);
            const isMeasurement = material.is_measurement === 1 || material.is_measurement === true;
            
            // Para materiais dimensionais com dimensões, sempre recalcular usando a lógica proporcional
            if (isMaterialDimensional && isMeasurement && material.area_total_material > 0) {
                console.log(`[DEBUG EDIÇÃO] Material dimensional ${material.material_nome}: recalculando subtotal proporcional...`);
                
                // Calcular área utilizada baseada nas dimensões
                const areaUtilizada = (parseFloat(material.largura) * parseFloat(material.altura)) / 10000;
                material.area_utilizada = areaUtilizada;
                
                // Usar a lógica inteligente de cálculo
                const nomeMaterial = material.material_nome || 'Material';
                const custoUnitario = parseFloat(material.custo_unitario) || 0;
                const quantidadeNecessaria = parseFloat(material.quantidade_necessaria) || 1;
                const unidadesPorPacote = parseFloat(material.unidades_por_pacote) || 0;
                const temDimensoes = true;
                const areaTotalMaterial = parseFloat(material.area_total_material) || 0;
                
                subtotal = calcularCustoMaterialInteligente(
                    nomeMaterial, custoUnitario, quantidadeNecessaria, areaUtilizada,
                    unidadesPorPacote, isMeasurement, temDimensoes, areaTotalMaterial
                );
                
                console.log(`[DEBUG EDIÇÃO] Material ${material.material_nome}: subtotal recalculado proporcional R$${subtotal.toFixed(2)} (área: ${areaUtilizada.toFixed(4)}m²)`);
                
                // CORREÇÃO CRÍTICA: Atualizar também o material no array editMateriais
                material.subtotal = subtotal;
                console.log(`[DEBUG CRÍTICO] Subtotal atualizado no objeto material: R$${subtotal.toFixed(2)}`);
            }
            // Para materiais não dimensionais, só recalcular se o subtotal for zero
            else if (subtotal === 0 && material.quantidade_necessaria && material.custo_unitario) {
                console.log(`[DEBUG EDIÇÃO] Material ${material.material_nome}: subtotal original é zero, recalculando...`);
                
                // Usar a mesma lógica inteligente de cálculo
                const nomeMaterial = material.material_nome || 'Material';
                const custoUnitario = parseFloat(material.custo_unitario) || 0;
                const quantidadeNecessaria = parseFloat(material.quantidade_necessaria) || 0;
                const areaUtilizada = parseFloat(material.area_utilizada) || 0;
                const unidadesPorPacote = parseFloat(material.unidades_por_pacote) || 0;
                const temDimensoes = !!(material.largura && material.altura);
                const areaTotalMaterial = parseFloat(material.area_total_material) || 0;
                
                subtotal = calcularCustoMaterialInteligente(
                    nomeMaterial, custoUnitario, quantidadeNecessaria, areaUtilizada,
                    unidadesPorPacote, isMeasurement, temDimensoes, areaTotalMaterial
                );
                
                console.log(`[DEBUG EDIÇÃO] Material ${material.material_nome}: subtotal recalculado para R$${subtotal.toFixed(2)}`);
            } else {
                console.log(`[DEBUG EDIÇÃO] Material ${material.material_nome}: preservando subtotal original R$${subtotal.toFixed(2)}`);
            }
            
            // Atualizar o subtotal no objeto material
            material.subtotal = subtotal;
            
            // NÃO somar ao custoTotalMateriais aqui - será recalculado no setTimeout
            
            console.log(`[DEBUG INIT] Material ${material.material_nome}: subtotal final garantido R$${material.subtotal.toFixed(2)}`);
            
            row.innerHTML = `
                <td style="padding: 8px; color: white;">${material.material_nome || 'Material não encontrado'}</td>
                <td style="padding: 8px; text-align: center; color: white;">${tipoMaterial}</td>
                <td style="padding: 8px; text-align: right; color: white;">${quantidadeDisponivel}</td>
                <td style="padding: 8px; text-align: center; color: white;">
                    ${material.largura && material.altura ? `
                        <input type="number" min="0" step="1" value="1" readonly
                               class="quantidade-input"
                               data-tipo="quantidade"
                               style="width: 60px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 4px; border-radius: 3px;"
                               title="Quantidade fixa para materiais dimensionais">
                    ` : `
                        <input type="number" min="0" step="1" value="${parseInt(material.quantidade_necessaria || '1')}"
                               class="quantidade-input edit-input-delayed"
                               data-tipo="quantidade"
                               style="width: 60px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 4px; border-radius: 3px;"
                               title="Quantidade necessária">
                    `}
                </td>
                <td style="padding: 8px; text-align: center; color: white;">
                    ${material.largura && material.altura ? `
                        <div class="dimensions-container">
                            <input type="number" placeholder="Larg." min="0" step="0.1" value="${material.largura || '0'}"
                                   class="dimensions-input edit-input-delayed"
                                   data-dimension="largura"
                                   style="width: 60px; margin-right: 5px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 2px; border-radius: 3px;"
                                   title="Largura em centímetros">
                            <span class="dimension-separator">×</span>
                            <input type="number" placeholder="Alt." min="0" step="0.1" value="${material.altura || '0'}"
                                   class="dimensions-input edit-input-delayed"
                                   data-dimension="altura"
                                   style="width: 60px; margin-left: 5px; text-align: center; background-color: rgba(155, 100, 227, 0.1); border: 1px solid #9B64E3; color: white; padding: 2px; border-radius: 3px;"
                                   title="Altura em centímetros">
                        </div>
                    ` : `
                        <span class="na-field">-</span>
                    `}
                </td>
                <td style="padding: 8px; text-align: right; color: white;">
                    ${material.area_utilizada ? `
                        <span class="area-display" 
                              data-area-total="${material.area_total_material || 0}"
                              data-area-utilizada="${material.area_utilizada || 0}">${(() => {
                            let area = parseFloat(material.area_utilizada);
                            if (area < 0.01 && area > 0) {
                                // Para áreas muito pequenas, mostrar em cm²
                                let areaCm2 = (area * 10000).toFixed(1);
                                return areaCm2.replace('.', ',') + ' cm²';
                            } else {
                                // Para áreas maiores, mostrar em m² com no máximo 2 casas decimais
                                let areaFormatada = area.toFixed(2);
                                return areaFormatada.replace('.', ',') + ' m²';
                            }
                        })()}</span>
                    ` : `
                        <span class="na-field">-</span>
                    `}
                </td>
                <td style="padding: 8px; text-align: right; color: white;">
                    <span class="preco-unitario-display">
                        ${parseFloat(material.custo_unitario || 0).toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        })}${material.largura && material.altura ? '/m²' : ''}
                    </span>
                </td>
                <td style="padding: 8px; text-align: right; color: white;">
                    <span class="subtotal-display"
                          data-preco="${material.custo_unitario || 0}"
                          data-unidades-pacote="${material.unidades_por_pacote || 0}"
                          data-is-measurement="${material.is_measurement ? 'true' : 'false'}"
                          data-mostrar-dimensoes="${material.largura && material.altura ? 'true' : 'false'}"
                          data-subtotal-original="${subtotal}">
                        ${subtotal.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        })}
                    </span>
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button type="button" onclick="removerMaterialEdit(${index})" class="action-btn" data-tooltip="Excluir" style="color: var(--action-icon-color); position: relative;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </td>
            `;
            
            lista.appendChild(row);
            
            // Adicionar event listener para remoção com botão direito do mouse
            row.addEventListener('contextmenu', function(e) {
                showContextMenu(e, this);
            });
            
            // Adicionar event listener para mostrar tooltip temporário
            row.addEventListener('mouseenter', function(e) {
                showCursorTooltip(e);
            });
            
            row.addEventListener('mouseleave', function(e) {
                hideCursorTooltip();
            });
        }
        
        // Atualizar custo total após TODOS os materiais serem processados
        setTimeout(() => {
            // CORREÇÃO: Recalcular subtotais para materiais dimensionais e atualizar custo total
            editMateriais.forEach((material, index) => {
                const nomeMaterial = material.material_nome || 'Material';
                
                // Se for material dimensional, verificar se os dados estão corretos
                if (material.largura && material.altura && material.largura > 0 && material.altura > 0) {
                    const areaCalculada = (parseFloat(material.largura) * parseFloat(material.altura)) / 10000;
                    if (Math.abs(areaCalculada - parseFloat(material.area_utilizada)) > 0.001) {
                        console.log(`[DEBUG] Corrigindo área utilizada de ${material.area_utilizada} para ${areaCalculada}`);
                        material.area_utilizada = areaCalculada;
                    }
                }
            });
            
            // SEMPRE recalcular o custo total após os ajustes de subtotais
            atualizarCustoTotalEdit();
            
            // Reset the loading flag after materials are loaded and initial calculations are done
            console.log('🔄 [INIT] Resetando flags de carregamento após finalização dos cálculos');
            window.isLoadingEditModal = false;
            
            // Definir modal como pronto após um pequeno delay adicional
            setTimeout(() => {
                window.editModalReady = true;
                console.log('✅ [INIT] Modal de edição está pronto para interações do usuário');
                
                // Anexar event handlers aos inputs de edição com delay adicional
                setTimeout(() => {
                    anexarEventHandlersEdicao();
                }, 50); // Delay adicional para garantir que o HTML esteja no DOM
            }, 200);
        }, 100);
    }

    function removerMaterialEdit(index) {
        // Remover diretamente, sem usar confirm() do navegador
        // A confirmação já foi feita pelo modal personalizado
        editMateriais.splice(index, 1);
        console.log(`[DEBUG] Material removido do index ${index}, restam ${editMateriais.length} materiais`);
        
        // Usar atualizarMateriaisEdit para re-renderizar a lista
        atualizarMateriaisEdit();
        
        // Mostrar mensagem de sucesso usando o sistema de notificação personalizado
        if (typeof mostrarMensagem === 'function') {
            mostrarMensagem('Material removido com sucesso!', 'sucesso');
        }
    }

    // Função para anexar event handlers aos inputs de edição após o carregamento
    function anexarEventHandlersEdicao() {
        console.log('🔗 [INIT] Anexando event handlers aos inputs de edição');
        
        // Debug: verificar se os elementos existem
        const todasAsClassesDelayed = document.querySelectorAll('.edit-input-delayed');
        console.log('🔍 [DEBUG] Elementos com .edit-input-delayed encontrados:', todasAsClassesDelayed.length);
        
        const todosQuantidadeInputs = document.querySelectorAll('.quantidade-input');
        console.log('🔍 [DEBUG] Elementos com .quantidade-input encontrados:', todosQuantidadeInputs.length);
        
        const todosDimensionInputs = document.querySelectorAll('.dimensions-input');
        console.log('🔍 [DEBUG] Elementos com .dimensions-input encontrados:', todosDimensionInputs.length);
        
        // Anexar event handlers aos inputs de quantidade
        const quantidadeInputs = document.querySelectorAll('.edit-input-delayed.quantidade-input');
        console.log('🔍 [DEBUG] Inputs de quantidade com .edit-input-delayed encontrados:', quantidadeInputs.length);
        
        quantidadeInputs.forEach(input => {
            console.log('🔗 [DEBUG] Anexando event handler ao input de quantidade:', input);
            input.addEventListener('input', function() {
                if (window.editModalReady) {
                    console.log('🔄 [INPUT] Alteração detectada em input de quantidade');
                    calcularSubtotalCompletoEdit(this);
                }
            });
            // Remover a classe temporária
            input.classList.remove('edit-input-delayed');
        });
        
        // Anexar event handlers aos inputs de dimensões (largura e altura)
        const dimensionInputs = document.querySelectorAll('.edit-input-delayed.dimensions-input');
        console.log('🔍 [DEBUG] Inputs de dimensões com .edit-input-delayed encontrados:', dimensionInputs.length);
        
        dimensionInputs.forEach(input => {
            console.log('🔗 [DEBUG] Anexando event handler ao input de dimensão:', input);
            input.addEventListener('input', function() {
                if (window.editModalReady) {
                    console.log('🔄 [INPUT] Alteração detectada em input de dimensão:', this.getAttribute('data-dimension'));
                    calcularSubtotalCompletoEdit(this);
                }
            });
            // Remover a classe temporária
            input.classList.remove('edit-input-delayed');
        });
        
        console.log(`✅ [INIT] Anexados event handlers a ${quantidadeInputs.length} inputs de quantidade e ${dimensionInputs.length} inputs de dimensões`);
    }

    function atualizarMateriaisEdit() {
        console.log('🔄 [DEBUG] atualizarMateriaisEdit() chamada');
        
        const lista = document.getElementById('editMateriaisList');
        if (!lista) {
            console.error('Elemento editMateriaisList não encontrado');
            return;
        }
        
        lista.innerHTML = '';
        
        // APENAS renderizar a interface, NÃO recalcular subtotais
        // Os subtotais já foram calculados corretamente em carregarMateriaisParaEdicao
        editMateriais.forEach((material, index) => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(155, 100, 227, 0.2)';
            
            // Usar o subtotal já calculado no array editMateriais
            // que foi atualizado corretamente em carregarMateriaisParaEdicao
            let subtotal = parseFloat(material.subtotal || 0);
            
            // APENAS fallback para casos extremos onde subtotal é 0
            if (subtotal === 0 && material.quantidade_necessaria && material.custo_unitario) {
                console.log(`[DEBUG FALLBACK] Material ${material.material_nome}: subtotal é 0, usando fallback`);
                if (material.area_utilizada && material.area_utilizada > 0) {
                    subtotal = parseFloat(material.area_utilizada) * parseFloat(material.custo_unitario);
                } else {
                    subtotal = parseFloat(material.quantidade_necessaria) * parseFloat(material.custo_unitario);
                }
                // Atualizar no array para próximas chamadas
                material.subtotal = subtotal;
            }
            
            console.log(`[DEBUG RENDER] Material ${material.material_nome}: usando subtotal R$${subtotal.toFixed(2)}`);
            
            row.innerHTML = `
                <td class="material-name-cell" style="padding: 8px; color: white;" title="${material.material_nome || 'Material não encontrado'}">${material.material_nome || 'Material não encontrado'}</td>
                <td style="padding: 8px; text-align: center; color: white;">${material.tipo_item_nome || 'Sem tipo'}</td>
                <td style="padding: 8px; text-align: right; color: white;">-</td>
                <td style="padding: 8px; text-align: center; color: white;">
                    ${material.largura && material.altura ? '1' : (material.quantidade_necessaria || '0')}
                </td>
                <td style="padding: 8px; text-align: center; color: white;">
                    ${material.largura && material.altura ? 
                        `${material.largura} × ${material.altura}` : 
                        '-'
                    }
                </td>
                <td style="padding: 8px; text-align: right; color: white;">
                    ${material.area_utilizada ? parseFloat(material.area_utilizada).toFixed(4) : '-'}
                </td>
                <td style="padding: 8px; text-align: right; color: white;">
                    ${parseFloat(material.custo_unitario || 0).toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    })}
                </td>
                <td style="padding: 8px; text-align: right; color: white;">
                    ${subtotal.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    })}
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button type="button" onclick="removerMaterialEdit(${index})" class="action-btn" data-tooltip="Excluir" style="color: var(--action-icon-color); position: relative;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </td>
            `;
            
            lista.appendChild(row);
            
            // Adicionar event listener para remoção com botão direito do mouse
            row.addEventListener('contextmenu', function(e) {
                showContextMenu(e, this);
            });
            
            // Adicionar event listener para mostrar tooltip temporário
            row.addEventListener('mouseenter', function(e) {
                showCursorTooltip(e);
            });
            
            row.addEventListener('mouseleave', function(e) {
                hideCursorTooltip();
            });
        });
        
        // Atualizar custo total usando função centralizada
        console.log('💰 [DEBUG] atualizarMateriaisEdit: Renderização concluída, chamando atualizarCustoTotalEdit()');
        atualizarCustoTotalEdit();
    }

    function carregarEtapasParaEdicao(etapasCarregadas) {
        // Carregar etapas no array específico do modal de edição, normalizando o formato de tempo
        editEtapas = etapasCarregadas.map(etapa => {
            // Normalizar formato do tempo para HH:MM:SS
            let tempoNormalizado = etapa.tempo_estimado || '00:00:00';
            if (tempoNormalizado && !tempoNormalizado.match(/^\d{2}:\d{2}:\d{2}$/)) {
                // Se o formato não está correto (ex: "0:00:08"), normalizar para "00:00:08"
                const partesTempo = tempoNormalizado.split(':');
                if (partesTempo.length === 3) {
                    const horas = partesTempo[0].padStart(2, '0');
                    const minutos = partesTempo[1].padStart(2, '0');
                    const segundos = partesTempo[2].padStart(2, '0');
                    tempoNormalizado = `${horas}:${minutos}:${segundos}`;
                }
            }
            
            return {
                ...etapa,
                tempo_estimado: tempoNormalizado
            };
        });
        
        const lista = document.getElementById('editEtapasList');
        if (!lista) {
            console.error('Elemento editEtapasList não encontrado');
            return;
        }
        
        // Usar a função de atualização da tabela de edição
        atualizarTabelaEtapasEdit();
    }

    async function salvarEdicaoProduto() {
        try {
            // Obter ID do produto
            const produtoId = document.getElementById('editProdutoForm').getAttribute('data-produto-id');
            if (!produtoId) {
                showNotification('ID do produto não encontrado', 'error');
                return;
            }
            
            // Coletar dados do formulário
            const formData = coletarDadosFormularioEdicao();
            
            // Validar dados obrigatórios
            if (!validarDadosProduto(formData)) {
                return;
            }
            
            // Detectar mudanças
            const changes = detectProductChanges(formData);
            
            // Se não há mudanças, apenas fechar o modal
            if (Object.keys(changes).length === 0) {
                showNotification('Nenhuma alteração foi detectada.', 'info');
                closeEditProdutoModal();
                return;
            }
            
            // Mostrar modal de confirmação com as mudanças
            showConfirmationEditModal(changes, async () => {
                await salvarEdicaoProdutoConfirmado(produtoId, formData);
            });
            
        } catch (error) {
            console.error('Erro ao preparar edição do produto:', error);
            showNotification('Erro ao preparar edição. Tente novamente.', 'error');
        }
    }
    
    async function salvarEdicaoProdutoConfirmado(produtoId, formData) {
        try {
            // Mostrar feedback de carregamento
            mostrarFeedbackCarregamento('Salvando alterações...');
            
            // Verificar se há anexos novos ou anexos para deletar para usar FormData
            const novosAnexos = anexosEditProduto.filter(anexo => anexo.file && !anexo.isExisting);
            const temNovosAnexos = novosAnexos.length > 0;
            const temAnexosParaDeletar = window.anexosParaDeletar && window.anexosParaDeletar.length > 0;
            const usarFormData = temNovosAnexos || temAnexosParaDeletar;
            let response;
            
            if (usarFormData) {
                // Usar FormData para suportar upload de arquivos
                const formDataMultipart = new FormData();
                
                // Adicionar dados básicos do produto como JSON
                formDataMultipart.append('dados', JSON.stringify({
                    nome: formData.nome,
                    codigo: formData.codigo,
                    categoria: formData.categoria,
                    preco: formData.preco,
                    margem: formData.margem,
                    descricao: formData.descricao,
                    especificacoes: formData.especificacoes,
                    materiais: formData.materiais,
                    etapas: formData.etapas,
                    custoMateriais: formData.custoMateriais,
                    custoEtapas: formData.custoEtapas,
                    custoTotal: formData.custoTotal
                }));
                
                // Adicionar novos arquivos (apenas os que têm .file e não são existentes)
                novosAnexos.forEach((anexo, index) => {
                    formDataMultipart.append('anexos', anexo.file);
                    // Enviar categoria como campo separado
                    formDataMultipart.append(`anexo_categoria_${index}`, anexo.categoria || '');
                });
                
                // Adicionar lista de anexos para deletar
                if (window.anexosParaDeletar && window.anexosParaDeletar.length > 0) {
                    formDataMultipart.append('anexosParaDeletar', JSON.stringify(window.anexosParaDeletar));
                }
                
                // Adicionar categorias alteradas de anexos existentes
                const anexosExistentesComCategoriaAlterada = anexosEditProduto
                    .filter(anexo => anexo.isExisting && !anexo.markedForDeletion)
                    .map(anexo => ({
                        id: anexo.existingId || anexo.id,
                        categoria: anexo.categoria || ''
                    }));
                
                if (anexosExistentesComCategoriaAlterada.length > 0) {
                    formDataMultipart.append('anexosExistentesCategoria', JSON.stringify(anexosExistentesComCategoriaAlterada));
                }
                
                // Enviar com FormData (sem Content-Type header - browser define automaticamente)
                response = await fetch(`/api/produtos/${produtoId}`, {
                    method: 'PUT',
                    body: formDataMultipart
                });
            } else {
                // Mesmo sem novos anexos, verificar se há anexos para deletar ou categorias alteradas
                if (temAnexosParaDeletar) {
                    formData.anexosParaDeletar = window.anexosParaDeletar;
                }
                
                // Adicionar categorias alteradas de anexos existentes
                const anexosExistentesComCategoriaAlterada = anexosEditProduto
                    .filter(anexo => anexo.isExisting && !anexo.markedForDeletion)
                    .map(anexo => ({
                        id: anexo.existingId || anexo.id,
                        categoria: anexo.categoria || ''
                    }));
                
                if (anexosExistentesComCategoriaAlterada.length > 0) {
                    formData.anexosExistentesCategoria = anexosExistentesComCategoriaAlterada;
                }
                
                // Enviar JSON normal quando não há anexos novos
                response = await fetch(`/api/produtos/${produtoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            }
            
            const result = await response.json();
            
            if (response.ok) {
                // Sucesso
                mostrarFeedbackSucesso('Produto atualizado com sucesso!');
                
                // Fechar modal
                closeEditProdutoModal();
                
                // Atualizar lista de produtos mantendo filtros ativos
                carregarListaProdutos(true);
                
            } else {
                // Erro do servidor
                mostrarFeedbackErro(result.message || 'Erro ao atualizar produto');
            }
            
        } catch (error) {
            console.error('Erro ao atualizar produto:', error);
            mostrarFeedbackErro('Erro de conexão. Tente novamente.');
        } finally {
            ocultarFeedbackCarregamento();
        }
    }

    function coletarDadosFormularioEdicao() {
        // Dados básicos do produto
        const dados = {
            nome: document.getElementById('editProdutoNome').value.trim(),
            codigo: document.getElementById('editProdutoCodigo').value.trim(),
            categoria: obterValorDropdown('editProdutoCategoria'),
            preco: extrairValorMonetario(document.getElementById('editProdutoPreco').value),
            margem: extrairValorPorcentagem(document.getElementById('editProdutoMargem').value),
            descricao: document.getElementById('editProdutoDescricao').value.trim(),
            especificacoes: document.getElementById('editProdutoEspecificacoes').value.trim()
        };
        
        // Materiais e etapas editados
        dados.materiais = editMateriais;
        dados.etapas = editEtapas;
        
        // Anexos
        dados.anexos = obterAnexos('edit');
        
        // Custos calculados
        dados.custoMateriais = extrairValorMonetario(document.getElementById('editCustoTotal').textContent);
        dados.custoEtapas = extrairValorMonetario(document.getElementById('editCustoTotalEtapas').textContent);
        dados.custoTotal = dados.custoMateriais + dados.custoEtapas;
        
        console.log('Dados coletados do formulário de edição:', dados);
        return dados;
    }

    // Variável para armazenar o timer de confirmação (similar ao estoque.html)
    let productDeleteConfirmationTimer = null;

    function duplicarProduto(id) {
        // Buscar dados do produto original
        fetch(`/api/produtos/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const produto = data.produto;
                    
                    // Abrir modal de novo produto com dados preenchidos
                    openProdutoModal();
                    
                    // Aguardar o modal carregar completamente
                    setTimeout(() => {
                        // Preencher campos com dados do produto original (com sufixo "Cópia")
                        document.getElementById('produtoNome').value = produto.nome + ' - Cópia';
                        document.getElementById('produtoCodigo').value = produto.codigo + '_COPIA';
                        
                        if (produto.descricao) {
                            document.getElementById('produtoDescricao').value = produto.descricao;
                        }
                        
                        if (produto.especificacoes) {
                            document.getElementById('produtoEspecificacoes').value = produto.especificacoes;
                        }
                        
                        if (produto.margem_lucro) {
                            document.getElementById('produtoMargem').value = produto.margem_lucro + '%';
                        }
                        
                        // Definir categoria se existir
                        if (produto.categoria_id) {
                            window.selectedCategoriaId = produto.categoria_id;
                            document.getElementById('selectedCategoria').textContent = produto.categoria || 'Categoria Selecionada';
                        }
                        
                        mostrarFeedbackSucesso('Produto carregado para duplicação. Altere os dados necessários e salve.');
                    }, 500);
                } else {
                    mostrarErro('Erro ao carregar dados do produto para duplicação');
                }
            })
            .catch(error => {
                console.error('Erro ao duplicar produto:', error);
                mostrarErro('Erro ao duplicar produto');
            });
    }

    function excluirProduto(id) {
        // Buscar informações do produto no DOM da lista
        const produtoRow = document.querySelector(`[data-produto-id="${id}"]`);
        let nomeProduto = `Produto #${id}`;
        
        if (produtoRow) {
            // O nome está na segunda coluna (index 1)
            const nomeCell = produtoRow.children[1];
            if (nomeCell) {
                nomeProduto = nomeCell.textContent.trim();
            }
        }
        
        // Mostra o modal de confirmação personalizado
        showProductDeleteConfirmationModal(`Tem certeza que deseja excluir o produto "${nomeProduto}"? Esta ação não pode ser desfeita.`, async () => {
            try {
                const response = await fetch(`/api/produtos/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    mostrarMensagem('Produto excluído com sucesso!', 'sucesso');
                    // Recarregar a lista de produtos mantendo filtros ativos
                    carregarListaProdutos(true);
                } else {
                    const errorData = await response.json();
                    mostrarMensagem(`Erro ao excluir produto: ${errorData.error || 'Erro desconhecido'}`, 'erro');
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                mostrarMensagem('Erro ao excluir produto. Tente novamente.', 'erro');
            }
        });
    }

    // Função para mostrar o modal de confirmação de exclusão de produto
    function showProductDeleteConfirmationModal(message, onConfirm) {
        const modal = document.getElementById('productDeleteConfirmationModal');
        const msg = document.getElementById('productDeleteConfirmationMessage');
        const confirmBtn = document.getElementById('productDeleteConfirmBtn');
        
        // Verificar se todos os elementos foram encontrados
        if (!modal || !msg || !confirmBtn) {
            console.error('DEBUG - Elementos do modal de confirmação de exclusão não encontrados:');
            console.error('  modal:', modal);
            console.error('  msg:', msg);
            console.error('  confirmBtn:', confirmBtn);
            // Fallback para confirmação nativa do browser
            if (confirm(message)) {
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            }
            return;
        }
        
        // Limpa qualquer timer existente
        if (productDeleteConfirmationTimer) {
            clearInterval(productDeleteConfirmationTimer);
        }
        
        // Usar innerHTML para renderizar HTML, ou textContent para texto simples
        if (message.includes('<div') || message.includes('<span')) {
            msg.innerHTML = message;
        } else {
            msg.textContent = message;
        }
        modal.style.display = 'block';
        
        // Remove qualquer onclick existente e desabilita o botão
        confirmBtn.onclick = null;
        confirmBtn.disabled = true;
        let secondsLeft = 5;
        confirmBtn.textContent = `Confirmar (${secondsLeft}s)`;
        
        // Inicia o contador
        productDeleteConfirmationTimer = setInterval(() => {
            secondsLeft--;
            if (secondsLeft <= 0) {
                clearInterval(productDeleteConfirmationTimer);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirmar';
                
                // Só adiciona o onclick depois do tempo
                confirmBtn.onclick = function() {
                    closeProductDeleteConfirmationModal();
                    if (typeof onConfirm === 'function') {
                        onConfirm();
                    }
                };
            } else {
                confirmBtn.textContent = `Confirmar (${secondsLeft}s)`;
            }
        }, 1000);
    }

    // Função para fechar o modal de confirmação de exclusão de produto
    function closeProductDeleteConfirmationModal() {
        const modal = document.getElementById('productDeleteConfirmationModal');
        const confirmBtn = document.getElementById('productDeleteConfirmBtn');
        
        // Limpa o timer e reseta o botão
        if (productDeleteConfirmationTimer) {
            clearInterval(productDeleteConfirmationTimer);
            productDeleteConfirmationTimer = null;
        }
        
        // Remove o onclick e reseta o botão
        if (confirmBtn) {
            confirmBtn.onclick = null;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Confirmar';
        }
        
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Funções para o modal de nova categoria
    function openNovaCategoriaModal() {
        document.getElementById('novaCategoriaModal').style.display = 'block';
    }

    function closeNovaCategoriaModal() {
        document.getElementById('novaCategoriaModal').style.display = 'none';
        document.getElementById('novaCategoriaForm').reset();
    }

    // Event listener para o formulário de nova categoria - código movido para initializeProdutosScripts()

    async function salvarNovaCategoriaProduto() {
        const nome = document.getElementById('novaCategoriaNome').value.trim();
        const descricao = document.getElementById('novaCategoriaDescricao').value.trim();

        if (!nome) {
            mostrarMensagem('Por favor, informe o nome da categoria.', 'erro');
            return;
        }

        try {
            const response = await fetch('/api/categoria_produtos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nome: nome, descricao: descricao })
            });

            const result = await response.json();

            if (response.ok) {
                mostrarMensagem('Categoria cadastrada com sucesso!', 'sucesso');
                closeNovaCategoriaModal();
                carregarCategoriasParaDropdown('produtoCategoria');
            } else {
                mostrarMensagem(`Erro ao cadastrar categoria: ${result.message}`, 'erro');
            }
        } catch (error) {
            console.error('Erro:', error);
            mostrarMensagem('Erro ao cadastrar categoria. Por favor, tente novamente.', 'erro');
        }
    }

    // Função para mostrar notificações (similar ao estoque.html)
    function mostrarMensagem(texto, tipo = 'info') {
        console.log(`[DEBUG] mostrarMensagem chamada - texto: "${texto}", tipo: "${tipo}"`);
        const tipoMap = {
            'sucesso': 'success',
            'erro': 'error',
            'aviso': 'warning',
            'info': 'info'
        };
        showNotificationModal(tipoMap[tipo] || 'info', texto);
    }

    // Função para mostrar notificações no modal
    function showNotificationModal(type, message) {
        console.log(`[DEBUG] showNotificationModal chamada - type: "${type}", message: "${message}"`);
        const iconContainer = document.getElementById('notificationIcon');
        
        if (type === 'success') {
            iconContainer.innerHTML = `
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#4CAF50">
                        <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                    </circle>
                    <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">
                        <animate attributeName="stroke-dashoffset" values="15;0" dur="0.5s" begin="0.3s" fill="freeze"/>
                    </path>
                    <animateTransform attributeName="transform" type="scale" values="0.5;1.1;1" dur="0.8s" repeatCount="1" additive="sum"/>
                </svg>
            `;
        } else {
            iconContainer.innerHTML = `
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#F44336">
                        <animate attributeName="opacity" values="0;1" dur="0.3s" fill="freeze"/>
                    </circle>
                    <path d="M8 8L16 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="15" stroke-dashoffset="15">
                        <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.3s" fill="freeze"/>
                    </path>
                    <path d="M16 8L8 16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-dasharray="15" stroke-dashoffset="15">
                        <animate attributeName="stroke-dashoffset" values="15;0" dur="0.4s" begin="0.5s" fill="freeze"/>
                    </path>
                    <animateTransform attributeName="transform" type="scale" values="0.5;1.2;1" dur="0.8s" repeatCount="1" additive="sum"/>
                </svg>
            `;
        }
        
        const modal = document.getElementById('notificationModal');
        const title = document.getElementById('notificationModalTitle');
        const msg = document.getElementById('notificationModalMessage');
        const content = modal.querySelector('.notification-modal-content');
        
        title.textContent = type === 'success' ? 'Sucesso!' : 'Erro!';
        msg.textContent = message;
        content.className = 'modal-content notification-modal-content ' + type;
        
        // Debug: verificar z-index do modal
        console.log(`[DEBUG] Modal z-index antes:`, window.getComputedStyle(modal).zIndex);
        
        // Forçar z-index alto para garantir que apareça acima de outros modais
        modal.style.zIndex = '15000';
        modal.style.position = 'fixed';
        
        modal.style.display = 'block';
        
        // Debug: verificar z-index após configuração
        console.log(`[DEBUG] Modal z-index depois:`, window.getComputedStyle(modal).zIndex);
        console.log(`[DEBUG] Modal display:`, modal.style.display);
        console.log(`[DEBUG] Modal position:`, window.getComputedStyle(modal).position);
    }

    // Função para fechar o modal de notificação
    function closeNotificationModal() {
        document.getElementById('notificationModal').style.display = 'none';
    }

    async function carregarCategoriasParaDropdown(selectId) {
        try {
            const response = await fetch('/api/categoria_produtos');
            if (response.ok) {
                const result = await response.json();
                const customSelect = document.getElementById(selectId);
                const selectButton = customSelect.querySelector('button');
                const selectOptionsDiv = customSelect.querySelector('.dropdown-content');

                selectOptionsDiv.innerHTML = '';
                selectButton.textContent = 'Selecione uma categoria';
                selectButton.setAttribute('data-selected', '');

                if (result.status === 'success' && result.categorias) {
                    result.categorias.forEach(categoria => {
                        const optionDiv = document.createElement('div');
                        optionDiv.textContent = categoria.nome;
                        optionDiv.setAttribute('data-value', categoria.id);
                        optionDiv.onclick = function() {
                            selectButton.textContent = this.textContent;
                            selectButton.setAttribute('data-selected', this.getAttribute('data-value'));
                            selectOptionsDiv.style.display = 'none';
                        };
                        selectOptionsDiv.appendChild(optionDiv);
                    });
                    console.log('✅ Categorias carregadas:', result.categorias.length);
                    return result.categorias;
                }
            } else {
                console.error('Erro ao carregar categorias:', await response.text());
                throw new Error('Erro ao carregar categorias');
            }
        } catch (error) {
            console.error('Erro na requisição de categorias:', error);
            throw error;
        }
    }

    // Funções para o modal de seleção de materiais
    function openSelecionarMaterialModal() {
        document.getElementById('selecionarMaterialModal').style.display = 'block';
        carregarTodosOsMateriais();
    }

    function closeSelecionarMaterialModal() {
        document.getElementById('selecionarMaterialModal').style.display = 'none';
    }

    async function carregarTodosOsMateriais() {
        try {
            const response = await fetch('/api/itens_estoque/completo');
            if (!response.ok) {
                throw new Error('Erro ao carregar materiais');
            }
            
            const data = await response.json();
            console.log('Materiais carregados:', data);
            
            const lista = document.getElementById('listaMateriais');
            lista.innerHTML = '';
            
            if (data.status === 'success' && data.items && data.items.length > 0) {
                // Processar itens sequencialmente para lidar com chamadas async
                for (const item of data.items) {
                    const tr = document.createElement('tr');
                    tr.style.cursor = 'pointer';
                    tr.style.transition = 'background-color 0.2s ease';
                    // Truncar código se for muito longo
                    const codigoTruncado = item.codigo.length > 12 ? item.codigo.substring(0, 12) + '...' : item.codigo;
                         // Verificar se material suporta dimensões
                let precoDisplay = formatarMoedaBrasileira(item.custo_atual || 0);
                let nomeCompleto = item.nome;
                let tipoMaterial = item.tipo_item_nome || 'Sem tipo'; // Valor padrão
                
                try {
                    // Buscar tipo do material para determinar se suporta dimensões
                    const response = await fetch(`/api/itens_estoque/${item.id}`);
                    if (response.ok) {
                        const materialInfo = await response.json();
                        tipoMaterial = materialInfo.item?.tipo_item_nome || 'Sem tipo';
                        
                        // Construir nome completo com dimensões e fabricante UMA ÚNICA VEZ
                        const largura = materialInfo.item?.largura;
                        const comprimento = materialInfo.item?.comprimento;
                        const area = materialInfo.item?.area;
                        const fabricante = materialInfo.item?.fabricante;
                            
                            // Adicionar dimensões se disponível
                            if (area && parseFloat(area) > 1 && largura && comprimento) {
                                const larguraFormat = parseFloat(largura).toFixed(0);
                                const comprimentoFormat = parseFloat(comprimento).toFixed(0);
                                const areaFormatada = parseFloat(area).toFixed(2).replace('.', ',');
                                nomeCompleto += ` ${larguraFormat}x${comprimentoFormat}cm (${areaFormatada}m²)`;
                            }
                            
                            // Adicionar fabricante se disponível
                            if (fabricante) {
                                nomeCompleto += ` ${fabricante.toUpperCase()}`;
                            }
                            
                            if (tipoSuportaDimensoes(tipoMaterial)) {
                                const precoUnitario = parseFloat(item.custo_atual || 0);
                                
                                // Usar área da API ou calcular se não disponível
                                if (materialInfo.item?.area) {
                                    const areaTotalM2 = parseFloat(materialInfo.item.area);
                                    const precoPorM2 = precoUnitario / areaTotalM2;
                                    precoDisplay = `${formatarMoedaBrasileira(precoPorM2)}/m²`;
                                } else if (materialInfo.item?.largura && materialInfo.item?.comprimento) {
                                    const larguraCm = parseFloat(materialInfo.item.largura);
                                    const comprimentoCm = parseFloat(materialInfo.item.comprimento);
                                    const areaTotalM2 = (larguraCm / 100) * (comprimentoCm / 100);
                                    const precoPorM2 = precoUnitario / areaTotalM2;
                                    precoDisplay = `${formatarMoedaBrasileira(precoPorM2)}/m²`;
                                } else {
                                    // Assumir que o preço já é por m²
                                    precoDisplay = `${formatarMoedaBrasileira(precoUnitario)}/m²`;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao buscar tipo do material:', error);
                    }
                         tr.innerHTML = `
                    <td class="material-name-cell" style="padding: 10px; color: white;" title="${nomeCompleto}">${nomeCompleto}</td>
                    <td style="padding: 10px; text-align: center; color: white;">${tipoMaterial}</td>
                        <td style="padding: 10px; text-align: center; color: white; max-width: 100px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;" title="${item.codigo}">${codigoTruncado}</td>
                        <td style="padding: 10px; text-align: right; color: white;">${item.quantidade_atual}</td>
                        <td style="padding: 10px; text-align: right; color: white;">${precoDisplay}</td>
                    `;
                    
                    tr.onmouseover = function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.1)';
                    };
                    
                    tr.onmouseout = function() {
                        this.style.backgroundColor = 'transparent';
                    };
                    
                    // Permitir clique direto na linha para selecionar
                    tr.onclick = function() {
                        selecionarMaterial(item.id, item.nome, item.quantidade_atual, item.custo_atual || 0);
                    };
                    
                    lista.appendChild(tr);
                }
            } else {
                lista.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: white;">Nenhum material encontrado</td></tr>';
            }
        } catch (error) {
            console.error('Erro ao carregar materiais:', error);
            document.getElementById('listaMateriais').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">Erro ao carregar materiais</td></tr>';
        }
    }

    function selecionarMaterial(id, nome, quantidadeDisponivel, preco) {
        const materialData = {
            id: id,
            nome: nome,
            quantidade_atual: quantidadeDisponivel,
            preco_unitario: preco
        };
        
        adicionarMaterialSelecionado(materialData);
        closeSelecionarMaterialModal();
        mostrarMensagem('Material adicionado com sucesso!', 'sucesso');
    }

    // Event listener para busca no modal - código movido para initializeProdutosScripts()

    function filtrarMateriais(termo) {
        const rows = document.querySelectorAll('#listaMateriais tr');
        rows.forEach(row => {
            const nomeCell = row.cells[0];
            const codigoCell = row.cells[1];
            
            if (nomeCell && codigoCell) {
                const nome = nomeCell.textContent.toLowerCase();
                const codigo = codigoCell.textContent.toLowerCase();
                const termoLower = termo.toLowerCase();
                
                if (nome.includes(termoLower) || codigo.includes(termoLower)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }

    // Funções para o modal de buscar categoria
    function openBuscarCategoriaModal() {
        document.getElementById('buscarCategoriaModal').style.display = 'block';
        carregarCategoriasParaModal();
    }

    function closeBuscarCategoriaModal() {
        document.getElementById('buscarCategoriaModal').style.display = 'none';
        document.getElementById('searchCategoriaModal').value = '';
    }

    async function carregarCategoriasParaModal() {
        try {
            const response = await fetch('/api/categoria_produtos');
            if (!response.ok) {
                throw new Error('Erro ao carregar categorias');
            }
            
            const data = await response.json();
            console.log('Categorias carregadas:', data);
            
            const lista = document.getElementById('listaCategorias');
            lista.innerHTML = '';
            
            if (data.status === 'success' && data.categorias && data.categorias.length > 0) {
                data.categorias.forEach(categoria => {
                    const tr = document.createElement('tr');
                    tr.style.cursor = 'pointer';
                    tr.style.transition = 'background-color 0.2s ease';
                    tr.innerHTML = `
                        <td style="padding: 10px; color: white;">${categoria.nome}</td>
                        <td style="padding: 10px; color: white;">${categoria.descricao || '-'}</td>
                    `;
                    
                    tr.onmouseover = function() {
                        this.style.backgroundColor = 'rgba(155, 100, 227, 0.1)';
                    };
                    
                    tr.onmouseout = function() {
                        this.style.backgroundColor = 'transparent';
                    };
                    
                    // Permitir clique direto na linha para selecionar
                    tr.onclick = function() {
                        selecionarCategoria(categoria.id, categoria.nome);
                    };
                    
                    lista.appendChild(tr);
                });
            } else {
                lista.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px; color: white;">Nenhuma categoria encontrada</td></tr>';
            }
        } catch (error) {
            console.error('Erro ao carregar categorias:', error);
            document.getElementById('listaCategorias').innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px; color: #ff6b6b;">Erro ao carregar categorias</td></tr>';
        }
    }

    function selecionarCategoria(id, nome) {
        const categoriaButton = document.querySelector('#produtoCategoria button');
        categoriaButton.textContent = nome;
        categoriaButton.setAttribute('data-selected', id);
        
        closeBuscarCategoriaModal();
        mostrarMensagem(`Categoria "${nome}" selecionada!`, 'sucesso');
    }

    function filtrarCategorias(termo) {
        const rows = document.querySelectorAll('#listaCategorias tr');
        rows.forEach(row => {
            const nomeCell = row.cells[0];
            const descricaoCell = row.cells[1];
            
            if (nomeCell && descricaoCell) {
                const nome = nomeCell.textContent.toLowerCase();
                const descricao = descricaoCell.textContent.toLowerCase();
                const termoLower = termo.toLowerCase();
                
                if (nome.includes(termoLower) || descricao.includes(termoLower)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }

    // Configurar dropdowns seguindo o padrão do template máquinas
    function configurarDropdownEspecifico(dropdown) {
        console.log('🔧 [SPECIFIC] Configurando dropdown específico:', dropdown.id);
        
        const button = dropdown.querySelector('button');
        const dropdownContent = dropdown.querySelector('.dropdown-content');
        
        if (button && dropdownContent) {
            console.log('🔧 [SPECIFIC] Elementos encontrados para', dropdown.id, '- Button:', !!button, 'Content:', !!dropdownContent);
            
            // Remover listeners antigos se existirem
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            const newDropdownContent = dropdownContent.cloneNode(true);
            dropdownContent.parentNode.replaceChild(newDropdownContent, dropdownContent);
            
            // Garantir que o dropdown esteja fechado inicialmente
            newDropdownContent.style.display = 'none';
            
            console.log('🔧 [SPECIFIC] Anexando event listeners para', dropdown.id);
            
            // Configurar clique no botão
            newButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('🔧 [CLICK] Botão clicado em dropdown:', dropdown.id);
                
                // Fechar todos os outros dropdowns ANTES de abrir o atual
                document.querySelectorAll('.dropdown-content').forEach(content => {
                    if (content !== newDropdownContent) {
                        content.style.display = 'none';
                    }
                });
                
                // Toggle do dropdown atual
                const isVisible = newDropdownContent.style.display === 'block';
                newDropdownContent.style.display = isVisible ? 'none' : 'block';
                
                // Se abriu, garantir z-index adequado
                if (!isVisible) {
                    newDropdownContent.style.zIndex = '2000';
                }
            });
            
            // Configurar clique nas opções
            Array.from(newDropdownContent.children).forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Extrair texto limpo da opção
                    let cleanText = this.textContent.trim();
                    
                    // Para equipamentos, limpar texto de informações extras
                    if (dropdown.id === 'etapaEquipamento') {
                        // Extrair apenas o nome do equipamento (antes de qualquer parenteses ou hífen)
                        const match = cleanText.match(/^([^(]+)/);
                        if (match) {
                            cleanText = match[1].trim();
                        }
                    }
                    
                    // Para materiais, manter o texto limpo
                    if (dropdown.id === 'etapaMaterial') {
                        // O texto já deve estar limpo pelo carregamento
                        cleanText = this.textContent.trim();
                    }
                    
                    // Definir valor selecionado
                    newButton.textContent = cleanText;
                    const dataValue = this.getAttribute('data-value');
                    newButton.setAttribute('data-selected', dataValue);
                    
                    // LOG DETALHADO PARA DEBUG
                    console.log('🔧 [DROPDOWN] Equipamento selecionado:');
                    console.log('   - Dropdown ID:', dropdown.id);
                    console.log('   - Data Value:', dataValue);
                    console.log('   - Clean Text:', cleanText);
                    console.log('   - Button data-selected após definir:', newButton.getAttribute('data-selected'));
                    
                    // Fechar dropdown
                    newDropdownContent.style.display = 'none';
                    
                    // Calcular custo se for o dropdown de equipamento
                    if (dropdown.id === 'etapaEquipamento') {
                        console.log('🔧 [DROPDOWN] Iniciando cálculos para equipamento...');
                        setTimeout(() => {
                            calcularCustoEstimado();
                            // Calcular e preencher tempo estimado automaticamente
                            atualizarTempoEstimadoMaquina();
                        }, 100);
                    }
                    
                    // Atualizar tempo estimado se for o dropdown de material (pode afetar a área total)
                    if (dropdown.id === 'etapaMaterial') {
                        setTimeout(() => {
                            atualizarTempoEstimadoMaquina();
                        }, 100);
                    }
                });
            });
        }
    }

    function configurarDropdowns() {
        // Configurar todos os dropdowns customizados
        document.querySelectorAll('.custom-select').forEach(dropdown => {
            configurarDropdownEspecifico(dropdown);
        });
        
        // Remover listeners anteriores e configurar um único listener global para fechar dropdowns
        document.removeEventListener('click', fecharDropdownsGlobal);
        document.addEventListener('click', fecharDropdownsGlobal);
    }
    
    // ========================
    // MODAL DE CONFIRMAÇÃO DE EDIÇÃO
    // ========================
    
    let confirmationEditTimer = null;
    let originalProductData = {}; // Para armazenar dados originais do produto

    // Função para detectar mudanças nos dados do produto
    function detectProductChanges(newData) {
        const changes = {};
        
        // Verificar campos básicos
        const fieldsToCheck = ['nome', 'codigo', 'categoria', 'preco', 'margem', 'descricao', 'especificacoes'];
        
        for (const field of fieldsToCheck) {
            const oldValue = originalProductData[field];
            const newValue = newData[field];
            
            // Normalizar valores para comparação
            let normalizedOld = oldValue;
            let normalizedNew = newValue;
            
            if (field === 'preco' || field === 'margem') {
                normalizedOld = parseFloat(oldValue) || 0;
                normalizedNew = parseFloat(newValue) || 0;
            } else if (typeof oldValue === 'string' && typeof newValue === 'string') {
                normalizedOld = oldValue.trim();
                normalizedNew = newValue.trim();
            }
            
            if (normalizedOld !== normalizedNew) {
                let displayOld = oldValue;
                let displayNew = newValue;
                
                if (field === 'preco') {
                    displayOld = formatarMoedaBrasileira(parseFloat(oldValue) || 0);
                    displayNew = formatarMoedaBrasileira(parseFloat(newValue) || 0);
                } else if (field === 'margem') {
                    displayOld = `${parseFloat(oldValue) || 0}%`;
                    displayNew = `${parseFloat(newValue) || 0}%`;
                }
                
                changes[field] = {
                    type: 'modified',
                    from: displayOld || '(vazio)',
                    to: displayNew || '(vazio)'
                };
            }
        }
        
        // Verificar mudanças nos materiais
        const materialsChanged = detectMaterialsChanges();
        if (materialsChanged) {
            changes.materials = {
                type: 'materials',
                summary: materialsChanged
            };
        }
        
        // Verificar mudanças nas etapas
        const etapasChanged = detectEtapasChanges();
        if (etapasChanged) {
            changes.etapas = {
                type: 'etapas',
                summary: etapasChanged
            };
        }
        
        // Verificar mudanças nos anexos
        const anexosChanged = detectAnexosChanges();
        if (anexosChanged) {
            changes.anexos = {
                type: 'anexos',
                summary: anexosChanged
            };
        }
        
        return changes;
    }
    
    // Função para detectar mudanças nos materiais
    function detectMaterialsChanges() {
        const originalMaterials = originalProductData.materiais || [];
        const currentMaterials = editMateriais || [];
        
        console.log('DEBUG - Detectando mudanças nos materiais:');
        console.log('Materiais originais:', originalMaterials);
        console.log('Materiais atuais:', currentMaterials);
        
        // Debug detalhado da estrutura dos materiais
        originalMaterials.forEach((mat, index) => {
            console.log(`Original [${index}]:`, {
                material_id: mat.material_id,
                instance_id: mat.instance_id,
                nome: mat.nome || mat.material_nome,
                quantidade: mat.quantidade_necessaria || mat.quantidade
            });
        });
        
        currentMaterials.forEach((mat, index) => {
            console.log(`Atual [${index}]:`, {
                material_id: mat.material_id,
                instance_id: mat.instance_id,
                nome: mat.nome || mat.material_nome,
                quantidade: mat.quantidade_necessaria || mat.quantidade
            });
        });
        
        const changes = [];
        
        // Materiais removidos
        const removedMaterials = originalMaterials.filter(original => {
            const hasMatch = currentMaterials.some(current => {
                // Se ambos têm instance_id, comparar por ele
                if (original.instance_id && current.instance_id) {
                    return original.instance_id === current.instance_id;
                }
                // Se não têm instance_id, comparar apenas por material_id
                return original.material_id === current.material_id;
            });
            
            console.log(`Material original ${original.nome || original.material_nome} (ID: ${original.material_id}, Instance: ${original.instance_id}) tem correspondência:`, hasMatch);
            return !hasMatch;
        });
        
        // Materiais adicionados
        const addedMaterials = currentMaterials.filter(current => {
            const hasMatch = originalMaterials.some(original => {
                // Se ambos têm instance_id, comparar por ele
                if (original.instance_id && current.instance_id) {
                    return original.instance_id === current.instance_id;
                }
                // Se não têm instance_id, comparar apenas por material_id
                return original.material_id === current.material_id;
            });
            
            console.log(`Material atual ${current.nome || current.material_nome} (ID: ${current.material_id}, Instance: ${current.instance_id}) tem correspondência:`, hasMatch);
            return !hasMatch;
        });
        
        // Materiais modificados
        const modifiedMaterials = [];
        currentMaterials.forEach(current => {
            const original = originalMaterials.find(orig => {
                // Se ambos têm instance_id, comparar por ele
                if (orig.instance_id && current.instance_id) {
                    return orig.instance_id === current.instance_id;
                }
                // Se não têm instance_id, comparar apenas por material_id
                return orig.material_id === current.material_id;
            });
            
            if (original) {
                const materialChanges = [];
                
                // Verificar quantidade - normalizar para comparação
                const originalQtd = parseFloat(original.quantidade_necessaria || original.quantidade || 0);
                const currentQtd = parseFloat(current.quantidade_necessaria || current.quantidade || 0);
                
                console.log(`DEBUG - Comparando quantidade para ${current.nome || current.material_nome}:`, {
                    original: originalQtd,
                    current: currentQtd,
                    saoIguais: originalQtd === currentQtd
                });
                
                if (originalQtd !== currentQtd) {
                    materialChanges.push(`Qtd: ${originalQtd} → ${currentQtd}`);
                }
                
                // Verificar dimensões se existirem
                const originalLargura = parseFloat(original.largura || 0);
                const currentLargura = parseFloat(current.largura || 0);
                if (originalLargura !== currentLargura) {
                    materialChanges.push(`Largura: ${originalLargura}cm → ${currentLargura}cm`);
                }
                
                const originalAltura = parseFloat(original.altura || 0);
                const currentAltura = parseFloat(current.altura || 0);
                if (originalAltura !== currentAltura) {
                    materialChanges.push(`Altura: ${originalAltura}cm → ${currentAltura}cm`);
                }
                
                // Verificar área utilizada se existir
                const originalArea = parseFloat(original.area_utilizada || 0);
                const currentArea = parseFloat(current.area_utilizada || 0);
                if (Math.abs(originalArea - currentArea) > 0.0001) { // Usar pequena tolerância para float
                    const originalAreaFormatted = originalArea.toFixed(4).replace(/\.?0+$/, '');
                    const currentAreaFormatted = currentArea.toFixed(4).replace(/\.?0+$/, '');
                    materialChanges.push(`Área: ${originalAreaFormatted}m² → ${currentAreaFormatted}m²`);
                }
                
                if (materialChanges.length > 0) {
                    const nomeDisplay = current.nome || current.material_nome || 'Material sem nome';
                    // Encurtar nome se muito longo
                    const nomeEncurtado = nomeDisplay.length > 40 ? 
                        nomeDisplay.substring(0, 37) + '...' : 
                        nomeDisplay;
                    
                    modifiedMaterials.push({
                        nome: nomeEncurtado,
                        changes: materialChanges
                    });
                }
            }
        });
        
        console.log('DEBUG - Resultados da detecção:', {
            removidos: removedMaterials,
            adicionados: addedMaterials,
            modificados: modifiedMaterials
        });
        
        // Compilar resumo das mudanças
        if (removedMaterials.length > 0) {
            const nomesRemovidos = removedMaterials.map(m => {
                const nome = m.nome || m.material_nome || 'Material sem nome';
                return nome.length > 30 ? nome.substring(0, 27) + '...' : nome;
            });
            // SVG ícone de lixeira em base64
            const deleteIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMgNmgxOCIgc3Ryb2tlPSIjZmY2YjZiIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJtMTkgNi0xIDE0YTIgMiAwIDAgMS0yIDJINmEyIDIgMCAwIDEtMi0yTDMgNm0zIDAgVjRhMiAyIDAgMCAxIDItMmg0YTIgMiAwIDAgMSAyIDJ2MiIgc3Ryb2tlPSIjZmY2YjZiIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K';
            changes.push(`<img src="${deleteIcon}" style="vertical-align: middle; margin-right: 6px;">Removidos: ${nomesRemovidos.join(', ')}`);
        }
        
        if (addedMaterials.length > 0) {
            const nomesAdicionados = addedMaterials.map(m => {
                const nome = m.nome || m.material_nome || 'Material sem nome';
                return nome.length > 30 ? nome.substring(0, 27) + '...' : nome;
            });
            // SVG ícone de adicionar em base64
            const addIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIHN0cm9rZT0iIzUxY2Y2NiIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxwYXRoIGQ9Im0xMiA4djgiIHN0cm9rZT0iIzUxY2Y2NiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0ibTggMTJoOCIgc3Ryb2tlPSIjNTFjZjY2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K';
            changes.push(`<img src="${addIcon}" style="vertical-align: middle; margin-right: 6px;">Adicionados: ${nomesAdicionados.join(', ')}`);
        }
        
        if (modifiedMaterials.length > 0) {
            // SVG ícone de editar em base64
            const editIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTExIDRINGEyIDIgMCAwIDAtMiAydjE0YTIgMiAwIDAgMCAyIDJoMTRhMiAyIDAgMCAwIDItMlY5IiBzdHJva2U9IiM5QjY0RTMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Im0xOC41IDIuNWEyLjEyMSAyLjEyMSAwIDAgMSAzIDNsLTkuNSA5LjUtNCAxdjRsNC0xIDkuNS05LjUiIHN0cm9rZT0iIzlCNjRFMyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0ibTE1IDVsMyAzIiBzdHJva2U9IiM5QjY0RTMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=';
            const modSummary = modifiedMaterials.map(m => 
                `<img src="${editIcon}" style="vertical-align: middle; margin-right: 6px;">${m.nome}:\n   ${m.changes.join('\n   ')}`
            ).join('\n\n');
            changes.push(`${modSummary}`);
        }
        
        const resultado = changes.length > 0 ? changes.join('\n\n') : null;
        console.log('DEBUG - Resultado final da detecção de materiais:', resultado);
        
        return resultado;
    }
    
    // Função para detectar mudanças nas etapas
    function detectEtapasChanges() {
        const originalEtapas = originalProductData.etapas || [];
        const currentEtapas = editEtapas || [];
        
        const changes = [];
        
        // Etapas removidas
        const removedEtapas = originalEtapas.filter((original, index) => 
            index >= currentEtapas.length || 
            !currentEtapas[index] ||
            currentEtapas[index].nome !== original.nome
        );
        
        // Etapas adicionadas
        const addedEtapas = currentEtapas.filter((current, index) => 
            index >= originalEtapas.length ||
            !originalEtapas[index] ||
            originalEtapas[index].nome !== current.nome
        );
        
        // Etapas modificadas
        const modifiedEtapas = [];
        const minLength = Math.min(originalEtapas.length, currentEtapas.length);
        
        for (let i = 0; i < minLength; i++) {
            const original = originalEtapas[i];
            const current = currentEtapas[i];
            
            if (original && current && original.nome === current.nome) {
                const etapaChanges = [];
                
                // Verificar tipo
                if (original.tipo !== current.tipo) {
                    etapaChanges.push(`Tipo: ${original.tipo} → ${current.tipo}`);
                }
                
                // Verificar equipamento
                if (original.equipamento !== current.equipamento_nome && original.equipamento !== current.equipamento) {
                    const originalEquip = original.equipamento || '(nenhum)';
                    const currentEquip = current.equipamento_nome || current.equipamento || '(nenhum)';
                    etapaChanges.push(`Equipamento: ${originalEquip} → ${currentEquip}`);
                }
                
                // Verificar material
                if (original.material !== current.material_nome && original.material !== current.material) {
                    const originalMat = original.material || '(nenhum)';
                    const currentMat = current.material_nome || current.material || '(nenhum)';
                    etapaChanges.push(`Material: ${originalMat} → ${currentMat}`);
                }
                
                // Verificar tempo estimado
                if (original.tempo_estimado !== current.tempo_estimado) {
                    etapaChanges.push(`Tempo: ${original.tempo_estimado || '00:00:00'} → ${current.tempo_estimado || '00:00:00'}`);
                }
                
                // Verificar custo
                const originalCusto = parseFloat(original.custo_estimado || original.custo || 0);
                const currentCusto = parseFloat(current.custo_estimado || current.custo || 0);
                if (originalCusto !== currentCusto) {
                    etapaChanges.push(`Custo: ${formatarMoedaBrasileira(originalCusto)} → ${formatarMoedaBrasileira(currentCusto)}`);
                }
                
                if (etapaChanges.length > 0) {
                    modifiedEtapas.push({
                        nome: current.nome,
                        changes: etapaChanges
                    });
                }
            }
        }
        
        // Compilar resumo das mudanças
        if (removedEtapas.length > 0) {
            // SVG ícone de lixeira em base64
            const deleteIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMgNmgxOCIgc3Ryb2tlPSIjZmY2YjZiIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJtMTkgNi0xIDE0YTIgMiAwIDAgMS0yIDJINmEyIDIgMCAwIDEtMi0yTDMgNm0zIDAgVjRhMiAyIDAgMCAxIDItMmg0YTIgMiAwIDAgMSAyIDJ2MiIgc3Ryb2tlPSIjZmY2YjZiIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K';
            changes.push(`<img src="${deleteIcon}" style="vertical-align: middle; margin-right: 6px;">Removidas: ${removedEtapas.map(e => e.nome).join(', ')}`);
        }
        
        if (addedEtapas.length > 0) {
            // SVG ícone de adicionar em base64
            const addIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIHN0cm9rZT0iIzUxY2Y2NiIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxwYXRoIGQ9Im0xMiA4djgiIHN0cm9rZT0iIzUxY2Y2NiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0ibTggMTJoOCIgc3Ryb2tlPSIjNTFjZjY2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K';
            changes.push(`<img src="${addIcon}" style="vertical-align: middle; margin-right: 6px;">Adicionadas: ${addedEtapas.map(e => e.nome).join(', ')}`);
        }
        
        if (modifiedEtapas.length > 0) {
            // SVG ícone de editar em base64
            const editIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTExIDRIMTlhMiAyIDAgMCAxIDIgMnYxNGEyIDIgMCAwIDEtMiAySDE5YTIgMiAwIDAgMS0yLTJWMTQiIHN0cm9rZT0iIzlCNjRFMyIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE4LjUgMi41YTIuMTIxIDIuMTIxIDAgMCAxIDMgM0wyMC41IDcuNWwtNCAyTDEyIDlsLTQgMi01LjUtNS41IDMtMyIgc3Ryb2tlPSIjOUI2NEUzIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K';
            const modSummary = modifiedEtapas.map(e => 
                `<img src="${editIcon}" style="vertical-align: middle; margin-right: 6px;">${e.nome}:\n   ${e.changes.join('\n   ')}`
            ).join('\n\n');
            changes.push(`${modSummary}`);
        }
        
        return changes.length > 0 ? changes.join('\n\n') : null;
    }
    
    // Função para detectar mudanças nos anexos
    function detectAnexosChanges() {
        // Anexos originais que estavam no produto quando carregado
        const anexosOriginais = originalProductData.anexos || [];
        
        // Anexos que estão marcados para deletar
        const anexosParaDeletar = [];
        anexosEditProduto.forEach(anexo => {
            if (anexo.markedForDeletion && anexo.isExisting) {
                anexosParaDeletar.push(anexo);
            }
        });
        
        // Anexos novos (files selecionados pelo usuário)
        const anexosNovos = anexosEditProduto.filter(anexo => 
            anexo.file && !anexo.isExisting && !anexo.markedForDeletion
        );
        
        // Anexos existentes com categoria alterada
        const anexosComCategoriaAlterada = [];
        anexosEditProduto.forEach(anexo => {
            if (anexo.isExisting && !anexo.markedForDeletion) {
                // Encontrar o anexo original correspondente
                const anexoOriginal = anexosOriginais.find(orig => 
                    orig.id === anexo.existingId || orig.id === anexo.id
                );
                
                if (anexoOriginal) {
                    const categoriaOriginal = normalizarCategoriaAnexo(anexoOriginal.categoria || anexoOriginal.descricao || '');
                    const categoriaNova = anexo.categoria || '';
                    
                    if (categoriaOriginal !== categoriaNova) {
                        anexosComCategoriaAlterada.push({
                            anexo: anexo,
                            categoriaOriginal: categoriaOriginal,
                            categoriaNova: categoriaNova
                        });
                    }
                }
            }
        });
        
        console.log('DEBUG - Detectando mudanças nos anexos:');
        console.log('Anexos originais:', anexosOriginais);
        console.log('Anexos para deletar:', anexosParaDeletar);
        console.log('Anexos novos:', anexosNovos);
        console.log('Anexos com categoria alterada:', anexosComCategoriaAlterada);
        
        const changes = [];
        
        // Anexos removidos
        if (anexosParaDeletar.length > 0) {
            const nomesRemovidos = anexosParaDeletar.map(anexo => {
                const nome = anexo.name || anexo.nome_original || 'Anexo sem nome';
                return nome.length > 30 ? nome.substring(0, 27) + '...' : nome;
            });
            // SVG ícone de lixeira em base64
            const deleteIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMgNmgxOCIgc3Ryb2tlPSIjZmY2YjZiIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJtMTkgNi0xIDE0YTIgMiAwIDAgMS0yIDJINmEyIDIgMCAwIDEtMi0yTDMgNm0zIDAgVjRhMiAyIDAgMCAxIDItMmg0YTIgMiAwIDAgMSAyIDJ2MiIgc3Ryb2tlPSIjZmY2YjZiIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K';
            changes.push(`<img src="${deleteIcon}" style="vertical-align: middle; margin-right: 6px;">Anexos removidos: ${nomesRemovidos.join(', ')}`);
        }
        
        // Anexos adicionados
        if (anexosNovos.length > 0) {
            const nomesAdicionados = anexosNovos.map(anexo => {
                const nome = anexo.name || anexo.file?.name || 'Anexo sem nome';
                return nome.length > 30 ? nome.substring(0, 27) + '...' : nome;
            });
            // SVG ícone de adicionar em base64
            const addIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIHN0cm9rZT0iIzUxY2Y2NiIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxwYXRoIGQ9Im0xMiA4djgiIHN0cm9rZT0iIzUxY2Y2NiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0ibTggMTJoOCIgc3Ryb2tlPSIjNTFjZjY2IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K';
            changes.push(`<img src="${addIcon}" style="vertical-align: middle; margin-right: 6px;">Anexos adicionados: ${nomesAdicionados.join(', ')}`);
        }
        
        // Categorias de anexos alteradas
        if (anexosComCategoriaAlterada.length > 0) {
            const alteracoes = anexosComCategoriaAlterada.map(item => {
                const nome = item.anexo.name || item.anexo.nome_original || 'Anexo sem nome';
                const nomeSimplificado = nome.length > 20 ? nome.substring(0, 17) + '...' : nome;
                const categoriaOriginalDisplay = item.categoriaOriginal ? 
                    item.categoriaOriginal.replace(/^[^\s]+\s/, '') : 'Sem categoria';
                const categoriaNovaDisplay = item.categoriaNova ? 
                    item.categoriaNova.replace(/^[^\s]+\s/, '') : 'Sem categoria';
                return `${nomeSimplificado}: ${categoriaOriginalDisplay} → ${categoriaNovaDisplay}`;
            });
            // SVG ícone de editar em base64
            const editIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0ibTExIDRoNXYySDExVjR6TTIgNmgxOG0tMS00aC0ydjJIMTBWNkg3djJIOXY4SDd2Mkg1djJINHY4SDN2MkgyVjZ6IiBzdHJva2U9IiNmZmQwMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Im0xMC41IDE0LjUgNCA0TDIxIDEybC00LTQgLTYuNSA2LjUiIHN0cm9rZT0iI2ZmZDAwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==';
            changes.push(`<img src="${editIcon}" style="vertical-align: middle; margin-right: 6px;">Categorias alteradas: ${alteracoes.join(', ')}`);
        }
        
        const resultado = changes.length > 0 ? changes.join('\n\n') : null;
        console.log('DEBUG - Resultado final da detecção de anexos:', resultado);
        
        return resultado;
    }
    
    // Função para atualizar anexos nos dados originais
    function updateOriginalProductDataAnexos(anexos) {
        if (originalProductData) {
            // Normalizar categorias dos anexos originais
            const anexosNormalizados = anexos.map(anexo => ({
                ...anexo,
                categoria: normalizarCategoriaAnexo(anexo.descricao || anexo.categoria || '')
            }));
            originalProductData.anexos = anexosNormalizados;
            console.log('Anexos atualizados nos dados originais (com categorias normalizadas):', originalProductData.anexos);
        }
    }
    
    // Função para armazenar dados originais do produto
    function storeOriginalProductData(produto) {
        // Para materiais, garantir que cada um tenha um instance_id para comparação
        const materiaisComInstanceId = (produto.materiais || []).map((material, index) => {
            return {
                ...material,
                instance_id: material.instance_id || `original_${material.material_id}_${index}`,
                nome: material.material_nome || material.nome || 'Material sem nome',
                custo_unitario: material.custo_unitario || material.preco_unitario || 0
            };
        });
        
        // Para etapas, normalizar estrutura
        const etapasNormalizadas = (produto.etapas || []).map(etapa => {
            // Normalizar formato do tempo para HH:MM:SS
            let tempoNormalizado = etapa.tempo_estimado || '00:00:00';
            if (tempoNormalizado && !tempoNormalizado.match(/^\d{2}:\d{2}:\d{2}$/)) {
                // Se o formato não está correto (ex: "0:00:08"), normalizar para "00:00:08"
                const partesTempo = tempoNormalizado.split(':');
                if (partesTempo.length === 3) {
                    const horas = partesTempo[0].padStart(2, '0');
                    const minutos = partesTempo[1].padStart(2, '0');
                    const segundos = partesTempo[2].padStart(2, '0');
                    tempoNormalizado = `${horas}:${minutos}:${segundos}`;
                }
            }
            
            return {
                nome: etapa.nome || '',
                tipo: etapa.tipo || 'Manual',
                equipamento: etapa.equipamento_nome || etapa.equipamento || '',
                equipamento_id: etapa.equipamento_id || null,
                material: etapa.material_nome || etapa.material || '',
                material_id: etapa.material_id || null,
                tempo_estimado: tempoNormalizado,
                custo_estimado: etapa.custo_estimado || etapa.custo || 0,
                custo: etapa.custo_estimado || etapa.custo || 0
            };
        });
        
        originalProductData = {
            nome: produto.nome || '',
            codigo: produto.codigo || '',
            categoria: produto.categoria || '',
            preco: produto.preco || 0,
            margem: produto.margem_lucro || produto.margem || 0,
            descricao: produto.descricao || '',
            especificacoes: produto.especificacoes_tecnicas || produto.especificacoes || '',
            materiais: materiaisComInstanceId,
            etapas: etapasNormalizadas,
            anexos: produto.anexos || [] // Incluir anexos se fornecidos
        };
        
        console.log('Dados originais armazenados:', originalProductData);
    }



    // Função para mostrar o modal de confirmação de edição
    function showConfirmationEditModal(changes, onConfirm) {
        const modal = document.getElementById('confirmationEditModal');
        const msg = document.getElementById('confirmationEditMessage');
        const changesDiv = document.getElementById('confirmationEditChanges');
        const confirmBtn = document.getElementById('confirmEditBtn');
        
        // Verificar se todos os elementos foram encontrados
        if (!modal || !msg || !changesDiv || !confirmBtn) {
            console.error('DEBUG - Elementos do modal de confirmação não encontrados');
            // Fallback para confirmação nativa do browser
            if (confirm('Deseja realmente salvar as alterações no produto?')) {
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            }
            return;
        }
        
        // Limpa qualquer timer existente
        if (confirmationEditTimer) {
            clearInterval(confirmationEditTimer);
        }
        
        // Configurar mensagem
        msg.textContent = 'Você está prestes a salvar as seguintes alterações no produto:';
        
        // Mostrar alterações
        changesDiv.innerHTML = formatChangesHTML(changes);
        
        modal.style.display = 'block';
        
        // Remove qualquer onclick existente e desabilita o botão
        confirmBtn.onclick = null;
        confirmBtn.disabled = true;
        let secondsLeft = 3;
        confirmBtn.textContent = `Confirmar Edição (${secondsLeft}s)`;
        
        // Inicia o contador
        confirmationEditTimer = setInterval(() => {
            secondsLeft--;
            if (secondsLeft <= 0) {
                clearInterval(confirmationEditTimer);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirmar Edição';
                
                // Só adiciona o onclick depois do tempo
                confirmBtn.onclick = function() {
                    closeConfirmationEditModal();
                    if (typeof onConfirm === 'function') {
                        onConfirm();
                    }
                };
            } else {
                confirmBtn.textContent = `Confirmar Edição (${secondsLeft}s)`;
            }
        }, 1000);
    }
    
    // Função para fechar o modal de confirmação de edição
    function closeConfirmationEditModal() {
        const modal = document.getElementById('confirmationEditModal');
        const confirmBtn = document.getElementById('confirmEditBtn');
        
        // Limpa o timer e reseta o botão
        if (confirmationEditTimer) {
            clearInterval(confirmationEditTimer);
            confirmationEditTimer = null;
        }
        
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirmar Edição';
            confirmBtn.onclick = null;
        }
        
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Função para formatar as mudanças em HTML
    function formatChangesHTML(changes) {
        if (!changes || Object.keys(changes).length === 0) {
            return '<div class="change-item">Nenhuma alteração detectada.</div>';
        }
        
        let html = '';
        
        for (const [field, change] of Object.entries(changes)) {
            const fieldName = getFieldDisplayName(field);
            
            if (change.type === 'modified') {
                html += `
                    <div class="change-item">
                        <span class="change-label">${fieldName}:</span>
                        <div class="change-comparison">
                            <span class="change-from">${truncateText(change.from, 40)}</span> 
                            <span style="color: #9B64E3; margin: 0 8px;">→</span> 
                            <span class="change-to">${truncateText(change.to, 40)}</span>
                        </div>
                    </div>
                `;
            } else if (change.type === 'materials') {
                html += `
                    <div class="change-item">
                        <span class="change-label">Materiais:</span>
                        <div class="change-value">${change.summary}</div>
                    </div>
                `;
            } else if (change.type === 'etapas') {
                html += `
                    <div class="change-item">
                        <span class="change-label">Etapas:</span>
                        <div class="change-value">${change.summary}</div>
                    </div>
                `;
            } else if (change.type === 'anexos') {
                html += `
                    <div class="change-item">
                        <span class="change-label">Anexos:</span>
                        <div class="change-value">${change.summary}</div>
                    </div>
                `;
            }
        }
        
        return html;
    }
    
    // Função para truncar texto longo
    function truncateText(text, maxLength) {
        if (!text || text.length <= maxLength) {
            return text;
        }
        return text.substring(0, maxLength - 3) + '...';
    }
    
    // Função para obter nome amigável dos campos
    function getFieldDisplayName(field) {
        const fieldNames = {
            'nome': 'Nome',
            'codigo': 'Código',
            'categoria': 'Categoria',
            'preco': 'Preço',
            'margem': 'Margem (%)',
            'descricao': 'Descrição',
            'especificacoes': 'Especificações',
            'custoMateriais': 'Custo de Materiais',
            'custoEtapas': 'Custo de Etapas'
        };
        
        return fieldNames[field] || field;
    }

    // Função global para fechar dropdowns
    function fecharDropdownsGlobal(e) {
        // Se clicou fora de qualquer dropdown, fechar todos
        if (!e.target.closest('.custom-select') && !e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(content => {
                content.style.display = 'none';
            });
        }
    }

    // Função para submeter o formulário de produto
    async function salvarProduto() {
        try {
            // Obter dados do formulário
            const formData = coletarDadosFormulario();
            
            // Validar dados obrigatórios
            if (!validarDadosProduto(formData)) {
                return;
            }
            
            // Mostrar feedback de carregamento
            mostrarFeedbackCarregamento('Salvando produto...');
            
            // Verificar se há anexos para usar FormData
            const temAnexos = anexosNovoProduto.length > 0;
            let response;
            
            if (temAnexos) {
                // Usar FormData para suportar upload de arquivos
                const formDataMultipart = new FormData();
                
                // Adicionar dados básicos do produto como JSON
                formDataMultipart.append('dados', JSON.stringify({
                    nome: formData.nome,
                    codigo: formData.codigo,
                    categoria: formData.categoria,
                    preco: formData.preco,
                    margem: formData.margem,
                    descricao: formData.descricao,
                    especificacoes: formData.especificacoes,
                    materiais: formData.materiais,
                    etapas: formData.etapas,
                    custoMateriais: formData.custoMateriais,
                    custoEtapas: formData.custoEtapas,
                    custoTotal: formData.custoTotal
                }));
                
                // Adicionar cada arquivo
                anexosNovoProduto.forEach((anexo, index) => {
                    formDataMultipart.append('anexos', anexo.file);
                    // Enviar categoria como campo separado
                    formDataMultipart.append(`anexo_categoria_${index}`, anexo.categoria || '');
                });
                
                // Enviar com FormData (sem Content-Type header - browser define automaticamente)
                response = await fetch('/api/produtos', {
                    method: 'POST',
                    body: formDataMultipart
                });
            } else {
                // Enviar JSON normal quando não há anexos
                response = await fetch('/api/produtos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            }
            
            const result = await response.json();
            
            if (response.ok) {
                // Sucesso
                mostrarFeedbackSucesso('Produto salvo com sucesso!');
                
                // Fechar modal e limpar formulário
                closeProdutoModal();
                
                // Atualizar lista de produtos mantendo filtros ativos
                carregarListaProdutos(true);
                
            } else {
                // Erro do servidor
                mostrarFeedbackErro(result.message || 'Erro ao salvar produto');
            }
            
        } catch (error) {
            console.error('Erro ao salvar produto:', error);
            mostrarFeedbackErro('Erro de conexão. Tente novamente.');
        } finally {
            ocultarFeedbackCarregamento();
        }
    }

    // Função para coletar todos os dados do formulário
    function coletarDadosFormulario() {
        // Dados básicos do produto
        const dados = {
            nome: document.getElementById('produtoNome').value.trim(),
            codigo: document.getElementById('produtoCodigo').value.trim(),
            categoria: obterValorDropdown('produtoCategoria'),
            preco: extrairValorMonetario(document.getElementById('produtoPreco').value),
            margem: extrairValorPorcentagem(document.getElementById('produtoMargem').value),
            descricao: document.getElementById('produtoDescricao').value.trim(),
            especificacoes: document.getElementById('produtoEspecificacoes').value.trim()
        };
        
        // Materiais selecionados
        dados.materiais = coletarMateriaisSelecionados();
        
        // Etapas configuradas
        dados.etapas = etapas.map(etapa => {
            // Tratar material_id para aceitar IDs reais ou definir como null para IDs temporários
            let materialId = etapa.material_id;
            if (materialId && materialId.toString().startsWith('material_')) {
                materialId = null; // Se for um ID temporário, definir como null
            } else if (materialId) {
                // Se for um ID real (número), converter para inteiro
                materialId = parseInt(materialId) || null;
            }
            
            return {
                nome: etapa.nome,
                tipo: etapa.tipo || 'Manual',
                equipamento_id: etapa.equipamento_id || null,
                equipamento: etapa.equipamento_nome || etapa.equipamento,
                material_id: materialId,
                material: etapa.material_nome || etapa.material,
                tempoEstimado: etapa.tempo_estimado,
                custo: extrairValorMonetario(etapa.custo_estimado)
            };
        });
        
        // Anexos
        dados.anexos = obterAnexos('novo');
        
        // Custos calculados
        dados.custoMateriais = extrairValorMonetario(document.getElementById('custoTotal').textContent);
        dados.custoEtapas = extrairValorMonetario(document.getElementById('custoTotalEtapas').textContent);
        dados.custoTotal = dados.custoMateriais + dados.custoEtapas;
        
        console.log('Dados coletados do formulário:', dados);
        return dados;
    }

    // Função para obter valor selecionado de dropdown customizado
    function obterValorDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return '';
        
        const button = dropdown.querySelector('button');
        if (!button) return '';
        
        const dataSelected = button.getAttribute('data-selected');
        const texto = button.textContent.trim();
        
        // Se há um data-selected, usar o texto (nome da categoria)
        // Se não há data-selected, retornar vazio
        return (texto === 'Selecione uma categoria' || !dataSelected) ? '' : texto;
    }

    // Função para definir valor em dropdown customizado
    function definirValorDropdown(dropdownId, valor) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        const button = dropdown.querySelector('button');
        if (!button) return;
        
        if (valor) {
            button.textContent = valor;
            button.setAttribute('data-selected', valor);
        } else {
            button.textContent = 'Selecione uma opção';
            button.removeAttribute('data-selected');
        }
    }

    // Função para extrair valor monetário de string formatada
    function extrairValorMonetario(valorString) {
        if (!valorString && valorString !== 0) return 0;
        
        // Se já for um número, retornar diretamente
        if (typeof valorString === 'number') {
            return valorString;
        }
        
        // Converter para string se não for
        valorString = String(valorString);
        
        // Remove R$, espaços e converte vírgula para ponto
        let valor = valorString.replace(/R\$\s*/g, '').trim();
        if (valor.includes(',')) {
            valor = valor.replace(/\./g, '').replace(',', '.');
        }
        return parseFloat(valor) || 0;
    }

    // Função para extrair valor percentual de string formatada
    function extrairValorPorcentagem(valorString) {
        if (!valorString && valorString !== 0) return 0;
        
        // Se já for um número, retornar diretamente
        if (typeof valorString === 'number') {
            return valorString;
        }
        
        // Converter para string se não for
        valorString = String(valorString);
        
        let valor = valorString.replace('%', '').replace(',', '.') || '0';
        return parseFloat(valor) || 0;
    }

    // Função para coletar materiais selecionados
    function coletarMateriaisSelecionados() {
        const materiais = [];
        const tabelaMateriais = document.getElementById('materiaisList');
        
        if (tabelaMateriais) {
            const linhas = tabelaMateriais.querySelectorAll('tr');
            linhas.forEach(linha => {
                const colunas = linha.querySelectorAll('td');
                if (colunas.length >= 8) { // Ajustar para o número correto de colunas
                    // Obter ID do material do atributo data-material-id da linha
                    const materialId = linha.getAttribute('data-material-id');
                    
                    // Obter dimensões se disponíveis
                    let largura = null;
                    let altura = null;
                    let areaUtilizada = null;
                    
                    // Verificar se há campos de dimensões
                    const larguraInput = colunas[4].querySelector('input[data-dimension="largura"]');
                    const alturaInput = colunas[4].querySelector('input[data-dimension="altura"]');
                    
                    if (larguraInput && alturaInput) {
                        const larguraValue = parseFloat(larguraInput.value);
                        const alturaValue = parseFloat(alturaInput.value);
                        
                        // Só definir largura/altura se têm valores válidos e maiores que 0
                        if (larguraValue && larguraValue > 0) {
                            largura = larguraValue;
                        }
                        if (alturaValue && alturaValue > 0) {
                            altura = alturaValue;
                        }
                        
                        // Calcular área utilizada se ambas dimensões estão disponíveis
                        if (largura && altura) {
                            areaUtilizada = (largura / 100) * (altura / 100); // Converter cm para m²
                        }
                    }
                    
                    // Obter área total do material se disponível
                    let areaTotalMaterial = null;
                    const areaDisplay = colunas[5]?.querySelector('.area-display');
                    if (areaDisplay) {
                        areaTotalMaterial = parseFloat(areaDisplay.getAttribute('data-area-total')) || 0;
                    }
                    
                    console.log(`[DEBUG] Material ${materialId}: largura=${largura}, altura=${altura}, area=${areaUtilizada}, areaTotalMaterial=${areaTotalMaterial}`);
                    
                    materiais.push({
                        id: materialId ? parseInt(materialId) : null,
                        nome: colunas[0].textContent.trim(),
                        quantidade: parseFloat(colunas[3].querySelector('input').value) || 0,
                        unidade: 'un', // Pode ser ajustado conforme necessário
                        largura: largura,
                        altura: altura,
                        area_utilizada: areaUtilizada,
                        area_total_material: areaTotalMaterial, // Adicionar área total
                        precoUnitario: extrairValorMonetario(colunas[6].textContent),
                        precoTotal: extrairValorMonetario(colunas[7].textContent)
                    });
                }
            });
        }
        
        return materiais;
    }

    // Função para validar dados obrigatórios
    function validarDadosProduto(dados) {
        const erros = [];
        
        if (!dados.nome) {
            erros.push('Nome do produto é obrigatório');
        }
        
        if (!dados.codigo) {
            erros.push('Código do produto é obrigatório');
        }
        
        if (!dados.categoria) {
            erros.push('Categoria do produto é obrigatória');
        }
        
        if (dados.preco <= 0) {
            erros.push('Preço do produto deve ser maior que zero');
        }
        
        if (erros.length > 0) {
            mostrarFeedbackErro('Campos obrigatórios:\n' + erros.join('\n'));
            return false;
        }
        
        return true;
    }

    // Funções de feedback visual
    function mostrarFeedbackCarregamento(mensagem) {
        // Criar ou atualizar elemento de feedback
        let feedback = document.getElementById('feedbackCarregamento');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.id = 'feedbackCarregamento';
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: rgba(155, 100, 227, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: bold;
            `;
            document.body.appendChild(feedback);
        }
        
        feedback.innerHTML = `
            <div style="width: 20px; height: 20px; border: 2px solid white; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            ${mensagem}
        `;
        feedback.style.display = 'flex';
        
        // Adicionar animação de rotação se não existir
        if (!document.getElementById('spinAnimation')) {
            const style = document.createElement('style');
            style.id = 'spinAnimation';
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
    }

    function mostrarFeedbackSucesso(mensagem) {
        mostrarFeedbackTemporario(mensagem, 'rgba(40, 167, 69, 0.9)');
    }

    function mostrarFeedbackErro(mensagem) {
        mostrarFeedbackTemporario(mensagem, 'rgba(220, 53, 69, 0.9)');
    }

    function mostrarFeedbackTemporario(mensagem, cor) {
        const feedback = document.createElement('div');
        feedback.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: ${cor};
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: bold;
            max-width: 300px;
            word-wrap: break-word;
        `;
        feedback.textContent = mensagem;
        
        document.body.appendChild(feedback);
        
        // Remover após 4 segundos
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 4000);
    }

    function ocultarFeedbackCarregamento() {
        const feedback = document.getElementById('feedbackCarregamento');
        if (feedback) {
            feedback.style.display = 'none';
        }
    }

    // Modificar o evento de submissão do formulário - código movido para initializeProdutosScripts()

    // ===== FUNÇÕES PARA MANIPULAÇÃO DE ANEXOS =====

    // Função para normalizar categoria de anexo
    function normalizarCategoriaAnexo(categoriaOriginal) {
        if (!categoriaOriginal || categoriaOriginal === 'Sem categoria') {
            return '';
        }
        
        // Se a categoria já tem emoji, manter como está
        if (categoriaOriginal.includes('📐') || categoriaOriginal.includes('🖨️') || 
            categoriaOriginal.includes('🎨') || categoriaOriginal.includes('✨') || 
            categoriaOriginal.includes('👁️') || categoriaOriginal.includes('📋') || 
            categoriaOriginal.includes('📏') || categoriaOriginal.includes('📝') || 
            categoriaOriginal.includes('📚') || categoriaOriginal.includes('✅') || 
            categoriaOriginal.includes('💾') || categoriaOriginal.includes('💰') || 
            categoriaOriginal.includes('📎')) {
            return categoriaOriginal;
        }
        
        // Mapear categoria sem emoji para categoria com emoji
        const categoriasMap = {
            'Arquivo de Corte': '📐 Arquivo de Corte',
            'Arquivo de Impressão': '🖨️ Arquivo de Impressão',
            'Layout/Design': '🎨 Layout/Design',
            'Arte Final': '✨ Arte Final',
            'Mockup/Prova': '👁️ Mockup/Prova',
            'Especificações Técnicas': '📋 Especificações Técnicas',
            'Molde/Template': '📏 Molde/Template',
            'Instruções de Produção': '📝 Instruções de Produção',
            'Material de Referência': '📚 Material de Referência',
            'Aprovação do Cliente': '✅ Aprovação do Cliente',
            'Arquivo Fonte': '💾 Arquivo Fonte',
            'Orçamento/Cotação': '💰 Orçamento/Cotação',
            'Outro': '📎 Outro'
        };
        
        return categoriasMap[categoriaOriginal] || '📎 Outro';
    }

    let anexosNovoProduto = [];
    let anexosEditProduto = [];

    // Função para atualizar categoria de anexo
    function atualizarCategoriaAnexo(anexoId, novaCategoria, modalType) {
        const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
        
        // Encontrar e atualizar o anexo no array
        const anexo = anexosArray.find(a => a.id == anexoId);
        if (anexo) {
            const categoriaAnterior = anexo.categoria;
            anexo.categoria = novaCategoria;
            
            console.log(`Categoria do anexo ${anexo.name} alterada de "${categoriaAnterior}" para "${novaCategoria}"`);
            
            // Mostrar feedback visual
            if (novaCategoria) {
                mostrarFeedbackSucesso(`Categoria "${novaCategoria.replace(/^[^\s]+\s/, '')}" aplicada ao arquivo "${anexo.name}"`);
            } else {
                mostrarFeedbackSucesso(`Categoria removida do arquivo "${anexo.name}"`);
            }
        }
    }

    // Função para lidar com drag and drop
    function handleFileDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropArea = event.target.closest('#anexoDropArea');
        if (dropArea) {
            dropArea.style.borderColor = 'rgba(155, 100, 227, 0.5)';
            dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        }
        
        const files = event.dataTransfer.files;
        processarArquivos(files, 'novo');
    }

    function handleFileDropEdit(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropArea = event.target.closest('#editAnexoDropArea');
        if (dropArea) {
            dropArea.style.borderColor = 'rgba(155, 100, 227, 0.5)';
            dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        }
        
        const files = event.dataTransfer.files;
        processarArquivos(files, 'edit');
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropArea = event.target.closest('[id$="DropArea"]');
        if (dropArea) {
            dropArea.style.borderColor = '#9B64E3';
            dropArea.style.backgroundColor = 'rgba(155, 100, 227, 0.1)';
        }
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropArea = event.target.closest('[id$="DropArea"]');
        if (dropArea) {
            dropArea.style.borderColor = 'rgba(155, 100, 227, 0.5)';
            dropArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        }
    }

    // Função para lidar com seleção de arquivos via input
    function handleFileSelect(event) {
        const files = event.target.files;
        processarArquivos(files, 'novo');
        event.target.value = ''; // Limpar input para permitir reenvio do mesmo arquivo
    }

    function handleFileSelectEdit(event) {
        const files = event.target.files;
        processarArquivos(files, 'edit');
        event.target.value = ''; // Limpar input para permitir reenvio do mesmo arquivo
    }

    // Função principal para processar arquivos
    function processarArquivos(files, modalType) {
        const formatosAceitos = ['.pdf', '.dwg', '.png', '.jpg', '.jpeg', '.doc', '.docx', '.xls', '.xlsx'];
        const tamanhoMaximo = 10 * 1024 * 1024; // 10MB
        
        Array.from(files).forEach(file => {
            // Verificar formato
            const extensao = '.' + file.name.split('.').pop().toLowerCase();
            if (!formatosAceitos.includes(extensao)) {
                mostrarFeedbackErro(`Formato não aceito: ${file.name}\nFormatos aceitos: ${formatosAceitos.join(', ')}`);
                return;
            }
            
            // Verificar tamanho
            if (file.size > tamanhoMaximo) {
                mostrarFeedbackErro(`Arquivo muito grande: ${file.name}\nTamanho máximo: 10MB`);
                return;
            }
            
            // Verificar se já existe
            const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
            const jaExiste = anexosArray.some(anexo => anexo.name === file.name && anexo.size === file.size);
            
            if (jaExiste) {
                mostrarFeedbackErro(`Arquivo já anexado: ${file.name}`);
                return;
            }
            
            // Adicionar arquivo diretamente sem categoria (será selecionada no dropdown)
            adicionarArquivoSemCategoria(file, modalType);
        });
    }

    // Função para adicionar arquivo sem categoria pré-definida
    function adicionarArquivoSemCategoria(file, modalType) {
        const anexo = {
            id: Date.now() + Math.random(), // ID único temporário
            file: file,
            name: file.name,
            size: file.size,
            type: file.type,
            categoria: '', // Sem categoria inicial - será selecionada no dropdown
            sizeFormatted: formatarTamanhoArquivo(file.size)
        };
        
        const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
        anexosArray.push(anexo);
        adicionarAnexoNaLista(anexo, modalType);
        atualizarContadorAnexos(modalType);
        
        mostrarFeedbackSucesso(`Arquivo "${file.name}" adicionado. Selecione uma categoria na lista.`);
    }

    // Função para mostrar modal de seleção de categoria
    // Função para adicionar anexo na lista visual
    function adicionarAnexoNaLista(anexo, modalType) {
        const listaId = modalType === 'novo' ? 'anexosList' : 'editAnexosList';
        const lista = document.getElementById(listaId);
        
        const anexoElement = document.createElement('div');
        anexoElement.className = 'anexo-item';
        anexoElement.setAttribute('data-anexo-id', anexo.id);
        anexoElement.style.cssText = `
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: rgba(155, 100, 227, 0.1);
            border: 1px solid rgba(155, 100, 227, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
        `;
        
        // Obter ícone da categoria se disponível
        const categoriaIcon = anexo.categoria ? getCategoriaIcon(anexo.categoria) : '';
        
        anexoElement.innerHTML = `
            <div style="flex-shrink: 0;">
                ${getIconeArquivo(anexo.name)}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: bold; color: white; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${anexo.name}">
                    ${anexo.name}
                </div>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; margin-bottom: 5px;">
                    ${anexo.sizeFormatted}
                </div>
                <select class="categoria-anexo-select" data-anexo-id="${anexo.id}" style="
                    width: 80%;
                    padding: 4px 6px;
                    border: 1px solid rgba(155, 100, 227, 0.5);
                    border-radius: 3px;
                    background-color: rgba(255, 255, 255, 0.1);
                    color: white;
                    font-size: 11px;
                    cursor: pointer;
                ">
                    <option value="">Selecione uma categoria...</option>
                    <option value="📐 Arquivo de Corte" ${anexo.categoria === '📐 Arquivo de Corte' ? 'selected' : ''}>📐 Arquivo de Corte</option>
                    <option value="🖨️ Arquivo de Impressão" ${anexo.categoria === '🖨️ Arquivo de Impressão' ? 'selected' : ''}>🖨️ Arquivo de Impressão</option>
                    <option value="🎨 Layout/Design" ${anexo.categoria === '🎨 Layout/Design' ? 'selected' : ''}>🎨 Layout/Design</option>
                    <option value="✨ Arte Final" ${anexo.categoria === '✨ Arte Final' ? 'selected' : ''}>✨ Arte Final</option>
                    <option value="👁️ Mockup/Prova" ${anexo.categoria === '👁️ Mockup/Prova' ? 'selected' : ''}>👁️ Mockup/Prova</option>
                    <option value="📋 Especificações Técnicas" ${anexo.categoria === '📋 Especificações Técnicas' ? 'selected' : ''}>📋 Especificações Técnicas</option>
                    <option value="📏 Molde/Template" ${anexo.categoria === '📏 Molde/Template' ? 'selected' : ''}>📏 Molde/Template</option>
                    <option value="📝 Instruções de Produção" ${anexo.categoria === '📝 Instruções de Produção' ? 'selected' : ''}>📝 Instruções de Produção</option>
                    <option value="📚 Material de Referência" ${anexo.categoria === '📚 Material de Referência' ? 'selected' : ''}>📚 Material de Referência</option>
                    <option value="✅ Aprovação do Cliente" ${anexo.categoria === '✅ Aprovação do Cliente' ? 'selected' : ''}>✅ Aprovação do Cliente</option>
                    <option value="💾 Arquivo Fonte" ${anexo.categoria === '💾 Arquivo Fonte' ? 'selected' : ''}>💾 Arquivo Fonte</option>
                    <option value="💰 Orçamento/Cotação" ${anexo.categoria === '💰 Orçamento/Cotação' ? 'selected' : ''}>💰 Orçamento/Cotação</option>
                    <option value="📎 Outro" ${anexo.categoria === '📎 Outro' ? 'selected' : ''}>📎 Outro</option>
                </select>
            </div>
            <button type="button" onclick="removerAnexo('${anexo.id}', '${modalType}')" style="
                background-color: rgba(255, 100, 100, 0.1);
                border: 1px solid rgba(255, 100, 100, 0.4);
                color: white;
                padding: 4px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s ease;
                flex-shrink: 0;
            " onmouseover="this.style.backgroundColor='rgba(255, 100, 100, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 100, 100, 0.1)'">
                ✕
            </button>
        `;
        
        // Hover effect
        anexoElement.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(155, 100, 227, 0.2)';
            this.style.borderColor = 'rgba(155, 100, 227, 0.5)';
        });
        
        anexoElement.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'rgba(155, 100, 227, 0.1)';
            this.style.borderColor = 'rgba(155, 100, 227, 0.3)';
        });
        
        // Event listener para mudança de categoria
        const categoriaSelect = anexoElement.querySelector('.categoria-anexo-select');
        categoriaSelect.addEventListener('change', function() {
            atualizarCategoriaAnexo(anexo.id, this.value, modalType);
        });
        
        lista.appendChild(anexoElement);
    }

    // Função para obter ícone da categoria
    function getCategoriaIcon(categoria) {
        if (categoria.includes('📐')) return '📐';
        if (categoria.includes('🖨️')) return '🖨️';
        if (categoria.includes('🎨')) return '🎨';
        if (categoria.includes('✨')) return '✨';
        if (categoria.includes('👁️')) return '👁️';
        if (categoria.includes('📋')) return '📋';
        if (categoria.includes('📏')) return '📏';
        if (categoria.includes('📝')) return '📝';
        if (categoria.includes('📚')) return '📚';
        if (categoria.includes('✅')) return '✅';
        if (categoria.includes('💾')) return '💾';
        if (categoria.includes('💰')) return '💰';
        return '📎';
    }

    // Função para obter ícone baseado no tipo de arquivo
    function getIconeArquivo(nomeArquivo) {
        const extensao = nomeArquivo.split('.').pop().toLowerCase();
        const icones = {
            'pdf': '📄',
            'dwg': '📐',
            'png': '🖼️',
            'jpg': '🖼️',
            'jpeg': '🖼️',
            'doc': '📄',
            'docx': '📄',
            'xls': '📊',
            'xlsx': '📊'
        };
        
        return `<span style="font-size: 20px;">${icones[extensao] || '📎'}</span>`;
    }

    // Função para formatar tamanho do arquivo
    function formatarTamanhoArquivo(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Função para remover anexo
    function removerAnexo(anexoId, modalType) {
        const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
        const listaId = modalType === 'novo' ? 'anexosList' : 'editAnexosList';
        
        // Remover do array
        const index = anexosArray.findIndex(anexo => anexo.id == anexoId);
        if (index > -1) {
            const anexoRemovido = anexosArray.splice(index, 1)[0];
            
            // Remover do DOM
            const anexoElement = document.querySelector(`[data-anexo-id="${anexoId}"]`);
            if (anexoElement) {
                anexoElement.remove();
            }
            
            // Atualizar contador
            atualizarContadorAnexos(modalType);
            
            mostrarFeedbackSucesso(`Arquivo removido: ${anexoRemovido.name}`);
        }
    }

    // Função para limpar todos os anexos
    function limparTodosAnexos() {
        anexosNovoProduto = [];
        document.getElementById('anexosList').innerHTML = '';
        atualizarContadorAnexos('novo');
        mostrarFeedbackSucesso('Todos os anexos foram removidos');
    }

    function limparTodosAnexosEdit() {
        anexosEditProduto = [];
        document.getElementById('editAnexosList').innerHTML = '';
        atualizarContadorAnexos('edit');
        mostrarFeedbackSucesso('Todos os anexos foram removidos');
    }

    // Função para atualizar contador de anexos
    function atualizarContadorAnexos(modalType) {
        const contadorId = modalType === 'novo' ? 'anexosCount' : 'editAnexosCount';
        const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
        const contador = document.getElementById(contadorId);
        
        if (contador) {
            contador.textContent = anexosArray.length;
        }
    }

    // Função para carregar anexos existentes do produto (para edição)
    async function carregarAnexosParaEdicao(produtoId) {
        try {
            const response = await fetch(`/api/produtos/${produtoId}/anexos`);
            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                // Limpar anexos atuais
                anexosEditProduto = [];
                document.getElementById('editAnexosList').innerHTML = '';
                
                // Adicionar anexos existentes
                if (result.anexos && result.anexos.length > 0) {
                    result.anexos.forEach(anexo => {
                        const anexoExistente = {
                            id: 'existing_' + anexo.id, // Marcar como existente
                            existingId: anexo.id, // ID no banco
                            name: anexo.nome_original,
                            size: anexo.tamanho,
                            type: anexo.tipo_mime,
                            categoria: normalizarCategoriaAnexo(anexo.descricao), // Normalizar categoria
                            sizeFormatted: anexo.tamanho_formatado,
                            isExisting: true, // Flag para identificar anexos já salvos
                            downloadUrl: `/api/anexos/${anexo.id}`
                        };
                        
                        console.log(`Carregando anexo: ${anexo.nome_original}, categoria original: "${anexo.descricao}", categoria normalizada: "${anexoExistente.categoria}"`);
                        
                        anexosEditProduto.push(anexoExistente);
                        adicionarAnexoExistenteNaLista(anexoExistente, 'edit');
                    });
                }
                
                // Atualizar dados originais com anexos carregados
                const anexosOriginais = result.anexos || [];
                updateOriginalProductDataAnexos(anexosOriginais);
                
                atualizarContadorAnexos('edit');
            }
        } catch (error) {
            console.error('Erro ao carregar anexos:', error);
            mostrarFeedbackErro('Erro ao carregar anexos do produto');
        }
    }

    // Função para adicionar anexo existente na lista visual (diferente de anexos novos)
    function adicionarAnexoExistenteNaLista(anexo, modalType) {
        const listaId = modalType === 'novo' ? 'anexosList' : 'editAnexosList';
        const lista = document.getElementById(listaId);
        
        const anexoElement = document.createElement('div');
        anexoElement.className = 'anexo-item';
        anexoElement.setAttribute('data-anexo-id', anexo.id);
        anexoElement.style.cssText = `
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: rgba(100, 200, 100, 0.1);
            border: 1px solid rgba(100, 200, 100, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
        `;
        
        anexoElement.innerHTML = `
            <div style="flex-shrink: 0;">
                ${getIconeArquivo(anexo.name)}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: bold; color: white; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${anexo.name}">
                    ${anexo.name}
                </div>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; margin-bottom: 5px;">
                    ${anexo.sizeFormatted} • <span style="color: rgba(100, 200, 100, 0.8);">Arquivo existente</span>
                </div>
                <select class="categoria-anexo-select" data-anexo-id="${anexo.id}" style="
                    width: 80%;
                    padding: 4px 6px;
                    border: 1px solid rgba(100, 200, 100, 0.5);
                    border-radius: 3px;
                    background-color: rgba(255, 255, 255, 0.1);
                    color: white;
                    font-size: 11px;
                    cursor: pointer;
                ">
                    <option value="">Selecione uma categoria...</option>
                    <option value="📐 Arquivo de Corte" ${anexo.categoria === '📐 Arquivo de Corte' ? 'selected' : ''}>📐 Arquivo de Corte</option>
                    <option value="🖨️ Arquivo de Impressão" ${anexo.categoria === '🖨️ Arquivo de Impressão' ? 'selected' : ''}>🖨️ Arquivo de Impressão</option>
                    <option value="🎨 Layout/Design" ${anexo.categoria === '🎨 Layout/Design' ? 'selected' : ''}>🎨 Layout/Design</option>
                    <option value="✨ Arte Final" ${anexo.categoria === '✨ Arte Final' ? 'selected' : ''}>✨ Arte Final</option>
                    <option value="👁️ Mockup/Prova" ${anexo.categoria === '👁️ Mockup/Prova' ? 'selected' : ''}>👁️ Mockup/Prova</option>
                    <option value="📋 Especificações Técnicas" ${anexo.categoria === '📋 Especificações Técnicas' ? 'selected' : ''}>📋 Especificações Técnicas</option>
                    <option value="📏 Molde/Template" ${anexo.categoria === '📏 Molde/Template' ? 'selected' : ''}>📏 Molde/Template</option>
                    <option value="📝 Instruções de Produção" ${anexo.categoria === '📝 Instruções de Produção' ? 'selected' : ''}>📝 Instruções de Produção</option>
                    <option value="📚 Material de Referência" ${anexo.categoria === '📚 Material de Referência' ? 'selected' : ''}>📚 Material de Referência</option>
                    <option value="✅ Aprovação do Cliente" ${anexo.categoria === '✅ Aprovação do Cliente' ? 'selected' : ''}>✅ Aprovação do Cliente</option>
                    <option value="💾 Arquivo Fonte" ${anexo.categoria === '💾 Arquivo Fonte' ? 'selected' : ''}>💾 Arquivo Fonte</option>
                    <option value="💰 Orçamento/Cotação" ${anexo.categoria === '💰 Orçamento/Cotação' ? 'selected' : ''}>💰 Orçamento/Cotação</option>
                    <option value="📎 Outro" ${anexo.categoria === '📎 Outro' ? 'selected' : ''}>📎 Outro</option>
                </select>
            </div>
            <div style="display: flex; gap: 5px; flex-shrink: 0;">
                <button type="button" onclick="downloadAnexo('${anexo.downloadUrl}', '${anexo.name}')" style="
                    background-color: rgba(100, 150, 255, 0.1);
                    border: 1px solid rgba(100, 150, 255, 0.4);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.3s ease;
                " onmouseover="this.style.backgroundColor='rgba(100, 150, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(100, 150, 255, 0.1)'" title="Baixar arquivo">
                    ⬇
                </button>
                <button type="button" onclick="removerAnexoExistente('${anexo.id}', '${anexo.existingId}', '${modalType}')" style="
                    background-color: rgba(255, 100, 100, 0.1);
                    border: 1px solid rgba(255, 100, 100, 0.4);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.3s ease;
                " onmouseover="this.style.backgroundColor='rgba(255, 100, 100, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 100, 100, 0.1)'" title="Remover arquivo">
                    ✕
                </button>
            </div>
        `;
        
        // Hover effect diferente para anexos existentes
        anexoElement.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(100, 200, 100, 0.2)';
            this.style.borderColor = 'rgba(100, 200, 100, 0.5)';
        });
        
        anexoElement.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'rgba(100, 200, 100, 0.1)';
            this.style.borderColor = 'rgba(100, 200, 100, 0.3)';
        });
        
        // Event listener para mudança de categoria
        const categoriaSelect = anexoElement.querySelector('.categoria-anexo-select');
        categoriaSelect.addEventListener('change', function() {
            atualizarCategoriaAnexo(anexo.id, this.value, modalType);
        });
        
        lista.appendChild(anexoElement);
    }

    // Função para download de anexo existente
    function downloadAnexo(downloadUrl, nomeArquivo) {
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = nomeArquivo;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        mostrarFeedbackSucesso(`Baixando: ${nomeArquivo}`);
    }

    // Função para remover anexo existente (marca para exclusão)
    function removerAnexoExistente(anexoId, existingId, modalType) {
        const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
        
        // Remover do array
        const index = anexosArray.findIndex(anexo => anexo.id === anexoId);
        if (index > -1) {
            const anexoRemovido = anexosArray.splice(index, 1)[0];
            
            // Adicionar à lista de anexos para deletar
            if (!window.anexosParaDeletar) {
                window.anexosParaDeletar = [];
            }
            window.anexosParaDeletar.push(existingId);
            
            // Remover do DOM
            const anexoElement = document.querySelector(`[data-anexo-id="${anexoId}"]`);
            if (anexoElement) {
                anexoElement.remove();
            }
            
            // Atualizar contador
            atualizarContadorAnexos(modalType);
            
            mostrarFeedbackSucesso(`Arquivo marcado para remoção: ${anexoRemovido.name}`);
        }
    }

    // Função para obter anexos do modal (para envio ao backend)
    function obterAnexos(modalType) {
        const anexosArray = modalType === 'novo' ? anexosNovoProduto : anexosEditProduto;
        return anexosArray.map(anexo => ({
            nome_original: anexo.name,
            tipo_arquivo: anexo.type,
            tamanho_arquivo: anexo.size,
            file: anexo.file,
            categoria: anexo.categoria || ''
        }));
    }

    // Função para limpar anexos ao fechar modais
    function limparAnexosAoFecharModal(modalType) {
        if (modalType === 'novo') {
            anexosNovoProduto = [];
            document.getElementById('anexosList').innerHTML = '';
            atualizarContadorAnexos('novo');
        } else {
            anexosEditProduto = [];
            document.getElementById('editAnexosList').innerHTML = '';
            atualizarContadorAnexos('edit');
            // Limpar também lista de anexos para deletar
            if (window.anexosParaDeletar) {
                window.anexosParaDeletar = [];
            }
        }
    }

    // =============================================
    // FUNCIONALIDADE DE BUSCA DE PRODUTOS
    // =============================================

    let timeoutBusca = null;

    // Função para executar a busca
    async function executarBuscaProdutos() {
        const termoBusca = document.getElementById('searchProduto').value.trim();
        const categoriaSelecionada = document.getElementById('filtroCategoriaBusca').value;
        
        console.log('[DEBUG] Executando busca de produtos...');
        console.log('[DEBUG] Termo de busca:', termoBusca);
        console.log('[DEBUG] Categoria selecionada:', categoriaSelecionada);
        
        try {
            // Construir URL com parâmetros de busca
            let url = '/api/produtos';
            const params = new URLSearchParams();
            
            if (termoBusca) {
                params.append('nome', termoBusca);
            }
            
            if (categoriaSelecionada && categoriaSelecionada !== 'all') {
                params.append('categoria', categoriaSelecionada);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            console.log('[DEBUG] URL da requisição:', url);
            
            // Fazer requisição
            const response = await fetch(url);
            const data = await response.json();
            
            console.log('[DEBUG] Resposta da API:', data);
            
            if (data.status === 'success') {
                console.log('[DEBUG] Produtos recebidos:', data.produtos.length);
                renderizarProdutos(data.produtos);
            } else {
                console.error('Erro na busca:', data.message);
                mostrarErro('Erro ao buscar produtos: ' + data.message);
            }
        } catch (error) {
            console.error('Erro na busca de produtos:', error);
            mostrarErro('Erro ao conectar com o servidor');
        }
    }

    // Função para renderizar os produtos na lista
    function renderizarProdutos(produtos) {
        const container = document.querySelector('.produtos-list');
        if (!container) {
            console.error('Container .produtos-list não encontrado');
            return;
        }

        if (!produtos || produtos.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; grid-column: 1 / -1;">Nenhum produto encontrado</div>';
            return;
        }

        let html = '';
        produtos.forEach(produto => {
            const preco = produto.preco ? `R$ ${produto.preco.toFixed(2).replace('.', ',')}` : 'N/A';
            const margem = produto.margem_lucro ? `${produto.margem_lucro.toFixed(1)}%` : '0%';
            const categoria = produto.categoria || 'Sem categoria';
            const status = produto.status || 'Ativo';
            const statusClass = status.toLowerCase() === 'ativo' ? 'status-ativo' : 'status-inativo';
            const etapasCount = produto.etapas_count || 0;
            const estoque = produto.estoque || 0;
            
            html += `
                <div class="produto-row" style="display: grid; grid-template-columns: 0.8fr 1.5fr 1fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: 15px; padding: 15px 20px; border-bottom: 1px solid rgba(155, 100, 227, 0.3); align-items: center;">
                    <div style="color: #9B64E3; font-weight: bold;">${produto.codigo}</div>
                    <div style="color: white; font-weight: 500;">${produto.nome}</div>
                    <div style="color: #ccc;">${categoria}</div>
                    <div style="color: #2ED573; font-weight: bold;">${preco}</div>
                    <div style="color: #51cf66; font-weight: bold; text-align: center;">${margem}</div>
                    <div style="color: #fff; text-align: center;">${etapasCount}</div>
                    <div style="text-align: center;">
                        <span class="status-badge ${statusClass}" style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            ${status}
                        </span>
                    </div>
                    <div style="color: #fff; text-align: center;">${estoque}</div>
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <button onclick="editarProduto(${produto.id})" class="btn-acao btn-editar" title="Editar produto" style="background: rgba(52, 152, 219, 0.2); border: 1px solid #3498db; color: #3498db; padding: 6px; border-radius: 4px; cursor: pointer;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="m18.5 2.5 a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="duplicarProduto(${produto.id})" class="btn-acao btn-duplicar" title="Duplicar produto" style="background: rgba(155, 89, 182, 0.2); border: 1px solid #9b59b6; color: #9b59b6; padding: 6px; border-radius: 4px; cursor: pointer;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        <button onclick="excluirProduto(${produto.id})" class="btn-acao btn-excluir" title="Excluir produto" style="background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; padding: 6px; border-radius: 4px; cursor: pointer;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Função para configurar eventos de busca
    function configurarEventosBusca() {
        const inputBusca = document.getElementById('searchProduto');
        const botaoBusca = document.getElementById('searchButton');
        const filtroCategoria = document.getElementById('filtroCategoriaBusca');

        if (inputBusca) {
            // Busca automática enquanto digita (com debounce)
            inputBusca.addEventListener('input', function() {
                clearTimeout(timeoutBusca);
                timeoutBusca = setTimeout(executarBuscaProdutos, 500);
            });

            // Busca ao pressionar Enter
            inputBusca.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(timeoutBusca);
                    executarBuscaProdutos();
                }
            });
        }

        if (botaoBusca) {
            // Busca ao clicar no botão
            botaoBusca.addEventListener('click', function() {
                clearTimeout(timeoutBusca);
                executarBuscaProdutos();
            });
        }

        if (filtroCategoria) {
            // Busca ao alterar categoria
            filtroCategoria.addEventListener('change', function() {
                clearTimeout(timeoutBusca);
                executarBuscaProdutos();
            });
        }
    }

    // Função para mostrar erro
    function mostrarErro(mensagem) {
        console.error('[ERRO]', mensagem);
        // Mostrar uma notificação simples no topo da página
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: #e74c3c; color: white; padding: 15px 20px;
            border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 400px; font-size: 14px;
        `;
        errorDiv.textContent = mensagem;
        document.body.appendChild(errorDiv);
        
        // Remover após 5 segundos
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    // Função para carregar categorias no dropdown
    async function carregarCategorias() {
        try {
            const response = await fetch('/api/categoria_produtos');
            const data = await response.json();
            
            if (data.status === 'success') {
                const select = document.getElementById('filtroCategoriaBusca');
                if (select) {
                    // Limpar opções existentes (manter apenas "Todas")
                    select.innerHTML = '<option value="all">Todas</option>';
                    
                    // Adicionar categorias
                    data.categorias.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Erro ao carregar categorias:', error);
        }
    }

    // =============================================
    // FUNÇÕES DE GERAÇÃO DE CÓDIGO DE PRODUTO
    // =============================================

    // Função para gerar código de produto no modal de novo produto
    async function gerarCodigoProduto() {
        // Obter valores dos campos
        const nomeProduto = document.getElementById('produtoNome').value.trim();
        const categoriaButton = document.querySelector('#produtoCategoria button');
        const categoriaNome = categoriaButton.getAttribute('data-selected') || '';
        
        // Verificar se os campos necessários estão preenchidos
        if (!nomeProduto) {
            showNotification('error', 'Por favor, informe o nome do produto primeiro.');
            return;
        }
        
        if (!categoriaNome) {
            showNotification('error', 'Por favor, selecione uma categoria primeiro.');
            return;
        }
        
        const codigo = await gerarCodigoInteligente(nomeProduto, categoriaNome);
        if (codigo) {
            document.getElementById('produtoCodigo').value = codigo;
            aplicarFeedbackVisual('produtoCodigo');
        }
    }

    // Função para gerar código de produto no modal de edição
    async function gerarCodigoProdutoEdit() {
        // Obter valores dos campos
        const nomeProduto = document.getElementById('editProdutoNome').value.trim();
        const categoriaButton = document.querySelector('#editProdutoCategoria button');
        const categoriaNome = categoriaButton.getAttribute('data-selected') || '';
        
        // Verificar se os campos necessários estão preenchidos
        if (!nomeProduto) {
            showNotification('error', 'Por favor, informe o nome do produto primeiro.');
            return;
        }
        
        if (!categoriaNome) {
            showNotification('error', 'Por favor, selecione uma categoria primeiro.');
            return;
        }
        
        const codigo = await gerarCodigoInteligente(nomeProduto, categoriaNome);
        if (codigo) {
            document.getElementById('editProdutoCodigo').value = codigo;
            aplicarFeedbackVisual('editProdutoCodigo');
        }
    }

    // Função principal para gerar código inteligente
    async function gerarCodigoInteligente(nomeProduto, categoriaNome) {
        // Função para extrair palavras-chave do nome
        function extrairPalavrasChave(texto) {
            // Lista de palavras a serem ignoradas
            const stopWords = ['de', 'da', 'do', 'das', 'dos', 'em', 'para', 'com', 'por', 'a', 'o', 'e', 'ou', 'na', 'no', 'nas', 'nos'];
            
            const palavras = texto.toLowerCase()
                .replace(/[^\w\s]/g, '') // Remove pontuação
                .split(/\s+/) // Divide por espaços
                .filter(palavra => palavra.length > 1 && !stopWords.includes(palavra)); // Remove palavras pequenas e stop words
            
            const abreviacoes = [];
            
            // Primeira palavra: 2 caracteres
            if (palavras[0]) {
                abreviacoes.push(palavras[0].substring(0, 2).toUpperCase());
            }
            
            // Segunda palavra: 2 caracteres
            if (palavras[1]) {
                abreviacoes.push(palavras[1].substring(0, 2).toUpperCase());
            }
            
            // Terceira palavra: 2 caracteres (se existir)
            if (palavras[2]) {
                abreviacoes.push(palavras[2].substring(0, 2).toUpperCase());
            }
            
            return abreviacoes;
        }
        
        // Extrair categoria (sem espaços)
        const categoriaCompleta = categoriaNome.toUpperCase().replace(/[^\w]/g, '').substring(0, 4);
        
        // Extrair abreviações do nome
        const abreviacoesProduto = extrairPalavrasChave(nomeProduto);
        
        // Função para verificar se código já existe
        async function verificarCodigoExistente(codigo) {
            try {
                const response = await fetch('/api/produtos/verificar_codigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ codigo: codigo })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.existe; // true se já existe, false se está disponível
                } else {
                    console.warn('Erro ao verificar código existente, continuando sem verificação');
                    return false; // Em caso de erro, assume que não existe
                }
            } catch (error) {
                console.warn('Erro na requisição de verificação de código:', error);
                return false; // Em caso de erro, assume que não existe
            }
        }
        
        // Gerar código até encontrar um único
        let tentativas = 0;
        const maxTentativas = 100;
        let codigoFinal = '';
        
        do {
            tentativas++;
            
            // Gerar número aleatório de 3 dígitos
            const numeroAleatorio = Math.floor(Math.random() * 900) + 100; // Entre 100 e 999
            
            // Construir o código: CATEGORIA_PRODUTO_NUMERO
            const partes = [categoriaCompleta, ...abreviacoesProduto, numeroAleatorio.toString()];
            codigoFinal = partes.join('_');
            
            console.log(`DEBUG - Tentativa ${tentativas}: ${codigoFinal}`);
            
            // Verificar se já existe no banco
            const jaExiste = await verificarCodigoExistente(codigoFinal);
            
            if (!jaExiste) {
                break; // Código único encontrado
            }
            
            if (tentativas >= maxTentativas) {
                showNotification('error', 'Não foi possível gerar um código único após várias tentativas. Tente novamente.');
                return null;
            }
            
        } while (tentativas < maxTentativas);
        
        return codigoFinal;
    }

    // Função para aplicar feedback visual ao campo
    function aplicarFeedbackVisual(campoId) {
        const input = document.getElementById(campoId);
        input.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
        input.style.borderColor = '#4CAF50';
        
        setTimeout(() => {
            input.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            input.style.borderColor = '#9B64E3';
        }, 2000);
    }

    // Função global para mostrar notificações (caso não exista)
    function showNotification(type, message) {
        // Tentar usar a função global se existir e for diferente desta função
        if (typeof window.showNotification === 'function' && window.showNotification !== showNotification) {
            window.showNotification(type, message);
            return;
        }
        
        // Fallback: mostrar alert simples
        if (type === 'error') {
            alert('Erro: ' + message);
        } else {
            alert(message);
        }
    }

    // Função para configurar eventos específicos do sistema de kits
    function configurarEventosKit() {
        console.log('[DEBUG] Configurando eventos do sistema de kits...');
        
        // Configurar eventos para fechar modais ao clicar fora
        const kitModal = document.getElementById('kitModal');
        const selecionarModal = document.getElementById('selecionarProdutosModal');
        
        if (kitModal) {
            window.addEventListener('click', function(event) {
                if (event.target === kitModal) {
                    closeKitModal();
                }
            });
        }
        
        if (selecionarModal) {
            window.addEventListener('click', function(event) {
                if (event.target === selecionarModal) {
                    closeSelecionarProdutosModal();
                }
            });
        }
        
        // Configurar eventos para tabs do kit (se necessário)
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                if (tabName) {
                    switchTab(tabName);
                }
            });
        });
        
        console.log('[DEBUG] Eventos do kit configurados com sucesso');
    }

    // Função para inicializar todos os scripts de produtos
    function initializeProdutosScripts() {
        console.log('[DEBUG] Inicializando scripts de produtos...');
        
        // Aguardar um pouco para garantir que todos os elementos estejam prontos
        setTimeout(() => {
            // Teste se os elementos existem
            const inputBusca = document.getElementById('searchProduto');
            const botaoBusca = document.getElementById('searchButton');
            const filtroCategoria = document.getElementById('filtroCategoriaBusca');
            const container = document.querySelector('.produtos-list');
            
            console.log('[DEBUG] Elementos encontrados:', {
                inputBusca: !!inputBusca,
                botaoBusca: !!botaoBusca,
                filtroCategoria: !!filtroCategoria,
                container: !!container
            });
            
            if (container) {
                console.log('[DEBUG] Container encontrado:', container);
            } else {
                console.error('[DEBUG] Container .produtos-list NÃO ENCONTRADO!');
            }
            
            // Carregar categorias e configurar eventos
            carregarCategorias();
            configurarEventosBusca();
            configurarEventosKit();
            
            // Carregar produtos iniciais
            console.log('[DEBUG] Carregando produtos iniciais...');
            executarBuscaProdutos();
        }, 100);
    }

    // Função para gerar descrição atraente do produto
    function gerarDescricaoProduto(modo = 'novo') {
        try {
            console.log('[DEBUG] Gerando descrição para produto...');
            
            // Determinar qual modal está ativo e obter dados correspondentes
            let nomeProduto, categoriaProduto, materiais, etapas, descricaoField;
            
            if (modo === 'edit') {
                // Modal de edição
                nomeProduto = document.getElementById('editProdutoNome').value.trim();
                categoriaProduto = obterValorDropdown('editProdutoCategoria') || 'produto personalizado';
                materiais = editMateriais || [];
                etapas = editEtapas || [];
                descricaoField = document.getElementById('editProdutoDescricao');
            } else {
                // Modal de novo produto
                nomeProduto = document.getElementById('produtoNome').value.trim();
                categoriaProduto = obterValorDropdown('produtoCategoria') || 'produto personalizado';
                materiais = coletarMateriaisSelecionados();
                etapas = window.etapas || [];
                descricaoField = document.getElementById('produtoDescricao');
            }
            
            if (!nomeProduto) {
                mostrarMensagem('Digite o nome do produto antes de gerar a descrição', 'erro');
                return;
            }
            
            // Gerar descrição baseada nos dados do produto
            let descricao = gerarTextoDescricao(nomeProduto, categoriaProduto, materiais, etapas);
            
            // Definir a descrição no campo
            if (descricaoField) {
                descricaoField.value = descricao;
                
                // Feedback visual
                const botao = modo === 'edit' ? 
                    document.getElementById('btnGerarDescricaoEdit') : 
                    document.getElementById('btnGerarDescricao');
                
                if (botao) {
                    const originalHTML = botao.innerHTML;
                    botao.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                            <polyline points="20,6 9,17 4,12"></polyline>
                        </svg>
                        Gerado!
                    `;
                    botao.style.background = 'linear-gradient(135deg, #28a745, #20a745)';
                    
                    setTimeout(() => {
                        botao.innerHTML = originalHTML;
                        botao.style.background = 'linear-gradient(135deg, #9B64E3, #7A4BB8)';
                    }, 2000);
                }
                
                mostrarMensagem('Descrição gerada com sucesso!', 'sucesso');
            }
            
        } catch (error) {
            console.error('Erro ao gerar descrição:', error);
            mostrarMensagem('Erro ao gerar descrição. Tente novamente.', 'erro');
        }
    }
    
    // Função para gerar o texto da descrição
    function gerarTextoDescricao(nome, categoria, materiais, etapas) {
        let descricao = '';
        let processos = [];
        let materiaisTexto = '';
        
        // Processar materiais de forma mais inteligente
        if (materiais && materiais.length > 0) {
            const materiaisProcessados = materiais.map(m => {
                let nomeMaterial = m.material_nome || m.nome || 'material';
                
                // Simplificar nomes de materiais comuns
                nomeMaterial = nomeMaterial.toLowerCase()
                    .replace(/papel fotográfico.*a4.*glossy/i, 'papel fotográfico glossy')
                    .replace(/papel fotográfico.*a4/i, 'papel fotográfico')
                    .replace(/papel.*\(unidades\)/i, 'papel especial')
                    .replace(/acrílico.*cristal/i, 'acrílico cristal')
                    .replace(/mdf.*\d+mm/i, 'MDF')
                    .replace(/pvc.*\d+mm/i, 'PVC')
                    .split('(')[0].trim(); // Remove especificações técnicas entre parênteses
                
                return nomeMaterial;
            });
            
            const materiaisUnicos = [...new Set(materiaisProcessados)];
            
            if (materiaisUnicos.length === 1) {
                materiaisTexto = materiaisUnicos[0];
            } else if (materiaisUnicos.length === 2) {
                materiaisTexto = `${materiaisUnicos[0]} e ${materiaisUnicos[1]}`;
            } else {
                const ultimo = materiaisUnicos.pop();
                materiaisTexto = `${materiaisUnicos.join(', ')} e ${ultimo}`;
            }
        }
        
        // Processar etapas de forma mais inteligente
        if (etapas && etapas.length > 0) {
            const etapasProcessadas = etapas.map(e => {
                const nomeEtapa = (e.nome || '').toLowerCase();
                
                // Mapear etapas para descrições mais atraentes
                if (nomeEtapa.includes('impressão')) {
                    return 'impressão em alta resolução';
                } else if (nomeEtapa.includes('recorte')) {
                    return 'recorte eletrônico de precisão';
                } else if (nomeEtapa.includes('corte')) {
                    return 'corte profissional';
                } else if (nomeEtapa.includes('dobra')) {
                    return 'dobra especializada';
                } else if (nomeEtapa.includes('solda')) {
                    return 'soldagem de qualidade';
                } else if (nomeEtapa.includes('pintura')) {
                    return 'acabamento em pintura';
                } else if (nomeEtapa.includes('montagem')) {
                    return 'montagem cuidadosa';
                } else if (nomeEtapa.includes('colagem')) {
                    return 'colagem profissional';
                } else if (nomeEtapa.includes('gravação')) {
                    return 'gravação de precisão';
                } else if (nomeEtapa.includes('laminação')) {
                    return 'laminação premium';
                } else {
                    return nomeEtapa;
                }
            }).filter(p => p && p.trim() !== '');
            
            processos = [...new Set(etapasProcessadas)];
        }
        
        // Construir a descrição de forma mais natural
        descricao = nome;
        
        // Adicionar material se disponível
        if (materiaisTexto) {
            descricao += ` confeccionado em ${materiaisTexto}`;
        }
        
        // Adicionar processos se disponíveis
        if (processos.length > 0) {
            if (processos.length === 1) {
                descricao += `, com ${processos[0]}`;
            } else if (processos.length === 2) {
                descricao += `, com ${processos[0]} e ${processos[1]}`;
            } else {
                const ultimoProcesso = processos.pop();
                descricao += `, com ${processos.join(', ')} e ${ultimoProcesso}`;
            }
        }
        
        descricao += '.';
        
        // Adicionar características baseadas na categoria
        const categoriaLower = categoria.toLowerCase();
        
        if (categoriaLower.includes('festa') || categoriaLower.includes('evento')) {
            descricao += ' Ideal para decoração de festas e eventos especiais, este produto temático possui design exclusivo que encanta crianças e adultos.';
        } else if (categoriaLower.includes('brinde') || categoriaLower.includes('promocional')) {
            descricao += ' Item promocional de alta qualidade, perfeito para presentear e fortalecer a identidade da sua marca.';
        } else if (categoriaLower.includes('decoração')) {
            descricao += ' Peça decorativa elegante que adiciona charme e personalidade ao ambiente.';
        } else if (categoriaLower.includes('embalagem')) {
            descricao += ' Embalagem sofisticada que valoriza o produto e cria uma experiência especial para o cliente.';
        } else if (categoriaLower.includes('convite')) {
            descricao += ' Convite exclusivo com design personalizado que impressiona e marca presença.';
        } else if (categoriaLower.includes('lembrancinha')) {
            descricao += ' Lembrancinha especial para marcar momentos únicos e criar recordações duradouras.';
        } else {
            descricao += ' Produto de alta qualidade com acabamento profissional e atenção aos detalhes.';
        }
        
        // Adicionar informações sobre qualidade técnica se relevante
        const temImpressao = processos.some(p => p.includes('impressão'));
        if (temImpressao) {
            descricao += ' Impressão de alta qualidade garante cores vibrantes e duradouras.';
        }
        
        // Finalizar com call-to-action apropriado
        if (categoriaLower.includes('festa') || categoriaLower.includes('evento')) {
            descricao += ' Transforme sua celebração em um evento inesquecível!';
        } else if (categoriaLower.includes('brinde') || categoriaLower.includes('promocional')) {
            descricao += ' Fortaleça sua marca com um brinde que faz a diferença!';
        } else if (categoriaLower.includes('decoração')) {
            descricao += ' Dê um toque especial e único ao seu espaço!';
        } else {
            descricao += ' Qualidade garantida e resultado excepcional em cada detalhe!';
        }
        
        return descricao;
    }

    // =============================================
    // SISTEMA DE KITS - JAVASCRIPT
    // =============================================

    let kitProdutos = []; // Array para armazenar produtos do kit
    let produtosDisponiveis = []; // Array para armazenar todos os produtos disponíveis

    // Função para abrir o modal de kit
    function openKitModal() {
        const modal = document.getElementById('kitModal');
        if (modal) {
            modal.style.display = 'block';
            
            // Limpar dados do kit
            kitProdutos = [];
            document.getElementById('kitForm').reset();
            
            // Atualizar displays
            atualizarTabelaProdutosKit();
            atualizarTotaisKit();
            
            // Inicializar abas no modal de kit
            setTimeout(() => {
                activateTab('produtos', 'kitModal');
            }, 100);
        }
    }

    // Função para fechar o modal de kit
    function closeKitModal() {
        const modal = document.getElementById('kitModal');
        if (modal) {
            modal.style.display = 'none';
            kitProdutos = [];
        }
    }

    // Função para abrir o modal de seleção de produtos
    async function openSelecionarProdutosModal() {
        console.log('[DEBUG] Abrindo modal de seleção de produtos...');
        const modal = document.getElementById('selecionarProdutosModal');
        if (modal) {
            modal.style.display = 'block';
            console.log('[DEBUG] Modal exibido, carregando produtos...');
            
            // Carregar produtos disponíveis
            await carregarProdutosDisponiveis();
            
            // Resetar pesquisa
            const searchInput = document.getElementById('searchProdutoKit');
            if (searchInput) {
                searchInput.value = '';
                console.log('[DEBUG] Campo de pesquisa resetado');
            }
            filtrarProdutosKit('');
        } else {
            console.error('[DEBUG] Modal selecionarProdutosModal não encontrado!');
        }
    }

    // Função para fechar o modal de seleção de produtos
    function closeSelecionarProdutosModal() {
        const modal = document.getElementById('selecionarProdutosModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Função para carregar produtos disponíveis
    async function carregarProdutosDisponiveis() {
        try {
            console.log('[DEBUG] Carregando produtos para seleção...');
            
            // Usar o mesmo endpoint que está funcionando na busca principal
            const response = await fetch('/api/produtos', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('[DEBUG] Produtos carregados para seleção:', data);
                
                if (data.produtos && Array.isArray(data.produtos)) {
                    // Mapear produtos usando a mesma estrutura da busca principal
                    produtosDisponiveis = data.produtos.map(produto => ({
                        id: produto.id,
                        codigo: produto.codigo || '',
                        nome: produto.nome || 'Produto sem nome',
                        categoria: produto.categoria || 'Sem categoria',
                        preco: parseFloat(produto.preco) || 0.00,
                        status: produto.status || 'ativo'
                    })).filter(produto => {
                        // Incluir produtos que estão ativos ou que não têm status definido (consideramos como ativos)
                        return !produto.status || produto.status === 'ativo' || produto.status === 'Ativo' || produto.status === null;
                    });
                    
                    console.log(`[DEBUG] ${produtosDisponiveis.length} produtos disponíveis para seleção`);
                    console.log(`[DEBUG] Primeiro produto (exemplo):`, produtosDisponiveis[0]);
                    popularTabelaProdutosSelecionaveis();
                } else if (data.status === 'success' && data.produtos) {
                    // Formato alternativo de resposta - incluir todos os produtos disponíveis
                    produtosDisponiveis = data.produtos.filter(produto => {
                        return !produto.status || produto.status === 'ativo' || produto.status === 'Ativo' || produto.status === null;
                    });
                    console.log(`[DEBUG] ${produtosDisponiveis.length} produtos carregados (formato alternativo)`);
                    popularTabelaProdutosSelecionaveis();
                } else {
                    throw new Error('Formato de resposta inválido');
                }
            } else {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
        } catch (error) {
            console.error('[DEBUG] Erro ao carregar produtos:', error);
            
            // Mostrar aviso de que não há produtos
            const tbody = document.getElementById('produtosKitList');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                            <div style="font-size: 16px; margin-bottom: 8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 10px; opacity: 0.5;">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                            </div>
                            <div>Erro ao carregar produtos</div>
                            <div style="font-size: 12px; margin-top: 5px;">Verifique a conexão e tente novamente</div>
                        </td>
                    </tr>
                `;
            }
            
            produtosDisponiveis = [];
        }
    }

    // Função para popular a tabela de produtos selecionáveis
    function popularTabelaProdutosSelecionaveis() {
        console.log('[DEBUG] Populando tabela de produtos selecionáveis...');
        const tbody = document.getElementById('produtosKitList');
        if (!tbody) {
            console.error('[DEBUG] Elemento produtosKitList não encontrado!');
            return;
        }

        console.log(`[DEBUG] ${produtosDisponiveis.length} produtos disponíveis para popular`);
        tbody.innerHTML = '';

        if (produtosDisponiveis.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                        <div>Nenhum produto disponível</div>
                        <div style="font-size: 12px; margin-top: 5px;">Cadastre alguns produtos primeiro</div>
                    </td>
                </tr>
            `;
            return;
        }

        produtosDisponiveis.forEach((produto, index) => {
            console.log(`[DEBUG] Adicionando produto ${index + 1}: ${produto.nome}`);
            const row = document.createElement('tr');
            row.dataset.produtoId = produto.id;
            row.dataset.nome = produto.nome.toLowerCase();
            row.dataset.categoria = (produto.categoria || '').toLowerCase();

            const isSelected = kitProdutos.some(p => p.id === produto.id);

            row.innerHTML = `
                <td style="text-align: center;">
                    <input type="checkbox" 
                           data-produto-id="${produto.id}" 
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleProdutoSelecao(${produto.id}, this.checked)">
                </td>
                <td style="cursor: pointer;" onclick="toggleProdutoSelecaoByRow(${produto.id})">
                    <div style="font-weight: 500; color: white;">${produto.nome}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        ${produto.codigo ? `Código: ${produto.codigo}` : `ID: ${produto.id}`}
                    </div>
                </td>
                <td style="text-align: center; color: rgba(255,255,255,0.8); cursor: pointer;" onclick="toggleProdutoSelecaoByRow(${produto.id})">
                    ${produto.categoria || 'Sem categoria'}
                </td>
                <td style="text-align: center; color: #2ED573; font-weight: 500; cursor: pointer;" onclick="toggleProdutoSelecaoByRow(${produto.id})">
                    R$ ${(produto.preco || 0).toFixed(2).replace('.', ',')}
                </td>
            `;

            // Adicionar estilo de hover para a linha
            row.style.cursor = 'pointer';
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(155, 100, 227, 0.1)';
            });
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
            });

            tbody.appendChild(row);
        });

        console.log(`[DEBUG] Tabela populada com ${produtosDisponiveis.length} produtos`);
        atualizarContadorProdutosSelecionados();
    }

    // Função para alternar seleção de produto
    function toggleProdutoSelecao(produtoId, isSelected) {
        const produto = produtosDisponiveis.find(p => p.id === produtoId);
        if (!produto) return;

        if (isSelected) {
            // Adicionar produto ao kit com quantidade padrão 1
            kitProdutos.push({
                id: produto.id,
                codigo: produto.codigo,
                nome: produto.nome,
                categoria: produto.categoria,
                preco: produto.preco,
                quantidade: 1
            });
        } else {
            // Remover produto do kit
            kitProdutos = kitProdutos.filter(p => p.id !== produtoId);
        }

        atualizarContadorProdutosSelecionados();
    }

    // Função para alternar seleção clicando na linha do produto
    function toggleProdutoSelecaoByRow(produtoId) {
        const checkbox = document.querySelector(`input[type="checkbox"][data-produto-id="${produtoId}"]`);
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            toggleProdutoSelecao(produtoId, checkbox.checked);
        }
    }

    // Função para selecionar todos os produtos
    function selecionarTodosProdutos() {
        const checkboxes = document.querySelectorAll('#produtosKitList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                const produtoId = parseInt(checkbox.dataset.produtoId);
                toggleProdutoSelecao(produtoId, true);
            }
        });
        
        // Atualizar checkbox "Selecionar Todos"
        const selectAllCheckbox = document.getElementById('selectAllProdutosKit');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = true;
        }
    }

    // Função para desselecionar todos os produtos
    function desselecionarTodosProdutos() {
        const checkboxes = document.querySelectorAll('#produtosKitList input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                checkbox.checked = false;
                const produtoId = parseInt(checkbox.dataset.produtoId);
                toggleProdutoSelecao(produtoId, false);
            }
        });
        
        // Atualizar checkbox "Selecionar Todos"
        const selectAllCheckbox = document.getElementById('selectAllProdutosKit');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
    }

    // Função para alternar seleção de todos
    function toggleAllProdutosKit() {
        const selectAllCheckbox = document.getElementById('selectAllProdutosKit');
        if (selectAllCheckbox.checked) {
            selecionarTodosProdutos();
        } else {
            desselecionarTodosProdutos();
        }
    }

    // Função para filtrar produtos na seleção
    function filtrarProdutosKit(searchTerm) {
        const rows = document.querySelectorAll('#produtosKitList tr');
        const term = searchTerm.toLowerCase();

        rows.forEach(row => {
            const nome = row.dataset.nome || '';
            const categoria = row.dataset.categoria || '';
            
            const shouldShow = nome.includes(term) || categoria.includes(term);
            row.style.display = shouldShow ? '' : 'none';
        });
    }

    // Função para atualizar contador de produtos selecionados
    function atualizarContadorProdutosSelecionados() {
        const contador = document.getElementById('produtosSelecionadosCount');
        if (contador) {
            contador.textContent = kitProdutos.length;
        }
    }

    // Função para confirmar seleção de produtos
    function confirmarSelecaoProdutos() {
        closeSelecionarProdutosModal();
        atualizarTabelaProdutosKit();
        atualizarTotaisKit();
    }

    // Função para atualizar tabela de produtos do kit
    function atualizarTabelaProdutosKit() {
        const tbody = document.getElementById('kitProdutosList');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (kitProdutos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" style="padding: 40px; text-align: center; color: #888; font-style: italic;">
                        Nenhum produto selecionado. Use o botão "Incluir Produtos" para adicionar.
                    </td>
                </tr>
            `;
            return;
        }

        kitProdutos.forEach((produto, index) => {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td style="padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2);">
                    <div style="display: flex; flex-direction: column;">
                        <strong style="color: white;">${produto.nome}</strong>
                        <small style="color: rgba(255, 255, 255, 0.7);">Código: ${produto.codigo || 'N/A'}</small>
                    </div>
                </td>
                <td style="padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); text-align: center;">
                    <span style="padding: 4px 8px; background-color: rgba(155, 100, 227, 0.2); border-radius: 12px; font-size: 11px; color: white;">
                        ${produto.categoria || 'Sem categoria'}
                    </span>
                </td>
                <td style="padding: 12px; border-bottom: 1px solid rgba(155, 100, 227, 0.2); text-align: center;">
                    <button type="button" 
                            onclick="removerProdutoKit(${index})" 
                            style="background-color: rgba(255, 100, 100, 0.2); border: 1px solid rgba(255, 100, 100, 0.5); color: white; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center;" 
                            onmouseover="this.style.backgroundColor='rgba(255, 100, 100, 0.4)'" 
                            onmouseout="this.style.backgroundColor='rgba(255, 100, 100, 0.2)'" 
                            title="Remover produto">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0zIDZoMThsLTIgMTNhMiAyIDAgMCAxLTIgMkg3YTIgMiAwIDAgMS0yLTJMMy4yIDZaIi8+PHBhdGggZD0ibTkgMTAgNCAxNC00LTE0Ii8+PHBhdGggZD0iTTEwIDNoMFYxYTEgMSAwIDAgMSAxLTFoMmExIDEgMCAwIDEgMSAxdjJoMCIvPjwvc3ZnPg==" alt="Excluir" style="width: 14px; height: 14px; filter: brightness(0) invert(1);">
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // Função para remover produto do kit
    function removerProdutoKit(index) {
        if (kitProdutos[index]) {
            kitProdutos.splice(index, 1);
            atualizarTabelaProdutosKit();
            atualizarTotaisKit();
        }
    }

    // Função para atualizar totais do kit (simplificada)
    function atualizarTotaisKit() {
        // Função mantida para compatibilidade, mas sem funcionalidade
        // já que removemos os campos de total e quantidade
    }

    // Função para salvar kit
    async function salvarKit() {
        const nome = document.getElementById('kitNome').value.trim();
        const codigo = document.getElementById('kitCodigo').value.trim();
        const descricao = document.getElementById('kitDescricao').value.trim();

        console.log('[DEBUG] Salvando kit:', { nome, codigo, descricao, kitProdutos });

        // Validações
        if (!nome) {
            alert('Por favor, informe o nome do kit.');
            return;
        }

        if (!codigo) {
            alert('Por favor, informe o código do kit.');
            return;
        }

        if (kitProdutos.length === 0) {
            alert('Por favor, adicione pelo menos um produto ao kit.');
            return;
        }

        const kitData = {
            nome: nome,
            codigo: codigo,
            descricao: descricao || null,
            produtos: kitProdutos
        };

        console.log('[DEBUG] Dados do kit a enviar:', kitData);

        try {
            const response = await fetch('/api/kits', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(kitData)
            });

            const result = await response.json();
            console.log('[DEBUG] Resposta do servidor:', result);

            if (result.success) {
                alert('Kit salvo com sucesso!');
                closeKitModal();
                // Recarregar lista de produtos para incluir o kit
                if (typeof carregarListaProdutos === 'function') {
                    carregarListaProdutos();
                }
            } else {
                alert('Erro ao salvar kit: ' + (result.message || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro ao salvar kit:', error);
            alert('Erro ao salvar kit. Verifique a conexão e tente novamente.');
        }
    }

    // Event listeners para os modais de kit
    document.addEventListener('DOMContentLoaded', function() {
        // Fechar modais ao clicar fora
        window.addEventListener('click', function(event) {
            const kitModal = document.getElementById('kitModal');
            const selecionarModal = document.getElementById('selecionarProdutosModal');
            
            if (event.target === kitModal) {
                closeKitModal();
            }
            
            if (event.target === selecionarModal) {
                closeSelecionarProdutosModal();
            }
        });

        // Event listeners para margem do kit não são mais necessários
        // pois removemos o campo de margem
    });

    // =============================================
    // FUNÇÕES ESPECÍFICAS PARA KITS
    // =============================================

    // Função para gerar código de kit
    async function gerarCodigoKit() {
        const nomeKit = document.getElementById('kitNome').value.trim();
        const codigoField = document.getElementById('kitCodigo');
        
        if (!nomeKit) {
            showNotification('error', 'Por favor, informe o nome do kit primeiro.');
            document.getElementById('kitNome').focus();
            return;
        }
        
        // Mostrar loading no botão
        const botaoGerar = document.querySelector('button[onclick="gerarCodigoKit()"]');
        const textoOriginal = botaoGerar.innerHTML;
        botaoGerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        botaoGerar.disabled = true;
        
        try {
            // Gerar código específico para kit
            const codigo = await gerarCodigoInteligenteKit(nomeKit);
            if (codigo) {
                codigoField.value = codigo;
                aplicarFeedbackVisual('kitCodigo');
                showNotification('success', 'Código gerado com sucesso!');
            } else {
                showNotification('error', 'Erro ao gerar código. Tente novamente.');
            }
        } catch (error) {
            console.error('Erro ao gerar código do kit:', error);
            showNotification('error', 'Erro ao gerar código. Tente novamente.');
        } finally {
            // Restaurar botão
            botaoGerar.innerHTML = textoOriginal;
            botaoGerar.disabled = false;
        }
    }

    // Função para gerar código inteligente para kit
    async function gerarCodigoInteligenteKit(nomeKit) {
        // Função para extrair palavras-chave do nome
        function extrairPalavrasChave(texto) {
            const stopWords = ['de', 'da', 'do', 'das', 'dos', 'em', 'para', 'com', 'por', 'a', 'o', 'e', 'ou', 'na', 'no', 'nas', 'nos', 'kit'];
            
            const palavras = texto.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(p => p.length > 1 && !stopWords.includes(p));
            
            const abreviacoes = [];
            
            // Primeira palavra: 2-3 caracteres
            if (palavras[0]) {
                abreviacoes.push(palavras[0].substring(0, 3).toUpperCase());
            }
            
            // Segunda palavra: 2 caracteres
            if (palavras[1]) {
                abreviacoes.push(palavras[1].substring(0, 2).toUpperCase());
            }
            
            return abreviacoes;
        }
        
        // Extrair abreviações do nome
        const abreviacoesKit = extrairPalavrasChave(nomeKit);
        
        // Função para verificar se código já existe
        async function verificarCodigoExistente(codigo) {
            try {
                const response = await fetch('/api/kits/verificar_codigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ codigo: codigo })
                });
                const data = await response.json();
                return data.existe || false;
            } catch (error) {
                console.error('Erro ao verificar código do kit:', error);
                return false;
            }
        }
        
        // Gerar código até encontrar um único
        let tentativas = 0;
        const maxTentativas = 100;
        let codigoFinal = '';
        
        do {
            tentativas++;
            
            // Gerar número aleatório de 3 dígitos
            const numeroAleatorio = Math.floor(Math.random() * 900) + 100;
            
            // Construir o código: KIT_ABREVIAÇÕES_NUMERO
            const partes = ['KIT', ...abreviacoesKit, numeroAleatorio.toString()];
            codigoFinal = partes.join('_');
            
            // Verificar se já existe no banco
            const jaExiste = await verificarCodigoExistente(codigoFinal);
            
            if (!jaExiste) {
                break;
            }
            
            if (tentativas >= maxTentativas) {
                console.warn('Limite de tentativas excedido, usando código com timestamp');
                codigoFinal = `KIT_${abreviacoesKit.join('_')}_${Date.now().toString().slice(-6)}`;
                break;
            }
            
        } while (tentativas < maxTentativas);
        
        return codigoFinal;
    }

    // Expor função globalmente para uso pelo dashboard
    window.initializeProdutosScripts = initializeProdutosScripts;

    // Configurar eventos quando a página carrega (para acesso direto)
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[DEBUG] DOM carregado, inicializando produtos...');
        initializeProdutosScripts();
    });
</script>
